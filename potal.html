<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>KAC 통합 관리 포털</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="config.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root { --navy-dark: #0f172a; --bg-gray: #f1f5f9; --text-main: #1e293b; --accent-blue: #3b82f6; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; background: #e2e8f0; display: flex; justify-content: center; }
    .app-container { width: 100%; max-width: 600px; min-height: 100dvh; background: var(--bg-gray); display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.1); position: relative; }
    .app-header { position: fixed; top: 0; width: 100%; max-width: 600px; height: 60px; background: var(--navy-dark); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; color: #fff; }
    .header-title { font-size: 16px; font-weight: 800; }
    .app-footer { position: fixed; bottom: 0; width: 100%; max-width: 600px; height: 54px; background: var(--navy-dark); color: #94a3b8; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; font-size: 11px; z-index: 1000; border-top: 1px solid rgba(255,255,255,0.1); }
    .footer-logo img { height: 18px; filter: brightness(0) invert(1); opacity: 0.8; }
    .app-content { flex: 1; margin-top: 60px; margin-bottom: 54px; padding: 30px 24px; }
    .portal-intro { text-align: center; margin-bottom: 30px; }
    .portal-intro h1 { font-size: 24px; font-weight: 900; color: var(--navy-dark); margin-bottom: 8px; }
    .menu-grid { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .menu-card { background: #fff; border-radius: 24px; padding: 24px 16px; display: flex; flex-direction: column; align-items: center; text-decoration: none; border: 1.5px solid #e2e8f0; transition: 0.2s; }
    .menu-card:active { transform: scale(0.95); background: #f8fafc; }
    .icon-circle { width: 60px; height: 60px; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 26px; margin-bottom: 14px; }
    .menu-name { font-size: 16px; font-weight: 800; color: var(--navy-dark); }
    .m-driver .icon-circle { background: #eff6ff; color: #3b82f6; }
    .m-meal .icon-circle { background: #ecfdf5; color: #10b981; }
    .m-coord .icon-circle { background: #f0f9ff; color: #0ea5e9; }
    .m-leader .icon-circle { background: #f5f3ff; color: #6366f1; }
    .full-btn { grid-column: span 2; flex-direction: row; gap: 15px; justify-content: flex-start; padding-left: 30px; }
    .full-btn .icon-circle { margin-bottom: 0; width: 50px; height: 50px; font-size: 20px; }
    /* 설정 모달 */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center; padding:20px; }
    .modal-content { background:#fff; width:100%; max-width:400px; border-radius:24px; padding:24px; }
    .input-box { width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:10px; font-size:14px; }
    .save-btn { width:100%; padding:14px; background:var(--navy-dark); color:#fff; border:none; border-radius:12px; font-weight:800; cursor:pointer; }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div style="width:40px"></div>
      <div class="header-title">KAC Training Platform</div>
      <div style="width:40px; text-align:right; cursor:pointer;" onclick="openAdminSettings()"><i class="fa-solid fa-gear"></i></div>
    </header>
    <main class="app-content">
      <div class="portal-intro"><h1>통합 관리 포털</h1><p>로그인 후 서비스에 접속해 주세요.</p></div>
      <div class="menu-grid">
        <a href="javascript:void(0)" onclick="goWithPin('driver.html', 'driver')" class="menu-card m-driver"><div class="icon-circle"><i class="fa-solid fa-bus"></i></div><span class="menu-name">운전원</span></a>
        <a href="javascript:void(0)" onclick="goWithPin('nutritionist.html', 'meal')" class="menu-card m-meal"><div class="icon-circle"><i class="fa-solid fa-utensils"></i></div><span class="menu-name">영양사</span></a>
        <a href="javascript:void(0)" onclick="goWithPin('admin_coord.html', 'coord')" class="menu-card m-coord full-btn"><div class="icon-circle"><i class="fa-solid fa-user-tie"></i></div><span class="menu-name">교육운영 담당자</span></a>
        <a href="student_leader.html" class="menu-card m-leader full-btn"><div class="icon-circle"><i class="fa-solid fa-crown"></i></div><span class="menu-name">학생장</span></a>
      </div>
    </main>
    <footer class="app-footer"><div id="footer-date"></div><div class="footer-logo"><img src="logo.png"></div></footer>
  </div>

  <!-- PIN 관리 모달 -->
  <div id="adminModal" class="modal">
    <div class="modal-content">
      <h3 style="margin-top:0">포털 PIN 번호 관리</h3>
      <p style="font-size:12px; color:gray">플랫폼별 접속 4자리 번호를 설정하세요.</p>
      <input type="password" id="new_driver" class="input-box" placeholder="운전원 새 PIN">
      <input type="password" id="new_meal" class="input-box" placeholder="영양사 새 PIN">
      <input type="password" id="new_coord" class="input-box" placeholder="담당자 새 PIN">
      <button class="save-btn" onclick="saveNewPins()">설정 저장</button>
      <button class="save-btn" style="background:#ccc; margin-top:8px" onclick="closeModal()">닫기</button>
    </div>
  </div>

  <script>
    async function hashPin(pin) {
      const msgUint8 = new TextEncoder().encode(pin);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function goWithPin(url, role) {
      const snap = await firebase.database().ref(`system/portalPins/${role}`).once('value');
      const dbHashed = snap.val();
      if(!dbHashed) { alert("PIN이 설정되지 않았습니다. 관리자에게 문의하세요."); return; }
      const userInput = prompt("접속 PIN 번호를 입력하세요.");
      if(!userInput) return;
      const userHashed = await hashPin(userInput);
      if(userHashed === dbHashed) {
        sessionStorage.setItem('kac_portal_auth', role);
        location.href = url;
      } else { alert("잘못된 PIN 번호입니다."); }
    }

    async function openAdminSettings() {
      const pw = prompt("강사 플랫폼 비밀번호를 입력하세요.");
      if(!pw) return;
      try {
        await firebase.auth().signInWithEmailAndPassword("admin@kac.com", pw);
        document.getElementById('adminModal').style.display = 'flex';
      } catch(e) { alert("비밀번호가 올바르지 않습니다."); }
    }

    async function saveNewPins() {
      const roles = ['driver', 'meal', 'coord'];
      for(const r of roles) {
        const val = document.getElementById(`new_${r}`).value;
        if(val) {
          const hashed = await hashPin(val);
          await firebase.database().ref(`system/portalPins/${r}`).set(hashed);
        }
      }
      alert("설정이 저장되었습니다."); closeModal();
    }

    function closeModal() { document.getElementById('adminModal').style.display='none'; }
    function runClock() {
      const now = new Date(); const week = ['일','월','화','수','목','금','토'];
      document.getElementById('footer-date').innerText = `${now.getFullYear()}년 ${now.getMonth()+1}월 ${now.getDate()}일 (${week[now.getDay()]}) ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    }
    setInterval(runClock, 1000); runClock();
  </script>
</body>
</html>