<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>항공기술훈련원 교육플랫폼 - 통합 포털</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="config.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root { 
        --navy-dark: #0f172a; 
        --bg-gray: #f8fafc; 
        --text-main: #1e293b; 
        --accent-blue: #3b82f6;
        --accent-orange: #f97316;
        --accent-green: #10b981;
        --accent-purple: #6366f1;
        --accent-sky: #0ea5e9;
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
        margin: 0; padding: 0; 
        font-family: 'Pretendard', sans-serif; 
        background: #000; 
        display: flex; justify-content: center;
        overflow: hidden; /* 바디 스크롤 금지 */
    }

    .app-container { 
        width: 100%; max-width: 500px; height: 100dvh; 
        background: var(--bg-gray); 
        display: flex; flex-direction: column; 
        position: relative; 
    }

    /* 상단바 슬림화 */
    .app-header { 
        height: 55px; 
        background: var(--navy-dark); 
        display: flex; align-items: center; justify-content: space-between; 
        padding: 0 16px; color: #fff; 
        border-bottom: 2px solid var(--accent-blue);
    }
    .header-title { font-size: 16px; font-weight: 900; }

    /* 메인 컨텐츠 영역 - 스크롤 없이 꽉 채우기 */
    .app-content { 
        flex: 1; 
        padding: 20px 16px; 
        display: flex; 
        flex-direction: column;
        justify-content: space-between; /* 요소 간 간격 균등 분배 */
    }

    .portal-intro { text-align: center; margin-bottom: 10px; }
    .portal-intro h1 { font-size: 22px; font-weight: 900; color: var(--navy-dark); margin: 0; }
    .portal-intro p { color: #64748b; font-size: 13px; margin: 4px 0 0 0; }

    /* 메뉴 그리드 레이아웃 - 높이 최적화 */
    .menu-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        grid-template-rows: repeat(3, 1fr); /* 3행 구조 */
        gap: 12px; 
        flex: 1; /* 남은 공간을 그리드가 다 차지함 */
        margin: 10px 0;
    }

    /* 카드 스타일 슬림화 */
    .menu-card { 
        background: #fff; 
        border-radius: 20px; 
        padding: 12px; 
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        text-decoration: none; 
        border: 1.5px solid #e2e8f0; 
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .menu-card:active { transform: scale(0.96); background: #f1f5f9; }

    .icon-circle { 
        width: 46px; height: 46px; 
        border-radius: 14px; 
        display: flex; align-items: center; justify-content: center; 
        font-size: 22px; margin-bottom: 8px; 
    }
    .menu-name { font-size: 14px; font-weight: 800; color: var(--navy-dark); text-align: center; line-height: 1.2; }

    /* 개별 메뉴 색상 */
    .m-driver .icon-circle { background: #eff6ff; color: var(--accent-blue); }
    .m-meal .icon-circle { background: #ecfdf5; color: var(--accent-green); }
    .m-coord .icon-circle { background: #f0f9ff; color: var(--accent-sky); }
    .m-support .icon-circle { background: #fff7ed; color: var(--accent-orange); }
    .m-leader .icon-circle { background: #f5f3ff; color: var(--accent-purple); }

    /* 하단 가로 긴 버튼 (학생장 전용) */
    .full-btn { 
        grid-column: span 2; 
        flex-direction: row; 
        gap: 15px; 
        padding-left: 20px; 
        justify-content: center;
    }
    .full-btn .icon-circle { margin-bottom: 0; }

    /* 하단바 (시간 가독성) */
    .app-footer { 
        height: 60px; 
        background: var(--navy-dark); 
        color: #fff; 
        display: flex; align-items: center; justify-content: space-between; 
        padding: 0 20px; 
    }
    #footer-date { 
        font-size: 16px; 
        font-weight: 800; 
        color: #f8fafc;
        letter-spacing: 0.5px;
    }
    .footer-logo img { height: 18px; filter: brightness(0) invert(1); opacity: 0.8; }

    /* 모달 스타일 */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2000; align-items:center; justify-content:center; padding:20px; backdrop-filter: blur(8px); }
    .modal-content { background:#fff; width:100%; max-width:360px; border-radius:24px; padding:24px; }
    .input-box { width:100%; padding:14px; margin-bottom:10px; border:2px solid #f1f5f9; border-radius:12px; font-size:14px; font-weight:600; outline:none; }
    .save-btn { width:100%; padding:14px; background:var(--navy-dark); color:#fff; border:none; border-radius:12px; font-weight:800; cursor:pointer; font-size:15px; }
    .close-btn { background:#f1f5f9; color:#64748b; margin-top:8px; }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div style="width:30px"></div>
      <div class="header-title">KAC 교육플랫폼 통합포털</div>
      <div style="width:30px; text-align:right; cursor:pointer; font-size: 18px;" onclick="openAdminSettings()"><i class="fa-solid fa-gear"></i></div>
    </header>

    <main class="app-content">
      <div class="portal-intro">
          <h1>서비스 선택</h1>
          <p>수행하실 업무를 선택해 주세요.</p>
      </div>

      <div class="menu-grid">
        <!-- 1. 운전원 -->
        <a href="javascript:void(0)" onclick="goWithPin('driver.html', 'driver')" class="menu-card m-driver">
            <div class="icon-circle"><i class="fa-solid fa-bus"></i></div>
            <span class="menu-name">운전원</span>
        </a>
        <!-- 2. 영양사 -->
        <a href="javascript:void(0)" onclick="goWithPin('nutritionist.html', 'meal')" class="menu-card m-meal">
            <div class="icon-circle"><i class="fa-solid fa-utensils"></i></div>
            <span class="menu-name">영양사</span>
        </a>
        <!-- 3. 교육운영 (행정) -->
        <a href="javascript:void(0)" onclick="goWithPin('admin_coord.html', 'coord')" class="menu-card m-coord">
            <div class="icon-circle"><i class="fa-solid fa-user-tie"></i></div>
            <span class="menu-name">교육운영<br>(행정)</span>
        </a>
        <!-- 4. 교육지원 (생활관) -->
        <a href="javascript:void(0)" onclick="goWithPin('support_admin.html', 'support')" class="menu-card m-support">
            <div class="icon-circle"><i class="fa-solid fa-hotel"></i></div>
            <span class="menu-name">교육지원<br>(생활관)</span>
        </a>
        <!-- 5. 학생장 (가로 전체 차지) -->
        <a href="student_leader.html" class="menu-card m-leader full-btn">
            <div class="icon-circle"><i class="fa-solid fa-crown"></i></div>
            <span class="menu-name">학생장 전용 플랫폼 바로가기</span>
        </a>
      </div>
    </main>

    <footer class="app-footer">
      <div id="footer-date">00/00 (월) 00:00:00</div>
      <div class="footer-logo"><img src="logo.png" alt="KAC Logo"></div>
    </footer>
  </div>

  <!-- PIN 관리 모달 -->
  <div id="adminModal" class="modal">
    <div class="modal-content">
      <h3 style="margin-top:0; margin-bottom:15px; font-size:18px;">포털 보안 PIN 설정</h3>
      <input type="password" id="new_driver" class="input-box" placeholder="운전원 PIN">
      <input type="password" id="new_meal" class="input-box" placeholder="영양사 PIN">
      <input type="password" id="new_coord" class="input-box" placeholder="교육운영 PIN">
      <input type="password" id="new_support" class="input-box" placeholder="교육지원 PIN">
      <button class="save-btn" onclick="saveNewPins()">설정 저장</button>
      <button class="save-btn close-btn" onclick="closeModal()">닫기</button>
    </div>
  </div>

  <script>
    async function hashPin(pin) {
      const msgUint8 = new TextEncoder().encode(pin);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function goWithPin(url, role) {
      const sessionKey = 'kac_session_' + role;
      const savedSession = localStorage.getItem(sessionKey);
      const FIVE_HOURS = 5 * 60 * 60 * 1000;

      if (savedSession) {
        const data = JSON.parse(savedSession);
        if (Date.now() - data.time < FIVE_HOURS) {
          location.href = url;
          return;
        }
      }

      const userInput = prompt("접속 PIN 번호 4자리를 입력하세요.");
      if (!userInput) return;

      try {
        const snap = await firebase.database().ref(`system/portalPins/${role}`).once('value');
        const dbHashed = snap.val();

        if (!dbHashed) {
          alert("PIN이 설정되지 않았습니다.");
          return;
        }

        const userHashed = await hashPin(userInput);

        if (userHashed === dbHashed) {
          localStorage.setItem(sessionKey, JSON.stringify({ time: Date.now() }));
          location.href = url;
        } else {
          alert("잘못된 PIN 번호입니다.");
        }
      } catch (e) {
        alert("데이터 연결 오류가 발생했습니다.");
      }
    }

    async function openAdminSettings() {
      const pw = prompt("시스템 마스터 비밀번호를 입력하세요.");
      if(!pw) return;
      try {
        await firebase.auth().signInWithEmailAndPassword("admin@kac.com", pw);
        document.getElementById('adminModal').style.display = 'flex';
      } catch(e) { alert("비밀번호가 올바르지 않습니다."); }
    }

    async function saveNewPins() {
      const roles = ['driver', 'meal', 'coord', 'support'];
      for(const r of roles) {
        const val = document.getElementById(`new_${r}`).value;
        if(val) {
          if(val.length !== 4) { alert("PIN은 4자리여야 합니다."); return; }
          const hashed = await hashPin(val);
          await firebase.database().ref(`system/portalPins/${r}`).set(hashed);
        }
      }
      alert("PIN 설정이 저장되었습니다."); 
      closeModal();
    }

    function closeModal() { document.getElementById('adminModal').style.display='none'; }

    function runClock() {
      const now = new Date(); 
      const week = ['일','월','화','수','목','금','토'];
      const dateStr = `${now.getMonth()+1}/${now.getDate()}(${week[now.getDay()]})`;
      const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
      document.getElementById('footer-date').innerText = `${dateStr} ${timeStr}`;
    }
    
    setInterval(runClock, 1000); 
    runClock();
  </script>
</body>
</html>