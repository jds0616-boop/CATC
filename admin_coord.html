<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>항공기술훈련원 교육운영부 - 통합 행정 관리</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>



/* 수송 요청 시간 그리드 */
.trans-time-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    background: #f8fafc;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}
.time-input-group { display: flex; flex-direction: column; gap: 5px; }
.time-input-group label { font-size: 10px; font-weight: 800; color: #64748b; }






/* 야간 모드나 주간 모드에서 생활관 정보 강조 */
#allStudentTableBody td:nth-child(3) {
    color: var(--blue-deep) !important;
    font-weight: 800;
}



/* 통합 명단 모바일 최적화 CSS */
#allStudentListView .navy-table {
    table-layout: fixed; /* 테이블 크기 고정 */
    width: 100%;
}

#allStudentListView .navy-table th, 
#allStudentListView .navy-table td {
    padding: 8px 2px; /* 패딩 최소화 */
    font-size: 11px; /* 폰트 크기 축소 */
    word-break: break-all;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* 과정명 열 전용 말줄임 스타일 */
.course-name-cell {
    max-width: 75px; /* 최대 너비 제한 */
    display: inline-block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    vertical-align: middle;
    font-weight: 800;
}

/* 상태 배지 크기 축소 */
.badge-shuttle {
    padding: 2px 4px;
    font-size: 9px;
}




/* [변경] 리스트 카드 - 부드러운 화이트 카드 스타일 */
.course-item-card {
    background: #ffffff; 
    border-radius: 16px; 
    display: flex; 
    align-items: center; 
    cursor: pointer; 
    margin-bottom: 12px; 
    border: 1px solid #e2e8f0; /* 얇은 회색 테두리 */
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
    overflow: hidden;
    transition: all 0.2s ease;
}


/* 마우스를 올렸을 때 테두리가 더 강조되는 효과 */
.course-item-card:hover {
    border-color: var(--blue-main);
    background: #f8fafc;
    transform: translateX(5px); /* 옆으로 살짝 밀리는 효과 */
}



    .course-item-card:active { transform: scale(0.98); }
    .course-color-bar { width: 6px; height: 60px; flex-shrink: 0; }
    .course-info-content { flex: 1; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
/* --- 여기까지 추가 --- */



    :root {
      --navy-dark: #0f172a; --blue-main: #0ea5e9; --blue-deep: #0369a1;
      --green-save: #10b981; --bg-cool: #f1f5f9; --card-white: #ffffff;
      --text-dark: #1e293b; --border-blue: #e2e8f0; --danger: #ef4444;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; padding: 0; font-family: 'Pretendard', sans-serif;
      background: #cfd8e3; display: flex; justify-content: center; color: var(--text-dark);
      overflow-x: hidden;
    }
    .app-container { width: 100%; max-width: 600px; min-height: 100dvh; background: var(--bg-cool); position: relative; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.1); }
    
    /* 상단바 */
    .app-header { height: 55px; background: var(--navy-dark); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; border-bottom: 2px solid var(--blue-main); position: sticky; top:0; z-index: 1000; }
    .header-btn { font-size: 20px; color: #fff; cursor: pointer; border:none; background:none; }
    .header-title { color: #fff; font-size: 18px; font-weight: 900; letter-spacing: -0.5px; }

    .app-content { flex: 1; padding: 12px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }


/* [변경] 큰 카드 디자인 - 테두리는 연하게, 그림자는 부드럽게 */
.section-card { 
    background: var(--card-white); 
    border-radius: 20px; 
    padding: 20px; 
    /* 테두리를 1px에 연한 회색으로 변경 */
    border: 1px solid #e2e8f0 !important; 
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03); 
    margin-bottom: 10px;
}
    .section-title { font-size: 13px; font-weight: 800; color: var(--blue-deep); margin-bottom: 12px; display: flex; align-items: center; justify-content: flex-start; gap: 8px; }
    
    .navy-select, .navy-input { width: 100%; height: 40px; border-radius: 8px; border: 1.5px solid var(--border-blue); background: #f8fafc; padding: 0 10px; font-size: 13px; font-weight: 800; color: var(--navy-dark); outline: none; }




/* [가독성 강화] 공지사항 입력창 - 글자 크기 및 폰트 강조 */
.notice-area { 
    width: 100%; 
    min-height: 120px; /* 입력창을 좀 더 시원하게 키움 */
    border-radius: 15px; 
    border: 1.5px solid #dbeafe !important; 
    background: #f8fafc !important; 
    padding: 20px; /* 내부 여백을 늘려 답답함 해소 */
    
    /* 가독성 핵심 설정 */
    font-family: 'Pretendard', sans-serif; /* 깔끔한 고딕체 */
    font-size: 18px;    /* 글자 크기 확대 (기존 14px -> 18px) */
    font-weight: 800;   /* 글자 두께를 아주 굵게 설정 */
    line-height: 1.8;   /* 줄 간격을 넓게 주어 가독성 확보 */
    color: #0f172a !important; /* 완전 진한 남색으로 명암 대비 강화 */
    
    resize: none; 
    margin-bottom: 15px; 
    outline: none;
    transition: all 0.2s;
}

/* 글 작성 시 입력창이 더 하얗고 선명하게 변하는 효과 */
.notice-area:focus {
    border-color: #3b82f6 !important;
    background-color: #ffffff !important;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}




.shuttle-detail-section { margin-bottom: 20px; border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; }
.shuttle-detail-header { padding: 10px 15px; font-weight: 800; font-size: 13px; display: flex; justify-content: space-between; }
/* [변경] 상세 명단 리스트 - 3열 격자 정렬 (바둑판 모양) */
.shuttle-detail-list { 
    display: grid;
    /* 화면 너비에 맞춰 3칸씩 똑같이 나눔 */
    grid-template-columns: repeat(3, 1fr); 
    gap: 8px; /* 칸 사이 간격 */
    padding: 15px; 
    background: #fff; 
}

/* 개별 이름표 스타일 */
.shuttle-detail-list span {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    padding: 8px 2px; /* 위아래 여백 */
    border-radius: 8px;
    font-size: 11.5px; /* 글자가 박스를 넘지 않도록 살짝 조절 */
    font-weight: 700;
    color: #334155;
    text-align: center;
    white-space: nowrap; /* 글자 줄바꿈 방지 */
    display: flex;
    align-items: center;
    justify-content: center;
}

/* 모바일 화면이 아주 작을 경우를 대비해 2열로 자동 조절 */
@media (max-width: 360px) {
    .shuttle-detail-list { grid-template-columns: repeat(2, 1fr); }
}

/* 테이블 행 호버 효과 */
.shuttle-row-hover:hover td {
    background-color: #f8fafc !important;
    color: var(--blue-main) !important;
}



/* 항목별 컬러 */
.bg-osong { background: #fee2e2; color: #ef4444; }
.bg-terminal { background: #dbeafe; color: #3b82f6; }
.bg-airport { background: #dcfce7; color: #10b981; }
.bg-car { background: #f1f5f9; color: #64748b; }
.bg-none { background: #fef3c7; color: #d97706; }










/* 상황판 그리드 전체 디자인 - 2x2 배치 */
.global-status-grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 12px; 
    width: 100%; 
    margin-bottom: 20px;
}

/* [핵심] 모든 버튼형 카드의 공통 기반 스타일 (레이아웃 통일) */
.dashboard-card-btn {
    height: 130px; /* 높이 고정 */
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    justify-content: space-between; /* 요소들을 상-중-하로 균등 배정 */
    align-items: center;
    cursor: pointer;
    transition: all 0.25s ease;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    border: 1px solid rgba(255, 255, 255, 0.1); /* 어두운 버튼용 */
    position: relative;
    overflow: hidden;
    text-align: center;
    box-sizing: border-box;
    padding: 15px 10px; /* 내부 여백 통일 */
}

/* 마우스 올렸을 때 효과 */
.dashboard-card-btn:hover {
    transform: translateY(-5px); 
    box-shadow: 0 12px 24px rgba(0,0,0,0.4);
}

/* 내부 텍스트 및 아이콘 정밀 위치 고정 */
.dashboard-card-btn .label { 
    font-size: 11px; 
    font-weight: 700; 
    opacity: 0.8; 
    margin-bottom: 0; 
}

.dashboard-card-btn .val { 
    font-size: 26px; 
    font-weight: 900; 
    line-height: 1;
    margin: 5px 0;
}

.dashboard-card-btn .val small { 
    font-size: 14px; 
    margin-left: 2px; 
    font-weight: 700;
}

.dashboard-card-btn i { 
    font-size: 22px; /* 아이콘 크기 통일 */
    margin-top: 5px;
}

/* [통일] 모든 상황판 버튼을 헤더와 동일한 딥블루 그라데이션으로 변경 */

/* 1번 카드: 전체 교육생 */
.stat-dark { 
    background: linear-gradient(135deg, #003366 0%, #0055aa 100%) !important; 
    color: white !important; 
    border: 1px solid rgba(255, 255, 255, 0.2) !important; /* 은은한 흰색 테두리 */
}
.stat-dark .val { color: #60a5fa !important; } /* 밝은 하늘색 숫자 */
.stat-dark i { color: #60a5fa !important; }

/* 2번 카드: 외출/외박 */
.stat-blue { 
    background: linear-gradient(135deg, #003366 0%, #0055aa 100%) !important; 
    color: white !important; 
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
}
.stat-blue .val { color: #fbbf24 !important; } /* 노란색 숫자 */
.stat-blue i { color: #fbbf24 !important; }

/* 3, 4번 카드: 하단 액션 버튼 (화이트에서 딥블루로 변경) */
.action-white { 
    background: linear-gradient(135deg, #003366 0%, #0055aa 100%) !important; 
    color: white !important;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
}
/* 3, 4번 카드의 내부 글자와 아이콘 색상 보정 */
.action-white .label { color: rgba(255, 255, 255, 0.7) !important; }
.action-white .val { color: white !important; }
.action-white .icon-pickup { color: #a5b4fc !important; } /* 연보라색 아이콘 */
.action-white .icon-shuttle { color: #fcd34d !important; } /* 황금색 아이콘 */





    /* 개별 과정 현황 박스 */
    .dashboard-split { display: flex; gap: 8px; align-items: stretch; width: 100%; }
    .col-1-3 { flex: 1; }
    .col-2-3 { flex: 2.5; }
    /* [변경] 상세페이지 입교 현황 박스 - 남색 실선 적용 */
.entry-box { 
    background: #f0f7ff !important; /* 아주 연한 파란색 채우기 */
    border: 1px solid #dbeafe !important; /* 배경보다 살짝 진한 테두리 */
    border-radius: 16px; 
    padding: 15px; 
    text-align: center; 
    height: 100%; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    cursor: pointer; 
    transition: all 0.2s ease;
}
.entry-box:hover {
    transform: translateY(-2px);
    border-color: var(--blue-main) !important;
}
    .entry-val { font-size: 24px; font-weight: 900; color: var(--navy-dark); }
    .shuttle-grid { display: flex; justify-content: space-between; gap: 4px; height: 100%; }
    .shuttle-item { flex: 1; background: #fff; border-radius: 8px; padding: 10px 2px; border: 1px solid #eef2f6; text-align: center; display: flex; flex-direction: column; justify-content: center; cursor: pointer; }
    .shuttle-item span { font-size: 10px; color: #64748b; display: block; margin-bottom: 4px; font-weight: 700; }
    .shuttle-item b { font-size: 16px; color: var(--navy-dark); font-weight: 900; }

/* 테이블 레이아웃 최적화 */
.navy-table { width: 100%; border-collapse: separate; border-spacing: 0; }
.navy-table th { 
    background: #f8fafc; 
    padding: 12px 8px; 
    border-bottom: 2px solid #e2e8f0; 
    color: #475569; 
    font-size: 12px; 
    font-weight: 800;
}



.navy-table th, .navy-table td { 
    padding: 14px 8px; 
    border-bottom: 1px solid #f1f5f9; 
    font-size: 13px; 
    color: #1e293b; 
    vertical-align: middle; 
    text-align: center !important; /* 가로 정렬 가운데 강제 */
}




/* 마우스 올리면 줄 색상 변경 */
.navy-table tr:hover td { background-color: #f8fafc; }




/* 상태 배지 디자인 정돈 */
.badge-status {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 800;
    display: inline-block;
    white-space: nowrap;
}
.badge-pending { background: #fff7ed; color: #ea580c; border: 1px solid #ffedd5; }
.badge-approved { background: #f0fdf4; color: #16a34a; border: 1px solid #dcfce7; }

/* 취소 버튼 디자인 */
.btn-cancel-mini {
    background: #fff;
    color: #94a3b8;
    border: 1px solid #e2e8f0;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 10px;
    cursor: pointer;
    margin-left: 4px;
    transition: 0.2s;
}
.btn-cancel-mini:hover { background: #fee2e2; color: #ef4444; border-color: #fecaca; }








    /* 서명 이미지(도장) 스타일 */
    .stamp-img { height: 35px; width: auto; object-fit: contain; mix-blend-mode: multiply; filter: contrast(1.2); }

    .navy-btn { width: 100%; height: 40px; border-radius: 8px; background: var(--blue-main); color: white; border: none; font-weight: 800; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; }
    .navy-btn:active { transform: scale(0.98); opacity: 0.9; }
    .navy-btn.green { background: var(--green-save); }
    .navy-btn.red { background: var(--danger); }

    /* 사이드 메뉴 */
.side-menu { 
    position: fixed; 
    top: 0; 
    right: -280px; 
    width: 280px; 
    height: 100%; 
    background: white; 
    z-index: 5000; 
    transition: 0.3s; 
    box-shadow: -5px 0 15px rgba(0,0,0,0.1); 
    padding: 20px; 
    display: flex; 
    flex-direction: column; 
    gap: 15px;
    /* [추가] 메뉴 내부 내용이 길면 메뉴 안에서만 스크롤 가능하게 함 */
    overflow-y: auto; 
}
    .side-menu.open { right: 0; }
    .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4500; display: none; }

    /* 모달 공통 */
    .setup-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:6000; align-items:center; justify-content:center; padding:15px; }
    .setup-box { background:white; width:100%; max-width:500px; border-radius:24px; padding:25px; max-height:90vh; overflow-y:auto; overflow-x: hidden; position: relative; }
    .setup-label { display: block; font-size: 12px; font-weight: 800; color: #64748b; margin-bottom: 6px; }

    /* 하단 푸터 */
    .app-footer { height: 50px; background: var(--navy-dark); color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; font-size: 12px; }
    .footer-logo img { height: 18px !important; filter: brightness(0) invert(1); opacity: 0.8; }

    /* 인쇄 로딩 레이어 */
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9000; display: none; align-items: center; justify-content: center; flex-direction: column; }
    .progress-bar { width: 180px; height: 8px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-top: 15px; }
    .progress-fill { height: 100%; background: var(--blue-main); width: 0%; transition: width 0.1s; }

    /* 관리대장 뷰 (중앙 배치) */
    #outingManagerView { display:none; position:fixed; top:0; left:50%; transform:translateX(-50%); width:100%; max-width:600px; height:100%; background:#f1f5f9; z-index:4000; flex-direction:column; box-shadow: 0 0 30px rgba(0,0,0,0.2); }

    @media print { .no-print { display: none !important; } #print-area { display: block !important; } .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; } .print-table th, .print-table td { border: 1px solid #000; padding: 10px; text-align: center; } }
    #print-area { display: none; }




/* 실시간 업데이트 배지 스타일 */
    .live-badge {
        display: inline-flex; align-items: center; gap: 5px;
        background: #f8fafc; border: 1px solid #e2e8f0;
        padding: 4px 10px; border-radius: 50px;
        font-size: 11px; font-weight: 800; color: #64748b;
    }
    .live-badge i { color: #3b82f6; font-size: 10px; }

    /* 전체 교육생 명단 모달 내부 테이블 보정 */
    .modal-scroll-area { max-height: 450px; overflow-y: auto; border: 1px solid #eee; border-radius: 12px; background: #fff; }








/* 수송 리스트 전용 슬림 테이블 디자인 */
.pickup-grid-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

.pickup-grid-table th {
    background: #f1f5f9;
    color: #475569;
    font-size: 11px;
    font-weight: 800;
    padding: 10px 5px;
    border-bottom: 2px solid #e2e8f0;
    text-transform: uppercase;
}

.pickup-grid-table td {
    padding: 8px 5px; /* 세로 간격을 줄여 슬림하게 만듦 */
    border-bottom: 1px solid #f1f5f9;
    font-size: 12px;
    color: #334155;
    vertical-align: middle;
    white-space: nowrap; /* 글자가 절대 줄바꿈되지 않음 */
}

/* 과정명: 말줄임표 처리 */
.td-course {
    max-width: 130px;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 700;
    color: #0369a1;
    text-align: left !important;
    padding-left: 15px !important;
}

/* 날짜/시간: 고정폭 폰트와 간결한 배치 */
.td-time {
    font-family: 'Pretendard', sans-serif;
    font-weight: 600;
    color: #1e293b;
    text-align: center;
}
.td-time span { color: #94a3b8; font-size: 10px; font-weight: 400; margin-right: 4px; }

/* 입교/퇴교 배지: 세련된 라운드 캡슐형 */
.badge-dir {
    padding: 2px 8px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 800;
}
.dir-in { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
.dir-out { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }

/* 기사 승인 상태 */
.status-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}
.dot-pending { width: 6px; height: 6px; background: #f59e0b; border-radius: 50%; display: inline-block; }
.dot-approved { width: 6px; height: 6px; background: #10b981; border-radius: 50%; display: inline-block; }

/* 취소 링크형 버튼 */
.btn-del-link {
    background: none;
    border: none;
    color: #94a3b8;
    text-decoration: underline;
    font-size: 10px;
    cursor: pointer;
    padding: 0 5px;
}
.btn-del-link:hover { color: #ef4444; }




/* 관리자용 실시간 수송 톡 배경 */
#pickupCardContainer {
    background: #abc1d1;
    flex: 1;
    overflow-y: auto !important;
    display: flex; 
    flex-direction: column; 
    gap: 15px;
    padding: 15px; 
    min-height: 0;
    /* 스크롤이 즉각적으로 맨 아래로 꽂히도록 behavior를 auto로 설정 */
    scroll-behavior: auto !important; 
}

    /* 날짜 구분선 */
    .chat-date-line { text-align: center; margin: 10px 0; }
    .chat-date-line span {
      background: rgba(0,0,0,0.15); color: #fff;
      padding: 5px 15px; border-radius: 20px; font-size: 11px; font-weight: 800;
    }

    /* 말풍선 공통 */
    .chat-bubble { max-width: 85%; position: relative; display: flex; flex-direction: column; margin-bottom: 5px; }
    
    /* 기사님 답변 (왼쪽 - 나에게 온 메시지) */
    .chat-left { align-self: flex-start; }
    .bubble-driver {
      background: #fff; padding: 12px; border-radius: 0 12px 12px 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 13px; font-weight: 800; color: #1e293b;
    }

    /* 내가 보낸 요청 (오른쪽 - 내가 보낸 메시지) */
    .chat-right { align-self: flex-end; }
    .bubble-admin {
      background: #fee500; padding: 12px; border-radius: 12px 0 12px 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 14px; line-height: 1.5; color: #1e293b;
    }

    /* 톡 양식 내부 텍스트 */
    .talk-header { font-size: 11px; color: #64748b; margin-bottom: 4px; font-weight: 800; }
    .talk-body { font-weight: 700; white-space: pre-line; }
    
    /* 톡 하단 관리 도구 */
    .talk-footer {
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 10px; padding-top: 8px; border-top: 1px dashed rgba(0,0,0,0.1);
    }
    .btn-cancel-talk {
      background: none; border: none; color: #ef4444; font-size: 11px; 
      font-weight: 800; text-decoration: underline; cursor: pointer;
    }

    .chat-time { font-size: 10px; color: #666; margin-top: 4px; }
    .chat-right .chat-time { align-self: flex-end; }




/* [변경] 퇴교차량 박스 - 연한 블루 배경 채우기 */
.shuttle-group-box {
    background: #f0f7ff !important; /* 동일한 블루 배경 */
    border: 1px solid #dbeafe !important; 
    border-radius: 16px;
    box-shadow: none !important;
}

.entry-box:hover, .shuttle-group-box:hover {
    background: #e0f2fe !important;
    transform: translateY(-2px);
}




/* 퇴교 수송 그룹 박스 호버 효과 */
.shuttle-group-box:hover {
    background-color: #f8fafc !important;
    border-color: #3b82f6 !important;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1) !important;
}
.shuttle-group-box:active {
    transform: translateY(0);
    filter: brightness(0.95);
}



/* [수정] 하단 푸터 제거 */
.app-footer { 
    display: none !important; 
}

/* [수정] 홈 버튼 - 기사 플랫폼과 동일한 원형 플로팅 디자인 */
#floatingHomeBtn {
    width: 56px; 
    height: 56px;
    background: var(--blue-main); 
    color: #fff;
    border-radius: 50%;
    display: none; /* 기본 숨김 (모달이나 서브페이지에서만 노출) */
    align-items: center;
    justify-content: center;
    position: fixed;
    bottom: 30px; /* 바닥에서 30px 띄움 */
    left: 50%; 
    transform: translateX(-50%); 
    box-shadow: 0 8px 20px rgba(0,0,0,0.3); 
    cursor: pointer;
    border: 4px solid #fff; /* 흰색 테두리 */
    z-index: 10000 !important;
    transition: 0.2s;
}

/* 홈 버튼 내부 아이콘 크기 조정 및 글자 숨김 */
#floatingHomeBtn i { 
    font-size: 22px; 
    color: #fff !important; 
}
#floatingHomeBtn span { 
    display: none; /* "홈으로" 글자 제거 */
}

#floatingHomeBtn:active { 
    transform: translateX(-50%) scale(0.9); 
}

/* 앱 컨테이너 높이 보정 (하단바가 없으므로 여백 조정) */
.app-container {
    min-height: 100dvh;
}


/* 팝업 또는 메뉴 열렸을 때 뒷배경 스크롤 방지 */
body.modal-open {
    overflow: hidden !important;
    position: fixed; /* 화면을 현재 위치에 고정 */
    width: 100%;
    height: 100%;
    touch-action: none; /* 터치 스크롤 방지 */
}


/* 실제 스크롤이 일어나는 내부 영역도 차단 */
body.modal-open .app-content {
    overflow: hidden !important;
    touch-action: none;
}




/* 팝업 내용물 영역 스크롤 최적화 */
.setup-box {
    overscroll-behavior: contain; /* 스크롤이 끝에 닿아도 부모로 전달되지 않음 */
    -webkit-overflow-scrolling: touch;
}



/* [수정] 강사 수송 통합 현황 뷰 - 전체 높이 고정 및 레이아웃 구조 */
#pickupStatusView.view-card-full {
    /* 화면 전체 높이에서 상단바(55px), 하단바(50px), 컨텐츠 여백(24px)을 뺀 높이 점유 */
    height: calc(100dvh - 55px - 50px - 24px); 
    display: flex;
    flex-direction: column;
}

/* [수정] 수송 리스트 카드 - 내부 스크롤을 위해 패딩 제거 및 flex 적용 */
#pickupStatusView .section-card { 
    background: var(--card-white); 
    border-radius: 20px; 
    padding: 0 !important; /* 내부 패딩 제거 (제목과 리스트가 밀착되도록) */
    border: 1px solid #e2e8f0 !important; 
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03); 
    margin-bottom: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* 카드 밖으로 스크롤이 나가지 않게 차단 */
    flex: 1;
}

/* [틀고정 대상] 제목 줄 - Sticky 속성 부여 */
#pickupStatusView .section-title { 
    position: sticky;
    top: 0;
    z-index: 20;
    background: white;
    padding: 18px 20px; /* 고정된 상태에서도 여백 유지 */
    margin-bottom: 0; 
    border-bottom: 1.5px solid #f1f5f9; /* 제목과 리스트 구분선 */
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    gap: 8px; 
}

/* [스크롤 영역] 실시간 수송 톡 배경 컨테이너 */
#pickupCardContainer {
    background: #abc1d1; /* 카톡 배경색 */
    flex: 1; /* 남은 공간 모두 차지 */
    overflow-y: auto !important; /* 내부 스크롤 활성화 */
    display: flex; 
    flex-direction: column; 
    gap: 15px;
    padding: 15px; 
    min-height: 0; /* flex 자식의 스크롤 작동 필수 속성 */
}


/* 퇴교 차량 배지 */
.badge-shuttle { padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 800; }
.badge-osong { background: #fee2e2; color: #ef4444; }
.badge-terminal { background: #dbeafe; color: #3b82f6; }
.badge-airport { background: #dcfce7; color: #10b981; }
.badge-car { background: #f1f5f9; color: #64748b; }

/* 외출외박 상태 표시 */
.status-action { font-size: 12px; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 4px; }
.text-outing { color: #ea580c; }
.text-overnight { color: #dc2626; }











/* [복구] 사용자님 방식의 표 형식 + 간격 초압축 */
#allStudentListView .section-card {
    padding: 8px 2px !important; /* 카드 내부 여백 제거 */
}

#allStudentListView .navy-table {
    table-layout: fixed !important; /* 표 너비 강제 고정 (가로 슬라이드 방지 핵심) */
    width: 100% !important;
    border-collapse: collapse !important;
    margin: 0 !important;
}

#allStudentListView .navy-table th, 
#allStudentListView .navy-table td {
    padding: 6px 1px !important; /* 셀 사이 간격을 거의 0으로 축소 */
    font-size: 10px !important;    /* 폰트 크기 최적화 */
    letter-spacing: -0.8px;       /* 자간 압축 */
    text-align: center !important;
    border-bottom: 1px solid #f1f5f9;
    word-break: break-all;        /* 내용이 길면 아래로 자동 줄바꿈 */
}

/* 5개 열 너비 비율 강제 고정 (합계 100%) */
.col-1 { width: 22%; } /* 과정명 */
.col-2 { width: 17%; } /* 성함 */
.col-3 { width: 22%; } /* 생활관 */
.col-4 { width: 17%; } /* 차량 */
.col-5 { width: 22%; } /* 외출 */

/* 과정명 2줄까지만 허용하고 자르기 */
.course-cell {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    color: #64748b;
    font-size: 9px;
}

/* 성함 및 기숙사 강조 */
.bold-text { font-weight: 800; color: #1e293b; display: block; }
.blue-text { font-weight: 800; color: #2563eb; display: block; }

/* 하단 홈 버튼 여백 */
#allStudentTableBody tr:last-child td {
    padding-bottom: 120px !important;
}





  </style>
</head>
<body>

  <div id="loadingOverlay" class="loading-overlay">
      <div style="font-weight:900; color:var(--navy-dark);">실시간 데이터를 동기화 중입니다...</div>
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
  </div>

  <div class="app-container no-print">
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu(false)"></div>
    <div id="sideMenu" class="side-menu">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-size:16px; color:var(--navy-dark);">행정 지원 메뉴</h3>
        <i class="fa-solid fa-xmark" style="cursor:pointer; font-size:22px;" onclick="toggleMenu(false)"></i>
      </div>

<div id="side-global-menu" style="display:none; flex-direction:column; gap:12px;">
    <!-- [복구] 과정 추가 및 개설 버튼 -->
    <button class="navy-btn" style="background:#3b82f6; height:45px;" onclick="openSetupModal()">
        <i class="fa-solid fa-plus-circle"></i> 교육과정 추가/설정
    </button>
    <!-- 여기에 QR 보기 버튼을 추가로 배치하면 편리합니다 -->
    <button class="navy-btn" style="background:#1e293b; height:45px;" onclick="openCenterQrModal()">
        <i class="fa-solid fa-qrcode"></i> 행정관리 접속용 QR
    </button>
</div>

<div id="side-individual-menu" style="display:none; flex-direction:column; gap:12px;">
          <button class="navy-btn" style="background:var(--blue-deep); height:45px;" onclick="openSetupModalFromIndividual()">
              <i class="fa-solid fa-sliders"></i> 해당 과정 설정 수정
          </button>
          <div class="section-card" style="padding:10px;">
              <div class="section-title"><i class="fa-solid fa-qrcode"></i> 출결 QR 관리</div>
              <div id="qrPreviewArea" style="background:#f8fafc; border:1px solid #eee; border-radius:8px; padding:10px; text-align:center;">
                  <img id="qrPreview" style="max-width:100%; max-height:120px; display:none;">
                  <div id="qrEmpty" style="font-size:11px; color:#94a3b8; padding:10px;">등록된 QR 없음</div>
              </div>
              <input type="file" id="qrFile" accept="image/*" style="display:none;" onchange="handleQRUpload(this)">
              <button class="navy-btn" style="background:#64748b; height:35px; font-size:11px; margin-top:10px;" onclick="document.getElementById('qrFile').click()">QR 이미지 교체</button>
          </div>
          <button class="navy-btn" style="background:#6366f1; height:45px;" onclick="openTransportModal()">
              <i class="fa-solid fa-car-side"></i> 강사 수송 요청
          </button>
          <!-- 생활관 배정현황 버튼 추가 -->
          <button class="navy-btn" style="background:#10b981; height:45px;" onclick="openDormManager()">
              <i class="fa-solid fa-bed"></i> 생활관 배정현황 조회
          </button>
          <button class="navy-btn red" style="height:45px; margin-top: 10px;" onclick="resetIndividualCourse()">
              <i class="fa-solid fa-triangle-exclamation"></i> 교육과정 강제 리셋
          </button>
      </div>
    </div>

<!-- 상단 헤더 부분 -->
<header class="app-header">
  <!-- 아이콘 대신 << 텍스트로 변경 및 클릭 시 handleBackNav 호출 -->
  <button class="header-btn" onclick="handleBackNav()" style="font-family: 'Pretendard'; font-weight: 900; letter-spacing: -2px;">&lt;&lt;</button>
  <div class="header-title">항공기술훈련원 교육운영부</div>
  <div style="display:flex; gap:15px; align-items:center;">
      <button class="header-btn" onclick="openCenterQrModal()"><i class="fa-solid fa-qrcode"></i></button>
      <button class="header-btn" onclick="toggleMenu(true)"><i class="fa-solid fa-bars"></i></button>
  </div>
</header>


    <main class="app-content">
<!-- [뷰 1] 전체 과정 현황 (메인) -->
<div id="totalStatusView" style="display:flex; flex-direction:column; gap:12px;">
    
    <!-- 4개 상단 상황판 카드 -->
    <div class="global-status-grid">
        <!-- 1번 카드: 전체 교육생 -->
        <div class="dashboard-card-btn stat-dark" onclick="showTotalStudentList()">
            <div class="label">항기원 전체 교육생 현황 / 찾기</div>
            <div class="val"><span id="g-total-students">0</span><small>명</small></div>
            <i class="fa-solid fa-users"></i>
        </div>

        <!-- 2번 카드: 금일 외출/외박 (클릭 시 상세페이지 이동) -->
        <div class="dashboard-card-btn stat-blue" onclick="openOutingManager()">
            <div class="label">금일 외출·외박 신청 현황</div>
            <div class="val"><span id="g-today-actions">0</span><small>건</small></div>
            <i class="fa-solid fa-file-signature"></i>
        </div>

        <!-- 3번 카드: 강사 픽업 현황 -->
        <div class="dashboard-card-btn action-white" onclick="showPickupView()">
            <div class="label">강사 픽업요청 신청 및 조회</div>
            <div class="val"><span id="g-pickup-count">0</span><small>건</small></div>
            <i class="fa-solid fa-car-side icon-pickup"></i>
        </div>

        <!-- 4번 카드: 교육생 퇴교 현황 -->
        <div class="dashboard-card-btn action-white" onclick="showStudentShuttleView()">
            <div class="label">교육생 퇴교 차량 신청 현황</div>
            <div class="val"><span id="g-shuttle-count">0</span><small>명</small></div>
            <i class="fa-solid fa-bus icon-shuttle"></i>
        </div>
    </div>

    <!-- ✅ [복구 완료] 현재 운영 중인 과정 리스트 섹션 -->
    <div class="section-card">
        <div class="section-title"><i class="fa-solid fa-list-ul"></i> 현재 운영 중인 과정 </div>
        <div id="activeCourseList" style="display:flex; flex-direction:column; gap:8px;">
            <!-- 자바스크립트가 여기에 ROOM A, ROOM C 등의 카드를 채워넣습니다 -->
        </div>
    </div>


<!-- [이동됨] 항기원 전체 공지 (센터 공통 공지) -->
<div class="section-card">
    <div class="section-title"><i class="fa-solid fa-earth-asia"></i> 과정 전체 공지 (모든과정에 표출됩니다!!)</div>
    <textarea id="globalNotice" class="notice-area" oninput="autoGrow(this)" placeholder="센터 전체 공지 입력"></textarea>
    <button class="navy-btn green" onclick="saveGlobalNotice()">모든 과정에 공지사항 보내기</button>
</div>






</div> <!-- totalStatusView 닫기 -->




<!-- [수정] 강사 픽업 통합 현황 테이블 -->
<div id="pickupStatusView" class="view-card-full" style="display:none; flex-direction:column; gap:12px;">
    <div class="section-card">
        <div class="section-title" style="justify-content:space-between;">
            <span><i class="fa-solid fa-car-side"></i> 강사 수송 통합 예약 리스트</span>
            <button class="navy-btn" style="width:120px; height:32px; font-size:11px;" onclick="openTransportModal()">
                <i class="fa-solid fa-plus"></i> 수송 추가요청
            </button>
        </div>
        <div style="overflow-x: auto;">
<!-- 수송 리스트를 담을 모바일 대응 컨테이너 -->
<div id="pickupCardContainer" style="display: flex; flex-direction: column; gap: 12px; margin-top: 10px;">
    <!-- 자바스크립트가 여기에 카드들을 채워넣습니다 -->
</div>

        </div>
    </div>
</div>




      <!-- [신규 뷰 4] 교육생 퇴교차량 통합 현황 -->
      <div id="studentShuttleView" class="view-card-full" style="display:none; flex-direction:column; gap:12px;">
          <div class="section-card">
              <div class="section-title"><i class="fa-solid fa-bus"></i> 과정별 퇴교차량 신청 총괄</div>
              <div style="overflow-x: auto;">
                  <table class="navy-table">
                      <thead>
                          <tr><th>과정명</th><th>총원</th><th>오송역</th><th>터미널</th><th>공항</th><th>자차</th></tr>
                      </thead>
                      <tbody id="shuttleTotalTableBody">
                          <!-- JS에서 내용 채움 -->
                      </tbody>
                  </table>
              </div>
          </div>
      </div>









<!-- [신규 뷰 5] 항기원 전체 교육생 통합 관리 페이지 -->
<div id="allStudentListView" class="view-card-full" style="display:none; flex-direction:column; gap:12px;">
    <div class="section-card" style="flex: 1; display: flex; flex-direction: column;">
        <div class="section-title" style="justify-content: space-between; align-items: center;">
            <span><i class="fa-solid fa-users-viewfinder"></i> 항기원 교육생 통합 명단</span>
            <div class="live-badge"><i class="fa-solid fa-sync fa-spin"></i> 실시간</div>
        </div>

        <!-- 상단 검색바 구역 -->
        <div style="margin-bottom: 15px; position: relative;">
            <i class="fa-solid fa-magnifying-glass" style="position: absolute; left: 15px; top: 13px; color: #94a3b8;"></i>
            <input type="text" id="studentSearchInput" class="navy-input" 
                   style="padding-left: 40px; height: 45px; border-radius: 12px; font-size: 15px;" 
                   placeholder="교육생 성함 또는 과정명을 입력하세요..." oninput="filterAllStudents()">
        </div>

        <!-- 명단 테이블 구역 -->
        <div style="flex: 1; overflow-y: auto; border: 1px solid #f1f5f9; border-radius: 12px;">
            <table class="navy-table" style="min-width: 500px;">
<thead style="position: sticky; top: 0; z-index: 10; background: #f8fafc;">
    <tr>
        <th class="col-course">과정명</th>
        <th class="col-name">성함</th>
        <th class="col-dorm">생활관</th>
        <th class="col-shuttle">차량</th>
        <th class="col-outing">외출</th>
    </tr>
</thead>
                <tbody id="allStudentTableBody">
                    <!-- JS에서 내용 채움 -->
                </tbody>
            </table>
        </div>
    </div>
</div>
































      <!-- [뷰 2] 개별 과정 상세 -->
      <div id="individualStatusView" style="display:none; flex-direction:column; gap:12px;">
          <div id="indCourseHeader" style="background: linear-gradient(135deg, #003366 0%, #0055aa 100%); border-radius: 12px; padding: 22px 25px; margin-bottom: 10px; color: #ffffff; box-shadow: 0 4px 12px rgba(0, 51, 102, 0.2); display: flex; flex-direction: column; gap: 12px;">
              <div style="display: flex; align-items: baseline; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.15); padding-bottom: 12px;">
                  <span style="font-weight: 900; font-size: 14px; color: #60a5fa;">ROOM <span id="ind-room-id">-</span></span>
                  <span id="ind-course-name" style="font-weight: 800; font-size: 19px;">과정명 로딩 중...</span>
              </div>
              <div style="display: flex; flex-wrap: wrap; gap: 10px 20px; font-size: 12.5px;">
                  <div><span style="opacity: 0.6;">교육기간:</span> <span id="ind-period">-</span></div>
                  <div><span style="opacity: 0.6;">담당교수:</span> <span id="ind-prof">-</span></div>
                  <div><span style="opacity: 0.6;">과정담당:</span> <span id="ind-coord">-</span></div>
                  <div><span style="opacity: 0.6;">강의실:</span> <span id="ind-room-loc">-</span></div>
                  <div style="width:100%; color: #fbbf24; font-weight: 800; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px; margin-top:5px;">
                    <i class="fa-solid fa-crown"></i> 학생장: <span id="ind-leader">지정된 학생장 없음</span>
                  </div>
              </div>
          </div>

          <div class="dashboard-split">
              <div class="col-1-3"><div class="entry-box" onclick="showEntryMemberList()"><span style="font-size:11px; font-weight:800; color:var(--blue-deep);">입교 현황</span><div class="entry-val" id="ind-entry-cnt">0<span>명</span></div></div></div>
              <div class="col-2-3">
              <div class="section-card" style="height:100%; padding:10px; display:flex; flex-direction:column; justify-content:center;">
                  <div class="section-title" style="margin-bottom:8px; font-size:11px;">
                      <i class="fa-solid fa-bus"></i> 퇴교 차량 수요조사 (실시간)
                  </div>


<div class="shuttle-group-box" onclick="showShuttleApplicationDetails(currentRID)" style="background: #ffffff; border: 1.5px solid #e2e8f0; border-radius: 15px; padding: 15px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.02); height: 75px;">
    <!-- 왼쪽: 전체 인원 (가장 크게) -->
    <div style="flex: 1.2; text-align: center; border-right: 1.5px solid #f1f5f9; padding-right: 10px; display: flex; flex-direction: column; justify-content: center;">
        <span style="font-size: 11px; font-weight: 800; color: #64748b; margin-bottom: 2px;">총 신청</span>
        <div>
            <b id="ind-shuttle-total" style="font-size: 26px; font-weight: 900; color: #3b82f6;">0</b>
            <span style="font-size: 13px; font-weight: 800; color: #3b82f6; margin-left: 2px;">명</span>
        </div>
    </div>
    
    <!-- 오른쪽: 목적지별 요약 숫자 (한 줄 배치) -->
    <div style="flex: 3; display: flex; justify-content: space-around; padding-left: 10px; align-items: center;">
        <div style="text-align: center;">
            <span style="font-size: 10px; font-weight: 800; color: #ef4444; display: block; margin-bottom: 2px;">오송</span>
            <b id="ind-osong" style="font-size: 16px; font-weight: 900; color: #1e293b;">0</b>
        </div>
        <div style="text-align: center;">
            <span style="font-size: 10px; font-weight: 800; color: #3b82f6; display: block; margin-bottom: 2px;">터미널</span>
            <b id="ind-term" style="font-size: 16px; font-weight: 900; color: #1e293b;">0</b>
        </div>
        <div style="text-align: center;">
            <span style="font-size: 10px; font-weight: 800; color: #10b981; display: block; margin-bottom: 2px;">공항</span>
            <b id="ind-air" style="font-size: 16px; font-weight: 900; color: #1e293b;">0</b>
        </div>
        <div style="text-align: center;">
            <span style="font-size: 10px; font-weight: 800; color: #64748b; display: block; margin-bottom: 2px;">자차</span>
            <b id="ind-car" style="font-size: 16px; font-weight: 900; color: #1e293b;">0</b>
        </div>
    </div>
    
    <!-- 우측 끝 화살표 아이콘 -->
    <div style="color: #cbd5e1; font-size: 14px; margin-left: 5px;">
        <i class="fa-solid fa-chevron-right"></i>
    </div>
</div>
              </div>
          </div>
          </div>

          <div class="section-card">
              <div class="section-title"><i class="fa-solid fa-comment-dots"></i> 담당 과정 공지 (해당 과정 교육생 공지)</div>
              <textarea id="courseNotice" class="notice-area" oninput="autoGrow(this)" placeholder="공지 입력"></textarea>
              <button class="navy-btn" onclick="saveCourseNotice()">과정 공지 업데이트</button>
          </div>


          <div class="section-card" style="margin-bottom: 50px;">
              <div class="section-title" style="justify-content:space-between;">
                  <span><i class="fa-solid fa-user-clock"></i> 외출/외박 신청자 명단</span>
                  <button class="navy-btn" style="width:140px; height:32px; font-size:12px;" onclick="openOutingLedger()">외출(외박)대장</button>
              </div>
              <div style="overflow-x: auto;">
                  <table class="navy-table">
                      <thead>
                          <tr>
                              <th>신청자</th>
                              <th>구분</th>
                              <th>시간</th>
                              <th width="100">담당 확인</th>
                          </tr>
                      </thead>
                      <tbody id="indActionTableBody"></tbody>
                  </table>
              </div>
          </div>
      </div>
    </main>


<!-- 플로팅 홈 버튼 -->
<div id="floatingHomeBtn" onclick="handleBackNav()">
    <i class="fa-solid fa-house"></i>
    <span>홈으로</span>
</div>



    <footer class="app-footer">
      <div id="footer-date">0000.00.00 00:00</div>
      <div class="footer-logo"><img src="logo.png" alt="KAC Logo"></div>
    </footer>
  </div>

<!-- 관리대장 뷰 (상세 페이지) -->
<div id="outingManagerView">
    <header class="app-header">
        <button class="header-btn" onclick="closeOutingManager()"><i class="fa-solid fa-chevron-left"></i></button>
        <div class="header-title">외출/외박 통합 관리 대장</div>
        <button class="header-btn" onclick="openPrintModal()"><i class="fa-solid fa-print"></i></button>
    </header>
    <div style="flex:1; overflow-y:auto; padding:15px;">
        <!-- 날짜 선택 섹션 추가 -->
        <div class="section-card" style="margin-bottom: 15px; padding: 15px;">
            <div class="section-title" style="justify-content: space-between; margin-bottom: 0;">
                <span><i class="fa-solid fa-calendar-day"></i> 조회 날짜 선택</span>
                <input type="date" id="managerDatePicker" class="navy-select" style="width:140px; height:35px;" onchange="changeManagerDate(this.value)">
            </div>
        </div>

        <div class="section-card">
            <div id="managerDateLabel" style="font-weight:900; margin-bottom:15px; color:var(--navy-dark); font-size:16px;">관리 현황</div>
            <div style="overflow-x: auto;">
                <table class="navy-table">
                    <thead><tr><th>과정명</th><th>신청자</th><th>구분</th><th>시간</th><th width="100">담당 확인</th></tr></thead>
                    <tbody id="managerTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

  <!-- 담당자 및 서명 관리 모달 -->
  <div id="coordManageModal" class="setup-modal" style="z-index: 7500;">
      <div class="setup-box" style="max-width: 450px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;">
              <h3 style="margin:0; font-size:17px; color:var(--navy-dark);"><i class="fa-solid fa-id-card-clip"></i> 담당자 명단 및 서명 관리</h3>
              <i class="fa-solid fa-xmark" style="cursor:pointer; font-size:22px;" onclick="document.getElementById('coordManageModal').style.display='none'"></i>
          </div>
          <div id="coordListContainer" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px; border:1px solid #eee; border-radius:8px; padding:10px; background:#f8fafc;"></div>
          <div style="padding:15px; background:#fff; border:1px solid #eee; border-radius:12px;">
              <label class="setup-label">새 담당자 등록 및 서명 업로드</label>
              <input type="text" id="newCoordInput" class="navy-input" placeholder="성함 직책" style="margin-bottom:8px;">
              <div style="display:flex; gap:5px;">
                  <input type="file" id="coordSignFile" accept="image/*" style="display:none;" onchange="coordMgr.handleFile(this)">
                  <button class="navy-btn" style="background:#64748b; flex:1;" onclick="document.getElementById('coordSignFile').click()"><i class="fa-solid fa-stamp"></i> 서명 선택</button>
                  <button id="coordRegBtn" class="navy-btn" style="flex:1;" onclick="coordMgr.add()">등록하기</button>
              </div>
              <div id="signPreviewArea" style="margin-top:10px; text-align:center; display:none;">
                  <span style="font-size:11px; color:#64748b;">선택된 서명 미리보기:</span><br>
                  <img id="tempSignPreview" style="height:50px; border:1px solid #eee; margin-top:5px; mix-blend-mode:multiply;">
              </div>
          </div>
          <button class="navy-btn" style="margin-top:20px; background:#1e293b;" onclick="document.getElementById('coordManageModal').style.display='none'">닫기</button>
      </div>
  </div>

  <!-- 통합 설정 모달 -->
  <div id="setupModal" class="setup-modal">
      <div class="setup-box" style="overflow-y: visible;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;">
              <h3 style="margin:0; font-size:18px; color:var(--navy-dark);"><i class="fa-solid fa-sliders"></i> 교육과정 통합 환경 설정</h3>
              <i class="fa-solid fa-xmark" style="cursor:pointer; font-size:22px;" onclick="closeSetupModal()"></i>
          </div>
          <div style="display:flex; flex-direction:column; gap:15px;">
              <div><label class="setup-label">대상 강의실 선택</label><select id="setup-room-select" class="navy-select" onchange="loadRoomSettings(this.value)"></select></div>
              <div><label class="setup-label">교육과정명</label><input type="text" id="setup-course-name" class="navy-input"></div>
              <div><label class="setup-label">교육 기간</label><div style="display:flex; gap:5px;"><input type="date" id="setup-start" class="navy-input"><input type="date" id="setup-end" class="navy-input"></div></div>
              <div><label class="setup-label">강의실 상세 위치</label>
                  <select id="setup-room-dropdown" class="navy-select" onchange="checkLocationDirect(this.value)">
                      <option value="">--- 장소 선택 ---</option>
                      <optgroup label="하늘관">
                          <option value="하늘관 1층 대강당">하늘관 1층 대강당</option>
                          <option value="하늘관 2층 A강의실">하늘관 2층 A강의실</option>
                          <option value="하늘관 2층 B강의실">하늘관 2층 B강의실</option>
                          <option value="하늘관 2층 C강의실">하늘관 2층 C강의실</option>
                          <option value="하늘관 2층 D강의실">하늘관 2층 D강의실</option>
                          <option value="하늘관 2층 E강의실">하늘관 2층 E강의실</option>
                          <option value="하늘관 2층 F강의실">하늘관 2층 F강의실</option>
                          <option value="하늘관 2층 G강의실">하늘관 2층 G강의실</option>
                      </optgroup>
                      <optgroup label="국제동">
                          <option value="국제동 1층 세미나홀">국제동 1층 세미나홀</option>
                          <option value="국제동 1층 A강의실">국제동 1층 A강의실</option>
                          <option value="국제동 1층 B강의실">국제동 1층 B강의실</option>
                          <option value="국제동 2층 항공정보통신시설 실습실">국제동 2층 실습실</option>
                          <option value="국제동 2층 VOR/DME/TACAN 실습실">국제동 2층 VOR/DME/TACAN</option>
                      </optgroup>
                      <option value="direct">직접 입력</option>
                  </select>
                  <input type="text" id="setup-location-direct" class="navy-input" style="margin-top:5px; display:none;" placeholder="위치 직접 작성">
              </div>
              <div><label class="setup-label">담당 교수</label><select id="setup-prof-select" class="navy-select"></select></div>
              <div>
                  <label class="setup-label">과정 운영 담당자 (행정)</label>
                  <div style="display:flex; gap:5px;">
                      <select id="setup-coord-select" class="navy-select"></select>
                      <button class="navy-btn" style="width:45px; background:#1e293b;" onclick="coordMgr.openManage()"><i class="fa-solid fa-gear"></i></button>
                  </div>
              </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:25px;"><button class="navy-btn" style="background:#64748b; flex:1;" onclick="closeSetupModal()">취소</button><button class="navy-btn" style="background:var(--blue-main); flex:2;" onclick="saveIntegratedSettings()">설정 저장 및 과정 개설</button></div>
      </div>
  </div>













<!-- 수송 요청 모달 수정본 -->
<div id="transportModal" class="setup-modal" style="z-index: 8000;">
    <div class="setup-box" style="max-width: 450px;">
        <div style="background:#6366f1; color:white; padding:18px; display:flex; justify-content:space-between; align-items:center; margin:-25px -25px 20px -25px; border-radius:24px 24px 0 0;">
            <h3 style="margin:0; font-size:17px;">🚖 강사 수송 요청 관리</h3>
            <i class="fa-solid fa-xmark" style="cursor:pointer; font-size:20px;" onclick="closeTransportModal()"></i>
        </div>
        <div style="display:flex; flex-direction:column; gap:15px;">
            <!-- 과정 선택 영역 -->
            <div id="reqCourseSelectRow" style="display:none;">
                <label class="setup-label">대상 교육과정</label>
                <select id="reqCourseRID" class="navy-select">
                    <option value="">--- 과정을 선택하세요 ---</option>
                </select>
            </div>

            <div>
                <label class="setup-label">픽업 장소</label>
                <select id="reqLoc" class="navy-select" onchange="updateTransLabels()">
                    <option value="오송역">오송역</option>
                    <option value="청주터미널">청주터미널</option>
                    <option value="청주공항">청주공항</option>
                </select>
            </div>

            <div>
                <label class="setup-label">수송 날짜</label>
                <input type="date" id="reqDate" class="navy-input">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f8fafc; padding: 12px; border-radius: 12px; border: 1.5px solid #e2e8f0;">
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <label id="labelTo" style="font-size: 10px; font-weight: 800; color: #64748b;">오송역 → 항기원</label>
                    <input type="time" id="reqTimeTo" class="navy-input">
                </div>
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <label id="labelFrom" style="font-size: 10px; font-weight: 800; color: #64748b;">항기원 → 오송역</label>
                    <input type="time" id="reqTimeFrom" class="navy-input">
                </div>
            </div>

            <input type="text" id="reqProf" class="navy-input" placeholder="강사명 성함">
            <input type="tel" id="reqPhone" class="navy-input" placeholder="강사 연락처">
            
            <button class="navy-btn" style="background:#6366f1; height:45px;" onclick="submitTransReq()">수송 예약 등록</button>
            
            <!-- 🚩 [변경] 실시간 예약 리스트 삭제 후 현황 보기 버튼 추가 -->
            <div style="margin-top:15px; border-top:1px dashed #eee; padding-top:20px; text-align: center;">
                <button class="navy-btn" style="background: #1e293b; width: 100%; height: 45px;" onclick="goToPickupView()">
                    <i class="fa-solid fa-comments"></i> 실시간 수송 신청현황(톡) 보기
                </button>
            </div>
        </div>
        <button class="navy-btn" style="margin-top:15px; background:#64748b;" onclick="closeTransportModal()">닫기</button>
    </div>
</div>




<!-- 생활관 배정현황 모달 -->
  <div id="dormManagerModal" class="setup-modal">
      <div class="setup-box" style="max-width: 500px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;">
              <h3 style="margin:0; font-size:17px; color:var(--navy-dark);"><i class="fa-solid fa-bed"></i> 과정 생활관 배정 명단</h3>
              <i class="fa-solid fa-xmark" style="cursor:pointer; font-size:22px;" onclick="document.getElementById('dormManagerModal').style.display='none'"></i>
          </div>
          <div style="max-height: 400px; overflow-y: auto;">
              <table class="navy-table">
                  <thead>
                      <tr><th>성함</th><th>뒷자리</th><th>생활관</th><th>호실</th></tr>
                  </thead>
                  <tbody id="dormTableBody"></tbody>
              </table>
          </div>
          <button class="navy-btn" style="margin-top:20px; background:#64748b;" onclick="document.getElementById('dormManagerModal').style.display='none'">닫기</button>
      </div>
  </div>




<!-- 전체 교육생 통합 명단 모달 -->
  <div id="totalStudentListModal" class="setup-modal">
      <div class="setup-box" style="max-width: 500px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;">
              <h3 style="margin:0; font-size:17px; color:var(--navy-dark);"><i class="fa-solid fa-users-list"></i> 항기원 전체 교육생 명단</h3>
              <i class="fa-solid fa-xmark" style="cursor:pointer; font-size:22px;" onclick="document.getElementById('totalStudentListModal').style.display='none'"></i>
          </div>
          <div class="modal-scroll-area">
              <table class="navy-table">
                  <thead style="position:sticky; top:0; z-index:10;">
                      <tr><th>과정</th><th>성함</th><th>연락처(뒷자리)</th></tr>
                  </thead>
                  <tbody id="totalStudentListBody"></tbody>
              </table>
          </div>
          <button class="navy-btn" style="margin-top:20px; background:#64748b;" onclick="document.getElementById('totalStudentListModal').style.display='none'">닫기</button>
      </div>
  </div>


<!-- --- 여기서부터 추가 (인쇄 과정 선택 모달) --- -->
  <div id="printSelectModal" class="setup-modal" style="z-index: 9500;">
      <div class="setup-box" style="max-width: 400px;">
          <div style="text-align:center; margin-bottom:20px;">
              <h3 style="margin:0; font-size:18px; color:var(--navy-dark);">인쇄할 과정을 선택하세요</h3>
              <p style="font-size:12px; color:#64748b; margin-top:5px;">선택 시 해당 과정의 관리대장으로 연결됩니다.</p>
          </div>
          <div id="printCourseList" style="display:flex; flex-direction:column; gap:8px; max-height:300px; overflow-y:auto;">
              <!-- 운영중인 과정 버튼이 여기에 생성됨 -->
          </div>
          <button class="navy-btn" style="margin-top:20px; background:#64748b;" onclick="document.getElementById('printSelectModal').style.display='none'">닫기</button>
      </div>
  </div>
<!-- --- 여기까지 추가 --- -->





  <!-- 인쇄 레이어 -->
  <div id="print-area">
      <div style="text-align:center; border-bottom:3px double #333; padding-bottom:10px; margin-bottom:30px;"><h1 style="margin:0; font-size:28px;">외출/외박 신청 교육생 현황</h1><p id="print-info-text" style="margin:10px 0; font-weight:700;"></p></div>
      <table class="print-table"><thead><tr><th width="40">No</th><th width="150">과정명</th><th width="60">구분</th><th width="80">성명</th><th width="130">비상연락처</th><th width="90">신청시간</th><th width="100">담당 확인</th></tr></thead><tbody id="printBody"></tbody></table>
  </div>





<!-- [신규] 외출/외박 상세 내역 팝업 -->
<div id="actionDetailModal" class="setup-modal" style="z-index: 8000;">
    <div class="setup-box" style="max-width: 400px; padding: 0; overflow: hidden;">
        <div style="background: var(--navy-dark); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 18px;"><i class="fa-solid fa-circle-info"></i> 신청 상세 정보</h3>
            <i class="fa-solid fa-xmark" style="cursor: pointer; font-size: 20px;" onclick="document.getElementById('actionDetailModal').style.display='none'"></i>
        </div>
        <div id="actionDetailContent" style="padding: 20px; display: flex; flex-direction: column; gap: 15px;">
            <!-- 상세 정보가 여기에 들어갑니다 -->
        </div>
        <div style="padding: 15px; background: #f8fafc; border-top: 1px solid #eee;">
            <button class="navy-btn" style="background: #64748b;" onclick="document.getElementById('actionDetailModal').style.display='none'">닫기</button>
        </div>
    </div>
</div>



    <div id="floatingHomeBtn" onclick="handleBackNav()">
        <i class="fa-solid fa-house"></i>
    </div>








  <script src="config.js"></script>
  <script>
    let globalAllData = {}; let currentRID = ""; let selectedDate = getTodayString(); let transDir = "";






let masterStudentList = []; // 검색을 위한 마스터 데이터 저장용

















// [1] 스크롤을 맨 아래로 내리는 함수 (더 강력한 타이밍 제어)
function scrollToBottomPickup() {
    const container = document.getElementById('pickupCardContainer');
    if (!container) return;

    // 1단계: 즉시 실행
    container.scrollTop = container.scrollHeight;

    // 2단계: 0.1초 뒤 (데이터 렌더링 직후 재확인)
    setTimeout(() => {
        container.scrollTop = container.scrollHeight;
    }, 100);

    // 3단계: 0.4초 뒤 (이미지나 레이아웃이 완전히 정착된 후 최종 확인)
    setTimeout(() => {
        container.scrollTop = container.scrollHeight;
    }, 400);
}



// [추가] 노선 분석 및 배차 효율화 계산기
const RouteManager = {
    INTERVAL: 30, // 구간별 이동 시간 (분)
    points: ['항기원', '오송역', '청주터미널', '청주공항'],
    getOffset: function(dirStr) {
        const isOutbound = dirStr.includes('항기원→'); 
        const path = isOutbound ? [...this.points] : [...this.points].reverse();
        const targetLoc = isOutbound ? dirStr.split('→')[1] : dirStr.split('→')[0];
        const idx = path.findIndex(p => targetLoc.includes(p));
        return { idx, isOutbound };
    },
    analyzeConflict: function(existingReq, newTime, newDir) {
        const existInfo = this.getOffset(existingReq.dir);
        const newInfo = this.getOffset(newDir);
        if (existInfo.isOutbound !== newInfo.isOutbound) return null;

        const [exH, exM] = existingReq.time.split(':').map(Number);
        const [newH, newM] = newTime.split(':').map(Number);
        const existMin = exH * 60 + exM;
        const newMin = newH * 60 + newM;

        const stopDiff = newInfo.idx - existInfo.idx;
        const recommendedMin = existMin + (stopDiff * this.INTERVAL);
        const recH = Math.floor(recommendedMin / 60).toString().padStart(2, '0');
        const recM = (recommendedMin % 60).toString().padStart(2, '0');
        const recTime = `${recH}:${recM}`;

        if (Math.abs(newMin - recommendedMin) <= 15) {
            const newLoc = newDir.includes('→') ? (newInfo.isOutbound ? newDir.split('→')[1] : newDir.split('→')[0]) : "해당장소";
            return {
                msg: `💡 [배차 효율화 제안]\n이미 ${existingReq.prof}강사님의 예약이 노선상에 있습니다.\n이 차량을 함께 이용할 경우, [${newLoc}] 권장 탑승시간은 [${recTime}]입니다.\n\n기사님과 협의하여 시간을 조정하시겠습니까?`
            };
        }
        return null;
    }
};












// [최종 보강] 과정 운영 담당자(행정) 및 서명 관리 객체 (수정 기능 추가 버전)
const coordMgr = {
    list: [],
    tempSign: "",
    editingKey: null, // 현재 수정 중인 담당자의 고유 키 저장
    
    // 1. 초기화
    init: async function() {
        const ref = firebase.database().ref('system/coordinators');
        const snap = await ref.once('value');
        if (!snap.exists()) {
            const initial = ["백유민 과장", "주영미 과장", "장영근 과장", "채유란 주임", "김지은 주임", "박찬미 주임"];
            for (let name of initial) { await ref.push({ name: name, sign: "" }); }
        }
        ref.on('value', s => {
            const data = s.val() || {};
            this.list = Object.keys(data).map(k => ({ key: k, ...data[k] }));
            this.renderSelects();    
            this.renderManageList(); 
        });
    },

    // 2. 설정창 드롭다운 갱신
    renderSelects: function() {
        const sel = document.getElementById('setup-coord-select'); 
        if(!sel) return;
        const curValue = sel.value;
        sel.innerHTML = '<option value="">--- 담당자 선택 ---</option>';
        this.list.forEach(c => {
            const opt = new Option(c.name, c.name);
            if(c.name === curValue) opt.selected = true;
            sel.add(opt);
        });
    },

    // 3. 관리창 리스트 그리기 (클릭 시 수정 모드 연결)
    renderManageList: function() {
        const div = document.getElementById('coordListContainer'); 
        if(!div) return;
        if(this.list.length === 0) {
            div.innerHTML = "<div style='text-align:center; padding:20px; color:#94a3b8;'>등록된 담당자가 없습니다.</div>";
            return;
        }

        div.innerHTML = this.list.map(c => `
            <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee; align-items:center; background:#fff; margin-bottom:5px; border-radius:8px; cursor:pointer; border:${this.editingKey === c.key ? '2px solid var(--blue-main)' : '1px solid #eee'}" 
                 onclick="coordMgr.startEdit('${c.key}')">
                <div style="display:flex; align-items:center; gap:12px; flex:1;">
                    <span style="font-weight:800; color:var(--navy-dark);">${c.name}</span>
                    ${c.sign ? `<img src="${c.sign}" style="height:35px; mix-blend-mode:multiply; border:1px solid #eee; border-radius:4px;">` : `<span style="font-size:10px; color:#94a3b8;">(서명 미등록)</span>`}
                </div>
                <i class="fa-solid fa-circle-xmark" style="color:var(--danger); cursor:pointer; font-size:20px; padding:5px;" 
                   onclick="event.stopPropagation(); coordMgr.delete('${c.key}')"></i>
            </div>`).join('');
    },

    // 4. 수정 모드 시작 (이름 클릭 시 호출)
    startEdit: function(key) {
        const item = this.list.find(c => c.key === key);
        if(!item) return;

        this.editingKey = key;
        document.getElementById('newCoordInput').value = item.name;
        
        // 버튼 텍스트 변경
        document.getElementById('coordRegBtn').innerHTML = '<i class="fa-solid fa-check"></i> 수정완료';
        document.getElementById('coordRegBtn').style.background = "var(--green-save)";

        // 기존 서명이 있다면 미리보기 표시
        if(item.sign) {
            this.tempSign = item.sign;
            document.getElementById('tempSignPreview').src = item.sign;
            document.getElementById('signPreviewArea').style.display = 'block';
        } else {
            this.tempSign = "";
            document.getElementById('signPreviewArea').style.display = 'none';
        }
        
        this.renderManageList(); // 선택된 항목 강조를 위해 재랜더링
        document.getElementById('newCoordInput').focus();
    },

    // 5. 입력값 초기화
    resetFields: function() {
        this.editingKey = null;
        this.tempSign = "";
        document.getElementById('newCoordInput').value = "";
        document.getElementById('coordRegBtn').innerHTML = '등록하기';
        document.getElementById('coordRegBtn').style.background = "var(--blue-main)";
        document.getElementById('signPreviewArea').style.display = 'none';
        document.getElementById('coordSignFile').value = "";
        this.renderManageList();
    },

    // 6. 파일 선택 처리
    handleFile: function(input) {
        const file = input.files[0]; 
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => { 
            this.tempSign = e.target.result;
            document.getElementById('tempSignPreview').src = e.target.result;
            document.getElementById('signPreviewArea').style.display = 'block';
        };
        reader.readAsDataURL(file);
    },

    // 7. 등록 또는 수정 실행
    add: async function() {
        const name = document.getElementById('newCoordInput').value.trim();
        if(!name) return alert("성함을 입력해 주세요.");
        
        try {
            const data = { name: name, sign: this.tempSign };
            
            if(this.editingKey) {
                // 수정 모드
                await firebase.database().ref(`system/coordinators/${this.editingKey}`).update(data);
                alert("수정되었습니다.");
            } else {
                // 신규 등록 모드
                await firebase.database().ref('system/coordinators').push(data);
                alert("등록되었습니다.");
            }
            this.resetFields();
        } catch(e) {
            alert("저장 오류: " + e.message);
        }
    },

    // 8. 삭제 처리
    delete: async function(k) {
        if(confirm("이 담당자를 명단에서 삭제할까요?")) {
            await firebase.database().ref(`system/coordinators/${k}`).remove();
            if(this.editingKey === k) this.resetFields();
        }
    },

    openManage: function() {
        this.resetFields(); // 열 때마다 초기화
        document.getElementById('coordManageModal').style.display = 'flex';
    }
};







// [수정] 보안 체크 기능이 추가된 초기화 함수
    function init() {
        // --- 보안 체크 시작 ---
        const sessionKey = 'kac_session_coord'; // 교육운영부 전용 키
        const savedSession = localStorage.getItem(sessionKey);
        const FIVE_HOURS = 5 * 60 * 60 * 1000;

        let isAccessDenied = true;

        if (savedSession) {
            const data = JSON.parse(savedSession);
            if (Date.now() - data.time < FIVE_HOURS) {
                isAccessDenied = false; // 5시간 이내이므로 허용
            }
        }

        if (isAccessDenied) {
            alert("보안 세션이 만료되었거나 권한이 없습니다.\n포털 페이지에서 다시 접속해주세요.");
            location.href = 'potal.html';
            return;
        }
        // --- 보안 체크 끝 ---

        // 기존 데이터 로드 로직 유지
        firebase.database().ref('courses').on('value', snap => {
            globalAllData = snap.val() || {};
            updateGlobalStatus(); 
            renderCourseSelectors(); 
            renderTotalHistory();
            if(currentRID) updateIndividualView();
            if(document.getElementById('outingManagerView').style.display === 'flex') renderOutingManager();
        });
        
        firebase.database().ref('system/globalNotice').on('value', s => { 
            const el = document.getElementById('globalNotice'); if(el) { el.value = s.val() || ""; autoGrow(el); }
        });
        
        document.getElementById('historyDate').value = selectedDate;
        handleRoomSelection();
        coordMgr.init();
    }









// [3. 전체 현황판 실시간 집계 및 명단 팝업] - 4개 버튼 수치 모두 반영
function updateGlobalStatus() {
    let globalList = []; 
    let todayA = 0; 
    let totalShuttle = 0; // 교육생 퇴교 인원 합계
    const tStr = getTodayString();

    // 1. 교육과정 데이터를 돌며 학생수, 외출건수, 퇴교신청수 집계
    Object.keys(globalAllData).forEach(rid => {
        const room = globalAllData[rid];
        const cName = room.settings?.courseName || `[미설정] Room ${rid}`;
        
        // [항기원 전체 교육생 집계]
        if (room.students) { 
            Object.values(room.students).forEach(s => {
                if (s && s.name && s.name !== "undefined" && s.name.trim() !== "") {
                    const cleanPhone = (s.phone || "0000").replace(/[^0-9]/g, "");
                    const last4 = cleanPhone.length >= 4 ? cleanPhone.slice(-4) : cleanPhone;
                    globalList.push({
                        courseName: cName,
                        name: s.name.trim(),
                        phone: last4
                    });
                }
            });
        }
        
        // [금일 외출/외박 건수 집계]
        if (room.admin_actions?.[tStr]) {
            todayA += Object.keys(room.admin_actions[tStr]).length;
        }

        // [교육생 퇴교 신청 총 인원 집계]
        if (room.shuttle?.requests) {
            totalShuttle += Object.keys(room.shuttle.requests).length;
        }
    });

    // 2. 중복 제거 (이름 + 뒷자리 기준) - 1번 버튼용
    const uniqueSet = new Set();
    const filteredList = globalList.filter(item => {
        const id = `${item.name}_${item.phone}`;
        if(uniqueSet.has(id)) return false;
        uniqueSet.add(id);
        return true;
    });

    // 3. 강사 픽업 요청 건수 가져오기 (전역 데이터) - 3번 버튼용
    firebase.database().ref('system/transport_requests').once('value', snap => {
        const pickupData = snap.val() || {};
        const pickupCount = Object.keys(pickupData).length;
        
        // 화면 숫자 업데이트 (ID 기준)
        if(document.getElementById('g-total-students')) document.getElementById('g-total-students').innerText = uniqueSet.size;
        if(document.getElementById('g-today-actions')) document.getElementById('g-today-actions').innerText = todayA;
        if(document.getElementById('g-pickup-count')) document.getElementById('g-pickup-count').innerText = pickupCount;
        if(document.getElementById('g-shuttle-count')) document.getElementById('g-shuttle-count').innerText = totalShuttle;
    });

    // 4. [1번 버튼 클릭 이벤트] - 전체 교육생 명단 팝업 유지
    const studentBtn = document.getElementById('g-total-students')?.closest('.dashboard-card-btn');
    if(studentBtn) {
        studentBtn.onclick = function() {
            showTotalStudentList(); // 페이지 전환 함수 호출
        };
    }
} // updateGlobalStatus 끝









// [수정] 개별 과정 상세 뷰: 행 전체 클릭 범위 확대 및 UI 보정
function updateIndividualView() {
    const room = globalAllData[currentRID]; 
    if (!room) return;

    document.getElementById('ind-room-id').innerText = currentRID;
    document.getElementById('ind-course-name').innerText = room.settings?.courseName || "과정명 미설정";
    document.getElementById('ind-period').innerText = room.settings?.period || "-";
    document.getElementById('ind-prof').innerText = (room.status?.professorName || "-") + " 교수";
    document.getElementById('ind-coord').innerText = room.settings?.coordinatorName || "-";
    document.getElementById('ind-room-loc').innerText = room.settings?.roomDetailName || "-";

    let leaderTxt = "지정된 학생장 없음";
    if(room.students) {
        const leaders = Object.values(room.students).filter(s => s.isLeader === true);
        if(leaders.length > 0) {
            leaderTxt = leaders.map(l => `${l.name} [${l.phone || '연락처 미등록'}]`).join(' / ');
        }
    }
    document.getElementById('ind-leader').innerText = leaderTxt;

    const students = Object.values(room.students || {}).filter(s => s.name && s.name !== "undefined");
    const uniqueSize = (new Set(students.map(s => `${s.name.trim()}_${(s.phone||"").replace(/-/g,'').trim()}`))).size;
    document.getElementById('ind-entry-cnt').innerHTML = `${uniqueSize}<span>명</span>`;
    
    const requests = room.shuttle?.requests || {};
    const items = Object.values(requests);
    document.getElementById('ind-shuttle-total').innerText = items.length;
    document.getElementById('ind-osong').innerText = items.filter(i => i.type === 'osong').length;
    document.getElementById('ind-term').innerText = items.filter(i => i.type === 'terminal').length;
    document.getElementById('ind-air').innerText = items.filter(i => i.type === 'airport').length;
    document.getElementById('ind-car').innerText = items.filter(i => i.type === 'car').length;

    const actionTbody = document.getElementById('indActionTableBody');
    const today = getTodayString();
    const actions = room.admin_actions?.[today] || {};
    const actionItems = Object.keys(actions).map(k=>({...actions[k], token:k})).sort((a,b)=>a.timestamp-b.timestamp);
    
    actionTbody.innerHTML = actionItems.length ? actionItems.map(a => {
        const isSigned = a.confirmed === true;
        const returnBadge = a.returned ? `<span style="display:inline-block; background:#10b981; color:white; padding:2px 8px; border-radius:4px; font-size:10px; margin-left:5px; font-weight:800; vertical-align:middle;">복귀완료</span>` : "";
        const btnText = isSigned ? "서명취소" : "서명";
        const btnStyle = isSigned ? "background:#94a3b8; color:#fff; border:none;" : "background:var(--blue-main); color:#fff; border:none;";
        const dataStr = encodeURIComponent(JSON.stringify(a));
        
        // 버튼을 제외한 행 전체를 클릭 영역으로 설정
        const rowClickAction = `onclick="showActionDetail('${dataStr}')" style="cursor:pointer;"`;

        return `<tr>
            <td ${rowClickAction} style="font-weight:800; text-align:center;">${a.name}${returnBadge}</td>
            <td ${rowClickAction} style="color:${a.type==='outing'?'#ea580c':'#dc2626'}; font-weight:800; text-align:center;">${a.type==='outing'?'외출':'외박'}</td>
            <td ${rowClickAction} style="text-align:center;">${new Date(a.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</td>
            <td><button onclick="toggleConfirm('${currentRID}', '${today}', '${a.token}', ${isSigned})" style="${btnStyle} border-radius:5px; width:100%; height:35px; display:flex; align-items:center; justify-content:center; font-weight:800; cursor:pointer; font-size:11px; margin: 0 auto;">${btnText}</button></td>
        </tr>`;
    }).join('') : '<tr><td colspan="4" style="padding:20px; color:#94a3b8; text-align:center;">신청 명단 없음</td></tr>';
    
    document.getElementById('courseNotice').value = room.coordNotice || ""; 
}






    // [5. 서명 연동 및 실시간 처리]
async function toggleConfirm(rid, date, token, currentStatus) {
    // 1. 현재 선택된 과정 담당자 정보를 가져옴 (예: 주영미 과장)
    const coordName = globalAllData[rid]?.settings?.coordinatorName || "담당자"; 
    
    // 2. 미리 등록된 담당자 리스트에서 해당 이름의 '도장 이미지'가 있는지 찾음
    // (이미 도장 이미지를 coordMgr 등에서 관리하고 있다고 가정)
    const coordinator = coordMgr.list.find(c => c.name === coordName);
    const signImg = coordinator ? coordinator.sign : ""; // 도장 이미지(Base64)

    if (!currentStatus) {
        // [승인할 때] 이름과 이미지를 동시에 저장
        await firebase.database().ref(`courses/${rid}/admin_actions/${date}/${token}`).update({
            confirmed: true,
            confirmedBy: coordName, // 성함/직급
            confirmedBySign: signImg // 도장 이미지
        });
        alert("✅ 서명이 완료되었습니다.");
    } else {
        // [취소할 때] 데이터 삭제
        await firebase.database().ref(`courses/${rid}/admin_actions/${date}/${token}`).update({
            confirmed: false,
            confirmedBy: null,
            confirmedBySign: null
        });
    }
}


// [신규] 팝업에서 톡 화면으로 바로 이동하는 함수
function goToPickupView() {
    closeTransportModal(); 
    showPickupView();      
    
    // 페이지 전환 후 스크롤 재보정
    const container = document.getElementById('pickupCardContainer');
    if(container) {
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 300);
    }
}




// [수정] 수송 요청 모달 열기 함수 (하단 리스트 호출 로직 제거)
function openTransportModal() { 
    // 사이드 메뉴가 열려있다면 닫기
    const sideMenu = document.getElementById('sideMenu');
    if(sideMenu) sideMenu.classList.remove('open');
    document.getElementById('menuOverlay').style.display = 'none';

    document.getElementById('transportModal').style.display = "flex"; 
    document.getElementById('reqDate').value = getTodayString(); 
    
    const row = document.getElementById('reqCourseSelectRow');
    const sel = document.getElementById('reqCourseRID');

    // 과정 선택 드롭다운 채우기
    sel.innerHTML = '<option value="">--- 과정을 선택하세요 ---</option>';
    Object.keys(globalAllData).forEach(rid => {
        const room = globalAllData[rid];
        if (room.status && room.status.roomStatus === 'active') {
            const courseName = room.settings?.courseName || `Room ${rid}`;
            const opt = new Option(courseName, rid);
            sel.add(opt);
        }
    });

    // 개별 과정 페이지에서 열었을 때 해당 과정 자동 선택
    if (currentRID) {
        row.style.display = "none";
        sel.value = currentRID;
    } else {
        row.style.display = "block";
        sel.value = "";
    }

    updateTransLabels(); 
}









// 선택한 장소(오송역, 터미널 등)에 따라 입력창 라벨을 즉시 바꾸는 함수
  function updateTransLabels() {
    const loc = document.getElementById('reqLoc').value;
    const toLabel = document.getElementById('labelTo');
    const fromLabel = document.getElementById('labelFrom');
    
    if(toLabel && fromLabel) {
        toLabel.innerText = `${loc} → 항기원`;
        fromLabel.innerText = `항기원 → ${loc}`;
    }
  }







// [수정] 수송 예약 리스트 로드 함수 (개별과정/전체현황 모두 대응)
  function loadCourseTransList() {
    const div = document.getElementById('courseReqList'); 
    if(!div) return;

    firebase.database().ref('system/transport_requests').on('value', snap => {
        const allData = snap.val() || {}; 
        let myList = Object.keys(allData).map(key => ({ id: key, ...allData[key] }));

        // [핵심 수정] 
        // 1. 개별 과정 상세페이지에서 열었을 때: 해당 과정(currentRID) 것만 필터링
        // 2. 전체 현황 페이지에서 열었을 때: 모든 과정의 수송 내역을 다 보여줌
        if (currentRID) {
            myList = myList.filter(req => req.courseRID === currentRID);
        }

        if (myList.length === 0) { 
            div.innerHTML = "<div style='color:#94a3b8; text-align:center; padding:15px; font-size:12px;'>예약 내역 없음</div>"; 
            return; 
        }

        // 날짜와 시간 순으로 정렬
        myList.sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));

        div.innerHTML = myList.map(r => {
            // 전체 현황에서 볼 때 어떤 과정인지 알 수 있도록 과정명 추출
            const roomInfo = globalAllData[r.courseRID];
            const cName = roomInfo?.settings?.courseName || `Room ${r.courseRID}`;

            return `
                <div style="background:#f8fafc; border:1px solid #e2e8f0; padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <div style="font-size:12px; line-height:1.4;">
                        <div style="font-size:10px; color:#64748b; font-weight:800; margin-bottom:2px;">[${cName}]</div>
                        <b style="color:var(--blue-deep);">${r.date} ${r.time}</b><br>
                        <span style="font-weight:800;">${r.prof}</span> 강사님 (${r.dir})
                    </div>
                    <button onclick="deleteTrans('${r.id}')" style="background:#fee2e2; color:#ef4444; border:none; padding:6px 10px; border-radius:6px; font-size:11px; cursor:pointer; font-weight:800;">삭제</button>
                </div>`;
        }).join('');
    });
  }






async function submitTransReq() {
    const rid = document.getElementById('reqCourseRID').value;
    const loc = document.getElementById('reqLoc').value;
    const date = document.getElementById('reqDate').value;
    const timeTo = document.getElementById('reqTimeTo').value;
    const timeFrom = document.getElementById('reqTimeFrom').value;
    const prof = document.getElementById('reqProf').value.trim();
    const phone = document.getElementById('reqPhone').value.trim();

    if(!rid || !date || !prof || (!timeTo && !timeFrom)) return alert("필수 항목을 모두 입력하세요.");

    try {
        const snap = await firebase.database().ref('system/transport_requests').once('value');
        const allReqs = snap.val() || {};
        let warningMsg = "";

        Object.values(allReqs).forEach(req => {
            if(req.date === date && req.status !== 'cancelled') {
                // 1. 단순 시간 충돌 체크 (±60분)
                const checkTime = (newT) => {
                    if(!newT) return false;
                    const m1 = parseInt(newT.split(':')[0])*60 + parseInt(newT.split(':')[1]);
                    const m2 = parseInt(req.time.split(':')[0])*60 + parseInt(req.time.split(':')[1]);
                    return Math.abs(m1 - m2) < 60;
                }

                if(checkTime(timeTo)) {
                    const advice = RouteManager.analyzeConflict(req, timeTo, `${loc}→항기원`);
                    warningMsg += advice ? advice.msg : `⚠️ [입교] ${req.time} ${req.prof}님 일정과 겹칩니다.\n`;
                }
                if(checkTime(timeFrom)) {
                    const advice = RouteManager.analyzeConflict(req, timeFrom, `항기원→${loc}`);
                    warningMsg += advice ? advice.msg : `⚠️ [퇴교] ${req.time} ${req.prof}님 일정과 겹칩니다.\n`;
                }
            }
        });

        if(warningMsg) {
            if(!confirm(warningMsg + "\n그래도 신청하시겠습니까?")) return;
        }

        // 저장 로직
        const requests = [];
        if(timeTo) requests.push({ courseRID: rid, dir: `${loc}→항기원`, date, time: timeTo, prof, phone, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP });
        if(timeFrom) requests.push({ courseRID: rid, dir: `항기원→${loc}`, date, time: timeFrom, prof, phone, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP });

        for(let r of requests) await firebase.database().ref('system/transport_requests').push(r);
        alert("✅ 수송 예약이 등록되었습니다.");
        closeTransportModal();
    } catch(e) { alert("오류: " + e.message); }
}







// [수정] 요청을 삭제하는 대신 'cancelled' 상태로 변경하여 채팅 기록 유지
async function deleteTrans(id) { 
    if(confirm("해당 수송 요청을 취소하시겠습니까? (채팅창에 취소 내역이 남습니다)")) {
        await firebase.database().ref(`system/transport_requests/${id}`).update({
            status: 'cancelled'
        });
        alert("취소되었습니다.");
    }
}



function setTransDir(d) { 
        const loc = document.getElementById('reqLoc').value; 
        const btnTo = document.getElementById('btnTransTo'); 
        const btnFrom = document.getElementById('btnTransFrom'); 
        if(d === 'to') { 
            transDir = `${loc}→항기원`; 
            btnTo.style.background = "var(--blue-main)"; 
            btnTo.style.color = "#fff"; 
            btnFrom.style.background = "#fff"; 
            btnFrom.style.color = "#64748b"; 
        } else { 
            transDir = `항기원→${loc}`; 
            btnFrom.style.background = "var(--blue-main)"; 
            btnFrom.style.color = "#fff"; 
            btnTo.style.background = "#fff"; 
            btnTo.style.color = "#64748b"; 
        } 
    }

function updateTransDirButtons() { 
        transDir = ""; 
        const loc = document.getElementById('reqLoc').value; // 현재 선택된 장소(오송역 등)
        const btnTo = document.getElementById('btnTransTo');
        const btnFrom = document.getElementById('btnTransFrom');
        
        // 1. 장소→항기원 버튼 글자 및 스타일 초기화
        if(btnTo) {
            btnTo.style.background = "#fff"; 
            btnTo.style.color = "#64748b"; 
            btnTo.style.border = "1.5px solid #e2e8f0";
            btnTo.innerHTML = `<i class="fa-solid fa-car"></i> ${loc}→항기원`;
        }
        
        // 2. 항기원→장소 버튼 글자 및 스타일 초기화
        if(btnFrom) {
            btnFrom.style.background = "#fff"; 
            btnFrom.style.color = "#64748b"; 
            btnFrom.style.border = "1.5px solid #e2e8f0";
            btnFrom.innerHTML = `<i class="fa-solid fa-car"></i> 항기원→${loc}`;
        }
    }



// [최종 수정] 뒤로가기 및 포탈 이동 로직
function handleBackNav() { 
    // 1. 열려있는 팝업(모달)이 있다면 팝업부터 닫기
    const allModals = [
        'totalStudentListModal', 'dormManagerModal', 'coordManageModal', 
        'setupModal', 'transportModal', 'shuttleDetailModal', 
        'actionDetailModal', 'printSelectModal', 'centerQrModal'
    ];
    
    let isModalOpen = false;
    allModals.forEach(id => {
        const modal = document.getElementById(id);
        if(modal && modal.style.display === 'flex') {
            modal.style.display = 'none';
            isModalOpen = true;
        }
    });

    if (isModalOpen) {
        document.body.classList.remove('modal-open');
        return; // 팝업을 닫았으면 여기서 중단
    }

    // 2. 관리대장 뷰가 열려있다면 닫고 종료
    const outingManager = document.getElementById('outingManagerView');
    if(outingManager && outingManager.style.display === 'flex') {
        outingManager.style.display = 'none';
        document.body.classList.remove('modal-open');
        return;
    }

    // 3. 현재 서브 뷰(개별과정, 강사픽업 등)에 있는지 확인
    const views = ['individualStatusView', 'pickupStatusView', 'studentShuttleView', 'allStudentListView'];
    let isSubViewOpen = false;
    views.forEach(v => {
        const el = document.getElementById(v);
        if(el && el.style.display === 'flex') {
            isSubViewOpen = true;
        }
    });

    if (isSubViewOpen) {
        // 서브 뷰가 열려있다면 메인(Total View)으로 복귀
        currentRID = ""; 
        handleRoomSelection();
    } else {
        // 🚩 [핵심] 이미 메인 페이지(Total View)라면 포탈로 이동!
        if(confirm("행정 관리 시스템을 종료하고 포탈로 이동하시겠습니까?")) {
            location.href = 'potal.html';
        }
    }
}









// [수정] 화면 선택 및 플로팅 버튼 노출 제어
function handleRoomSelection() { 
    const isInd = (currentRID !== ""); 
    const homeBtn = document.getElementById('floatingHomeBtn');

    // 뷰 숨김 처리
    document.getElementById('totalStatusView').style.display = "none"; 
    document.getElementById('individualStatusView').style.display = "none"; 
    document.getElementById('pickupStatusView').style.display = "none";
    document.getElementById('studentShuttleView').style.display = "none";
    if(document.getElementById('allStudentListView')) document.getElementById('allStudentListView').style.display = "none";

    // [개선] 메뉴 섹션 표시 로직 강화
    const globalMenu = document.getElementById('side-global-menu');
    const individualMenu = document.getElementById('side-individual-menu');
    
    if(isInd) {
        globalMenu.style.setProperty('display', 'none', 'important');
        individualMenu.style.setProperty('display', 'flex', 'important');
        
        document.getElementById('individualStatusView').style.display = "flex";
        if(homeBtn) homeBtn.style.display = "flex";
        updateIndividualView(); 
        updateQRPreview(); 
    } else {
        globalMenu.style.setProperty('display', 'flex', 'important');
        individualMenu.style.setProperty('display', 'none', 'important');
        
        document.getElementById('totalStatusView').style.display = "flex";
        if(homeBtn) homeBtn.style.display = "none";
    }
}





function renderCourseSelectors() {
    const list = document.getElementById('activeCourseList');
    const setupRoom = document.getElementById('setup-room-select');
    if (!list || !setupRoom) return;

    list.innerHTML = "";
    setupRoom.innerHTML = '<option value="">강의실 선택 (A~Z)</option>';

    // 과정별로 부여할 컬러 배열
    const barColors = ['#0ea5e9', '#10b981', '#6366f1', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];

    for (let i = 65; i <= 90; i++) {
        const rid = String.fromCharCode(i);
        const room = globalAllData[rid];

        // 1. 설정창용 드롭다운 옵션 생성
        let label = `Room ${rid}`;
        if (room?.status?.roomStatus === 'active') {
            label += ` [사용중 - ${room.status.professorName || '미정'}]`;
        }
        setupRoom.add(new Option(label, rid));

        // 2. 메인 리스트 아이템 생성 (사용중인 방만)
        if (room?.status?.roomStatus === 'active') {
            const cName = room.settings?.courseName || rid;
            const coordName = room.settings?.coordinatorName || "담당 미지정";
            const color = barColors[i % barColors.length]; // 알파벳 순서대로 컬러 배정

            const card = document.createElement('div');
            card.className = "course-item-card";
            card.onclick = () => {
                currentRID = rid;
                handleRoomSelection();
            };

            card.innerHTML = `
                <div class="course-color-bar" style="background: ${color};"></div>
                <div class="course-info-content">
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <span style="font-size:11px; color:${color}; font-weight:800;">ROOM ${rid}</span>
                        <span style="font-weight:800; font-size:15px; color:var(--navy-dark);">${cName}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:12px; color:#64748b; font-weight:700;">${coordName}</span>
                        <i class="fa-solid fa-chevron-right" style="color:#cbd5e1; font-size:12px;"></i>
                    </div>
                </div>
            `;
            list.appendChild(card);
        }
    }
}




// [수정] 중복 아이콘 제거 및 제목-배지 완벽 한 줄 정렬
function renderTotalHistory() {
    const tbody = document.getElementById('historyTableBody');
    const label = document.getElementById('historyDateLabel');
    if(!tbody || !label) return;

    const d = new Date(selectedDate);
    const dateText = `${d.getMonth() + 1}/${d.getDate()}`;
    
    // HTML에 이미 아이콘이 있으므로 JS에서는 아이콘을 빼고 텍스트와 배지만 넣습니다.
    // display: inline-flex를 사용하여 옆에 있는 아이콘과 높이를 맞춥니다.
    label.innerHTML = `
        <span style="display:inline-flex; align-items:center; gap:8px; vertical-align:middle;">
            <span style="white-space:nowrap; font-weight:800; font-size:14px; color:var(--navy-bg);">당일(${dateText}) 외출·외박 명단</span>
            <div class="live-badge" style="white-space:nowrap; padding:2px 8px; font-size:10px; display:inline-flex; align-items:center; height:20px;">
                <i class="fa-solid fa-sync fa-spin" style="color:#3b82f6; margin-right:4px;"></i> 실시간
            </div>
        </span>
    `;

    tbody.innerHTML = "";
    let list = [];
    Object.keys(globalAllData).forEach(rid => {
        const actions = globalAllData[rid].admin_actions?.[selectedDate];
        if(actions) {
            Object.keys(actions).forEach(token => {
                list.push({
                    ...actions[token], 
                    rid: rid, 
                    token: token,
                    cName: globalAllData[rid].settings?.courseName || rid
                });
            });
        }
    });

    if(list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="padding:40px; color:#94a3b8; text-align:center; font-size:13px;">오늘 신청된 내역이 없습니다.</td></tr>';
        return;
    }

    list.sort((a,b) => a.timestamp - b.timestamp).forEach(a => {
        const isSigned = a.confirmed === true;
        const returnBadge = a.returned ? `<span style="display:inline-block; white-space:nowrap; background:#10b981; color:white; padding:2px 8px; border-radius:4px; font-size:10px; margin-left:5px; font-weight:800; vertical-align:middle;">복귀</span>` : "";
        const btnText = isSigned ? "취소" : "서명";
        const btnStyle = isSigned ? "background:#94a3b8; color:#fff; border:none;" : "background:var(--blue-main); color:#fff; border:none;";

        const dataStr = encodeURIComponent(JSON.stringify(a));
        // 행 전체 클릭을 위한 설정 (서명 버튼 제외)
        const rowClickAction = `onclick="showActionDetail('${dataStr}')" style="cursor:pointer;"`;

        tbody.innerHTML += `
            <tr>
                <td ${rowClickAction} style="text-align:center; font-size:11px; color:var(--blue-deep); font-weight:700;">${a.cName.substring(0,6)}..</td>
                <td ${rowClickAction} style="font-weight:800; text-align:center;">${a.name}${returnBadge}</td>
                <td ${rowClickAction} style="color:${a.type==='outing'?'#ea580c':'#dc2626'}; font-weight:800; text-align:center;">${a.type==='outing'?'외출':'외박'}</td>
                <td ${rowClickAction} style="text-align:center; font-size:11px; color:#94a3b8;">${new Date(a.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</td>
                <td>
                    <button onclick="toggleConfirm('${a.rid}', '${selectedDate}', '${a.token}', ${isSigned})" 
                            style="${btnStyle} border-radius:6px; width:100%; height:32px; display:flex; align-items:center; justify-content:center; font-weight:800; cursor:pointer; font-size:11px; margin: 0 auto;">
                        ${btnText}
                    </button>
                </td>
            </tr>`;
    });
}








// [수정] 통합 관리대장 열기 (날짜 선택기 초기화 및 홈 버튼 표시)
function openOutingManager() { 
    // 상세 페이지 내부의 날짜 선택기를 현재 선택된 전역 날짜(selectedDate)로 세팅
    const datePicker = document.getElementById('managerDatePicker');
    if(datePicker) datePicker.value = selectedDate;

    document.getElementById('outingManagerView').style.display = 'flex'; 
    const homeBtn = document.getElementById('floatingHomeBtn');
    if(homeBtn) homeBtn.style.display = "flex"; 
    
    renderOutingManager(); 
}

// [신규] 상세 페이지 내에서 날짜 변경 시 호출되는 함수
function changeManagerDate(val) {
    selectedDate = val; // 전역 날짜 변수 업데이트
    renderOutingManager(); // 리스트 새로고침
}

// [수정] 통합 관리대장 리스트 렌더링 (날짜별 필터링 완벽 적용)
function renderOutingManager() { 
    const tbody = document.getElementById('managerTableBody'); 
    const label = document.getElementById('managerDateLabel'); 
    
    // 헤더에 요일 표시 추가
    const d = new Date(selectedDate);
    const dayNames = ["일","월","화","수","목","금","토"];
    const dayName = isNaN(d.getDay()) ? "" : ` (${dayNames[d.getDay()]})`;
    label.innerText = `${selectedDate}${dayName} 통합 관리 현황`; 

    tbody.innerHTML = ""; 
    let list = []; 

    // 모든 과정(Room)을 돌며 선택된 날짜(selectedDate)의 신청 내역 수집
    Object.keys(globalAllData).forEach(rid => { 
        const actions = globalAllData[rid].admin_actions?.[selectedDate]; 
        if(actions) {
            Object.keys(actions).forEach(token => {
                list.push({ 
                    ...actions[token], 
                    rid, 
                    token, 
                    cName: globalAllData[rid].settings?.courseName || rid 
                });
            });
        }
    }); 

    if(list.length === 0) { 
        tbody.innerHTML = '<tr><td colspan="5" style="padding:40px; color:#94a3b8; text-align:center;">선택한 날짜에 신청 내역이 없습니다.</td></tr>'; 
        return; 
    } 

    // 시간순 정렬 및 테이블 출력
    list.sort((a,b) => a.timestamp - b.timestamp).forEach(a => { 
        const isSigned = a.confirmed === true; 
        const btnContent = isSigned ? `<img src="${a.confirmedBySign}" class="stamp-img" style="height:32px;">` : "서명하기"; 
        const btnStyle = isSigned ? "background: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0;" : "background: var(--blue-main); color: #fff; border: none;"; 
        
        tbody.innerHTML += `
            <tr>
                <td style="width:30%; font-size:10px; text-align:center;">${a.cName}</td>
                <td style="width:18%; font-weight:800; text-align:center;">${a.name}</td>
                <td style="width:12%; color:${a.type==='outing'?'#ea580c':'#dc2626'}; font-weight:800; text-align:center;">${a.type==='outing'?'외출':'외박'}</td>
                <td style="width:20%; font-size:10px; text-align:center;">${new Date(a.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</td>
                <td style="width:20%; text-align:center;">
                    <button onclick="toggleConfirm('${a.rid}', '${selectedDate}', '${a.token}', ${isSigned})" 
                            style="${btnStyle} border-radius:5px; padding:2px 0; font-size:10px; cursor:pointer; width:100%; height:38px; display:flex; align-items:center; justify-content:center; font-weight:800;">
                        ${btnContent}
                    </button>
                </td>
            </tr>`; 
    }); 
}

// [기존 유지] 관리대장 닫기
function closeOutingManager() { 
    document.getElementById('outingManagerView').style.display = 'none'; 
}

// [기존 유지] 설정 모달 핸들링
function openSetupModal() { toggleMenu(false); document.getElementById('setupModal').style.display = "flex"; }
function openSetupModalFromIndividual() { document.getElementById('setup-room-select').value = currentRID; loadRoomSettings(currentRID); toggleMenu(false); document.getElementById('setupModal').style.display = "flex"; }

async function loadRoomSettings(rid) { 
    const room = globalAllData[rid]; 
    if(!room) return; 
    document.getElementById('setup-course-name').value = room.settings?.courseName || ""; 
    document.getElementById('setup-prof-select').value = room.status?.professorName || ""; 
    document.getElementById('setup-coord-select').value = room.settings?.coordinatorName || ""; 
    if(room.settings?.period?.includes(" ~ ")) { 
        const p = room.settings.period.split(" ~ "); 
        document.getElementById('setup-start').value = p[0]; 
        document.getElementById('setup-end').value = p[1]; 
    } 
    const loc = room.settings?.roomDetailName || ""; 
    const dropdown = document.getElementById('setup-room-dropdown'); 
    let found = false; 
    for(let i=0; i<dropdown.options.length; i++) { 
        if(dropdown.options[i].value === loc) { dropdown.selectedIndex = i; found = true; break; } 
    } 
    if(!found && loc) { 
        dropdown.value = "direct"; 
        document.getElementById('setup-location-direct').value = loc; 
        document.getElementById('setup-location-direct').style.display = "block"; 
    } else { 
        document.getElementById('setup-location-direct').style.display = "none"; 
    } 
}

async function saveIntegratedSettings() { 
    const rid = document.getElementById('setup-room-select').value; 
    const name = document.getElementById('setup-course-name').value.trim(); 
    const start = document.getElementById('setup-start').value; 
    const end = document.getElementById('setup-end').value; 
    const prof = document.getElementById('setup-prof-select').value; 
    const coord = document.getElementById('setup-coord-select').value; 
    const dropLoc = document.getElementById('setup-room-dropdown').value; 
    const loc = (dropLoc === 'direct') ? document.getElementById('setup-location-direct').value.trim() : dropLoc; 
    
    if(!rid || !name || !start || !end || !prof || !loc) return alert("필수 항목 입력 필요"); 
    
    const updates = {}; 
    updates[`courses/${rid}/settings/courseName`] = name; 
    updates[`courses/${rid}/settings/period`] = `${start} ~ ${end}`; 
    updates[`courses/${rid}/status/professorName`] = prof; 
    updates[`courses/${rid}/settings/coordinatorName`] = coord; 
    updates[`courses/${rid}/settings/roomDetailName`] = loc; 
    updates[`courses/${rid}/status/roomStatus`] = "active"; 
    
    await firebase.database().ref().update(updates).then(()=>alert("저장 완료")); 
    closeSetupModal(); 
}







// [보안 강화] 관리자 비밀번호 확인 후 교육과정 강제 리셋 실행
async function resetIndividualCourse() {
    if (!currentRID) return alert("먼저 리셋할 교육 과정을 선택해주세요.");

    // 1. 해당 과정의 관리자 비밀번호를 서버에서 가져옴
    const snap = await firebase.database().ref(`courses/${currentRID}/settings/password`).once('value');
    const dbPw = snap.val() || btoa("7777"); // 데이터가 없으면 기본값 7777 (암호화됨)

    // 2. 사용자에게 비밀번호 입력 요청
    const userInput = prompt("🚨 [주의] 모든 데이터(명단, 신청내역 등)가 삭제됩니다.\n계속하시려면 이 과정의 관리자 비밀번호를 입력하세요.");

    if (!userInput) return; // 입력 안 하거나 취소 누르면 중단

    // 3. 비밀번호 대조 (입력값을 Base64로 변환하여 비교)
    if (btoa(userInput) === dbPw) {
        // 비밀번호가 맞을 경우 최종 확인
        if (!confirm("정말 초기화하시겠습니까?\n이 작업은 절대로 되돌릴 수 없으며 모든 교육생이 퇴출됩니다.")) return;

        const rPath = `courses/${currentRID}`;
        const updates = {};
        
        // 초기화할 데이터 항목들
        updates[`${rPath}/students`] = null;
        updates[`${rPath}/admin_actions`] = null;
        updates[`${rPath}/shuttle`] = null;
        updates[`${rPath}/questions`] = null;
        updates[`${rPath}/coordNotice`] = null;
        updates[`${rPath}/notice`] = null;
        updates[`${rPath}/expectedStudents`] = null;
        updates[`${rPath}/attendanceQR`] = null;
        
        // 상태 변경 (비어있음으로 전환 및 강제 퇴출 키 발송)
        updates[`${rPath}/status/roomStatus`] = "idle";
        updates[`${rPath}/status/resetKey`] = "KICK_COORD_" + Date.now();

        try {
            await firebase.database().ref().update(updates);
            alert("✅ 교육과정이 정상적으로 초기화 및 종료되었습니다.");
            currentRID = ""; // 선택 해제
            handleRoomSelection(); // 첫 화면으로 복귀
        } catch (e) {
            alert("오류 발생: " + e.message);
        }
    } else {
        // 비밀번호가 틀렸을 때
        alert("❌ 비밀번호가 올바르지 않습니다. 초기화가 취소되었습니다.");
    }
}
  

// 외출외박 대장 새창 열기 함수
function openOutingLedger() {
    if(!currentRID) {
        alert("먼저 왼쪽 리스트에서 교육 과정을 선택해주세요.");
        return;
    }
    // 새 창으로 출력용 페이지 열기 (과정 ID를 함께 보냄)
    window.open(`outing_ledger.html?room=${currentRID}`, '_blank', 'width=1300,height=900,scrollbars=yes');
}


// 인쇄 아이콘 클릭 시 실행되는 함수
function openPrintModal() {
    const modal = document.getElementById('printSelectModal');
    const listDiv = document.getElementById('printCourseList');
    if (!modal || !listDiv) return; // 에러 방지용 체크
    
    listDiv.innerHTML = "";

    let hasActive = false;
    for (let i = 65; i <= 90; i++) {
        const rid = String.fromCharCode(i);
        const room = globalAllData[rid];
        if (room?.status?.roomStatus === 'active') {
            hasActive = true;
            const cName = room.settings?.courseName || `Room ${rid}`;
            const btn = document.createElement('button');
            btn.className = "navy-btn";
            btn.style = "background:#fff; color:var(--navy-dark); border:1.5px solid #e2e8f0; justify-content:flex-start; padding-left:15px; margin-bottom:5px;";
            btn.innerHTML = `<i class="fa-solid fa-file-lines" style="color:var(--blue-main); margin-right:10px;"></i> ${cName}`;
            btn.onclick = () => {
                window.open(`outing_ledger.html?room=${rid}`, '_blank');
                modal.style.display = 'none';
            };
            listDiv.appendChild(btn);
        }
    }

    if(!hasActive) {
        listDiv.innerHTML = "<p style='text-align:center; padding:20px; color:#94a3b8; font-size:13px;'>현재 운영 중인 과정이 없습니다.</p>";
    }

    modal.style.display = 'flex';
}





// ==========================================
// [1] 날짜 및 인쇄 관련 핵심 로직 (수정본)
// ==========================================

// 날짜 변경 시 호출
function changeManagerDate(val) {
    selectedDate = val; // 전역 날짜 변수 업데이트
    renderOutingManager(); // 리스트 새로고침
}

// 인쇄 시작 로직
function startPrint(mode) { 
    document.getElementById('outingManagerView').style.display = 'none'; 
    const overlay = document.getElementById('loadingOverlay'); 
    overlay.style.display = "flex"; 
    let progress = 0; 
    const timer = setInterval(() => { 
        progress += 25; 
        document.getElementById('progressFill').style.width = progress + "%"; 
        if(progress > 100) { 
            clearInterval(timer); 
            overlay.style.display = "none"; 
            executePrintProcess(mode); 
        } 
    }, 150); 
}

// 실제 인쇄 데이터 생성 - 선택된 날짜(selectedDate) 기준
function executePrintProcess(mode) { 
    const targetBody = document.getElementById('printBody'); 
    const targetRID = (mode === 'course') ? currentRID : ""; 
    document.getElementById('print-info-text').innerText = `대상일자: ${selectedDate}`; 
    
    targetBody.innerHTML = ""; 
    let list = []; 
    
    Object.keys(globalAllData).forEach(rid => { 
        if (mode === 'course' && rid !== targetRID) return; 
        const actions = globalAllData[rid].admin_actions?.[selectedDate]; 
        if(actions) {
            Object.values(actions).forEach(a => {
                list.push({ ...a, rid, cName: globalAllData[rid].settings?.courseName || rid });
            });
        }
    }); 
    
    list.sort((a,b) => a.timestamp - b.timestamp).forEach((a, idx) => { 
        const signImg = a.confirmedBySign ? `<img src="${a.confirmedBySign}" style="height:35px; mix-blend-mode:multiply;">` : ""; 
        targetBody.innerHTML += `
            <tr>
                <td>${idx+1}</td>
                <td>${a.cName}</td>
                <td>${a.type==='outing'?'외출':'외박'}</td>
                <td>${a.name}</td>
                <td>${a.phone}</td>
                <td>${new Date(a.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</td>
                <td>${signImg}</td>
            </tr>`; 
    }); 
    window.print(); 
}

// ==========================================
// [2] 화면 UI 제어 및 유틸리티 함수 (중복 제거용)
// ==========================================

function toggleMenu(open) { 
    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    
    sideMenu.classList.toggle('open', open); 
    menuOverlay.style.display = open ? "block" : "none"; 

    // [추가] 메뉴가 열릴 때 body 스크롤 방지 클래스 토글
    if (open) {
        document.body.classList.add('modal-open');
    } else {
        // 단, 다른 모달이 열려있지 않을 때만 스크롤 방지 해제
        const isAnyModalVisible = Array.from(document.querySelectorAll('.setup-modal'))
            .some(el => window.getComputedStyle(el).display !== 'none');
            
        if (!isAnyModalVisible) {
            document.body.classList.remove('modal-open');
        }
    }
}

function closeSetupModal() { document.getElementById('setupModal').style.display = "none"; }
function closeTransportModal() { document.getElementById('transportModal').style.display = 'none'; }

function getTodayString(d = new Date()) { 
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; 
}

function autoGrow(el) { 
    el.style.height = "5px"; 
    el.style.height = (el.scrollHeight) + "px"; 
}

// 이 아래부터는 기존에 있던 나머지 함수들(checkLocationDirect, saveCourseNotice 등)을 그대로 두시면 됩니다.





// [신규] 행정 페이지 접속 QR 열기 함수
function openCenterQrModal() {
    toggleMenu(false); // 사이드바가 열려있다면 닫기
    const modal = document.getElementById('centerQrModal');
    const target = document.getElementById('centerQrTarget');
    
    modal.style.display = 'flex';
    target.innerHTML = ""; // 기존 QR 초기화

    // 현재 페이지의 주소를 QR로 생성
    const currentUrl = window.location.href;

    new QRCode(target, {
        text: currentUrl,
        width: 200,
        height: 200,
        colorDark : "#0f172a",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
    });
}






    function checkLocationDirect(v) { document.getElementById('setup-location-direct').style.display = (v === 'direct') ? "block" : "none"; }
    function saveCourseNotice() { if(currentRID) firebase.database().ref(`courses/${currentRID}/coordNotice`).set(document.getElementById('courseNotice').value).then(()=>alert("저장 완료")); }
    function saveGlobalNotice() { firebase.database().ref(`system/globalNotice`).set(document.getElementById('globalNotice').value).then(()=>alert("저장 완료")); }
    async function handleQRUpload(input) { const reader = new FileReader(); reader.onload = async (e) => { await firebase.database().ref(`courses/${currentRID}/attendanceQR`).set(e.target.result); alert("QR 저장 완료"); updateQRPreview(); }; reader.readAsDataURL(input.files[0]); }
    function updateQRPreview() { const room = globalAllData[currentRID]; const img = document.getElementById('qrPreview'); const empty = document.getElementById('qrEmpty'); if(room?.attendanceQR) { img.src = room.attendanceQR; img.style.display = "block"; empty.style.display = "none"; } else { img.style.display = "none"; empty.style.display = "block"; } }
    function loadActionHistory(date) { selectedDate = date; renderTotalHistory(); }
    function showEntryMemberList() { const room = globalAllData[currentRID]; const valid = Object.values(room.students || {}).filter(s => s.name && s.name !== "undefined"); const list = Array.from(new Set(valid.map(s => s.name))).sort().join(", "); alert(`[입교 명단]\n\n${list || "입교자 없음"}`); }
// [개편] 목적지별 클릭 시 상세 명단 팝업
    function showShuttleMembers(locType) {
        const room = globalAllData[currentRID];
        // 개편된 데이터 경로(requests)에서 가져옵니다.
        const requests = room.shuttle?.requests || {};
        const typeNames = { osong: '오송역', terminal: '청주터미널', airport: '청주공항', car: '자차/개별이동' };
        
        const members = Object.values(requests)
            .filter(r => r.type === locType)
            .map(r => `${r.name}(${r.phone})`)
            .sort();

        alert(`[${typeNames[locType]} 신청 명단]\n\n${members.join(", ") || "신청자 없음"}`);
    }

    setInterval(() => { const now = new Date(); const week = ['일','월','화','수','목','금','토']; document.getElementById('footer-date').innerText = `${now.getFullYear()}.${now.getMonth()+1}.${now.getDate()} (${week[now.getDay()]}) ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`; }, 1000);
    firebase.database().ref('system/professors').on('value', snap => {
        const sel = document.getElementById('setup-prof-select'); if(sel) { sel.innerHTML = '<option value="">교수 선택</option>'; Object.values(snap.val() || {}).forEach(n => sel.add(new Option(n, n))); }
    });







// 생활관 배정 현황 로직 추가
    async function openDormManager() {
        toggleMenu(false);
        const tbody = document.getElementById('dormTableBody');
        tbody.innerHTML = "<tr><td colspan='4' style='padding:20px;'>데이터를 불러오는 중...</td></tr>";
        document.getElementById('dormManagerModal').style.display = 'flex';

        try {
            const [studentSnap, dormSnap] = await Promise.all([
                firebase.database().ref(`courses/${currentRID}/students`).once('value'),
                firebase.database().ref(`system/dormitory_assignments`).once('value')
            ]);

            const students = studentSnap.val() || {};
            const dormData = dormSnap.val() || {};
            tbody.innerHTML = "";

            const studentList = Object.values(students)
                .filter(s => s.name && s.name !== "undefined")
                .sort((a, b) => a.name.localeCompare(b.name));

            if (studentList.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4' style='padding:20px;'>입교한 교육생이 없습니다.</td></tr>";
                return;
            }

            studentList.forEach(s => {
                const sPhone = s.phone ? s.phone.slice(-4) : "";
                let assigned = dormData[`${s.name.trim()}_${sPhone}`] || dormData[s.name.trim()] || { building: "-", room: "미배정" };
                
                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight:800;">${s.name}</td>
                        <td style="color:#64748b;">${sPhone}</td>
                        <td style="color:var(--blue-deep);">${assigned.building}</td>
                        <td style="font-weight:800;">${assigned.room}${assigned.room !== '미배정' ? '호' : ''}</td>
                    </tr>`;
            });
        } catch (e) {
            tbody.innerHTML = "<tr><td colspan='4' style='color:red;'>오류 발생: " + e.message + "</td></tr>";
        }
    }



// [신규] 상세 내역 팝업 표시 함수
function showActionDetail(dataJson) {
    const data = JSON.parse(decodeURIComponent(dataJson));
    const content = document.getElementById('actionDetailContent');
    
    const typeNm = data.type === 'outing' ? '<span style="color:#ea580c;">외출(당일)</span>' : '<span style="color:#dc2626;">외박(익일)</span>';
    const returnStatus = data.returned ? `<b style="color:#10b981;">[복귀보고 완료: ${data.returnReportTime}]</b>` : `<b style="color:#ef4444;">[미복귀 / 외출중]</b>`;

    content.innerHTML = `
        <div style="border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 5px;">
            <div style="font-size: 13px; color: #64748b; font-weight: 800;">신청자 및 유형</div>
            <div style="font-size: 18px; font-weight: 900;">${data.name} <small style="font-size:13px; font-weight:700; margin-left:5px;">(${typeNm})</small></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div style="background:#f8fafc; padding:10px; border-radius:8px;">
                <div style="font-size:11px; color:#94a3b8; font-weight:800;">소속</div>
                <div style="font-weight:700; font-size:14px;">${data.dept || '-'}</div>
            </div>
            <div style="background:#f8fafc; padding:10px; border-radius:8px;">
                <div style="font-size:11px; color:#94a3b8; font-weight:800;">연락처</div>
                <div style="font-weight:700; font-size:14px;">${data.phone || '-'}</div>
            </div>
        </div>
        <div style="background:#f0f9ff; padding:12px; border-radius:8px; border:1px solid #e0f2fe;">
            <div style="font-size:11px; color:#3b82f6; font-weight:800;">외출/복귀 시간</div>
            <div style="font-weight:800; font-size:15px;">${data.startTime} ~ ${data.endTime}</div>
            ${data.type === 'overnight' ? `<div style="font-size:12px; color:#64748b; margin-top:2px;">(복귀예정일: ${data.returnDate})</div>` : ''}
        </div>
        <div style="background:#f8fafc; padding:12px; border-radius:8px;">
            <div style="font-size:11px; color:#94a3b8; font-weight:800;">행선지</div>
            <div style="font-weight:700; font-size:14px; margin-bottom:8px;">${data.destination || '-'}</div>
            <div style="font-size:11px; color:#94a3b8; font-weight:800;">신청 사유</div>
            <div style="font-weight:700; font-size:14px;">${data.reason || '-'}</div>
        </div>
        <div style="text-align:center; padding:5px;">
            ${returnStatus}
        </div>
    `;
    
    document.getElementById('actionDetailModal').style.display = 'flex';
}



// [2] 수송 톡 화면을 여는 함수
function showPickupView() {
    currentRID = ""; 
    handleRoomSelection(); 
    
    // 전체 화면 가리고 픽업 뷰 활성화
    document.getElementById('totalStatusView').style.display = "none";
    document.getElementById('pickupStatusView').style.display = "flex";
    
    const homeBtn = document.getElementById('floatingHomeBtn');
    if(homeBtn) homeBtn.style.display = "flex";
    
    // 데이터 렌더링 시작
    renderPickupTable();
    
    // 뷰 전환 시점에 스크롤 한 번 더 시도
    setTimeout(scrollToBottomPickup, 150);
}






// [수정] 교육생 수송 뷰 진입 시 플로팅 버튼 표시
function showStudentShuttleView() {
    currentRID = "";
    handleRoomSelection();
    document.getElementById('totalStatusView').style.display = "none";
    document.getElementById('studentShuttleView').style.display = "flex";
    
    const homeBtn = document.getElementById('floatingHomeBtn');
    if(homeBtn) homeBtn.style.display = "flex";
    
    renderShuttleTotalTable();
}









function renderPickupTable() {
    const container = document.getElementById('pickupCardContainer');
    if(!container) return;
    
    firebase.database().ref('system/transport_requests').on('value', snap => {
        const data = snap.val() || {};
        const now = new Date();
        const updates = {};
        let hasUpdates = false;

        // 1. 데이터 배열화 및 마감 로직 (기존과 동일)
        const items = Object.keys(data).map(k => {
            const item = { id: k, ...data[k] };
            if (item.status === 'approved' && item.date && item.time) {
                const scheduledTime = new Date(item.date + ' ' + item.time);
                const limitTime = new Date(scheduledTime.getTime() + 2 * 60 * 60 * 1000); 
                if (now > limitTime && !isNaN(scheduledTime.getTime())) {
                    updates[`system/transport_requests/${k}/status`] = 'finished';
                    item.status = 'finished';
                    hasUpdates = true;
                }
            }
            return item;
        });

        if (hasUpdates) firebase.database().ref().update(updates);

        if (items.length === 0) {
            container.innerHTML = '<div style="padding:50px; color:#fff; text-align:center; font-size:14px; font-weight:800;">수송 내역이 없습니다.</div>';
            return;
        }

        const validItems = items.filter(r => r.prof && r.date && r.courseRID);
        const grouped = {};
        validItems.forEach(r => {
            const requestDate = r.timestamp ? new Date(r.timestamp).toISOString().split('T')[0] : r.date;
            const groupKey = `${requestDate}_${r.prof}_${r.courseRID}`;
            if (!grouped[groupKey]) {
                grouped[groupKey] = { requestDate, prof: r.prof, phone: r.phone || "", courseRID: r.courseRID, requests: [] };
            }
            grouped[groupKey].requests.push(r);
        });

        const sortedGroups = Object.values(grouped).sort((a, b) => a.requestDate.localeCompare(b.requestDate));
        let htmlContent = ""; 
        let lastDividerDate = "";
        const dayNames = ["일","월","화","수","목","금","토"];

        sortedGroups.forEach(group => {
            if(group.requestDate !== lastDividerDate) {
                htmlContent += `<div class="chat-date-line"><span>${group.requestDate} 요청건</span></div>`;
                lastDividerDate = group.requestDate;
            }

            const roomInfo = globalAllData[group.courseRID];
            const cName = roomInfo?.settings?.courseName || `과정 정보 없음`;
            const isAllFinished = group.requests.every(r => r.status === 'finished' || r.status === 'completed' || r.status === 'cancelled');

            const targetDate = group.requests[0].date;
            const d = new Date(targetDate);
            const dateWithDay = `${targetDate}(${dayNames[d.getDay()]})`;

            group.requests.sort((a,b) => (a.time || "").localeCompare(b.time || ""));

            let scheduleHtml = group.requests.map(r => {
                const isCan = r.status === 'cancelled';
                const isFin = r.status === 'finished' || r.status === 'completed';
                const style = isCan ? 'text-decoration:line-through; opacity:0.5;' : (isFin ? 'color:#94a3b8;' : '');
                return `<div style="${style} font-size:14px; margin-bottom:2px;"><b>${r.time}</b> ${r.dir.replace('→',' > ')} ${isCan?'(취소)':isFin?'(완료)':''}</div>`;
            }).join('');
            
            const cancelButtons = group.requests.map(r => 
                (r.status !== 'cancelled' && r.status !== 'finished' && r.status !== 'completed') 
                ? `<button class="btn-cancel-talk" onclick="deleteTrans('${r.id}')">취소(${r.time})</button>` : ''
            ).join('');

            const bubbleBg = isAllFinished ? "background: #e2e8f0; color: #64748b;" : "background: #fee500; color: #1e293b;";

            htmlContent += `
                <div class="chat-bubble chat-right" style="opacity: ${isAllFinished ? '0.8' : '1'};">
                    <div class="talk-header" style="text-align:right;">수송요청 ${isAllFinished ? '(완료)' : ''}</div>
                    <div class="bubble-admin" style="${bubbleBg} padding:15px; border-radius:12px 0 12px 12px;">
                        <div style="font-size:14px; line-height:1.5; font-weight:700;">
                            강사수송요청드립니다.<br>
                            ${cName} 과정<br>
                            ${group.prof} 강사님<br>
                            (${formatPhone(group.phone)})
                        </div>
                        <div style="border-top:1px dashed rgba(0,0,0,0.1); margin:10px 0;"></div>
                        <div style="font-size:14px; font-weight:800; margin-bottom:5px;">[${dateWithDay}]</div>
                        <div class="talk-body">${scheduleHtml}</div>
                        ${cancelButtons ? `<div class="talk-footer" style="justify-content: flex-end; margin-top:8px;">${cancelButtons}</div>` : ''}
                    </div>
                    <div class="chat-time">운영부</div>
                </div>`;

            group.requests.forEach(r => {
                if(r.status === 'approved' || r.status === 'finished' || r.status === 'completed') {
                    const isFin = r.status === 'finished' || r.status === 'completed';
                    htmlContent += `
                        <div class="chat-bubble chat-left">
                            <div class="talk-header">기사님 회신</div>
                            <div class="bubble-driver" style="${isFin ? 'background:#f1f5f9; color:#94a3b8;' : ''} padding:10px; border-radius:0 12px 12px 12px;">
                                <div style="font-weight:800; font-size:13px;">${isFin ? '✅ 운행 마감' : '확인했습니다. 배차 승인!'}</div>
                                <div style="font-size:11px; margin-top:3px; opacity:0.8;">
                                    ${r.prof} [${r.date}] ${r.dir}
                                </div>
                            </div>
                            <div class="chat-time">운전원</div>
                        </div>`;
                }
            });
        });

        // 🚩 [핵심] 톡 내용 마지막에 보이지 않는 점(Anchor) 추가
        htmlContent += `<div id="chat-bottom-anchor" style="height:10px; width:100%; clear:both;"></div>`;

        container.innerHTML = htmlContent;

        // 🚩 [핵심] 보이지 않는 점으로 즉시 화면 초점 이동
        setTimeout(() => {
            const anchor = document.getElementById('chat-bottom-anchor');
            if(anchor) {
                anchor.scrollIntoView({ behavior: 'auto', block: 'end' });
            }
        }, 100);
    });
}












 



// [수정] 교육생 퇴교차량 통합 테이블 (총원 음영 제거 완료)
function renderShuttleTotalTable() {
    const tbody = document.getElementById('shuttleTotalTableBody');
    if(!tbody) return;

    let html = "";
    for (let i = 65; i <= 90; i++) {
        const rid = String.fromCharCode(i);
        const room = globalAllData[rid];
        if (room?.status?.roomStatus === 'active') {
            const requests = room.shuttle?.requests || {};
            const items = Object.values(requests);
            
            const cName = room.settings?.courseName || rid;
            const rO = items.filter(i => i.type === 'osong').length;
            const rT = items.filter(i => i.type === 'terminal').length;
            const rA = items.filter(i => i.type === 'airport').length;
            const rC = items.filter(i => i.type === 'car').length;

            html += `
                <tr onclick="showShuttleApplicationDetails('${rid}')" style="cursor:pointer;" class="shuttle-row-hover">
                    <td style="text-align:left; padding-left:15px; font-weight:800; color:var(--blue-deep);">${cName}</td>
                    <!-- 🚩 여기 td에서 background 스타일을 삭제했습니다 -->
                    <td style="font-weight:900;">${items.length}</td> 
                    <td style="color:#ef4444; font-weight:800;">${rO}</td>
                    <td style="color:#3b82f6; font-weight:800;">${rT}</td>
                    <td style="color:#10b981; font-weight:800;">${rA}</td>
                    <td style="color:#64748b;">${rC}</td>
                </tr>`;
        }
    }
    tbody.innerHTML = html || '<tr><td colspan="6" style="padding:40px; color:#94a3b8;">운영 중인 과정의 신청 내역이 없습니다.</td></tr>';
}





// [최종] 격자 정렬 및 스크롤 잠금이 적용된 퇴교 차량 상세 팝업
async function showShuttleApplicationDetails(rid) {
    const targetRID = rid || currentRID;
    const room = globalAllData[targetRID];
    if (!room) return;

    // 팝업 열 때 배경 스크롤 차단
    document.body.classList.add('modal-open');

    const cName = room.settings?.courseName || targetRID;
    const requests = room.shuttle?.requests || {};
    const appliedData = Object.values(requests);

    // 가나다순 정렬을 미리 수행
    appliedData.sort((a, b) => a.name.localeCompare(b.name));

    const categories = {
        osong: { title: "오송역", color: "bg-osong", icon: "fa-train", members: [] },
        terminal: { title: "청주터미널", color: "bg-terminal", icon: "fa-bus", members: [] },
        airport: { title: "청주공항", color: "bg-airport", icon: "fa-plane", members: [] },
        car: { title: "자차/개별", color: "bg-car", icon: "fa-car", members: [] }
    };

    appliedData.forEach(req => {
        if (categories[req.type] && req.name && req.name !== "undefined") {
            const phoneSuffix = req.phone ? `(${req.phone.slice(-4)})` : "";
            categories[req.type].members.push(`${req.name}${phoneSuffix}`);
        }
    });

    let html = `<div style="margin-bottom:15px; font-weight:800; color:var(--navy-bg); font-size:15px; padding-left:5px;">[${cName}] 수송 명단</div>`;
    
    Object.keys(categories).forEach(key => {
        const cat = categories[key];
        html += `
            <div class="shuttle-detail-section">
                <div class="shuttle-detail-header ${cat.color}" style="border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-weight:900;"><i class="fa-solid ${cat.icon}"></i> ${cat.title} (${cat.members.length}명)</span>
                </div>
                <div class="shuttle-detail-list">
                    ${cat.members.length > 0 ? cat.members.map(m => `<span>${m}</span>`).join('') : '<div style="grid-column: span 3; padding: 20px; color: #cbd5e1; text-align: center; font-size: 12px;">신청자 없음</div>'}
                </div>
            </div>
        `;
    });

    document.getElementById('shuttleDetailContent').innerHTML = html;
    document.getElementById('shuttleDetailModal').style.display = 'flex';
}




// [수정] 어떤 팝업이든 열리면 홈 버튼 노출 + 배경 스크롤 차단 자동화
function handleModalScrollLock() {
    const homeBtn = document.getElementById('floatingHomeBtn');
    if(!homeBtn) return;

    // 감시할 대상들 (팝업, 관리대장 등)
    const observer = new MutationObserver(() => {
        // 현재 화면에 'display: flex' 또는 'block'으로 보이는 모달이 하나라도 있는지 확인
        const isAnyModalVisible = Array.from(document.querySelectorAll('.setup-modal, .modal-overlay, #outingManagerView'))
            .some(el => {
                const style = window.getComputedStyle(el);
                return style.display !== 'none';
            });
        
        if (isAnyModalVisible) {
            // 팝업이 하나라도 열려있을 때
            document.body.classList.add('modal-open');
            homeBtn.style.display = 'flex';
        } else {
            // 모든 팝업이 닫혔을 때 (단, 개별과정 상세 뷰가 아닐 때만 스크롤 해제)
            if (currentRID === "") {
                document.body.classList.remove('modal-open');
                homeBtn.style.display = 'none';
            } else {
                // 개별 상세 뷰에서는 홈 버튼은 유지하되 스크롤은 허용
                document.body.classList.remove('modal-open');
                homeBtn.style.display = 'flex';
            }
        }
    });

    // 모든 모달 요소의 'style' 속성 변화를 감시
    document.querySelectorAll('.setup-modal, .modal-overlay, #outingManagerView').forEach(modal => {
        observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
    });
}

// 기존 init 함수 내 호출 부분 수정
const originalInitSupport = init;
init = function() {
    originalInitSupport();
    handleModalScrollLock(); // 감시 시작
};



// 숫자를 휴대폰 번호 형식(하이픈)으로 바꿔주는 함수
  function formatPhone(num) {
    if (!num) return "";
    // 숫자만 남기기
    const s = num.replace(/[^0-9]/g, "");
    if (s.length === 11) {
      return s.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3");
    } else if (s.length === 10) {
      return s.replace(/(\d{3})(\d{3})(\d{4})/, "$1-$2-$3");
    }
    return num; // 형식이 안 맞으면 그냥 원본 출력
  }







// [수정] 메인 상황판에서 '전체 교육생' 버튼 클릭 시 실행
async function showTotalStudentList() {
    currentRID = ""; 
    handleRoomSelection(); // 모든 뷰 숨기기
    document.getElementById('totalStatusView').style.display = "none";
    document.getElementById('allStudentListView').style.display = "flex";
    
    const homeBtn = document.getElementById('floatingHomeBtn');
    if(homeBtn) homeBtn.style.display = "flex";
    
    // 데이터 불러오기
    await loadAllStudentData();
}

// [수정] 모든 과정의 교육생 정보를 긁어모아 테이블 데이터 생성
async function loadAllStudentData() {
    const tbody = document.getElementById('allStudentTableBody');
    tbody.innerHTML = '<tr><td colspan="5" style="padding:50px;">데이터를 통합 중입니다...</td></tr>';
    
    const today = getTodayString();
    masterStudentList = [];

    const dormSnap = await firebase.database().ref('system/dormitory_assignments').once('value');
    const dormData = dormSnap.val() || {};

    Object.keys(globalAllData).forEach(rid => {
        const room = globalAllData[rid];
        const courseName = room.settings?.courseName || `Room ${rid}`;
        if (!room.students) return;

        Object.keys(room.students).forEach(stoken => {
            const s = room.students[stoken];
            if (!s.name || s.name === "undefined") return;

            const phoneSuffix = s.phone ? s.phone.slice(-4) : "0000";
            const sKey = `${s.name.trim()}_${phoneSuffix}`;

            // A. 생활관 정보 찾기
            let assigned = dormData[sKey] || dormData[s.name.trim()];
            if (!assigned) {
                const foundKey = Object.keys(dormData).find(k => k.startsWith(s.name.trim()));
                if (foundKey) assigned = dormData[foundKey];
            }

            const dorm = assigned || { building: "-", room: "미배정" };
            
            // B. 퇴교 차량 정보 찾기
            const shuttleReq = room.shuttle?.requests?.[stoken];
            let shuttleText = "-";
            let shuttleClass = "";
            if(shuttleReq) {
                const types = { osong: '오송역', terminal: '터미널', airport: '공항', car: '자차' };
                shuttleText = types[shuttleReq.type] || "신청";
                shuttleClass = `badge-shuttle badge-${shuttleReq.type}`;
            }

            // C. 외출/외박 정보 찾기
            const action = room.admin_actions?.[today]?.[stoken];
            let actionText = "-";
            let actionClass = "";
            if(action) {
                actionText = action.type === 'outing' ? '외출' : '외박';
                actionClass = action.type === 'outing' ? 'text-outing' : 'text-overnight';
                if(action.returned) actionText += " (복귀)";
            }

            masterStudentList.push({
                courseName,
                name: s.name,
                phone: phoneSuffix,
                dormBuilding: dorm.building, // 건물명 분리
                dormRoom: dorm.room !== '미배정' ? `${dorm.room}호` : "미배정", // 호실 분리
                shuttleText,
                shuttleClass,
                actionText,
                actionClass,
                searchKey: (courseName + s.name).toLowerCase()
            });
        });
    });

    renderStudentTable(masterStudentList);
}








function renderStudentTable(list) {
    const tbody = document.getElementById('allStudentTableBody');
    if(!tbody) return;

    if(list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="padding:40px;">데이터가 없습니다.</td></tr>';
        return;
    }

    tbody.innerHTML = list.map(s => {
        // 차량/외출 데이터가 없으면 '-' 표시
        const shuttleHtml = s.shuttleText !== "-" 
            ? `<span class="badge-shuttle ${s.shuttleClass}" style="font-size:9px; padding:2px 3px;">${s.shuttleText}</span>` 
            : `<span style="color:#eee">-</span>`;

        const actionHtml = s.actionText !== "-" 
            ? `<span class="status-action ${s.actionClass}" style="font-size:9px; font-weight:800;">${s.actionText}</span>` 
            : `<span style="color:#eee">-</span>`;

        return `
        <tr>
            <td><div class="course-cell">${s.courseName}</div></td>
            <td>
                <span class="bold-text" style="font-size:11px;">${s.name}</span>
                <span style="color:#cbd5e1; font-size:8.5px;">${s.phone}</span>
            </td>
            <td>
                <span class="blue-text" style="font-size:10px;">${s.dormBuilding}</span>
                <span style="color:#64748b; font-size:9px;">${s.dormRoom}</span>
            </td>
            <td>${shuttleHtml}</td>
            <td>${actionHtml}</td>
        </tr>
        `;
    }).join('');
}








// [신규] 실시간 검색 필터링
function filterAllStudents() {
    const query = document.getElementById('studentSearchInput').value.toLowerCase();
    const filtered = masterStudentList.filter(s => s.searchKey.includes(query));
    renderStudentTable(filtered);
}

// [기존 함수 수정] handleBackNav에 신규 뷰 숨김 추가
const originalHandleBackNav = handleBackNav;
handleBackNav = function() {
    originalHandleBackNav(); // 기존 뒤로가기 로직 실행
    
    // 통합 명단 뷰 전용 정리
    const allStudentView = document.getElementById('allStudentListView');
    if(allStudentView) {
        allStudentView.style.display = "none";
        const searchInput = document.getElementById('studentSearchInput');
        if(searchInput) searchInput.value = ""; // 검색어 초기화
    }
    
    // 다시 메인 화면을 그리도록 강제 호출
    currentRID = "";
    handleRoomSelection();
}





    init();
  </script>


<!-- 퇴교 차량 상세 신청 현황 모달 -->
<div id="shuttleDetailModal" class="setup-modal" style="display:none;">
    <div class="setup-box" style="max-width: 600px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;">
            <h3 style="margin:0; font-size:18px; color:var(--navy-dark);"><i class="fa-solid fa-list-check"></i> 퇴교 차량 상세 신청 내역</h3>
            <i class="fa-solid fa-xmark" style="cursor:pointer; font-size:22px;" onclick="document.getElementById('shuttleDetailModal').style.display='none'; document.body.classList.remove('modal-open');"></i>
        </div>
        <div id="shuttleDetailContent" style="max-height: 500px; overflow-y: auto;">
            <!-- JS에서 내용 생성 -->
        </div>
        <button class="navy-btn" style="margin-top:20px; background:#64748b;" onclick="document.getElementById('shuttleDetailModal').style.display='none'">닫기</button>
    </div>
</div>




<!-- [신규] 센터 접속 QR 팝업 모달 -->
<div id="centerQrModal" class="setup-modal">
    <div class="setup-box" style="max-width: 350px; text-align: center;">
        <h3 style="margin-top:0; color:var(--navy-dark);"><i class="fa-solid fa-link"></i> 행정 시스템 접속 QR</h3>
        <p style="font-size:12px; color:#64748b;">항공기술훈련원 교육운영부 통합 행정 관리</p>
        
        <!-- QR이 생성될 영역 -->
        <div id="centerQrTarget" style="display:flex; justify-content:center; margin: 20px 0; padding:15px; background:#fff; border:1px solid #eee; border-radius:12px;"></div>
        
        <p style="font-size:11px; color:var(--danger); font-weight:800;">※ 관리자 외 유출 금지 (보안주의)</p>
        <button class="navy-btn" style="margin-top:20px; background:#1e293b;" onclick="document.getElementById('centerQrModal').style.display='none'">닫기</button>
    </div>
</div>

<!-- QR 생성 라이브러리 추가 (헤더에 없다면 여기에 추가) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>



</body>
</html>