<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>KAC Coordinator Dashboard</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Font Awesome & Pretendard Font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

  <style>
:root {
      --navy-dark: #0f172a;
      --blue-main: #0ea5e9;
      --blue-deep: #0369a1;
      --green-save: #10b981;
      --bg-cool: #f0f9ff;
      --card-white: #ffffff;
      --text-dark: #1e293b;
      --border-blue: #e0f2fe;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; padding: 0; font-family: 'Pretendard', sans-serif;
      background: #e2e8f0; display: flex; justify-content: center; color: var(--text-dark);
      overflow: hidden; /* 스크롤 방지 */
    }

    .app-container {
      width: 100%; max-width: 600px; height: 100dvh;
      background: var(--bg-cool); position: relative; display: flex; flex-direction: column;
    }

    /* --- 상단바 --- */
    .app-header {
      height: 50px; background: var(--navy-dark); 
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 15px; flex-shrink: 0;
    }
    .header-btn { font-size: 18px; color: #fff; cursor: pointer; border:none; background:none; }
    .header-title { color: #fff; font-size: 15px; font-weight: 800; }

    /* --- 콘텐츠 영역 (스크롤 없이 최적화) --- */
    .app-content { 
      flex: 1; padding: 10px 12px; 
      display: flex; flex-direction: column; gap: 8px;
      overflow-y: auto; /* 내용 많을 때만 내부 스크롤 */
    }

    .section-card {
      background: var(--card-white); border-radius: 15px; padding: 12px;
      border: 1px solid var(--border-blue); box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .section-title {
      font-size: 12px; font-weight: 800; color: var(--blue-deep);
      margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
    }

    .navy-select {
      width: 100%; height: 44px; border-radius: 10px;
      border: 1.5px solid var(--border-blue); background: #f8fafc;
      padding: 0 12px; font-size: 14px; font-weight: 800; color: var(--navy-dark); outline: none;
    }

    .data-date-label { font-size: 10px; color: #64748b; margin-bottom: 6px; font-weight: 700; display: block; }

    /* 셔틀/외출 가로 밀도 높임 */
    .shuttle-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .mini-stat-box { background: #f0f9ff; border-radius: 10px; padding: 8px 4px; text-align: center; }
    .mini-stat-box span { font-size: 10px; color: var(--blue-deep); font-weight: 700; display: block; }
    .mini-stat-box strong { font-size: 16px; font-weight: 900; color: var(--navy-dark); }

    .action-row { display: flex; gap: 8px; }
    .action-box { flex: 1; padding: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
    .outing { background: #fff7ed; color: #9a3412; }
    .overnight { background: #fef2f2; color: #991b1b; }

    /* 공지사항 높이 조절 */
    .notice-area {
      width: 100%; height: 60px; border-radius: 10px;
      border: 1px solid #e2e8f0; padding: 10px;
      font-size: 13px; resize: none; outline: none; margin-bottom: 8px; background: #fafafa;
    }
    .navy-btn { width: 100%; height: 40px; border-radius: 10px; background: var(--blue-main); color: white; border: none; font-weight: 800; font-size: 14px; }
    .navy-btn.green { background: var(--green-save); }

    /* --- 우측 메뉴 (사이드바) --- */
    .side-menu {
      position: absolute; top: 0; right: -280px; width: 280px; height: 100%;
      background: white; z-index: 2000; transition: 0.3s;
      box-shadow: -5px 0 15px rgba(0,0,0,0.1); padding: 20px;
    }
    .side-menu.open { right: 0; }
    .menu-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 1500; display: none;
    }

    /* 하단바 고정 */
    .app-footer {
      height: 40px; background: var(--navy-dark); color: #94a3b8;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 15px; font-size: 10px; flex-shrink: 0;
    }
    .footer-logo img { height: 14px; filter: brightness(0) invert(1); }
  </style>
</head>



<body>
  <div class="app-container">
    <!-- [추가] 햄버거 메뉴용 암막 레이어 -->
    <div id="menuOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1500;" onclick="toggleMenu(false)"></div>

    <!-- [추가] 우측 사이드 메뉴 (QR 관리창) -->
    <div id="sideMenu" style="position:fixed; top:0; right:-280px; width:280px; height:100%; background:white; z-index:2000; transition:0.3s; padding:20px; box-shadow:-5px 0 15px rgba(0,0,0,0.1);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0; font-size:16px; color:#0f172a;">출결 QR 관리</h3>
        <i class="fa-solid fa-xmark" style="cursor:pointer; font-size:20px;" onclick="toggleMenu(false)"></i>
      </div>
      <div style="text-align:center; background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e0f2fe;">
          <input type="file" id="qrFile" accept="image/*" style="display:none;" onchange="handleQRUpload(this)">
          <button class="navy-btn" style="background:#64748b; height:35px; font-size:12px; margin-bottom:10px;" onclick="document.getElementById('qrFile').click()">
              <i class="fa-solid fa-camera"></i> QR 이미지 업로드
          </button>
          <img id="qrPreview" style="width:100%; max-height:150px; object-fit:contain; border:1px solid #ddd; display:none; margin:10px 0;">
          <div id="qrStatus" style="font-size:11px; color:#0ea5e9; font-weight:700;">과정 선택 후 업로드하세요.</div>
      </div>
    </div>

    <header class="app-header">
      <button class="header-btn" onclick="history.back()"><i class="fa-solid fa-chevron-left"></i></button>
      <div class="header-title">Coordinator Dashboard</div>
      <!-- [수정] 햄버거 아이콘에 클릭 이벤트 추가 -->
      <button class="header-btn" onclick="toggleMenu(true)"><i class="fa-solid fa-bars"></i></button>
    </header>

    <main class="app-content">
      <!-- 1라인: 담당 과정 -->
      <div class="section-card">
          <div class="section-title"><i class="fa-solid fa-chalkboard-user"></i> <span id="selectionLabel">전체 과정 운영 현황입니다.</span></div>
          <select id="roomSelect" class="navy-select" onchange="loadRoomSpecificData()">
              <option value="">전체 과정 현황 보기</option>
          </select>
          <div id="leaderDisplay" class="leader-display" style="margin-top:8px; display:none;">
              <i class="fa-solid fa-crown" style="color:#f59e0b; margin-right:6px;"></i> 학생장 : <span id="leaderInfoText">-</span>
          </div>
      </div>

      <!-- 2라인: 셔틀 수요조사 (디자인 컴팩트화) -->
      <div class="section-card">
          <div class="section-title"><i class="fa-solid fa-bus"></i> 셔틀 탑승 현황 (훈련원 발)</div>
          <div class="shuttle-stats">
              <div class="mini-stat-box"><span>오송역</span><strong id="s-osong">0</strong></div>
              <div class="mini-stat-box"><span>터미널</span><strong id="s-term">0</strong></div>
              <div class="mini-stat-box"><span>공항</span><strong id="s-air">0</strong></div>
          </div>
      </div>

      <!-- 3라인: 외출/외박 현황 -->
      <div class="section-card">
          <div class="section-title"><i class="fa-solid fa-user-clock"></i> 외출/외박 현황</div>
          <div class="action-row">
              <div class="action-box outing" style="padding:10px;">
                  <span style="font-weight: 800; font-size:12px;">외출</span>
                  <strong style="font-size: 16px;"><span id="o-cnt">0</span>명</strong>
              </div>
              <div class="action-box overnight" style="padding:10px;">
                  <span style="font-weight: 800; font-size:12px;">외박</span>
                  <strong style="font-size: 16px;"><span id="n-cnt">0</span>명</strong>
              </div>
          </div>
      </div>

      <!-- 4라인: 과정 공지 (과정 선택시에만 활성화) -->
      <div class="section-card" id="courseNoticeCard">
          <div class="section-title"><i class="fa-solid fa-comment-dots"></i> 과정별 공지사항</div>
          <textarea id="courseNotice" class="notice-area" style="height:50px;" placeholder="과정을 선택하면 작성 가능합니다." disabled></textarea>
          <button id="btnCourseNotice" class="navy-btn" style="height:35px; font-size:13px;" onclick="saveCourseNotice()" disabled>과정 공지 업데이트</button>
      </div>

      <!-- 5라인: 센터 전체 공지 -->
      <div class="section-card">
          <div class="section-title"><i class="fa-solid fa-earth-asia"></i> 센터 전체 공지사항</div>
          <textarea id="globalNotice" class="notice-area" style="height:50px;" placeholder="모든 교육생 앱 공지사항에 게시됩니다."></textarea>
          <button class="navy-btn green" style="height:35px; font-size:13px;" onclick="saveGlobalNotice()">전체 공지 업데이트</button>
      </div>
    </main>

    <footer class="app-footer" style="height:40px;">
      <div id="footer-date" style="font-size:10px;">0000년 00월 00일 00:00</div>
      <div class="footer-logo"><img src="logo.png" alt="KAC Logo" style="height:15px;"></div>


<!-- [추가] 상세 명단 확인용 팝업 모달 -->
    <div id="listModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; align-items:center; justify-content:center; padding:20px;">
        <div style="background:white; width:100%; max-width:400px; border-radius:20px; overflow:hidden; display:flex; flex-direction:column; max-height:80vh;">
            <div style="background:#0f172a; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="listModalTitle" style="margin:0; font-size:16px;">상세 명단</h3>
                <i class="fa-solid fa-xmark" style="cursor:pointer;" onclick="closeListModal()"></i>
            </div>
            <div id="listModalContent" style="padding:20px; overflow-y:auto; font-size:14px; line-height:1.8; color:#334155;">
                <!-- 명단이 여기에 표시됨 -->
            </div>
            <button style="width:100%; padding:15px; border:none; background:#f1f5f9; font-weight:bold; cursor:pointer;" onclick="closeListModal()">닫기</button>
        </div>
    </div>


    </footer>
  </div>

  <script src="config.js"></script>
  <script>
// [설정] 인증 체크
    if(sessionStorage.getItem('kac_portal_auth') !== 'coord') {
        alert("정상적인 접근이 아닙니다.");
        location.replace('portal.html');
    }

    let globalAllData = {}; // 전체 데이터를 담아둘 변수

    // [기능] 메뉴 및 모달 제어
    function toggleMenu(isOpen) {
        document.getElementById('sideMenu').style.right = isOpen ? '0' : '-280px';
        document.getElementById('menuOverlay').style.display = isOpen ? 'block' : 'none';
    }

    function closeListModal() {
        document.getElementById('listModal').style.display = 'none';
    }

    // [기능] 시계 실행
    function runClock() {
        const now = new Date();
        document.getElementById('footer-date').innerText = 
            `${now.getFullYear()}년 ${now.getMonth()+1}월 ${now.getDate()}일 ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    }
    setInterval(runClock, 1000); runClock();

    // [기능] 과정 리스트 초기화 및 실시간 감시
    function initActiveRoomList() {
        firebase.database().ref('courses').on('value', snap => {
            const data = snap.val() || {};
            globalAllData = data; // 데이터 저장
            const select = document.getElementById('roomSelect');
            const savedVal = select.value;
            
            select.innerHTML = '<option value="">전체 과정 현황 보기</option>';
            Object.keys(data).forEach(rid => {
                const room = data[rid];
                if (room.status && room.status.roomStatus === 'active') {
                    const cName = room.settings?.courseName || `ROOM ${rid}`;
                    const opt = document.createElement('option');
                    opt.value = rid; opt.innerText = cName;
                    if(rid === savedVal) opt.selected = true;
                    select.appendChild(opt);
                }
            });
            
            // 현재 선택된 모드에 따라 화면 업데이트
            if(!select.value) loadTotalStatus();
            else loadRoomSpecificData();
        });
    }

    // [로직] 1. 전체 과정 현황 합산 (미선택 시)
    function loadTotalStatus() {
        document.getElementById('selectionLabel').innerText = "전체 과정 운영 현황입니다.";
        document.getElementById('leaderDisplay').style.display = "none";
        document.getElementById('courseNotice').disabled = true;
        document.getElementById('btnCourseNotice').disabled = true;
        document.getElementById('courseNotice').value = "";
        document.getElementById('courseNotice').placeholder = "과정을 선택하면 작성 가능합니다.";

        updateStats(globalAllData);
    }

    // [로직] 2. 특정 과정 상세 조회 (선택 시)
    function loadRoomSpecificData() {
        const rid = document.getElementById('roomSelect').value;
        if(!rid) { loadTotalStatus(); return; }

        const roomData = globalAllData[rid] || {};
        const profName = roomData.status?.professorName || "미지정";
        
        document.getElementById('selectionLabel').innerHTML = `<span style="color:#0ea5e9;">[Room ${rid}]</span> ${profName} 교수님 과정`;
        document.getElementById('courseNotice').disabled = false;
        document.getElementById('btnCourseNotice').disabled = false;
        document.getElementById('courseNotice').value = roomData.coordNotice || "";
        document.getElementById('courseNotice').placeholder = "수강생 앱에 표시될 공지를 입력하세요.";

        // 학생장 표시
        const students = roomData.students || {};
        const leader = Object.values(students).find(st => st.isLeader === true);
        document.getElementById('leaderInfoText').innerText = leader ? `${leader.name} (${leader.phone || '연락처 미등록'})` : "지정된 학생장 없음";
        document.getElementById('leaderDisplay').style.display = "block";

        // QR 프리뷰 업데이트
        const preview = document.getElementById('qrPreview');
        if (roomData.attendanceQR) {
            preview.src = roomData.attendanceQR;
            preview.style.display = "block";
            document.getElementById('qrStatus').innerText = "QR 등록됨";
        } else {
            preview.style.display = "none";
            document.getElementById('qrStatus').innerText = "QR 없음";
        }

        // 해당 과정 데이터만 추출해서 통계 업데이트
        const singleData = {}; singleData[rid] = roomData;
        updateStats(singleData);
    }

    // [공통] 통계 숫자 업데이트 및 클릭 이벤트 연결
    function updateStats(dataScope) {
        let osong = [], term = [], air = [];
        let outing = [], overnight = [];
        const today = getTodayString();

        Object.keys(dataScope).forEach(rid => {
            const room = dataScope[rid];
            if(room.shuttle) {
                if(room.shuttle.osong) osong.push(...Object.values(room.shuttle.osong));
                if(room.shuttle.terminal) term.push(...Object.values(room.shuttle.terminal));
                if(room.shuttle.airport) air.push(...Object.values(room.shuttle.airport));
            }
            if(room.admin_actions && room.admin_actions[today]) {
                Object.values(room.admin_actions[today]).forEach(v => {
                    if(v.type === 'outing') outing.push(`${v.name}(Room ${rid})`);
                    if(v.type === 'overnight') overnight.push(`${v.name}(Room ${rid})`);
                });
            }
        });

        // 숫자 표시 및 클릭 시 명단 팝업 연결
        renderStatItem('s-osong', osong, "오송역 신청자");
        renderStatItem('s-term', term, "터미널 신청자");
        renderStatItem('s-air', air, "공항 신청자");
        renderStatItem('o-cnt', outing, "오늘 외출자");
        renderStatItem('n-cnt', overnight, "오늘 외박자");
    }

    function renderStatItem(id, list, title) {
        const el = document.getElementById(id);
        el.innerText = list.length;
        el.parentElement.style.cursor = "pointer";
        el.parentElement.onclick = () => {
            if(list.length === 0) return;
            document.getElementById('listModalTitle').innerText = `${title} (${list.length}명)`;
            document.getElementById('listModalContent').innerHTML = list.map((name, i) => `${i+1}. ${name}`).join('<br>');
            document.getElementById('listModal').style.display = 'flex';
        };
    }

    // [저장] 과정 공지 및 전체 공지
    function saveCourseNotice() {
        const rid = document.getElementById('roomSelect').value;
        const msg = document.getElementById('courseNotice').value;
        if(!rid) return;
        firebase.database().ref(`courses/${rid}/coordNotice`).set(msg).then(() => alert("✅ 과정 공지 저장완료"));
    }

    function saveGlobalNotice() {
        const msg = document.getElementById('globalNotice').value;
        firebase.database().ref(`system/globalNotice`).set(msg).then(() => alert("✅ 전체 공지 저장완료"));
    }

    // [기능] QR 업로드
    async function handleQRUpload(input) {
        const rid = document.getElementById('roomSelect').value;
        if(!rid) return alert("과정을 먼저 선택하세요.");
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            await firebase.database().ref(`courses/${rid}/attendanceQR`).set(e.target.result);
            alert("QR 업로드 완료");
            toggleMenu(false);
        };
        reader.readAsDataURL(file);
    }

    initActiveRoomList();
    firebase.database().ref(`system/globalNotice`).once('value', s => {
        document.getElementById('globalNotice').value = s.val() || "";
    });
  </script>
</body>
</html>