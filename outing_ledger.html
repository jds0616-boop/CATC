<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>외출·외박 신청서(대장)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css");
        * { box-sizing: border-box; font-family: "Pretendard", sans-serif; }
        body { margin: 0; padding: 0; background: #f1f5f9; }

        .page {
            width: 297mm;
            min-height: 210mm;
            padding: 10mm 15mm 10mm 30mm;
            margin: 10mm auto;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            position: relative;
        }

        /* 펀치 구멍 가이드 */
        .punch-hole {
            position: absolute;
            left: 10mm;
            width: 6mm;
            height: 6mm;
            background: #cbd5e1;
            border-radius: 50%;
        }
        .hole-1 { top: 70mm; }
        .hole-2 { bottom: 70mm; }

        .header-section { margin-bottom: 15px; }
        .title { text-align: center; font-size: 32px; font-weight: 900; letter-spacing: 10px; margin: 0; }
        .course-title { text-align: right; font-size: 18px; font-weight: bold; margin-top: 10px; border-bottom: 2px solid #000; padding-bottom: 5px; }

        table { width: 100%; border-collapse: collapse; border: 2.5px solid #000; table-layout: fixed; }
        th, td { border: 1px solid #000; text-align: center; vertical-align: middle; padding: 2px; }
        th { background: #f1f5f9; font-size: 14px; font-weight: 800; height: 45px; }
        
        /* [중요] 행 높이 고정 및 가운데 정렬 */
        td { height: 60px; font-size: 15px; word-break: break-all; }

        /* 소속 등이 길 경우 글자 크기 축소 */
        .shrink-text {
            display: block;
            width: 100%;
            font-size: 13px; /* 기본보다 작게 시작 */
            line-height: 1.2;
        }

        .name-cell { font-weight: 900; font-size: 17px; }
        .stamp-img { height: 50px; width: auto; mix-blend-mode: multiply; }
        .confirm-text { font-size: 13px; font-weight: bold; color: #333; }

        .print-btn {
            position: fixed; top: 20px; right: 20px;
            padding: 15px 30px; background: #003366; color: white;
            border: none; border-radius: 8px; cursor: pointer; font-weight: 900; z-index: 1000;
        }

        @media print {
            body { background: white; }
            .page { margin: 0; box-shadow: none; width: 100%; }
            .print-btn { display: none; }
            @page { size: A4 landscape; margin: 0; }
        }
    </style>
</head>
<body>
    <button class="print-btn" onclick="window.print()">대장 인쇄하기</button>

    <div class="page">
        <div class="punch-hole hole-1"></div>
        <div class="punch-hole hole-2"></div>

        <div class="header-section">
            <h1 class="title">외출 (외박) 신청서</h1>
            <div class="course-title">◎ 과정명 : <span id="displayCourseName">-</span></div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 8%;">일자</th>
                    <th style="width: 13%;">시간<br>(외출/복귀)</th>
                    <th style="width: 12%;">소속</th>
                    <th style="width: 10%;">성명</th>
                    <th style="width: 12%;">행선지</th>
                    <th style="width: 15%;">전화번호</th>
                    <th style="width: 20%;">사유</th>
                    <th style="width: 10%;">확인<br>(담임/담당)</th>
                </tr>
            </thead>
            <tbody id="ledgerBody"></tbody>
        </table>
    </div>

    <script src="config.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const room = params.get('room');
        const db = firebase.database();

        async function init() {
            if(!room) return;
            const setSnap = await db.ref(`courses/${room}/settings`).once('value');
            document.getElementById('displayCourseName').innerText = setSnap.val()?.courseName || room;

            db.ref(`courses/${room}/admin_actions`).on('value', snap => {
                const allData = snap.val() || {};
                const body = document.getElementById('ledgerBody');
                body.innerHTML = "";

                let list = [];
                Object.keys(allData).forEach(date => {
                    Object.values(allData[date]).forEach(item => { list.push({ date, ...item }); });
                });

                list.sort((a,b) => a.timestamp - b.timestamp); // 시간순 정렬





// [수정] 시간 표시 로직: 출발/복귀 두 줄로 분리
list.forEach(a => {
    const tr = document.createElement('tr');
    
    // 시간 칸 디자인 가공
    let startTime = a.startTime || "-";
    let endTime = a.endTime || "-";
    
    // 외박일 경우 복귀 날짜 표시 추가
    if(a.type === 'overnight' && a.returnDate) {
        const retDay = a.returnDate.substring(8,10);
        endTime = `익일(${retDay}일) ${endTime}`;
    }

    const timeHtml = `
        <div style="font-size:12px; font-weight:800; color:#1e3a8a;">출발: ${startTime}</div>
        <div style="margin: 3px 5px; border-top: 1px dashed #cbd5e1;"></div>
        <div style="font-size:12px; font-weight:800; color:#b91c1c;">복귀: ${endTime}</div>
    `;

    // 서명 표시 로직
    let confirmDisplay = "";
    if(a.confirmedBySign) {
        confirmDisplay = `<img src="${a.confirmedBySign}" class="stamp-img">`;
    } else if(a.confirmedBy) {
        confirmDisplay = `<span class="confirm-text">${a.confirmedBy}</span>`;
    }

    tr.innerHTML = `
        <td>${a.date.substring(5)}</td>
        <td style="padding: 5px 2px;">${timeHtml}</td>
        <td><span class="shrink-text">${a.dept || ""}</span></td>
        <td class="name-cell">${a.name}</td>
        <td>${a.destination || ""}</td>
        <td style="font-size:13px;">${a.phone || ""}</td>
        <td><span class="shrink-text">${a.reason || ""}</span></td>
        <td>${confirmDisplay}</td>
    `;
    body.appendChild(tr);
});





                // 빈 줄 10줄 유지
                for(let i=list.length; i<10; i++) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = "<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>";
                    body.appendChild(tr);
                }
            });
        }
        init();
    </script>
</body>
</html>