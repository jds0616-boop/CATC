<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>외출·외박 신청서(대장) 출력</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css");
        * { box-sizing: border-box; font-family: "Pretendard", sans-serif; }
        body { margin: 0; padding: 0; background: #f1f5f9; }

        /* A4 가로 설정 */
        .page {
            width: 297mm;
            min-height: 210mm;
            padding: 15mm 15mm 10mm 25mm; /* 좌측에 철할 공간 25mm 확보 */
            margin: 10mm auto;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            position: relative;
        }

        /* 펀치 구멍 가이드 (회색 동그라미) */
        .punch-guide {
            position: absolute;
            left: 8mm; /* 가장자리에서 8mm 안쪽 */
            width: 6mm;
            height: 6mm;
            background: #e2e8f0;
            border-radius: 50%;
        }
        .punch-top { top: 70mm; }
        .punch-bottom { bottom: 70mm; }

        .title-area { text-align: center; margin-bottom: 25px; }
        .title-area h1 { font-size: 32px; font-weight: 900; text-decoration: underline; margin: 0; letter-spacing: 5px; }
        
        .info-header { 
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 10px; font-size: 16px; font-weight: bold; 
        }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; border: 2px solid #000; }
        th, td { border: 1px solid #000; padding: 8px 4px; text-align: center; font-size: 14px; }
        th { background: #f1f5f9; font-weight: 800; height: 50px; }
        td { height: 55px; word-break: break-all; line-height: 1.3; }

        /* 인쇄 시 버튼 숨기기 및 여백 조정 */
        .print-btn {
            position: fixed; top: 20px; right: 20px;
            padding: 12px 25px; background: #003366; color: white;
            border: none; border-radius: 8px; cursor: pointer; font-weight: 900; z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        @media print {
            body { background: white; }
            .page { margin: 0; box-shadow: none; width: 100%; }
            .print-btn { display: none; }
            @page { size: A4 landscape; margin: 0; }
        }
    </style>
</head>
<body>
    <button class="print-btn" onclick="window.print()">대장 인쇄하기</button>

    <div class="page">
        <!-- 펀치 가이드 동그라미 -->
        <div class="punch-guide punch-top"></div>
        <div class="punch-guide punch-bottom"></div>

        <div class="title-area">
            <h1>외출 (외박) 신청서</h1>
        </div>

        <div class="info-header">
            <div>◎ 과정명 : <span id="displayCourseName" style="text-decoration: underline;">-</span></div>
            <div style="font-size: 14px;">※ 담당자 승인(날인) 후 외출 가능</div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 7%;">일자</th>
                    <th style="width: 13%;">시간<br>(외출/복귀)</th>
                    <th style="width: 12%;">소속</th>
                    <th style="width: 10%;">성명</th>
                    <th style="width: 15%;">행선지</th>
                    <th style="width: 13%;">전화번호</th>
                    <th style="width: 20%;">사유</th>
                    <th style="width: 10%;">확인<br>(담임/담당)</th>
                </tr>
            </thead>
            <tbody id="ledgerBody">
                <!-- 데이터가 여기에 자동으로 추가됩니다 -->
            </tbody>
        </table>
    </div>

    <script src="config.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const room = params.get('room');
        const db = firebase.database();

        async function initLedger() {
            if(!room) return;

            // 1. 과정명 가져오기
            const setSnap = await db.ref(`courses/${room}/settings`).once('value');
            if(setSnap.exists()) {
                document.getElementById('displayCourseName').innerText = setSnap.val().courseName || room;
            }

            // 2. 외출외박 데이터 실시간 로드
            db.ref(`courses/${room}/admin_actions`).on('value', snap => {
                const allData = snap.val() || {};
                const body = document.getElementById('ledgerBody');
                body.innerHTML = "";

                // 날짜순으로 정렬
                const dates = Object.keys(allData).sort();
                
                let rowCount = 0;
                dates.forEach(date => {
                    const dailyActions = allData[date];
                    Object.values(dailyActions).forEach(action => {
                        const tr = document.createElement('tr');
                        
                        // 관리자가 찍은 도장(이미지)이 있으면 표시, 없으면 공란
                        const stamp = action.confirmedBySign 
                            ? `<img src="${action.confirmedBySign}" style="height:45px; mix-blend-mode:multiply;">` 
                            : "";

                        // 날짜에서 년도 빼고 월-일만 표시 (예: 01-20)
                        const shortDate = date.substring(5);

                        tr.innerHTML = `
                            <td>${shortDate}</td>
                            <td>${action.timeRange || "-"}</td>
                            <td>${action.dept || "-"}</td>
                            <td style="font-weight:900;">${action.name}</td>
                            <td>${action.destination || "-"}</td>
                            <td style="font-size:12px;">${action.phone || "-"}</td>
                            <td style="text-align:left; padding-left:10px;">${action.reason || "-"}</td>
                            <td>${stamp}</td>
                        `;
                        body.appendChild(tr);
                        rowCount++;
                    });
                });

                // 양식을 위해 빈 줄 12줄까지 채우기
                for(let i = rowCount; i < 12; i++) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = "<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>";
                    body.appendChild(tr);
                }
            });
        }

        initLedger();
    </script>
</body>
</html>