<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>í•­ê³µê¸°ìˆ í›ˆë ¨ì› ì°¨ëŸ‰ì§€ì› ì‹œìŠ¤í…œ</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
<style>
    :root {
      --navy: #0f172a; --blue: #0ea5e9; --blue-deep: #0369a1;
      --bg: #f1f5f9; --card: #ffffff; --border: #e2e8f0;
      --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
      --color-mon: #3b82f6; --color-tue: #10b981; --color-wed: #f59e0b; --color-thu: #8b5cf6; --color-fri: #ec4899;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
    body { margin: 0; padding: 0; background: #cfd8e3; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }
    
    .app-container { width: 100%; max-width: 600px; height: 100%; background: var(--bg); display: flex; flex-direction: column; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.2); }
    
    /* ìƒë‹¨ë°” */
    .app-header { height: 60px; background: var(--navy); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 2px solid var(--blue); flex-shrink: 0; }
    .header-title { font-size: 17px; font-weight: 900; color: #fff; letter-spacing: -0.5px; }
    .sync-status { font-size: 11px; color: var(--success); font-weight: 800; display: flex; align-items: center; gap: 5px; }

    /* íƒ­ ë°” */
    .tab-bar { display: flex; background: #fff; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .tab-btn { flex: 1; padding: 16px 0; border: none; background: none; font-size: 14px; font-weight: 800; color: #94a3b8; cursor: pointer; border-bottom: 3px solid transparent; }
    .tab-btn.active { color: var(--blue-deep); border-bottom-color: var(--blue); background: #f8fafc; }

    .app-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }

    /* 1. í–‰ì • í”Œë«í¼ ìŠ¤íƒ€ì¼ì˜ 2x2 ìƒí™©íŒ (ê·¸ë¼ë°ì´ì…˜ ì ìš©) */
    .global-status-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 10px; 
        margin-bottom: 5px;
    }
    .stat-card-new {
        background: linear-gradient(135deg, #003366 0%, #0055aa 100%);
        border-radius: 18px;
        padding: 15px 10px;
        color: white;
        text-align: center;
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .stat-label { font-size: 11px; font-weight: 700; opacity: 0.8; margin-bottom: 5px; }
    .stat-val { font-size: 26px; font-weight: 900; line-height: 1; color: #60a5fa; }
    .stat-val.orange { color: #fbbf24; }
    .stat-val.green { color: #4ade80; }
    .stat-val small { font-size: 14px; margin-left: 2px; font-weight: 700; }

    /* 2. ê²©ìí˜• ë¦¬ìŠ¤íŠ¸ (ì„¸ë¡œì¤„ ë° ì¤‘ì•™ ì •ë ¬ ê°•í™”) */
    .list-wrapper { background: #fff; border-radius: 12px; border: 1.5px solid #e2e8f0; overflow: hidden; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

/* í‘œì˜ ì—´ ë„ˆë¹„ë¥¼ ë¹„ìœ¨ë¡œ ì¡°ì •í•˜ì—¬ ì¹˜ìš°ì¹¨ í•´ê²° */
    .list-header, .course-row {
      display: grid;
      /* ê³¼ì •ëª…(1.5) : ì´ì›(0.6) : ì¶œë°œì‹œê°„(1.8) : ê³µì§€(0.6) ë¹„ìœ¨ë¡œ ë°°ë¶„ */
      grid-template-columns: 1.5fr 0.6fr 1.8fr 0.6fr; 
      align-items: center;
      text-align: center;
      width: 100%;
    }

    .list-header { background: #f1f5f9; border-bottom: 2px solid #cbd5e1; font-size: 11px; font-weight: 900; color: #475569; }
    .course-row { border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; }
    .course-row:last-child { border-bottom: none; }
    .course-row:active { background: #f8fafc; }

    /* ê° ì¹¸ì˜ ì„¸ë¡œì¤„ê³¼ ì •ë ¬ ë³´ì • */
    .t-cell {
      padding: 12px 5px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      border-right: 1px solid #f1f5f9;
      overflow: hidden;
    }
    .t-cell:last-child { border-right: none; }





    /* ê³¼ì •ëª… ì…€ì˜ í…ìŠ¤íŠ¸ê°€ ì´ì› ìª½(ì˜¤ë¥¸ìª½)ìœ¼ë¡œ ë„ˆë¬´ ë¶™ì§€ ì•Šê²Œ ì—¬ë°±ì„ ì‚´ì§ ì¤ë‹ˆë‹¤. */
   .t-cell.name { 
      justify-content: center; 
      font-size: 14px; 
      font-weight: 800; 
      color: #1e293b; 
      padding: 0 10px;
    }

    /* ì´ì› ì…€ì˜ ë„ˆë¹„ë¥¼ ë§ì¶¤ */
    .t-cell.count {
      font-size: 13px;
      font-weight: 900;
      color: #0ea5e9;
      border-right: 1px solid #e2e8f0; /* ì„¸ë¡œì„ ì´ ëª…í™•íˆ ë³´ì´ê²Œ í•¨ */
    }

    /* ì¶œë°œì‹œê°„ ë²„íŠ¼ ì˜ì—­ */
    .t-cell.btns { 
      gap: 4px; 
      padding: 8px 6px; 
      width: 100%;
    }
    .mini-btn {
      height: 34px; flex: 1; border-radius: 6px; border: 1px solid #e2e8f0;
      background: #fff; font-size: 11px; font-weight: 800; color: #64748b; cursor: pointer;
    }
    .mini-btn.active { background: #0f172a !important; color: #fff !important; border-color: #0f172a !important; }

    /* ê³µì§€ì—¬ë¶€ ì•„ì´ì½˜ */
    .t-cell.status { font-size: 18px; }
    .notice-on { color: #10b981; } 
    .notice-off { color: #cbd5e1; }

    /* ìƒì„¸ íŒì—… ë‚´ë¶€ ìŠ¤íƒ€ì¼ */
    .popup-group { margin-bottom: 20px; text-align: left; }
    .group-title { 
      font-size: 14px; font-weight: 900; color: var(--blue-deep); 
      padding-bottom: 5px; border-bottom: 2px solid #f1f5f9; margin-bottom: 10px;
      display: flex; justify-content: space-between;
    }
    .group-item { 
      display: flex; justify-content: space-between; padding: 8px 0; 
      border-bottom: 1px dashed #f1f5f9; font-size: 14px; 
    }
    .p-name { font-weight: 800; color: #1e293b; }
    .p-phone { color: #64748b; font-weight: 600; font-size: 13px; }

    /* ì¼ì •í‘œ ìŠ¤íƒ€ì¼ */
    .week-nav { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 10px; background: #fff; padding: 12px; border-radius: 12px; border: 1px solid var(--border); }
    .nav-arrow { font-size: 24px; color: var(--blue-deep); cursor: pointer; }
    .week-label { font-size: 15px; font-weight: 900; color: var(--navy); }
    .schedule-wrapper { background: #fff; border: 1px solid #000; border-radius: 8px; overflow: hidden; }
    .schedule-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .schedule-table th, .schedule-table td { border: 1px solid #ddd; text-align: center; height: 50px; font-size: 9px; vertical-align: middle; padding: 2px; }
    .schedule-table th { background: #f1f5f9; font-weight: 900; height: 45px; color: var(--navy); border-bottom: 2px solid var(--navy); font-size: 10px; }
    .time-col { width: 45px; background: #f1f5f9 !important; font-weight: 800; border-right: 2px solid var(--navy) !important; font-size: 11px !important; }


/* ìº¡ì³ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .capture-btn {
      width: 100%; height: 45px; background: #fff; border: 2px solid var(--blue);
      color: var(--blue-deep); border-radius: 12px; font-weight: 800; cursor: pointer;
      margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: 0.2s; font-size: 14px;
    }
    .capture-btn:active { background: var(--blue); color: #fff; }
    .capture-btn i { font-size: 18px; }



    
    .cell-event { border-radius: 4px; padding: 4px 2px; height: 100%; display: flex; flex-direction: column; justify-content: center; font-weight: 800; line-height: 1.2; }
    .block-entry { background: #eff6ff; color: #1e40af; border: 1px solid #1e40af; }
    .block-prof { background: #fae8ff; color: #a21caf; border: 1px solid #a21caf; }
    .block-departure { background: #ecfdf5; color: #047857; border: 1px solid #047857; }
    .block-off { background: #fee2e2; color: #ef4444; }

 

/* ì‹¤ì‹œê°„ ìˆ˜ì†¡ í†¡ ë°°ê²½ */
    .chat-container {
      background: #abc1d1; /* ì¹´í†¡ ë°°ê²½ìƒ‰ */
      display: flex; flex-direction: column; gap: 15px;
      padding: 15px; border-radius: 12px; min-height: 400px;
    }

    /* ë‚ ì§œ êµ¬ë¶„ì„  */
    .chat-date-line {
      text-align: center; margin: 10px 0;
    }
    .chat-date-line span {
      background: rgba(0,0,0,0.2); color: #fff;
      padding: 4px 12px; border-radius: 20px; font-size: 11px;
    }

    /* ë§í’ì„  ê³µí†µ */
    .chat-bubble { max-width: 85%; position: relative; display: flex; flex-direction: column; margin-bottom: 5px; }
    
    /* ìš´ì˜ë¶€ ìš”ì²­ (ì™¼ìª½) */
    .chat-left { align-self: flex-start; }
    .bubble-content {
      background: #fff; padding: 12px; border-radius: 0 12px 12px 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 14px; line-height: 1.5;
    }

    /* ìŠ¹ì¸ ì‹œ ê¸°ì‚¬ë‹˜ ë‹µë³€ (ì˜¤ë¥¸ìª½) */
    .chat-right { align-self: flex-end; }
    .bubble-reply {
      background: #fee500; padding: 10px; border-radius: 12px 0 12px 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 13px; font-weight: 800;
    }

    /* í†¡ ì–‘ì‹ ë‚´ë¶€ í…ìŠ¤íŠ¸ */
    .talk-header { color: #888; font-size: 12px; margin-bottom: 5px; font-weight: 800; }
    .talk-body { color: #1e293b; font-weight: 700; white-space: pre-line; }
    .talk-link { color: #3b82f6; text-decoration: underline; margin: 5px 0; display: block; }
    
    /* í†¡ í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ */
    .talk-actions {
      display: flex; gap: 8px; margin-top: 10px; padding-top: 10px;
      border-top: 1px dashed #eee;
    }
    .talk-btn {
      flex: 1; height: 36px; border-radius: 8px; border: none;
      font-weight: 900; font-size: 12px; cursor: pointer;
    }
    .btn-approve { background: #3b82f6; color: #fff; }
    .btn-reject { background: #f1f5f9; color: #ef4444; }

    .chat-time { font-size: 10px; color: #666; margin-top: 4px; align-self: flex-end; }








/* ê¸°ì¡´ í•˜ë‹¨ë°” ìŠ¤íƒ€ì¼ ì‚­ì œ í›„ í™ˆ ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§Œ ìœ ì§€/ìˆ˜ì • */
    .footer-home { 
      width: 56px; height: 56px; 
      background: var(--blue); color: #fff; 
      border-radius: 50%; 
      display: none; align-items: center; justify-content: center; 
      font-size: 24px; 
      position: absolute; 
      bottom: 30px; /* ë°”ë‹¥ì—ì„œ 30px ë„ì›€ */
      left: 50%; transform: translateX(-50%); 
      box-shadow: 0 8px 20px rgba(0,0,0,0.3); 
      cursor: pointer; 
      border: 4px solid #fff; /* í°ìƒ‰ í…Œë‘ë¦¬ë¡œ ê°•ì¡° */
      z-index: 10000; 
      transition: 0.2s; 
    }
    .footer-home:active { transform: translateX(-50%) scale(0.9); }

    /* ëª¨ë‹¬ ë ˆì´ì•„ì›ƒ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
    .modal-box { background: #fff; width: 100%; max-width: 440px; border-radius: 28px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); text-align: center; }
    .modal-title { font-size: 20px; font-weight: 900; color: var(--navy); margin-bottom: 15px; }
    .modal-desc { font-size: 15px; color: #475569; line-height: 1.6; margin-bottom: 25px; text-align: left; }
    .m-btn { flex: 1; height: 52px; border-radius: 14px; border: none; font-weight: 900; font-size: 16px; cursor: pointer; }
    .m-btn.ok { background: var(--blue); color: #fff; }
    .m-btn.no { background: #f1f5f9; color: #64748b; }

/* íŒì—… ë‚´ ì´ë¦„ ë°”ë‘‘íŒ ê·¸ë¦¬ë“œ ì„¤ì • */
    .group-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr); /* 5ì—´ ì •ë ¬ */
      gap: 6px; /* ì´ë¦„ ì¹¸ ì‚¬ì´ ê°„ê²© */
      padding: 10px 0;
    }

    /* ê°œë³„ ì´ë¦„ ì¹¸ ìŠ¤íƒ€ì¼ */
    .grid-name-item {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 10px 2px;
      font-size: 13px;
      font-weight: 800;
      color: #1e293b;
      text-align: center;
      white-space: nowrap; /* ì´ë¦„ ì˜ë¦¼ ë°©ì§€ */
      cursor: pointer;
    }
    .grid-name-item:active { background: #e2e8f0; }


/* ì§€ë‚œ ì¼ì • ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
    .chat-bubble.is-past {
      filter: grayscale(1); /* í‘ë°± ì²˜ë¦¬ */
      opacity: 0.5; /* íˆ¬ëª…í•˜ê²Œ */
      pointer-events: none; /* í´ë¦­ ë°©ì§€ */
    }


/* ë§í’ì„  ë‚´ ê°œë³„ ì¼ì • í–‰ */
    .talk-leg-item {
      padding: 8px 0;
      border-bottom: 1px dashed #eee;
    }
    .talk-leg-item:last-child { border-bottom: none; }
    
    /* ê°œë³„ ì¼ì • ë‚´ ë²„íŠ¼ ë ˆì´ì•„ì›ƒ */
    .leg-actions {
      display: flex; gap: 5px; margin-top: 5px;
    }
    .mini-talk-btn {
      flex: 1; height: 30px; border-radius: 6px; border: 1px solid #e2e8f0;
      background: #fff; font-size: 11px; font-weight: 800; cursor: pointer;
    }
    .mini-talk-btn.ok { color: #3b82f6; border-color: #dbeafe; }
    .mini-talk-btn.no { color: #ef4444; border-color: #fecaca; }
    
    /* ìŠ¹ì¸ëœ í•­ëª© í‘œì‹œ */
    .leg-status-done {
      font-size: 11px; color: #10b981; font-weight: 900; margin-top: 5px;
    }

    /* ê³¼ê±° ì¼ì • ì²˜ë¦¬ */
    .leg-is-past { opacity: 0.5; filter: grayscale(0.8); }








  </style>






<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>












<div class="app-container">
  <header class="app-header">
    <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼: íƒ­ì— ë”°ë¼ Portal ë˜ëŠ” Backìœ¼ë¡œ ê¸€ìê°€ ë°”ë€ë‹ˆë‹¤ -->
    <div id="back-btn-area" style="min-width:60px; color:#fff; font-size:18px; font-weight:900; cursor:pointer; display:flex; align-items:center;" onclick="handleBack()">
        <span id="back-btn-text">&lt;&lt;</span>
    </div>
    <div class="header-title">í•­ê³µê¸°ìˆ í›ˆë ¨ì› ì°¨ëŸ‰ì§€ì› ì‹œìŠ¤í…œ</div>
    <div class="sync-status"><i class="fa-solid fa-sync fa-spin"></i> ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</div>
  </header>

  <div class="tab-bar">
    <button id="tab0" class="tab-btn active" onclick="switchTab(0)">ì¢…í•© ì¼ì •í‘œ</button>
    <button id="tab1" class="tab-btn" onclick="switchTab(1)">ê°•ì‚¬ ìˆ˜ì†¡ ë¦¬ìŠ¤íŠ¸</button>
    <button id="tab2" class="tab-btn" onclick="switchTab(2)">êµìœ¡ìƒ í‡´êµ ê´€ë¦¬</button>
  </div>

  <main class="app-content" id="main-content">
    <!-- íƒ­ 0: ì¢…í•© ì¼ì •í‘œ -->
    <div id="view-0" style="display: block;">
      
      <!-- [ìˆ˜ì •] ìº¡ì³ë  ì˜ì—­ì„ divë¡œ ê°ì‹¸ê³  idë¥¼ ë¶€ì—¬í•¨ -->
      <div id="capture-area" style="padding: 10px; background: var(--bg); border-radius: 12px;">
        <div class="week-nav">
          <i class="fa-solid fa-circle-chevron-left nav-arrow" onclick="changeWeek(-1)"></i>
          <div class="week-label" id="week-range">ë‚ ì§œ ê³„ì‚° ì¤‘...</div>
          <i class="fa-solid fa-circle-chevron-right nav-arrow" onclick="changeWeek(1)"></i>
        </div>
        <div class="schedule-wrapper">
          <table class="schedule-table">
            <thead id="sched-head"></thead>
            <tbody id="sched-body"></tbody>
          </table>
        </div>
      </div>

      <!-- [ì¶”ê°€] ìº¡ì³ ì‹¤í–‰ ë²„íŠ¼ -->
      <button class="capture-btn" onclick="captureSchedule()">
        <i class="fa-solid fa-camera"></i> í˜„ì¬ ì¼ì •í‘œ ì´ë¯¸ì§€ ì €ì¥ (ìº¡ì³)
      </button>

      <div style="margin-top:8px; font-size:10px; color:#64748b; text-align:right;">* ìš”ì¼ í´ë¦­: ìš´í–‰ì¤‘ë‹¨ | ì¹¸ í´ë¦­: ìƒì„¸ì •ë³´</div>
    </div>

    <!-- íƒ­ 1: ê°•ì‚¬ ìˆ˜ì†¡ -->
    <div id="view-1" style="display: none;">
      <div id="new-request-container"></div> 
      <div id="all-request-container"></div> 
    </div>

    <!-- íƒ­ 2: êµìœ¡ìƒ í‡´êµ -->
    <div id="view-2" style="display: none;">
      <!-- ìƒí™©íŒì„ ì‚­ì œí•˜ê³  ë¦¬ìŠ¤íŠ¸ë§Œ ë‚¨ê²¼ìŠµë‹ˆë‹¤ -->
      <div id="trainee-course-list"></div>
    </div>
  </main>





















  <!-- í•˜ë‹¨ë°”ëŠ” ì§€ìš°ê³ , ë™ë™ ë–  ìˆëŠ” í™ˆ ë²„íŠ¼ë§Œ ë‚¨ê¹ë‹ˆë‹¤ -->
  <div class="footer-home" id="floating-home" onclick="switchTab(0)"><i class="fa-solid fa-house"></i></div>
</div>

<!-- ê³µìš© ëª¨ë‹¬ -->
<div id="detailModal" class="modal-overlay" onclick="if(event.target==this) closeModal('detailModal')">
  <div class="modal-box">
    <div class="modal-title" id="m-title">ì •ë³´</div>
    <div id="m-content" class="modal-desc"></div>
    <div class="modal-btn-group">
        <button class="m-btn no" onclick="closeModal('detailModal')">ë‹«ê¸°</button>
        <button id="m-call-btn" class="m-btn ok" style="display:none;"><i class="fa-solid fa-phone"></i> ì „í™”í•˜ê¸°</button>
    </div>
  </div>
</div>

<div id="confirmModal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-title" id="c-title">í™•ì¸</div>
    <div id="c-desc" class="modal-desc">ë‚´ìš©</div>
    <div class="modal-btn-group">
        <button class="m-btn no" onclick="closeModal('confirmModal')">ì·¨ì†Œ</button>
        <button class="m-btn ok" id="c-ok-btn">í™•ì¸</button>
    </div>
  </div>
</div>

<script src="config.js"></script>
<script>
  let allCourses = {};
  let profReqs = [];
  let weekOffset = 0;
  let prevPendingCount = 0;
  const alarmAudio = new Audio('timer.mp3');

  function init() {
    firebase.database().ref('courses').on('value', snap => { allCourses = snap.val() || {}; renderAll(); });
    firebase.database().ref('system/transport_requests').on('value', snap => {
      const raw = snap.val() || {};
      profReqs = Object.keys(raw).map(k => ({ id: k, ...raw[k] }));
      checkNewRequests();
      renderAll();
    });
  }

  // --- ì•ŒëŒ ì‹œìŠ¤í…œ (2íšŒ ì¬ìƒ) ---
  function checkNewRequests() {
    const currentPending = profReqs.filter(r => r.status === 'pending').length;
    if (currentPending > prevPendingCount) {
        playAlarm(2);
    }
    prevPendingCount = currentPending;
  }

  function playAlarm(times) {
    let played = 0;
    const play = () => {
        alarmAudio.play().catch(e => console.log("Audio Play Blocked"));
        played++;
        if (played < times) { alarmAudio.onended = play; } else { alarmAudio.onended = null; }
    };
    play();
  }

  function renderAll() { renderSchedule(); renderInstructorList(); renderTraineeManagement(); }












// --- [íƒ­ 0] ì¢…í•© ì¼ì •í‘œ (ì˜¤ë¥˜ ìˆ˜ì • ë° ì¶œë ¥ ë³´ê°• ë²„ì „) ---
function renderSchedule() {
    const head = document.getElementById('sched-head');
    const body = document.getElementById('sched-body');
    const range = getWeekDates(weekOffset);
    const dayNames = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'];
    
    // ë¦¬ì…‹ ê¸°ì¤€ì¼ ê³„ì‚° (ì§€ë‚œ í† ìš”ì¼)
    const now = new Date();
    const lastSaturday = new Date();
    const diff = (lastSaturday.getDay() + 1) % 7; 
    lastSaturday.setDate(now.getDate() - diff);
    lastSaturday.setHours(0,0,0,0);
    const lastSaturdayStr = lastSaturday.toISOString().split('T')[0];

    // ì£¼ê°„ ë²”ìœ„ í‘œì‹œ ì—…ë°ì´íŠ¸
    document.getElementById('week-range').innerText = `${range[0]} ~ ${range[4].substring(5)}`;
    
    // í—¤ë” ì¶œë ¥
    head.innerHTML = `<tr><th class="time-col">ì‹œê°„</th>${range.map((d, i) => `<th onclick="askDayOff('${d}')">${d.substring(5)}<br>${dayNames[i]}</th>`).join('')}</tr>`;
    body.innerHTML = '';

    // ì‹œê°„ëŒ€ë³„(8ì‹œ~18ì‹œ) ë£¨í”„
    for(let h=8; h<=18; h++) {
        let row = `<tr><td class="time-col">${h}:00</td>`;
        
        // ìš”ì¼ë³„(ì›”~ê¸ˆ) ë£¨í”„
        for(let d=0; d<5; d++) {
            const curDate = range[d];
            let content = '';

            // 1. ìš´í–‰ ì¤‘ë‹¨ ì²´í¬
            if(profReqs.some(r => r.date === curDate && r.prof === 'ìš´í–‰ì¤‘ë‹¨')) {
                content = (h === 12) ? `<div class="cell-event block-off">ìš´í–‰ë¶ˆê°€</div>` : `<div class="cell-event block-off"></div>`;
            } 
            // 2. ì…êµìˆ˜ì†¡
            else if(d === 0 && (h === 9 || h === 10)) { 
                content = `<div class="cell-event block-entry">ì…êµìˆ˜ì†¡</div>`; 
            } 
            // 3. ì ì‹¬ ì‹œê°„
            else if(h === 12) { 
                content = `<div class="cell-event block-lunch">ì ì‹¬</div>`; 
            } 
            else {
                // 4. ê°•ì‚¬ ìˆ˜ì†¡ ì¼ì • ì²´í¬
                const matchedProf = profReqs.filter(r => r.date === curDate && parseInt(r.time.split(':')[0]) === h && r.status === 'approved');
                if(matchedProf.length > 0) {
                    const names = matchedProf.length > 1 ? `${matchedProf[0].prof} ì™¸` : matchedProf[0].prof;
                    content = `<div class="cell-event block-prof" onclick="showDetail('prof', ${JSON.stringify(matchedProf[0]).replace(/"/g, '&quot;')})">${matchedProf[0].dir.replace('â†’','>>')}<br>${names}</div>`;
                } 
                else {
                    // 5. êµìœ¡ìƒ í‡´êµìˆ˜ì†¡ ì¼ì • ì²´í¬
                    Object.keys(allCourses).forEach(rid => {
                        const room = allCourses[rid];
                        const dep = room.shuttle?.departure;
                        if(dep && dep.date === curDate && parseInt(dep.time.split(':')[0]) === h) {
                            content = `<div class="cell-event block-departure" onclick="showDrillDown('course', '${rid}')">í‡´êµìˆ˜ì†¡</div>`;
                        }
                    });
                }
            }
            row += `<td>${content}</td>`;
        }
        body.innerHTML += row + '</tr>';
    }

    // [ìˆ˜ì •] ì˜¤ë¥˜ê°€ ë‚¬ë˜ ë¦¬ì…‹ í•¨ìˆ˜ í˜¸ì¶œ ë°©ì‹ì„ ì•ˆì „í•˜ê²Œ ë³€ê²½
    checkAndResetOldData(lastSaturdayStr);
}

// ë°ì´í„° ì •ë¦¬ í•¨ìˆ˜ (ì•ˆì „í•˜ê²Œ ë¶„ë¦¬)
function checkAndResetOldData(limitDate) {
    if (!allCourses) return;
    Object.keys(allCourses).forEach(rid => {
        const dep = allCourses[rid].shuttle?.departure;
        if (dep && dep.date && dep.date < limitDate) {
            firebase.database().ref(`courses/${rid}/shuttle/departure`).set(null);
            firebase.database().ref(`courses/${rid}/shuttle/requests`).set(null);
        }
    });
}






// [íƒ­ 1] ì‹¤ì‹œê°„ í†¡ ë Œë”ë§ (ë‚ ì§œ ì •ë³´ê°€ í¬í•¨ëœ ë‹µë³€ ë²„ì „)
  function renderInstructorList() {
    const allZone = document.getElementById('all-request-container');
    const newZone = document.getElementById('new-request-container');
    newZone.innerHTML = '';
    allZone.innerHTML = '<div class="chat-container" id="chat-box"></div>';
    const chatBox = document.getElementById('chat-box');

    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    const currentTimeStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');

    const grouped = {};
    profReqs.filter(r => r.prof !== 'ìš´í–‰ì¤‘ë‹¨').forEach(r => {
        const groupKey = `${r.prof}_${r.date}_${r.courseRID}`;
        if (!grouped[groupKey]) grouped[groupKey] = { prof: r.prof, date: r.date, phone: r.phone, courseRID: r.courseRID, legs: [] };
        grouped[groupKey].legs.push(r);
    });

    const sortedGroups = Object.values(grouped).sort((a, b) => a.date.localeCompare(b.date));
    let lastDate = "";

    sortedGroups.forEach(group => {
        if(group.date !== lastDate) {
            chatBox.innerHTML += `<div class="chat-date-line"><span>${group.date}</span></div>`;
            lastDate = group.date;
        }

        const roomInfo = allCourses[group.courseRID];
        const cName = roomInfo?.settings?.courseName || `ê³¼ì •`;
        const dayNames = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
        const dIdx = new Date(group.date).getDay();
        const dateWithDay = `${group.date}(${dayNames[dIdx]})`; // ë‚ ì§œ(ìš”ì¼) í˜•íƒœ
        
        let legsHtml = "";
        let repliesHtml = "";

        group.legs.sort((a,b) => a.time.localeCompare(b.time));

        group.legs.forEach(r => {
            const isApp = r.status === 'approved';
            const isCan = r.status === 'cancelled';
            const isPast = (r.date < todayStr) || (r.date === todayStr && r.time < currentTimeStr);
            
            if(isCan) {
                legsHtml += `<div style="padding:8px; opacity:0.5; text-decoration:line-through;">ğŸš« ì·¨ì†Œë¨: ${r.time} ${r.dir}</div>`;
                return;
            }

            legsHtml += `
                <div class="talk-leg-item ${isPast ? 'leg-is-past' : ''}">
                    <div style="font-weight:800; color:#0369a1;">
                        ${r.time} ${r.dir.replace('â†’',' >> ')} ${isPast ? '(ë§Œë£Œ)' : ''}
                    </div>
                    ${(!isApp && !isPast) ? `
                        <div class="leg-actions">
                            <button class="mini-talk-btn ok" onclick="handleSmartApprove('${r.id}')">ìŠ¹ì¸</button>
                            <button class="mini-talk-btn no" onclick="confirmAction('delete', '${r.id}')">ë¶ˆê°€</button>
                        </div>
                    ` : (isApp ? `<div class="leg-status-done"><i class="fa-solid fa-check"></i> ë°°ì°¨ ìŠ¹ì¸ë¨</div>` : '')}
                </div>`;

            if(isApp) {
                // [ìˆ˜ì • í¬ì¸íŠ¸] ë‚ ì§œ(dateWithDay) ì •ë³´ ì¶”ê°€
                repliesHtml += `
                    <div class="chat-bubble chat-right">
                        <div class="bubble-reply">
                            ë„¤ í™•ì¸í–ˆìŠµë‹ˆë‹¤.<br>
                            <b>&lt;${cName}&gt; ${r.prof} ê°•ì‚¬ë‹˜</b><br>
                            ${dateWithDay} [${r.time}]<br>
                            ${r.dir.replace('â†’',' >> ')}<br>
                            ë°°ì°¨ ìŠ¹ì¸ ì™„ë£Œ!
                        </div>
                        <div class="chat-time" style="align-self: flex-start;">ë‚˜(ê¸°ì‚¬)</div>
                    </div>`;
            }
        });

        chatBox.innerHTML += `
            <div class="chat-bubble chat-left">
                <div class="talk-header">ìš´ì˜ë¶€ ìˆ˜ì†¡ìš”ì²­</div>
                <div class="bubble-content">
                    <div class="talk-body">&lt;${cName}&gt; ${group.prof} ê°•ì‚¬ë‹˜ (${formatPhone(group.phone)})</div>
                    <div style="margin-top:10px; border-top:1px solid #eee; padding-top:5px;">${legsHtml}</div>
                </div>
                <div class="chat-time">ìš´ì˜ë¶€</div>
            </div>` + repliesHtml;
    });

    const contentArea = document.getElementById('main-content');
    contentArea.scrollTop = contentArea.scrollHeight;
  }











  // í‘œì˜ í•œ ì¤„ì„ ë§Œë“œëŠ” í•¨ìˆ˜ (ê¸°ì¡´ createCard ëŒ€ì²´)
  function createTransRow(r) {
    const isApp = r.status === 'approved';
    const d = new Date(r.date);
    const dayNames = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
    const dIdx = d.getDay();
    const dateStr = `${r.date.substring(5)}`;

    return `
        <div class="trans-row">
            <div class="tr-cell">
                <b>${dateStr}</b><span class="day-label d-${dIdx}">${dayNames[dIdx]}</span>
            </div>
            <div class="tr-cell" style="font-weight:800;">${r.time}</div>
            <div class="tr-cell info">
                <span class="info-route">${r.dir}</span>
                <span class="info-prof">${r.prof} ê°•ì‚¬ë‹˜</span>
            </div>
            <div class="tr-cell btns">
                ${isApp ? 
                    `<div class="tr-btn ok active" onclick="confirmAction('cancel', '${r.id}')"><i class="fa-solid fa-rotate-left"></i></div>` : 
                    `<div class="tr-btn ok" onclick="handleSmartApprove('${r.id}')"><i class="fa-solid fa-check"></i></div>`
                }
                <div class="tr-btn del" onclick="confirmAction('delete', '${r.id}')"><i class="fa-solid fa-trash-can"></i></div>
                <div class="tr-btn call" onclick="window.location.href='tel:${r.phone}'"><i class="fa-solid fa-phone"></i></div>
            </div>
        </div>`;
  }
























// [íƒ­ 1] ìŠ¤ë§ˆíŠ¸ ìŠ¹ì¸ í•¨ìˆ˜ (ì¶©ëŒ ë‚´ì—­ ìƒì„¸ í‘œì‹œ ë²„ì „)
  async function handleSmartApprove(id) {
    const target = profReqs.find(r => r.id === id);
    const targetH = parseInt(target.time.split(':')[0]);
    let conflictList = []; // ì¶©ëŒë˜ëŠ” ë‚´ì—­ë“¤ì„ ë‹´ì„ ë¦¬ìŠ¤íŠ¸

    // 1. ë‹¤ë¥¸ ê°•ì‚¬ ìˆ˜ì†¡ ì¼ì •ê³¼ ì¶©ëŒí•˜ëŠ”ì§€ í™•ì¸ (ì´ë¯¸ ìŠ¹ì¸ëœ ê²ƒë“¤ ì¤‘)
    profReqs.forEach(r => {
        if(r.id !== id && r.status === 'approved' && r.date === target.date) {
            const otherH = parseInt(r.time.split(':')[0]);
            if(otherH === targetH) {
                conflictList.push(`[ê°•ì‚¬ìˆ˜ì†¡] ${r.prof} ê°•ì‚¬ë‹˜ (${r.dir})`);
            }
        }
    });

    // 2. êµìœ¡ìƒ í‡´êµ ì°¨ëŸ‰ ì¼ì •ê³¼ ì¶©ëŒí•˜ëŠ”ì§€ í™•ì¸
    Object.values(allCourses).forEach(room => {
        const dep = room.shuttle?.departure;
        if(dep && dep.date === target.date) {
            const depH = parseInt(dep.time.split(':')[0]);
            if(depH === targetH) {
                const courseName = room.settings?.courseName || "ì•Œ ìˆ˜ ì—†ëŠ” ê³¼ì •";
                conflictList.push(`[êµìœ¡ìƒí‡´êµ] ${courseName} (#${dep.time})`);
            }
        }
    });

    // 3. ì¶©ëŒ ë‚´ì—­ì´ ìˆë‹¤ë©´ ìƒì„¸íˆ ë³´ì—¬ì¤Œ
    if(conflictList.length > 0) {
        // ì¶©ëŒ ë‚´ì—­ì„ ì˜ˆì˜ê²Œ ë‚˜ì—´
        const conflictHtml = conflictList.map(item => 
            `<div style="color:#ef4444; font-weight:800; margin-top:5px; padding-left:10px;">â€¢ ${item}</div>`
        ).join('');

        showConfirm(
            "âš ï¸ ë°°ì°¨ ì¶©ëŒ ê²½ê³ ", 
            `í•´ë‹¹ ì‹œê°„ëŒ€ì— ì´ë¯¸ ë‹¤ìŒ ì¼ì •ì´ ì¡´ì¬í•©ë‹ˆë‹¤:<br>${conflictHtml}<br><br>ê·¸ë˜ë„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 
            async () => {
                await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'approved' });
                closeModal('confirmModal');
            }
        );
    } else {
        // ì¶©ëŒì´ ì—†ìœ¼ë©´ ë°”ë¡œ ìŠ¹ì¸ í™•ì¸ì°½
        confirmAction('approve', id);
    }
  }












function renderTraineeManagement() {
    const area = document.getElementById('trainee-course-list');
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0]; // ì˜¤ëŠ˜ (2026-01-24)

    // ë¦¬ì…‹ ê¸°ì¤€ (ì§€ë‚œ í† ìš”ì¼)
    const lastSat = new Date();
    lastSat.setDate(now.getDate() - ((now.getDay() + 1) % 7));
    const lastSatStr = lastSat.toISOString().split('T')[0];

    let listHTML = `<div class="list-wrapper">
        <div class="list-header">
          <div class="t-cell name">ê³¼ì •ëª…</div>
          <div class="t-cell">í‡´êµì´ì›</div>
          <div class="t-cell">í•­ê¸°ì› ì¶œë°œì‹œê°„</div>
          <div class="t-cell">ê³µì§€</div>
        </div>`;

    Object.keys(allCourses).forEach(rid => {
      const room = allCourses[rid];
      if(room.status?.roomStatus !== 'active') return;

      const period = room.settings?.period || "";
      if (!period.includes(" ~ ")) return;
      const [startDate, endDate] = period.split(" ~ ");

      // [í•µì‹¬ ë¡œì§] ê³¼ì •ì´ ì§„í–‰ ì¤‘ì´ê±°ë‚˜ ì˜¤ëŠ˜ì´ ì¢…ë£Œì¼ì´ë¼ë©´ ë¬´ì¡°ê±´ í‘œì‹œ!
      // ì¦‰, 2ì£¼ì°¨ ê³¼ì •ì´ë¼ ì¢…ë£Œì¼ì´ ë‹¤ìŒ ì£¼ ê¸ˆìš”ì¼ì´ë¼ë©´ ì˜¤ëŠ˜(í† ìš”ì¼)ë„ ë‹¹ì—°íˆ ë³´ì…ë‹ˆë‹¤.
      if (endDate < todayStr) return; 

      const dep = room.shuttle?.departure || { time: "", date: "" };
      
      // ìë™ ë¦¬ì…‹: ë§Œì•½ ì €ì¥ëœ ë°ì´í„°ê°€ ì§€ë‚œ í† ìš”ì¼ë³´ë‹¤ ì „ì´ë©´ ì‚­ì œ
      if (dep.date && dep.date < lastSatStr) {
          firebase.database().ref(`courses/${rid}/shuttle/departure`).set(null);
          firebase.database().ref(`courses/${rid}/shuttle/requests`).set(null);
          return;
      }

      const reqs = Object.values(room.shuttle?.requests || {});
      const subTotal = reqs.filter(r => r.type !== 'car').length;
      const cName = room.settings?.courseName || 'ê³¼ì •ëª…';

      // ì‹¤ì‹œê°„ ë²„íŠ¼ í™œì„±í™” ì²´í¬
      const curT = dep.time ? dep.time.trim() : "";
      const is13 = (curT === '13:00');
      const is15 = (curT === '15:00');
      const isManual = (curT && !is13 && !is15);

      listHTML += `
        <div class="course-row">
          <div class="t-cell name" style="font-size:12px; font-weight:800; justify-content:flex-start; padding-left:10px;">${cName}</div>
          <div class="t-cell count" style="cursor:pointer; color:#0ea5e9; font-weight:900;" onclick="showDrillDown('course', '${rid}')">${subTotal}ëª…</div>
          <div class="t-cell btns">
            <button class="mini-btn ${is13 ? 'active' : ''}" onclick="confirmAction('dep', '${rid}', '13:00', '${endDate}')">13:00</button>
            <button class="mini-btn ${is15 ? 'active' : ''}" onclick="confirmAction('dep', '${rid}', '15:00', '${endDate}')">15:00</button>
            <button class="mini-btn ${isManual ? 'active' : ''}" onclick="promptManual('${rid}', '${endDate}')">ìˆ˜ë™</button>
          </div>
          <div class="t-cell status">
            ${curT ? `<i class="fa-solid fa-circle-check notice-on" style="cursor:pointer;" onclick="confirmAction('cancelDep', '${rid}')"></i>` : `<i class="fa-solid fa-minus notice-off" style="opacity:0.2;"></i>`}
          </div>
        </div>`;
    });

    listHTML += `</div>`;
    area.innerHTML = listHTML;
  }






// [ê¸°ì‚¬ë‹˜ í”Œë«í¼] ëª¨ë“  í™•ì¸/ì €ì¥/ì¶©ëŒì²´í¬ í†µí•© í•¨ìˆ˜
  function confirmAction(type, id, val = null, targetDate = null) {
    const modal = document.getElementById('confirmModal');
    const okBtn = document.getElementById('c-ok-btn');
    
    // --- 1. ê°•ì‚¬ ìˆ˜ì†¡ ìŠ¹ì¸ (ì¶©ëŒ ì²´í¬ ë¡œì§ ë³µêµ¬) ---
    if(type === 'approve') {
        const target = profReqs.find(r => r.id === id);
        const targetH = parseInt(target.time.split(':')[0]);
        let conflictList = [];

        // ë‹¤ë¥¸ ê°•ì‚¬ ìˆ˜ì†¡ ì¼ì •ê³¼ ê²¹ì¹˜ëŠ”ì§€ ì²´í¬
        profReqs.forEach(r => {
            if(r.id !== id && r.status === 'approved' && r.date === target.date) {
                if(parseInt(r.time.split(':')[0]) === targetH) conflictList.push(`[ê°•ì‚¬] ${r.prof} (${r.dir})`);
            }
        });

        // êµìœ¡ìƒ í‡´êµ ì¼ì •ê³¼ ê²¹ì¹˜ëŠ”ì§€ ì²´í¬
        Object.values(allCourses).forEach(room => {
            const dep = room.shuttle?.departure;
            if(dep && dep.date === target.date && parseInt(dep.time.split(':')[0]) === targetH) {
                conflictList.push(`[í‡´êµ] ${room.settings?.courseName || 'ê³¼ì •'}`);
            }
        });

        if(conflictList.length > 0) {
            document.getElementById('c-title').innerText = "âš ï¸ ë°°ì°¨ ì¶©ëŒ ê²½ê³ ";
            document.getElementById('c-desc').innerHTML = `í•´ë‹¹ ì‹œê°„ëŒ€ì— ì´ë¯¸ ì¼ì •ì´ ìˆìŠµë‹ˆë‹¤:<br><br>${conflictList.map(v => `<span style="color:#ef4444; font-weight:800;">â€¢ ${v}</span>`).join('<br>')}<br><br>ê·¸ë˜ë„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
        } else {
            document.getElementById('c-title').innerText = "ë°°ì°¨ ìŠ¹ì¸";
            document.getElementById('c-desc').innerText = "í•´ë‹¹ ìˆ˜ì†¡ì„ ìŠ¹ì¸í•˜ê³  ì¼ì •í‘œì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
        }

        okBtn.onclick = async () => { 
            await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'approved' }); 
            closeModal('confirmModal'); 
        };
    } 
    // --- 2. êµìœ¡ìƒ í‡´êµ ê³µì§€ ì„¤ì • (ë‚ ì§œ/ì‹œê°„ ì €ì¥ ë° ì‹¤ì‹œê°„ ë°˜ì˜) ---
    else if(type === 'dep') {
        document.getElementById('c-title').innerText = "í‡´êµ ê³µì§€"; 
        document.getElementById('c-desc').innerHTML = `ê³µì§€ì‹œê°„: <b style="color:#0ea5e9;">${val}</b><br>í‡´êµì˜ˆì •: <b style="color:#ef4444;">${targetDate}</b><br><br>í•´ë‹¹ ê³¼ì • ì¢…ë£Œì¼ì— ë§ì¶° ê³µì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
        
        okBtn.onclick = async () => { 
            closeModal('confirmModal');
            // ì •í™•í•œ Room ID ê²½ë¡œì— ì €ì¥ (targetDateëŠ” ê°•ì‚¬ê°€ ì„¤ì •í•œ ì „ì²´ ê³¼ì • ì¢…ë£Œì¼)
            await firebase.database().ref(`courses/${id}/shuttle/departure`).set({ 
                time: val, 
                date: targetDate 
            }); 
            // [ì¤‘ìš”] ì €ì¥ ì¦‰ì‹œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ê·¸ë ¤ì„œ ë²„íŠ¼ ê²€ì •ìƒ‰(active) ë°˜ì˜
            renderTraineeManagement(); 
        };
    } 
    // --- 3. êµìœ¡ìƒ í‡´êµ ê³µì§€ ì·¨ì†Œ ---
    else if(type === 'cancelDep') {
        if(!confirm("ì„¤ì •ëœ í‡´êµ ê³µì§€ ì‹œê°„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        firebase.database().ref(`courses/${id}/shuttle/departure`).set(null).then(() => {
            renderTraineeManagement(); 
        });
        return;
    }
    // --- 4. ê¸°íƒ€ ì•¡ì…˜ (ìŠ¹ì¸ì·¨ì†Œ, ì‚­ì œ) ---
    else if(type === 'cancel') {
        document.getElementById('c-title').innerText = "ìŠ¹ì¸ ì·¨ì†Œ"; 
        document.getElementById('c-desc').innerText = "ë°°ì°¨ ìŠ¹ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
        okBtn.onclick = async () => { await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'pending' }); closeModal('confirmModal'); };
    } else if(type === 'delete') {
        document.getElementById('c-title').innerText = "ì‚­ì œ/ê±°ì ˆ"; 
        document.getElementById('c-desc').innerHTML = "<span style='color:red; font-weight:900;'>ì´ ì‘ì—…ì€ ì¦‰ì‹œ ì‚­ì œë©ë‹ˆë‹¤.</span>";
        okBtn.onclick = async () => { await firebase.database().ref(`system/transport_requests/${id}`).remove(); closeModal('confirmModal'); };
    }

    modal.style.display = 'flex';
  }











  function showConfirm(title, desc, callback) {
    document.getElementById('c-title').innerText = title;
    document.getElementById('c-desc').innerHTML = desc;
    document.getElementById('c-ok-btn').onclick = callback;
    document.getElementById('confirmModal').style.display = 'flex';
  }

  function showDetail(type, data) {
    const modal = document.getElementById('detailModal');
    const content = document.getElementById('m-content');
    if(type === 'prof') {
        document.getElementById('m-title').innerText = "ìˆ˜ì†¡ ìƒì„¸ ì •ë³´";
        content.innerHTML = `<b>ê°•ì‚¬ëª…:</b> ${data.prof} ê°•ì‚¬ë‹˜<br><b>êµ¬ê°„:</b> ${data.dir}<br><b>ì‹œê°„:</b> ${data.time}<br><b>ë‚ ì§œ:</b> ${data.date}`;
        document.getElementById('m-call-btn').style.display = 'block'; 
        document.getElementById('m-call-btn').onclick = () => window.location.href = "tel:" + data.phone;
    }
    modal.style.display = 'flex';
  }

// í˜„ì¬ íƒ­ ë²ˆí˜¸ë¥¼ ê¸°ì–µí•  ë³€ìˆ˜ (ë§¨ ìœ„ì— ì„ ì–¸í•˜ê±°ë‚˜ í•¨ìˆ˜ ë°–ì— ë‘¡ë‹ˆë‹¤)
  let currentTab = 0;

function switchTab(n) {
    currentTab = n; 
    document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === n));
    document.querySelectorAll('[id^="view-"]').forEach((v, i) => v.style.display = i === n ? 'block' : 'none');
    
    // í™ˆ ë²„íŠ¼ í‘œì‹œ ì œì–´
    const homeBtn = document.getElementById('floating-home');
    if(homeBtn) homeBtn.style.display = (n === 0) ? 'none' : 'flex';

    // ìƒë‹¨ ë²„íŠ¼ ê¸€ì ë³€ê²½ (ì¢…í•©ì¼ì •í‘œì¼ ë•Œë§Œ << í‘œì‹œ)
    const btnText = document.getElementById('back-btn-text');
    if (btnText) {
        btnText.innerText = (n === 0) ? "<<" : "Back";
    }
  }

  function getWeekDates(offset) {
    const now = new Date();
    const start = new Date(now.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1) + (offset * 7)));
    const dates = [];
    for(let i=0; i<5; i++) {
        const d = new Date(start); d.setDate(start.getDate() + i);
        dates.push(d.toISOString().split('T')[0]);
    }
    return dates;
  }
  function changeWeek(n) { weekOffset += n; renderAll(); }
  function closeModal(id) { document.getElementById(id).style.display = 'none'; }
  function askDayOff(date) {
    const reason = prompt(`${date} ìš´í–‰ì¤‘ë‹¨ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”`, "ì°¨ëŸ‰ ì •ë¹„");
    if(reason) firebase.database().ref('system/transport_requests').push({ date, prof: 'ìš´í–‰ì¤‘ë‹¨', dir: reason, status: 'approved', time: '00:00' });
  }





function promptManual(rid, endDate) {
    // ì‹œê³„ ì•„ì´ì½˜(ì‹œê°„ ì„ íƒê¸°)ì„ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ì—¬ í´ë¦­ ìœ ë„
    const timeInput = document.createElement('input');
    timeInput.type = 'time';
    timeInput.style.position = 'fixed';
    timeInput.style.top = '-100px'; // í™”ë©´ ë°–ìœ¼ë¡œ ìˆ¨ê¹€
    document.body.appendChild(timeInput);

    timeInput.onchange = (e) => {
        if(e.target.value) {
            confirmAction('dep', rid, e.target.value, endDate);
        }
        document.body.removeChild(timeInput); // ì‚¬ìš© í›„ ì œê±°
    };

    // ì•„ì´í°/ì•ˆë“œë¡œì´ë“œì—ì„œ ê¸°ë³¸ ì‹œê°„ ì„ íƒê¸°ë¥¼ ë„ì›€
    timeInput.showPicker ? timeInput.showPicker() : timeInput.click();
  }






function showDrillDown(type, filterRid = null) {
    const area = document.getElementById('m-content');
    const title = document.getElementById('m-title');
    document.getElementById('m-call-btn').style.display = 'none';
    area.innerHTML = '';
    
    let list = [];
    Object.keys(allCourses).forEach(rid => {
        if(filterRid && rid !== filterRid) return;
        const roomName = allCourses[rid].settings?.courseName || "ìƒì„¸ ëª…ë‹¨";
        if(filterRid) title.innerText = roomName; 
        
        const reqs = Object.values(allCourses[rid].shuttle?.requests || {});
        reqs.forEach(req => {
            if(req.type !== 'car') list.push({...req});
        });
    });

    if(list.length === 0) {
        area.innerHTML = "<div style='text-align:center; padding:20px;'>ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    } else {
        const groups = {
            osong: { name: "ğŸš… ì˜¤ì†¡ì—­", items: [] },
            terminal: { name: "ğŸšŒ í„°ë¯¸ë„", items: [] },
            airport: { name: "âœˆï¸ ê³µí•­", items: [] }
        };

        list.forEach(item => { if(groups[item.type]) groups[item.type].items.push(item); });

        let groupHTML = '';
        ['osong', 'terminal', 'airport'].forEach(key => {
            const g = groups[key];
            if(g.items.length > 0) {
                groupHTML += `
                    <div class="popup-group">
                        <div class="group-title">
                            <span>${g.name}</span> 
                            <span style="color:#0ea5e9;">${g.items.length}ëª…</span>
                        </div>
                        <div class="group-grid">`; // ê·¸ë¦¬ë“œ ì‹œì‘
                
                g.items.forEach(person => {
                    groupHTML += `
                        <div class="grid-name-item" onclick="window.location.href='tel:${person.phone}'">
                            ${person.name}
                        </div>`;
                });

                groupHTML += `</div></div>`; // ê·¸ë¦¬ë“œ ë° ê·¸ë£¹ ì¢…ë£Œ
            }
        });
        area.innerHTML = groupHTML;
    }
    document.getElementById('detailModal').style.display = 'flex';
  }





// ë’¤ë¡œê°€ê¸° í´ë¦­ ì‹œ ë™ì‘
  function handleBack() {
    if (currentTab === 0) {
        // ì¢…í•© ì¼ì •í‘œë¼ë©´ ì‚¬ìš©ìê°€ ì œê³µí•œ potal.htmlë¡œ ì´ë™
        location.href = 'potal.html';
    } else {
        // ë‹¤ë¥¸ íƒ­ì´ë¼ë©´ ì¢…í•© ì¼ì •í‘œ(í™ˆ)ë¡œ ì´ë™
        switchTab(0);
    }
  }

// ì¢…í•© ì¼ì •í‘œ í™”ë©´ ìº¡ì³ ë° ì´ë¯¸ì§€ ì €ì¥ í•¨ìˆ˜
  async function captureSchedule() {
    const area = document.getElementById('capture-area');
    const weekText = document.getElementById('week-range').innerText;
    
    // ë²„íŠ¼ì„ ì ì‹œ ìˆ¨ê¸°ê±°ë‚˜ í‘œì‹œë¥¼ ì¡°ì ˆí•  í•„ìš” ì—†ì´ ì§€ì •ëœ ì˜ì—­ë§Œ ì°ìŠµë‹ˆë‹¤.
    try {
      const canvas = await html2canvas(area, {
        backgroundColor: "#f1f5f9", // ë°°ê²½ìƒ‰ ìœ ì§€
        scale: 2, // 2ë°° ì„ ëª…í•˜ê²Œ ìº¡ì³
        logging: false
      });
      
      const link = document.createElement('a');
      link.download = `KAC_ì°¨ëŸ‰ì§€ì›_ì¼ì •í‘œ(${weekText}).png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    } catch (e) {
      alert("ìº¡ì³ ê¸°ëŠ¥ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ë³´ì•ˆ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
      console.error(e);
    }
  }


// ìˆ«ìë¥¼ íœ´ëŒ€í° ë²ˆí˜¸ í˜•ì‹(í•˜ì´í”ˆ)ìœ¼ë¡œ ë°”ê¿”ì£¼ëŠ” í•¨ìˆ˜
  function formatPhone(num) {
    if (!num) return "";
    // ìˆ«ìë§Œ ë‚¨ê¸°ê¸°
    const s = num.replace(/[^0-9]/g, "");
    if (s.length === 11) {
      return s.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3");
    } else if (s.length === 10) {
      return s.replace(/(\d{3})(\d{3})(\d{4})/, "$1-$2-$3");
    }
    return num; // í˜•ì‹ì´ ì•ˆ ë§ìœ¼ë©´ ê·¸ëƒ¥ ì›ë³¸ ì¶œë ¥
  }




  init();
</script>
</body>
</html>