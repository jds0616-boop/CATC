<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>KAC 수송 관리 시스템 - 기사님용</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      --kac-navy: #0f172a; --kac-blue: #3b82f6; --bg-gray: #f1f5f9;
      --osong: #ef4444; --term: #3b82f6; --air: #10b981; --car: #64748b;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
    body { margin: 0; padding: 0; background: #cfd8e3; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }
    
    .app-container { width: 100%; max-width: 600px; height: 100%; background: var(--bg-gray); display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.2); }
    
    /* 상단바 */
    .app-header { height: 60px; background: var(--kac-navy); display: flex; align-items: center; justify-content: center; padding: 0 20px; color: #fff; border-bottom: 2px solid var(--kac-blue); flex-shrink: 0; }
    .header-title { font-size: 19px; font-weight: 900; letter-spacing: -0.5px; }

    /* 3단 탭 바 */
    .tab-bar { display: flex; background: #1e293b; padding: 12px 15px; gap: 8px; flex-shrink: 0; }
    .tab-btn { flex: 1; padding: 12px 5px; border-radius: 10px; border: none; background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); font-weight: 800; cursor: pointer; font-size: 13px; transition: 0.2s; white-space: nowrap; }
    .tab-btn.active { background: var(--kac-blue); color: #fff; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

    .app-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }

    /* 공통 카드 스타일 */
    .section-card { background: white; border-radius: 20px; padding: 20px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
    
    /* [탭 1] 과정 카드 */
    .course-card { border-left: 6px solid var(--kac-blue); margin-bottom: 12px; }
    .course-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
    .course-name { font-weight: 900; font-size: 17px; color: var(--kac-navy); }
    .time-btn-group { display: grid; grid-template-columns: 1fr 1fr 0.6fr; gap: 8px; }
    .time-btn { height: 45px; border-radius: 10px; border: 1.5px solid #cbd5e1; background: #fff; font-size: 14px; font-weight: 800; color: #475569; cursor: pointer; }
    .time-btn.active { background: var(--kac-blue); color: white; border-color: var(--kac-blue); }
    .time-btn.manual { background: #1e293b; color: white; border: none; }
    .status-banner { margin-top: 12px; padding: 8px; border-radius: 8px; background: #f8fafc; text-align: center; font-size: 12px; font-weight: 800; color: #64748b; border: 1px solid #e2e8f0; }
    .status-banner.on { background: #ecfdf4; color: #10b981; border-color: #10b981; }

    /* [탭 2] 주간 리스트 */
    .week-selector { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 5px; }
    .day-group-title { font-size: 13px; font-weight: 900; color: var(--kac-blue); margin: 15px 0 8px 5px; }
    .pickup-ticket { background: white; border-radius: 15px; padding: 15px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .ticket-time { font-size: 18px; font-weight: 900; color: var(--kac-navy); }
    .ticket-loc { font-size: 13px; font-weight: 700; color: var(--kac-blue); }
    .ticket-prof { font-size: 14px; font-weight: 800; }
    .call-circle { width: 45px; height: 45px; border-radius: 50%; background: #ecfdf5; color: #10b981; display: flex; align-items: center; justify-content: center; font-size: 20px; border: none; cursor: pointer; }

    /* [탭 3] 스케줄표 */
    .schedule-wrapper { background: white; border-radius: 15px; border: 1px solid #e2e8f0; overflow: hidden; }
    .schedule-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .schedule-table th, .schedule-table td { border: 1px solid #f1f5f9; text-align: center; height: 50px; font-size: 11px; vertical-align: middle; }
    .schedule-table th { background: #f8fafc; color: #475569; font-weight: 800; cursor: pointer; }
    .schedule-table th:active { background: #e2e8f0; }
    .time-col { width: 50px; font-weight: 900; background: #f8fafc !important; }

    /* 팝업 모달 */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 5000; align-items: center; justify-content: center; padding: 20px; }
    .modal-box { background: white; width: 100%; max-width: 400px; border-radius: 24px; padding: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }

    .app-footer { height: 60px; background: var(--kac-navy); color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; flex-shrink: 0; border-top: 2px solid var(--kac-blue); }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div class="header-title">항공기술훈련원 차량관리시스템</div>
    </header>

    <div class="tab-bar">
      <button id="tab-btn-1" class="tab-btn active" onclick="switchTab(1)">교육생 퇴교 관리</button>
      <button id="tab-btn-2" class="tab-btn" onclick="switchTab(2)">강사 수송 리스트</button>
      <button id="tab-btn-3" class="tab-btn" onclick="switchTab(3)">종합 일정표</button>
    </div>

    <main class="app-content">
      <!-- 탭 1: 교육생 퇴교 관리 -->
      <div id="view-1" style="display: flex; flex-direction: column;">
          <div class="summary-card" style="background: var(--kac-navy); border-radius: 20px; padding: 20px; color: white; display: flex; justify-content: space-around; text-align: center; margin-bottom: 20px;">
              <div><span style="font-size:11px; opacity:0.7; display:block;">오송역</span><b id="sum-osong" style="font-size:24px;">0</b></div>
              <div><span style="font-size:11px; opacity:0.7; display:block;">터미널</span><b id="sum-term" style="font-size:24px;">0</b></div>
              <div><span style="font-size:11px; opacity:0.7; display:block;">공항</span><b id="sum-air" style="font-size:24px;">0</b></div>
              <div style="width:1px; background:rgba(255,255,255,0.1)"></div>
              <div><span style="font-size:11px; opacity:0.7; display:block;">총원</span><b id="sum-total" style="font-size:24px; color:var(--kac-blue);">0</b></div>
          </div>
          <div id="course-list-area"></div>
      </div>

      <!-- 탭 2: 강사 수송 리스트 -->
      <div id="view-2" style="display: none; flex-direction: column;">
          <div class="week-selector">
              <i class="fa-solid fa-circle-chevron-left nav-arrow" onclick="changeWeek(-1)"></i>
              <b id="list-week-label" style="font-size:16px;">날짜 로딩 중...</b>
              <i class="fa-solid fa-circle-chevron-right nav-arrow" onclick="changeWeek(1)"></i>
          </div>
          <div id="instructor-pickup-list"></div>
      </div>

      <!-- 탭 3: 종합 일정표 -->
      <div id="view-3" style="display: none; flex-direction: column; gap: 15px;">
          <div class="week-nav">
              <i class="fa-solid fa-circle-chevron-left nav-arrow" onclick="changeWeek(-1)"></i>
              <b id="sched-week-label">날짜 로딩 중...</b>
              <i class="fa-solid fa-circle-chevron-right nav-arrow" onclick="changeWeek(1)"></i>
          </div>
          <div style="text-align:right; font-size:10px; color:#64748b; margin-top:-5px;">*요일 클릭 시 운행 불가 설정</div>
          <div class="schedule-wrapper">
            <table class="schedule-table">
              <thead><tr id="schedule-header"></tr></thead>
              <tbody id="schedule-body"></tbody>
            </table>
          </div>
      </div>
    </main>

    <footer class="app-footer">
      <div id="footer-clock" style="font-size:18px; font-weight:900;">00:00:00</div>
      <img src="logo.png" alt="Logo" style="height:20px; filter:brightness(0) invert(1);">
    </footer>
  </div>

  <!-- 수송 상세 내역 팝업 -->
  <div id="detailModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
      <div class="modal-box">
          <div style="text-align:center; margin-bottom:20px;">
              <h2 id="pop-loc" style="margin:0; font-size:28px; font-weight:900; color:var(--kac-navy);">장소명</h2>
              <div id="pop-time" style="font-size:24px; font-weight:800; color:var(--kac-blue); margin-top:5px;">00:00</div>
          </div>
          <div style="background:#f8fafc; border-radius:15px; padding:15px; border:1px solid #f1f5f9; display:flex; flex-direction:column; gap:12px;">
              <div style="display:flex; justify-content:space-between;"><span style="color:#64748b;">수송 일자</span><b id="pop-date"></b></div>
              <div style="display:flex; justify-content:space-between;"><span style="color:#64748b;">수송 대상</span><b id="pop-target"></b></div>
              <div style="display:flex; justify-content:space-between;"><span style="color:#64748b;">비상 연락처</span><b id="pop-phone" style="color:var(--kac-blue);"></b></div>
          </div>
          <div style="display:flex; gap:10px; margin-top:25px;">
              <button class="navy-btn" style="flex:1; background:#64748b;" onclick="document.getElementById('detailModal').style.display='none'">닫기</button>
              <button id="pop-call-btn" class="navy-btn" style="flex:2; background:#10b981;"><i class="fa-solid fa-phone"></i> 전화 연결</button>
          </div>
      </div>
  </div>

  <!-- 요일별 운행 설정 팝업 -->
  <div id="daySettingModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
      <div class="modal-box">
          <h3 id="day-pop-title" style="margin-top:0;">0월 0일(요일) 설정</h3>
          <p style="font-size:13px; color:#64748b; line-height:1.5;">해당 요일의 운행을 중단하시겠습니까?<br>중단 시 예약된 모든 내역이 취소 처리됩니다.</p>
          <textarea id="no-op-reason" style="width:100%; height:80px; border-radius:10px; border:1.5px solid #e2e8f0; padding:10px; font-size:14px; margin:10px 0;" placeholder="사유 입력 (예: 차량 정비)"></textarea>
          <div style="display:flex; gap:10px;">
              <button class="navy-btn" style="flex:1; background:#64748b;" onclick="document.getElementById('daySettingModal').style.display='none'">취소</button>
              <button class="navy-btn" style="flex:2; background:var(--osong);" onclick="confirmNoOperation()">운행 중단 확정</button>
          </div>
      </div>
  </div>

  <script src="config.js"></script>
  <script>
    let allCourses = {};
    let teacherRequests = [];
    let currentTab = 1;
    let weekOffset = 0;
    let selectedDayToOff = "";

    function init() {
      // 강사 수송 데이터 리스너
      firebase.database().ref('system/transport_requests').on('value', snap => {
        const raw = snap.val() || {};
        teacherRequests = Object.keys(raw).map(k => ({ id: k, ...raw[k] }));
        if(currentTab === 2) renderInstructorList();
        if(currentTab === 3) renderSchedule();
      });

      // 교육과정 데이터 리스너
      firebase.database().ref('courses').on('value', snap => {
        allCourses = snap.val() || {};
        renderCourseDepartureList();
        updateDepartureStats();
        if(currentTab === 3) renderSchedule();
      });

      startClock();
    }

    // --- [탭 1] 교육생 퇴교 관리 ---
    function updateDepartureStats() {
        let stats = { o:0, t:0, a:0, sum:0 };
        Object.values(allCourses).forEach(room => {
            if(room.status?.roomStatus === 'active' && room.shuttle?.requests) {
                const reqs = Object.values(room.shuttle.requests);
                stats.o += reqs.filter(r => r.type === 'osong').length;
                stats.t += reqs.filter(r => r.type === 'terminal').length;
                stats.a += reqs.filter(r => r.type === 'airport').length;
                stats.sum += reqs.length;
            }
        });
        document.getElementById('sum-osong').innerText = stats.o;
        document.getElementById('sum-term').innerText = stats.t;
        document.getElementById('sum-air').innerText = stats.a;
        document.getElementById('sum-total').innerText = stats.sum;
    }

    function renderCourseDepartureList() {
        const container = document.getElementById('course-list-area');
        if(!container) return;
        container.innerHTML = "";
        
        const activeRids = Object.keys(allCourses).filter(rid => allCourses[rid].status?.roomStatus === 'active');
        if(activeRids.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:50px; color:#94a3b8;">현재 운영 중인 과정이 없습니다.</div>`;
            return;
        }

        activeRids.forEach(rid => {
            const room = allCourses[rid];
            const dep = room.shuttle?.departure || { time: "" };
            const reqs = room.shuttle?.requests ? Object.values(room.shuttle.requests) : [];
            
            const card = document.createElement('div');
            card.className = 'section-card course-card';
            card.innerHTML = `
                <div class="course-info">
                    <span class="course-name">#${rid} ${room.settings?.courseName || rid}</span>
                    <div class="course-shuttle-info">
                        <span style="color:var(--osong)">오송 ${reqs.filter(r=>r.type==='osong').length}</span>
                        <span style="color:var(--term)">터미널 ${reqs.filter(r=>r.type==='terminal').length}</span>
                        <span style="color:var(--air)">공항 ${reqs.filter(r=>r.type==='airport').length}</span>
                    </div>
                </div>
                <div class="time-btn-group">
                    <button class="time-btn ${dep.time==='13:00'?'active':''}" onclick="setDepartureTime('${rid}', '13:00')">13:00</button>
                    <button class="time-btn ${dep.time==='15:00'?'active':''}" onclick="setDepartureTime('${rid}', '15:00')">15:00</button>
                    <button class="time-btn manual" onclick="toggleManualTime('${rid}')">수동</button>
                </div>
                <div id="status-${rid}" class="status-banner ${dep.time?'on':''}">
                    ${dep.time ? `현재 [${dep.time}] 운행 공지 중` : '운행 시간을 선택해 주세요.'}
                </div>
                <input type="time" id="manual-time-${rid}" style="display:none; width:100%; margin-top:10px; height:40px; border-radius:8px; border:1.5px solid #1e293b; text-align:center;" onchange="setDepartureTime('${rid}', this.value)">
            `;
            container.appendChild(card);
        });
    }

    function setDepartureTime(rid, time) {
        const today = new Date();
        const friday = new Date();
        friday.setDate(today.getDate() + (5 - today.getDay())); 
        firebase.database().ref(`courses/${rid}/shuttle/departure`).set({
            time: time,
            date: friday.toISOString().split('T')[0]
        });
    }

    function toggleManualTime(rid) {
        const input = document.getElementById(`manual-time-${rid}`);
        input.style.display = input.style.display === 'none' ? 'block' : 'none';
        if(input.style.display === 'block') input.focus();
    }

    // --- [탭 2] 강사 수송 리스트 ---
    function renderInstructorList() {
        const div = document.getElementById('instructor-pickup-list');
        const range = getWeekDates();
        document.getElementById('list-week-label').innerText = `${range[0].replace(/-/g,'.')} ~ ${range[4].split('-')[2]}`;
        
        div.innerHTML = "";
        const dayNames = ['월','화','수','목','금'];
        
        range.forEach((date, idx) => {
            const dayReqs = teacherRequests.filter(r => r.date === date && r.status === 'approved');
            div.innerHTML += `<div class="day-group-title">${date} (${dayNames[idx]})</div>`;
            
            if(dayReqs.length === 0) {
                div.innerHTML += `<div style="padding:15px; color:#cbd5e1; font-size:12px; text-align:center;">예약된 수송 내역이 없습니다.</div>`;
            } else {
                dayReqs.sort((a,b) => a.time.localeCompare(b.time)).forEach(r => {
                    div.innerHTML += `
                        <div class="pickup-ticket">
                            <div>
                                <div class="ticket-loc">${r.dir}</div>
                                <div class="ticket-time">${r.time}</div>
                                <div class="ticket-prof">${r.prof} 강사님</div>
                            </div>
                            <button class="call-circle" onclick="makeCall('${r.phone}')"><i class="fa-solid fa-phone"></i></button>
                        </div>`;
                });
            }
        });
    }

    // --- [탭 3] 종합 일정표 ---
    function renderSchedule() {
        const range = getWeekDates();
        document.getElementById('sched-week-label').innerText = `${range[0].replace(/-/g,'.')} ~ ${range[4].split('-')[2]}`;
        
        const header = document.getElementById('schedule-header');
        header.innerHTML = '<th class="time-col">시간</th>';
        const dayNames = ['월','화','수','목','금'];
        range.forEach((d, i) => {
            const th = document.createElement('th');
            th.innerHTML = `${d.split('-')[1]}/${d.split('-')[2]}<br>${dayNames[i]}`;
            th.onclick = () => openDaySetting(d, dayNames[i]);
            header.appendChild(th);
        });

        const body = document.getElementById('schedule-body');
        body.innerHTML = "";
        for(let h=8; h<=18; h++) {
            const row = document.createElement('tr');
            row.innerHTML = `<td class="time-col">${h}:00</td>`;
            for(let d=0; d<5; d++) {
                const dateKey = range[d];
                const td = document.createElement('td');
                
                // 운행 중단 체크
                const isNoOp = teacherRequests.some(r => r.date === dateKey && r.prof === '운행중단');
                if(isNoOp) {
                    td.style.background = "#fee2e2";
                    if(h === 12) td.innerText = "휴무";
                } else {
                    const tReq = teacherRequests.find(r => r.date === dateKey && parseInt(r.time.split(':')[0]) === h && r.status === 'approved');
                    let sReq = null;
                    Object.values(allCourses).forEach(room => {
                        const dep = room.shuttle?.departure;
                        if(dep && dep.date === dateKey && parseInt(dep.time.split(':')[0]) === h) {
                            sReq = { loc: '훈련원', time: dep.time, prof: room.settings?.courseName || '교육생퇴교', phone: room.settings?.coordinatorName };
                        }
                    });

                    if(tReq) {
                        td.className = 'block-teacher'; td.innerText = tReq.prof + "\n" + tReq.dir.split('→')[1];
                        td.onclick = () => showPop('강사수송', tReq, dateKey);
                    } else if(sReq) {
                        td.className = 'block-departure'; td.innerText = "교육생\n퇴교";
                        td.onclick = () => showPop('교육생퇴교', sReq, dateKey);
                    } else if(h === 12) {
                        td.className = 'block-lunch'; td.innerText = "점심";
                    }
                }
                row.appendChild(td);
            }
            body.appendChild(row);
        }
    }

    function openDaySetting(date, dayNm) {
        selectedDayToOff = date;
        document.getElementById('day-pop-title').innerText = `${date} (${dayNm}) 운행 설정`;
        document.getElementById('daySettingModal').style.display = 'flex';
    }

    async function confirmNoOperation() {
        const reason = document.getElementById('no-op-reason').value.trim() || "차량 정비 및 내부 사정";
        if(!confirm(`정말 ${selectedDayToOff} 운행을 중단할까요?\n관련 모든 예약이 자동 취소됩니다.`)) return;

        // 1. 해당 날짜 모든 예약 삭제
        teacherRequests.filter(r => r.date === selectedDayToOff).forEach(r => firebase.database().ref(`system/transport_requests/${r.id}`).remove());
        Object.keys(allCourses).forEach(rid => { if(allCourses[rid].shuttle?.departure?.date === selectedDayToOff) firebase.database().ref(`courses/${rid}/shuttle/departure`).remove(); });

        // 2. 운행중단 데이터 및 전체 공지 등록
        await firebase.database().ref('system/transport_requests').push({ date: selectedDayToOff, prof: '운행중단', status: 'approved', time: '00:00' });
        await firebase.database().ref('system/shuttle_notice').set(`${selectedDayToOff}은 ${reason}으로 인해 차량 운행을 하지 않습니다.`);
        
        alert("운행 중단 처리가 완료되었습니다.");
        document.getElementById('daySettingModal').style.display = 'none';
        document.getElementById('no-op-reason').value = "";
    }

    // --- 유틸리티 ---
    function switchTab(n) {
        currentTab = n;
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i+1 === n));
        document.getElementById('view-1').style.display = n === 1 ? 'flex' : 'none';
        document.getElementById('view-2').style.display = n === 2 ? 'flex' : 'none';
        document.getElementById('view-3').style.display = n === 3 ? 'flex' : 'none';
        if(n === 2) renderInstructorList();
        if(n === 3) renderSchedule();
    }

    function getWeekDates() {
        const today = new Date();
        const start = new Date(today);
        start.setDate(today.getDate() + (weekOffset * 7) - (today.getDay() === 0 ? 6 : today.getDay() - 1));
        const days = [];
        for(let i=0; i<5; i++) {
            const d = new Date(start); d.setDate(start.getDate() + i);
            days.push(d.toISOString().split('T')[0]);
        }
        return days;
    }

    function changeWeek(n) { weekOffset += n; if(currentTab===2) renderInstructorList(); if(currentTab===3) renderSchedule(); }

    function makeCall(phone) {
        if(!phone || phone === '미등록') return alert("번호 정보가 없습니다.");
        if(confirm(`${phone} 번호로 전화를 연결하시겠습니까?`)) location.href = "tel:" + phone.replace(/[^0-9]/g, '');
    }

    function showPop(type, data, date) {
        const modal = document.getElementById('detailModal');
        document.getElementById('pop-loc').innerText = data.dir?.split('→')[0] || (data.loc || '항기원');
        document.getElementById('pop-time').innerText = data.time;
        document.getElementById('pop-date').innerText = date;
        document.getElementById('pop-target').innerText = data.prof;
        document.getElementById('pop-phone').innerText = data.phone || "미등록";
        document.getElementById('pop-call-btn').onclick = () => makeCall(data.phone);
        modal.style.display = 'flex';
    }

    function saveGlobalShuttleNotice() {
        const msg = document.getElementById('driver-global-notice').value;
        firebase.database().ref('system/shuttle_notice').set(msg).then(() => alert("전체 공지가 저장되었습니다."));
    }

    function startClock() {
        setInterval(() => {
            const now = new Date();
            document.getElementById('footer-clock').innerText = now.toLocaleTimeString();
        }, 1000);
    }

    init();
  </script>
</body>
</html>