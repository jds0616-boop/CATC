<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>í•­ê³µê¸°ìˆ í›ˆë ¨ì› ì°¨ëŸ‰ì§€ì› ì‹œìŠ¤í…œ (ê¸°ì‚¬ìš©)</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
<style>
    :root {
      --navy: #0f172a; --blue: #0ea5e9; --blue-deep: #0369a1;
      --bg: #f1f5f9; --card: #ffffff; --border: #e2e8f0;
      --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
    body { margin: 0; padding: 0; background: #cfd8e3; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }
    
    /* ì•± ì»¨í…Œì´ë„ˆ ë° í—¤ë” */
    .app-container { width: 100%; max-width: 600px; height: 100%; background: var(--bg); display: flex; flex-direction: column; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.2); }
    .app-header { height: 60px; background: var(--navy); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-bottom: 2px solid var(--blue); z-index: 1000; }
    .header-left { display: flex; align-items: center; gap: 15px; color: #fff; font-size: 20px; }
    .header-title { font-size: 16px; font-weight: 900; color: #fff; letter-spacing: -0.5px; }

    /* ì‚¬ì´ë“œë°” (í–„ë²„ê±° ë©”ë‰´) */
    .sidebar { position: absolute; top: 0; left: -280px; width: 280px; height: 100%; background: #fff; z-index: 10000; transition: 0.3s; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
    .sidebar.open { left: 0; }
    .sidebar-header { padding: 30px 20px; background: var(--navy); color: #fff; }
    .sidebar-menu { padding: 10px; }
    .menu-item { padding: 15px; display: flex; align-items: center; gap: 12px; font-weight: 700; color: #334155; border-radius: 8px; cursor: pointer; }
    .menu-item:hover { background: #f1f5f9; }
    .sidebar-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; }

    /* íƒ­ ë°” */
    .tab-bar { display: flex; background: #fff; border-bottom: 1px solid var(--border); flex-shrink: 0; box-shadow: var(--shadow); }
    .tab-btn { flex: 1; padding: 14px 0; border: none; background: none; font-size: 12px; font-weight: 800; color: #94a3b8; cursor: pointer; border-bottom: 3px solid transparent; position: relative; }
    .tab-btn.active { color: var(--blue-deep); border-bottom-color: var(--blue); background: #f8fafc; }
    .badge { position: absolute; top: 5px; right: 5px; background: var(--danger); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; display: none; }

    /* ì½˜í…ì¸  ì˜ì—­ */
    .app-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }

    /* ì¢…í•© ì¼ì •í‘œ í…Œì´ë¸” */
    .schedule-wrapper { background: #fff; border: 1.5px solid #334155; border-radius: 8px; overflow: hidden; }
    .schedule-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .schedule-table th, .schedule-table td { border: 1px solid #e2e8f0; text-align: center; height: 48px; font-size: 11px; vertical-align: middle; position: relative; }
    .schedule-table th { background: #f8fafc; font-weight: 900; color: var(--navy); border-bottom: 2px solid var(--navy); font-size: 10px; }
    .time-col { width: 42px; background: #f1f5f9 !important; font-weight: 800; border-right: 2px solid var(--navy) !important; }
    .diagonal-off { background: linear-gradient(to top right, transparent 48%, #cbd5e1 48%, #cbd5e1 52%, transparent 52%); }

    /* ìˆ˜ì§í˜• ì±„íŒ… ë¦¬ìŠ¤íŠ¸ (ê°•ì‚¬ìˆ˜ì†¡) */
    .chat-container { background: #abc1d1; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; gap: 12px; min-height: 100%; }
    .req-card { background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
    .req-status { font-size: 11px; font-weight: 800; margin-bottom: 5px; }
    .req-time { font-size: 16px; font-weight: 900; color: #1e293b; }
    .req-route { font-size: 13px; font-weight: 700; color: var(--blue-deep); margin: 4px 0; }
    .req-prof { font-size: 14px; font-weight: 800; display: flex; align-items: center; justify-content: space-between; }
    .req-btn-group { display: flex; gap: 8px; margin-top: 10px; }
    .btn-smart { flex: 1; height: 38px; border-radius: 8px; border: none; font-weight: 800; font-size: 13px; cursor: pointer; }
    .btn-approve { background: var(--blue); color: #fff; }
    .btn-cancel { background: #f1f5f9; color: #64748b; }
    .msg-bubble-reply { background: #fee500; align-self: flex-end; padding: 10px 15px; border-radius: 15px 0 15px 15px; font-size: 12px; font-weight: 800; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .msg-cancel-alert { background: rgba(0,0,0,0.4); color: #fff; font-size: 11px; padding: 5px 15px; border-radius: 20px; text-align: center; margin: 10px 0; }

    /* êµìœ¡ìƒ í‡´êµ ê´€ë¦¬ */
    .trainee-row { background: #fff; border-radius: 12px; padding: 15px; border: 1px solid var(--border); box-shadow: var(--shadow); }
    .row-title { font-weight: 900; font-size: 14px; margin-bottom: 10px; color: var(--navy); display: flex; justify-content: space-between; }
    .dep-input-group { display: flex; gap: 5px; margin-top: 10px; }
    .dep-btn { flex: 1; height: 34px; border-radius: 6px; border: 1px solid var(--border); background: #fff; font-size: 12px; font-weight: 800; cursor: pointer; }
    .dep-btn.active { background: var(--navy); color: #fff; border-color: var(--navy); }
    .direct-input { flex: 1.5; padding: 0 10px; border-radius: 6px; border: 1.5px solid var(--blue); font-size: 12px; font-weight: 800; }

    /* ê¸ˆì¼ ì¼ì • (íƒ€ì„ë¼ì¸) */
    .timeline-item { display: flex; gap: 15px; padding-left: 10px; border-left: 3px solid var(--blue); margin-bottom: 15px; position: relative; }
    .timeline-item::before { content: ''; position: absolute; left: -7px; top: 0; width: 11px; height: 11px; background: var(--blue); border-radius: 50%; }
    .tm-time { font-weight: 900; font-size: 14px; color: var(--navy); min-width: 50px; }
    .tm-content { background: #fff; padding: 12px; border-radius: 10px; flex: 1; box-shadow: var(--shadow); }

    /* ê³µí†µ ë²„íŠ¼ */
    .today-btn { background: #fff; border: 1.5px solid var(--navy); padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 800; cursor: pointer; }
    .capture-btn { width: 100%; height: 45px; background: var(--navy); color: #fff; border-radius: 12px; font-weight: 800; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }

    /* ëª¨ë‹¬ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; padding: 20px; }
    .modal-box { background: #fff; width: 100%; max-width: 400px; border-radius: 20px; padding: 25px; }
    .m-btn { width: 100%; height: 48px; border-radius: 10px; font-weight: 800; font-size: 15px; margin-top: 10px; border: none; cursor: pointer; }
    .m-ok { background: var(--blue); color: #fff; }
</style>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>

<div class="sidebar-overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div style="font-size:18px; font-weight:900;">ê¸°ì‚¬ ì „ìš© ì„¤ì •</div>
        <div style="font-size:12px; opacity:0.8; margin-top:5px;">ìš´í–‰ ì œì–´ ë° ê³µì§€ ê´€ë¦¬</div>
    </div>
    <div class="sidebar-menu">
        <div class="menu-item" onclick="setDayOff()">
            <i class="fa-solid fa-calendar-xmark"></i> ìš´í–‰ë¶ˆê°€ ê³µì§€ (ì—°ì°¨/ì ê²€)
        </div>
        <div class="menu-item" onclick="clearFinished()">
            <i class="fa-solid fa-trash-can"></i> ì™„ë£Œëœ ëª©ë¡ ì¼ê´„ ì‚­ì œ
        </div>
        <div class="menu-item" onclick="location.href='potal.html'">
            <i class="fa-solid fa-right-from-bracket"></i> ì‹œìŠ¤í…œ ë¡œê·¸ì•„ì›ƒ
        </div>
    </div>
</div>

<div class="app-container">
  <header class="app-header">
    <div class="header-left">
        <i class="fa-solid fa-bars" onclick="toggleSidebar()"></i>
    </div>
    <div class="header-title">í•­ê³µê¸°ìˆ í›ˆë ¨ì› ì°¨ëŸ‰ì§€ì›</div>
    <div style="width:24px;"></div> <!-- ìš°ì¸¡ ë°¸ëŸ°ìŠ¤ -->
  </header>

  <div class="tab-bar">
    <button id="tab0" class="tab-btn active" onclick="switchTab(0)">ì¢…í•© ì¼ì •í‘œ</button>
    <button id="tab1" class="tab-btn" onclick="switchTab(1)">ê¸ˆì¼ ì¼ì •</button>
    <button id="tab2" class="tab-btn" onclick="switchTab(2)">ê°•ì‚¬ ìˆ˜ì†¡ <span id="badge-count" class="badge">0</span></button>
    <button id="tab3" class="tab-btn" onclick="switchTab(3)">êµìœ¡ìƒ í‡´êµ</button>
  </div>

  <main class="app-content" id="main-content">
    <!-- íƒ­ 0: ì¢…í•© ì¼ì •í‘œ -->
    <div id="view-0" style="display: block;">
      <div id="capture-area" style="padding: 10px; background: var(--bg); border-radius: 12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <button class="today-btn" onclick="goToday()">ì˜¤ëŠ˜</button>
          <div style="display:flex; align-items:center; gap:15px;">
            <i class="fa-solid fa-chevron-left" onclick="changeWeek(-1)"></i>
            <span id="week-range" style="font-weight:900; font-size:14px; color:var(--navy);">ë‚ ì§œ ê³„ì‚° ì¤‘...</span>
            <i class="fa-solid fa-chevron-right" onclick="changeWeek(1)"></i>
          </div>
        </div>
        <div class="schedule-wrapper">
          <table class="schedule-table">
            <thead id="sched-head"></thead>
            <tbody id="sched-body"></tbody>
          </table>
        </div>
      </div>
      <button class="capture-btn" onclick="captureSchedule()" style="margin-top:10px;">
        <i class="fa-solid fa-camera"></i> ì¼ì •í‘œ ìº¡ì³ ì €ì¥
      </button>
    </div>

    <!-- íƒ­ 1: ê¸ˆì¼ ì¼ì • -->
    <div id="view-1" style="display: none;">
      <div id="today-timeline-container"></div>
    </div>

    <!-- íƒ­ 2: ê°•ì‚¬ ìˆ˜ì†¡ ë¦¬ìŠ¤íŠ¸ -->
    <div id="view-2" style="display: none; height:100%;">
      <div class="chat-container" id="chat-list-inner"></div>
    </div>

    <!-- íƒ­ 3: êµìœ¡ìƒ í‡´êµ ê´€ë¦¬ -->
    <div id="view-3" style="display: none;">
      <div id="trainee-management-list"></div>
    </div>
  </main>
</div>

<!-- ê³µìš© ì•Œë¦¼ ëª¨ë‹¬ -->
<div id="alertModal" class="modal-overlay" onclick="if(event.target==this) closeModal('alertModal')">
  <div class="modal-box">
    <div id="alert-title" style="font-size:18px; font-weight:900; margin-bottom:10px;">ì•Œë¦¼</div>
    <div id="alert-content" style="font-size:14px; color:#475569; line-height:1.6; margin-bottom:20px;">ë‚´ìš©</div>
    <button class="m-btn m-ok" onclick="closeModal('alertModal')">í™•ì¸</button>
  </div>
</div>

<script src="config.js"></script>
<script>
  let allCourses = {};
  let profReqs = [];
  let weekOffset = 0;
  let currentTab = 0;
  const alarmAudio = new Audio('timer.mp3');

  // [ì¤‘ìš”] ê¸ˆìš”ì¼ ìì • ì°¨ì£¼ ì „í™˜ ë¡œì§
  function checkFridaySwitch() {
    const now = new Date();
    if (now.getDay() === 5 || now.getDay() === 6 || now.getDay() === 0) { // ê¸ˆ,í† ,ì¼
        if (weekOffset === 0) weekOffset = 1; 
    }
  }

  function init() {
    checkFridaySwitch();
    
    // 1. êµìœ¡ ê³¼ì • ë°ì´í„° ê°ì‹œ
    firebase.database().ref('courses').on('value', snap => {
      allCourses = snap.val() || {};
      renderAll();
    });

    // 2. ìˆ˜ì†¡ ìš”ì²­ ë°ì´í„° ê°ì‹œ
    firebase.database().ref('system/transport_requests').on('value', snap => {
      const raw = snap.val() || {};
      const now = new Date();
      
      let pendingCount = 0;
      profReqs = Object.keys(raw).map(k => {
        const item = { id: k, ...raw[k] };
        if(item.status === 'pending' && item.prof !== 'ìš´í–‰ì¤‘ë‹¨') pendingCount++;
        
        // ìë™ ë§ˆê° ë¡œì§ (2ì‹œê°„ ê²½ê³¼ ì‹œ)
        if (item.status === 'approved' && item.date && item.time) {
          const scheduled = new Date(item.date + ' ' + item.time);
          if (now > new Date(scheduled.getTime() + 2 * 60 * 60 * 1000)) {
            firebase.database().ref(`system/transport_requests/${k}/status`).set('finished');
          }
        }
        return item;
      }).sort((a,b) => b.timestamp - a.timestamp);

      // ë°°ì§€ ì—…ë°ì´íŠ¸
      const badge = document.getElementById('badge-count');
      if(pendingCount > 0) {
        badge.innerText = pendingCount;
        badge.style.display = 'block';
        if(pendingCount > parseInt(badge.dataset.prev || 0)) alarmAudio.play().catch(()=>{});
      } else {
        badge.style.display = 'none';
      }
      badge.dataset.prev = pendingCount;

      renderAll();
    });
  }

  // ì§€ëŠ¥í˜• AI í•©ìŠ¹ ì œì•ˆ ë¡œì§
  const RouteManager = {
    INTERVAL: 30, // êµ¬ê°„ë‹¹ 30ë¶„
    points: ['ì²­ì£¼ê³µí•­', 'ì²­ì£¼í„°ë¯¸ë„', 'ì˜¤ì†¡ì—­', 'í•­ê¸°ì›'],

    analyze: function(newReq) {
      if(newReq.prof === 'ìš´í–‰ì¤‘ë‹¨') return null;
      
      const targetArriveTime = 50; // xx:50ë¶„ ë„ì°© ì›ì¹™
      const newTimeParts = newReq.time.split(':');
      const newHour = parseInt(newTimeParts[0]);
      const newMin = parseInt(newTimeParts[1]);

      // ê°™ì€ ë‚ , ìŠ¹ì¸ëœ ë‹¤ë¥¸ ìš”ì²­ ì°¾ê¸°
      const others = profReqs.filter(r => r.id !== newReq.id && r.date === newReq.date && r.status === 'approved');
      
      for(let other of others) {
        const oTime = other.time.split(':');
        if (Math.abs(parseInt(oTime[0]) - newHour) <= 1) { // 1ì‹œê°„ ì´ë‚´ ì¼ì •ë“¤
            const msg = `ğŸ’¡ [AI ë¶„ì„]\n${other.prof}ë‹˜(${other.time})ê³¼ í•©ìŠ¹ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.\nì •ì‹œ 10ë¶„ ì „ ë„ì°©ì„ ìœ„í•´ ë…¸ì„  í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.`;
            return msg;
        }
      }
      return null;
    }
  };

  // ---------------- UI ë Œë”ë§ í•¨ìˆ˜ë“¤ ----------------

  function renderAll() {
    renderSchedule();
    renderTodayTimeline();
    renderInstructorChat();
    renderTraineeManagement();
  }

  // 1. ì¢…í•© ì¼ì •í‘œ
  function renderSchedule() {
    const head = document.getElementById('sched-head');
    const body = document.getElementById('sched-body');
    const range = getWeekDates(weekOffset);
    if (!head || !body) return;

    document.getElementById('week-range').innerText = `${range[0]} ~ ${range[4].substring(5)}`;
    head.innerHTML = `<tr><th class="time-col">ì‹œê°„</th>${['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'].map((day, i) => `<th>${range[i].substring(5)}<br>${day}</th>`).join('')}</tr>`;

    let html = '';
    for(let h=8; h<=18; h++) {
      html += `<tr><td class="time-col">${h}:00</td>`;
      for(let d=0; d<5; d++) {
        const curDate = range[d];
        const isOff = profReqs.some(r => r.date === curDate && r.prof === 'ìš´í–‰ì¤‘ë‹¨');
        
        let cell = '';
        if(isOff) {
            cell = `<div class="diagonal-off" style="width:100%; height:100%;"></div>`;
        } else if(h === 12) {
            cell = `<span style="color:#cbd5e1; font-size:9px;">íœ´ê²Œ</span>`;
        } else {
            // ê°•ì‚¬ ìˆ˜ì†¡ ë°ì´í„° í‘œì‹œ
            const matched = profReqs.filter(r => (r.status === 'approved' || r.status === 'finished') && r.date === curDate && parseInt(r.time.split(':')[0]) === h);
            if(matched.length > 0) {
                cell = `<div style="background:var(--blue-deep); color:#fff; border-radius:4px; font-size:9px; padding:2px;">ê°•ì‚¬ ${matched.length}</div>`;
            }
            // í‡´êµ ìˆ˜ì†¡ ë°ì´í„° í‘œì‹œ
            for(let rid in allCourses) {
                const dep = allCourses[rid]?.shuttle?.departure;
                if(dep && dep.date === curDate && parseInt(dep.time.split(':')[0]) === h) {
                    cell = `<div style="background:var(--success); color:#fff; border-radius:4px; font-size:9px; padding:2px;">í‡´êµ</div>`;
                }
            }
        }
        html += `<td>${cell}</td>`;
      }
      html += `</tr>`;
    }
    body.innerHTML = html;
  }

  // 2. ê¸ˆì¼ ì¼ì • íƒ€ì„ë¼ì¸
  function renderTodayTimeline() {
    const container = document.getElementById('today-timeline-container');
    const today = new Date().toISOString().split('T')[0];
    let items = [];

    // ê°•ì‚¬ ì¼ì • ì¶”ê°€
    profReqs.filter(r => r.date === today && (r.status==='approved' || r.status==='finished') && r.prof !== 'ìš´í–‰ì¤‘ë‹¨').forEach(r => {
        items.push({ time: r.time, content: `[ê°•ì‚¬ìˆ˜ì†¡] ${r.prof} ê°•ì‚¬ë‹˜ (${r.dir})`, type: 'prof' });
    });

    // í•™ìƒ í‡´êµ ì¶”ê°€
    Object.keys(allCourses).forEach(rid => {
        const dep = allCourses[rid]?.shuttle?.departure;
        if(dep && dep.date === today && dep.time) {
            const count = Object.values(allCourses[rid].shuttle?.requests || {}).filter(v => v.type !== 'car').length;
            items.push({ time: dep.time, content: `[í•™ìƒí‡´êµ] ${allCourses[rid].settings?.courseName} (${count}ëª…)`, type: 'student' });
        }
    });

    items.sort((a,b) => a.time.localeCompare(b.time));

    if(items.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:50px; color:#94a3b8; font-weight:800;">ê¸ˆì¼ ì˜ˆì •ëœ ìˆ˜ì†¡ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
    }

    container.innerHTML = items.map(item => `
        <div class="timeline-item">
            <div class="tm-time">${item.time}</div>
            <div class="tm-content">
                <div style="font-weight:800; color:var(--navy);">${item.content}</div>
                <div style="font-size:11px; color:var(--blue); margin-top:5px;">${item.type==='prof' ? 'â— ì •ì‹œ 10ë¶„ì „ ë„ì°© ì¤€ìˆ˜' : 'â— ì•ˆì „ìš´í–‰'}</div>
            </div>
        </div>
    `).join('');
  }

  // 3. ê°•ì‚¬ ìˆ˜ì†¡ ë¦¬ìŠ¤íŠ¸ (ì±„íŒ… í˜•íƒœ)
  function renderInstructorChat() {
    const box = document.getElementById('chat-list-inner');
    if(!box) return;

    let html = "";
    // ìš´í–‰ ì¤‘ë‹¨ ì œì™¸í•œ ê°•ì‚¬ ìš”ì²­ë§Œ í‘œì‹œ
    const filtered = profReqs.filter(r => r.prof !== 'ìš´í–‰ì¤‘ë‹¨');

    filtered.forEach(r => {
      const isPending = r.status === 'pending';
      const isApproved = r.status === 'approved';
      const isFinished = r.status === 'finished';
      const isCancelled = r.status === 'cancelled';

      if(isCancelled) {
          html += `<div class="msg-cancel-alert">ì•Œë¦¼: ${r.date} ${r.prof} ê°•ì‚¬ë‹˜ ìˆ˜ì†¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>`;
          return;
      }

      html += `
        <div class="req-card" style="${isFinished ? 'opacity:0.6' : ''}">
            <div class="req-status" style="color:${isPending ? 'var(--danger)' : 'var(--success)'}">
                ${isPending ? 'â— ì‹ ê·œ ìš”ì²­' : (isApproved ? 'âœ“ ìŠ¹ì¸ ì™„ë£Œ' : 'âœ… ìš´í–‰ ì™„ë£Œ')}
            </div>
            <div class="req-time">${r.date} (${r.time})</div>
            <div class="req-route">${r.dir}</div>
            <div class="req-prof">
                <span>${r.prof} ê°•ì‚¬ë‹˜</span>
                <a href="tel:${r.phone}" style="color:var(--blue); text-decoration:none;"><i class="fa-solid fa-phone"></i></a>
            </div>
            ${isPending ? `
                <div class="req-btn-group">
                    <button class="btn-smart btn-approve" onclick="approveRequest('${r.id}')">ìŠ¹ì¸í•˜ê¸°</button>
                    <button class="btn-smart btn-cancel" onclick="cancelRequest('${r.id}')">ë¶ˆê°€</button>
                </div>
            ` : (isApproved ? `
                <div class="req-btn-group">
                    <button class="btn-smart btn-cancel" style="width:100%" onclick="cancelRequest('${r.id}')">ìŠ¹ì¸ ì·¨ì†Œ</button>
                </div>
            ` : '')}
        </div>
        ${(isApproved || isFinished) ? `<div class="msg-bubble-reply">${isFinished ? 'ìš´í–‰ì„ ë§ˆì³¤ìŠµë‹ˆë‹¤.' : 'í™•ì¸í–ˆìŠµë‹ˆë‹¤. ì‹œê°„ ë§ì¶° ê°€ê² ìŠµë‹ˆë‹¤!'}</div>` : ''}
      `;
    });

    box.innerHTML = html || `<div style="text-align:center; padding:50px; color:#fff; font-weight:800;">ìš”ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    // ìŠ¤í¬ë¡¤ ìµœí•˜ë‹¨
    if(currentTab === 2) box.scrollTop = box.scrollHeight;
  }

  // 4. êµìœ¡ìƒ í‡´êµ ê´€ë¦¬
  function renderTraineeManagement() {
    const list = document.getElementById('trainee-management-list');
    let html = "";

    Object.keys(allCourses).forEach(rid => {
        const room = allCourses[rid];
        if(room.status?.roomStatus !== 'active') return;
        const dep = room.shuttle?.departure || { time: "" };
        const total = Object.values(room.shuttle?.requests || {}).filter(r => r.type !== 'car').length;

        html += `
            <div class="trainee-row">
                <div class="row-title">
                    <span>${room.settings?.courseName}</span>
                    <span style="color:var(--blue)">ì´ ${total}ëª…</span>
                </div>
                <div style="font-size:11px; color:#64748b;">ì¶œë°œ ì‹œê°„ ê³µì§€</div>
                <div class="dep-input-group">
                    <button class="dep-btn ${dep.time==='13:00'?'active':''}" onclick="setDeparture('${rid}', '13:00')">13:00</button>
                    <button class="dep-btn ${dep.time==='15:00'?'active':''}" onclick="setDeparture('${rid}', '15:00')">15:00</button>
                    <input type="time" class="direct-input" id="direct-${rid}" onchange="setDeparture('${rid}', this.value)">
                </div>
                <div style="margin-top:10px; font-size:12px; font-weight:800;">
                    ê³µì§€ ìƒíƒœ: ${dep.time ? '<span style="color:var(--success)">âœ… ê³µì§€ì™„ë£Œ</span>' : '<span style="color:var(--danger)">âŒ ë¯¸ê³µì§€</span>'}
                </div>
            </div>
        `;
    });

    list.innerHTML = html || `<div style="text-align:center; padding:50px; color:#94a3b8; font-weight:800;">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }

  // ---------------- ì•¡ì…˜ í•¨ìˆ˜ë“¤ ----------------

  async function approveRequest(id) {
    const req = profReqs.find(r => r.id === id);
    const advice = RouteManager.analyze(req);
    if(advice) {
        if(!confirm(advice + "\n\nê·¸ë˜ë„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    }
    await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'approved' });
  }

  async function cancelRequest(id) {
    if(!confirm("ë¶ˆê°€(ë˜ëŠ” ì·¨ì†Œ) ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'cancelled' });
  }

  async function setDeparture(rid, time) {
    await firebase.database().ref(`courses/${rid}/shuttle/departure`).update({ time });
  }

  async function setDayOff() {
    const date = prompt("ìš´í–‰ ë¶ˆê°€ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2025-01-29)", new Date().toISOString().split('T')[0]);
    if(!date) return;
    const reason = prompt("ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì—°ì°¨, ê±´ê°•ê²€ì§„, ì°¨ëŸ‰ìˆ˜ë¦¬ ë“±)", "ì°¨ëŸ‰ ì ê²€");
    if(!reason) return;

    // 1. ìš´í–‰ ë¶ˆê°€ ë°ì´í„° ë“±ë¡
    await firebase.database().ref('system/transport_requests').push({
        date, prof: 'ìš´í–‰ì¤‘ë‹¨', dir: reason, status: 'approved', time: '00:00', timestamp: Date.now()
    });

    // 2. í•´ë‹¹ ë‚ ì§œ ê¸°ì¡´ ì˜ˆì•½ ìë™ ì·¨ì†Œ ì—°ë™
    const conflicts = profReqs.filter(r => r.date === date && r.prof !== 'ìš´í–‰ì¤‘ë‹¨');
    for(let c of conflicts) {
        await firebase.database().ref(`system/transport_requests/${c.id}`).update({ status: 'cancelled' });
    }

    toggleSidebar();
    alert(`${date} ìš´í–‰ ë¶ˆê°€ ì„¤ì • ë° í•´ë‹¹ ë‚ ì§œ ê¸°ì¡´ ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
  }

  async function clearFinished() {
    if(!confirm("ì™„ë£Œë˜ê±°ë‚˜ ì·¨ì†Œëœ ë‚´ì—­ì„ ëª©ë¡ì—ì„œ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const targets = profReqs.filter(r => r.status === 'finished' || r.status === 'cancelled');
    for(let t of targets) {
        await firebase.database().ref(`system/transport_requests/${t.id}`).remove();
    }
    toggleSidebar();
  }

  // ---------------- í—¬í¼ í•¨ìˆ˜ ----------------

  function switchTab(n) {
    currentTab = n;
    document.querySelectorAll('.tab-btn').forEach((btn, i) => btn.classList.toggle('active', i === n));
    document.querySelectorAll('[id^="view-"]').forEach((v, i) => v.style.display = i === n ? 'block' : 'none');
  }

  function toggleSidebar() {
    const sb = document.getElementById('sidebar');
    const ol = document.querySelector('.sidebar-overlay');
    const isOpen = sb.classList.contains('open');
    sb.classList.toggle('open', !isOpen);
    ol.style.display = isOpen ? 'none' : 'block';
  }

  function getWeekDates(offset) {
    const now = new Date();
    const day = now.getDay();
    const diff = (day === 0 ? 1 : 1 - day);
    const mon = new Date(now);
    mon.setDate(now.getDate() + diff + (offset * 7));
    const res = [];
    for(let i=0; i<5; i++) {
        const d = new Date(mon);
        d.setDate(mon.getDate()+i);
        res.push(d.toISOString().split('T')[0]);
    }
    return res;
  }

  function changeWeek(n) { weekOffset += n; renderAll(); }
  function goToday() { weekOffset = 0; checkFridaySwitch(); renderAll(); }
  function closeModal(id) { document.getElementById(id).style.display = 'none'; }

  async function captureSchedule() {
    const area = document.getElementById('capture-area');
    const canvas = await html2canvas(area, { backgroundColor: "#f1f5f9", scale: 2 });
    const link = document.createElement('a');
    link.download = `ìˆ˜ì†¡ì¼ì •í‘œ_${new Date().toISOString().split('T')[0]}.png`;
    link.href = canvas.toDataURL();
    link.click();
  }

  init();
</script>

</body>
</html>