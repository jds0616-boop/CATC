<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>í•­ê³µê¸°ìˆ í›ˆë ¨ì› ì°¨ëŸ‰ì§€ì›ì‹œìŠ¤í…œ</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
    :root {
      --navy: #0f172a; --blue: #0ea5e9; --blue-deep: #0369a1;
      --bg: #f1f5f9; --card: #ffffff; --border: #e2e8f0;
      --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
    body { margin: 0; padding: 0; background: #cfd8e3; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }
    
    .app-container { width: 100%; max-width: 600px; height: 100%; background: var(--bg); display: flex; flex-direction: column; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.2); }
    .app-header { height: 60px; background: var(--navy); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1000; }
    .header-btn { color: #fff; font-size: 20px; font-weight: 900; cursor: pointer; padding: 10px; }
    .header-title { font-size: 16px; font-weight: 900; color: #fff; letter-spacing: -0.5px; }

    .sidebar { position: absolute; top: 0; right: -280px; width: 280px; height: 100%; background: #fff; z-index: 10000; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.2); }
    .sidebar.open { right: 0; }
    .sidebar-header { padding: 30px 20px; background: var(--navy); color: #fff; }
    .sidebar-menu { padding: 10px; }
    .menu-item { padding: 15px; display: flex; align-items: center; gap: 12px; font-weight: 700; color: #334155; border-radius: 8px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }

    .tab-bar { display: flex; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.08); flex-shrink: 0; }
    .tab-btn { flex: 1; padding: 14px 0; border: none; background: none; font-size: 11px; font-weight: 800; color: #94a3b8; cursor: pointer; border-bottom: 3px solid transparent; position: relative; }
    .tab-btn.active { color: var(--blue-deep); border-bottom-color: var(--blue); background: #f8fafc; }
    .badge { position: absolute; top: 5px; right: 5px; background: var(--danger); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; }

    .app-content { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }

    .schedule-wrapper { background: #fff; border: 2px solid #000; border-radius: 8px; overflow-x: auto; }
    .schedule-table { width: 100%; border-collapse: collapse; min-width: 450px; table-layout: fixed; }
    .schedule-table th, .schedule-table td { border: 1px solid #ddd; text-align: center; height: 45px !important; font-size: 10px; vertical-align: middle; position: relative; padding: 0 2px !important; overflow: hidden; }
    .cell-container { width: 100%; height: 100%; overflow-y: auto; display: flex; flex-direction: column; gap: 2px; }
    .schedule-table th { background: #f1f5f9; font-weight: 900; color: var(--navy); }
    .time-col { width: 50px; background: #f1f5f9 !important; font-weight: 800; border-right: 2px solid var(--navy) !important; }
    .drop-target { background-color: #e0f2fe !important; }
    .cell-event { border-radius: 4px; padding: 2px; height: 38px; font-size: 9px; font-weight: 800; line-height: 1.1; cursor: pointer; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .block-entry { background: #eff6ff; color: #1e40af; border: 1px solid #1e40af; }
    .block-prof { background: #fae8ff; color: #a21caf; border: 1px solid #a21caf; }
    .block-departure { background: #ecfdf5; color: #047857; border: 1px solid #047857; }
    .block-off { background: #fee2e2; color: #ef4444; border: 1px dashed #ef4444; position: relative; }
    .block-off::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(239,68,68,0.2) 5px, rgba(239,68,68,0.2) 10px); }
    .cell-íœ´ { background: #fafafa; color: #999; font-size: 9px; }


/* ë„ì°©(ë¹¨ê°•) ë° ì¶œë°œ(íŒŒë‘) ìƒ‰ìƒ ì •ì˜ */
    .block-arr { background: #fee2e2 !important; color: #991b1b !important; border: 1px solid #f87171 !important; } /* ë„ì°©: ì—°ë¹¨ê°• */
    .block-dep { background: #e0f2fe !important; color: #075985 !important; border: 1px solid #7dd3fc !important; } /* ì¶œë°œ: ì—°íŒŒë‘ */




    .chat-container { background: #abc1d1; padding: 10px; display: flex; flex-direction: column; gap: 8px; min-height: 100%; }
    .req-card { background: #fff; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); width: auto; max-width: 70%; position: relative; align-self: flex-start; font-size: 11px; line-height: 1.4; }
    .req-card.mine { align-self: flex-end; background: #fee500; }
    .req-card.mine::after { content: ''; position: absolute; top: 10px; right: -8px; border-left: 10px solid #fee500; border-bottom: 10px solid transparent; }
    .req-card:not(.mine)::after { content: ''; position: absolute; top: 10px; left: -8px; border-right: 10px solid #fff; border-bottom: 10px solid transparent; }
    .req-btn-group { display: flex; gap: 5px; margin-top: 8px; }
    .mini-btn { padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd; background: #fff; font-size: 11px; font-weight: 800; cursor: pointer; }
    .mini-btn.primary { background: var(--blue); color:#fff; border:none; }
    .cancel-notice { text-align: center; margin: 8px 0; }
    .cancel-notice span { background: rgba(0,0,0,0.1); padding: 4px 12px; border-radius: 10px; font-size: 10px; color: #666; }
    .req-card.mine[style*="grayscale"] { background: #d0d0d0 !important; }
    .req-card.mine[style*="grayscale"]::after { border-left-color: #d0d0d0 !important; }

    .list-wrapper { background: transparent; border: none; overflow: hidden; }
    .list-header { display: grid; grid-template-columns: 1.5fr 0.6fr 1.5fr 0.5fr; padding: 12px 15px; background: #f8fafc; border-radius: 12px; margin-bottom: 10px; font-size: 11px; font-weight: 800; color: #64748b; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .course-row { display: grid; grid-template-columns: 1.5fr 0.6fr 1.5fr 0.5fr; background: #fff; border-radius: 15px; margin-bottom: 8px; padding: 10px 5px; align-items: center; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #f1f5f9; transition: transform 0.2s; }
    .course-row:active { transform: scale(0.98); }
    .t-cell { padding: 8px 2px; font-size: 12px; font-weight: 700; color: var(--navy); }
    .count-badge { background: #e0f2fe; color: #0369a1; padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: 900; }
    .time-select-custom { width: 90%; padding: 8px; border-radius: 10px; border: 1.5px solid #e2e8f0; background: #fcfcfc; font-size: 12px; font-weight: 800; color: var(--blue-deep); text-align: center; outline: none; }
    .notice-btn { border: none; background: #f1f5f9; width: 36px; height: 36px; border-radius: 10px; font-size: 18px; cursor: pointer; color: #cbd5e1; transition: 0.3s; }
    .notice-btn.active { background: #d1fae5; color: var(--success); box-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }

    .timeline-card { background: #fff; border-radius: 10px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 8px; }
    .timeline-time { font-size: 16px; font-weight: 900; color: var(--blue-deep); margin-bottom: 8px; }
    .timeline-item { padding: 8px 0; border-left: 3px solid var(--blue); padding-left: 12px; margin-left: 5px; font-size: 12px; font-weight: 700; }
    .timeline-route { color: #047857; font-weight: 800; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; padding: 20px; }
    .modal-box { background: #fff; width: 100%; max-width: 400px; border-radius: 20px; padding: 20px; max-height: 90vh; overflow-y: auto; }
    .modal-input { width: 100%; height: 45px; border: 1.5px solid #ddd; border-radius: 8px; padding: 0 10px; margin-bottom: 10px; font-size: 14px; font-weight: 700; }

    .context-menu { position: absolute; background: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 5px; z-index: 15000; min-width: 120px; }
    .context-item { padding: 10px 15px; cursor: pointer; font-size: 12px; font-weight: 700; border-radius: 6px; display: flex; align-items: center; gap: 8px; }
    .context-item:hover { background: #f1f5f9; }
    .context-item.danger { color: var(--danger); }

    #view-0 { background: var(--bg); min-height: 100%; }
    #view-1 { background: var(--bg); min-height: 100%; }
    #view-2 { background: #abc1d1; min-height: 100%; } 
    #view-3 { background: var(--bg); min-height: 100%; }


    #prof-info-area { background: #e0f2fe !important; border: 1px solid #7dd3fc !important; } /* ê°•ì‚¬ì •ë³´: ì—°íŒŒë‘ */
    #route-info-area { background: #fef3c7 !important; border: 1px solid #fcd34d !important; } /* ì´ë™ì •ë³´: ì—°ë…¸ë‘ */
    #passengers-area { background: #dcfce7 !important; border: 1px solid #86efac !important; } /* ë™ìŠ¹ê°: ì—°ì´ˆë¡ */
    #off-reason-area { background: #fee2e2 !important; border: 1px solid #fecaca !important; } /* ìš´í–‰ë¶ˆê°€: ì—°ë¹¨ê°• */



</style>
</head>
<body>

<div class="sidebar-overlay" onclick="toggleSidebar()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header"><div style="font-size:18px; font-weight:900;">ê¸°ì‚¬ ì „ìš© ì„¤ì •</div></div>
    <div class="sidebar-menu">
        <div class="menu-item" onclick="captureSchedule()"><i class="fa-solid fa-camera"></i> ì¼ì •í‘œ ìº¡ì²˜</div>
    </div>
</div>

<div class="app-container">
  <header class="app-header">
    <div class="header-btn" onclick="handleBack()">&lt;&lt;</div>
    <div class="header-title">í•­ê³µê¸°ìˆ í›ˆë ¨ì› ì°¨ëŸ‰ì§€ì›</div>
    <div class="header-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>
  </header>

  <div class="tab-bar">
    <button id="tab0" class="tab-btn active" onclick="switchTab(0)">ì¢…í•©ì¼ì •í‘œ</button>
    <button id="tab1" class="tab-btn" onclick="switchTab(1)">ê¸ˆì¼ì¼ì •</button>
    <button id="tab2" class="tab-btn" onclick="switchTab(2)">ê°•ì‚¬ìˆ˜ì†¡ <span id="badge-count" class="badge" style="display:none;">0</span></button>
    <button id="tab3" class="tab-btn" onclick="switchTab(3)">í‡´êµìˆ˜ì†¡</button>
  </div>

<div id="loading-spinner" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:20000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; text-align:center;">
    <i class="fa-solid fa-spinner fa-spin" style="font-size:30px; color:var(--blue);"></i>
    <div style="margin-top:10px; font-weight:800;">ë°ì´í„° ë¡œë”©ì¤‘...</div>
  </div>
</div>

  <main class="app-content">
    <div id="view-0" style="display: block;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <button class="mini-btn primary" onclick="goToday()"><i class="fa-solid fa-calendar-day"></i> ì˜¤ëŠ˜</button>
          <div style="display:flex; align-items:center; gap:8px;">
            <i class="fa-solid fa-circle-chevron-left" style="font-size:22px; color:var(--blue); cursor:pointer;" onclick="changeWeek(-1)"></i>
            <span id="week-range" style="font-weight:900; font-size:13px; min-width:120px; text-align:center;">...</span>
            <i class="fa-solid fa-circle-chevron-right" style="font-size:22px; color:var(--blue); cursor:pointer;" onclick="changeWeek(1)"></i>
          </div>
          <button class="mini-btn" onclick="openNewSchedule()"><i class="fa-solid fa-plus"></i> ì‹ ê·œ</button>
        </div>
        <div class="schedule-wrapper" id="schedule-capture-area">
          <table class="schedule-table">
            <thead id="sched-head"></thead>
            <tbody id="sched-body"></tbody>
          </table>
        </div>
<!-- í‘œ ë°”ë¡œ ì•„ë˜ ìš°ì¸¡ ì •ë ¬ëœ ë²„íŠ¼ ì˜ì—­ -->
        <div style="display:flex; justify-content:flex-end; margin-top:10px;">
          <button class="mini-btn" style="background:var(--danger); color:white; padding:10px 15px; font-weight:bold;" onclick="openNewDayOff()">
            <i class="fa-solid fa-calendar-xmark"></i> ìš´í–‰ë¶ˆê°€ ì„¤ì •
          </button>
        </div>
    </div>

    <div id="view-1" style="display: none;">
      <div style="background:#fff; padding:10px; border-radius:8px; margin-bottom:10px; text-align:center;">
        <div style="font-size:16px; font-weight:900; color:var(--blue-deep);" id="today-date-display">ì˜¤ëŠ˜ì˜ ìˆ˜ì†¡ ì¼ì •</div>
      </div>
      <div id="today-timeline-container" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>

    <div id="view-2" style="display: none; height:100%; display:flex; flex-direction:column;">
      <div style="padding: 5px; background: #fff; border-bottom: 1px solid #ddd; display:flex; justify-content:flex-end; flex-shrink:0;">
        <button class="mini-btn" onclick="clearFinished()"><i class="fa-solid fa-broom"></i> ì™„ë£Œëª©ë¡ ì •ë¦¬</button>
      </div>
      <div style="flex:1; overflow-y:auto; background:#abc1d1;">
        <div class="chat-container" id="chat-list-inner"></div>
      </div>
    </div>

    <div id="view-3" style="display: none;">
      <div class="list-wrapper">
        <div class="list-header">
          <div>ê³¼ì •ëª…</div>
          <div>ì¸ì›</div>
          <div>ì¶œë°œì‹œê°„</div>
          <div>ê³µì§€</div>
        </div>
        <div id="trainee-list-body"></div>
      </div>
    </div>
  </main>
</div>

<!-- ìš´í–‰ë¶ˆê°€ ê³µì§€ ëª¨ë‹¬ -->
<div id="dayOffModal" class="modal-overlay" onclick="if(event.target==this) closeModal('dayOffModal')">
  <div class="modal-box">
    <div style="font-weight:900; font-size:17px; margin-bottom:15px; border-bottom:2px solid var(--danger); padding-bottom:8px;">ìš´í–‰ë¶ˆê°€ ì¼ì • ë“±ë¡</div>
    <input type="date" id="off-date" class="modal-input">
    <select id="off-reason" class="modal-input">
        <option value="ê±´ê°•ê²€ì§„">ê±´ê°•ê²€ì§„</option>
        <option value="ì—°ì°¨">ì—°ì°¨</option>
        <option value="ì°¨ëŸ‰ê³ ì¥">ì°¨ëŸ‰ê³ ì¥</option>
        <option value="ì§ì ‘ì…ë ¥">ì§ì ‘ì…ë ¥</option>
    </select>
    <input type="text" id="off-custom" class="modal-input" placeholder="ì§ì ‘ ì…ë ¥ ì‹œ ì‚¬ìœ ë¥¼ ì ì–´ì£¼ì„¸ìš”" style="display:none;">
    <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="modal-input" style="background:#f1f5f9; border:none;" onclick="closeModal('dayOffModal')">ì·¨ì†Œ</button>
        <button class="modal-input" style="background:var(--danger); color:#fff; border:none;" onclick="saveDayOff()">ë“±ë¡</button>
    </div>
  </div>
</div>

<!-- ì¼ì • ê´€ë¦¬ ëª¨ë‹¬ (ì‹ ê·œ/ìˆ˜ì •) -->
<div id="scheduleModal" class="modal-overlay" onclick="if(event.target==this) closeModal('scheduleModal')">
  <div class="modal-box">
    <div style="font-weight:900; font-size:17px; margin-bottom:15px; border-bottom:2px solid var(--blue); padding-bottom:8px;" id="schedule-modal-title">ì¼ì • ê´€ë¦¬</div>
    
    <input type="date" id="s-date" class="modal-input">
<div id="time-section">
  <input type="time" id="s-time" class="modal-input">
</div>

<select id="s-schedule-type" class="modal-input" onchange="toggleScheduleType()">
  <option value="prof">ê°•ì‚¬ ìˆ˜ì†¡</option>
  <option value="off">ìš´í–‰ ë¶ˆê°€</option>
</select>




    <div id="prof-info-area"  style="border:1px solid #e2e8f0; padding:12px; border-radius:10px; margin-bottom:10px; background:#fafafa;">
      <div style="font-size:12px; font-weight:800; color:#64748b; margin-bottom:8px;">ê°•ì‚¬ ì •ë³´</div>
      <input type="text" id="s-prof" class="modal-input" placeholder="ê°•ì‚¬ ì„±í•¨ (ì˜ˆ: í™ê¸¸ë™)" style="margin-bottom:5px;">
      <input type="tel" id="s-phone" class="modal-input" placeholder="ì—°ë½ì²˜" style="margin-bottom:0;">
    </div>

    <div id="route-info-area" style="border:1px solid #e2e8f0; padding:12px; border-radius:10px; margin-bottom:10px; background:#fafafa;">
      <div style="font-size:12px; font-weight:800; color:#64748b; margin-bottom:8px;">ì´ë™ ì •ë³´</div>
      <select id="s-dir-type" class="modal-input">
        <option value="arrival">í•­ê¸°ì› ë„ì°©</option>
        <option value="departure">í•­ê¸°ì› ì¶œë°œ</option>
      </select>
      <select id="s-dir-loc" class="modal-input">
        <option value="ì˜¤ì†¡ì—­">ì˜¤ì†¡ì—­</option>
        <option value="ì²­ì£¼ê³µí•­">ì²­ì£¼ê³µí•­</option>
        <option value="ì²­ì£¼í„°ë¯¸ë„">ì²­ì£¼í„°ë¯¸ë„</option>
        <option value="ì§ì ‘ì…ë ¥">ì§ì ‘ì…ë ¥</option>
      </select>
      <input type="text" id="s-dir-custom" class="modal-input" placeholder="ëª©ì ì§€ ì§ì ‘ ì…ë ¥" style="display:none;">
    </div>

    <div id="passengers-area" style="border:1px solid #e2e8f0; padding:12px; border-radius:10px; margin-bottom:10px; background:#fafafa;">
      <div style="font-size:12px; font-weight:800; color:#64748b; margin-bottom:8px;">ë™ìŠ¹ê° ì¶”ê°€</div>
      <div id="passengers-list" style="margin-bottom:8px;"></div>
      <button class="mini-btn" onclick="addPassenger()" style="width:100%;"><i class="fa-solid fa-user-plus"></i> ë™ìŠ¹ê° ì¶”ê°€</button>
    </div>


<!-- ğŸ”¥ ìš´í–‰ë¶ˆê°€ ì‚¬ìœ  ì…ë ¥ (ìˆ¨ê¹€ ìƒíƒœë¡œ ì‹œì‘) -->
<div id="off-reason-area" style="display:none; border:1px solid #e2e8f0; padding:12px; border-radius:10px; margin-bottom:10px; background:#fff3cd;">
  <div style="font-size:12px; font-weight:800; color:#856404; margin-bottom:8px;">ìš´í–‰ë¶ˆê°€ ì‚¬ìœ </div>
  <select id="s-off-reason" class="modal-input">
    <option value="ê±´ê°•ê²€ì§„">ê±´ê°•ê²€ì§„</option>
    <option value="ì—°ì°¨">ì—°ì°¨</option>
    <option value="ì°¨ëŸ‰ê³ ì¥">ì°¨ëŸ‰ê³ ì¥</option>
    <option value="ì§ì ‘ì…ë ¥">ì§ì ‘ì…ë ¥</option>
  </select>
  <input type="text" id="s-off-custom" class="modal-input" placeholder="ì‚¬ìœ ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”" style="display:none;">
</div>





    <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="modal-input" style="background:#f1f5f9; border:none; flex:1;" onclick="closeModal('scheduleModal')">ì·¨ì†Œ</button>
        <button id="delete-schedule-btn" class="modal-input" style="background:var(--danger); color:#fff; border:none; flex:1; display:none;" onclick="deleteSchedule()">ì‚­ì œ</button>
        <button class="modal-input" style="background:var(--blue); color:#fff; border:none; flex:1;" onclick="saveSchedule()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- í‡´êµ ì‹œê°„ í™•ì¸ ëª¨ë‹¬ -->
<div id="departureConfirmModal" class="modal-overlay" onclick="if(event.target==this) closeModal('departureConfirmModal')">
  <div class="modal-box" style="text-align:center;">
    <div style="font-size:18px; font-weight:900; margin-bottom:20px; color:var(--blue-deep);">
      <i class="fa-solid fa-bullhorn"></i> ê³µì§€ í™•ì¸
    </div>
    <div id="confirm-message" style="font-size:14px; font-weight:700; margin-bottom:20px; line-height:1.6;"></div>
    <div style="display:flex; gap:10px;">
      <button class="modal-input" style="background:#f1f5f9; border:none; flex:1;" onclick="closeModal('departureConfirmModal')">ì·¨ì†Œ</button>
      <button class="modal-input" style="background:var(--success); color:#fff; border:none; flex:1;" onclick="confirmDepartureNotice()">ê³µì§€ ì™„ë£Œ</button>
    </div>
  </div>
</div>

<div id="context-menu" class="context-menu" style="display:none;"></div>

<script src="config.js"></script>
<script>
  let allCourses = {}, profReqs = [], weekOffset = 0, currentTab = 0;
  let currentEditId = null, currentPassengers = [];
  let pendingDepartureData = null;

function init() {
  document.getElementById('loading-spinner').style.display = 'flex';

  const now = new Date();
  const day = now.getDay(); 
  weekOffset = (day === 5 || day === 6 || day === 0) ? 1 : 0;

  firebase.database().ref('courses').on('value', snap => { 
    allCourses = snap.val() || {}; 
    renderAll(); 
    document.getElementById('loading-spinner').style.display = 'none';
  });

  firebase.database().ref('system/transport_requests').on('value', snap => {
    const raw = snap.val() || {};
    let pendingCount = 0;
    profReqs = Object.keys(raw).map(k => {
      const item = { id: k, ...raw[k] };
      if(item.status === 'pending') pendingCount++;
      return item;
    }).sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0));
    updateBadge(pendingCount);
    renderAll();
  });

  document.getElementById('off-reason').addEventListener('change', function() {
    document.getElementById('off-custom').style.display = this.value === 'ì§ì ‘ì…ë ¥' ? 'block' : 'none';
  });

  document.getElementById('s-dir-loc').addEventListener('change', function() {
    document.getElementById('s-dir-custom').style.display = this.value === 'ì§ì ‘ì…ë ¥' ? 'block' : 'none';
  });

  document.addEventListener('click', () => {
    document.getElementById('context-menu').style.display = 'none';
  });
}










function renderSchedule() {
  const head = document.getElementById('sched-head'), body = document.getElementById('sched-body');
  const range = getWeekDates(weekOffset);
  document.getElementById('week-range').innerText = `${range[0]} ~ ${range[4].substring(5)}`;
  head.innerHTML = `<tr><th class="time-col">ì‹œê°„</th>${['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'].map((day, i) => `<th>${range[i].substring(5)}<br>${day}</th>`).join('')}</tr>`;

  let html = '';
  for(let h=8; h<=18; h++) {
    const timeLabel = h < 10 ? "0" + h + ":00" : h + ":00";
    html += `<tr><td class="time-col">${timeLabel}</td>`;
    
    for(let d=0; d<5; d++) {
      const curDate = range[d];
      let cell = '';

      const offDayItem = profReqs.find(r => r.date === curDate && r.prof === 'ìš´í–‰ì¤‘ë‹¨' && r.status !== 'cancelled');

      if(offDayItem && h !== 12) {
        cell = `<div class="cell-event block-off" draggable="true" ondragstart="onDragStart(event, '${offDayItem.id}')" onclick="openEditSchedule('${offDayItem.id}')">ìš´í–‰ë¶ˆê°€<br>${offDayItem?.dir || ''}</div>`;
      }
      else if(d === 0 && (h === 9 || h === 10)) {
        cell = `<div class="cell-event block-entry">ì…êµìˆ˜ì†¡</div>`;
      }
      else if(h === 12) {
        cell = `<div class="cell-íœ´">íœ´ê²Œì‹œê°„</div>`;
      }
      else {
        const items = profReqs.filter(r => 
          r.date === curDate && 
          parseInt(r.time?.split(':')[0]) === h && 
          r.status !== 'cancelled' && 
          r.prof !== 'ìš´í–‰ì¤‘ë‹¨'
        );

        if(items.length > 0) {
          const groups = {};
          items.forEach(item => {
            if(!groups[item.dir]) groups[item.dir] = [];
            groups[item.dir].push(item);
          });

         const firstDir = Object.keys(groups)[0];
          const groupItems = groups[firstDir];
          const nameDisplay = groupItems.length > 1 ? `${groupItems[0].prof} ì™¸ ${groupItems.length-1}` : groupItems[0].prof;
          const hasMultipleDirs = Object.keys(groups).length > 1;
          const finalName = hasMultipleDirs ? `${nameDisplay} (ê²½ë¡œë‹¤ë¦„)` : nameDisplay;

          // â˜… ë°©í–¥ì— ë”°ë¼ ìƒ‰ìƒ í´ë˜ìŠ¤ ê²°ì •
          let dirClass = "block-prof"; // ê¸°ë³¸ê°’
          if (firstDir.includes("â†’í•­ê¸°ì›")) {
            dirClass = "block-arr"; // ë„ì°©ì€ ë¹¨ê°„ìƒ‰
          } else if (firstDir.includes("í•­ê¸°ì›â†’")) {
            dirClass = "block-dep"; // ì¶œë°œì€ íŒŒë€ìƒ‰
          }

          let passengerText = "";
          if(groupItems[0].passengers && groupItems[0].passengers.length > 0) {
            passengerText = `<br><span style="font-size:8.5px; opacity:0.8;">(ë™ìŠ¹:${groupItems[0].passengers.join(',')})</span>`;
          }

          // div class ë¶€ë¶„ì— dirClassë¥¼ ë„£ìŠµë‹ˆë‹¤.
          cell = `<div class="cell-event ${dirClass}" draggable="true" ondragstart="onDragStart(event, '${groupItems[0].id}')" onclick="openEditSchedule('${groupItems[0].id}')">
            ${firstDir}<br>${finalName}${passengerText}
          </div>`;
          // â˜… ì—¬ê¸°ê¹Œì§€ ìˆ˜ì •ë¨
        }
        
        if(!cell) {
          for(let rid in allCourses) {
            const dep = allCourses[rid]?.shuttle?.departure;
            if(dep && dep.date === curDate && parseInt(dep.time?.split(':')[0]) === h) {
              cell = `<div class="cell-event block-departure" onclick="switchTab(3)">í‡´êµìˆ˜ì†¡</div>`;
              break;
            }
          }
        }
      }
      let clickAction = cell === '' ? `onclick="clickCellNewSchedule('${curDate}', '${timeLabel}')"` : '';
      html += `<td ondragover="allowDrop(event)" ondrop="onDrop(event, '${curDate}', '${h}:00')" ${clickAction} style="cursor:pointer;">${cell}</td>`;
    }
    html += `</tr>`;
  }
  body.innerHTML = html;
}













function renderTodayTimeline() {
  const container = document.getElementById('today-timeline-container');
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('today-date-display').innerText = `${today} ìˆ˜ì†¡ ì¼ì •`;

  const todaySchedule = [];
  const dayOfWeek = new Date(today).getDay();
  if(dayOfWeek === 1) {
    todaySchedule.push({ time: '09:00', type: 'ì…êµìˆ˜ì†¡', desc: 'ì‹ ê·œ êµìœ¡ìƒ ì…êµ ìˆ˜ì†¡' });
    todaySchedule.push({ time: '10:00', type: 'ì…êµìˆ˜ì†¡', desc: 'ì‹ ê·œ êµìœ¡ìƒ ì…êµ ìˆ˜ì†¡' });
  }

  profReqs.filter(r => r.date === today && r.status !== 'cancelled').forEach(item => {
    if(item.prof === 'ìš´í–‰ì¤‘ë‹¨') {
      todaySchedule.push({ 
        id: item.id, time: item.time, type: 'ìš´í–‰ë¶ˆê°€', 
        desc: item.dir || 'ì‚¬ìœ  ì—†ìŒ', route: '', completed: item.status === 'finished'
      });
    } else {
      todaySchedule.push({ 
        id: item.id, time: item.time, type: 'ê°•ì‚¬ìˆ˜ì†¡', 
        desc: `${item.prof || 'ê°•ì‚¬'} í”½ì—…`,
        route: item.dir || 'êµ¬ê°„ ì •ë³´ ì—†ìŒ', completed: item.status === 'finished'
      });
    }
  });

  for(let rid in allCourses) {
    const dep = allCourses[rid]?.shuttle?.departure;
    if(dep && dep.date === today) {
      const courseName = allCourses[rid].settings?.courseName || 'ê³¼ì •ëª… ì—†ìŒ';
      const total = Object.values(allCourses[rid].shuttle?.requests || {}).filter(r => r.type !== 'car').length;
      todaySchedule.push({ 
        time: dep.time, type: 'í‡´êµìˆ˜ì†¡', 
        desc: `${courseName} (${total}ëª…)`, route: 'í•­ê¸°ì› â†’ ì²­ì£¼ê³µí•­/ì˜¤ì†¡ì—­'
      });
    }
  }

  todaySchedule.sort((a, b) => (a.time || '').localeCompare(b.time || ''));

  let html = '';
  if(todaySchedule.length === 0) {
    html = '<div class="timeline-card"><div style="text-align:center; color:#999;">ì˜¤ëŠ˜ì€ ì˜ˆì •ëœ ìˆ˜ì†¡ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>';
  } else {
    todaySchedule.forEach(item => {
      html += `<div class="timeline-card" style="${item.completed ? 'opacity:0.5; background:#f1f5f9;' : ''}">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div class="timeline-time"><i class="fa-solid fa-clock"></i> ${item.time}</div>
          ${item.id ? `<label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
            <input type="checkbox" ${item.completed ? 'checked' : ''} onchange="toggleComplete('${item.id}')" style="width:20px; height:20px; cursor:pointer;">
            <span style="font-size:10px; color:#666;">ì™„ë£Œ</span>
          </label>` : ''}
        </div>
        <div class="timeline-item">
          <div style="font-size:14px; font-weight:900; margin-bottom:4px; ${item.completed ? 'text-decoration:line-through; color:#999;' : ''}">${item.type}</div>
          <div style="${item.completed ? 'color:#999;' : ''}">${item.desc}</div>
          ${item.route ? `<div class="timeline-route"><i class="fa-solid fa-route"></i> ${item.route}</div>` : ''}
        </div>
      </div>`;
    });
  }
  container.innerHTML = html;
}

function renderInstructorChat() {
  if(currentTab !== 2) return;
  const box = document.getElementById('chat-list-inner');
  let html = "";
  let firstUnreadIndex = -1;
  
  profReqs.forEach((r, idx) => {
    const isPending = r.status === 'pending';
    const isMine = r.status === 'approved' || r.status === 'finished';
    const isCancelled = r.status === 'cancelled';
    const isFinished = r.status === 'finished';
    
    if(firstUnreadIndex === -1 && isPending) firstUnreadIndex = idx;
    
    if(isCancelled) {
      html += `<div class="cancel-notice"><span><i class="fa-solid fa-ban"></i> ${r.prof || 'ê°•ì‚¬'} ìˆ˜ì†¡ ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤</span></div>`;
    } else {
      const cardStyle = isFinished ? 'opacity:0.5; filter:grayscale(80%);' : '';
      const bgColor = isFinished ? '#e5e5e5' : (isMine ? '#fee500' : '#fff');
      
      html += `<div class="req-card ${isMine?'mine':''}" style="${cardStyle} background:${bgColor};" data-id="${r.id}" oncontextmenu="showContextMenu(event, '${r.id}')">
        <div style="font-size:9px; color:${isPending?'var(--danger)':'#666'}; font-weight:800; margin-bottom:2px;">
          ${isPending?'â— ì‹ ê·œìš”ì²­':(isFinished?'âœ“ ìš´í–‰ì™„ë£Œ':'âœ“ í™•ì¸ë¨')}
        </div>
        <div style="font-weight:900; font-size:13px; margin-bottom:3px;">${isPending?'ìŠ¹ì¸ ëŒ€ê¸°':(isFinished?'ìš´í–‰ì™„ë£Œ':'ìŠ¹ì¸ì™„ë£Œ!')}</div>
        <div style="font-weight:700; font-size:12px; margin-bottom:2px;">${r.date || 'ë‚ ì§œì—†ìŒ'}</div>
        <div style="font-weight:700; font-size:12px; margin-bottom:2px;">${r.time || '--:--'}</div>
        <div style="font-size:11px; font-weight:600; color:var(--blue-deep); margin-bottom:2px;">
          <i class="fa-solid fa-route"></i> ${r.dir || 'êµ¬ê°„ ì •ë³´ ì—†ìŒ'}
        </div>
        <div style="font-size:10px; color:#047857; font-weight:700; margin-bottom:3px;">
          ì˜ˆìƒë„ì°©: ${calculateETA(r.time, r.dir)}
        </div>
        <div style="font-size:13px; font-weight:800; margin-bottom:2px;">
          ${r.prof || 'ì´ë¦„ì—†ìŒ'} ê°•ì‚¬ë‹˜
        </div>
        <div style="font-size:11px; font-weight:600; color:#64748b;">
          ${r.phone ? 
            `<a href="tel:${r.phone}" style="color:var(--blue); text-decoration:none;"><i class="fa-solid fa-phone"></i> ${r.phone}</a>` 
            : 
            `<span style="color:#999; font-size:9px;">(ì—°ë½ì²˜ ì—†ìŒ)</span>`
          }
        </div>
        ${isPending ? `<div class="req-btn-group" style="margin-top:6px;">
          <button class="mini-btn primary" onclick="approveRequest('${r.id}')"><i class="fa-solid fa-check"></i> ìŠ¹ì¸</button>
          <button class="mini-btn" onclick="cancelRequest('${r.id}')"><i class="fa-solid fa-times"></i> ë¶ˆê°€</button>
        </div>` : `<div style="font-size:10px; color:#666; margin-top:6px; text-align:center;">${isFinished?'ìš´í–‰ ì™„ë£Œë¨':'í™•ì¸í–ˆìŠµë‹ˆë‹¤'}</div>`}
      </div>`;
    }
  });
  
  box.innerHTML = html;
  
  if(currentTab === 2) {
    setTimeout(() => {
      if(firstUnreadIndex >= 0) {
        const firstUnread = box.querySelector(`[data-id="${profReqs[firstUnreadIndex].id}"]`);
        if(firstUnread) firstUnread.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        box.parentElement.scrollTop = box.parentElement.scrollHeight;
      }
    }, 100);
  }
}

function renderTraineeGrid() {
  const container = document.getElementById('trainee-list-body');
  let html = "";
  
  if (Object.keys(allCourses).length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:50px; color:#94a3b8; font-size:13px; font-weight:700;">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ êµìœ¡ ê³¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  Object.keys(allCourses).forEach(rid => {
    const room = allCourses[rid]; 
    if(room.status?.roomStatus !== 'active') return;
    
    const dep = room.shuttle?.departure || { time: "", announced: false };
    const total = Object.values(room.shuttle?.requests || {}).filter(r => r.type !== 'car').length;
    
    let timeOptions = `<option value="">ì‹œê°„ ì„ íƒ</option>`;
    for(let h=13; h<=18; h++) {
      const t = h + ":00";
      timeOptions += `<option value="${t}" ${dep.time===t?'selected':''}>${t}</option>`;
    }

    html += `
      <div class="course-row">
        <div class="t-cell" style="text-align:left; padding-left:10px; font-size:11px; line-height:1.3;">
          ${room.settings?.courseName || 'ê³¼ì •ëª… ì—†ìŒ'}
        </div>
        <div class="t-cell">
          <span class="count-badge">${total}ëª…</span>
        </div>
        <div class="t-cell">
          <select class="time-select-custom" onchange="confirmDepartureTime('${rid}', this.value)">
            ${timeOptions}
          </select>
        </div>
        <div class="t-cell">
          <button class="notice-btn ${dep.announced?'active':''}" onclick="toggleNotice('${rid}', ${dep.announced})">
            <i class="fa-solid fa-${dep.announced?'check':'bullhorn'}"></i>
          </button>
        </div>
      </div>`;
  });
  container.innerHTML = html;
}

function confirmDepartureTime(rid, time) {
  if(!time) return;
  
  const room = allCourses[rid];
  const courseName = room.settings?.courseName || 'ê³¼ì •ëª…';
  const total = Object.values(room.shuttle?.requests || {}).filter(r => r.type !== 'car').length;
  
  pendingDepartureData = { rid, time };
  
  document.getElementById('confirm-message').innerHTML = `
    <strong>${courseName}</strong><br>
    ì¶œë°œì‹œê°„: <strong style="color:var(--blue-deep);">${time}</strong><br>
    ì¸ì›: <strong>${total}ëª…</strong><br><br>
    í•´ë‹¹ ì‹œê°„ìœ¼ë¡œ ê³µì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
  `;
  
  document.getElementById('departureConfirmModal').style.display = 'flex';
}

async function confirmDepartureNotice() {
  if(!pendingDepartureData) return;
  
  const { rid, time } = pendingDepartureData;
  const depDate = allCourses[rid].shuttle?.departure?.date || new Date().toISOString().split('T')[0];
  
  await firebase.database().ref(`courses/${rid}/shuttle/departure`).update({ 
    time, 
    date: depDate,
    announced: true 
  });
  
  closeModal('departureConfirmModal');
  pendingDepartureData = null;
  alert('âœ“ ê³µì§€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
}

async function toggleNotice(rid, stat) { 
  if(confirm(`${stat?'ê³µì§€ë¥¼ ì·¨ì†Œí• ê¹Œìš”?':'í™•ì„±ê¸° ê³µì§€ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆê¹Œ?'}`)) {
    await firebase.database().ref(`courses/${rid}/shuttle/departure`).update({ announced: !stat });
  }
}

async function approveRequest(id) {
  const req = profReqs.find(r => r.id === id);
  if(!req) return;
  
  const conflicts = profReqs.filter(r => 
    r.id !== id &&
    r.date === req.date && 
    r.status !== 'cancelled' && 
    r.prof !== 'ìš´í–‰ì¤‘ë‹¨'
  );
  
  if(conflicts.length > 0) {
    const list = conflicts.map(c => `${c.time} ${c.prof} (${c.dir})`).join('\n');
    if(!confirm(`âš ï¸ í•´ë‹¹ ë‚ ì§œì— ë‹¤ìŒ ì¼ì •ì´ ìˆìŠµë‹ˆë‹¤:\n\n${list}\n\nìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      return;
    }
  }
  
  await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'approved' }); 
}

async function cancelRequest(id) { 
  if(confirm("ë¶ˆê°€ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'cancelled' }); 
  }
}

async function toggleComplete(id) {
  const item = profReqs.find(r => r.id === id);
  if(!item) return;
  await firebase.database().ref(`system/transport_requests/${id}`).update({
    status: item.status === 'finished' ? 'approved' : 'finished'
  });
}

function openNewSchedule() {
  currentEditId = null;
  currentPassengers = [];
  document.getElementById('schedule-modal-title').innerText = 'ì‹ ê·œ ì¼ì • ì¶”ê°€';
  document.getElementById('s-schedule-type').value = 'prof';  // ğŸ”¥ ì¶”ê°€
  document.getElementById('s-date').value = '';
  document.getElementById('s-time').value = '';
  document.getElementById('s-prof').value = 'í™ê¸¸ë™';
  document.getElementById('s-phone').value = '';
  document.getElementById('s-dir-type').value = 'arrival';
  document.getElementById('s-dir-loc').value = 'ì˜¤ì†¡ì—­';
  document.getElementById('s-dir-custom').value = '';
  document.getElementById('s-dir-custom').style.display = 'none';
  document.getElementById('delete-schedule-btn').style.display = 'none';
  toggleScheduleType();  // ğŸ”¥ ì¶”ê°€
  renderPassengers();
  document.getElementById('scheduleModal').style.display = 'flex';
}

function openEditSchedule(id) {
  const item = profReqs.find(r => r.id === id);
  if(!item) return;
  
  currentEditId = id;
  currentPassengers = item.passengers || [];
  
  document.getElementById('schedule-modal-title').innerText = 'ì¼ì • ìˆ˜ì •';
  document.getElementById('s-date').value = item.date;
  document.getElementById('s-time').value = item.time;
  document.getElementById('s-prof').value = item.prof === 'ìš´í–‰ì¤‘ë‹¨' ? '' : item.prof;
  document.getElementById('s-phone').value = item.phone || '';
  
  const dirText = item.dir || '';
  if(dirText.includes('â†’í•­ê¸°ì›')) {
    document.getElementById('s-dir-type').value = 'arrival';
    const loc = dirText.replace('â†’í•­ê¸°ì›', '');
    setLocValue(loc);
  } else if(dirText.includes('í•­ê¸°ì›â†’')) {
    document.getElementById('s-dir-type').value = 'departure';
    const loc = dirText.replace('í•­ê¸°ì›â†’', '');
    setLocValue(loc);
  }
  
  // ğŸ”¥ íƒ€ì… ì„¤ì •
  if(item.prof === 'ìš´í–‰ì¤‘ë‹¨') {
    document.getElementById('s-schedule-type').value = 'off';
    document.getElementById('s-off-reason').value = item.dir || 'ì—°ì°¨';
  } else {
    document.getElementById('s-schedule-type').value = 'prof';
  }
  
  document.getElementById('delete-schedule-btn').style.display = 'block';
  toggleScheduleType();  // ğŸ”¥ ì¶”ê°€
  renderPassengers();




  document.getElementById('delete-schedule-btn').style.display = 'block';
  renderPassengers();
  document.getElementById('scheduleModal').style.display = 'flex';
}

function setLocValue(loc) {
  const locSelect = document.getElementById('s-dir-loc');
  const customInput = document.getElementById('s-dir-custom');
  if(['ì˜¤ì†¡ì—­', 'ì²­ì£¼ê³µí•­', 'ì²­ì£¼í„°ë¯¸ë„'].includes(loc)) {
    locSelect.value = loc;
    customInput.style.display = 'none';
  } else {
    locSelect.value = 'ì§ì ‘ì…ë ¥';
    customInput.value = loc;
    customInput.style.display = 'block';
  }
}

function addPassenger() {
  const name = prompt('ë™ìŠ¹ê° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
  if(name && name.trim()) {
    currentPassengers.push(name.trim());
    renderPassengers();
  }
}

function removePassenger(index) {
  currentPassengers.splice(index, 1);
  renderPassengers();
}


// ğŸ”¥ ì¼ì • íƒ€ì… ì „í™˜ í•¨ìˆ˜
function toggleScheduleType() {
  const type = document.getElementById('s-schedule-type').value;
  const timeSection = document.getElementById('time-section');
  
  if(type === 'off') {
    // ìš´í–‰ë¶ˆê°€ì¼ ë•Œ
    document.getElementById('prof-info-area').style.display = 'none';
    document.getElementById('route-info-area').style.display = 'none';
    document.getElementById('passengers-area').style.display = 'none';
    document.getElementById('off-reason-area').style.display = 'block';
    timeSection.style.display = 'none'; // ì‹œê°„ ìˆ¨ê¸°ê¸°
  } else {
    // ê°•ì‚¬ìˆ˜ì†¡ì¼ ë•Œ
    document.getElementById('prof-info-area').style.display = 'block';
    document.getElementById('route-info-area').style.display = 'block';
    document.getElementById('passengers-area').style.display = 'block';
    document.getElementById('off-reason-area').style.display = 'none';
    timeSection.style.display = 'block'; // ì‹œê°„ ë³´ì´ê¸°
  }
}




// ğŸ”¥ ìš´í–‰ë¶ˆê°€ ì‚¬ìœ  ì§ì ‘ì…ë ¥ í† ê¸€
document.addEventListener('DOMContentLoaded', function() {
  const offReasonSelect = document.getElementById('s-off-reason');
  if(offReasonSelect) {
    offReasonSelect.addEventListener('change', function() {
      document.getElementById('s-off-custom').style.display = 
        this.value === 'ì§ì ‘ì…ë ¥' ? 'block' : 'none';
    });
  }
});












function renderPassengers() {
  const container = document.getElementById('passengers-list');
  if(currentPassengers.length === 0) {
    container.innerHTML = '<div style="text-align:center; color:#999; font-size:11px; padding:10px;">ë™ìŠ¹ê° ì—†ìŒ</div>';
  } else {
    container.innerHTML = currentPassengers.map((name, i) => `
      <div style="display:flex; justify-content:space-between; align-items:center; background:#fff; padding:8px; border-radius:6px; margin-bottom:5px;">
        <span style="font-size:12px; font-weight:700;">${name}</span>
        <button class="mini-btn" onclick="removePassenger(${i})" style="padding:4px 8px; background:var(--danger); color:#fff; border:none;">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
    `).join('');
  }
}









async function saveSchedule() {
  const type = document.getElementById('s-schedule-type').value;
  const date = document.getElementById('s-date').value;
  const time = document.getElementById('s-time').value;
  
// ìš´í–‰ ë¶ˆê°€(off)ì¼ ë•ŒëŠ” ë‚ ì§œë§Œ í™•ì¸í•˜ê³ , ì‹œê°„ì€ ì„ì˜ë¡œ '09:00'ì„ ë„£ì–´ì¤ë‹ˆë‹¤.
  if(type === 'off') {
    if(!date) { alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
    if(!time) { time = "09:00"; } // ìš´í–‰ë¶ˆê°€ëŠ” ì‹œê°„ ìƒê´€ì—†ì´ 9ì‹œ ìŠ¬ë¡¯ì— ì €ì¥
  } else {
    // ê°•ì‚¬ ìˆ˜ì†¡ì¼ ë•ŒëŠ” ë‚ ì§œì™€ ì‹œê°„ì´ ëª¨ë‘ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
    if(!date || !time) {
      alert('ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  }
  
  let data = { date, time, status: 'approved', timestamp: Date.now() };
  
  if(type === 'off') {
    // ìš´í–‰ë¶ˆê°€
    const reasonSel = document.getElementById('s-off-reason').value;
    const customReason = document.getElementById('s-off-custom').value;
    const reason = reasonSel === 'ì§ì ‘ì…ë ¥' ? customReason : reasonSel;
    
    data.prof = 'ìš´í–‰ì¤‘ë‹¨';
    data.dir = reason;
    data.phone = '';
    data.passengers = [];
  } else {
    // ê°•ì‚¬ìˆ˜ì†¡
    const prof = document.getElementById('s-prof').value;
    const phone = document.getElementById('s-phone').value;
    const dirType = document.getElementById('s-dir-type').value;
    const dirLoc = document.getElementById('s-dir-loc').value;
    const customLoc = document.getElementById('s-dir-custom').value;
    
    if(!prof) {
      alert('ê°•ì‚¬ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
      return;
    }
    
    const finalLoc = (dirLoc === 'ì§ì ‘ì…ë ¥') ? customLoc : dirLoc;
    const finalDir = (dirType === 'arrival') ? `${finalLoc}â†’í•­ê¸°ì›` : `í•­ê¸°ì›â†’${finalLoc}`;
    
    data.prof = prof;
    data.phone = phone;
    data.dir = finalDir;
    data.passengers = currentPassengers;
  }
  
  if(currentEditId) {
    await firebase.database().ref(`system/transport_requests/${currentEditId}`).update(data);
  } else {
    await firebase.database().ref('system/transport_requests').push(data);
  }
  
  closeModal('scheduleModal');
  currentEditId = null;
  currentPassengers = [];
}













async function deleteSchedule() {
  if(confirm('ì´ ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?')) {
    await firebase.database().ref(`system/transport_requests/${currentEditId}`).remove();
    closeModal('scheduleModal');
    currentEditId = null;
  }
}

async function saveDayOff() {
  const date = document.getElementById('off-date').value;
  const reasonSel = document.getElementById('off-reason').value;
  const customReason = document.getElementById('off-custom').value;
  const reason = reasonSel === 'ì§ì ‘ì…ë ¥' ? customReason : reasonSel;
  
  if(!date || !reason) {
    alert('ë‚ ì§œì™€ ì‚¬ìœ ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”');
    return;
  }

  const existingSchedules = profReqs.filter(r => 
    r.date === date && r.prof !== 'ìš´í–‰ì¤‘ë‹¨' && r.status !== 'cancelled'
  );
  
  if(existingSchedules.length > 0) {
    const list = existingSchedules.map(s => `${s.time} ${s.prof}`).join('\n');
    if(!confirm(`âš ï¸ í•´ë‹¹ ë‚ ì§œì— ì•„ë˜ ì¼ì •ì´ ìˆìŠµë‹ˆë‹¤:\n\n${list}\n\nìš´í–‰ë¶ˆê°€ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      return;
    }
  }

  const data = { 
    date, time: '09:00', prof: 'ìš´í–‰ì¤‘ë‹¨', dir: reason, 
    status: 'approved', timestamp: Date.now() 
  };
  
  await firebase.database().ref('system/transport_requests').push(data);
  closeModal('dayOffModal');
  alert('ìš´í–‰ë¶ˆê°€ ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function showContextMenu(event, id) {
  event.preventDefault();
  const menu = document.getElementById('context-menu');
  menu.innerHTML = `
    <div class="context-item danger" onclick="deleteFromChat('${id}')">
      <i class="fa-solid fa-trash"></i> ì‚­ì œ
    </div>
  `;
  menu.style.display = 'block';
  menu.style.left = event.pageX + 'px';
  menu.style.top = event.pageY + 'px';
}

async function deleteFromChat(id) {
  if(confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    await firebase.database().ref(`system/transport_requests/${id}`).remove();
  }
  document.getElementById('context-menu').style.display = 'none';
}

async function clearFinished() { 
  if(confirm("ì™„ë£Œëœ ë‚´ì—­ì„ ì •ë¦¬í• ê¹Œìš”?")) { 
    profReqs.filter(r => r.status==='finished' || r.status==='cancelled')
      .forEach(t => firebase.database().ref(`system/transport_requests/${t.id}`).remove()); 
  } 
}

function captureSchedule() {
  toggleSidebar();
  const element = document.getElementById('schedule-capture-area');
  html2canvas(element, { scale: 2 }).then(canvas => {
    const link = document.createElement('a');
    link.download = `ì¼ì •í‘œ_${new Date().toISOString().split('T')[0]}.png`;
    link.href = canvas.toDataURL();
    link.click();
    alert('ì¼ì •í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
  });
}

let draggedItemId = null;

function onDragStart(event, id) {
  draggedItemId = id;
  event.dataTransfer.effectAllowed = 'move';
}

function allowDrop(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
}

async function onDrop(event, date, time) {
  event.preventDefault();
  if(!draggedItemId) return;
  
  const req = profReqs.find(r => r.id === draggedItemId);
  if(!req) return;
  
  const newTime = time.split(':')[0] + ':' + (req.time ? req.time.split(':')[1] : '00');
  
  if(confirm(`${date} ${newTime}ìœ¼ë¡œ ë³€ê²½í• ê¹Œìš”?`)) {
    await firebase.database().ref(`system/transport_requests/${draggedItemId}`).update({ 
      date, 
      time: newTime 
    });
  }
  
  draggedItemId = null;
}

function getWeekDates(offset) {
  const now = new Date();
  const day = now.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  const monday = new Date(now);
  monday.setDate(now.getDate() + diff + (offset * 7));
  const res = [];
  for(let i=0; i<5; i++) {
    const d = new Date(monday); 
    d.setDate(monday.getDate()+i);
    res.push(d.toISOString().split('T')[0]);
  }
  return res;
}

function calculateETA(startTime, route) {
  if(!startTime || !route) return 'ì‹œê°„ ë¯¸ì •';
  const [hour, min] = startTime.split(':').map(Number);
  let totalMinutes = hour * 60 + min;
  const segments = route.split('â†’').length - 1;
  totalMinutes += segments * 30;
  const etaHour = Math.floor(totalMinutes / 60);
  const etaMin = totalMinutes % 60;
  return `${String(etaHour).padStart(2,'0')}:${String(etaMin).padStart(2,'0')}`;
}

function toggleSidebar() { 
  const sb = document.getElementById('sidebar');
  const ol = document.querySelector('.sidebar-overlay');
  const isOpen = sb.classList.contains('open'); 
  sb.classList.toggle('open', !isOpen); 
  ol.style.display = isOpen ? 'none' : 'block'; 
}

function switchTab(n) { 
  currentTab = n; 
  document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === n)); 
  document.querySelectorAll('[id^="view-"]').forEach((v, i) => v.style.display = i === n ? 'block' : 'none'); 
  renderAll(); 
}

function updateBadge(count) { 
  const b = document.getElementById('badge-count'); 
  if(count > 0) { 
    b.innerText = count; 
    b.style.display = 'block'; 
  } else {
    b.style.display = 'none'; 
  }
}

function renderAll() { 
  renderSchedule(); 
  if(currentTab === 1) renderTodayTimeline();
  if(currentTab === 2) renderInstructorChat();
  if(currentTab === 3) renderTraineeGrid();
}

function changeWeek(n) { 
  weekOffset += n; 
  renderAll(); 
}

function goToday() { 
  const now = new Date();
  const day = now.getDay(); 
  weekOffset = (day === 5 || day === 6 || day === 0) ? 1 : 0;
  renderAll();
}

function closeModal(id) { 
  document.getElementById(id).style.display = 'none'; 
}

function handleBack() { 
  if(confirm("í¬íƒˆë¡œ ì´ë™í• ê¹Œìš”?")) location.href = 'portal.html'; 
}



function openNewDayOff() {
  openNewSchedule(); // ì¼ë‹¨ ì‹ ê·œ ì°½ì„ ì—´ê³ 
  document.getElementById('s-schedule-type').value = 'off'; // íƒ€ì…ì„ ìš´í–‰ë¶ˆê°€ë¡œ ë³€ê²½
  toggleScheduleType(); // í™”ë©´ êµ¬ì„± ë³€ê²½
  document.getElementById('schedule-modal-title').innerText = 'ìš´í–‰ë¶ˆê°€ ë“±ë¡';
}

// ìŠ¤ì¼€ì¤„í‘œ ì¹¸ì„ í´ë¦­í–ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
function clickCellNewSchedule(date, time) {
  openNewSchedule(); 
  document.getElementById('s-date').value = date;
  document.getElementById('s-time').value = time; // ì´ì œ 08:00ì´ ê·¸ëŒ€ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.
}


init();



</script>
</body>
</html>




