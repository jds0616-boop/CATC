<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>KAC TRANSPORT MASTER</title>
  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° í°íŠ¸ -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

  <style>
    /* 1. ë””ìì¸ ì‹œìŠ¤í…œ (í•­ê³µ ê´€ì œ í”„ë¦¬ë¯¸ì—„ í…Œë§ˆ) */
    :root {
      --navy: #0f172a; --blue: #3b82f6; --blue-deep: #1e40af;
      --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0;
      --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
      --text-main: #1e293b; --text-sub: #64748b;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
    body { margin: 0; padding: 0; background: #cfd8e3; display: flex; justify-content: center; height: 100dvh; overflow: hidden; font-size: 14px; color: var(--text-main); }
    
    .app-container { width: 100%; max-width: 800px; height: 100%; background: var(--bg); display: flex; flex-direction: column; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    
    /* ìƒë‹¨ë°” */
    .app-header { height: 60px; background: var(--navy); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 3px solid var(--blue); flex-shrink: 0; }
    .header-title { font-size: 18px; font-weight: 900; color: #fff; letter-spacing: -0.5px; }
    .sync-status { font-size: 11px; color: var(--success); font-weight: 800; display: flex; align-items: center; gap: 6px; }

    /* íƒ­ ë©”ë‰´ */
    .tab-bar { display: flex; background: #fff; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .tab-btn { flex: 1; padding: 15px 0; border: none; background: none; font-size: 14px; font-weight: 800; color: var(--text-sub); cursor: pointer; border-bottom: 4px solid transparent; transition: 0.2s; }
    .tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); background: #f1f7ff; }

    .app-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }

    /* ë¦¬ìŠ¤íŠ¸ í‘œ ê³µí†µ */
    .modern-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid var(--border); }
    .modern-table th { background: #f1f5f9; padding: 12px 8px; font-size: 12px; font-weight: 800; color: var(--text-sub); border-bottom: 2px solid var(--border); text-align: center; }
    .modern-table td { padding: 12px 8px; border-bottom: 1px solid var(--border); text-align: center; font-size: 13px; vertical-align: middle; }
    .modern-table tr:hover { background: #f8fbff; }

    /* ì¢…í•© ì¼ì •í‘œ ìŠ¤ì¼€ì¤„ ì „ìš© */
    .schedule-wrapper { background: #fff; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
    .schedule-table { table-layout: fixed; width: 100%; border-collapse: collapse; }
    .schedule-table th, .schedule-table td { border: 1px solid var(--border); height: 42px; text-align: center; font-size: 11px; }
    .time-col { background: #f1f5f9; font-weight: 800; width: 65px; color: var(--navy); }
    .cell-event { width: 95%; height: 85%; margin: 0 auto; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #fff; font-size: 10px; border-radius: 4px; }
    .block-prof { background: var(--blue); }
    .block-departure { background: var(--warning); }
    .block-entry { background: var(--success); }
    .block-lunch { background: #e2e8f0; color: #94a3b8; }

    /* ë²„íŠ¼ ë° ë°°ì§€ */
    .btn-sm { padding: 7px 12px; border-radius: 8px; border: none; font-weight: 800; cursor: pointer; font-size: 12px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
    .btn-blue { background: var(--blue); color: #fff; }
    .btn-red { background: #fee2e2; color: var(--danger); }
    .btn-outline { background: #fff; border: 1px solid var(--border); color: var(--text-sub); }
    .btn-time { background: #f8fafc; border: 1px solid var(--border); color: var(--text-main); height: 35px; width: 55px; }
    .btn-time.active { background: var(--navy); color: #fff; border-color: var(--navy); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .badge-done { background: #dcfce7; color: var(--success); padding: 4px 10px; border-radius: 50px; font-size: 11px; font-weight: 900; border: 1px solid var(--success); }

    /* ëª¨ë‹¬ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.85); z-index: 9999; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
    .modal-box { background: #fff; width: 100%; max-width: 480px; border-radius: 24px; padding: 30px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); text-align: center; }
    .modal-title { font-size: 22px; font-weight: 900; color: var(--navy); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    
    .footer-clock { font-size: 13px; font-weight: 800; color: #fff; font-family: monospace; }
    .app-footer { height: 50px; background: var(--navy); border-top: 2px solid var(--blue); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
  </style>
</head>
<body>

<div class="app-container">
  <header class="app-header">
    <div style="width:30px; color:#fff; font-size:22px; cursor:pointer;" onclick="location.href='portal.html'"><i class="fa-solid fa-chevron-left"></i></div>
    <div class="header-title">KAC TRANSPORT MASTER</div>
    <div class="sync-status"><i class="fa-solid fa-satellite-dish fa-pulse"></i> LIVE</div>
  </header>

  <div class="tab-bar">
    <button id="tab0" class="tab-btn active" onclick="switchTab(0)">ì¢…í•© ì¼ì •í‘œ</button>
    <button id="tab1" class="tab-btn" onclick="switchTab(1)">ê°•ì‚¬ ìˆ˜ì†¡ ë¦¬ìŠ¤íŠ¸</button>
    <button id="tab2" class="tab-btn" onclick="switchTab(2)">êµìœ¡ìƒ í‡´êµ ê´€ë¦¬</button>
  </div>

  <main class="app-content" id="main-content">
    <!-- íƒ­ 0: ì¢…í•© ì¼ì •í‘œ -->
    <div id="view-0" style="display: block;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; background:#fff; padding:10px; border-radius:12px; border:1px solid var(--border);">
        <i class="fa-solid fa-caret-left" style="font-size:28px; color:var(--blue); cursor:pointer;" onclick="changeWeek(-1)"></i>
        <div style="font-size:16px; font-weight:900; color:var(--navy);" id="week-range">Week</div>
        <i class="fa-solid fa-caret-right" style="font-size:28px; color:var(--blue); cursor:pointer;" onclick="changeWeek(1)"></i>
      </div>
      <div class="schedule-wrapper"><table class="schedule-table"><thead id="sched-head"></thead><tbody id="sched-body"></tbody></table></div>
    </div>

    <!-- íƒ­ 1: ê°•ì‚¬ ìˆ˜ì†¡ ê´€ë¦¬ -->
    <div id="view-1" style="display: none;">
      <table class="modern-table">
        <thead>
          <tr>
            <th style="width:35px;">No</th><th style="width:75px;">ë‚ ì§œ</th><th style="width:40px;">ìš”ì¼</th><th>í”½ì—…ì¥ì†Œ</th><th style="width:70px;">ì‹œê°„</th><th>ê°•ì‚¬ëª…</th><th style="width:90px;">ì „í™”ë²ˆí˜¸</th><th style="width:65px;">ìŠ¹ì¸</th><th style="width:55px;">ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody id="prof-list-body"></tbody>
      </table>
    </div>

    <!-- íƒ­ 2: êµìœ¡ìƒ í‡´êµ ê´€ë¦¬ -->
    <div id="view-2" style="display: none;">
      <table class="modern-table">
        <thead>
          <tr>
            <th>ê³¼ì •ëª…</th><th style="width:45px;">ì˜¤ì†¡</th><th style="width:45px;">í„°ë¯¸</th><th style="width:45px;">ê³µí•­</th><th style="width:165px;">ì¶œë°œì‹œê° ì„¤ì •</th><th style="width:75px;">ìƒíƒœ</th>
          </tr>
        </thead>
        <tbody id="trainee-list-body"></tbody>
      </table>
    </div>
  </main>

  <footer class="app-footer">
    <div class="footer-clock" id="clock">0000.00.00 00:00:00</div>
    <img src="logo.png" alt="KAC" style="height:18px; filter: brightness(0) invert(1);">
  </footer>
</div>

<!-- íŒì—… ëª¨ë‹¬ë“¤ -->
<div id="newRequestModal" class="modal-overlay">
  <div class="modal-box" style="border-top: 8px solid var(--blue);">
    <div class="modal-title"><i class="fa-solid fa-bell fa-shake" style="color:var(--blue);"></i> ì‹ ê·œ ìš”ì²­ ë°œìƒ</div>
    <div id="new-req-content" style="background:#f8fafc; padding:20px; border-radius:15px; margin-bottom:20px; font-size:17px; font-weight:800; border:1px solid var(--border);"></div>
    <div style="display:flex; gap:12px;">
        <button class="btn-sm btn-outline" style="flex:1; height:50px;" onclick="closeModal('newRequestModal')">ë‹«ê¸°</button>
        <button class="btn-sm btn-blue" style="flex:2; height:50px;" id="new-req-approve-btn">ì¦‰ì‹œ ë°°ì°¨ ìŠ¹ì¸</button>
    </div>
  </div>
</div>

<div id="detailModal" class="modal-overlay" onclick="if(event.target==this) closeModal('detailModal')">
  <div class="modal-box">
    <div class="modal-title" id="m-title" style="color:var(--blue-deep);">ìƒì„¸ ëª…ë‹¨</div>
    <div id="m-content" style="max-height:450px; overflow-y:auto; border-top:2px solid var(--navy); padding-top:15px;"></div>
    <button class="btn-sm btn-outline" style="width:100%; height:45px; margin-top:20px;" onclick="closeModal('detailModal')">íŒì—… ë‹«ê¸°</button>
  </div>
</div>

<script src="config.js"></script>
<script>
  let allCourses = {}; let profReqs = []; let weekOffset = 0; 
  let shownRequestIds = new Set(); 

  function init() {
    setInterval(updateClock, 1000);
    // ë°ì´í„° ì‹¤ì‹œê°„ ë™ê¸°í™”
    firebase.database().ref('courses').on('value', snap => { allCourses = snap.val() || {}; renderAll(); });
    firebase.database().ref('system/transport_requests').on('value', snap => {
      const raw = snap.val() || {};
      profReqs = Object.keys(raw).map(k => ({ id: k, ...raw[k] }));
      checkNewRequestLogic();
      renderAll();
    });
  }

  // ì‹ ê·œ ìš”ì²­ íŒì—… ë¡œì§ (ì•ŒëŒ ìŒì†Œê±°)
  function checkNewRequestLogic() {
    const pending = profReqs.filter(r => r.status === 'pending' && r.prof !== 'ìš´í–‰ì¤‘ë‹¨');
    pending.forEach(req => {
        if (!shownRequestIds.has(req.id)) {
            const msg = `<span style="color:var(--blue-deep)">[${req.date}] ${req.time}</span><br>${req.prof} ê°•ì‚¬ë‹˜<br><span style="color:var(--text-sub)">${req.dir}</span>`;
            document.getElementById('new-req-content').innerHTML = msg;
            document.getElementById('new-req-approve-btn').onclick = () => { 
                handleSmartApprove(req.id); 
                closeModal('newRequestModal');
            };
            document.getElementById('newRequestModal').style.display = 'flex';
            shownRequestIds.add(req.id);
        }
    });
  }

  function renderAll() { renderSchedule(); renderInstructorList(); renderTraineeManagement(); }

  // 1. ì¢…í•© ì¼ì •í‘œ ê·¸ë¦¬ê¸°
  function renderSchedule() {
    const head = document.getElementById('sched-head'); const body = document.getElementById('sched-body');
    const range = getWeekDates(weekOffset); const dayNames = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'];
    document.getElementById('week-range').innerText = `${range[0]} ~ ${range[4]}`;
    head.innerHTML = `<tr><th class="time-col">TIME</th>${range.map((d, i) => `<th>${d.substring(5)}<br>${dayNames[i]}</th>`).join('')}</tr>`;
    body.innerHTML = '';
    for(let h=8; h<=18; h++) {
      let row = `<tr><td class="time-col">${h}:00</td>`;
      for(let d=0; d<5; d++) {
        const curDate = range[d]; let content = '';
        const prof = profReqs.find(r => r.date === curDate && parseInt(r.time.split(':')[0]) === h && r.status === 'approved');
        let depRid = null;
        Object.keys(allCourses).forEach(rid => {
            const dep = allCourses[rid].shuttle?.departure;
            if(dep && dep.date === curDate && parseInt(dep.time.split(':')[0]) === h) depRid = rid;
        });
        if(prof) content = `<div class="cell-event block-prof">${prof.prof.substring(0,2)}</div>`;
        else if(depRid) content = `<div class="cell-event block-departure">í‡´êµ</div>`;
        else if(h === 12) content = `<div class="cell-event block-lunch">ì ì‹¬</div>`;
        else if(d === 0 && (h === 9 || h === 10)) content = `<div class="cell-event block-entry">ì…êµ</div>`;
        row += `<td>${content}</td>`;
      }
      body.innerHTML += row + '</tr>';
    }
  }

  // 2. ê°•ì‚¬ ìˆ˜ì†¡ ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
  function renderInstructorList() {
    const tbody = document.getElementById('prof-list-body');
    tbody.innerHTML = '';
    const sorted = profReqs.filter(r => r.prof !== 'ìš´í–‰ì¤‘ë‹¨').sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time));
    const dayNames = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
    sorted.forEach((r, idx) => {
        const isApproved = r.status === 'approved';
        const dIdx = new Date(r.date).getDay();
        const tr = document.createElement('tr');
        if(isApproved) tr.style.background = "#f0fdf4";
        tr.innerHTML = `
            <td>${idx+1}</td><td>${r.date.substring(5)}</td><td>${dayNames[dIdx]}</td>
            <td style="text-align:left; font-weight:800; color:var(--blue-deep);">${r.dir.replace('í•­ê³µê¸°ìˆ í›ˆë ¨ì›','í•­ê¸°ì›')}</td>
            <td style="font-weight:900;">${r.time}</td><td>${r.prof}</td><td style="font-size:11px;">${r.phone}</td>
            <td>${isApproved ? `<button class="btn-sm btn-outline" onclick="handleCancel('${r.id}')">ì·¨ì†Œ</button>` : `<button class="btn-sm btn-blue" onclick="handleSmartApprove('${r.id}')">ìŠ¹ì¸</button>`}</td>
            <td><button class="btn-sm btn-red" onclick="handleDelete('${r.id}')"><i class="fa-solid fa-trash-can"></i></button></td>
        `;
        tbody.appendChild(tr);
    });
  }

  // 3. êµìœ¡ìƒ í‡´êµ ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
  function renderTraineeManagement() {
    const tbody = document.getElementById('trainee-list-body');
    tbody.innerHTML = '';
    Object.keys(allCourses).forEach(rid => {
      const room = allCourses[rid]; if(room.status?.roomStatus !== 'active') return;
      const dep = room.shuttle?.departure || { time: "" };
      const reqs = Object.values(room.shuttle?.requests || {});
      const cO = reqs.filter(r=>r.type==='osong').length; 
      const cT = reqs.filter(r=>r.type==='terminal').length; 
      const cA = reqs.filter(r=>r.type==='airport').length;
      tbody.innerHTML += `
        <tr>
          <td style="text-align:left; font-weight:800; color:var(--navy); cursor:pointer;" onclick="showTraineeDetail('${rid}')"><i class="fa-solid fa-users-viewfinder"></i> #${rid} ${room.settings?.courseName.substring(0,12)}..</td>
          <td style="color:var(--danger); font-weight:800;">${cO}</td><td style="color:var(--blue); font-weight:800;">${cT}</td><td style="color:var(--success); font-weight:800;">${cA}</td>
          <td>
            <div style="display:flex; gap:3px; justify-content:center;">
                <button class="btn-sm btn-time ${dep.time==='13:00'?'active':''}" onclick="setDeparture('${rid}', '13:00')">13:00</button>
                <button class="btn-sm btn-time ${dep.time==='15:00'?'active':''}" onclick="setDeparture('${rid}', '15:00')">15:00</button>
                <button class="btn-sm btn-time ${dep.time && !['13:00','15:00'].includes(dep.time)?'active':''}" onclick="askManualTime('${rid}')">ìˆ˜ë™</button>
            </div>
          </td>
          <td>${dep.time ? `<span class="badge-done">ê³µì§€ ì™„ë£Œ</span>` : `<span style="color:#cbd5e1;">ëŒ€ê¸°</span>`}</td>
        </tr>`;
    });
  }

  // ê³ ì°¨ì› ì¶©ëŒ ë°©ì§€ ìŠ¹ì¸ ì•Œê³ ë¦¬ì¦˜
  async function handleSmartApprove(id) {
    const target = profReqs.find(r => r.id === id);
    const targetHour = parseInt(target.time.split(':')[0]);
    let conflictMsg = "";
    const otherProf = profReqs.find(r => r.date === target.date && parseInt(r.time.split(':')[0]) === targetHour && r.status === 'approved' && r.id !== id);
    if(otherProf) conflictMsg = `ğŸš¨ [ë°°ì°¨ì¤‘ë³µ] ì´ë¯¸ ${otherProf.prof} ê°•ì‚¬ë‹˜ ì¼ì •ì´ ìˆìŠµë‹ˆë‹¤.`;
    Object.keys(allCourses).forEach(rid => {
        const dep = allCourses[rid].shuttle?.departure;
        if(dep && dep.date === target.date && parseInt(dep.time.split(':')[0]) === targetHour) conflictMsg = `ğŸš¨ [í‡´êµì¶©ëŒ] #${rid} ê³¼ì • í‡´êµ ìˆ˜ì†¡ì´ ì˜ˆì•½ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`;
    });
    if(conflictMsg && !confirm(conflictMsg + "\n\nê°•í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'approved' });
    alert("âœ… í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  function showTraineeDetail(rid) {
    const room = allCourses[rid]; const reqs = Object.values(room.shuttle?.requests || {});
    const content = document.getElementById('m-content'); document.getElementById('m-title').innerText = room.settings.courseName;
    if(reqs.length === 0) content.innerHTML = "<div style='padding:40px; color:#94a3b8;'>ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    else {
        reqs.sort((a,b) => a.name.localeCompare(b.name));
        let html = `<table class="modern-table" style="box-shadow:none; border:none;"><thead><tr><th>ì„±í•¨</th><th>ì—°ë½ì²˜</th><th>ëª©ì ì§€</th></tr></thead><tbody>`;
        reqs.forEach(r => { if(r.type !== 'car') html += `<tr><td style="font-weight:800;">${r.name}</td><td>${r.phone.slice(-4)}</td><td style="font-weight:700; color:var(--blue-deep);">${r.typeText}</td></tr>`; });
        html += "</tbody></table>"; content.innerHTML = html;
    }
    document.getElementById('detailModal').style.display = 'flex';
  }

  async function setDeparture(rid, time) { await firebase.database().ref(`courses/${rid}/shuttle/departure`).set({ time: time, date: new Date().toISOString().split('T')[0] }); }
  function askManualTime(rid) { const t = prompt("ì‹œê°„ ì…ë ¥ (ì˜ˆ: 14:30)"); if(t) setDeparture(rid, t); }
  function handleCancel(id) { if(confirm("ìŠ¹ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'pending' }); }
  function handleDelete(id) { if(confirm("ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) firebase.database().ref(`system/transport_requests/${id}`).remove(); }
  function switchTab(n) {
    document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === n));
    document.querySelectorAll('[id^="view-"]').forEach((v, i) => v.style.display = i === n ? 'block' : 'none');
  }
  function closeModal(id) { document.getElementById(id).style.display = 'none'; }
  function getWeekDates(offset) { 
    const now = new Date(); const start = new Date(now.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1) + (offset * 7))); 
    const dates = []; for(let i=0; i<5; i++) { const d = new Date(start); d.setDate(start.getDate() + i); dates.push(d.toISOString().split('T')[0]); } return dates; 
  }
  function changeWeek(n) { weekOffset += n; renderAll(); }
  function updateClock() {
    const now = new Date(); const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    document.getElementById('clock').innerText = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')} (${days[now.getDay()]}) ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
  }

  init();
</script>
</body>
</html>