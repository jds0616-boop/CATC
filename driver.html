  <!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>항공기술훈련원 차량지원 시스템</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
<style>
    :root {
      --navy: #0f172a; --blue: #0ea5e9; --blue-deep: #0369a1;
      --bg: #f1f5f9; --card: #ffffff; --border: #e2e8f0;
      --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
    body { margin: 0; padding: 0; background: #cfd8e3; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }
    
    .app-container { width: 100%; max-width: 600px; height: 100%; background: var(--bg); display: flex; flex-direction: column; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.2); }
    .app-header { height: 60px; background: var(--navy); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1000; }
    .header-btn { color: #fff; font-size: 20px; font-weight: 900; cursor: pointer; padding: 10px; }
    .header-title { font-size: 16px; font-weight: 900; color: #fff; letter-spacing: -0.5px; }

    /* 사이드바 */
    .sidebar { position: absolute; top: 0; right: -280px; width: 280px; height: 100%; background: #fff; z-index: 10000; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.2); }
    .sidebar.open { right: 0; }
    .sidebar-header { padding: 30px 20px; background: var(--navy); color: #fff; }
    .sidebar-menu { padding: 10px; }
    .menu-item { padding: 15px; display: flex; align-items: center; gap: 12px; font-weight: 700; color: #334155; border-radius: 8px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }

    .tab-bar { display: flex; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.08); flex-shrink: 0; }
    .tab-btn { flex: 1; padding: 14px 0; border: none; background: none; font-size: 11px; font-weight: 800; color: #94a3b8; cursor: pointer; border-bottom: 3px solid transparent; position: relative; }
    .tab-btn.active { color: var(--blue-deep); border-bottom-color: var(--blue); background: #f8fafc; }
    .badge { position: absolute; top: 5px; right: 5px; background: var(--danger); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; }

    .app-content { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }

    /* 종합일정표 */
    .schedule-wrapper { background: #fff; border: 2px solid #000; border-radius: 8px; overflow-x: auto; }
.schedule-table { 
  width: 100%; 
  border-collapse: collapse; 
  min-width: 450px; 
  table-layout: fixed; /* 모든 칸 너비를 일정하게 고정 */
}
.schedule-table th, .schedule-table td { 
  border: 1px solid #ddd; 
  text-align: center; 
  height: 45px !important; /* 처음 높이로 고정 */
  font-size: 10px; 
  vertical-align: middle; 
  position: relative; 
  padding: 0 2px !important;
  overflow: hidden; /* 절대 칸이 늘어나지 않음 */
}


.cell-container {
  width: 100%;
  height: 100%;
  overflow-y: auto; /* 일정이 많으면 칸 내부에서 스크롤 */
  display: flex;
  flex-direction: column;
  gap: 2px;
}
    .schedule-table th { background: #f1f5f9; font-weight: 900; color: var(--navy); }
    .time-col { width: 50px; background: #f1f5f9 !important; font-weight: 800; border-right: 2px solid var(--navy) !important; }
    .drop-target { background-color: #e0f2fe !important; }
.cell-event { 
  border-radius: 4px; 
  padding: 2px; 
  height: 38px; /* 칸 높이에 맞춤 */
  font-size: 9px; 
  font-weight: 800; 
  line-height: 1.1; 
  cursor: pointer; 
  display: flex; 
  flex-direction: column; 
  justify-content: center; 
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap; /* 글자가 길면 ... 처리 */
}
    .block-entry { background: #eff6ff; color: #1e40af; border: 1px solid #1e40af; }
    .block-prof { background: #fae8ff; color: #a21caf; border: 1px solid #a21caf; }
    .block-departure { background: #ecfdf5; color: #047857; border: 1px solid #047857; }
    .block-off { background: #fee2e2; color: #ef4444; border: 1px dashed #ef4444; position: relative; }
    .block-off::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(239,68,68,0.2) 5px, rgba(239,68,68,0.2) 10px); }
    .cell-休 { background: #fafafa; color: #999; font-size: 9px; }

    /* 카톡 스타일 채팅창 */
.chat-container { 
  background: #abc1d1; 
  padding: 10px; 
  display: flex; 
  flex-direction: column; 
  gap: 8px;  /* 10px → 8px */
  min-height: 100%; 
}
.req-card { 
  background: #fff; 
  border-radius: 10px; 
  padding: 10px; 
  box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
  width: auto;           /* 너비를 내용에 맞게 */
  max-width: 70%;        /* 너무 길지 않게 제한 */
  position: relative; 
  align-self: flex-start; 
  font-size: 11px; 
  line-height: 1.4; 
}
    .req-card.mine { align-self: flex-end; background: #fee500; }
    .req-card.mine::after { content: ''; position: absolute; top: 10px; right: -8px; border-left: 10px solid #fee500; border-bottom: 10px solid transparent; }
    .req-card:not(.mine)::after { content: ''; position: absolute; top: 10px; left: -8px; border-right: 10px solid #fff; border-bottom: 10px solid transparent; }
    .req-btn-group { display: flex; gap: 5px; margin-top: 8px; }
    .mini-btn { padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd; background: #fff; font-size: 11px; font-weight: 800; cursor: pointer; }
    .mini-btn.primary { background: var(--blue); color:#fff; border:none; }
    .cancel-notice { text-align: center; margin: 8px 0; }
    .cancel-notice span { background: rgba(0,0,0,0.1); padding: 4px 12px; border-radius: 10px; font-size: 10px; color: #666; }
/* ✨ 완료된 카드의 말풍선 색상도 회색으로 */
.req-card.mine[style*="grayscale"] {
  background: #d0d0d0 !important;
}
.req-card.mine[style*="grayscale"]::after {
  border-left-color: #d0d0d0 !important;
}

    /* 퇴교 수송 */
    .list-wrapper { background: #fff; border-radius: 12px; border: 1.5px solid #e2e8f0; overflow: hidden; }
    .list-header, .course-row { display: grid; grid-template-columns: 1.2fr 0.5fr 2fr 0.5fr; align-items: center; text-align: center; }
    .list-header { background: #f1f5f9; border-bottom: 2px solid #cbd5e1; font-size: 11px; font-weight: 900; }
    .course-row { border-bottom: 1px solid #f1f5f9; padding: 5px 0; }
    .t-cell { padding: 8px 4px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; border-right: 1px solid #f1f5f9; }
    .t-cell:last-child { border-right: none; }
    .time-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; width: 100%; padding: 0 5px; }
    .time-input { width: 100%; padding: 4px; font-size: 10px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }
    .notice-btn { border: none; background: none; font-size: 20px; cursor: pointer; color: #94a3b8; }
    .notice-btn.active { color: var(--warning); }

    /* 금일 수송일정 */
    .timeline-card { background: #fff; border-radius: 10px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 8px; }
    .timeline-time { font-size: 16px; font-weight: 900; color: var(--blue-deep); margin-bottom: 8px; }
    .timeline-item { padding: 8px 0; border-left: 3px solid var(--blue); padding-left: 12px; margin-left: 5px; font-size: 12px; font-weight: 700; }
    .timeline-route { color: #047857; font-weight: 800; }

    /* 모달 */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; padding: 20px; }
    .modal-box { background: #fff; width: 100%; max-width: 400px; border-radius: 20px; padding: 20px; }
    .modal-input { width: 100%; height: 45px; border: 1.5px solid #ddd; border-radius: 8px; padding: 0 10px; margin-bottom: 10px; font-size: 14px; font-weight: 700; }

#view-0 { background: var(--bg); min-height: 100%; }
#view-1 { background: var(--bg); min-height: 100%; }
#view-2 { background: #abc1d1; min-height: 100%; } 
#view-3 { background: var(--bg); min-height: 100%; }



</style>
</head>
<body>

<div class="sidebar-overlay" onclick="toggleSidebar()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header"><div style="font-size:18px; font-weight:900;">기사 전용 설정</div></div>
    <div class="sidebar-menu">
        <div class="menu-item" onclick="openDayOffModal()"><i class="fa-solid fa-calendar-xmark"></i> 운행불가 통합 공지</div>
        <div class="menu-item" onclick="handleBack()"><i class="fa-solid fa-house"></i> 포탈 메인 이동</div>
    </div>
</div>

<div class="app-container">
  <header class="app-header">
    <div class="header-btn" onclick="handleBack()">&lt;&lt;</div>
    <div class="header-title">항공기술훈련원 차량지원</div>
    <div class="header-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>
  </header>

  <div class="tab-bar">
    <button id="tab0" class="tab-btn active" onclick="switchTab(0)">종합일정표</button>
    <button id="tab1" class="tab-btn" onclick="switchTab(1)">금일일정</button>
    <button id="tab2" class="tab-btn" onclick="switchTab(2)">강사수송 <span id="badge-count" class="badge" style="display:none;">0</span></button>
    <button id="tab3" class="tab-btn" onclick="switchTab(3)">퇴교수송</button>
  </div>



<div id="loading-spinner" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:20000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; text-align:center;">
    <i class="fa-solid fa-spinner fa-spin" style="font-size:30px; color:var(--blue);"></i>
    <div style="margin-top:10px; font-weight:800;">데이터 로딩중...</div>
  </div>
</div>





  <main class="app-content">
    <!-- 탭 0: 종합일정표 -->
    <div id="view-0" style="display: block;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <button class="mini-btn primary" onclick="goToday()"><i class="fa-solid fa-calendar-day"></i> 오늘</button>
          <div style="display:flex; align-items:center; gap:8px;">
            <i class="fa-solid fa-circle-chevron-left" style="font-size:22px; color:var(--blue); cursor:pointer;" onclick="changeWeek(-1)"></i>
            <span id="week-range" style="font-weight:900; font-size:13px; min-width:120px; text-align:center;">...</span>
            <i class="fa-solid fa-circle-chevron-right" style="font-size:22px; color:var(--blue); cursor:pointer;" onclick="changeWeek(1)"></i>
          </div>
        </div>
        <div class="schedule-wrapper">
          <table class="schedule-table">
            <thead id="sched-head"></thead>
            <tbody id="sched-body"></tbody>
          </table>
        </div>
    </div>

    <!-- 탭 1: 금일 일정 -->
    <div id="view-1" style="display: none;">
      <div style="background:#fff; padding:10px; border-radius:8px; margin-bottom:10px; text-align:center;">
        <div style="font-size:16px; font-weight:900; color:var(--blue-deep);" id="today-date-display">오늘의 수송 일정</div>
      </div>
      <div id="today-timeline-container" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>

<!-- 탭 2: 강사 수송 -->
<div id="view-2" style="display: none; height:100%; display:flex; flex-direction:column;">
  <div style="padding: 5px; background: #fff; border-bottom: 1px solid #ddd; display:flex; justify-content:flex-end; flex-shrink:0;">
    <button class="mini-btn" onclick="clearFinished()"><i class="fa-solid fa-broom"></i> 완료목록 정리</button>
  </div>
  <div style="flex:1; overflow-y:auto; background:#abc1d1;">
    <div class="chat-container" id="chat-list-inner"></div>
  </div>
</div>

    <!-- 탭 3: 퇴교 수송 -->
    <div id="view-3" style="display: none;">
      <div class="list-wrapper">
        <div class="list-header">
          <div>과정명</div>
          <div>인원</div>
          <div>출발시간</div>
          <div>공지</div>
        </div>
        <div id="trainee-list-body"></div>
      </div>
    </div>
  </main>
</div>

<!-- 운행불가 공지 모달 -->
<div id="dayOffModal" class="modal-overlay" onclick="if(event.target==this) closeModal('dayOffModal')">
  <div class="modal-box">
    <div style="font-weight:900; font-size:17px; margin-bottom:15px; border-bottom:2px solid var(--danger); padding-bottom:8px;">운행불가 일정 등록</div>
    <input type="date" id="off-date" class="modal-input">
    <select id="off-reason" class="modal-input">
        <option value="건강검진">건강검진</option>
        <option value="연차">연차</option>
        <option value="차량고장">차량고장</option>
        <option value="직접입력">직접입력</option>
    </select>
    <input type="text" id="off-custom" class="modal-input" placeholder="직접 입력 시 사유를 적어주세요" style="display:none;">
    <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="modal-input" style="background:#f1f5f9; border:none;" onclick="closeModal('dayOffModal')">취소</button>
        <button class="modal-input" style="background:var(--danger); color:#fff; border:none;" onclick="saveDayOff()">등록</button>
    </div>
  </div>
</div>

<!-- 일정 관리 모달 -->
<div id="allInOneModal" class="modal-overlay" onclick="if(event.target==this) closeModal('allInOneModal')">
  <div class="modal-box">
    <div id="m-header" style="font-weight:900; font-size:17px; margin-bottom:15px; border-bottom:2px solid var(--blue); padding-bottom:8px;">일정 상세 관리</div>
    <input type="date" id="m-date" class="modal-input">
    <select id="m-type" class="modal-input" onchange="toggleReasonInput()">
        <option value="prof">강사 수송 추가</option>
        <option value="off">운행 불가(OFF) 설정</option>
    </select>
<!-- 2-1. 입력 필드 지능형 구성 (Ctrl+F: id="reason-area" 검색) -->
    <div id="reason-area">
        <!-- 강사명 입력 (제주맨 삭제) -->
        <input type="text" id="m-reason" class="modal-input" placeholder="강사 성함을 입력하세요">
        
        <div id="prof-fields">
          <input type="time" id="m-time" class="modal-input">
          
          <!-- 방향 및 목적지 선택 -->
          <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <select id="m-dir-type" class="modal-input" style="flex: 1; margin-bottom: 0;">
              <option value="arrival">항기원 도착</option>
              <option value="departure">항기원 출발</option>
            </select>
            <select id="m-dir-loc" class="modal-input" style="flex: 1; margin-bottom: 0;">
              <option value="오송역">오송역</option>
              <option value="청주공항">청주공항</option>
              <option value="청주터미널">청주터미널</option>
              <option value="직접입력">직접입력</option>
            </select>
          </div>
          <!-- 직접입력 시 나타날 칸 -->
          <input type="text" id="m-dir-custom" class="modal-input" placeholder="목적지를 직접 입력하세요" style="display:none;">
          <input type="tel" id="m-phone" class="modal-input" placeholder="강사 연락처">
        </div>
    </div>
    <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="modal-input" style="background:#f1f5f9; border:none;" onclick="closeModal('allInOneModal')">취소</button>
        <button class="modal-input" style="background:var(--blue); color:#fff; border:none;" onclick="saveAllInOne()">저장</button>
    </div>
    <button id="del-btn" style="width:100%; height:40px; margin-top:10px; background:var(--danger); color:#fff; border:none; border-radius:8px; font-weight:800; display:none;" onclick="deleteRecord()">삭제하기</button>
  </div>
</div>

<script src="config.js"></script>
<script>
  let allCourses = {}, profReqs = [], weekOffset = 0, currentTab = 0, draggedItem = null;

function init() {
  document.getElementById('loading-spinner').style.display = 'flex';

  const now = new Date();
  const day = now.getDay(); 
  
  // ✨ 금요일(5), 토요일(6), 일요일(0) 일 때 다음 주 보기
  weekOffset = (day === 5 || day === 6 || day === 0) ? 1 : 0; 

  firebase.database().ref('courses').on('value', snap => { 
    allCourses = snap.val() || {}; 
    renderAll(); 
    document.getElementById('loading-spinner').style.display = 'none';
  });
    







    firebase.database().ref('system/transport_requests').on('value', snap => {
      const raw = snap.val() || {};
      let pendingCount = 0;
      profReqs = Object.keys(raw).map(k => {
        const item = { id: k, ...raw[k] };
        if(item.status === 'pending') pendingCount++;
        return item;
      }).sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0));
      updateBadge(pendingCount);
      renderAll();
    });

    // 운행불가 사유 선택 변경 시
    document.getElementById('off-reason').addEventListener('change', function() {
      const custom = document.getElementById('off-custom');
      custom.style.display = this.value === '직접입력' ? 'block' : 'none';
    });
  }







function renderSchedule() {
  const head = document.getElementById('sched-head'), body = document.getElementById('sched-body');
  const range = getWeekDates(weekOffset);
  document.getElementById('week-range').innerText = `${range[0]} ~ ${range[4].substring(5)}`;
  head.innerHTML = `<tr><th class="time-col">시간</th>${['월','화','수','목','금'].map((day, i) => `<th>${range[i].substring(5)}<br>${day}</th>`).join('')}</tr>`;

  let html = '';
  for(let h=8; h<=18; h++) {
    const timeLabel = `${h}:00`;
    html += `<tr><td class="time-col">${timeLabel}</td>`;
    
    for(let d=0; d<5; d++) {
      const curDate = range[d];
      let cell = '';

      // 1. 운행불가 체크
      const offDayItem = profReqs.find(r => r.date === curDate && r.prof === '운행중단' && r.status !== 'cancelled');

      if(offDayItem && h !== 12) {
        cell = `<div class="cell-event block-off" onclick="openEditModal('${offDayItem.id}')">운행불가<br>${offDayItem?.dir || ''}</div>`;
      }
      // 2. 입교수송 (월요일 9~10시)
      else if(d === 0 && (h === 9 || h === 10)) {
        cell = `<div class="cell-event block-entry">입교수송</div>`;
      }
      // 3. 점심시간
      else if(h === 12) {
        cell = `<div class="cell-休">휴게시간</div>`;
      }
      else {
        // 4. 강사수송 (지능형 요약 로직)
        const matches = profReqs.filter(r => r.date === curDate && parseInt(r.time?.split(':')[0]) === h && r.status !== 'cancelled' && r.prof !== '운행중단');
        
        if(matches.length > 0) {
          const first = matches[0];
          // 2명 이상이면 "외 N명" 표시, 1명이면 "구간/성함" 표시
          const displayStr = matches.length > 1 
            ? `${first.dir}<br>외 ${matches.length - 1}건` 
            : `${first.dir}<br>${first.prof}`;
          
          cell = `<div class="cell-event block-prof" onclick="${matches.length > 1 ? 'switchTab(2)' : `openEditModal('${first.id}')`}">${displayStr}</div>`;
        }
        
        // 5. 퇴교수송 (강사수송이 없을 때만 표시하거나 겹치게 처리)
        if(!cell) {
          for(let rid in allCourses) {
            const dep = allCourses[rid]?.shuttle?.departure;
            if(dep && dep.date === curDate && parseInt(dep.time?.split(':')[0]) === h) {
              cell = `<div class="cell-event block-departure" onclick="switchTab(3)">퇴교수송</div>`;
              break;
            }
          }
        }
      }
      
      html += `<td onclick="handleCellClick(event, '${curDate}', '${h}:00')">${cell}</td>`;
    }
    html += `</tr>`;
  }
  body.innerHTML = html;
}







function renderTodayTimeline() {
  const container = document.getElementById('today-timeline-container');
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('today-date-display').innerText = `${today} 수송 일정`;

  // 오늘의 모든 일정 수집
  const todaySchedule = [];

  // 입교수송 (월요일만)
  const dayOfWeek = new Date(today).getDay();
  if(dayOfWeek === 1) {
    todaySchedule.push({ time: '09:00', type: '입교수송', desc: '신규 교육생 입교 수송' });
    todaySchedule.push({ time: '10:00', type: '입교수송', desc: '신규 교육생 입교 수송' });
  }

  // 강사 수송
  profReqs.filter(r => r.date === today && r.status !== 'cancelled').forEach(item => {
    if(item.prof === '운행중단') {
      todaySchedule.push({ 
        id: item.id,
        time: item.time, 
        type: '운행불가', 
        desc: item.dir || '사유 없음',
        route: '',
        completed: item.status === 'finished'
      });
    } else {
      todaySchedule.push({ 
        id: item.id,
        time: item.time, 
        type: '강사수송', 
        desc: `${item.prof || '강사'} 픽업`,
        route: item.dir || '구간 정보 없음',
        completed: item.status === 'finished'
      });
    }
  });

  // 퇴교수송
  for(let rid in allCourses) {
    const dep = allCourses[rid]?.shuttle?.departure;
    if(dep && dep.date === today) {
      const courseName = allCourses[rid].settings?.courseName || '과정명 없음';
      const total = Object.values(allCourses[rid].shuttle?.requests || {}).filter(r => r.type !== 'car').length;
      todaySchedule.push({ 
        time: dep.time, 
        type: '퇴교수송', 
        desc: `${courseName} (${total}명)`,
        route: '항기원 → 청주공항/오송역'
      });
    }
  }

  // 시간순 정렬
  todaySchedule.sort((a, b) => (a.time || '').localeCompare(b.time || ''));

  let html = '';
  if(todaySchedule.length === 0) {
    html = '<div class="timeline-card"><div style="text-align:center; color:#999;">오늘은 예정된 수송 일정이 없습니다.</div></div>';
  } else {
    todaySchedule.forEach(item => {
      html += `<div class="timeline-card" style="${item.completed ? 'opacity:0.5; background:#f1f5f9;' : ''}">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div class="timeline-time"><i class="fa-solid fa-clock"></i> ${item.time}</div>
          ${item.id ? `<label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
            <input type="checkbox" ${item.completed ? 'checked' : ''} onchange="toggleComplete('${item.id}')" style="width:20px; height:20px; cursor:pointer;">
            <span style="font-size:10px; color:#666;">완료</span>
          </label>` : ''}
        </div>
        <div class="timeline-item">
          <div style="font-size:14px; font-weight:900; margin-bottom:4px; ${item.completed ? 'text-decoration:line-through; color:#999;' : ''}">${item.type}</div>
          <div style="${item.completed ? 'color:#999;' : ''}">${item.desc}</div>
          ${item.route ? `<div class="timeline-route"><i class="fa-solid fa-route"></i> ${item.route}</div>` : ''}
        </div>
      </div>`;
    });
  }
  container.innerHTML = html;
}







function renderInstructorChat() {
  if(currentTab !== 2) return;

  const box = document.getElementById('chat-list-inner');
  let html = "";
  let firstUnreadIndex = -1;
  
  profReqs.forEach((r, idx) => {
    const isPending = r.status === 'pending';
    const isMine = r.status === 'approved' || r.status === 'finished';
    const isCancelled = r.status === 'cancelled';
    const isFinished = r.status === 'finished';
    
    // 첫 번째 안읽은 메시지 위치 저장
    if(firstUnreadIndex === -1 && isPending) {
      firstUnreadIndex = idx;
    }
    
    if(isCancelled) {
      // 취소 알림은 최신 메시지로
      html += `<div class="cancel-notice"><span><i class="fa-solid fa-ban"></i> ${r.prof || '강사'} 수송 요청이 취소되었습니다</span></div>`;
    } else {
      // ✨ 완료된 메시지는 회색 음영 처리
      const cardStyle = isFinished ? 'opacity:0.5; filter:grayscale(80%);' : '';
      const bgColor = isFinished ? '#e5e5e5' : (isMine ? '#fee500' : '#fff');
      
      html += `<div class="req-card ${isMine?'mine':''}" style="${cardStyle} background:${bgColor};" data-id="${r.id}">
        <div style="font-size:9px; color:${isPending?'var(--danger)':'#666'}; font-weight:800; margin-bottom:2px;">
          ${isPending?'● 신규요청':(isFinished?'✓ 운행완료':'✓ 확인됨')}
        </div>
        <div style="font-weight:900; font-size:13px; margin-bottom:3px;">${isPending?'승인 대기':(isFinished?'운행완료':'승인완료!')}</div>
        <div style="font-weight:700; font-size:12px; margin-bottom:2px;">${r.date || '날짜없음'}</div>
        <div style="font-weight:700; font-size:12px; margin-bottom:2px;">${r.time || '--:--'}</div>
        <div style="font-size:11px; font-weight:600; color:var(--blue-deep); margin-bottom:2px;">
          <i class="fa-solid fa-route"></i> ${r.dir || '구간 정보 없음'}
        </div>
        <div style="font-size:10px; color:#047857; font-weight:700; margin-bottom:3px;">
          예상도착: ${calculateETA(r.time, r.dir)}
        </div>
        <div style="font-size:11px; font-weight:600;">
          ${r.prof || '이름없음'} 강사님 픽업
          ${r.phone ? 
            `<a href="tel:${r.phone}"><i class="fa-solid fa-phone" style="color:var(--blue); margin-left:5px;"></i></a>` 
            : 
            `<span style="color:#999; margin-left:5px; font-size:9px;">(연락처 없음)</span>`
          }
        </div>
        ${isPending ? `<div class="req-btn-group" style="margin-top:6px;">
          <button class="mini-btn primary" onclick="approveRequest('${r.id}')"><i class="fa-solid fa-check"></i> 승인</button>
          <button class="mini-btn" onclick="cancelRequest('${r.id}')"><i class="fa-solid fa-times"></i> 불가</button>
        </div>` : `<div style="font-size:10px; color:#666; margin-top:6px; text-align:center;">${isFinished?'운행 완료됨':'확인했습니다'}</div>`}
      </div>`;
    }
  });
  
  box.innerHTML = html;
  
  // ✨ 안읽은 메시지가 있으면 그곳으로 스크롤
  if(currentTab === 2) {
    setTimeout(() => {
      if(firstUnreadIndex >= 0) {
        const firstUnread = box.querySelector(`[data-id="${profReqs[firstUnreadIndex].id}"]`);
        if(firstUnread) {
          firstUnread.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      } else {
        // 안읽은게 없으면 맨 아래로
        box.parentElement.scrollTop = box.parentElement.scrollHeight;
      }
    }, 100);
  }
}











function renderTraineeGrid() {
  const container = document.getElementById('trainee-list-body');
  let html = "";
  Object.keys(allCourses).forEach(rid => {
    const room = allCourses[rid]; 
    if(room.status?.roomStatus !== 'active') return;
    const dep = room.shuttle?.departure || { time: "", announced: false };
    const total = Object.values(room.shuttle?.requests || {}).filter(r => r.type !== 'car').length;
    
    // 13:00부터 18:00까지 선택 옵션 만들기
    let timeOptions = `<option value="">시간 선택</option>`;
    for(let h=13; h<=18; h++) {
      const t1 = h + ":00";
      const t2 = h + ":30";
      timeOptions += `<option value="${t1}" ${dep.time===t1?'selected':''}>${t1}</option>`;
      if(h !== 18) timeOptions += `<option value="${t2}" ${dep.time===t2?'selected':''}>${t2}</option>`;
    }

    html += `<div class="course-row">
      <div class="t-cell">${room.settings?.courseName || '과정명'}</div>
      <div class="t-cell" style="color:var(--blue); font-weight:900;">${total}명</div>
      <div class="t-cell">
        <select class="time-input" style="width:90%;" onchange="setDeparture('${rid}', this.value)">
          ${timeOptions}
        </select>
      </div>
      <div class="t-cell">
        <button class="notice-btn ${dep.announced?'active':''}" onclick="toggleNotice('${rid}', ${dep.announced})">
          <i class="fa-solid fa-bullhorn"></i>
        </button>
      </div>
    </div>`;
  });
  container.innerHTML = html;
}
  async function setDeparture(rid, time) { 
    if(!time) return;
    const depDate = allCourses[rid].shuttle?.departure?.date || new Date().toISOString().split('T')[0];
    await firebase.database().ref(`courses/${rid}/shuttle/departure`).update({ time, date: depDate }); 
    alert(time + " 수송 확정");
  }

  async function toggleNotice(rid, stat) { 
    if(confirm(`${stat?'공지를 취소할까요?':'확성기 공지를 완료했습니까?'}`)) {
      await firebase.database().ref(`courses/${rid}/shuttle/departure`).update({ announced: !stat });
    }
  }

  function getWeekDates(offset) {
    const now = new Date();
    const day = now.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    const monday = new Date(now);
    monday.setDate(now.getDate() + diff + (offset * 7));
    const res = [];
    for(let i=0; i<5; i++) {
      const d = new Date(monday); 
      d.setDate(monday.getDate()+i);
      res.push(d.toISOString().split('T')[0]);
    }
    return res;
  }

  function handleCellClick(ev, date, time) {
    if(ev.target.closest('.cell-event') || (date.includes('Monday') && (time==='9:00'||time==='10:00'))) return;
    openEmptyCell(date, time);
  }

  async function approveRequest(id) { 
    await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'approved' }); 
  }

  async function cancelRequest(id) { 
    if(confirm("불가 처리하시겠습니까?")) {
      await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'cancelled' }); 
    }
  }

  function onDragStart(ev, id) { draggedItem = id; }
  function onDragEnter(ev) { 
    let t = ev.target.closest('td'); 
    if(t) t.classList.add('drop-target'); 
  }
  function onDragLeave(ev) { 
    let t = ev.target.closest('td'); 
    if(t) t.classList.remove('drop-target'); 
  }

  async function onDrop(ev, date, time) {
    ev.preventDefault(); 
    onDragLeave(ev); 
    if(!draggedItem) return;
    const req = profReqs.find(r => r.id === draggedItem);
    const newTime = time.split(':')[0] + ":" + (req.time ? req.time.split(':')[1] : "00");
    if(confirm(`${date} ${newTime}으로 변경할까요?`)) { 
      await firebase.database().ref(`system/transport_requests/${draggedItem}`).update({ date, time: newTime }); 
    }
    draggedItem = null;
  }

  function openEmptyCell(date, time) {
    document.getElementById('m-header').innerText = "새 일정 추가"; 
    document.getElementById('m-date').value = date; 
    document.getElementById('m-time').value = time;
    document.getElementById('prof-fields').style.display = 'block'; 
    document.getElementById('m-type').value = 'prof';
    document.getElementById('del-btn').style.display = 'none'; 
    document.getElementById('allInOneModal').style.display = 'flex';
  }

function openEditModal(id) {
  const item = profReqs.find(r => r.id === id); 
  if(!item) return;
  
  document.getElementById('m-header').innerText = "일정 수정"; 
  document.getElementById('m-date').value = item.date; 
  document.getElementById('m-time').value = item.time;
  document.getElementById('m-reason').value = item.prof === '운행중단' ? "" : item.prof;
  document.getElementById('m-phone').value = item.phone || "";

  // 방향 분석 로직
  const dirText = item.dir || "";
  if(dirText.includes('→항기원')) {
    document.getElementById('m-dir-type').value = 'arrival';
    const loc = dirText.replace('→항기원', '');
    setLocValue(loc);
  } else if(dirText.includes('항기원→')) {
    document.getElementById('m-dir-type').value = 'departure';
    const loc = dirText.replace('항기원→', '');
    setLocValue(loc);
  }

  document.getElementById('m-type').value = item.prof === '운행중단' ? 'off' : 'prof'; 
  toggleReasonInput();
  document.getElementById('allInOneModal').dataset.editId = id; 
  document.getElementById('del-btn').style.display = 'block'; 
  document.getElementById('allInOneModal').style.display = 'flex';
}




// 목적지 선택창 세팅 도와주는 함수 (추가)
function setLocValue(loc) {
  const locSelect = document.getElementById('m-dir-loc');
  const customInput = document.getElementById('m-dir-custom');
  if(['오송역', '청주공항', '청주터미널'].includes(loc)) {
    locSelect.value = loc;
    customInput.style.display = 'none';
  } else {
    locSelect.value = '직접입력';
    customInput.value = loc;
    customInput.style.display = 'block';
  }
}











  function openDayOffModal() {
    toggleSidebar();
    document.getElementById('dayOffModal').style.display = 'flex';
  }

  async function saveDayOff() {
    const date = document.getElementById('off-date').value;
    const reasonSel = document.getElementById('off-reason').value;
    const customReason = document.getElementById('off-custom').value;
    const reason = reasonSel === '직접입력' ? customReason : reasonSel;
    
    if(!date || !reason) {
      alert('날짜와 사유를 모두 입력해주세요');
      return;
    }

  const existingSchedules = profReqs.filter(r => 
    r.date === date && 
    r.prof !== '운행중단' && 
    r.status !== 'cancelled'
  );
  
  if(existingSchedules.length > 0) {
    const list = existingSchedules.map(s => `${s.time} ${s.prof}`).join('\n');
    if(!confirm(`⚠️ 해당 날짜에 아래 일정이 있습니다:\n\n${list}\n\n운행불가로 설정하시겠습니까?`)) {
      return;
    }
  }





    const data = { 
      date, 
      time: '09:00',
      prof: '운행중단', 
      dir: reason, 
      status: 'approved', 
      timestamp: Date.now() 
    };
    
    await firebase.database().ref('system/transport_requests').push(data);
    closeModal('dayOffModal');
    alert('운행불가 일정이 등록되었습니다');
  }

async function saveAllInOne() {
  const id = document.getElementById('allInOneModal').dataset.editId; 
  const type = document.getElementById('m-type').value;
  const date = document.getElementById('m-date').value;
  const time = document.getElementById('m-time').value;
  const profName = document.getElementById('m-reason').value;
  const phone = document.getElementById('m-phone').value;

  // 방향 및 목적지 합치기
  const dirType = document.getElementById('m-dir-type').value;
  const dirLoc = document.getElementById('m-dir-loc').value;
  const customLoc = document.getElementById('m-dir-custom').value;
  
  const finalLoc = (dirLoc === '직접입력') ? customLoc : dirLoc;
  const finalDir = (dirType === 'arrival') ? `${finalLoc}→항기원` : `항기원→${finalLoc}`;

  if(type === 'prof' && !profName) { alert("강사 성함을 입력해주세요."); return; }

  const data = { 
    date, time, 
    prof: type === 'off' ? '운행중단' : profName, 
    dir: finalDir,
    phone: phone,
    status: 'approved', 
    timestamp: Date.now() 
  };
  
  if(id) {
    await firebase.database().ref(`system/transport_requests/${id}`).update(data);
  } else {
    await firebase.database().ref('system/transport_requests').push(data);
  }
  closeModal('allInOneModal');
}













  async function deleteRecord() { 
    if(confirm("삭제할까요?")) { 
      await firebase.database().ref(`system/transport_requests/${document.getElementById('allInOneModal').dataset.editId}`).remove(); 
      closeModal('allInOneModal'); 
    } 
  }

  function toggleSidebar() { 
    const sb = document.getElementById('sidebar');
    const ol = document.querySelector('.sidebar-overlay');
    const isOpen = sb.classList.contains('open'); 
    sb.classList.toggle('open', !isOpen); 
    ol.style.display = isOpen ? 'none' : 'block'; 
  }

  function switchTab(n) { 
    currentTab = n; 
    document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === n)); 
    document.querySelectorAll('[id^="view-"]').forEach((v, i) => v.style.display = i === n ? 'block' : 'none'); 
    renderAll(); 
  }

  function updateBadge(count) { 
    const b = document.getElementById('badge-count'); 
    if(count > 0) { 
      b.innerText = count; 
      b.style.display = 'block'; 
    } else {
      b.style.display = 'none'; 
    }
  }

function renderAll() { 
  renderSchedule(); 
  
  // 금일일정은 탭1일 때만
  if(currentTab === 1) {
    renderTodayTimeline();
  }
  
  // 강사수송은 탭2일 때만
  if(currentTab === 2) {
    renderInstructorChat();
  }
  
  // 퇴교수송은 탭3일 때만
  if(currentTab === 3) {
    renderTraineeGrid();
  }
}







  function changeWeek(n) { 
    weekOffset += n; 
    renderAll(); 
  }

function goToday() { 
  const now = new Date();
  const day = now.getDay(); 
  // ✨ 금요일(5), 토요일(6), 일요일(0) 일 때 다음 주 보기
  weekOffset = (day === 5 || day === 6 || day === 0) ? 1 : 0;
  renderAll();
}



  function closeModal(id) { 
    document.getElementById(id).style.display = 'none'; 
    delete document.getElementById(id).dataset.editId; 
  }

  function toggleReasonInput() { 
    document.getElementById('prof-fields').style.display = document.getElementById('m-type').value==='off'?'none':'block'; 
  }

  async function clearFinished() { 
    if(confirm("완료된 내역을 정리할까요?")) { 
      profReqs.filter(r => r.status==='finished' || r.status==='cancelled').forEach(t => firebase.database().ref(`system/transport_requests/${t.id}`).remove()); 
    } 
  }



// ✨ 여기에 추가!
async function toggleComplete(id) {
  const item = profReqs.find(r => r.id === id);
  if(!item) return;
  
  await firebase.database().ref(`system/transport_requests/${id}`).update({
    status: item.status === 'finished' ? 'approved' : 'finished'
  });
}








  function handleBack() { 
    if(confirm("포탈로 이동할까요?")) location.href = 'potal.html'; 
  }

  function allowDrop(ev) { 
    ev.preventDefault(); 
  }
  

function calculateETA(startTime, route) {
  if(!startTime || !route) return '시간 미정';
  
  const [hour, min] = startTime.split(':').map(Number);
  let totalMinutes = hour * 60 + min;
  
  // 구간별 30분씩 계산
  const segments = route.split('→').length - 1;
  totalMinutes += segments * 30;
  
  const etaHour = Math.floor(totalMinutes / 60);
  const etaMin = totalMinutes % 60;
  
  return `${String(etaHour).padStart(2,'0')}:${String(etaMin).padStart(2,'0')}`;
}


// 목적지 선택 변경 시 직접입력창 제어
document.getElementById('m-dir-loc')?.addEventListener('change', function() {
  document.getElementById('m-dir-custom').style.display = (this.value === '직접입력') ? 'block' : 'none';
});


  init();
</script>
</body>
</html>