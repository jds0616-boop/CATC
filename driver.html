<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>KAC Driver Monitoring</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Font Awesome & Pretendard Font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

 <style>
    :root {
      --navy-dark: #0f172a;
      --bg-light: #f1f5f9;
      --card-white: #ffffff;
      --text-dark: #1e293b;
      --accent-blue: #2563eb;
      --osong: #3b82f6;
      --term: #f59e0b;
      --air: #10b981;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; padding: 0; font-family: 'Pretendard', sans-serif;
      background: #e2e8f0; display: flex; justify-content: center; color: var(--text-dark);
      overflow: hidden; /* 전체 스크롤 방지 (내부 스크롤 사용) */
    }

    .app-container {
      width: 100%; max-width: 600px; height: 100dvh;
      background: var(--bg-light); position: relative; display: flex; flex-direction: column;
    }

    /* --- 상단바 --- */
    .app-header {
      height: 50px; background: var(--navy-dark);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; z-index: 1000; flex-shrink: 0;
    }
    .header-title { color: #fff; font-size: 16px; font-weight: 800; }

    /* --- 상단 탭 메뉴 --- */
    .tab-bar {
        display: flex; background: var(--navy-dark); height: 45px; padding: 0 10px; flex-shrink: 0;
    }
    .tab-btn {
        flex: 1; border: none; background: none; color: #94a3b8; font-weight: 800; font-size: 14px;
        cursor: pointer; position: relative;
    }
    .tab-btn.active { color: #fff; }
    .tab-btn.active::after {
        content: ''; position: absolute; bottom: 0; left: 20%; width: 60%; height: 3px; background: var(--accent-blue);
    }

    /* --- 메인 콘텐츠 --- */
    .app-content { flex: 1; overflow-y: auto; padding: 15px; position: relative; }

    /* [탭 1] 교육생 수송 스타일 */
    .main-summary {
      background: var(--card-white); border-radius: 20px; padding: 20px;
      text-align: center; margin-bottom: 15px; border: 1px solid #e2e8f0;
    }
    .summary-count { font-size: 50px; font-weight: 900; color: var(--navy-dark); line-height: 1; }
    .summary-count span { font-size: 18px; color: #94a3b8; margin-left: 5px; }

    .dest-card { background: #fff; border-radius: 15px; border: 1px solid #e2e8f0; overflow: hidden; margin-bottom: 10px; }
    .dest-header { padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; }
    .dest-info { display: flex; align-items: center; gap: 10px; font-weight: 800; }
    .dest-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #fff; }
    .osong .dest-icon { background: var(--osong); }
    .term .dest-icon { background: var(--term); }
    .air .dest-icon { background: var(--air); }

    /* [탭 2] 강사 수송 - 주간 일정표 스타일 */
    .week-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .nav-btn { background: #fff; border: 1px solid #cbd5e1; padding: 5px 12px; border-radius: 8px; font-weight: 800; font-size: 12px; }

    .schedule-table-wrapper { 
        width: 100%; overflow-x: auto; background: white; border-radius: 12px; border: 1px solid #cbd5e1;
    }
    .schedule-table { width: 100%; border-collapse: collapse; min-width: 500px; table-layout: fixed; }
    .schedule-table th, .schedule-table td { 
        border: 1px solid #eee; padding: 8px 4px; text-align: center; font-size: 11px; vertical-align: top;
    }
    .schedule-table th { background: #f8fafc; font-weight: 800; color: #64748b; height: 40px; }
    .schedule-table td { height: 80px; }
    .time-col { width: 50px; background: #f8fafc; font-weight: 800; color: #94a3b8; vertical-align: middle !important; }

    /* 일정 박스 */
    .job-box {
        font-size: 10px; border-radius: 4px; padding: 4px; margin-bottom: 4px; text-align: left; line-height: 1.3;
        font-weight: 700;
    }
    .job-to { background: #eff6ff; color: #1e40af; border-left: 3px solid #3b82f6; } /* 항기원 행 */
    .job-from { background: #fff7ed; color: #9a3412; border-left: 3px solid #f59e0b; } /* 항기원 발 */
    .job-off { background: #f1f5f9; color: #64748b; text-align: center; font-style: italic; } /* 운행불가 */

    /* 하단바 */
    .app-footer {
      height: 40px; background: var(--navy-dark); color: #94a3b8;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; font-size: 11px; flex-shrink: 0;
    }
    .footer-logo img { height: 16px; filter: brightness(0) invert(1); opacity: 0.8; }
  </style>
</head>

<body>
  <div class="app-container">
    <header class="app-header">
      <div class="header-title">KAC 수송 관리 시스템</div>
      <i class="fa-solid fa-rotate" style="color:white; cursor:pointer;" onclick="location.reload()"></i>
    </header>

    <div class="tab-bar">
        <button id="tab1" class="tab-btn active" onclick="switchTab(1)">교육생 수송</button>
        <button id="tab2" class="tab-btn" onclick="switchTab(2)">강사 수송 (주간)</button>
    </div>

    <main class="app-content">
      
      <!-- [탭 1] 교육생 수송 화면 -->
      <div id="view-student">
          <div class="main-summary">
              <div style="font-size:12px; font-weight:800; color:#64748b; margin-bottom:8px;">교육생 셔틀 탑승 총원</div>
              <div class="summary-count" id="total-all">0<span>명</span></div>
          </div>

          <div id="student-list-container">
              <!-- 목적지 카드들 JS 생성 -->
          </div>
      </div>

      <!-- [탭 2] 강사 수송 화면 (주간 일정표) -->
      <div id="view-teacher" style="display:none;">
          <div class="week-nav">
              <button class="nav-btn" onclick="changeWeek(-7)"><i class="fa-solid fa-chevron-left"></i> 이전 주</button>
              <span id="current-week-label" style="font-weight:900; font-size:14px; color:#0f172a;">2024.01.19 ~ 01.25</span>
              <button class="nav-btn" onclick="changeWeek(7)">다음 주 <i class="fa-solid fa-chevron-right"></i></button>
          </div>

          <div class="schedule-table-wrapper">
              <table class="schedule-table">
                  <thead>
                      <tr id="table-header-days">
                          <th class="time-col">시간</th>
                          <!-- 날짜 헤더 JS 생성 -->
                      </tr>
                  </thead>
                  <tbody id="schedule-body">
                      <!-- 시간대별 행 JS 생성 -->
                  </tbody>
              </table>
          </div>

          <div style="margin-top:15px; background:#fff; padding:12px; border-radius:12px; font-size:12px; border:1px solid #e2e8f0;">
              <div style="font-weight:800; margin-bottom:5px; color:#6366f1;"><i class="fa-solid fa-circle-info"></i> 기사용 안내</div>
              • 시간대를 클릭하면 <b style="color:#ef4444;">[운행불가]</b> 상태를 설정할 수 있습니다.<br>
              • 하늘색은 목적지에서 들어오는 일정, 주황색은 나가는 일정입니다.
          </div>
      </div>

    </main>

    <footer class="app-footer">
      <div id="footer-time">00:00</div>
      <div class="footer-logo"><img src="logo.png" alt="KAC"></div>
    </footer>
<!-- [추가] 상세 명단 확인용 팝업 모달 (기사용) -->
  <div id="listModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:5000; align-items:center; justify-content:center; padding:20px;">
      <div style="background:white; width:100%; max-width:400px; border-radius:24px; overflow:hidden; display:flex; flex-direction:column; max-height:80vh; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
          <div style="background:#0f172a; color:white; padding:18px; display:flex; justify-content:space-between; align-items:center;">
              <h3 id="listModalTitle" style="margin:0; font-size:17px;">탑승객 명단</h3>
              <i class="fa-solid fa-xmark" style="cursor:pointer; font-size:20px;" onclick="closeListModal()"></i>
          </div>
          <div id="listModalContent" style="padding:25px; overflow-y:auto; font-size:15px; line-height:1.8; color:#1e293b;"></div>
          <button style="width:100%; padding:18px; border:none; background:#f1f5f9; font-weight:800; color:#475569; font-size:16px; cursor:pointer;" onclick="closeListModal()">닫기</button>
      </div>
  </div>
  </div>

  <script src="config.js"></script>
  <script>
    // 인증 체크
    if(sessionStorage.getItem('kac_portal_auth') !== 'driver') {
        alert("인증이 필요합니다.");
        location.replace('portal.html');
    }

    let currentBaseDate = new Date(); // 일정표 기준 날짜 (해당 주의 월요일 계산용)
    let transportRequests = {}; // 강사 수송 데이터
    let driverOffSlots = {}; // 기사 운행불가 데이터

    // 탭 전환
    function switchTab(num) {
        document.getElementById('view-student').style.display = (num === 1) ? 'block' : 'none';
        document.getElementById('view-teacher').style.display = (num === 2) ? 'block' : 'none';
        document.getElementById('tab1').classList.toggle('active', num === 1);
        document.getElementById('tab2').classList.toggle('active', num === 2);
        if(num === 2) renderWeeklySchedule();
    }

    // --- [탭 1] 교육생 수송 로직 ---
    function initStudentTransport() {
        firebase.database().ref('courses').on('value', snap => {
            const data = snap.val() || {};
            const totals = { osong: 0, terminal: 0, airport: 0 };
            const details = { osong: [], terminal: [], airport: [] };

            Object.keys(data).forEach(rid => {
                const room = data[rid];
                if(room.shuttle) {
                    ['osong', 'terminal', 'airport'].forEach(loc => {
                        if(room.shuttle[loc]) {
                            const names = Object.values(room.shuttle[loc]);
                            totals[loc] += names.length;
                            if(names.length > 0) details[loc].push({ rid, count: names.length, names });
                        }
                    });
                }
            });

            document.getElementById('total-all').innerHTML = `${totals.osong + totals.terminal + totals.airport}<span>명</span>`;
            
            const container = document.getElementById('student-list-container');
            container.innerHTML = "";
            
            const locInfo = [
                { id: 'osong', name: '오송역', icon: 'fa-train' },
                { id: 'terminal', name: '청주터미널', icon: 'fa-bus' },
                { id: 'airport', name: '청주공항', icon: 'fa-plane' }
            ];

            locInfo.forEach(loc => {
                const card = document.createElement('div');
                card.className = `dest-card ${loc.id.substring(0,3)}`;
                card.innerHTML = `
                    <div class="dest-header" onclick="showStudentDetail('${loc.name}', ${JSON.stringify(details[loc.id]).replace(/"/g, '&quot;')})">
                        <div class="dest-info">
                            <div class="dest-icon"><i class="fa-solid ${loc.icon}"></i></div>
                            ${loc.name}
                        </div>
                        <div style="font-size:18px; font-weight:900;">${totals[loc.id]}명 ></div>
                    </div>
                `;
                container.appendChild(card);
            });
        });
    }

// [수정] 학생 명단을 전용 팝업 모달로 출력
    function showStudentDetail(title, data) {
        if(data.length === 0) return;
        const modal = document.getElementById('listModal');
        const content = document.getElementById('listModalContent');
        document.getElementById('listModalTitle').innerText = `${title} 탑승 명단`;
        
        let html = data.map(item => `
            <div style="margin-bottom:15px; padding-bottom:10px; border-bottom:1px dashed #e2e8f0;">
                <div style="font-weight:900; color:#2563eb; margin-bottom:4px;">[Room ${item.rid}]</div>
                <div style="font-weight:700;">${item.names.join(', ')}</div>
            </div>
        `).join('');
        
        content.innerHTML = html;
        modal.style.display = 'flex';
    }

    function closeListModal() {
        document.getElementById('listModal').style.display = 'none';
    }

    // --- [탭 2] 강사 수송 (주간 일정표) 로직 ---
    function renderWeeklySchedule() {
        const monday = getMonday(currentBaseDate);
        const days = [];
        for(let i=0; i<7; i++) {
            const d = new Date(monday);
            d.setDate(monday.getDate() + i);
            days.push(d);
        }

        // 헤더(날짜) 렌더링
        const headerRow = document.getElementById('table-header-days');
        headerRow.innerHTML = '<th class="time-col">시간</th>';
        const dayNames = ['월','화','수','목','금','토','일'];
        days.forEach((d, i) => {
            const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
            headerRow.innerHTML += `<th>${dateStr}(${dayNames[i]})</th>`;
        });

        document.getElementById('current-week-label').innerText = 
            `${days[0].getFullYear()}.${days[0].getMonth()+1}.${days[0].getDate()} ~ ${days[6].getMonth()+1}.${days[6].getDate()}`;

        // 바디(시간대) 렌더링 (08:00 ~ 18:00)
        const body = document.getElementById('schedule-body');
        body.innerHTML = "";
        for(let h=8; h<=18; h++) {
            const row = document.createElement('tr');
            const timeStr = `${h.toString().padStart(2,'0')}:00`;
            row.innerHTML = `<td class="time-col">${timeStr}</td>`;
            
            days.forEach(d => {
                const dateKey = getTodayString(d);
                const td = document.createElement('td');
                
                // 점심시간 처리
                if(h === 12) {
                    td.innerHTML = '<div class="job-box job-off">점심시간</div>';
                } else {
                    td.onclick = () => toggleDriverOff(dateKey, h);
                    
                    // 1. 기사 운행불가 확인
                    if(driverOffSlots[dateKey] && driverOffSlots[dateKey][h]) {
                        td.innerHTML = `<div class="job-box job-off">${driverOffSlots[dateKey][h]}</div>`;
                    }
                    
                    // 2. 강사 수송 요청 확인
                    const dayReqs = Object.values(transportRequests).filter(r => r.date === dateKey && parseInt(r.time.split(':')[0]) === h);
                    dayReqs.forEach(req => {
                        const isTo = req.dir.includes('목적지→');
                        const cls = isTo ? 'job-to' : 'job-from';
                        const locShort = req.loc.substring(0,2);
                        td.innerHTML += `<div class="job-box ${cls}">${req.time} ${locShort}<br>${req.prof}</div>`;
                    });
                }
                row.appendChild(td);
            });
            body.appendChild(row);
        }
    }

    function getMonday(d) {
        d = new Date(d);
        const day = d.getDay();
        const diff = d.getDate() - day + (day == 0 ? -6 : 1); 
        return new Date(d.setDate(diff));
    }

    function changeWeek(days) {
        currentBaseDate.setDate(currentBaseDate.getDate() + days);
        renderWeeklySchedule();
    }

    // 기사 운행불가 토글
    function toggleDriverOff(date, hour) {
        const current = (driverOffSlots[date] && driverOffSlots[date][hour]) ? driverOffSlots[date][hour] : null;
        if(current) {
            if(confirm("이 시간의 운행불가 설정을 해제하시겠습니까?")) {
                firebase.database().ref(`system/driver_status/${date}/${hour}`).remove();
            }
        } else {
            const reason = prompt("운행불가 사유를 입력하세요 (예: 건강검진, 차량정비, 개인용무)\n입력 시 코디네이터가 예약할 수 없습니다.");
            if(reason) {
                firebase.database().ref(`system/driver_status/${date}/${hour}`).set(reason);
            }
        }
    }



// 날짜를 YYYY-MM-DD 형식으로 만드는 함수 (이게 있어야 일정이 저장됩니다)
    function getTodayString(d = new Date()) {
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }



    // 데이터 감시 시작
    function startDataMonitor() {
        // 1. 수송 요청 감시
        firebase.database().ref('system/transport_requests').on('value', s => {
            transportRequests = s.val() || {};
            if(document.getElementById('view-teacher').style.display === 'block') renderWeeklySchedule();
        });
        // 2. 기사 상태 감시
        firebase.database().ref('system/driver_status').on('value', s => {
            driverOffSlots = s.val() || {};
            if(document.getElementById('view-teacher').style.display === 'block') renderWeeklySchedule();
        });
    }

    // 시계
    function runClock() {
        const now = new Date();
        document.getElementById('footer-time').innerText = 
            `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    }
    setInterval(runClock, 1000); runClock();

    // 초기화
    initStudentTransport();
    startDataMonitor();
  </script>
</body>
</html>