
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>í•­ê³µê¸°ìˆ í›ˆë ¨ì› ì°¨ëŸ‰ì§€ì› ì‹œìŠ¤í…œ</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
<style>
    /* ... ê¸°ì¡´ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ìœ ì§€ (ìƒëµí•˜ì§€ ì•ŠìŒ) ... */
    :root {
      --navy: #0f172a; --blue: #0ea5e9; --blue-deep: #0369a1;
      --bg: #f1f5f9; --card: #ffffff; --border: #e2e8f0;
      --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
      --color-mon: #3b82f6; --color-tue: #10b981; --color-wed: #f59e0b; --color-thu: #8b5cf6; --color-fri: #ec4899;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
    body { margin: 0; padding: 0; background: #cfd8e3; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }
    
    .app-container { width: 100%; max-width: 600px; height: 100%; background: var(--bg); display: flex; flex-direction: column; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.2); }
    
    .app-header { height: 60px; background: var(--navy); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 2px solid var(--blue); flex-shrink: 0; }
    .header-title { font-size: 17px; font-weight: 900; color: #fff; letter-spacing: -0.5px; }
    .sync-status { font-size: 11px; color: var(--success); font-weight: 800; display: flex; align-items: center; gap: 5px; }

    .tab-bar { display: flex; background: #fff; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .tab-btn { flex: 1; padding: 16px 0; border: none; background: none; font-size: 14px; font-weight: 800; color: #94a3b8; cursor: pointer; border-bottom: 3px solid transparent; }
    .tab-btn.active { color: var(--blue-deep); border-bottom-color: var(--blue); background: #f8fafc; }

    .app-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }

    .global-status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 5px; }
    .stat-card-new { background: linear-gradient(135deg, #003366 0%, #0055aa 100%); border-radius: 18px; padding: 15px 10px; color: white; text-align: center; box-shadow: 0 6px 12px rgba(0,0,0,0.15); display: flex; flex-direction: column; justify-content: center; align-items: center; border: 1px solid rgba(255, 255, 255, 0.1); }
    .stat-label { font-size: 11px; font-weight: 700; opacity: 0.8; margin-bottom: 5px; }
    .stat-val { font-size: 26px; font-weight: 900; line-height: 1; color: #60a5fa; }
    .stat-val.orange { color: #fbbf24; }
    .stat-val.green { color: #4ade80; }
    .stat-val small { font-size: 14px; margin-left: 2px; font-weight: 700; }

    .list-wrapper { background: #fff; border-radius: 12px; border: 1.5px solid #e2e8f0; overflow: hidden; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .list-header, .course-row { display: grid; grid-template-columns: 1.5fr 0.6fr 1.8fr 0.6fr; align-items: center; text-align: center; width: 100%; }
    .list-header { background: #f1f5f9; border-bottom: 2px solid #cbd5e1; font-size: 11px; font-weight: 900; color: #475569; }
    .course-row { border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; }
    .course-row:last-child { border-bottom: none; }
    .course-row:active { background: #f8fafc; }

    .t-cell { padding: 12px 5px; height: 100%; display: flex; align-items: center; justify-content: center; border-right: 1px solid #f1f5f9; overflow: hidden; }
    .t-cell:last-child { border-right: none; }
    .t-cell.name { justify-content: center; font-size: 14px; font-weight: 800; color: #1e293b; padding: 0 10px; }
    .t-cell.count { font-size: 13px; font-weight: 900; color: #0ea5e9; border-right: 1px solid #e2e8f0; }
    .t-cell.btns { gap: 4px; padding: 8px 6px; width: 100%; }
    .mini-btn { height: 34px; flex: 1; border-radius: 6px; border: 1px solid #e2e8f0; background: #fff; font-size: 11px; font-weight: 800; color: #64748b; cursor: pointer; }
    .mini-btn.active { background: #0f172a !important; color: #fff !important; border-color: #0f172a !important; }
    .t-cell.status { font-size: 18px; }
    .notice-on { color: #10b981; } 
    .notice-off { color: #cbd5e1; }

    .week-nav { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 10px; background: #fff; padding: 12px; border-radius: 12px; border: 1px solid var(--border); }
    .nav-arrow { font-size: 24px; color: var(--blue-deep); cursor: pointer; }
    .week-label { font-size: 15px; font-weight: 900; color: var(--navy); }
    .schedule-wrapper { background: #fff; border: 1px solid #000; border-radius: 8px; overflow: hidden; }
    .schedule-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .schedule-table th, .schedule-table td { border: 1px solid #ddd; text-align: center; height: 50px; font-size: 9px; vertical-align: middle; padding: 2px; }
    .schedule-table th { background: #f1f5f9; font-weight: 900; height: 45px; color: var(--navy); border-bottom: 2px solid var(--navy); font-size: 10px; }
    .time-col { width: 45px; background: #f1f5f9 !important; font-weight: 800; border-right: 2px solid var(--navy) !important; font-size: 11px !important; }

    .capture-btn { width: 100%; height: 45px; background: #fff; border: 2px solid var(--blue); color: var(--blue-deep); border-radius: 12px; font-weight: 800; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 14px; }
    .capture-btn:active { background: var(--blue); color: #fff; }

    .cell-event { border-radius: 4px; padding: 4px 2px; height: 100%; display: flex; flex-direction: column; justify-content: center; font-weight: 800; line-height: 1.2; cursor: pointer; transition: background 0.2s; }
    .block-entry { background: #eff6ff; color: #1e40af; border: 1px solid #1e40af; }
    .block-prof { background: #fae8ff; color: #a21caf; border: 1px solid #a21caf; }
    .block-departure { background: #ecfdf5; color: #047857; border: 1px solid #047857; }
    .block-off { background: #fee2e2; color: #ef4444; }

    .chat-container { background: #abc1d1; display: flex; flex-direction: column; gap: 15px; padding: 15px; border-radius: 12px; min-height: 400px; }
    .chat-date-line { text-align: center; margin: 10px 0; }
    .chat-date-line span { background: rgba(0,0,0,0.2); color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 11px; }

    .chat-bubble { max-width: 85%; position: relative; display: flex; flex-direction: column; margin-bottom: 5px; }
    .chat-left { align-self: flex-start; }
    .bubble-content { background: #fff; padding: 12px; border-radius: 0 12px 12px 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 14px; line-height: 1.5; }
    .chat-right { align-self: flex-end; }
    .bubble-reply { background: #fee500; padding: 10px; border-radius: 12px 0 12px 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 13px; font-weight: 800; }

    .talk-header { color: #888; font-size: 12px; margin-bottom: 5px; font-weight: 800; }
    .talk-body { color: #1e293b; font-weight: 700; white-space: pre-line; }
    .talk-actions { display: flex; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; }
    .chat-time { font-size: 10px; color: #666; margin-top: 4px; align-self: flex-end; }

    .footer-home { width: 56px; height: 56px; background: var(--blue); color: #fff; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 24px; position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); box-shadow: 0 8px 20px rgba(0,0,0,0.3); cursor: pointer; border: 4px solid #fff; z-index: 10000; transition: 0.2s; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
    .modal-box { background: #fff; width: 100%; max-width: 440px; border-radius: 28px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); text-align: center; }
    .modal-title { font-size: 20px; font-weight: 900; color: var(--navy); margin-bottom: 15px; }
    .modal-desc { font-size: 15px; color: #475569; line-height: 1.6; margin-bottom: 25px; text-align: left; }
    .m-btn { flex: 1; height: 52px; border-radius: 14px; border: none; font-weight: 900; font-size: 16px; cursor: pointer; }
    .m-btn.ok { background: var(--blue); color: #fff; }
    .m-btn.no { background: #f1f5f9; color: #64748b; }

    .talk-leg-item { padding: 8px 0; border-bottom: 1px dashed #eee; }
    .talk-leg-item:last-child { border-bottom: none; }
    .mini-talk-btn { flex: 1; height: 32px; border-radius: 6px; border: 1px solid #e2e8f0; background: #fff; font-size: 11px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; }
</style>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>

<div class="app-container">
  <header class="app-header">
    <div id="back-btn-area" style="min-width:60px; color:#fff; font-size:18px; font-weight:900; cursor:pointer; display:flex; align-items:center;" onclick="handleBack()">
        <span id="back-btn-text">&lt;&lt;</span>
    </div>
    <div class="header-title">í•­ê³µê¸°ìˆ í›ˆë ¨ì› ì°¨ëŸ‰ì§€ì› ì‹œìŠ¤í…œ</div>
    <div class="sync-status"><i class="fa-solid fa-sync fa-spin"></i> ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</div>
  </header>

  <div class="tab-bar">
    <button id="tab0" class="tab-btn active" onclick="switchTab(0)">ì¢…í•© ì¼ì •í‘œ</button>
    <button id="tab1" class="tab-btn" onclick="switchTab(1)">ê°•ì‚¬ ìˆ˜ì†¡ ë¦¬ìŠ¤íŠ¸</button>
    <button id="tab2" class="tab-btn" onclick="switchTab(2)">êµìœ¡ìƒ í‡´êµ ê´€ë¦¬</button>
  </div>

  <main class="app-content" id="main-content">
    <div id="view-0" style="display: block;">
      <div id="capture-area" style="padding: 10px; background: var(--bg); border-radius: 12px;">
        <div class="week-nav">
          <i class="fa-solid fa-circle-chevron-left nav-arrow" onclick="changeWeek(-1)"></i>
          <div class="week-label" id="week-range">ë‚ ì§œ ê³„ì‚° ì¤‘...</div>
          <i class="fa-solid fa-circle-chevron-right nav-arrow" onclick="changeWeek(1)"></i>
        </div>
        <div class="schedule-wrapper">
          <table class="schedule-table">
            <thead id="sched-head"></thead>
            <tbody id="sched-body"></tbody>
          </table>
        </div>
      </div>
      <button class="capture-btn" onclick="captureSchedule()">
        <i class="fa-solid fa-camera"></i> í˜„ì¬ ì¼ì •í‘œ ì´ë¯¸ì§€ ì €ì¥ (ìº¡ì³)
      </button>
    </div>

    <div id="view-1" style="display: none;">
      <div id="all-request-container"></div> 
    </div>

    <div id="view-2" style="display: none;">
      <div id="trainee-course-list"></div>
    </div>
  </main>

  <div class="footer-home" id="floating-home" onclick="switchTab(0)"><i class="fa-solid fa-house"></i></div>
</div>

<div id="detailModal" class="modal-overlay" onclick="if(event.target==this) closeModal('detailModal')">
  <div class="modal-box">
    <div class="modal-title" id="m-title">ì •ë³´</div>
    <div id="m-content" class="modal-desc"></div>
    <div class="modal-btn-group"><button class="m-btn no" onclick="closeModal('detailModal')">ë‹«ê¸°</button></div>
  </div>
</div>

<div id="confirmModal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-title" id="c-title">í™•ì¸</div>
    <div id="c-desc" class="modal-desc">ë‚´ìš©</div>
    <div class="modal-btn-group">
        <button class="m-btn no" onclick="closeModal('confirmModal')">ì·¨ì†Œ</button>
        <button class="m-btn ok" id="c-ok-btn">í™•ì¸</button>
    </div>
  </div>
</div>

<script src="config.js"></script>

<script>
  let allCourses = {};
  let profReqs = [];
  let weekOffset = 0;
  let prevPendingCount = 0;
  const alarmAudio = new Audio('timer.mp3');

  function init() {
    firebase.database().ref('courses').on('value', snap => {
      allCourses = snap.val() || {}; 
      renderAll(); 
    });

    firebase.database().ref('system/transport_requests').on('value', snap => {
      const raw = snap.val() || {};
      // [ìˆ˜ì •] ê¹¨ì§„ ë°ì´í„°(í•„ìˆ˜ê°’ ëˆ„ë½) í•„í„°ë§ ì¶”ê°€
      profReqs = Object.keys(raw)
        .map(k => ({ id: k, ...raw[k] }))
        .filter(r => r.date && r.prof && r.courseRID && r.time);
      
      checkNewRequests();
      renderAll();
    });
  }

  function checkNewRequests() {
    const currentPending = profReqs.filter(r => r.status === 'pending').length;
    if (currentPending > prevPendingCount) playAlarm(2);
    prevPendingCount = currentPending;
  }

  function playAlarm(times) {
    let played = 0;
    const play = () => {
        alarmAudio.play().catch(e => {});
        played++;
        if (played < times) { alarmAudio.onended = play; } else { alarmAudio.onended = null; }
    };
    play();
  }

  function renderAll() { 
    try { renderSchedule(); } catch(e) {}
    try { renderInstructorList(); } catch(e) {}
    try { renderTraineeManagement(); } catch(e) {}
  }

  function renderSchedule() {
    const head = document.getElementById('sched-head');
    const body = document.getElementById('sched-body');
    const range = getWeekDates(weekOffset);
    const dayNames = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'];
    
    document.getElementById('week-range').innerText = `${range[0]} ~ ${range[4].substring(5)}`;
    head.innerHTML = `<tr><th class="time-col">ì‹œê°„</th>${range.map((d, i) => `<th onclick="askDayOff('${d}')">${d.substring(5)}<br>${dayNames[i]}</th>`).join('')}</tr>`;
    
    let bodyHTML = '';
    for(let h=8; h<=18; h++) {
        bodyHTML += `<tr><td class="time-col">${h}:00</td>`;
        for(let d=0; d<5; d++) {
            const curDate = range[d];
            let cellContent = '';
            const isDayOff = profReqs.some(r => r.date === curDate && r.prof === 'ìš´í–‰ì¤‘ë‹¨');
            if(isDayOff) {
                cellContent = (h === 12) ? `<div class="cell-event block-off">ìš´í–‰ë¶ˆê°€</div>` : `<div class="cell-event block-off"></div>`;
            } else if(h === 12) {
                cellContent = `<div class="cell-event block-lunch" style="font-size:10px; opacity:0.3; display:flex; align-items:center; justify-content:center;">ì ì‹¬</div>`;
            } else if(d === 0 && (h === 9 || h === 10)) {
                cellContent = `<div class="cell-event block-entry">ì…êµìˆ˜ì†¡</div>`;
            } else {
                const matchedProfs = profReqs.filter(r => (r.status === 'approved' || r.status === 'finished' || r.status === 'completed') && r.date === curDate && parseInt(String(r.time || "").split(':')[0]) === h);
                if(matchedProfs.length > 0) {
                    const item = matchedProfs[0];
                    const profLabel = matchedProfs.length > 1 ? `ê°•ì‚¬ ${matchedProfs.length}ëª…` : item.prof;
                    const route = (item.dir || "").replace(/â†’|>>/g, '>');
                    const isFin = matchedProfs.every(r => r.status === 'finished' || r.status === 'completed');
                    cellContent = `<div class="cell-event block-prof" style="${isFin?'background:#e2e8f0; border-color:#cbd5e1; color:#94a3b8;':''}" onclick="showDetail('prof', ${JSON.stringify(matchedProfs).replace(/"/g, '&quot;')})">${route}<br>${profLabel}</div>`;
                } else {
                    for (const rid in allCourses) {
                        const dep = allCourses[rid]?.shuttle?.departure;
                        if(dep && dep.date === curDate && parseInt(String(dep.time || "").split(':')[0]) === h) {
                            cellContent = `<div class="cell-event block-departure" onclick="showDrillDown('course', '${rid}')">í‡´êµìˆ˜ì†¡</div>`;
                            break; 
                        }
                    }
                }
            }
            bodyHTML += `<td>${cellContent}</td>`;
        }
        bodyHTML += `</tr>`;
    }
    body.innerHTML = bodyHTML;
  }

  // [ìˆ˜ì •] ê°•ì‚¬ ìˆ˜ì†¡ ë¦¬ìŠ¤íŠ¸ (ë¯¸ì…˜ 2 ì™„ë£Œ ì²˜ë¦¬ ë° ë²„ê·¸ ìˆ˜ì • ë°˜ì˜)
  function renderInstructorList() {
    const allZone = document.getElementById('all-request-container');
    if (!allZone) return;
    allZone.innerHTML = '<div class="chat-container" id="chat-box"></div>';
    const chatBox = document.getElementById('chat-box');
    const todayStr = new Date().toISOString().split('T')[0];

    const grouped = {};
    profReqs.filter(r => r.prof !== 'ìš´í–‰ì¤‘ë‹¨').forEach(r => {
        const groupKey = `${r.prof}_${r.date}_${r.courseRID}`;
        if (!grouped[groupKey]) grouped[groupKey] = { ...r, legs: [] };
        grouped[groupKey].legs.push(r);
    });

    const sortedGroups = Object.values(grouped).sort((a, b) => a.date.localeCompare(b.date));
    let lastDate = "";

    sortedGroups.forEach(group => {
        if(group.date !== lastDate) {
            chatBox.innerHTML += `<div class="chat-date-line"><span>${group.date}</span></div>`;
            lastDate = group.date;
        }
        const roomInfo = allCourses[group.courseRID];
        const cName = roomInfo?.settings?.courseName || `ê³¼ì •`;
        
        // [ë¯¸ì…˜ 2] ê·¸ë£¹ ë‚´ ëª¨ë“  ì¼ì •ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
        const isAllFinished = group.legs.every(r => r.status === 'finished' || r.status === 'completed');
        const isPastGroup = group.date < todayStr;
        const shading = (isPastGroup || isAllFinished) ? 'opacity: 0.65; filter: grayscale(1);' : '';
        const bubbleBg = isAllFinished ? 'background: #e2e8f0; color: #64748b;' : 'background: #fff;';

        let legsHtml = "";
        let repliesHtml = "";
        group.legs.sort((a,b) => (a.time || "").localeCompare(b.time || "")).forEach(r => {
            const isApp = r.status === 'approved';
            const isFin = (r.status === 'finished' || r.status === 'completed');
            const isCan = r.status === 'cancelled';
            
            if(isCan) {
                legsHtml += `<div style="padding:5px; opacity:0.5; text-decoration:line-through; font-size:12px;">ğŸš« ì·¨ì†Œ: ${r.time} ${r.dir}</div>`;
                return;
            }

            legsHtml += `<div class="talk-leg-item">
                <div style="font-weight:800; color:${isFin?'#94a3b8':'#0369a1'}; font-size:13px; ${isFin?'text-decoration:line-through;':''}">${r.time} ${r.dir.replace('â†’',' > ')}</div>
                <div style="margin-top:5px; display:flex; gap:5px;">
                    ${(!isApp && !isFin && !isPastGroup) ? 
                        `<button class="mini-talk-btn" style="background:#3b82f6; color:white; border:none;" onclick="handleSmartApprove('${r.id}')">ìŠ¹ì¸</button>
                         <button class="mini-talk-btn" style="color:#ef4444;" onclick="confirmAction('delete', '${r.id}')">ê±°ì ˆ</button>` 
                        : (isApp ? 
                        `<button class="mini-talk-btn" style="background:#10b981; color:white; border:none;" onclick="handleStatusUpdate('${r.id}', 'finished')">ìš´í–‰ì¢…ë£Œ</button>
                         <button class="mini-talk-btn" style="color:#94a3b8;" onclick="confirmAction('cancel', '${r.id}')">ì·¨ì†Œ</button>` 
                        : (isFin ? `<div style="color:#94a3b8; font-size:11px; font-weight:900;">âœ… ìš´í–‰ì™„ë£Œ</div>` : ''))}
                </div>
            </div>`;

            if(isApp || isFin) {
                const replyText = isFin ? `ìš´í–‰ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (${r.time})` : `ë„¤ í™•ì¸í–ˆìŠµë‹ˆë‹¤. [${cName}] ${r.prof}ë‹˜ ${r.date} ${r.time} ë°°ì°¨ ìŠ¹ì¸!`;
                const replyBg = isFin ? 'background:#f1f5f9; color:#94a3b8;' : 'background:#fee500; color:#1e293b;';
                repliesHtml += `<div class="chat-bubble chat-right"><div class="bubble-reply" style="${replyBg}">${replyText}</div></div>`;
            }
        });

        chatBox.innerHTML += `<div class="chat-bubble chat-left" style="${shading}">
            <div class="talk-header">ìš´ì˜ë¶€ ìˆ˜ì†¡ìš”ì²­ ${isAllFinished?'(ë§ˆê°)':''}</div>
            <div class="bubble-content" style="${bubbleBg}">
                <div class="talk-body" style="font-size:13px;"><b>[${cName}] ${group.prof} ê°•ì‚¬ë‹˜</b> (${formatPhone(group.phone)})</div>
                <div style="margin-top:8px; border-top:1px solid #f1f5f9; padding-top:8px;">${legsHtml}</div>
            </div>
        </div>` + repliesHtml;
    });
  }

  // [ìˆ˜ì •] ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (.update() ì‚¬ìš©ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
  async function handleStatusUpdate(id, nextStatus) {
    const confirmMsg = nextStatus === 'finished' ? "ìš´í–‰ ì¢…ë£Œ(ì™„ë£Œ) ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
    if (!confirm(confirmMsg)) return;

    await firebase.database().ref('system/transport_requests/' + id).update({
        status: nextStatus
    }).then(() => {
        renderAll();
    }).catch(e => alert("ì˜¤ë¥˜: " + e.message));
  }

  function renderTraineeManagement() {
    const area = document.getElementById('trainee-course-list');
    if (!area) return;
    const now = new Date();
    const graceDate = new Date();
    graceDate.setDate(graceDate.getDate() - 3);
    const limitStr = graceDate.toISOString().split('T')[0];

    const weekNo = Math.ceil((now.getDate() + new Date(now.getFullYear(), now.getMonth(), 1).getDay()) / 7);
    const headerTitle = `${now.getFullYear()}ë…„ ${now.getMonth() + 1}ì›” ${weekNo}ì§¸ì£¼ ì„¤ì •`;
    
    let listHTML = `<div style="text-align:center; font-weight:900; color:#0f172a; margin-bottom:15px; background:#fff; border:1px solid #e2e8f0; padding:12px; border-radius:12px;">ğŸ“… ${headerTitle}</div>
      <div class="list-wrapper">
        <div class="list-header">
          <div class="t-cell name">ê³¼ì •ëª…</div><div class="t-cell">í‡´êµì´ì›</div><div class="t-cell">ì¶œë°œì‹œê°„</div><div class="t-cell">ê³µì§€</div>
        </div>`;

    let activeCount = 0;
    Object.keys(allCourses).forEach(rid => {
        const room = allCourses[rid];
        if (!room || room.status?.roomStatus !== 'active') return;
        const period = room.settings?.period || "";
        const endDate = period.includes(" ~ ") ? period.split(" ~ ")[1] : "9999-12-31";
        if (endDate < limitStr) return; 

        activeCount++;
        const dep = room.shuttle?.departure || { time: "", date: "" };
        const reqs = Object.values(room.shuttle?.requests || {});
        const subTotal = reqs.filter(r => r.type !== 'car').length;
        const curT = String(dep.time || "").trim();

        listHTML += `<div class="course-row">
              <div class="t-cell name" style="font-size:12px; font-weight:800; justify-content:flex-start; padding-left:10px;">${room.settings.courseName || rid}</div>
              <div class="t-cell count" onclick="showDrillDown('course', '${rid}')">${subTotal}ëª…</div>
              <div class="t-cell btns">
                <button class="mini-btn ${curT === '13:00' ? 'active' : ''}" onclick="confirmAction('dep', '${rid}', '13:00', '${endDate}')">13:00</button>
                <button class="mini-btn ${curT === '15:00' ? 'active' : ''}" onclick="confirmAction('dep', '${rid}', '15:00', '${endDate}')">15:00</button>
                <button class="mini-btn ${curT !== '' && curT !== '13:00' && curT !== '15:00' ? 'active' : ''}" onclick="promptManual('${rid}', '${endDate}')">ìˆ˜ë™</button>
              </div>
              <div class="t-cell status">${curT ? `<i class="fa-solid fa-circle-check notice-on" onclick="confirmAction('cancelDep', '${rid}')"></i>` : `<i class="fa-solid fa-minus notice-off"></i>`}</div>
            </div>`;
    });
    area.innerHTML = listHTML + (activeCount === 0 ? '<div style="padding:40px; text-align:center;">ì§„í–‰ ì¤‘ì¸ ê³¼ì • ì—†ìŒ</div>' : '') + '</div>';
  }

  async function confirmAction(type, id, val = null, targetDate = null) {
    const modal = document.getElementById('confirmModal');
    const okBtn = document.getElementById('c-ok-btn');
    if(type === 'dep') {
        document.getElementById('c-title').innerText = "í‡´êµ ê³µì§€"; 
        document.getElementById('c-desc').innerHTML = `ì‹œê°„: <b>${val}</b><br>í‡´êµì˜ˆì •: <b>${targetDate}</b>`;
        okBtn.onclick = async () => { await firebase.database().ref(`courses/${id}/shuttle/departure`).set({ time: val, date: targetDate }); closeModal('confirmModal'); };
    } else if(type === 'cancelDep') {
        if(!confirm("ê³µì§€ ì‹œê°„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await firebase.database().ref(`courses/${id}/shuttle/departure`).set(null);
    } else if(type === 'delete') {
        document.getElementById('c-title').innerText = "ê±°ì ˆ/ì‚­ì œ"; 
        document.getElementById('c-desc').innerText = "ì´ ìˆ˜ì†¡ ìš”ì²­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
        okBtn.onclick = async () => { await firebase.database().ref(`system/transport_requests/${id}`).remove(); closeModal('confirmModal'); };
    } else if(type === 'cancel') {
        document.getElementById('c-title').innerText = "ìŠ¹ì¸ ì·¨ì†Œ"; 
        document.getElementById('c-desc').innerText = "ë°°ì°¨ ìŠ¹ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
        okBtn.onclick = async () => { await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'pending' }); closeModal('confirmModal'); };
    }
    modal.style.display = 'flex';
  }

  function promptManual(rid, endDate) {
    const timeInput = document.createElement('input');
    timeInput.type = 'time';
    timeInput.onchange = (e) => { if(e.target.value) confirmAction('dep', rid, e.target.value, endDate); };
    timeInput.click();
  }

  function getWeekDates(offset) {
    const now = new Date();
    const day = now.getDay(); 
    const diffToMon = (day === 0 ? 1 : 1 - day);
    const thisMon = new Date(now);
    thisMon.setDate(now.getDate() + diffToMon);
    let baseMon = new Date(thisMon);
    if (day === 5 || day === 6 || day === 0) baseMon.setDate(thisMon.getDate() + 7);
    baseMon.setDate(baseMon.getDate() + (offset * 7));
    const dates = [];
    for (let i = 0; i < 5; i++) {
        const d = new Date(baseMon);
        d.setDate(baseMon.getDate() + i);
        dates.push(d.toISOString().split('T')[0]);
    }
    return dates;
  }

  function changeWeek(n) { weekOffset += n; renderAll(); }
  function closeModal(id) { document.getElementById(id).style.display = 'none'; }
  function handleBack() { currentTab === 0 ? location.href = 'potal.html' : switchTab(0); }
  let currentTab = 0;
  function switchTab(n) {
    currentTab = n;
    document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === n));
    document.querySelectorAll('[id^="view-"]').forEach((v, i) => v.style.display = i === n ? 'block' : 'none');
    document.getElementById('floating-home').style.display = (n === 0) ? 'none' : 'flex';
    document.getElementById('back-btn-text').innerText = (n === 0) ? "<<" : "Back";
  }

  function showDetail(type, data) {
    const modal = document.getElementById('detailModal');
    const content = document.getElementById('m-content');
    if (type === 'prof') {
        const info = data[0];
        document.getElementById('m-title').innerText = "ìˆ˜ì†¡ ìƒì„¸";
        let html = `<div style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:8px;"><b>${info.date}</b> [${info.time}]<br>${info.dir}</div>`;
        data.forEach(p => {
            html += `<div style="display:flex; justify-content:space-between; align-items:center; background:#f8fafc; padding:10px; border-radius:10px; margin-bottom:5px;">
                        <div><b>${p.prof}</b><br><small>${p.phone}</small></div>
                        <a href="tel:${p.phone}" style="background:#0ea5e9; color:white; padding:8px; border-radius:50%;"><i class="fa-solid fa-phone"></i></a>
                     </div>`;
        });
        content.innerHTML = html;
    }
    modal.style.display = 'flex';
  }

  function showDrillDown(type, filterRid = null) {
    const area = document.getElementById('m-content');
    const title = document.getElementById('m-title');
    const room = allCourses[filterRid];
    title.innerText = room?.settings?.courseName || "ëª…ë‹¨";
    const reqs = Object.values(room?.shuttle?.requests || {}).filter(r => r.type !== 'car');
    if(reqs.length === 0) { area.innerHTML = "ì‹ ì²­ì ì—†ìŒ"; }
    else {
        const groups = { osong: "ğŸš… ì˜¤ì†¡", terminal: "ğŸšŒ í„°ë¯¸ë„", airport: "âœˆï¸ ê³µí•­" };
        let html = '';
        Object.keys(groups).forEach(key => {
            const list = reqs.filter(r => r.type === key);
            if(list.length > 0) {
                html += `<div style="margin-bottom:10px;"><b>${groups[key]} (${list.length})</b><div style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px; margin-top:5px;">`;
                list.forEach(p => { html += `<div style="background:#f1f5f9; padding:5px; font-size:12px; text-align:center;">${p.name}</div>`; });
                html += `</div></div>`;
            }
        });
        area.innerHTML = html;
    }
    document.getElementById('detailModal').style.display = 'flex';
  }

  async function handleSmartApprove(id) {
    const target = profReqs.find(r => r.id === id);
    if(!target) return;
    const targetH = parseInt(target.time.split(':')[0]);
    let conflict = [];
    profReqs.forEach(r => { if(r.id !== id && (r.status === 'approved' || r.status === 'finished') && r.date === target.date && parseInt(r.time.split(':')[0]) === targetH) conflict.push(`${r.prof}(ê°•ì‚¬)`); });
    Object.values(allCourses).forEach(room => { const dep = room.shuttle?.departure; if(dep?.date === target.date && parseInt(dep.time.split(':')[0]) === targetH) conflict.push(`${room.settings.courseName}(í‡´êµ)`); });
    if(conflict.length > 0) { if(!confirm(`âš ï¸ ë‹¤ìŒ ì¼ì •ê³¼ ê²¹ì¹©ë‹ˆë‹¤:\n${conflict.join('\n')}\nìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return; }
    await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'approved' });
  }

  function formatPhone(num) {
    if (!num) return "";
    const s = num.replace(/[^0-9]/g, "");
    return s.length === 11 ? s.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3") : num;
  }

  async function captureSchedule() {
    const area = document.getElementById('capture-area');
    try {
      const canvas = await html2canvas(area, { backgroundColor: "#f1f5f9", scale: 2 });
      const link = document.createElement('a');
      link.download = `ì¼ì •í‘œ.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    } catch (e) { alert("ì‹¤íŒ¨"); }
  }

  function askDayOff(date) {
    const reason = prompt(`${date} ìš´í–‰ì¤‘ë‹¨ ì‚¬ìœ `, "ì°¨ëŸ‰ ì •ë¹„");
    if(reason) firebase.database().ref('system/transport_requests').push({ date, prof: 'ìš´í–‰ì¤‘ë‹¨', dir: reason, status: 'approved', time: '00:00' });
  }

  init();
</script>
</body>
</html>