<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>KAC Driver Monitoring</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Font Awesome & Pretendard Font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

  <style>
    :root {
      --navy-dark: #0f172a;   /* 상/하단바 배경 */
      --bg-light: #f8fafc;    /* 메인 배경색 */
      --card-white: #ffffff;  /* 카드 배경 */
      --text-dark: #1e293b;   /* 메인 텍스트 */
      --accent-blue: #2563eb;
      --osong: #3b82f6;
      --term: #f59e0b;
      --air: #10b981;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; padding: 0;
      font-family: 'Pretendard', sans-serif;
      background: #e2e8f0; 
      display: flex; justify-content: center;
      color: var(--text-dark);
    }

    .app-container {
      width: 100%;
      max-width: 600px; 
      min-height: 100dvh;
      background: var(--bg-light); 
      position: relative;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 30px rgba(0,0,0,0.1);
    }

    /* --- 상단바 (고정) --- */
    .app-header {
      position: fixed; top: 0; width: 100%; max-width: 600px; height: 60px;
      background: var(--navy-dark);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; z-index: 1000;
    }
    .header-btn { font-size: 20px; color: #fff; cursor: pointer; border:none; background:none; }
    .header-title { color: #fff; font-size: 17px; font-weight: 800; letter-spacing: -0.5px; }

    /* --- 하단바 (고정) --- */
    .app-footer {
      position: fixed; bottom: 0; width: 100%; max-width: 600px; height: 54px;
      background: var(--navy-dark); color: #94a3b8;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; font-size: 12px; z-index: 1000;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .footer-logo img { 
      height: 22px; 
      display: block;
      filter: brightness(0) invert(1); /* 어두운 배경에 맞게 로고 반전 */
      opacity: 0.8;
    }

    /* --- 메인 콘텐츠 영역 --- */
    .app-content {
      flex: 1;
      margin-top: 60px; margin-bottom: 54px;
      padding: 24px 20px;
    }

    /* 전체 요약 카드 */
    .main-summary {
      background: var(--card-white);
      border-radius: 24px; padding: 24px;
      text-align: center; margin-bottom: 28px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      border: 1px solid #e2e8f0;
    }
    .summary-label { font-size: 14px; color: #64748b; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .summary-label i { color: #3b82f6; font-size: 10px; }
    .summary-count { font-size: 60px; font-weight: 900; color: var(--navy-dark); line-height: 1; }
    .summary-count span { font-size: 22px; font-weight: 700; color: #94a3b8; margin-left: 4px; }

    /* 목적지 섹션 리스트 */
    .dest-list { display: flex; flex-direction: column; gap: 16px; }
    
    .dest-card {
      background: var(--card-white);
      border-radius: 20px; 
      border: 1px solid #e2e8f0;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }

    .dest-header {
      padding: 16px 20px; 
      display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid #f1f5f9;
    }

    .dest-info { display: flex; align-items: center; gap: 14px; }
    .dest-icon { 
        width: 44px; height: 44px; border-radius: 12px; 
        display: flex; align-items: center; justify-content: center; font-size: 20px; 
    }
    .dest-name { font-size: 17px; font-weight: 800; color: var(--text-dark); }
    .dest-total-val { font-size: 20px; font-weight: 900; color: var(--navy-dark); }

    .dest-body {
      padding: 16px 20px;
      display: flex; flex-wrap: wrap; gap: 10px;
      background: #fafcfe;
    }

    /* 강의실별 배지 */
    .room-badge {
      background: #fff; 
      border: 1.5px solid #e2e8f0;
      padding: 10px 14px; border-radius: 12px; 
      font-size: 14px; font-weight: 800;
      color: #475569;
      display: flex; align-items: center;
    }
    .room-badge b { color: var(--accent-blue); margin-left: 8px; font-size: 16px; }

    /* 포인트 컬러 */
    .osong .dest-icon { background: #eff6ff; color: var(--osong); }
    .terminal .dest-icon { background: #fffbeb; color: var(--term); }
    .airport .dest-icon { background: #ecfdf5; color: var(--air); }

    .empty-text { font-size: 13px; color: #cbd5e1; width: 100%; text-align: center; padding: 10px 0; }

  </style>
</head>

<body>

  <div class="app-container">
    <!-- 상단바 -->
    <header class="app-header">
      <button class="header-btn" onclick="history.back()"><i class="fa-solid fa-chevron-left"></i></button>
      <div class="header-title">KAC Driver Monitoring</div>
      <button class="header-btn"><i class="fa-solid fa-bars"></i></button>
    </header>

    <!-- 메인 콘텐츠 -->
    <main class="app-content">
      
      <!-- 전체 요약 (자차 제외 셔틀 인원만 합산) -->
      <div class="main-summary">
          <span class="summary-label"><i class="fa-solid fa-shuttle-van"></i> 셔틀 탑승 총원</span>
          <div class="summary-count" id="total-all">0<span>명</span></div>
      </div>

      <!-- 목적지 리스트 -->
      <div class="dest-list">
          
          <!-- 오송역 -->
          <div class="dest-card osong">
              <div class="dest-header">
                  <div class="dest-info">
                      <div class="dest-icon"><i class="fa-solid fa-train"></i></div>
                      <div class="dest-name">오송역</div>
                  </div>
                  <div class="dest-total-val" id="total-osong">0명</div>
              </div>
              <div class="dest-body" id="list-osong"></div>
          </div>

          <!-- 청주터미널 -->
          <div class="dest-card terminal">
              <div class="dest-header">
                  <div class="dest-info">
                      <div class="dest-icon"><i class="fa-solid fa-bus-simple"></i></div>
                      <div class="dest-name">청주터미널</div>
                  </div>
                  <div class="dest-total-val" id="total-terminal">0명</div>
              </div>
              <div class="dest-body" id="list-terminal"></div>
          </div>

          <!-- 청주공항 -->
          <div class="dest-card airport">
              <div class="dest-header">
                  <div class="dest-info">
                      <div class="dest-icon"><i class="fa-solid fa-plane-up"></i></div>
                      <div class="dest-name">청주공항</div>
                  </div>
                  <div class="dest-total-val" id="total-airport">0명</div>
              </div>
              <div class="dest-body" id="list-airport"></div>
          </div>

      </div>
    </main>

    <!-- 하단바 -->
    <footer class="app-footer">
      <div id="footer-time">0000년 00월 00일 (요일) 00:00</div>
      <div class="footer-logo">
          <img src="logo.png" alt="KAC Logo">
      </div>
    </footer>
  </div>

  <script src="config.js"></script>
  <script>

  if(sessionStorage.getItem('kac_portal_auth') !== 'driver') {
      alert("정상적인 접근이 아닙니다. 포털에서 인증 후 접속해주세요.");
      location.replace('portal.html'); // 포털 파일명에 맞게 수정
  }



    // --- 실시간 시계 설정 ---
    function runClock() {
        const now = new Date();
        const week = ['일','월','화','수','목','금','토'];
        const dateStr = `${now.getFullYear()}년 ${now.getMonth()+1}월 ${now.getDate()}일 (${week[now.getDay()]}) ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        document.getElementById('footer-time').innerText = dateStr;
    }
    setInterval(runClock, 1000);
    runClock();

    // --- Firebase 실시간 데이터 연동 ---
    firebase.database().ref('courses').on('value', snap => {
      const data = snap.val() || {};
      const totals = { osong: 0, terminal: 0, airport: 0 };
      const details = { osong: {}, terminal: {}, airport: {} };

      Object.keys(data).forEach(rid => {
        const shuttle = data[rid].shuttle;
        if(!shuttle) return;

        ['osong', 'terminal', 'airport'].forEach(loc => {
          if(shuttle[loc]) {
            const count = Object.keys(shuttle[loc]).length;
            if(count > 0) {
              totals[loc] += count;
              details[loc][rid] = count;
            }
          }
        });
      });

      // 합계 업데이트
      const grandTotal = totals.osong + totals.terminal + totals.airport;
      document.getElementById('total-all').innerHTML = `${grandTotal}<span>명</span>`;

      // 각 목적지별 렌더링
      ['osong', 'terminal', 'airport'].forEach(loc => {
          document.getElementById(`total-${loc}`).innerText = totals[loc] + '명';
          const container = document.getElementById(`list-${loc}`);
          container.innerHTML = "";
          
          const rooms = Object.keys(details[loc]).sort();

          if(rooms.length === 0) {
              container.innerHTML = `<span class="empty-text">신청자 없음</span>`;
          } else {
              rooms.forEach(rid => {
                  const badge = document.createElement('div');
                  badge.className = 'room-badge';
                  badge.innerHTML = `ROOM ${rid} <b>${details[loc][rid]}명</b>`;
                  container.appendChild(badge);
              });
          }
      });
    });
  </script>
</body>
</html>