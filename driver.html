<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>KAC 수송 관리 시스템</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      --kac-navy: #003366; --kac-blue: #3b82f6; --bg-fresh: #f0f4f8;
      --osong: #2563eb; --term: #0ea5e9; --air: #10b981;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; padding: 0; font-family: 'Pretendard', sans-serif;
      background: #cfd8e3; display: flex; justify-content: center; color: #1e293b;
      height: 100dvh; overflow: hidden;
    }
    .app-container { width: 100%; max-width: 600px; height: 100%; background: var(--bg-fresh); display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.2); }
    
    /* 헤더 및 탭 */
    .app-header { height: 55px; background: var(--kac-navy); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; border-bottom: 2px solid var(--kac-blue); }
    .header-title { color: #fff; font-size: 17px; font-weight: 900; font-style: italic; letter-spacing: -0.5px; }
    .tab-container { background: var(--kac-navy); padding-bottom: 8px; }
    .tab-bar { display: flex; margin: 0 12px; background: rgba(255,255,255,0.15); border-radius: 50px; padding: 4px; }
    .tab-btn { flex: 1; border: none; background: none; color: rgba(255,255,255,0.6); font-weight: 800; font-size: 14px; padding: 10px 0; border-radius: 50px; cursor: pointer; transition: 0.3s; }
    .tab-btn.active { color: #fff; background: var(--kac-blue); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

    .app-content { flex: 1; display: flex; flex-direction: column; padding: 12px; overflow: hidden; }

    /* 교육생 수송 섹션 */
    .dir-toggle-container { display: flex; gap: 8px; margin-bottom: 12px; }
    .dir-pill { flex: 1; padding: 10px; border-radius: 10px; border: 2px solid #e2e8f0; background: white; font-weight: 800; font-size: 13px; color: #64748b; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .dir-pill.active { border-color: var(--kac-blue); color: var(--kac-blue); background: #eff6ff; }

    .hero-summary-card { background: linear-gradient(135deg, #003366 0%, #0055aa 100%); border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 15px; color: white; box-shadow: 0 10px 25px rgba(0, 51, 102, 0.15); position: relative; overflow: hidden; border-left: 6px solid var(--kac-blue); }
    .summary-label { font-size: 11px; font-weight: 800; opacity: 0.8; margin-bottom: 5px; }
    .summary-count { font-size: 50px; font-weight: 900; line-height: 1; }
    .summary-count span { font-size: 18px; margin-left: 5px; opacity: 0.7; }

    /* 목적지 카드 정렬 고정 */
    .dest-card { background: #fff; border-radius: 15px; margin-bottom: 8px; border: 1.5px solid #eef2f6; display: flex; align-items: center; justify-content: space-between; padding: 15px 18px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
    .dest-info { display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 16px; color: var(--kac-navy); }
    .dest-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 18px; flex-shrink: 0; }
    .osong .dest-icon { background: var(--osong); } .term .dest-icon { background: var(--term); } .air .dest-icon { background: var(--air); }
    .val-box { font-size: 20px; font-weight: 900; color: var(--kac-navy); display: flex; align-items: center; gap: 4px; }
    .val-box span { font-size: 12px; color: #94a3b8; }

    /* 강사 수송 일정표 (밀림 방지 적용) */
    .week-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 8px; }
    .nav-btn { background: var(--kac-navy); color: #fff; border: none; padding: 8px 12px; border-radius: 8px; font-weight: 800; font-size: 11px; flex: 1; }
    .schedule-table-wrapper { flex: 1; background: white; border-radius: 15px; border: 2px solid var(--kac-navy); overflow: hidden; display: flex; flex-direction: column; }
    .schedule-table { width: 100%; height: 100%; border-collapse: collapse; table-layout: fixed; }
    .schedule-table th, .schedule-table td { border: 1px solid #f1f5f9; padding: 1px; text-align: center; font-size: 10px; vertical-align: top; }
    .schedule-table th { background: var(--kac-navy); color: #fff; font-weight: 900; height: 35px; }
    .time-col { width: 45px; background: #f8fafc !important; font-weight: 900; color: var(--kac-navy); vertical-align: middle !important; border-right: 1.5px solid var(--kac-navy) !important; font-size: 11px; }
    
    /* 셀 높이 고정 및 밀림 방지 */
    .schedule-table td { height: calc(100% / 12); max-height: 80px; overflow: hidden; position: relative; }
    .job-box { font-size: 9px; border-radius: 4px; padding: 3px 1px; margin: 1px; font-weight: 800; text-align: center; line-height: 1.3; overflow: hidden; display: block; }
    .job-to { background: #e0f2fe; color: #0369a1; border-left: 3px solid var(--osong); } 
    .job-from { background: #ffedd5; color: #9a3412; border-left: 3px solid var(--term); } 
    .job-off { background: #f1f5f9; color: #94a3b8; height: 100%; display: flex; align-items: center; justify-content: center; font-style: italic; font-size: 9px; }

    .app-footer { height: 40px; background: #fff; border-top: 1px solid #e2e8f0; color: #94a3b8; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; font-size: 12px; font-weight: 700; }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <i class="fa-solid fa-chevron-left" style="color:#fff; cursor:pointer; font-size:20px;" onclick="location.href='potal.html'"></i>
      <div class="header-title">운전기사 통합 시스템</div>
      <i class="fa-solid fa-rotate-right" style="color:#fff; cursor:pointer; font-size:20px;" onclick="location.reload()"></i>
    </header>

    <div class="tab-container">
        <div class="tab-bar">
            <button id="tab1" class="tab-btn active" onclick="switchTab(1)">교육생 수송</button>
            <button id="tab2" class="tab-btn" onclick="switchTab(2)">강사수송 일정</button>
        </div>
    </div>

    <main class="app-content">
      <div id="view-student" style="flex:1;">
          <div class="dir-toggle-container">
              <button id="dirBtnOut" class="dir-pill active" onclick="setStudentDir('out')"><i class="fa-solid fa-right-from-bracket"></i> 항기원 퇴교 수송</button>
              <button id="dirBtnIn" class="dir-pill" onclick="setStudentDir('in')"><i class="fa-solid fa-right-to-bracket"></i> 항기원 입교 수송</button>
          </div>
          <div class="hero-summary-card">
              <div class="summary-label" id="summary-title">금일 퇴교 수송 총원</div>
              <div class="summary-count" id="total-all">0<span>명</span></div>
          </div>
          <div id="student-list-container"></div>
      </div>

      <div id="view-teacher" style="display:none; flex:1; flex-direction:column;">
          <div class="week-nav">
              <button class="nav-btn" onclick="changeWeek(-7)">이전 주</button>
              <span style="font-weight:900; font-size:13px; color:var(--kac-navy);">주간 스케줄</span>
              <button class="nav-btn" onclick="changeWeek(7)">다음 주</button>
          </div>
          <div class="schedule-table-wrapper">
              <table class="schedule-table">
                  <thead><tr id="table-header-days"><th class="time-col">TIME</th></tr></thead>
                  <tbody id="schedule-body"></tbody>
              </table>
          </div>
      </div>
    </main>

    <footer class="app-footer">
      <div id="footer-time">00:00</div>
      <div class="footer-logo"><img src="logo.png" alt="KAC" style="height:15px; opacity:0.5;"></div>
    </footer>

    <div id="listModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:5000; align-items:center; justify-content:center; padding:20px; backdrop-filter: blur(5px);">
        <div style="background:white; width:100%; max-width:400px; border-radius:24px; overflow:hidden; display:flex; flex-direction:column; max-height:80vh;">
            <div style="background:var(--kac-navy); color:white; padding:18px; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="listModalTitle" style="margin:0; font-size:16px;">탑승객 명단</h3>
                <i class="fa-solid fa-xmark" style="cursor:pointer; font-size:20px;" onclick="closeListModal()"></i>
            </div>
            <div id="listModalContent" style="padding:25px; overflow-y:auto; font-size:15px; line-height:1.6;"></div>
            <button style="width:100%; padding:18px; border:none; background:#f8fafc; font-weight:900; font-size:16px; color:var(--kac-navy);" onclick="closeListModal()">확인 및 닫기</button>
        </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    let currentBaseDate = new Date();
    let transportRequests = {}; let driverOffSlots = {};
    let studentDirection = 'out';

    if(sessionStorage.getItem('kac_portal_auth') !== 'driver') {
        alert("인증 필요"); location.replace('potal.html');
    }

    function switchTab(num) {
        document.getElementById('view-student').style.display = (num === 1) ? 'block' : 'none';
        document.getElementById('view-teacher').style.display = (num === 2) ? 'flex' : 'none';
        document.getElementById('tab1').classList.toggle('active', num === 1);
        document.getElementById('tab2').classList.toggle('active', num === 2);
        if(num === 2) renderWeeklySchedule();
    }

    function setStudentDir(dir) {
        studentDirection = dir;
        document.getElementById('dirBtnOut').classList.toggle('active', dir === 'out');
        document.getElementById('dirBtnIn').classList.toggle('active', dir === 'in');
        document.getElementById('summary-title').innerText = (dir === 'out') ? "금일 퇴교 수송 총원" : "금일 입교 수송 총원";
        initStudentTransport();
    }

    function initStudentTransport() {
        firebase.database().ref('courses').on('value', snap => {
            const data = snap.val() || {};
            const totals = { osong: 0, terminal: 0, airport: 0 };
            const details = { osong: [], terminal: [], airport: [] };
            Object.keys(data).forEach(rid => {
                const shuttle = data[rid].shuttle ? data[rid].shuttle[studentDirection] : null;
                if(shuttle) {
                    ['osong', 'terminal', 'airport'].forEach(loc => {
                        if(shuttle[loc]) {
                            const names = Object.values(shuttle[loc]);
                            totals[loc] += names.length;
                            if(names.length > 0) details[loc].push({ rid, names });
                        }
                    });
                }
            });
            document.getElementById('total-all').innerHTML = `${totals.osong + totals.terminal + totals.airport}<span>명</span>`;
            const container = document.getElementById('student-list-container'); container.innerHTML = "";
            const locInfo = [{id:'osong', name:'오송역', icon:'fa-train'}, {id:'terminal', name:'청주터미널', icon:'fa-bus'}, {id:'airport', name:'청주공항', icon:'fa-plane-up'}];
            locInfo.forEach(loc => {
                const card = document.createElement('div'); card.className = `dest-card ${loc.id.substring(0,3)}`;
                card.innerHTML = `<div class="dest-info"><div class="dest-icon"><i class="fa-solid ${loc.icon}"></i></div>${loc.name}</div>
                    <div class="val-box">${totals[loc.id]}<span>명 ></span></div>`;
                card.onclick = () => showStudentDetail(loc.name, details[loc.id]);
                container.appendChild(card);
            });
        });
    }

    function showStudentDetail(title, data) {
        if(data.length === 0) return;
        document.getElementById('listModalTitle').innerText = title + " 상세 명단";
        document.getElementById('listModalContent').innerHTML = data.map(item => `
            <div style="margin-bottom:12px; border-bottom:1px solid #f1f5f9; padding-bottom:8px;">
                <div style="font-weight:900; color:var(--kac-blue);">ROOM ${item.rid}</div><div>${item.names.join(', ')}</div>
            </div>`).join('');
        document.getElementById('listModal').style.display = 'flex';
    }

    function closeListModal() { document.getElementById('listModal').style.display = 'none'; }

    function renderWeeklySchedule() {
        const sunday = new Date(currentBaseDate); sunday.setDate(currentBaseDate.getDate() - currentBaseDate.getDay());
        const days = []; for(let i=0; i<6; i++) { const d = new Date(sunday); d.setDate(sunday.getDate() + i); days.push(d); }
        const headerRow = document.getElementById('table-header-days');
        headerRow.innerHTML = '<th class="time-col">TIME</th>';
        const dayNames = ['일','월','화','수','목','금'];
        days.forEach((d, i) => { headerRow.innerHTML += `<th>${d.getMonth()+1}/${d.getDate()}<br>${dayNames[i]}</th>`; });
        const body = document.getElementById('schedule-body'); body.innerHTML = "";
        for(let h=8; h<=18; h++) {
            const row = document.createElement('tr'); row.innerHTML = `<td class="time-col">${h}:00</td>`;
            days.forEach(d => {
                const dateKey = getTodayString(d); const td = document.createElement('td');
                if(h === 12) { td.innerHTML = '<div class="job-off">식사</div>'; }
                else {
                    td.onclick = () => toggleDriverOff(dateKey, h);
                    if(driverOffSlots[dateKey] && driverOffSlots[dateKey][h]) { td.innerHTML = `<div class="job-off">${driverOffSlots[dateKey][h]}</div>`; }
                    const dayReqs = Object.values(transportRequests).filter(r => r.date === dateKey && parseInt(r.time.split(':')[0]) === h);
                    dayReqs.forEach(req => {
                        const locName = req.loc.replace('역','').replace('터미널','').replace('공항','');
                        const dirText = req.dir.includes('→항기원') ? `${locName}>항기원` : `항기원>${locName}`;
                        td.innerHTML += `<div class="job-box ${req.dir.includes('항기원→')?'job-from':'job-to'}">${req.time}<br>${dirText}<br>${req.prof}</div>`;
                    });
                }
                row.appendChild(td);
            });
            body.appendChild(row);
        }
    }

    function changeWeek(days) { currentBaseDate.setDate(currentBaseDate.getDate() + days); renderWeeklySchedule(); }
    function toggleDriverOff(date, hour) {
        const current = (driverOffSlots[date] && driverOffSlots[date][hour]) ? driverOffSlots[date][hour] : null;
        if(current) { if(confirm("해제할까요?")) firebase.database().ref(`system/driver_status/${date}/${hour}`).remove(); }
        else { const reason = prompt("사유(개인용무, 검진 등)"); if(reason) firebase.database().ref(`system/driver_status/${date}/${hour}`).set(reason); }
    }
    function getTodayString(d = new Date()) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function runClock() { const now = new Date(); document.getElementById('footer-time').innerText = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`; }
    
    initStudentTransport();
    firebase.database().ref('system/transport_requests').on('value', s => { transportRequests = s.val() || {}; if(document.getElementById('view-teacher').style.display === 'flex') renderWeeklySchedule(); });
    firebase.database().ref('system/driver_status').on('value', s => { driverOffSlots = s.val() || {}; if(document.getElementById('view-teacher').style.display === 'flex') renderWeeklySchedule(); });
    setInterval(runClock, 1000); runClock();
  </script>
</body>
</html>