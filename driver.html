<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>í•­ê³µê¸°ìˆ í›ˆë ¨ì› ì°¨ëŸ‰ì§€ì› ì‹œìŠ¤í…œ (ê¸°ì‚¬ìš©)</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
<style>
    :root {
      --navy: #0f172a; --blue: #0ea5e9; --blue-deep: #0369a1;
      --bg: #f1f5f9; --card: #ffffff; --border: #e2e8f0;
      --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
    body { margin: 0; padding: 0; background: #cfd8e3; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }
    
    /* [1] í—¤ë” ë° ê·¸ë¦¼ì */
    .app-container { width: 100%; max-width: 600px; height: 100%; background: var(--bg); display: flex; flex-direction: column; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.2); }
    .app-header { 
        height: 60px; background: var(--navy); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.4); /* ì…ì²´ì  ê·¸ë¦¼ì */
        border-bottom: 2px solid var(--blue); z-index: 1000; 
    }
    .header-btn { color: #fff; font-size: 18px; font-weight: 900; cursor: pointer; width: 40px; }
    .header-title { font-size: 16px; font-weight: 900; color: #fff; letter-spacing: -0.5px; }

    /* [1-1] ìš°ì¸¡ í–„ë²„ê±° ì‚¬ì´ë“œë°” */
    .sidebar { position: absolute; top: 0; right: -280px; width: 280px; height: 100%; background: #fff; z-index: 10000; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.2); }
    .sidebar.open { right: 0; }
    .sidebar-header { padding: 30px 20px; background: var(--navy); color: #fff; }
    .sidebar-menu { padding: 10px; }
    .menu-item { padding: 15px; display: flex; align-items: center; gap: 12px; font-weight: 700; color: #334155; border-radius: 8px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }

    /* íƒ­ ë°” */
    .tab-bar { display: flex; background: #fff; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .tab-btn { flex: 1; padding: 14px 0; border: none; background: none; font-size: 12px; font-weight: 800; color: #94a3b8; cursor: pointer; border-bottom: 3px solid transparent; position: relative; }
    .tab-btn.active { color: var(--blue-deep); border-bottom-color: var(--blue); background: #f8fafc; }
    .badge { position: absolute; top: 5px; right: 5px; background: var(--danger); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; }

    .app-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }

    /* [2] ì¢…í•© ì¼ì •í‘œ (ë“œë˜ê·¸ì•¤ë“œë¡­) */
    .schedule-wrapper { background: #fff; border: 1.5px solid #000; border-radius: 8px; overflow: hidden; }
    .schedule-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .schedule-table th, .schedule-table td { border: 1px solid #ddd; text-align: center; height: 50px; font-size: 10px; vertical-align: middle; position: relative; }
    .schedule-table th { background: #f1f5f9; font-weight: 900; color: var(--navy); border-bottom: 2px solid var(--navy); }
    .time-col { width: 45px; background: #f1f5f9 !important; font-weight: 800; border-right: 2px solid var(--navy) !important; }
    
    .cell-event { 
        border-radius: 4px; padding: 4px 2px; height: 90%; font-size: 9px; font-weight: 800; line-height: 1.2; cursor: move; 
        display: flex; flex-direction: column; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
    }
    .block-entry { background: #eff6ff; color: #1e40af; border: 1px solid #1e40af; }
    .block-prof { background: #fae8ff; color: #a21caf; border: 1px solid #a21caf; }
    .block-departure { background: #ecfdf5; color: #047857; border: 1px solid #047857; }
    .block-off { background: #fee2e2; color: #ef4444; border: 1px dashed #ef4444; }

    /* [1] ê¸ˆì¼ ì¼ì • íƒ€ì„ë¼ì¸ */
    .timeline-item { display: flex; gap: 15px; padding: 10px; background: #fff; border-radius: 10px; border-left: 5px solid var(--blue); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .tm-time { font-weight: 900; font-size: 15px; color: var(--navy); min-width: 60px; }
    .tm-info { flex: 1; font-size: 13px; font-weight: 700; color: #475569; }

    /* [3] ê°•ì‚¬ ìˆ˜ì†¡ ë¦¬ìŠ¤íŠ¸ (ì¹´í†¡ ë°©ì‹/ë¯¸ë‹ˆ ë²„íŠ¼) */
    .chat-container { background: #abc1d1; padding: 15px; display: flex; flex-direction: column; gap: 12px; min-height: 100%; }
    .req-card { background: #fff; border-radius: 12px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); align-self: flex-start; max-width: 85%; }
    .req-card.mine { align-self: flex-end; background: #fee500; }
    .req-btn-group { display: flex; gap: 5px; margin-top: 8px; }
    .mini-btn { padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd; background: #fff; font-size: 10px; font-weight: 800; cursor: pointer; }
    .mini-btn.primary { background: var(--blue); color:#fff; border:none; }

    /* [4] í‡´êµ ìˆ˜ì†¡ (ê·¸ë¦¬ë“œ ë³µêµ¬) */
    .list-wrapper { background: #fff; border-radius: 12px; border: 1.5px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .list-header, .course-row { display: grid; grid-template-columns: 1.5fr 0.5fr 1.8fr 0.6fr; align-items: center; text-align: center; }
    .list-header { background: #f1f5f9; border-bottom: 2px solid #cbd5e1; font-size: 11px; font-weight: 900; }
    .course-row { border-bottom: 1px solid #f1f5f9; }
    .t-cell { padding: 12px 5px; display: flex; align-items: center; justify-content: center; height: 100%; border-right: 1px solid #f1f5f9; }
    .t-cell:last-child { border-right: none; }
    .notice-btn { border: none; background: none; font-size: 22px; cursor: pointer; }

    /* í†µí•© ëª¨ë‹¬ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; padding: 20px; }
    .modal-box { background: #fff; width: 100%; max-width: 400px; border-radius: 20px; padding: 25px; }
    .modal-input { width: 100%; height: 45px; border: 1.5px solid #ddd; border-radius: 8px; padding: 0 10px; margin-bottom: 10px; font-size: 14px; font-weight: 700; }
</style>
</head>
<body>

<div class="sidebar-overlay" onclick="toggleSidebar()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header"><div style="font-size:18px; font-weight:900;">ê¸°ì‚¬ ì „ìš© ì„¤ì •</div></div>
    <div class="sidebar-menu">
        <div class="menu-item" onclick="openDayOffModal()"><i class="fa-solid fa-calendar-xmark"></i> ìš´í–‰ë¶ˆê°€ í†µí•© ê³µì§€</div>
        <div class="menu-item" onclick="handleBack()"><i class="fa-solid fa-house"></i> í¬íƒˆ ë©”ì¸ ì´ë™</div>
    </div>
</div>

<div class="app-container">
  <header class="app-header">
    <div class="header-btn" onclick="handleBack()">&lt;&lt;</div>
    <div class="header-title">í•­ê³µê¸°ìˆ í›ˆë ¨ì› ì°¨ëŸ‰ì§€ì› ì‹œìŠ¤í…œ</div>
    <div class="header-btn" style="text-align:right;" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>
  </header>

  <div class="tab-bar">
    <button id="tab0" class="tab-btn active" onclick="switchTab(0)">ì¢…í•© ì¼ì •í‘œ</button>
    <button id="tab1" class="tab-btn" onclick="switchTab(1)">ê¸ˆì¼ ì¼ì •</button>
    <button id="tab2" class="tab-btn" onclick="switchTab(2)">ê°•ì‚¬ ìˆ˜ì†¡ <span id="badge-count" class="badge" style="display:none;">0</span></button>
    <button id="tab3" class="tab-btn" onclick="switchTab(3)">í‡´êµ ìˆ˜ì†¡</button>
  </div>

  <main class="app-content" id="main-content">
    <!-- íƒ­ 0: ì¢…í•© ì¼ì •í‘œ -->
    <div id="view-0" style="display: block;">
      <div id="capture-area">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <button class="mini-btn" onclick="goToday()">ì˜¤ëŠ˜</button>
          <div style="display:flex; align-items:center; gap:10px;">
            <i class="fa-solid fa-chevron-left" style="color:var(--blue);" onclick="changeWeek(-1)"></i>
            <span id="week-range" style="font-weight:900; font-size:13px;">...</span>
            <i class="fa-solid fa-chevron-right" style="color:var(--blue);" onclick="changeWeek(1)"></i>
          </div>
        </div>
        <div class="schedule-wrapper">
          <table class="schedule-table">
            <thead id="sched-head"></thead>
            <tbody id="sched-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- íƒ­ 1: ê¸ˆì¼ ì¼ì • (ë³´ê°•ë¨) -->
    <div id="view-1" style="display: none;">
      <div id="today-timeline-container" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>

    <!-- íƒ­ 2: ê°•ì‚¬ ìˆ˜ì†¡ -->
    <div id="view-2" style="display: none; height:100%; overflow:hidden; display:flex; flex-direction:column;">
      <div style="padding: 8px; background: #fff; border-bottom: 1px solid #ddd; display:flex; justify-content:flex-end;">
          <button class="mini-btn" onclick="clearFinished()">ì™„ë£Œ/ì·¨ì†Œ ëª©ë¡ ì‚­ì œ</button>
      </div>
      <div class="chat-container" id="chat-list-inner" style="flex:1; overflow-y:auto;"></div>
    </div>

    <!-- íƒ­ 3: í‡´êµ ìˆ˜ì†¡ -->
    <div id="view-3" style="display: none;">
      <div class="list-wrapper">
          <div class="list-header">
              <div class="t-cell">ê³¼ì •ëª…</div><div class="t-cell">ì´ì›</div><div class="t-cell">ì¶œë°œì‹œê°„</div><div class="t-cell">ê³µì§€</div>
          </div>
          <div id="trainee-list-body"></div>
      </div>
    </div>
  </main>
</div>

<!-- í†µí•© ëª¨ë‹¬ -->
<div id="allInOneModal" class="modal-overlay" onclick="if(event.target==this) closeModal('allInOneModal')">
  <div class="modal-box">
    <div id="m-header" style="font-weight:900; font-size:16px; margin-bottom:15px; border-bottom:2px solid var(--blue); padding-bottom:5px;">ì¼ì • ê´€ë¦¬</div>
    <input type="date" id="m-date" class="modal-input">
    <select id="m-type" class="modal-input" onchange="toggleReasonInput()">
        <option value="prof">ê°•ì‚¬ ìˆ˜ì†¡ ì¶”ê°€</option>
        <option value="off">ìš´í–‰ ë¶ˆê°€(OFF) ì„¤ì •</option>
    </select>
    <div id="reason-area">
        <input type="text" id="m-reason" class="modal-input" placeholder="ê°•ì‚¬ëª… ë˜ëŠ” ì‚¬ìœ ">
        <div id="prof-fields">
            <input type="time" id="m-time" class="modal-input">
            <input type="text" id="m-dir" class="modal-input" placeholder="ì˜¤ì†¡->í•­ê¸°ì›">
        </div>
    </div>
    <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="m-btn" style="background:#f1f5f9; flex:1; height:45px; border-radius:8px; border:none; font-weight:800;" onclick="closeModal('allInOneModal')">ì·¨ì†Œ</button>
        <button class="m-btn" style="background:var(--blue); color:#fff; flex:1; height:45px; border-radius:8px; border:none; font-weight:800;" onclick="saveAllInOne()">ì €ì¥</button>
    </div>
    <button id="del-btn" style="width:100%; height:40px; margin-top:10px; background:var(--danger); color:#fff; border:none; border-radius:8px; font-weight:800; display:none;" onclick="deleteRecord()">ì¼ì • ì‚­ì œ</button>
  </div>
</div>

<script src="config.js"></script>
<script>
  let allCourses = {}, profReqs = [], weekOffset = 0, currentTab = 0, draggedItem = null;

  function init() {
    firebase.database().ref('courses').on('value', snap => { allCourses = snap.val() || {}; renderAll(); });
    firebase.database().ref('system/transport_requests').on('value', snap => {
      const raw = snap.val() || {};
      let pendingCount = 0;
      profReqs = Object.keys(raw).map(k => {
        const item = { id: k, ...raw[k] };
        if(item.status === 'pending') pendingCount++;
        return item;
      }).sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0)); // [3-2] ì¹´í†¡ ì •ë ¬ (ìµœì‹  ì•„ë˜)

      updateBadge(pendingCount);
      renderAll();
      if(currentTab === 2) scrollToBottom();
    });
  }

  // [2] ì¢…í•© ì¼ì •í‘œ
  function renderSchedule() {
    const head = document.getElementById('sched-head'), body = document.getElementById('sched-body');
    const range = getWeekDates(weekOffset);
    document.getElementById('week-range').innerText = `${range[0]} ~ ${range[4].substring(5)}`;
    head.innerHTML = `<tr><th class="time-col">ì‹œê°„</th>${['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'].map((day, i) => `<th>${range[i].substring(5)}<br>${day}</th>`).join('')}</tr>`;

    let html = '';
    for(let h=8; h<=18; h++) {
      html += `<tr><td class="time-col">${h}:00</td>`;
      for(let d=0; d<5; d++) {
        const curDate = range[d];
        let cell = '';
        if(d === 0 && (h === 9 || h === 10)) cell = `<div class="cell-event block-entry">ì…êµìˆ˜ì†¡</div>`;
        else if(h === 12) cell = `<span style="opacity:0.3; font-size:9px;">íœ´ê²Œ</span>`;
        else {
            profReqs.filter(r => r.date === curDate && parseInt(r.time?.split(':')[0]) === h && r.status !== 'cancelled').forEach(item => {
                const isOff = item.prof === 'ìš´í–‰ì¤‘ë‹¨';
                cell += `<div class="cell-event ${isOff?'block-off':'block-prof'}" draggable="true" ondragstart="onDragStart(event,'${item.id}')" onclick="openEditModal('${item.id}')">${isOff?'ìš´í–‰ë¶ˆê°€':item.prof}</div>`;
            });
            for(let rid in allCourses) {
                const dep = allCourses[rid]?.shuttle?.departure;
                if(dep && dep.date === curDate && parseInt(dep.time?.split(':')[0]) === h) cell += `<div class="cell-event block-departure" onclick="switchTab(3)">í‡´êµìˆ˜ì†¡</div>`;
            }
        }
        html += `<td ondrop="onDrop(event,'${curDate}','${h}:00')" ondragover="allowDrop(event)" onclick="if(!event.target.closest('.cell-event')) openEmptyCell('${curDate}','${h}:00')">${cell}</td>`;
      }
      html += `</tr>`;
    }
    body.innerHTML = html;
  }

  // [1] ê¸ˆì¼ ì¼ì • (ë³´ê°•ëœ ë¡œì§)
  function renderTodayTimeline() {
    const container = document.getElementById('today-timeline-container');
    const today = new Date().toISOString().split('T')[0];
    let items = [];

    // ê°•ì‚¬ ìˆ˜ì†¡ ì¶”ê°€
    profReqs.filter(r => r.date === today && r.status === 'approved').forEach(r => {
        items.push({ time: r.time, info: `ğŸš– ê°•ì‚¬ìˆ˜ì†¡: ${r.prof} (${r.dir})`, type: 'prof' });
    });

    // í‡´êµ ìˆ˜ì†¡ ì¶”ê°€
    Object.keys(allCourses).forEach(rid => {
        const dep = allCourses[rid].shuttle?.departure;
        if(dep && dep.date === today && dep.time) {
            items.push({ time: dep.time, info: `ğŸšŒ í‡´êµìˆ˜ì†¡: ${allCourses[rid].settings.courseName}`, type: 'dep' });
        }
    });

    items.sort((a,b) => a.time.localeCompare(b.time));
    
    if(items.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#888;">ê¸ˆì¼ ì˜ˆì •ëœ ìˆ˜ì†¡ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    } else {
        container.innerHTML = items.map(i => `
            <div class="timeline-item">
                <div class="tm-time">${i.time}</div>
                <div class="tm-info">${i.info}</div>
            </div>
        `).join('');
    }
  }

  // [3] ê°•ì‚¬ ìˆ˜ì†¡ ë¦¬ìŠ¤íŠ¸ (ì¹´í†¡ ë°©ì‹)
  function renderInstructorChat() {
    const box = document.getElementById('chat-list-inner');
    let html = "";
    profReqs.forEach(r => {
      const isPending = r.status === 'pending', isMine = r.status === 'approved' || r.status === 'finished', isCancelled = r.status === 'cancelled';
      if(isCancelled) html += `<div style="text-align:center; margin:5px 0;"><span style="background:rgba(0,0,0,0.1); padding:2px 8px; border-radius:10px; font-size:10px;">ì·¨ì†Œ ì•Œë¦¼: ${r.prof} ê°•ì‚¬ë‹˜ ìˆ˜ì†¡ ì·¨ì†Œ</span></div>`;
      else html += `
        <div class="req-card ${isMine?'mine':''}">
            <div style="font-size:9px; color:${isPending?'var(--danger)':'#666'}; font-weight:800;">${isPending?'â— ì‹ ê·œìš”ì²­':'âœ“ í™•ì¸ë¨'}</div>
            <div style="font-weight:900; font-size:12px;">${r.date} (${r.time})</div>
            <div style="font-size:11px; color:var(--blue-deep); font-weight:800;">${r.dir}</div>
            <div style="font-size:11px; font-weight:700;">${r.prof} <a href="tel:${r.phone}" style="color:var(--blue); margin-left:5px;"><i class="fa-solid fa-phone"></i></a></div>
            ${isPending ? `<div class="req-btn-group"><button class="mini-btn primary" onclick="approveRequest('${r.id}')">ìŠ¹ì¸</button><button class="mini-btn" onclick="cancelRequest('${r.id}')">ë¶ˆê°€</button></div>` : ''}
        </div>`;
    });
    box.innerHTML = html;
  }

  // [4] í‡´êµ ìˆ˜ì†¡ (ê·¸ë¦¬ë“œ ë°©ì‹/DB ì—°ë™ ë³´ê°•)
  function renderTraineeGrid() {
    const container = document.getElementById('trainee-list-body');
    let html = "";
    Object.keys(allCourses).forEach(rid => {
        const room = allCourses[rid]; if(room.status?.roomStatus !== 'active') return;
        const dep = room.shuttle?.departure || { time: "", announced: false }, total = Object.values(room.shuttle?.requests || {}).filter(r => r.type !== 'car').length;
        html += `<div class="course-row">
            <div class="t-cell" style="font-weight:800; font-size:12px;">${room.settings?.courseName}</div>
            <div class="t-cell" style="color:var(--blue); font-weight:900;">${total}ëª…</div>
            <div class="t-cell"><div style="display:flex; gap:3px;">
                <button class="mini-btn ${dep.time==='13:00'?'primary':''}" onclick="setDeparture('${rid}','13:00')">13:00</button>
                <button class="mini-btn ${dep.time==='15:00'?'primary':''}" onclick="setDeparture('${rid}','15:00')">15:00</button>
            </div></div>
            <div class="t-cell"><button class="notice-btn" onclick="toggleNotice('${rid}', ${dep.announced})">${dep.announced ? 'ğŸ””' : 'ğŸ”•'}</button></div>
        </div>`;
    });
    container.innerHTML = html;
  }

  // [4-2] í”¼ë“œë°± ë° DB ì €ì¥ ë³´ê°•
  async function setDeparture(rid, time) { 
      const today = new Date().toISOString().split('T')[0];
      await firebase.database().ref(`courses/${rid}/shuttle/departure`).update({ time, date: today }); 
      alert(`${time} ì¶œë°œë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`); 
  }
  async function toggleNotice(rid, currentStatus) { 
      if(confirm(`í‡´êµ ìˆ˜ì†¡ ì •ë³´ë¥¼ ${currentStatus ? 'ê³µì§€ ì·¨ì†Œ' : 'ê³µì§€ ì™„ë£Œ'} ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          await firebase.database().ref(`courses/${rid}/shuttle/departure`).update({ announced: !currentStatus });
          alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
  }

  // [AI] ì§€ëŠ¥í˜• ë°°ì°¨ ê°€ì´ë“œ (10ë¶„ ì „ ë„ì°© ì›ì¹™)
  function runAICheck(newTime) {
      const hh = parseInt(newTime.split(':')[0]);
      const mm = parseInt(newTime.split(':')[1]);
      if (mm > 40) return `âš ï¸ ì£¼ì˜: ê³¼ì • ì‹œì‘ ì •ì‹œ 10ë¶„ ì „(${hh}:50) ë„ì°©ì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°œë³„ í”½ì—…ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`;
      return null;
  }

  // [2-2] ë“œë˜ê·¸ ì•¤ ë“œë¡­
  function allowDrop(ev) { ev.preventDefault(); }
  function onDragStart(ev, id) { draggedItem = id; }
  async function onDrop(ev, date, time) {
    ev.preventDefault(); if(!draggedItem) return;
    if(confirm(`${date} ${time}ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { 
        await firebase.database().ref(`system/transport_requests/${draggedItem}`).update({ date, time }); 
        alert("ì¼ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); 
    }
    draggedItem = null;
  }

  // í†µí•© ëª¨ë‹¬
  function openEmptyCell(date, time) {
    document.getElementById('m-header').innerText = "ìƒˆ ìˆ˜ì†¡ ì¼ì • ì¶”ê°€";
    document.getElementById('m-date').value = date; document.getElementById('m-time').value = time;
    document.getElementById('del-btn').style.display = 'none';
    document.getElementById('allInOneModal').style.display = 'flex';
  }
  function openEditModal(id) {
    const item = profReqs.find(r => r.id === id); if(!item) return;
    document.getElementById('m-header').innerText = "ì¼ì • ìˆ˜ì •";
    document.getElementById('m-date').value = item.date; document.getElementById('m-time').value = item.time;
    document.getElementById('m-reason').value = item.prof==='ìš´í–‰ì¤‘ë‹¨'?item.dir:item.prof;
    document.getElementById('m-dir').value = item.dir || "";
    document.getElementById('allInOneModal').dataset.editId = id;
    document.getElementById('del-btn').style.display = 'block';
    document.getElementById('allInOneModal').style.display = 'flex';
  }
  async function saveAllInOne() {
    const id = document.getElementById('allInOneModal').dataset.editId;
    const type = document.getElementById('m-type').value, date = document.getElementById('m-date').value, time = document.getElementById('m-time').value, reason = document.getElementById('m-reason').value, dir = document.getElementById('m-dir').value;
    const data = { date, time, prof: type==='off'?'ìš´í–‰ì¤‘ë‹¨':reason, dir: type==='off'?reason:dir, status: 'approved', timestamp: Date.now() };
    if(id) await firebase.database().ref(`system/transport_requests/${id}`).update(data);
    else await firebase.database().ref('system/transport_requests').push(data);
    alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); closeModal('allInOneModal');
  }
  async function deleteRecord() {
      const id = document.getElementById('allInOneModal').dataset.editId;
      if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await firebase.database().ref(`system/transport_requests/${id}`).remove(); closeModal('allInOneModal'); }
  }

  async function approveRequest(id) { 
      const r = profReqs.find(it => it.id === id);
      const aiWarn = runAICheck(r.time);
      if(aiWarn) { if(!confirm(aiWarn + "\n\nê·¸ë˜ë„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; }
      await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'approved' }); 
      alert("ìŠ¹ì¸ ì™„ë£Œ!"); 
  }
  async function cancelRequest(id) { if(confirm("ë¶ˆê°€ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'cancelled' }); alert("ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."); } }
  
  function handleBack() { if(confirm("í¬íƒˆ ì‚¬ì´íŠ¸ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) location.href = 'potal.html'; }
  function toggleSidebar() { const sb = document.getElementById('sidebar'), ol = document.querySelector('.sidebar-overlay'), isOpen = sb.classList.contains('open'); sb.classList.toggle('open', !isOpen); ol.style.display = isOpen ? 'none' : 'block'; }
  function switchTab(n) { currentTab = n; document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === n)); document.querySelectorAll('[id^="view-"]').forEach((v, i) => v.style.display = i === n ? 'block' : 'none'); renderAll(); if(n === 2) setTimeout(scrollToBottom, 100); }
  function scrollToBottom() { const box = document.getElementById('chat-list-inner'); box.scrollTop = box.scrollHeight; }
  function updateBadge(count) { const b = document.getElementById('badge-count'); if(count > 0) { b.innerText = count; b.style.display = 'block'; } else b.style.display = 'none'; }
  function renderAll() { renderSchedule(); renderTodayTimeline(); renderInstructorChat(); renderTraineeGrid(); }
  function changeWeek(n) { weekOffset += n; renderAll(); }
  function goToday() { weekOffset = 0; renderAll(); }
  function closeModal(id) { document.getElementById(id).style.display = 'none'; delete document.getElementById(id).dataset.editId; }
  function getWeekDates(offset) { const now = new Date(), day = now.getDay(), diff = (day === 0 ? 1 : 1 - day), mon = new Date(now); mon.setDate(now.getDate() + diff + (offset * 7)); const res = []; for(let i=0; i<5; i++) { const d = new Date(mon); d.setDate(mon.getDate()+i); res.push(d.toISOString().split('T')[0]); } return res; }
  function toggleReasonInput() { const type = document.getElementById('m-type').value; document.getElementById('prof-fields').style.display = type==='off'?'none':'block'; }
  async function clearFinished() { if(confirm("ì™„ë£Œ/ì·¨ì†Œëœ ëª©ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { profReqs.filter(r => r.status==='finished' || r.status==='cancelled').forEach(t => firebase.database().ref(`system/transport_requests/${t.id}`).remove()); } }
  
  init();
</script>
</body>
</html>