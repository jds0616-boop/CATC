<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>í•­ê³µê¸°ìˆ í›ˆë ¨ì› ì°¨ëŸ‰ì§€ì› ì‹œìŠ¤í…œ</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
<style>
    :root {
      --navy: #0f172a; --blue: #0ea5e9; --blue-deep: #0369a1;
      --bg: #f1f5f9; --card: #ffffff; --border: #e2e8f0;
      --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
    body { margin: 0; padding: 0; background: #cfd8e3; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }
    .app-container { width: 100%; max-width: 600px; height: 100%; background: var(--bg); display: flex; flex-direction: column; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.2); }
    .app-header { height: 60px; background: var(--navy); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 2px solid var(--blue); flex-shrink: 0; }
    .header-title { font-size: 17px; font-weight: 900; color: #fff; letter-spacing: -0.5px; }
    .sync-status { font-size: 11px; color: var(--success); font-weight: 800; display: flex; align-items: center; gap: 5px; }
    .tab-bar { display: flex; background: #fff; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .tab-btn { flex: 1; padding: 16px 0; border: none; background: none; font-size: 14px; font-weight: 800; color: #94a3b8; cursor: pointer; border-bottom: 3px solid transparent; }
    .tab-btn.active { color: var(--blue-deep); border-bottom-color: var(--blue); background: #f8fafc; }
    .app-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
    .list-wrapper { background: #fff; border-radius: 12px; border: 1.5px solid #e2e8f0; overflow: hidden; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .list-header, .course-row { display: grid; grid-template-columns: 1.5fr 0.6fr 1.8fr 0.6fr; align-items: center; text-align: center; width: 100%; }
    .list-header { background: #f1f5f9; border-bottom: 2px solid #cbd5e1; font-size: 11px; font-weight: 900; color: #475569; }
    .course-row { border-bottom: 1px solid #f1f5f9; cursor: pointer; }
    .t-cell { padding: 12px 5px; height: 100%; display: flex; align-items: center; justify-content: center; border-right: 1px solid #f1f5f9; overflow: hidden; }
    .t-cell:last-child { border-right: none; }
    .t-cell.name { justify-content: center; font-size: 13px; font-weight: 800; color: #1e293b; padding: 0 10px; }
    .t-cell.count { font-size: 13px; font-weight: 900; color: #0ea5e9; }
    .t-cell.btns { gap: 4px; padding: 8px 6px; }
    .mini-btn { height: 34px; flex: 1; border-radius: 6px; border: 1px solid #e2e8f0; background: #fff; font-size: 11px; font-weight: 800; color: #64748b; }
    .mini-btn.active { background: #0f172a !important; color: #fff !important; }
    .week-nav { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 10px; background: #fff; padding: 12px; border-radius: 12px; border: 1px solid var(--border); }
    .nav-arrow { font-size: 24px; color: var(--blue-deep); cursor: pointer; }
    .week-label { font-size: 15px; font-weight: 900; color: var(--navy); }
    .schedule-wrapper { background: #fff; border: 1px solid #000; border-radius: 8px; overflow: hidden; }
    .schedule-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .schedule-table th, .schedule-table td { border: 1px solid #ddd; text-align: center; height: 50px; font-size: 9px; vertical-align: middle; padding: 2px; }
    .schedule-table th { background: #f1f5f9; font-weight: 900; height: 45px; color: var(--navy); border-bottom: 2px solid var(--navy); }
    .time-col { width: 45px; background: #f1f5f9 !important; font-weight: 800; border-right: 2px solid var(--navy) !important; font-size: 11px !important; }
    .capture-btn { width: 100%; height: 45px; background: #fff; border: 2px solid var(--blue); color: var(--blue-deep); border-radius: 12px; font-weight: 800; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; }
    .cell-event { border-radius: 4px; padding: 4px 2px; height: 100%; display: flex; flex-direction: column; justify-content: center; font-weight: 800; line-height: 1.2; cursor: pointer; }
    .block-entry { background: #eff6ff; color: #1e40af; border: 1px solid #1e40af; }
    .block-prof { background: #fae8ff; color: #a21caf; border: 1px solid #a21caf; }
    .block-departure { background: #ecfdf5; color: #047857; border: 1px solid #047857; }
    .block-off { background: #fee2e2; color: #ef4444; }
    .chat-container { background: #abc1d1; display: flex; flex-direction: column; gap: 15px; padding: 15px; border-radius: 12px; min-height: 400px; }
    .chat-date-line { text-align: center; margin: 10px 0; }
    .chat-date-line span { background: rgba(0,0,0,0.2); color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 11px; }
    .chat-bubble { max-width: 85%; position: relative; display: flex; flex-direction: column; margin-bottom: 5px; }
    .chat-left { align-self: flex-start; }
    .bubble-content { background: #fff; padding: 12px; border-radius: 0 12px 12px 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 13px; line-height: 1.5; }
    .chat-right { align-self: flex-end; }
    .bubble-reply { background: #fee500; padding: 10px; border-radius: 12px 0 12px 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 12px; font-weight: 800; color: #1e293b; }
    .talk-header { color: #888; font-size: 11px; margin-bottom: 5px; font-weight: 800; }
    .talk-body { color: #1e293b; font-weight: 700; white-space: pre-line; }
    .talk-leg-item { padding: 8px 0; border-bottom: 1px dashed #eee; }
    .mini-talk-btn { flex: 1; height: 32px; border-radius: 6px; border: 1px solid #e2e8f0; background: #fff; font-size: 11px; font-weight: 800; cursor: pointer; }
    .footer-home { width: 56px; height: 56px; background: var(--blue); color: #fff; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 24px; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); box-shadow: 0 8px 20px rgba(0,0,0,0.3); cursor: pointer; border: 4px solid #fff; z-index: 10000; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9000; align-items: center; justify-content: center; padding: 20px; }
    .modal-box { background: #fff; width: 100%; max-width: 440px; border-radius: 28px; padding: 30px; text-align: center; }
    .m-btn { flex: 1; height: 50px; border-radius: 12px; border: none; font-weight: 900; font-size: 15px; cursor: pointer; }
    .m-btn.ok { background: var(--blue); color: #fff; }
    .m-btn.no { background: #f1f5f9; color: #64748b; }
</style>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>

<div class="app-container">
  <header class="app-header">
    <div id="back-btn-area" style="min-width:60px; color:#fff; font-size:18px; font-weight:900; cursor:pointer;" onclick="handleBack()">
        <span id="back-btn-text">&lt;&lt;</span>
    </div>
    <div class="header-title">í•­ê³µê¸°ìˆ í›ˆë ¨ì› ì°¨ëŸ‰ì§€ì› ì‹œìŠ¤í…œ</div>
    <div class="sync-status"><i class="fa-solid fa-sync fa-spin"></i> ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</div>
  </header>

  <div class="tab-bar">
    <button id="tab0" class="tab-btn active" onclick="switchTab(0)">ì¢…í•© ì¼ì •í‘œ</button>
    <button id="tab1" class="tab-btn" onclick="switchTab(1)">ê°•ì‚¬ ìˆ˜ì†¡ ë¦¬ìŠ¤íŠ¸</button>
    <button id="tab2" class="tab-btn" onclick="switchTab(2)">êµìœ¡ìƒ í‡´êµ ê´€ë¦¬</button>
  </div>

  <main class="app-content" id="main-content">
    <!-- íƒ­ 0 -->
    <div id="view-0" style="display: block;">
      <div id="capture-area" style="padding: 10px; background: var(--bg); border-radius: 12px;">
        <div class="week-nav">
          <i class="fa-solid fa-circle-chevron-left nav-arrow" onclick="changeWeek(-1)"></i>
          <div class="week-label" id="week-range">ë‚ ì§œ ê³„ì‚° ì¤‘...</div>
          <i class="fa-solid fa-circle-chevron-right nav-arrow" onclick="changeWeek(1)"></i>
        </div>
        <div class="schedule-wrapper">
          <table class="schedule-table">
            <thead id="sched-head"></thead>
            <tbody id="sched-body"></tbody>
          </table>
        </div>
      </div>
      <button class="capture-btn" onclick="captureSchedule()">
        <i class="fa-solid fa-camera"></i> í˜„ì¬ ì¼ì •í‘œ ì´ë¯¸ì§€ ì €ì¥ (ìº¡ì³)
      </button>
    </div>
    <!-- íƒ­ 1 -->
    <div id="view-1" style="display: none;">
      <div id="all-request-container"></div> 
    </div>
    <!-- íƒ­ 2 -->
    <div id="view-2" style="display: none;">
      <div id="trainee-course-list"></div>
    </div>
  </main>
  <div class="footer-home" id="floating-home" onclick="switchTab(0)"><i class="fa-solid fa-house"></i></div>
</div>

<!-- ëª¨ë‹¬ë“¤ -->
<div id="detailModal" class="modal-overlay" onclick="if(event.target==this) closeModal('detailModal')">
  <div class="modal-box">
    <div class="modal-title" id="m-title">ì •ë³´</div>
    <div id="m-content" style="text-align:left; font-size:14px; color:#475569; line-height:1.6; margin-bottom:20px;"></div>
    <button class="m-btn no" onclick="closeModal('detailModal')" style="width:100%">ë‹«ê¸°</button>
  </div>
</div>
<div id="confirmModal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-title" id="c-title">í™•ì¸</div>
    <div id="c-desc" style="text-align:left; font-size:14px; color:#475569; margin-bottom:25px;">ë‚´ìš©</div>
    <div style="display:flex; gap:10px;">
        <button class="m-btn no" onclick="closeModal('confirmModal')">ì·¨ì†Œ</button>
        <button class="m-btn ok" id="c-ok-btn">í™•ì¸</button>
    </div>
  </div>
</div>






<script src="config.js"></script>
<script>
  let allCourses = {}
  let profReqs = []
  let weekOffset = 0
  let prevPendingCount = 0
  let currentTab = 0
  const alarmAudio = new Audio('timer.mp3')

  // 1. ë°ì´í„° ë¡œë“œ ë° ìë™ ë§ˆê° ë¡œì§
  function init() {
    firebase.database().ref('courses').on('value', snap => {
      allCourses = snap.val() || {}
      renderAll()
    })

    firebase.database().ref('system/transport_requests').on('value', snap => {
      const raw = snap.val() || {}
      const now = new Date()
      const updates = {}
      let hasUpdates = false

      profReqs = Object.keys(raw).map(k => {
        const item = { id: k, ...raw[k] }
        if (item.status === 'approved' && item.date && item.time) {
          const scheduledTime = new Date(item.date + ' ' + item.time)
          const limitTime = new Date(scheduledTime.getTime() + 2 * 60 * 60 * 1000)
          if (now > limitTime && !isNaN(scheduledTime.getTime())) {
            updates[`system/transport_requests/${k}/status`] = 'finished'
            item.status = 'finished'
            hasUpdates = true
          }
        }
        return item
      }).filter(r => r.date && r.prof && r.courseRID && r.time)

      if (hasUpdates) firebase.database().ref().update(updates)
      checkNewRequests()
      renderAll()
    })
  }

  // [í•µì‹¬] ë…¸ì„  ë° êµ¬ê°„ ì‹œê°„ ê³„ì‚°ê¸° (ê°ì²´ ë‚´ë¶€ ì‰¼í‘œ ìœ ì§€ í•„ìˆ˜)
  const RouteManager = {
    INTERVAL: 30,
    points: ['í•­ê¸°ì›', 'ì˜¤ì†¡ì—­', 'ì²­ì£¼í„°ë¯¸ë„', 'ì²­ì£¼ê³µí•­'],

    getOffset: function(dirStr) {
      if(!dirStr || !dirStr.includes('â†’')) return { idx: -1, isOutbound: false }
      const isOutbound = dirStr.startsWith('í•­ê¸°ì›')
      const path = isOutbound ? [...this.points] : [...this.points].reverse()
      const targetLoc = isOutbound ? dirStr.split('â†’')[1] : dirStr.split('â†’')[0]
      const idx = path.findIndex(p => targetLoc && targetLoc.includes(p))
      return { idx, isOutbound }
    },

    analyzeConflict: function(existingReq, newTime, newDir) {
      const existInfo = this.getOffset(existingReq.dir)
      const newInfo = this.getOffset(newDir)
      if (existInfo.idx === -1 || newInfo.idx === -1 || existInfo.isOutbound !== newInfo.isOutbound) return null

      const exMin = this.toMin(existingReq.time)
      const newMin = this.toMin(newTime)
      if(exMin < 0 || newMin < 0) return null

      const stopDiff = newInfo.idx - existInfo.idx
      const recommendedMin = exMin + (stopDiff * this.INTERVAL)
      const recH = Math.floor(recommendedMin / 60).toString().padStart(2, '0')
      const recM = (recommendedMin % 60).toString().padStart(2, '0')
      const recTime = `${recH}:${recM}`

      if (Math.abs(newMin - recommendedMin) <= 20) {
        const newLoc = newDir.includes('â†’') ? (newInfo.isOutbound ? newDir.split('â†’')[1] : newDir.split('â†’')[0]) : "í•´ë‹¹ì¥ì†Œ"
        return {
          msg: `ğŸ’¡ [ë™ì„  í•©ìŠ¹ ì œì•ˆ]\n\nì´ë¯¸ ${existingReq.prof}ê°•ì‚¬ë‹˜ ì˜ˆì•½(${existingReq.time})ì´ ë…¸ì„ ìƒì— ìˆìŠµë‹ˆë‹¤.\n\nì´ ì°¨ëŸ‰ì„ í•¨ê»˜ ì´ìš©í•  ê²½ìš°, ${newLoc} ê¶Œì¥ íƒ‘ìŠ¹ì‹œê°„ì€ [${recTime}]ì…ë‹ˆë‹¤.\nê°•ì‚¬ë‹˜ê»˜ ì—°ë½í•˜ì—¬ ì‹œê°„ì„ ì¡°ìœ¨í•˜ê³  í•©ìŠ¹ ì•ˆë‚´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
        }
      }
      return null
    },

    toMin: function(tStr) {
      if(!tStr) return -1000
      const parts = tStr.split(':')
      return parseInt(parts[0]) * 60 + parseInt(parts[1])
    }
  }

  // ì§€ëŠ¥í˜• ë°°ì°¨ ìŠ¹ì¸ í•¨ìˆ˜
  async function handleSmartApprove(id) {
    const target = profReqs.find(r => r.id === id)
    if(!target || target.prof === 'ìš´í–‰ì¤‘ë‹¨') return

    const toMin = (tStr) => {
      if(!tStr || typeof tStr !== 'string') return -1000
      const p = tStr.split(':')
      return parseInt(p[0]) * 60 + parseInt(p[1])
    }

    const targetMin = toMin(target.time)
    let conflicts = []
    let advice = ""

    profReqs.forEach(r => {
      if(r.id !== id && (r.status === 'approved' || r.status === 'finished') && r.date === target.date && r.prof !== 'ìš´í–‰ì¤‘ë‹¨') {
        const rMin = toMin(r.time)
        if(Math.abs(rMin - targetMin) < 60) {
          conflicts.push(`ğŸš– [ê°•ì‚¬ìˆ˜ì†¡] ${r.prof}ë‹˜ (${r.time} / ${r.dir})`)
          const result = RouteManager.analyzeConflict(r, target.time, target.dir)
          if (result && !advice) advice = result.msg
        }
      }
    })

    Object.keys(allCourses).forEach(rid => {
      const dep = allCourses[rid]?.shuttle?.departure
      if(dep && dep.date === target.date && dep.time) {
        if(Math.abs(toMin(dep.time) - targetMin) < 60) {
          conflicts.push(`ğŸšŒ [í•™ìƒí‡´êµ] ${allCourses[rid].settings?.courseName || rid} (${dep.time})`)
        }
      }
    })

    if (advice) { if (!confirm(advice)) return }
    else if (conflicts.length > 0) { if (!confirm(`âš ï¸ [ë°°ì°¨ ì¤‘ë³µ ê²½ê³ ]\n\nì˜ˆì•½í•˜ì‹  ì‹œê°„ ì „í›„ë¡œ ì´ë¯¸ ì¼ì •ì´ ì¡´ì¬í•©ë‹ˆë‹¤:\n\n${conflicts.join('\n')}\n\nê·¸ëŒ€ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return }

    try {
      await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'approved' })
    } catch(e) { alert("ì˜¤ë¥˜: " + e.message) }
  }

  function renderAll() {
    renderSchedule()
    renderInstructorList()
    renderTraineeManagement()
  }

  function renderSchedule() {
    const head = document.getElementById('sched-head')
    const body = document.getElementById('sched-body')
    const range = getWeekDates(weekOffset)
    if (!head || !body || !range) return
    
    document.getElementById('week-range').innerText = `${range[0]} ~ ${range[4].substring(5)}`
    head.innerHTML = `<tr><th class="time-col">ì‹œê°„</th>${['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'].map((day, i) => `<th onclick="askDayOff('${range[i]}')">${range[i].substring(5)}<br>${day}</th>`).join('')}</tr>`
    
    let html = ''
    for(let h=8; h<=18; h++) {
      html += `<tr><td class="time-col">${h}:00</td>`
      for(let d=0; d<5; d++) {
        const curDate = range[d]
        let cell = ''
        const isOff = profReqs.some(r => r.date === curDate && r.prof === 'ìš´í–‰ì¤‘ë‹¨')
        if(isOff) cell = (h === 12) ? `<div class="cell-event block-off">ìš´í–‰ë¶ˆê°€</div>` : `<div class="cell-event block-off"></div>`
        else if(h === 12) cell = `<div class="cell-event" style="opacity:0.3;">ì ì‹¬</div>`
        else if(d === 0 && (h === 9 || h === 10)) cell = `<div class="cell-event block-entry">ì…êµìˆ˜ì†¡</div>`
        else {
          const matched = profReqs.filter(r => (r.status === 'approved' || r.status === 'finished') && r.date === curDate && parseInt(r.time.split(':')[0]) === h)
          if(matched.length > 0) {
            const isFin = matched.every(r => r.status === 'finished')
            cell = `<div class="cell-event block-prof" style="${isFin?'background:#e2e8f0;':''}" onclick="showDetail('prof', '${encodeURIComponent(JSON.stringify(matched))}')">${matched[0].dir.replace('â†’','>')}<br>${matched.length>1?'ê°•ì‚¬ '+matched.length+'ëª…':matched[0].prof}</div>`
          } else {
            for (const rid in allCourses) {
              const dep = allCourses[rid]?.shuttle?.departure
              if(dep && dep.date === curDate && parseInt(dep.time.split(':')[0]) === h) {
                cell = `<div class="cell-event block-departure" onclick="showDrillDown('course', '${rid}')">í‡´êµìˆ˜ì†¡</div>`
                break
              }
            }
          }
        }
        html += `<td>${cell}</td>`
      }
      html += `</tr>`
    }
    body.innerHTML = html
  }

  function renderInstructorList() {
    const inner = document.getElementById('all-request-container')
    if (!inner) return
    inner.innerHTML = '<div class="chat-container" id="chat-list-inner" style="overflow-y:auto; height: 400px;"></div>'
    const box = document.getElementById('chat-list-inner')
    
    const grouped = {}
    profReqs.filter(r => r.prof !== 'ìš´í–‰ì¤‘ë‹¨').forEach(r => {
      const day = r.timestamp ? new Date(r.timestamp).toISOString().split('T')[0] : r.date
      const k = `${day}_${r.prof}_${r.courseRID}`
      if (!grouped[k]) grouped[k] = { day, prof: r.prof, phone: r.phone || "", rid: r.courseRID, legs: [] }
      grouped[k].legs.push(r)
    })

    let html = ""
    let lastDay = ""
    Object.values(grouped).sort((a,b) => a.day.localeCompare(b.day)).forEach((g, idx) => {
      if(g.day !== lastDay) { html += `<div class="chat-date-line"><span>${g.day} ìš”ì²­</span></div>`; lastDay = g.day; }
      const cName = allCourses[g.rid]?.settings?.courseName || "ê³¼ì • ì •ë³´ ì—†ìŒ"
      const isFin = g.legs.every(r => r.status === 'finished')
      
      let legs = ""
      let replies = ""
      g.legs.sort((a,b) => a.time.localeCompare(b.time)).forEach(r => {
        if(r.status === 'cancelled') {
           legs += `<div class="talk-leg-item" style="opacity:0.5; text-decoration:line-through;">${r.date} [${r.time}] ${r.dir}</div>`
        } else {
           const isApp = r.status === 'approved'
           const isF = r.status === 'finished'
           legs += `<div class="talk-leg-item">
              <b>${r.date} [${r.time}]</b><br>${r.dir}<br>
              <div style="margin-top:5px; display:flex; gap:5px;">
                ${(!isApp && !isF) ? `<button class="mini-talk-btn" style="background:#3b82f6; color:#fff;" onclick="handleSmartApprove('${r.id}')">ìŠ¹ì¸</button><button class="mini-talk-btn" onclick="confirmAction('delete', '${r.id}')">ë¶ˆê°€</button>` : (isApp ? `<span style="color:#10b981; font-size:11px;">âœ“ ìŠ¹ì¸ë¨</span><button class="mini-talk-btn" style="width:50px;" onclick="confirmAction('cancel', '${r.id}')">ì·¨ì†Œ</button>` : `<span style="color:#94a3b8; font-size:11px;">âœ… ë§ˆê°ë¨</span>`)}
              </div>
           </div>`
           if(isApp || isF) replies += `<div class="chat-bubble chat-right"><div class="bubble-reply" style="${isF?'background:#f1f5f9;':''}">${isF?'ìš´í–‰ ë§ˆê°':'ìŠ¹ì¸í–ˆìŠµë‹ˆë‹¤!'}</div></div>`
        }
      })

      html += `<div class="chat-bubble chat-left" style="${isFin?'opacity:0.6;':''}">
        <div class="talk-header">ìˆ˜ì†¡ìš”ì²­</div>
        <div class="bubble-content">
          <div style="font-size:10px; color:#64748b;">${cName}</div>
          <b>${g.prof} ê°•ì‚¬ë‹˜</b> (${formatPhone(g.phone)})
          <div style="margin-top:8px; border-top:1px solid #f1f5f9;">${legs}</div>
        </div>
      </div>` + replies
    })
    box.innerHTML = html
    setTimeout(() => { box.scrollTop = box.scrollHeight }, 100)
  }

  function renderTraineeManagement() {
    const area = document.getElementById('trainee-course-list')
    if (!area) return
    let html = `<div class="list-wrapper"><div class="list-header"><div class="t-cell name">ê³¼ì •ëª…</div><div class="t-cell">ì´ì›</div><div class="t-cell">ì¶œë°œì‹œê°„</div><div class="t-cell">ê³µì§€</div></div>`
    Object.keys(allCourses).forEach(rid => {
      const room = allCourses[rid]
      if (room.status?.roomStatus !== 'active') return
      const dep = room.shuttle?.departure || { time: "" }
      const total = Object.values(room.shuttle?.requests || {}).filter(r => r.type !== 'car').length
      html += `<div class="course-row">
        <div class="t-cell name">${room.settings?.courseName || rid}</div>
        <div class="t-cell count" onclick="showDrillDown('course', '${rid}')">${total}ëª…</div>
        <div class="t-cell btns">
          <button class="mini-btn ${dep.time === '13:00'?'active':''}" onclick="confirmAction('dep', '${rid}', '13:00')">13:00</button>
          <button class="mini-btn ${dep.time === '15:00'?'active':''}" onclick="confirmAction('dep', '${rid}', '15:00')">15:00</button>
        </div>
        <div class="t-cell">${dep.time ? 'âœ…' : '-'}</div>
      </div>`
    })
    area.innerHTML = html + '</div>'
  }

  function getWeekDates(offset) {
    const now = new Date(); const day = now.getDay()
    const diff = (day === 0 ? 1 : 1 - day); const mon = new Date(now)
    mon.setDate(now.getDate() + diff + (offset * 7))
    const res = []; for(let i=0; i<5; i++) { const d = new Date(mon); d.setDate(mon.getDate()+i); res.push(d.toISOString().split('T')[0]) }
    return res
  }

  function checkNewRequests() {
    const curr = profReqs.filter(r => r.status === 'pending').length
    if (curr > prevPendingCount) alarmAudio.play().catch(e => {})
    prevPendingCount = curr
  }

  function switchTab(n) {
    currentTab = n; document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === n))
    document.querySelectorAll('[id^="view-"]').forEach((v, i) => v.style.display = i === n ? 'block' : 'none')
    document.getElementById('floating-home').style.display = (n === 0) ? 'none' : 'flex'
  }

  function handleBack() { currentTab === 0 ? location.href = 'potal.html' : switchTab(0) }
  function changeWeek(n) { weekOffset += n; renderAll() }
  function closeModal(id) { document.getElementById(id).style.display = 'none' }
  function formatPhone(s) { if(!s) return ""; s = s.replace(/[^0-9]/g, ""); return s.length === 11 ? s.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3") : s }

  async function confirmAction(type, id, val) {
    const ok = document.getElementById('c-ok-btn')
    if(type === 'dep') {
      document.getElementById('c-title').innerText = "í‡´êµ ì‹œê°„ ê³µì§€"
      document.getElementById('c-desc').innerText = `${val}ì‹œë¡œ ê³µì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
      ok.onclick = async () => { await firebase.database().ref(`courses/${id}/shuttle/departure`).update({ time: val }); closeModal('confirmModal') }
    } else if(type === 'cancel') {
      ok.onclick = async () => { await firebase.database().ref(`system/transport_requests/${id}`).update({ status: 'pending' }); closeModal('confirmModal') }
    } else if(type === 'delete') {
      if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await firebase.database().ref(`system/transport_requests/${id}`).remove()
      return
    }
    document.getElementById('confirmModal').style.display = 'flex'
  }

  function showDetail(type, str) {
    const data = JSON.parse(decodeURIComponent(str))
    let html = `<b>${data[0].date} ìˆ˜ì†¡ ë‚´ì—­</b><br>`
    data.forEach(p => {
      html += `<div style="background:#f8fafc; padding:10px; border-radius:8px; margin-top:10px;">
        ${p.time} / <b>${p.prof} ê°•ì‚¬ë‹˜</b><br>${p.dir}
      </div>`
    })
    document.getElementById('m-content').innerHTML = html
    document.getElementById('detailModal').style.display = 'flex'
  }

  function showDrillDown(type, rid) {
    const room = allCourses[rid]
    const reqs = Object.values(room.shuttle?.requests || {}).filter(r => r.type !== 'car')
    let html = ""
    const groups = { osong: "ğŸš… ì˜¤ì†¡", terminal: "ğŸšŒ í„°ë¯¸ë„", airport: "âœˆï¸ ê³µí•­" }
    Object.keys(groups).forEach(k => {
      const list = reqs.filter(r => r.type === k)
      if(list.length > 0) html += `<b>${groups[k]} (${list.length})</b>: ${list.map(l => l.name).join(', ')}<br>`
    })
    document.getElementById('m-content').innerHTML = html || "ì‹ ì²­ì ì—†ìŒ"
    document.getElementById('detailModal').style.display = 'flex'
  }

  async function captureSchedule() {
    const area = document.getElementById('capture-area')
    const canvas = await html2canvas(area, { backgroundColor: "#f1f5f9", scale: 2 })
    const link = document.createElement('a'); link.download = 'ì¼ì •í‘œ.png'; link.href = canvas.toDataURL(); link.click()
  }

  function askDayOff(date) {
    const reason = prompt(`${date} ìš´í–‰ì¤‘ë‹¨ ì‚¬ìœ `, "ì°¨ëŸ‰ ì •ë¹„")
    if(reason) firebase.database().ref('system/transport_requests').push({ date, prof: 'ìš´í–‰ì¤‘ë‹¨', dir: reason, status: 'approved', time: '00:00' })
  }

  init()
</script>












</body>
</html>