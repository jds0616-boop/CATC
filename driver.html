<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>KAC ìˆ˜ì†¡ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      --kac-navy: #0f172a; 
      --kac-blue: #3b82f6; 
      --bg-fresh: #f1f5f9;
      --card-white: #ffffff;
      --osong: #2563eb; 
      --term: #f59e0b; 
      --air: #10b981;
      --accent-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; padding: 0; font-family: 'Pretendard', sans-serif;
      background: #cfd8e3; display: flex; justify-content: center; color: #1e293b;
      height: 100dvh; overflow: hidden;
    }

    .app-container { 
      width: 100%; max-width: 600px; height: 100%; 
      background: var(--bg-fresh); display: flex; flex-direction: column; 
      box-shadow: 0 0 50px rgba(0,0,0,0.2); 
    }
    
    /* ìƒë‹¨ í—¤ë” */
    .app-header { 
        height: 60px; background: var(--kac-navy); display: flex; align-items: center; 
        justify-content: space-between; padding: 0 20px; flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .header-title { color: #fff; font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }

    /* íƒ­ ë©”ë‰´ */
    .tab-container { background: var(--kac-navy); padding: 5px 15px 15px 15px; }
    .tab-bar { display: flex; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 4px; }
    .tab-btn { 
        flex: 1; border: none; background: none; color: rgba(255,255,255,0.5); 
        font-weight: 700; font-size: 15px; padding: 12px 0; border-radius: 8px; 
        cursor: pointer; transition: 0.3s;
    }
    .tab-btn.active { color: #fff; background: var(--kac-blue); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

    .app-content { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }

    /* ë°©í–¥ í† ê¸€ ë²„íŠ¼ */
    .dir-toggle-container { display: flex; gap: 10px; margin-bottom: 20px; }
    .dir-pill { 
        flex: 1; padding: 14px; border-radius: 12px; border: 2px solid #e2e8f0; 
        background: white; font-weight: 800; font-size: 14px; color: #64748b; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        transition: 0.2s;
    }
    .dir-pill.active { border-color: var(--kac-blue); color: var(--kac-blue); background: #eff6ff; }

    /* íˆì–´ë¡œ ìš”ì•½ ì¹´ë“œ */
    .hero-summary-card { 
        background: var(--accent-gradient);
        border-radius: 24px; padding: 30px 20px; text-align: center; margin-bottom: 25px;
        color: white; box-shadow: 0 10px 25px rgba(15, 23, 42, 0.2);
        position: relative; overflow: hidden;
    }
    .hero-summary-card::after {
        content: ''; position: absolute; top: -50px; right: -50px;
        width: 150px; height: 150px; background: rgba(59, 130, 246, 0.1); border-radius: 50%;
    }
    .summary-label { font-size: 13px; font-weight: 700; opacity: 0.8; margin-bottom: 8px; letter-spacing: 1px; }
    .summary-count { font-size: 55px; font-weight: 900; line-height: 1; }
    .summary-count span { font-size: 20px; margin-left: 5px; opacity: 0.7; font-weight: 500; }

    /* ëª©ì ì§€ ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ */
    .dest-card { 
        background: #fff; border-radius: 20px; margin-bottom: 15px; 
        border: 1px solid #e2e8f0; display: flex; align-items: center; 
        justify-content: space-between; padding: 22px; cursor: pointer; 
        transition: 0.2s ease;
    }
    .dest-card:active { transform: translateY(2px); background: #f8fafc; }
    .dest-info { display: flex; align-items: center; gap: 15px; font-weight: 800; font-size: 18px; color: #1e293b; }
    .dest-icon { 
        width: 48px; height: 48px; border-radius: 14px; display: flex; 
        align-items: center; justify-content: center; color: #fff; font-size: 20px; 
    }
    .osong .dest-icon { background: var(--osong); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); } 
    .term .dest-icon { background: var(--term); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); } 
    .air .dest-icon { background: var(--air); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
    .val-box { font-size: 22px; font-weight: 900; color: var(--kac-navy); display: flex; align-items: center; gap: 5px; }
    .val-box span { font-size: 14px; color: #94a3b8; font-weight: 600; }

    /* ê°•ì‚¬ì¼ì •í‘œ ê°œì„  */
    .week-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px; }
    .nav-btn { background: #fff; color: var(--kac-navy); border: 2px solid var(--kac-navy); padding: 12px; border-radius: 12px; font-weight: 800; font-size: 14px; flex: 1; cursor: pointer; transition: 0.2s; }
    .nav-btn:active { background: var(--kac-navy); color: #fff; }
    
    .schedule-table-wrapper { 
        flex: 1; background: white; border-radius: 20px; border: 1px solid #e2e8f0; 
        overflow: hidden; display: flex; flex-direction: column;
        box-shadow: 0 8px 20px rgba(0,0,0,0.05);
    }
    .schedule-table { width: 100%; height: 100%; border-collapse: collapse; table-layout: fixed; }
    .schedule-table th, .schedule-table td { border: 1px solid #f1f5f9; padding: 4px; text-align: center; vertical-align: top; }
    .schedule-table th { background: #f8fafc; color: #64748b; font-weight: 800; height: 50px; font-size: 11px; }
    .time-col { width: 60px; background: #fff !important; font-weight: 900; color: var(--kac-navy); vertical-align: middle !important; border-right: 2px solid #f1f5f9 !important; font-size: 13px; }
    
.job-box { 
        font-size: 10px; border-radius: 6px; padding: 5px 2px; margin: 2px 0; font-weight: 800; 
        text-align: center; line-height: 1.3; border: 1px solid transparent;
        cursor: pointer; transition: 0.2s;
    }
    /* ê°€ëŠ” í¸ (íŒŒë‘ê³„ì—´) */
    .job-to { background: #eff6ff; color: #1e40af; border: 1.5px solid #bfdbfe; border-left: 4px solid #2563eb; } 
    /* ì˜¤ëŠ” í¸ (ì£¼í™©ê³„ì—´) */
    .job-from { background: #fff7ed; color: #9a3412; border: 1.5px solid #fed7aa; border-left: 4px solid #f59e0b; } 
    /* ì¤‘ë³µ ì˜ˆì•½ í‘œì‹œìš© */
    .job-multi { background: #f5f3ff; color: #5b21b6; border: 1.5px solid #ddd6fe; border-left: 4px solid #7c3aed; }
    
    .job-off { background: #f1f5f9; color: #94a3b8; height: 100%; display: flex; align-items: center; justify-content: center; font-style: italic; font-weight: 700; border-radius: 8px; font-size: 11px; }



    /* í•˜ë‹¨ í‘¸í„° */
    .app-footer { 
        height: 60px; background: #fff; border-top: 1px solid #e2e8f0; color: #94a3b8; 
        display: flex; align-items: center; justify-content: space-between; padding: 0 25px; 
        font-size: 13px; font-weight: 700; flex-shrink: 0;
    }
    .footer-logo img { height: 18px; opacity: 0.8; filter: grayscale(1); }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <i class="fa-solid fa-chevron-left" style="color:#fff; cursor:pointer; font-size:22px;" onclick="location.href='potal.html'"></i>
      <div class="header-title">TRANSPORT ADMIN</div>
      <i class="fa-solid fa-rotate-right" style="color:#fff; cursor:pointer; font-size:20px;" onclick="location.reload()"></i>
    </header>

    <div class="tab-container">
        <div class="tab-bar">
            <button id="tab1" class="tab-btn active" onclick="switchTab(1)">êµìœ¡ìƒ ìˆ˜ì†¡</button>
            <button id="tab2" class="tab-btn" onclick="switchTab(2)">ê°•ì‚¬ì¼ì •í‘œ</button>
        </div>
    </div>

    <main class="app-content">
      <!-- êµìœ¡ìƒ ìˆ˜ì†¡ ë·° -->
      <div id="view-student" style="flex:1;">
          <div class="dir-toggle-container">
              <button id="dirBtnOut" class="dir-pill active" onclick="setStudentDir('out')"><i class="fa-solid fa-bus"></i> í‡´êµ (ì¶œë°œ)</button>
              <button id="dirBtnIn" class="dir-pill" onclick="setStudentDir('in')"><i class="fa-solid fa-house-user"></i> ì…êµ (ë„ì°©)</button>
          </div>

<!-- [ì‹ ê·œ] ì´ë²ˆ ì£¼ êµìœ¡ìƒ ëŒ€í˜• ìˆ˜ì†¡ ì„¤ì • ê´€ë¦¬ -->
          <div style="background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1.5px solid #e2e8f0; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
              <div style="font-size: 13px; font-weight: 800; color: var(--kac-navy); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                  <i class="fa-solid fa-calendar-check" style="color: var(--kac-blue);"></i> ì´ë²ˆ ì£¼ êµìœ¡ìƒ ìˆ˜ì†¡ ì¼ì • ì„ í¬
              </div>
              
              <div style="display: flex; flex-direction: column; gap: 10px;">
                  <!-- ì›”ìš”ì¼ ì…êµ -->
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #f8fafc; border-radius: 12px;">
                      <div>
                          <span style="font-size: 13px; font-weight: 800;">ì›”ìš”ì¼ ì…êµ ìˆ˜ì†¡</span>
                          <div style="font-size: 10px; color: #94a3b8; font-weight: 600;">09:00 / 10:20 / 10:50</div>
                      </div>
                      <button id="fixed-mon" class="nav-btn" style="flex:none; width: 80px; padding: 8px; font-size: 11px;" onclick="toggleFixedSlot('monday_entrance')">ìš´í–‰ì•ˆí•¨</button>
                  </div>

                  <!-- ê¸ˆìš”ì¼ í‡´êµ 1ì°¨ -->
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #f8fafc; border-radius: 12px;">
                      <div>
                          <span style="font-size: 13px; font-weight: 800;">ê¸ˆìš”ì¼ í‡´êµ <b style="color:var(--osong);">1ì°¨</b></span>
                          <div style="font-size: 10px; color: #94a3b8; font-weight: 600;">13:00 ì¶œë°œ (í•­ê¸°ì› ë°œ)</div>
                      </div>
                      <button id="fixed-fri1" class="nav-btn" style="flex:none; width: 80px; padding: 8px; font-size: 11px;" onclick="toggleFixedSlot('friday_wave1')">ìš´í–‰ì•ˆí•¨</button>
                  </div>

                  <!-- ê¸ˆìš”ì¼ í‡´êµ 2ì°¨ -->
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #f8fafc; border-radius: 12px;">
                      <div>
                          <span style="font-size: 13px; font-weight: 800;">ê¸ˆìš”ì¼ í‡´êµ <b style="color:var(--term);">2ì°¨</b></span>
                          <div style="font-size: 10px; color: #94a3b8; font-weight: 600;">15:00 ì¶œë°œ (í•­ê¸°ì› ë°œ)</div>
                      </div>
                      <button id="fixed-fri2" class="nav-btn" style="flex:none; width: 80px; padding: 8px; font-size: 11px;" onclick="toggleFixedSlot('friday_wave2')">ìš´í–‰ì•ˆí•¨</button>
                  </div>
              </div>
<p style="font-size: 10px; color: #ef4444; margin: 12px 0 10px 5px; font-weight: 700;">â€» ìš´í–‰í•¨ìœ¼ë¡œ ì„¤ì • ì‹œ êµìœ¡ìƒ ì•±ì—ì„œ ì‹ ì²­ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</p>
              
              <!-- [ì‹ ê·œ] ê¸°ì‚¬ë‹˜ í•œ ì¤„ ê³µì§€ ì‘ì„± -->
              <div style="border-top: 1px dashed #cbd5e1; pt: 15px; margin-top: 5px; padding-top: 10px;">
                  <span style="font-size: 11px; font-weight: 800; color: #64748b; margin-bottom: 8px; display: block;">ğŸ“¢ ìˆ˜ì†¡ ê´€ë ¨ ê³µì§€ì‚¬í•­ (ì „ í”Œë«í¼ ì†¡ì¶œ)</span>
                  <div style="display: flex; gap: 8px;">
                      <input type="text" id="shuttleNoticeInput" class="navy-select" style="flex:1; height: 35px; font-size: 12px;" placeholder="ì˜ˆ: ì´ë²ˆ ì£¼ëŠ” ëˆˆ ì˜ˆë³´ë¡œ 10ë¶„ ì¡°ê¸° ì¶œë°œí•©ë‹ˆë‹¤.">
                      <button class="nav-btn" style="flex:none; width: 60px; padding: 0; height: 35px; font-size: 11px; background: var(--kac-navy); color:white;" onclick="saveShuttleNotice()">ì €ì¥</button>
                  </div>
              </div>
          </div>





          <div class="hero-summary-card">
              <div class="summary-label" id="summary-title">ê¸ˆì¼ í‡´êµ ìˆ˜ì†¡ ì´ì›</div>
              <div class="summary-count" id="total-all">0<span>ëª…</span></div>
          </div>
          <div id="student-list-container"></div>
      </div>

      <!-- ê°•ì‚¬ ìˆ˜ì†¡ ë·° -->
      <div id="view-teacher" style="display:none; flex:1; flex-direction:column;">
          <div class="week-nav">
              <button class="nav-btn" onclick="changeWeek(-7)"><i class="fa-solid fa-chevron-left"></i> ì´ì „ ì£¼</button>
              <button class="nav-btn" onclick="changeWeek(7)">ë‹¤ìŒ ì£¼ <i class="fa-solid fa-chevron-right"></i></button>
          </div>
          <div class="schedule-table-wrapper">
              <table class="schedule-table">
                  <thead><tr id="table-header-days"><th class="time-col">ì‹œê°„</th></tr></thead>
                  <tbody id="schedule-body"></tbody>
              </table>
          </div>
      </div>
    </main>

    <footer class="app-footer">
      <div id="footer-time"><i class="fa-regular fa-clock"></i> 00:00</div>
      <div class="footer-logo"><img src="logo.png" alt="KAC"></div>
    </footer>

    <!-- ìƒì„¸ ëª…ë‹¨ ëª¨ë‹¬ -->
    <div id="listModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:5000; align-items:center; justify-content:center; padding:20px; backdrop-filter: blur(4px);">
        <div style="background:white; width:100%; max-width:420px; border-radius:28px; overflow:hidden; display:flex; flex-direction:column; max-height:80vh; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
            <div style="background:var(--kac-navy); color:white; padding:22px; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="listModalTitle" style="margin:0; font-size:18px; font-weight:800;">ìƒì„¸ ëª…ë‹¨</h3>
                <i class="fa-solid fa-xmark" style="cursor:pointer; font-size:22px;" onclick="closeListModal()"></i>
            </div>
            <div id="listModalContent" style="padding:25px; overflow-y:auto; font-size:16px; line-height:1.6; color:#334155;"></div>
            <div style="padding:15px; background:#f8fafc;">
                <button style="width:100%; padding:16px; border:none; border-radius:16px; background:var(--bg-fresh); font-weight:800; font-size:16px; color:var(--kac-navy); cursor:pointer;" onclick="closeListModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    let currentBaseDate = new Date();
    let transportRequests = {}; let driverOffSlots = {};
    let shuttleSettings = { monday_entrance: false, friday_wave1: false, friday_wave2: false };
    let studentDirection = 'out';

    if(sessionStorage.getItem('kac_portal_auth') !== 'driver') {
        alert("ì¸ì¦ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."); location.replace('potal.html');
    }

    function switchTab(num) {
        document.getElementById('view-student').style.display = (num === 1) ? 'block' : 'none';
        document.getElementById('view-teacher').style.display = (num === 2) ? 'flex' : 'none';
        document.getElementById('tab1').classList.toggle('active', num === 1);
        document.getElementById('tab2').classList.toggle('active', num === 2);
        if(num === 2) renderWeeklySchedule();
    }

    function setStudentDir(dir) {
        studentDirection = dir;
        document.getElementById('dirBtnOut').classList.toggle('active', dir === 'out');
        document.getElementById('dirBtnIn').classList.toggle('active', dir === 'in');
        document.getElementById('summary-title').innerText = (dir === 'out') ? "ê¸ˆì¼ í‡´êµ ìˆ˜ì†¡ ì´ì›" : "ê¸ˆì¼ ì…êµ ìˆ˜ì†¡ ì´ì›";
        initStudentTransport();
    }

    function initStudentTransport() {
        firebase.database().ref('courses').on('value', snap => {
            const data = snap.val() || {};
            const totals = { osong: 0, terminal: 0, airport: 0 };
            const details = { osong: [], terminal: [], airport: [] };

            Object.keys(data).forEach(rid => {
                const room = data[rid];
                const cName = room.settings?.courseName || `Room ${rid} ê³¼ì •`;
                const shuttle = room.shuttle ? room.shuttle[studentDirection] : null;
                if(shuttle) {
                    ['osong', 'terminal', 'airport'].forEach(loc => {
                        if(shuttle[loc]) {
                            const names = Object.values(shuttle[loc]);
                            totals[loc] += names.length;
                            if(names.length > 0) details[loc].push({ title: cName, names });
                        }
                    });
                }
            });

            document.getElementById('total-all').innerHTML = `${totals.osong + totals.terminal + totals.airport}<span>ëª…</span>`;
            const container = document.getElementById('student-list-container'); container.innerHTML = "";
            const locInfo = [{id:'osong', name:'ì˜¤ì†¡ì—­', icon:'fa-train'}, {id:'terminal', name:'ì²­ì£¼í„°ë¯¸ë„', icon:'fa-bus'}, {id:'airport', name:'ì²­ì£¼ê³µí•­', icon:'fa-plane-up'}];

            locInfo.forEach(loc => {
                const card = document.createElement('div'); card.className = `dest-card ${loc.id.substring(0,3)}`;
                card.innerHTML = `<div class="dest-info"><div class="dest-icon"><i class="fa-solid ${loc.icon}"></i></div>${loc.name}</div>
                    <div class="val-box">${totals[loc.id]}<span>ëª…</span><i class="fa-solid fa-chevron-right" style="font-size:14px; margin-left:8px; color:#cbd5e1;"></i></div>`;
                card.onclick = () => showStudentDetail(loc.name, details[loc.id]);
                container.appendChild(card);
            });
        });
    }

    function showStudentDetail(title, data) {
        if(data.length === 0) return;
        const modal = document.getElementById('listModal');
        const content = document.getElementById('listModalContent');
        document.getElementById('listModalTitle').innerText = title + " ìƒì„¸ ëª…ë‹¨";
        content.innerHTML = data.map(item => `
            <div style="margin-bottom:20px; border-bottom:1px solid #f1f5f9; padding-bottom:15px;">
                <div style="font-weight:800; color:var(--kac-blue); margin-bottom:6px; font-size:14px;">${item.title}</div>
                <div style="font-weight:700; color:#1e293b; font-size:16px;">${item.names.join(', ')}</div>
            </div>`).join('');
        modal.style.display = 'flex';
    }

    function closeListModal() { document.getElementById('listModal').style.display = 'none'; }



function showInstructorDetail(date, hour, requests) {
        const modal = document.getElementById('listModal');
        const title = document.getElementById('listModalTitle');
        const content = document.getElementById('listModalContent');

        title.innerText = `${date} ${hour}:00 ê°•ì‚¬ ìˆ˜ì†¡ í˜„í™©`;
        
        let html = "";
        requests.forEach((req, idx) => {
            const isTo = req.dir.includes('â†’í•­ê¸°ì›');
            const typeTag = isTo ? `<span style="color:#2563eb;">[ì…ê³ ]</span>` : `<span style="color:#f59e0b;">[í‡´ê³ ]</span>`;
            
            html += `
                <div style="margin-bottom:15px; border-bottom:1px solid #f1f5f9; padding-bottom:12px;">
                    <div style="font-weight:900; font-size:16px; margin-bottom:5px;">${idx+1}. ${req.prof} ê°•ì‚¬ë‹˜</div>
                    <div style="font-size:14px; color:#475569; margin-bottom:4px;">${typeTag} ${req.dir}</div>
                    <div style="font-size:14px; color:#1e293b; font-weight:700;">
                        <i class="fa-solid fa-phone"></i> ì—°ë½ì²˜: ${req.phone || 'ë“±ë¡ë˜ì§€ ì•ŠìŒ'}
                    </div>
                    <div style="font-size:12px; color:#94a3b8; margin-top:4px;">ì˜ˆì•½ì‹œê°„: ${req.time}</div>
                </div>
            `;
        });
        
        content.innerHTML = html;
        modal.style.display = 'flex';
    }




function showStudentWaveDetail(direction, title) {
        const modal = document.getElementById('listModal');
        const modalTitle = document.getElementById('listModalTitle');
        const content = document.getElementById('listModalContent');

        modalTitle.innerText = title;
        content.innerHTML = "<div style='text-align:center; padding:20px;'>ì „ì²´ ì¸ì›ì„ ì§‘ê³„ ì¤‘ì…ë‹ˆë‹¤...</div>";
        modal.style.display = 'flex';

        // ëª¨ë“  ê°•ì˜ì‹¤(courses) ë°ì´í„°ë¥¼ í•©ì‚°í•˜ì—¬ í†µê³„ ìƒì„±
        firebase.database().ref('courses').once('value', snap => {
            const data = snap.val() || {};
            const stats = { osong: [], terminal: [], airport: [] };

            Object.keys(data).forEach(rid => {
                const room = data[rid];
                const shuttle = room.shuttle ? room.shuttle[direction] : null;
                if(shuttle) {
                    if(shuttle.osong) stats.osong.push(...Object.values(shuttle.osong));
                    if(shuttle.terminal) stats.terminal.push(...Object.values(shuttle.terminal));
                    if(shuttle.airport) stats.airport.push(...Object.values(shuttle.airport));
                }
            });

            const totalCount = stats.osong.length + stats.terminal.length + stats.airport.length;
            
            content.innerHTML = `
                <div style="background:#f8fafc; padding:15px; border-radius:15px; margin-bottom:20px; text-align:center; border:1px solid #e2e8f0;">
                    <div style="font-size:12px; color:#64748b; font-weight:800; margin-bottom:5px;">ì „ì²´ ê³¼ì • í•©ì‚° ì¸ì›</div>
                    <div style="font-size:32px; font-weight:900; color:var(--kac-blue);">${totalCount}<small style="font-size:16px; color:#1e293b; margin-left:3px;">ëª…</small></div>
                </div>
                <div style="display:flex; flex-direction:column; gap:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b style="font-size:16px;"><i class="fa-solid fa-train" style="color:var(--osong);"></i> ì˜¤ì†¡ì—­</b>
                        <span style="font-weight:900; font-size:18px;">${stats.osong.length}ëª…</span>
                    </div>
                    <div style="font-size:13px; color:#64748b; padding-left:25px; margin-bottom:5px;">${stats.osong.join(', ') || 'ì‹ ì²­ì ì—†ìŒ'}</div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b style="font-size:16px;"><i class="fa-solid fa-bus" style="color:var(--term);"></i> í„°ë¯¸ë„</b>
                        <span style="font-weight:900; font-size:18px;">${stats.terminal.length}ëª…</span>
                    </div>
                    <div style="font-size:13px; color:#64748b; padding-left:25px; margin-bottom:5px;">${stats.terminal.join(', ') || 'ì‹ ì²­ì ì—†ìŒ'}</div>

                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b style="font-size:16px;"><i class="fa-solid fa-plane-up" style="color:var(--air);"></i> ì²­ì£¼ê³µí•­</b>
                        <span style="font-weight:900; font-size:18px;">${stats.airport.length}ëª…</span>
                    </div>
                    <div style="font-size:13px; color:#64748b; padding-left:25px;">${stats.airport.join(', ') || 'ì‹ ì²­ì ì—†ìŒ'}</div>
                </div>
            `;
        });
    }











function renderWeeklySchedule() {
        const sunday = new Date(currentBaseDate); sunday.setDate(currentBaseDate.getDate() - currentBaseDate.getDay());
        const days = []; for(let i=0; i<6; i++) { const d = new Date(sunday); d.setDate(sunday.getDate() + i); days.push(d); }
        const headerRow = document.getElementById('table-header-days');
        headerRow.innerHTML = '<th class="time-col">ì‹œê°„</th>';
        const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'];
        days.forEach((d, i) => { headerRow.innerHTML += `<th>${d.getMonth()+1}/${d.getDate()}<br>${dayNames[i]}</th>`; });

        const body = document.getElementById('schedule-body'); body.innerHTML = "";
        for(let h=8; h<=18; h++) {
            const row = document.createElement('tr'); row.innerHTML = `<td class="time-col">${h}:00</td>`;
            days.forEach((d, dayIdx) => {
                const dateKey = getTodayString(d); const td = document.createElement('td');
                const dayNum = d.getDay(); // 1:ì›”, 5:ê¸ˆ

                // 1. ì›”ìš”ì¼ ì˜¤ì „ êµìœ¡ìƒ ì…êµ ìˆ˜ì†¡ ë¸”ë¡ (ë“œë¼ì´ë²„ ì„¤ì • ê¸°ë°˜)
                if (dayNum === 1 && (h === 9 || h === 10) && shuttleSettings.monday_entrance) {
                    td.onclick = () => showStudentWaveDetail('in', 'ì›”ìš”ì¼ ì…êµ í†µí•© ìˆ˜ì†¡');
                    td.innerHTML = `<div class="job-box" style="background:#fef9c3; color:#854d0e; border:1.5px solid #fde047; height:100%; display:flex; align-items:center; justify-content:center;">ì…êµìˆ˜ì†¡<br>ì¸ì›í™•ì¸ ></div>`;
                } 
                // 2. ê¸ˆìš”ì¼ ì˜¤í›„ êµìœ¡ìƒ í‡´êµ ìˆ˜ì†¡ ë¸”ë¡ (1ì°¨ 13ì‹œ, 2ì°¨ 15ì‹œ)
                else if (dayNum === 5 && h === 13 && shuttleSettings.friday_wave1) {
                    td.onclick = () => showStudentWaveDetail('out', 'ê¸ˆìš”ì¼ í‡´êµ 1ì°¨(13ì‹œ) í†µí•©ìˆ˜ì†¡');
                    td.innerHTML = `<div class="job-box" style="background:#dcfce7; color:#166534; border:1.5px solid #86efac; height:100%; display:flex; align-items:center; justify-content:center;">í‡´êµ 1ì°¨<br>ì¸ì›í™•ì¸ ></div>`;
                }
                else if (dayNum === 5 && h === 15 && shuttleSettings.friday_wave2) {
                    td.onclick = () => showStudentWaveDetail('out', 'ê¸ˆìš”ì¼ í‡´êµ 2ì°¨(15ì‹œ) í†µí•©ìˆ˜ì†¡');
                    td.innerHTML = `<div class="job-box" style="background:#dcfce7; color:#166534; border:1.5px solid #86efac; height:100%; display:flex; align-items:center; justify-content:center;">í‡´êµ 2ì°¨<br>ì¸ì›í™•ì¸ ></div>`;
                }
                // 3. ì ì‹¬ ì‹œê°„
                else if(h === 12) { 
                    td.innerHTML = '<div class="job-off">ì ì‹¬</div>'; 
                } 
                // 4. ì¼ë°˜ ê°•ì‚¬ ìˆ˜ì†¡ ì˜ˆì•½ ê±´
                else {
                    const dayReqs = Object.values(transportRequests).filter(r => r.date === dateKey && parseInt(r.time.split(':')[0]) === h);
                    if(driverOffSlots[dateKey] && driverOffSlots[dateKey][h]) { 
                        td.innerHTML = `<div class="job-off" onclick="toggleDriverOff('${dateKey}', ${h})">${driverOffSlots[dateKey][h]}</div>`; 
                    } else if (dayReqs.length > 0) {
                        // í´ë¦­ ì‹œ ìƒì„¸ ëª…ë‹¨ íŒì—… í˜¸ì¶œ
                        td.onclick = () => showInstructorDetail(dateKey, h, dayReqs);
                        
                        if (dayReqs.length === 1) {
                            const req = dayReqs[0];
                            const isTo = req.dir.includes('â†’í•­ê¸°ì›');
                            // ì§ê´€ì ì¸ ê²½ë¡œ ë¼ë²¨ ìƒì„± (ì˜ˆ: ì˜¤ì†¡ > í•­ê¸°ì›)
                            const pathLabel = req.dir.replace('â†’', ' > ').replace('ì²­ì£¼', '');
                            td.innerHTML = `<div class="job-box ${isTo?'job-to':'job-from'}">${pathLabel}<br>${req.prof}</div>`;
                        } else {
                            // ì¤‘ë³µ ì˜ˆì•½ ì‹œ ë³´ë¼ìƒ‰ ë¸”ë¡ìœ¼ë¡œ í‘œì‹œ
                            td.innerHTML = `<div class="job-box job-multi">ê°•ì‚¬ìˆ˜ì†¡<br>${dayReqs.length}ê±´ í™•ì¸ ></div>`;
                        }
                    } else {
                        // ë¹ˆ ì¹¸ í´ë¦­ ì‹œ ìš´í–‰ë¶ˆê°€(íœ´ë¬´ ë“±) ì„¤ì • ê°€ëŠ¥
                        td.onclick = () => toggleDriverOff(dateKey, h);
                    }
                }
                row.appendChild(td);
            });
            body.appendChild(row);
        }
    }


function toggleFixedSlot(key) {
        const newValue = !shuttleSettings[key];
        firebase.database().ref('system/shuttle_settings').child(key).set(newValue);
    }

    function updateFixedScheduleUI() {
        const btnMon = document.getElementById('fixed-mon');
        const btnFri1 = document.getElementById('fixed-fri1');
        const btnFri2 = document.getElementById('fixed-fri2');

        const styleActive = (el, active) => {
            el.innerText = active ? "ìš´í–‰í•¨" : "ìš´í–‰ì•ˆí•¨";
            el.style.background = active ? "var(--kac-blue)" : "#fff";
            el.style.color = active ? "#fff" : "var(--kac-navy)";
            el.style.borderColor = active ? "var(--kac-blue)" : "var(--kac-navy)";
        };

        if(btnMon) styleActive(btnMon, shuttleSettings.monday_entrance);
        if(btnFri1) styleActive(btnFri1, shuttleSettings.friday_wave1);
        if(btnFri2) styleActive(btnFri2, shuttleSettings.friday_wave2);
    }



function saveShuttleNotice() {
        const msg = document.getElementById('shuttleNoticeInput').value.trim();
        firebase.database().ref('system/shuttle_notice').set(msg).then(() => {
            alert("âœ… ê³µì§€ì‚¬í•­ì´ ì „ í”Œë«í¼(êµìœ¡ìƒ/ê°•ì‚¬)ì— ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
    }

    // ì´ˆê¸° ë¡œë“œ ì‹œ ê¸°ì¡´ ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸°
    firebase.database().ref('system/shuttle_notice').on('value', s => {
        const input = document.getElementById('shuttleNoticeInput');
        if(input && !input.matches(':focus')) input.value = s.val() || "";
    });















    function changeWeek(days) { currentBaseDate.setDate(currentBaseDate.getDate() + days); renderWeeklySchedule(); }
    function toggleDriverOff(date, hour) {
        const current = (driverOffSlots[date] && driverOffSlots[date][hour]) ? driverOffSlots[date][hour] : null;
        if(current) { if(confirm("í•´ë‹¹ ì‹œê°„ ìš´í–‰ ë¶ˆê°€ ì„¤ì •ì„ í•´ì œí• ê¹Œìš”?")) firebase.database().ref(`system/driver_status/${date}/${hour}`).remove(); }
        else { const reason = prompt("ìš´í–‰ ë¶ˆê°€ ì‚¬ìœ  ì…ë ¥(ì˜ˆ: ì°¨ëŸ‰ì •ë¹„, íœ´ë¬´ ë“±)"); if(reason) firebase.database().ref(`system/driver_status/${date}/${hour}`).set(reason); }
    }
    function getTodayString(d = new Date()) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function runClock() { const now = new Date(); document.getElementById('footer-time').innerHTML = `<i class="fa-regular fa-clock"></i> ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`; }
    
    initStudentTransport();
    firebase.database().ref('system/transport_requests').on('value', s => { transportRequests = s.val() || {}; if(document.getElementById('view-teacher').style.display === 'flex') renderWeeklySchedule(); });
    firebase.database().ref('system/driver_status').on('value', s => { driverOffSlots = s.val() || {}; if(document.getElementById('view-teacher').style.display === 'flex') renderWeeklySchedule(); });
    firebase.database().ref('system/shuttle_settings').on('value', s => {
        shuttleSettings = { ...shuttleSettings, ...s.val() };
        updateFixedScheduleUI();
        if(document.getElementById('view-teacher').style.display === 'flex') renderWeeklySchedule();
    });
    setInterval(runClock, 1000); runClock();
  </script>
</body>
</html>