<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>항공기술훈련원 차량지원 시스템</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root {
      --primary: #3b82f6; --primary-dark: #1d4ed8;
      --navy: #0f172a; --slate: #1e293b; --light-slate: #94a3b8;
      --bg: #f1f5f9; --card: #ffffff; --border: #e2e8f0;
      --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
    body { margin: 0; padding: 0; background: #cbd5e1; display: flex; justify-content: center; height: 100dvh; overflow: hidden; color: var(--navy); }
    
    .app-container { width: 100%; max-width: 600px; height: 100%; background: var(--bg); display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.15); position: relative; }
    
    /* 상단바 */
    .app-header { height: 65px; background: var(--navy); display: flex; align-items: center; justify-content: center; padding: 0 20px; color: #fff; border-bottom: 3px solid var(--primary); flex-shrink: 0; }
    .header-title { font-size: 18px; font-weight: 900; letter-spacing: -0.5px; }

    /* 탭 메뉴 */
    .tab-bar { display: flex; background: #1e293b; padding: 8px 12px; gap: 6px; flex-shrink: 0; }
    .tab-btn { flex: 1; padding: 12px 5px; border-radius: 12px; border: none; background: transparent; color: rgba(255,255,255,0.4); font-weight: 800; cursor: pointer; font-size: 13px; transition: all 0.3s ease; white-space: nowrap; }
    .tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }

    .app-content { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; }

    /* 통계 요약 */
    .stat-card { 
      background: linear-gradient(135deg, #0f172a, #1e293b); 
      border-radius: 24px; padding: 24px; color: white; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .stat-item { text-align: center; }
    .stat-item span { font-size: 10px; font-weight: 700; color: var(--light-slate); display: block; margin-bottom: 4px; }
    .stat-item b { font-size: 24px; font-weight: 900; color: #fff; }

    /* 리스트 카드 */
    .modern-card { background: var(--card); border-radius: 22px; padding: 20px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
    .course-card { border-left: 8px solid var(--primary); }
    .course-name { font-weight: 900; font-size: 16px; color: var(--navy); margin-bottom: 12px; }
    
    .btn-group { display: flex; gap: 8px; }
    .action-btn { flex: 1; height: 48px; border-radius: 12px; border: 1.5px solid var(--border); background: #fff; font-size: 14px; font-weight: 800; color: var(--slate); cursor: pointer; transition: 0.2s; }
    .action-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .action-btn.manual { background: var(--navy); color: #fff; border: none; flex: 0.5; }

    .status-badge { margin-top: 12px; padding: 10px; border-radius: 10px; background: #f8fafc; font-size: 12px; font-weight: 800; text-align: center; color: var(--light-slate); border: 1px solid var(--border); }
    .status-badge.on { background: #ecfdf4; color: var(--success); border-color: #bbf7d0; }

    /* 강사 티켓 */
    .ticket { background: #fff; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 12px; overflow: hidden; }
    .ticket-head { background: var(--navy); color: #fff; padding: 12px 18px; display: flex; justify-content: space-between; align-items: center; }
    .ticket-body { padding: 16px 18px; display: flex; justify-content: space-between; align-items: center; }
    .ticket-time { font-size: 20px; font-weight: 900; color: var(--primary); }
    .call-btn { width: 44px; height: 44px; border-radius: 50%; background: #ecfdf5; color: var(--success); border: none; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; }
    .del-btn { width: 44px; height: 44px; border-radius: 50%; background: #fef2f2; color: var(--danger); border: none; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; }

    /* 일정표 */
    .sched-nav { display: flex; align-items: center; justify-content: center; gap: 20px; padding: 10px; background: #fff; border-radius: 15px; border: 1px solid var(--border); }
    .nav-arrow { font-size: 22px; color: var(--primary); cursor: pointer; }
    .table-container { background: #fff; border-radius: 16px; border: 2px solid var(--navy); overflow: hidden; }
    .modern-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .modern-table th, .modern-table td { border: 1px solid #e2e8f0; text-align: center; font-size: 10px; vertical-align: middle; padding: 4px; height: 60px; line-height: 1.2; }
    .modern-table th { background: #f8fafc; color: var(--navy); font-weight: 900; height: 45px; cursor: pointer; }
    .t-col { background: #f8fafc !important; font-weight: 900; width: 45px; }
    
    .event-block { height: 100%; width: 100%; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; font-weight: 800; cursor: pointer; }
    .event-teacher { background: #eff6ff; color: #1d4ed8; }
    .event-shuttle { background: #ecfdf5; color: #065f46; border-left: 4px solid var(--success); }
    .event-lunch { color: #cbd5e1; font-style: italic; background: #fcfdfe; }

    /* 푸터 */
    .app-footer { height: 65px; background: var(--navy); border-top: 3px solid var(--primary); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; color: #fff; flex-shrink: 0; }
    #footer-clock { font-size: 20px; font-weight: 900; font-family: monospace; }

    /* 팝업 */
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.85); z-index: 9000; align-items: center; justify-content: center; padding: 24px; backdrop-filter: blur(8px); }
    .pop-card { background: #fff; border-radius: 30px; width: 100%; max-width: 400px; padding: 30px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
    .pop-btn { width: 100%; height: 55px; border-radius: 16px; border: none; background: var(--primary); color: #fff; font-size: 16px; font-weight: 900; cursor: pointer; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div class="header-title">항공기술훈련원 차량지원 시스템</div>
    </header>

    <div class="tab-bar">
      <button id="tab-1" class="tab-btn active" onclick="setTab(1)">교육생 퇴교 관리</button>
      <button id="tab-2" class="tab-btn" onclick="setTab(2)">강사 수송 리스트</button>
      <button id="tab-3" class="tab-btn" onclick="setTab(3)">종합 일정표</button>
    </div>

    <main class="app-content">
      <!-- 탭 1: 퇴교 관리 -->
      <div id="view-1">
          <div class="stat-card">
              <div class="stat-item"><span>오송역</span><b id="h-osong">0</b></div>
              <div class="stat-item"><span>터미널</span><b id="h-term">0</b></div>
              <div class="stat-item"><span>공항</span><b id="h-air">0</b></div>
              <div style="width:1px; height:30px; background:rgba(255,255,255,0.1)"></div>
              <div class="stat-item"><span>총원</span><b id="h-total" style="color:var(--warning);">0</b></div>
          </div>
          <div id="course-container" style="margin-top:15px;"></div>
      </div>

      <!-- 탭 2: 강사 리스트 -->
      <div id="view-2" style="display:none;">
          <div class="sched-nav">
              <i class="fa-solid fa-circle-chevron-left nav-arrow" onclick="changeWeek(-1)"></i>
              <b id="list-week-label" style="font-size:15px;">조회 중...</b>
              <i class="fa-solid fa-circle-chevron-right nav-arrow" onclick="changeWeek(1)"></i>
          </div>
          <div id="instructor-list" style="margin-top:15px;"></div>
      </div>

      <!-- 탭 3: 종합 일정 -->
      <div id="view-3" style="display:none;">
          <div class="sched-nav" style="margin-bottom:12px;">
              <i class="fa-solid fa-circle-chevron-left nav-arrow" onclick="changeWeek(-1)"></i>
              <b id="sched-week-label" style="font-size:15px;">조회 중...</b>
              <i class="fa-solid fa-circle-chevron-right nav-arrow" onclick="changeWeek(1)"></i>
          </div>
          <div class="table-container">
            <table class="modern-table">
              <thead><tr id="sched-header"></tr></thead>
              <tbody id="sched-body"></tbody>
            </table>
          </div>
      </div>
    </main>

    <footer class="app-footer">
      <div id="footer-clock" style="font-size:18px; font-weight:900;">00:00:00</div>
      <img src="logo.png" alt="Logo" style="height:22px; filter:brightness(0) invert(1);">
    </footer>
  </div>

  <!-- [상세 팝업] -->
  <div id="detailPop" class="overlay" onclick="if(event.target==this) this.style.display='none'">
      <div class="pop-card">
          <div style="text-align:center; margin-bottom:25px;">
              <span id="pop-cat" style="font-size:11px; font-weight:900; color:var(--primary); background:#eff6ff; padding:4px 12px; border-radius:50px;">수송 정보</span>
              <h2 id="pop-loc" style="margin:10px 0 5px 0; font-size:28px; font-weight:900;">오송역</h2>
              <div id="pop-time" style="font-size:22px; font-weight:800; color:var(--primary);">13:00</div>
          </div>
          <div style="background:#f8fafc; border-radius:20px; padding:20px; border:1px solid var(--border); display:flex; flex-direction:column; gap:12px;">
              <div style="display:flex; justify-content:space-between;"><span style="color:var(--light-slate); font-weight:700;">날짜</span><b id="pop-date"></b></div>
              <div style="display:flex; justify-content:space-between;"><span style="color:var(--light-slate); font-weight:700;">수송 대상</span><b id="pop-target"></b></div>
              <div style="display:flex; justify-content:space-between;"><span style="color:var(--light-slate); font-weight:700;">비상 연락처</span><b id="pop-phone" style="color:var(--primary);"></b></div>
          </div>
          <button id="callBtn" class="pop-btn" style="background:var(--success); margin-top:25px;"><i class="fa-solid fa-phone"></i> 전화 연결하기</button>
          <button class="pop-btn" style="background:var(--light-slate);" onclick="document.getElementById('detailPop').style.display='none'">닫기</button>
      </div>
  </div>

  <!-- [운행 불가 설정 팝업] -->
  <div id="dayOffPop" class="overlay" onclick="if(event.target==this) this.style.display='none'">
      <div class="pop-card">
          <h3 id="off-title" style="margin-top:0; font-weight:900; font-size:20px;">요일 운행 설정</h3>
          <p style="color:var(--light-slate); font-size:14px; line-height:1.6;">해당 요일의 운행을 중단하시겠습니까?<br><span style="color:var(--danger); font-weight:800;">(중단 시 모든 예약이 자동 취소됩니다.)</span></p>
          <textarea id="off-reason" style="width:100%; height:80px; border-radius:12px; border:1px solid var(--border); padding:12px; font-weight:700; margin:10px 0;" placeholder="중단 사유 입력 (예: 차량 점검)"></textarea>
          <div style="display:flex; gap:10px;">
              <button class="pop-btn" style="flex:1; background:var(--light-slate);" onclick="document.getElementById('dayOffPop').style.display='none'">취소</button>
              <button class="pop-btn" style="flex:2; background:var(--danger); margin-top:10px;" onclick="confirmDayOff()">운행 중단 확정</button>
          </div>
      </div>
  </div>

  <script src="config.js"></script>
  <script>
    let allCourses = {};
    let teacherRequests = [];
    let weekOffset = 0;
    let currentTab = 1;
    let offTargetDate = "";
    const TRAVEL_TIME = 40; // 편도 운행시간

    function init() {
      // 1. 강사 수송 데이터 로드
      firebase.database().ref('system/transport_requests').on('value', snap => {
        const raw = snap.val() || {};
        teacherRequests = Object.keys(raw).map(k => ({ id: k, ...raw[k] }));
        renderAll();
      });

      // 2. 교육과정 데이터 로드
      firebase.database().ref('courses').on('value', snap => {
        allCourses = snap.val() || {};
        renderAll();
      });

      setInterval(updateClock, 1000);
    }

    function renderAll() {
        if(currentTab === 1) renderTab1();
        if(currentTab === 2) renderTab2();
        if(currentTab === 3) renderTab3();
    }

    // --- 탭 1: 퇴교 관리 ---
    function renderTab1() {
        let stats = { o:0, t:0, a:0, sum:0 };
        const container = document.getElementById('course-container');
        container.innerHTML = "";
        
        const activeRids = Object.keys(allCourses).filter(rid => allCourses[rid].status?.roomStatus === 'active');
        activeRids.forEach(rid => {
            const room = allCourses[rid];
            const dep = room.shuttle?.departure || { time: "" };
            const reqs = room.shuttle?.requests ? Object.values(room.shuttle.requests) : [];
            
            stats.o += reqs.filter(r => r.type === 'osong').length;
            stats.t += reqs.filter(r => r.type === 'terminal').length;
            stats.a += reqs.filter(r => r.type === 'airport').length;
            stats.sum += reqs.length;

            const card = document.createElement('div');
            card.className = "modern-card course-card";
            card.innerHTML = `
                <div class="course-name">#${rid} ${room.settings?.courseName || rid}</div>
                <div style="display:flex; gap:12px; font-size:11px; font-weight:800; margin-bottom:15px;">
                    <span style="color:var(--osong)">오송 ${reqs.filter(r=>r.type==='osong').length}</span>
                    <span style="color:var(--term)">터미널 ${reqs.filter(r=>r.type==='terminal').length}</span>
                    <span style="color:var(--air)">공항 ${reqs.filter(r=>r.type==='airport').length}</span>
                </div>
                <div class="btn-group">
                    <button class="action-btn ${dep.time==='13:00'?'active':''}" onclick="setDepConfirm('${rid}','13:00')">13:00</button>
                    <button class="action-btn ${dep.time==='15:00'?'active':''}" onclick="setDepConfirm('${rid}','15:00')">15:00</button>
                    <button class="action-btn manual" onclick="toggleManual('${rid}')">수동</button>
                </div>
                <div class="status-badge ${dep.time?'active':''}">
                    ${dep.time ? `현재 [${dep.time}] 운행 공지 중` : '시간을 선택하여 공지하세요.'}
                </div>
                <div id="manual-${rid}" style="display:none; margin-top:10px;">
                    <input type="time" id="val-${rid}" style="width:100%; height:45px; border-radius:12px; border:2.5px solid var(--navy); text-align:center; font-weight:900;" onchange="setDepConfirm('${rid}', this.value)">
                </div>`;
            container.appendChild(card);
        });
        document.getElementById('h-osong').innerText = stats.o;
        document.getElementById('h-term').innerText = stats.t;
        document.getElementById('h-air').innerText = stats.a;
        document.getElementById('h-total').innerText = stats.sum;
    }

    function setDepConfirm(rid, time) {
        if(!confirm(`[${time}] 퇴교 수송을 공지할까요?`)) return;
        const f = new Date(); f.setDate(f.getDate() + (5 - f.getDay())); 
        firebase.database().ref(`courses/${rid}/shuttle/departure`).set({ time, date: f.toISOString().split('T')[0] });
    }

    // --- 탭 2: 강사 리스트 ---
    function renderTab2() {
        const div = document.getElementById('instructor-list');
        const range = getWeekDates();
        document.getElementById('list-week-label').innerText = `${range[0].replace(/-/g,'.')} ~ ${range[4].split('-')[2]}`;
        div.innerHTML = "";
        const dayNms = ['월','화','수','목','금'];
        
        range.forEach((date, idx) => {
            const dayReqs = teacherRequests.filter(r => r.date === date && r.status === 'approved').sort((a,b)=>a.time.localeCompare(b.time));
            div.innerHTML += `<div class="day-group-title" style="font-size:13px; font-weight:900; color:var(--primary); margin:15px 0 8px 5px;">${date} (${dayNms[idx]})</div>`;
            
            if(dayReqs.length === 0) div.innerHTML += `<div style="padding:20px; color:var(--light-slate); font-size:12px; text-align:center;">예약이 없습니다.</div>`;
            else {
                dayReqs.forEach(r => {
                    div.innerHTML += `
                        <div class="ticket" onclick="showDetail('강사수송', ${JSON.stringify(r).replace(/"/g, '&quot;')}, '${date}')">
                            <div class="ticket-head"><span>${r.prof} 강사님</span><i class="fa-solid fa-id-card"></i></div>
                            <div class="ticket-body">
                                <div><div style="font-size:12px; color:var(--primary); font-weight:800;">${r.dir}</div><div class="ticket-time">${r.time}</div></div>
                                <div style="display:flex; gap:10px;">
                                    <button class="btn-circle btn-call" onclick="event.stopPropagation(); makeCallConfirm('${r.phone}')"><i class="fa-solid fa-phone"></i></button>
                                    <button class="btn-circle btn-cancel" onclick="event.stopPropagation(); cancelReqConfirm('${r.id}')"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                            </div>
                        </div>`;
                });
            }
        });
    }

    // --- 탭 3: 일정표 ---
    function renderTab3() {
        const range = getWeekDates();
        document.getElementById('sched-week-label').innerText = `${range[0].replace(/-/g,'.')} ~ ${range[4].split('-')[2]}`;
        const header = document.getElementById('sched-header');
        header.innerHTML = '<th class="t-col">시간</th>';
        const dayNms = ['월','화','수','목','금'];
        range.forEach((d, i) => {
            const th = document.createElement('th');
            th.innerHTML = `${d.split('-')[1]}/${d.split('-')[2]}<br>${dayNms[i]}`;
            th.onclick = () => openDayOff(d);
            header.appendChild(th);
        });

        const body = document.getElementById('sched-body');
        body.innerHTML = "";
        for(let h=8; h<=18; h++) {
            const row = document.createElement('tr');
            row.innerHTML = `<td class="t-col">${h}:00</td>`;
            for(let d=0; d<5; d++) {
                const dateKey = range[d];
                const td = document.createElement('td');
                const isOff = teacherRequests.some(r => r.date === dateKey && r.prof === '운행중단');
                
                if(isOff) {
                    td.style.background = "#fee2e2";
                    if(h === 12) td.innerHTML = "<b style='color:var(--danger)'>휴무</b>";
                } else {
                    // 강사 수송 매칭
                    const tReq = teacherRequests.find(r => r.date === dateKey && parseInt(r.time.split(':')[0]) === h && r.status === 'approved');
                    
                    // 교육생 퇴교 2시간 점유 로직
                    let sReq = null;
                    Object.values(allCourses).forEach(room => {
                        const dep = room.shuttle?.departure;
                        if(dep && dep.date === dateKey) {
                            const depH = parseInt(dep.time.split(':')[0]);
                            if(h === depH || h === depH + 1) sReq = { name: room.settings?.courseName || "퇴교", isMain: (h === depH), phone: room.settings?.coordinatorName, time: dep.time, dir: '훈련원→전체' };
                        }
                    });

                    if(tReq) {
                        const dir = tReq.dir.includes('항기원→') ? `KAC→${tReq.dir.split('→')[1].substring(0,2)}` : `${tReq.dir.split('→')[0].substring(0,2)}→KAC`;
                        td.innerHTML = `<div class="event-block event-teacher" onclick="showDetail('강사수송', ${JSON.stringify(tReq).replace(/"/g, '&quot;')}, '${dateKey}')">${tReq.time}<br>${dir}<br>${tReq.prof}</div>`;
                    } else if(sReq) {
                        const label = sReq.isMain ? `${sReq.name.substring(0,4)}..<br>퇴교수송` : `(운행중)`;
                        td.innerHTML = `<div class="event-block event-shuttle" onclick="showDetail('교육생퇴교', ${JSON.stringify(sReq).replace(/"/g, '&quot;')}, '${dateKey}')">${label}</div>`;
                    } else if(h === 12) {
                        td.className = "event-lunch"; td.innerText = "점심";
                    }
                }
                row.appendChild(td);
            }
            body.appendChild(row);
        }
    }

    // --- 기능 함수 ---
    function makeCallConfirm(p) { if(confirm(p+" 강사님께 전화를 걸까요?")) location.href="tel:"+p.replace(/[^0-9]/g,''); }
    function cancelReqConfirm(id) { if(confirm("해당 예약을 취소하시겠습니까?")) firebase.database().ref(`system/transport_requests/${id}`).remove(); }
    
    function showDetail(type, data, date) {
        document.getElementById('pop-category').innerText = type;
        document.getElementById('pop-location').innerText = data.dir || "항공기술훈련원";
        document.getElementById('pop-time').innerText = data.time;
        document.getElementById('pop-date').innerText = date;
        document.getElementById('pop-target').innerText = data.prof;
        document.getElementById('pop-phone').innerText = data.phone || "미등록";
        document.getElementById('callBtn').onclick = () => makeCallConfirm(data.phone);
        document.getElementById('detailPop').style.display = 'flex';
    }

    function openDayOff(d) { offTargetDate = d; document.getElementById('off-title').innerText = d + " 운행 설정"; document.getElementById('dayOffPop').style.display = 'flex'; }
    async function confirmDayOff() {
        const reason = document.getElementById('off-reason').value || "내부 사정";
        if(!confirm(offTargetDate+" 모든 운행을 취소하고 중단할까요?")) return;
        teacherRequests.filter(r=>r.date===offTargetDate).forEach(r=>firebase.database().ref(`system/transport_requests/${r.id}`).remove());
        Object.keys(allCourses).forEach(rid=>{ if(allCourses[rid].shuttle?.departure?.date===offTargetDate) firebase.database().ref(`courses/${rid}/shuttle/departure`).remove(); });
        await firebase.database().ref('system/transport_requests').push({ date: offTargetDate, prof: '운행중단', status: 'approved', time: '00:00' });
        await firebase.database().ref('system/shuttle_notice').set(offTargetDate + "은 " + reason + "으로 인해 차량 운행을 하지 않습니다.");
        document.getElementById('dayOffPop').style.display = 'none';
        document.getElementById('off-reason').value = "";
    }

    function setTab(n) { currentTab = n; document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active', i+1===n)); document.getElementById('view-1').style.display = n===1?'flex':'none'; document.getElementById('view-2').style.display = n===2?'flex':'none'; document.getElementById('view-3').style.display = n===3?'flex':'none'; renderAll(); }
    function changeWeek(n) { weekOffset += n; renderAll(); }
    function updateClock() { document.getElementById('footer-clock').innerText = new Date().toLocaleTimeString('ko-KR', {hour12: false}); }
    function toggleManual(rid) { const el = document.getElementById(`manual-${rid}`); el.style.display = el.style.display==='none'?'block':'none'; }
    function getWeekDates() {
        const today = new Date(); const start = new Date(today);
        start.setDate(today.getDate() + (weekOffset * 7) - (today.getDay() === 0 ? 6 : today.getDay() - 1));
        const days = []; for(let i=0; i<5; i++) { const d = new Date(start); d.setDate(start.getDate() + i); days.push(d.toISOString().split('T')[0]); }
        return days;
    }

    init();
  </script>
</body>
</html>