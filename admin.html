<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Platform - CATC</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- CSS (Í∏∞Ï°¥Í≥º ÎèôÏùº, ÏÉùÎûµ ÏóÜÏù¥ Ï†ÑÏ≤¥ Ìè¨Ìï®) -->
    <style>
        :root {
            --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #333;
            --header-bg: #1a237e; --sidebar-bg: #212529; --sidebar-text: #e9ecef;
            --accent-color: #3b82f6;
        }
        body.dark-mode { --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --header-bg: #0d1b2a; }
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-color); overflow-x: hidden; transition: background 0.3s; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 0 30px; height: 70px; background: var(--header-bg); color: #fff; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-bottom: 5px solid transparent; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .header-title { font-size: 20px; font-weight: 700; display:flex; align-items: center; gap:10px;}
        .course-name-text { font-size: 20px; font-weight: 400; color: #fff; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .icon-btn { font-size: 20px; cursor: pointer; color: rgba(255,255,255,0.7); padding: 5px; }
        .kac-logo { height: 28px; object-fit: contain; margin-left: 10px; }

        /* Container */
        .container { padding: 20px 40px; max-width: 1400px; margin: 0 auto; min-height: 80vh; }
        .mode-tabs { display: flex; justify-content: center; margin-top: 20px; gap: 10px; }
        .mode-tab { padding: 10px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; background: rgba(0,0,0,0.1); transition: 0.2s; }
        .mode-tab.active { background: var(--accent-color); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #view-qa, #view-quiz { display: none; }
        .view-active { display: block !important; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }

        /* Quiz Layout */
        .quiz-container { display: flex; gap: 20px; height: 70vh; margin-top: 20px; }
        .quiz-sidebar { width: 300px; background: var(--card-bg); border-radius: 12px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
        .quiz-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; margin-bottom: 5px; }
        .quiz-item.active { background: var(--accent-color); color: white; }
        
        .quiz-stage { flex-grow: 1; background: var(--card-bg); border-radius: 12px; padding: 40px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .quiz-question-text { font-size: 28px; font-weight: 800; margin-bottom: 30px; line-height: 1.4; text-align: center; }
        .quiz-options { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 800px; }
        .quiz-option { display: flex; align-items: center; padding: 15px 20px; border: 2px solid #eee; border-radius: 50px; font-size: 20px; font-weight: 500; color: var(--text-color); transition: 0.2s; }
        .opt-icon { width: 36px; height: 36px; background: #eee; color: #555; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 16px; margin-right: 15px; flex-shrink: 0; }
        .quiz-option.correct { border-color: #10b981; color: #10b981; background: #f0fdf4; }
        .quiz-option.correct .opt-icon { background: #10b981; color: white; }

        .quiz-controls { margin-top: 40px; display: flex; gap: 15px; }
        .btn-quiz { padding: 12px 30px; font-size: 16px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; gap: 8px;}
        .btn-start { background: #2563eb; } .btn-stop { background: #d32f2f; } .btn-result { background: #10b981; }

        /* Sidebar Settings */
        .sidebar { position: fixed; top: 0; left: 0; width: 450px; height: 100%; background: var(--sidebar-bg); color: var(--sidebar-text); transform: translateX(-100%); transition: 0.3s; z-index: 200; padding: 25px; overflow-y: auto; box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
        .sidebar.active { transform: translateX(0); }
        .setting-group { margin-bottom: 25px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; }
        .setting-label { font-size: 12px; color: #adb5bd; margin-bottom: 8px; display: block; font-weight: 700; text-transform: uppercase; }
        .setting-input { width: 100%; padding: 10px; background: #343a40; border: 1px solid #495057; color: white; border-radius: 4px; margin-bottom: 10px; }
        .setting-divider { border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0; }

        .radio-group { display: flex; gap: 15px; margin-bottom: 10px; }
        .radio-label { display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer; }
        .pw-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .color-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; margin-bottom: 10px; }
        .color-swatch { width: 100%; aspect-ratio: 1; border-radius: 4px; cursor: pointer; border: 2px solid transparent; }
        .color-swatch.selected { border-color: white; transform: scale(1.1); box-shadow: 0 0 0 2px #3b82f6; }

        /* Chart */
        .chart-overlay { position: absolute; top:0; left:0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 10; border-radius: 12px; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .dark-mode .chart-overlay { background: rgba(30,30,30,0.98); }
        .chart-box { display: flex; align-items: flex-end; gap: 40px; height: 300px; padding-bottom: 10px; border-bottom: 2px solid #ccc; }
        .bar-col { display: flex; flex-direction: column; align-items: center; }
        .bar { width: 50px; background: #3b82f6; border-radius: 5px 5px 0 0; transition: height 1s; }

        /* Q&A Cards */
        .q-list { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .q-card { background: var(--card-bg); border-radius: 10px; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #ccc; cursor: pointer; }
        
        .btn-action { width: 100%; padding: 10px; border-radius: 4px; border:none; cursor: pointer; font-weight: bold; margin-bottom: 5px; color:white; }
        .btn-blue { background: #2563eb; } .btn-red { background: #ef4444; } .btn-dark { background: #495057; } .btn-green { background: #10b981; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 500; justify-content: center; align-items: center; }
        .modal-box { background: var(--card-bg); padding: 30px; border-radius: 12px; width: 600px; max-width: 95%; color: var(--text-color); }
        .footer { text-align: center; margin-top: 50px; font-size: 13px; color: #888; padding-bottom: 30px;}
    </style>
</head>
<body>

    <header class="header" id="mainHeader">
        <div class="header-left">
            <div class="icon-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>
            <div class="header-title">
                CATC Training Platform <span style="margin:0 10px; opacity:0.5;">|</span> 
                <span class="course-name-text" id="displayCourseName">Loading...</span>
            </div>
        </div>
        <div class="header-right">
            <div class="icon-btn" onclick="toggleDarkMode()"><i class="fa-solid fa-moon" id="themeIcon"></i></div>
            <div class="icon-btn" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i></div>
            <img src="logo.png" alt="KAC" class="kac-logo">
        </div>
    </header>

    <div class="container">
        <div class="mode-tabs">
            <div class="mode-tab active" id="tab-qa" onclick="switchView('qa')"><i class="fa-regular fa-comments"></i> Q&A Mode</div>
            <div class="mode-tab" id="tab-quiz" onclick="switchView('quiz')"><i class="fa-solid fa-clipboard-question"></i> Quiz Mode</div>
        </div>

        <div id="view-qa" class="view-active">
            <div id="qListArea" class="q-list"></div>
        </div>

        <div id="view-quiz">
            <div class="quiz-container">
                <div class="quiz-sidebar">
                    <button class="btn-action btn-dark" onclick="openQuizEditor()">+ New Question</button>
                    <div id="quizListArea"></div>
                </div>
                <div class="quiz-stage">
                    <div id="quizEmptyMsg" style="color:#888;">Î¨∏Ï†úÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</div>
                    <div id="quizContent" style="display:none; width:100%; display:flex; flex-direction:column; align-items:center;">
                        <div class="quiz-question-text" id="stageQuestion"></div>
                        <div class="quiz-options" id="stageOptions"></div>
                        <div class="quiz-controls">
                            <button class="btn-quiz btn-start" onclick="startQuiz()"><i class="fa-solid fa-play"></i> Start</button>
                            <button class="btn-quiz btn-stop" onclick="stopQuiz()"><i class="fa-solid fa-stop"></i> Stop</button>
                            <button class="btn-quiz btn-result" onclick="showResult()"><i class="fa-solid fa-chart-simple"></i> Result</button>
                        </div>
                        <div class="chart-overlay" id="chartOverlay">
                            <h2 style="color:#333; margin-bottom:30px;">Result Analysis</h2>
                            <div class="chart-box" id="chartBox"></div>
                            <button class="btn-action btn-dark" style="width:auto; margin-top:20px;" onclick="closeResult()">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">Developer Dooseok Jang (jds0616@airport.co.kr)</div>
    </div>

    <!-- Sidebar Settings -->
    <div class="sidebar" id="sidebar">
        <div class="sb-header">Settings <span style="cursor:pointer" onclick="toggleSidebar()">‚úï</span></div>
        
        <div class="setting-group">
            <label class="setting-label">Select Course Room</label>
            <select id="roomSelect" class="setting-input" onchange="changeRoom(this.value)"></select>
        </div>

        <div class="setting-group">
            <label class="setting-label">Course Mode</label>
            <div class="radio-group">
                <label class="radio-label"><input type="radio" name="courseMode" value="continue" checked> Ïù¥Ïñ¥ÏÑú ÏßÑÌñâ</label>
                <label class="radio-label"><input type="radio" name="courseMode" value="new"> Ïã†Í∑ú Í∞úÏÑ§ (Ï¥àÍ∏∞Ìôî)</label>
            </div>

            <label class="setting-label">Course Name</label>
            <input type="text" id="confName" class="setting-input" placeholder="Í≥ºÏ†ïÎ™Ö ÏûÖÎ†•">
            
            <label class="setting-label">Room Password (4 Digits)</label>
            <div class="pw-grid">
                <input type="password" id="confPw" class="setting-input" placeholder="ÎπÑÎ≤à" maxlength="4">
                <input type="password" id="confPwConfirm" class="setting-input" placeholder="ÌôïÏù∏" maxlength="4">
            </div>

            <label class="setting-label">Theme Color</label>
            <div class="color-grid" id="colorGrid"></div>
            <input type="hidden" id="confColor" value="#3b82f6">

            <label class="setting-label">Footer Text</label>
            <textarea id="confFooter" class="setting-input" style="height:100px;" placeholder="ÌïòÎã® Î¨∏Íµ¨..."></textarea>
            
            <button class="btn-action btn-blue" onclick="handleSaveConfig()">Save Config</button>
        </div>
        
        <!-- Super Admin Zone (Password Change Added) -->
        <div class="setting-group" id="superAdminZone" style="display:none; border:1px solid #d63384;">
            <label class="setting-label" style="color:#d63384;">Super Admin Zone</label>
            
            <div style="margin-bottom:15px;">
                <label class="setting-label">Change System Password</label>
                <input type="text" id="newInstPw" class="setting-input" placeholder="New Instructor Pw (4ÏûêÎ¶¨)">
                <input type="text" id="newAdminPw" class="setting-input" placeholder="New Admin Pw (4ÏûêÎ¶¨)">
                <button class="btn-action btn-red" onclick="changeSystemPw()">Update Passwords</button>
            </div>
            
            <div class="setting-divider"></div>

            <label class="setting-label">Data Backup</label>
            <input type="password" id="ghToken" class="setting-input" placeholder="GitHub Token">
            <button class="btn-action btn-dark" onclick="saveGithubInfo()">Save Token</button>
            <button class="btn-action btn-green" onclick="uploadToGithub()">Backup to GitHub</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="detailModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-box">
            <h3>Q&A Detail</h3>
            <div id="modalText" style="font-size:18px; margin:20px 0; background:#f9f9f9; padding:15px; border-radius:8px; color:#333;"></div>
            <textarea id="adminMemo" style="width:100%; height:80px; padding:10px; margin-bottom:10px;" placeholder="Memo..."></textarea>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                <button class="btn-action btn-dark" id="btnPin" onclick="setQaStatus('pin')">üìå Pin</button>
                <button class="btn-action btn-dark" id="btnDone" onclick="setQaStatus('done')">‚úÖ Done</button>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <button class="btn-action btn-red" style="width:auto;" onclick="deleteQa()">Delete</button>
                <button class="btn-action btn-blue" style="width:auto;" onclick="saveQa()">Save</button>
            </div>
        </div>
    </div>

    <div id="quizEditModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Î¨∏Ï†ú Îì±Î°ù/ÏàòÏ†ï</h3>
            <input type="hidden" id="editQuizId">
            <input type="text" id="editQText" class="setting-input" placeholder="ÏßàÎ¨∏ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
                <div style="display:flex; align-items:center; gap:10px;"><input type="radio" name="correct" value="1"><input type="text" id="opt1" class="setting-input" placeholder="Î≥¥Í∏∞ 1Î≤à"></div>
                <div style="display:flex; align-items:center; gap:10px;"><input type="radio" name="correct" value="2"><input type="text" id="opt2" class="setting-input" placeholder="Î≥¥Í∏∞ 2Î≤à"></div>
                <div style="display:flex; align-items:center; gap:10px;"><input type="radio" name="correct" value="3"><input type="text" id="opt3" class="setting-input" placeholder="Î≥¥Í∏∞ 3Î≤à"></div>
                <div style="display:flex; align-items:center; gap:10px;"><input type="radio" name="correct" value="4"><input type="text" id="opt4" class="setting-input" placeholder="Î≥¥Í∏∞ 4Î≤à"></div>
            </div>
            <div style="margin-top:20px; display:flex; justify-content:space-between;">
                <button class="btn-action btn-red" style="width:auto;" onclick="deleteQuiz()">ÏÇ≠Ï†ú</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn-action btn-dark" style="width:auto;" onclick="document.getElementById('quizEditModal').style.display='none'">Ï∑®ÏÜå</button>
                    <button class="btn-action btn-blue" style="width:auto;" onclick="saveQuiz()">Ï†ÄÏû•</button>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let currentRoom = "A", dbRef = {};
        let currentData = {}, quizData = {}, activeQuizId = null;
        
        const PRESET_COLORS = ["#f44336", "#e91e63", "#9c27b0", "#673ab7", "#3f51b5", "#2196f3", "#03a9f4", "#00bcd4", "#009688", "#4caf50", "#8bc34a", "#ffeb3b", "#ff9800", "#ff5722", "#795548", "#607d8b"];

        window.onload = function() {
            initRoomSelector();
            initColorPicker();
            loadRoom("A");
            
            const session = JSON.parse(localStorage.getItem('kac_admin_session'));
            if(session && session.role === 'super_admin') {
                document.getElementById('superAdminZone').style.display='block';
                loadGithubSettings();
            }
        };

        function initRoomSelector() {
            const s = document.getElementById('roomSelect');
            for(let i=65;i<=90;i++) s.innerHTML += `<option value="${String.fromCharCode(i)}">Course ${String.fromCharCode(i)}</option>`;
        }

        function initColorPicker() {
            const g = document.getElementById('colorGrid');
            PRESET_COLORS.forEach(c => {
                const d = document.createElement('div'); d.className='color-swatch'; d.style.background=c;
                d.onclick = () => { document.getElementById('confColor').value=c; document.querySelectorAll('.color-swatch').forEach(x=>x.classList.remove('selected')); d.classList.add('selected'); };
                g.appendChild(d);
            });
        }

        function changeRoom(r) { currentRoom=r; loadRoom(r); }
        function loadRoom(r) {
            if(dbRef.qa) dbRef.qa.off(); if(dbRef.quiz) dbRef.quiz.off();
            dbRef.qa = firebase.database().ref(`courses/${r}/questions`);
            dbRef.quiz = firebase.database().ref(`courses/${r}/quizzes`);
            dbRef.settings = firebase.database().ref(`courses/${r}/settings`);

            dbRef.settings.on('value', s => {
                const v = s.val() || {};
                document.getElementById('displayCourseName').innerText = v.courseName || `Course ${r}`;
                document.getElementById('mainHeader').style.borderBottomColor = v.themeColor || '#3b82f6';
                document.documentElement.style.setProperty('--accent-color', v.themeColor || '#3b82f6');
                document.getElementById('confName').value = v.courseName || "";
                document.getElementById('confColor').value = v.themeColor || "#3b82f6";
                document.getElementById('confFooter').value = v.footerText || "";
            });

            dbRef.qa.on('value', s => {
                const d = s.val();
                window.currentQaData = d;
                const div = document.getElementById('qListArea'); div.innerHTML = "";
                if(!d) { div.innerHTML="<p style='text-align:center; padding:30px; color:#888;'>ÏßàÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.</p>"; return; }
                Object.keys(d).forEach(k => {
                    const item = d[k];
                    const badge = item.status==='pin'?'<span style="color:red">[NOTICE]</span> ':'';
                    div.innerHTML += `<div class="q-card" onclick="openQaModal('${k}')"><div class="q-text">${badge}${escapeHtml(item.text)}</div></div>`;
                });
            });

            dbRef.quiz.on('value', s => {
                quizData = s.val() || {};
                const div = document.getElementById('quizListArea'); div.innerHTML = "";
                Object.keys(quizData).forEach(k => {
                    const q = quizData[k];
                    const done = q.status==='finished'?'color:#10b981':'';
                    div.innerHTML += `<div class="quiz-item" onclick="selectQuiz('${k}')"><span style="${done}">Q. ${q.text.substring(0,10)}...</span></div>`;
                });
            });
        }

        function selectQuiz(k) {
            activeQuizId = k;
            const q = quizData[k];
            document.getElementById('quizContent').style.display='flex';
            document.getElementById('quizEmptyMsg').style.display='none';
            document.getElementById('stageQuestion').innerText = q.text;
            
            const optDiv = document.getElementById('stageOptions'); optDiv.innerHTML="";
            q.options.forEach((opt, i) => {
                const isCorrect = (i+1 == q.correct);
                optDiv.innerHTML += `<div class="quiz-option ${isCorrect?'correct':''}"><div class="opt-icon">${i+1}</div>${opt}</div>`;
            });
        }

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // System Password Change
        async function changeSystemPw() {
            const instPw = document.getElementById('newInstPw').value;
            const adminPw = document.getElementById('newAdminPw').value;
            
            if(!instPw && !adminPw) return alert("Î≥ÄÍ≤ΩÌï† ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
            
            const updates = {};
            if(instPw) {
                if(instPw.length !== 4) return alert("ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4ÏûêÎ¶¨Ïó¨Ïïº Ìï©ÎãàÎã§.");
                updates.instructor = await sha256(instPw);
            }
            if(adminPw) {
                if(adminPw.length !== 4) return alert("ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4ÏûêÎ¶¨Ïó¨Ïïº Ìï©ÎãàÎã§.");
                updates.super_admin = await sha256(adminPw);
            }
            
            firebase.database().ref('globalSettings/passwords').update(updates)
                .then(() => { 
                    alert("ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§."); 
                    document.getElementById('newInstPw').value = "";
                    document.getElementById('newAdminPw').value = "";
                })
                .catch(e => alert("Ïò§Î•ò: " + e.message));
        }

        // ... (Other functions: startQuiz, stopQuiz, showResult, handleSaveConfig, etc. same as before) ...
        
        function startQuiz() {
            if(!activeQuizId) return;
            if(confirm("Î¨∏Ï†úÎ•º Ï∂úÏ†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? (ÍµêÏú°ÏÉù ÌôîÎ©¥ Ï†ÑÌôò)")) {
                firebase.database().ref(`courses/${currentRoom}/activeQuiz`).set({ id: activeQuizId, timestamp: Date.now() });
                alert("Ï∂úÏ†ú ÏôÑÎ£å.");
            }
        }

        function stopQuiz() {
            if(confirm("ÏÑ§Î¨∏ÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                firebase.database().ref(`courses/${currentRoom}/activeQuiz`).set(null);
                alert("Ï¢ÖÎ£å ÏôÑÎ£å.");
            }
        }

        function showResult() {
            document.getElementById('chartOverlay').style.display='flex';
            const box = document.getElementById('chartBox'); box.innerHTML = "<p>ÏßëÍ≥ÑÏ§ë...</p>";
            
            // Realtime Count
            firebase.database().ref(`courses/${currentRoom}/quiz_answers/${activeQuizId}`).once('value', s => {
                const answers = s.val();
                const counts = [0,0,0,0];
                if(answers) {
                    Object.values(answers).forEach(ans => {
                        if(ans.choice >=1 && ans.choice <=4) counts[ans.choice-1]++;
                    });
                }
                
                box.innerHTML = "";
                const max = Math.max(...counts, 1);
                counts.forEach((c, i) => {
                    const h = (c/max)*100;
                    box.innerHTML += `<div class="bar-col"><div style="font-weight:bold; margin-bottom:5px;">${c}</div><div class="bar" style="height:${h}%;"></div><div style="margin-top:10px; font-weight:bold;">${i+1}Î≤à</div></div>`;
                });
                
                dbRef.quiz.child(activeQuizId).update({ status: 'finished' });
            });
        }
        function closeResult() { document.getElementById('chartOverlay').style.display='none'; }

        function handleSaveConfig() {
            const mode = document.querySelector('input[name="courseMode"]:checked').value;
            const name = document.getElementById('confName').value;
            const pw = document.getElementById('confPw').value;
            const color = document.getElementById('confColor').value;
            const footer = document.getElementById('confFooter').value;

            const updates = { courseName: name, themeColor: color, footerText: footer };
            
            // Password logic if needed
            
            dbRef.settings.update(updates).then(() => {
                if(mode === 'new') {
                    if(confirm("Ï†ïÎßê Ï¥àÍ∏∞Ìôî ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                        dbRef.qa.set(null);
                        alert("Ï¥àÍ∏∞Ìôî Î∞è Ï†ÄÏû• ÏôÑÎ£å");
                    }
                } else {
                    alert("Ï†ÄÏû• ÏôÑÎ£å");
                }
            });
        }

        function openQuizEditor() { document.getElementById('quizEditModal').style.display='flex'; }
        function saveQuiz() {
            const txt = document.getElementById('editQText').value;
            const opts = [1,2,3,4].map(i=>document.getElementById('opt'+i).value);
            const cor = document.querySelector('input[name="correct"]:checked')?.value;
            if(!txt || !cor) return alert("ÏûÖÎ†• ÌôïÏù∏");
            const id = dbRef.quiz.push().key;
            dbRef.quiz.child(id).set({ text: txt, options: opts, correct: cor });
            document.getElementById('quizEditModal').style.display='none';
        }
        function deleteQuiz() { /* ... */ }

        function switchView(v) {
            document.getElementById('view-qa').style.display = (v=='qa'?'block':'none');
            document.getElementById('view-quiz').style.display = (v=='quiz'?'block':'none');
            document.getElementById('tab-qa').className = (v=='qa'?'mode-tab active':'mode-tab');
            document.getElementById('tab-quiz').className = (v=='quiz'?'mode-tab active':'mode-tab');
        }
        
        function loadGithubSettings() { /* ... */ }
        function saveGithubInfo() { /* ... */ }
        function uploadToGithub() { /* ... */ }
        
        function openQaModal(key) {
            activeQaId = key;
            const item = window.currentQaData[key];
            document.getElementById('modalText').innerText = item.text;
            document.getElementById('detailModal').style.display='flex';
        }
        function closeModal(e) { if(e.target.className.includes('modal-overlay')) e.target.style.display='none'; }
        
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
        function logout() { localStorage.removeItem('kac_admin_session'); location.replace('login.html'); }
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
        function loadThemeMode() { /* ... */ }
        function escapeHtml(t) { return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }
    </script>
</body>
</html>