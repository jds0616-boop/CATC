<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Platform - CATC</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- FontAwesome & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333;
            --header-bg: #1a237e; /* Navy Default */
            --sidebar-bg: #212529;
            --sidebar-text: #e9ecef;
            --accent-color: #3b82f6;
        }

        body.dark-mode {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #0d1b2a;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 0; 
            background-color: var(--bg-color); color: var(--text-color);
            transition: background 0.3s;
            overflow-x: hidden;
        }

        /* --- Header --- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px; height: 70px;
            background: var(--header-bg); color: #fff;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border-bottom: 5px solid transparent; /* Dynamic Color */
        }
        
        .header-left { display: flex; align-items: center; gap: 20px; }
        .header-title { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; display:flex; align-items: center; gap:10px;}
        .course-divider { color: rgba(255,255,255,0.4); font-size: 18px; }
        .course-name-text { font-size: 20px; font-weight: 400; color: #fff; }

        .header-right { display: flex; align-items: center; gap: 15px; }
        .icon-btn { font-size: 20px; cursor: pointer; color: rgba(255,255,255,0.7); transition: 0.2s; padding: 5px; }
        .icon-btn:hover { color: #fff; }
        .kac-logo { height: 28px; width: auto; object-fit: contain; margin-left: 10px; }

        /* --- Mode Switcher (Tab) --- */
        .mode-tabs {
            display: flex; justify-content: center; margin-top: 20px; gap: 10px;
        }
        .mode-tab {
            padding: 10px 30px; border-radius: 50px; font-weight: bold; cursor: pointer;
            background: rgba(0,0,0,0.1); color: var(--text-color); border: 2px solid transparent;
            transition: 0.2s;
        }
        .mode-tab.active { background: var(--accent-color); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* --- Main Container --- */
        .container { padding: 20px 40px; max-width: 1400px; margin: 0 auto; min-height: 80vh; }
        
        /* View Sections */
        #view-qa, #view-quiz { display: none; }
        .view-active { display: block !important; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }

        /* --- Q&A Styling --- */
        .q-list { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .q-card {
            background: var(--card-bg); border-radius: 10px; padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #ccc;
            cursor: pointer; transition: transform 0.2s;
        }
        .q-card:hover { transform: translateY(-2px); }
        .state-notice { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.05); }
        .state-done { opacity: 0.6; filter: grayscale(1); border-left-color: #10b981; }
        .q-text { font-size: 18px; font-weight: 500; }
        .q-sub { font-size: 12px; color: #888; margin-top: 5px; }

        /* --- Quiz Styling --- */
        .quiz-container { display: flex; gap: 20px; height: 70vh; margin-top: 20px; }
        
        /* Quiz Sidebar (List) */
        .quiz-sidebar { 
            width: 300px; background: var(--card-bg); border-radius: 12px; 
            padding: 15px; overflow-y: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
        }
        .quiz-add-btn { width: 100%; padding: 12px; background: #212529; color: white; border:none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 15px; }
        .quiz-item { 
            padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center;
            transition: background 0.2s; border-radius: 8px; margin-bottom: 5px;
        }
        .quiz-item:hover { background: rgba(0,0,0,0.05); }
        .quiz-item.active { background: var(--accent-color); color: white; }
        .quiz-item.completed i { color: #10b981; } /* ÏôÑÎ£å Ï≤¥ÌÅ¨ ÏÉâÏÉÅ */

        /* Quiz Main Stage */
        .quiz-stage { 
            flex-grow: 1; background: var(--card-bg); border-radius: 12px; 
            padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; position: relative;
        }
        .quiz-question-text { font-size: 28px; font-weight: 800; margin-bottom: 40px; line-height: 1.4; }
        .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 800px; }
        .quiz-option { 
            padding: 20px; border: 2px solid #eee; border-radius: 12px; 
            font-size: 20px; font-weight: 500; color: var(--text-color);
        }
        .quiz-option.correct { border-color: #10b981; color: #10b981; font-weight: 700; } /* Í≤∞Í≥º Í≥µÍ∞úÏãú Ï†ïÎãµ ÌëúÏãú */

        .quiz-controls { margin-top: 40px; display: flex; gap: 15px; }
        .btn-quiz { padding: 15px 40px; font-size: 18px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        .btn-quiz:active { transform: scale(0.95); }
        .btn-start { background: #2563eb; color: white; }
        .btn-stop { background: #d32f2f; color: white; }
        .btn-result { background: #10b981; color: white; }

        /* Chart Overlay */
        .chart-overlay {
            position: absolute; top:0; left:0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 10; border-radius: 12px;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .dark-mode .chart-overlay { background: rgba(30,30,30,0.95); }
        
        .chart-box { display: flex; align-items: flex-end; gap: 30px; height: 300px; width: 60%; border-bottom: 2px solid #888; padding-bottom: 5px; margin-bottom: 20px;}
        .bar-container { flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end; }
        .bar { width: 60%; background: #3b82f6; border-radius: 5px 5px 0 0; transition: height 1s ease-out; height: 0;}
        .bar-label { margin-top: 10px; font-size: 18px; font-weight: bold; }
        .bar-value { margin-bottom: 5px; font-weight: bold; }

        /* --- Footer --- */
        .footer {
            text-align: center; padding: 20px; font-size: 12px; color: rgba(255,255,255,0.7);
            background: var(--header-bg); margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* --- Sidebar (Settings) --- */
        .sidebar {
            position: fixed; top: 0; left: 0; width: 400px; height: 100%;
            background: var(--sidebar-bg); color: var(--sidebar-text);
            box-shadow: 5px 0 20px rgba(0,0,0,0.4);
            transform: translateX(-100%); transition: 0.3s; z-index: 200; padding: 25px;
            overflow-y: auto;
        }
        .sidebar.active { transform: translateX(0); }
        .sb-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .setting-group { margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; }
        .setting-label { font-size: 12px; color: #adb5bd; margin-bottom: 5px; display: block; font-weight: 700; }
        .setting-input { width: 100%; padding: 10px; background: #343a40; border: 1px solid #495057; color: white; border-radius: 4px; margin-bottom: 10px; font-size: 13px; }
        .setting-input:focus { border-color: var(--accent-color); outline: none; }
        
        .btn-action { width: 100%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; display: flex; justify-content: center; gap: 8px; margin-bottom: 5px;}
        .btn-blue { background: #2563eb; color: white; }
        .btn-red { background: #ef4444; color: white; }
        .btn-dark { background: #495057; color: white; }

        /* --- Modals --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 500; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--card-bg); width: 600px; padding: 30px; border-radius: 12px; color: var(--text-color); position: relative; }
        
        /* Quiz Editor Modal */
        .quiz-edit-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
        .option-row { display: flex; align-items: center; gap: 10px; }
        .radio-correct { width: 20px; height: 20px; accent-color: #10b981; }

    </style>
</head>
<body>

    <!-- Header -->
    <header class="header" id="mainHeader">
        <div class="header-left">
            <div class="icon-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>
            <div class="header-title">
                CATC Training Platform
                <span class="course-divider">|</span>
                <span class="course-name-text" id="displayCourseName">Loading...</span>
            </div>
        </div>
        <div class="header-right">
            <div class="icon-btn" onclick="toggleDarkMode()" title="Day/Night Mode"><i class="fa-solid fa-moon" id="themeIcon"></i></div>
            <div class="icon-btn" onclick="logout()" title="Logout"><i class="fa-solid fa-right-from-bracket"></i></div>
            <img src="logo.png" alt="KAC" class="kac-logo">
        </div>
    </header>

    <!-- Content -->
    <div class="container">
        <!-- Mode Tabs -->
        <div class="mode-tabs">
            <div class="mode-tab active" id="tab-qa" onclick="switchView('qa')"><i class="fa-regular fa-comments"></i> Q&A Mode</div>
            <div class="mode-tab" id="tab-quiz" onclick="switchView('quiz')"><i class="fa-solid fa-clipboard-question"></i> Quiz Mode</div>
        </div>

        <!-- 1. Q&A View -->
        <div id="view-qa" class="view-active">
            <div id="qListArea" class="q-list">
                <div style="text-align:center; padding:50px; color:#888;">Loading Q&A...</div>
            </div>
        </div>

        <!-- 2. Quiz View -->
        <div id="view-quiz">
            <div class="quiz-container">
                <!-- List -->
                <div class="quiz-sidebar">
                    <button class="quiz-add-btn" onclick="openQuizEditor()">+ New Question / Î¨∏Ï†úÎì±Î°ù</button>
                    <div id="quizListArea">
                        <!-- Dynamic List -->
                    </div>
                </div>
                
                <!-- Stage -->
                <div class="quiz-stage" id="quizStage">
                    <div id="quizEmptyMsg" style="color:#888;">Ï¢åÏ∏° Î¶¨Ïä§Ìä∏ÏóêÏÑú Î¨∏Ï†úÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.<br>Select a question from the list.</div>
                    
                    <div id="quizContent" style="display:none; width:100%;">
                        <div class="quiz-question-text" id="stageQuestion">Q. Î¨∏Ï†ú ÎÇ¥Ïö©Ïù¥ ÎÇòÏòµÎãàÎã§.</div>
                        <div class="quiz-options" id="stageOptions">
                            <!-- Options -->
                        </div>

                        <div class="quiz-controls">
                            <button class="btn-quiz btn-start" onclick="startQuiz()"><i class="fa-solid fa-play"></i> Start / Ï∂úÏ†ú</button>
                            <button class="btn-quiz btn-stop" onclick="stopQuiz()"><i class="fa-solid fa-stop"></i> Stop / Ï¢ÖÎ£å</button>
                            <button class="btn-quiz btn-result" onclick="showResult()"><i class="fa-solid fa-chart-simple"></i> Result / Í≤∞Í≥º</button>
                        </div>
                        
                        <!-- Chart Overlay -->
                        <div class="chart-overlay" id="chartOverlay">
                            <div id="chartLoading" style="font-size:24px; font-weight:bold; color:#333;">
                                <i class="fa-solid fa-spinner fa-spin"></i> ÏßëÍ≥Ñ Ï§ë...
                            </div>
                            <div id="chartContent" style="display:none; width:100%; height:100%; flex-direction:column; align-items:center; justify-content:center;">
                                <h2 style="margin-bottom:20px; color:#333;">Result Analysis</h2>
                                <div class="chart-box" id="chartBox">
                                    <!-- Bars Generated via JS -->
                                </div>
                                <button class="btn-action btn-dark" style="width:auto;" onclick="closeResult()">Close Result</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer" id="mainFooter">
        Î≥∏ ÏõπÏÇ¨Ïù¥Ìä∏Îäî KAC Ìï≠Í≥µÍ∏∞Ïà†ÌõàÎ†®Ïõê ÍµêÏú°Í¥ÄÎ†® Q&AÌîåÎû´ÌèºÏûÖÎãàÎã§.<br>
        Î¨∏Ïùò Ïù¥Î©îÏùº : jds0616@airport.co.kr (Developed by DooSeok, Jang)<br>
        ¬© 2026 Korea Airports Corporation. All rights reserved.
    </div>

    <!-- Sidebar Settings -->
    <div class="sidebar" id="sidebar">
        <div class="sb-header">
            <span>Settings</span>
            <span style="cursor:pointer" onclick="toggleSidebar()">‚úï</span>
        </div>

        <div class="setting-group">
            <label class="setting-label">Select Course Room</label>
            <select id="roomSelect" class="setting-input" onchange="changeRoom(this.value)"></select>
        </div>

        <div class="setting-group">
            <label class="setting-label">Course Name</label>
            <input type="text" id="confName" class="setting-input" placeholder="Í≥ºÏ†ïÎ™Ö">
            <label class="setting-label">Theme Color</label>
            <input type="color" id="confColor" class="setting-input">
            <label class="setting-label">Footer Text (Admin Edit)</label>
            <textarea id="confFooter" class="setting-input" style="height:80px;" placeholder="ÌïòÎã® Î¨∏Íµ¨..."></textarea>
            <button class="btn-action btn-blue" onclick="saveConfig()">Save Config</button>
        </div>

        <div class="setting-group super-admin-zone" id="superAdminZone" style="display:none;">
            <label class="setting-label" style="color:#d63384;">Super Admin Zone</label>
            <input type="password" id="ghToken" class="setting-input" placeholder="GitHub Token">
            <button class="btn-action btn-dark" onclick="saveGithubInfo()">Save Token</button>
            <button class="btn-action btn-green" onclick="uploadToGithub()">Backup to GitHub</button>
        </div>
    </div>

    <!-- Q&A Detail Modal -->
    <div id="detailModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-box">
            <h3>Q&A Detail</h3>
            <div id="modalText" style="font-size:18px; margin:20px 0; background:#f9f9f9; padding:15px; border-radius:8px; color:#333;"></div>
            <textarea id="adminMemo" style="width:100%; height:80px; padding:10px; margin-bottom:10px;" placeholder="Memo..."></textarea>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                <button class="btn-action btn-dark" id="btnPin" onclick="setQaStatus('pin')">üìå Pin</button>
                <button class="btn-action btn-dark" id="btnDone" onclick="setQaStatus('done')">‚úÖ Done</button>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <button class="btn-action btn-red" style="width:auto;" onclick="deleteQa()">Delete</button>
                <button class="btn-action btn-blue" style="width:auto;" onclick="saveQa()">Save</button>
            </div>
        </div>
    </div>

    <!-- Quiz Editor Modal -->
    <div id="quizEditModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Quiz Editor</h3>
            <input type="hidden" id="editQuizId">
            <input type="text" id="editQText" class="setting-input" placeholder="Question Text (Î¨∏Ï†ú ÎÇ¥Ïö©)">
            <div class="quiz-edit-grid">
                <div class="option-row"><input type="radio" name="correct" value="1" class="radio-correct"><input type="text" id="opt1" class="setting-input" placeholder="Option 1"></div>
                <div class="option-row"><input type="radio" name="correct" value="2" class="radio-correct"><input type="text" id="opt2" class="setting-input" placeholder="Option 2"></div>
                <div class="option-row"><input type="radio" name="correct" value="3" class="radio-correct"><input type="text" id="opt3" class="setting-input" placeholder="Option 3"></div>
                <div class="option-row"><input type="radio" name="correct" value="4" class="radio-correct"><input type="text" id="opt4" class="setting-input" placeholder="Option 4"></div>
            </div>
            <div style="text-align:right; margin-top:20px; display:flex; justify-content:space-between;">
                <button class="btn-action btn-red" style="width:auto;" onclick="deleteQuiz()">Delete</button>
                <div>
                    <button class="btn-action btn-dark" style="width:auto; display:inline-block;" onclick="document.getElementById('quizEditModal').style.display='none'">Cancel</button>
                    <button class="btn-action btn-blue" style="width:auto; display:inline-block;" onclick="saveQuiz()">Save Question</button>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // --- 1. Init & Config ---
        let currentRoom = "A";
        let userRole = 'instructor';
        let currentMode = 'qa'; // qa or quiz
        let activeQuizId = null; // Currently selected quiz in UI
        
        // Refs
        let dbQaRef = null;
        let dbQuizRef = null; 
        let dbSettingsRef = null;

        // Session Check
        (function checkAuth() {
            const session = JSON.parse(localStorage.getItem('kac_admin_session'));
            if(!session || session.token !== 'granted') {
                location.replace('login.html'); return;
            }
            userRole = session.role;
            if(userRole === 'super_admin') document.getElementById('superAdminZone').style.display = 'block';
        })();

        window.onload = function() {
            initRoomSelector();
            loadThemeMode();
            loadRoom(currentRoom);
        };

        function initRoomSelector() {
            const sel = document.getElementById('roomSelect');
            for(let i=65; i<=90; i++) {
                const char = String.fromCharCode(i);
                sel.innerHTML += `<option value="${char}">Course ${char}</option>`;
            }
        }

        // --- 2. Main Logic (Room & DB) ---
        function changeRoom(roomId) {
            currentRoom = roomId;
            loadRoom(roomId);
            // Sidebar stays open as requested
        }

        function loadRoom(roomId) {
            // Unsubscribe old
            if(dbQaRef) dbQaRef.off();
            if(dbQuizRef) dbQuizRef.off();
            if(dbSettingsRef) dbSettingsRef.off();

            // Set Refs
            dbQaRef = firebase.database().ref(`courses/${roomId}/questions`);
            dbQuizRef = firebase.database().ref(`courses/${roomId}/quizzes`);
            dbSettingsRef = firebase.database().ref(`courses/${roomId}/settings`);

            // Load Settings
            dbSettingsRef.on('value', snap => {
                const val = snap.val() || {};
                document.getElementById('displayCourseName').innerText = val.courseName || `Course ${roomId}`;
                document.getElementById('mainHeader').style.borderBottomColor = val.themeColor || '#3b82f6';
                document.documentElement.style.setProperty('--accent-color', val.themeColor || '#3b82f6');
                
                // Sidebar Inputs
                document.getElementById('confName').value = val.courseName || "";
                document.getElementById('confColor').value = val.themeColor || "#3b82f6";
                document.getElementById('confFooter').value = val.footerText || "";
                
                if(val.footerText) document.getElementById('mainFooter').innerHTML = val.footerText.replace(/\n/g, '<br>');
            });

            // Load Q&A List
            dbQaRef.on('value', snap => renderQaList(snap.val()));

            // Load Quiz List
            dbQuizRef.on('value', snap => renderQuizList(snap.val()));
        }

        // --- 3. Q&A Mode Logic ---
        function renderQaList(data) {
            const listDiv = document.getElementById('qListArea');
            listDiv.innerHTML = "";
            if(!data) { listDiv.innerHTML = "<p style='text-align:center; padding:30px; color:#888;'>No Questions.</p>"; return; }

            let items = Object.keys(data).map(key => ({ id: key, ...data[key] }));
            items.sort((a,b) => {
                if(a.status === 'pin') return -1; if(b.status === 'pin') return 1;
                return b.timestamp - a.timestamp; 
            });

            items.forEach(item => {
                let badge = item.status==='pin' ? '<span style="color:red; font-weight:bold;">[NOTICE]</span> ' : '';
                let doneClass = item.status==='done' ? 'state-done' : (item.status==='pin'?'state-notice':'');
                listDiv.innerHTML += `
                    <div class="q-card ${doneClass}" onclick="openQaModal('${item.id}')">
                        <div style="width:90%">
                            <div class="q-text">${badge}${escapeHtml(item.text)}</div>
                            <div class="q-sub">${new Date(item.timestamp).toLocaleTimeString()} <i class="fa-solid fa-thumbs-up"></i> ${item.likes||0}</div>
                        </div>
                    </div>
                `;
            });
            window.currentQaData = data; // store for modal
        }

        let activeQaId = null;
        function openQaModal(key) {
            activeQaId = key;
            const item = window.currentQaData[key];
            document.getElementById('modalText').innerText = item.text;
            document.getElementById('adminMemo').value = item.memo || "";
            document.getElementById('detailModal').style.display = 'flex';
        }
        function saveQa() {
            const memo = document.getElementById('adminMemo').value;
            dbQaRef.child(activeQaId).update({ memo: memo });
            document.getElementById('detailModal').style.display = 'none';
        }
        function setQaStatus(status) {
            dbQaRef.child(activeQaId).update({ status: status });
            document.getElementById('detailModal').style.display = 'none';
        }
        function deleteQa() {
            if(confirm("Delete this question?")) {
                dbQaRef.child(activeQaId).remove();
                document.getElementById('detailModal').style.display = 'none';
            }
        }

        // --- 4. Quiz Mode Logic ---
        function renderQuizList(data) {
            const listDiv = document.getElementById('quizListArea');
            listDiv.innerHTML = "";
            if(!data) return;
            
            window.quizData = data; // Store globally
            
            Object.keys(data).forEach(key => {
                const q = data[key];
                const isCompleted = q.status === 'finished';
                const checkMark = isCompleted ? '<i class="fa-solid fa-check-circle"></i>' : '<i class="fa-regular fa-circle"></i>';
                
                listDiv.innerHTML += `
                    <div class="quiz-item ${isCompleted?'completed':''}" onclick="selectQuiz('${key}')">
                        <span>${checkMark} <b>${q.text.substring(0,15)}...</b></span>
                        <i class="fa-solid fa-pen" style="font-size:12px; color:#aaa;" onclick="event.stopPropagation(); editQuiz('${key}')"></i>
                    </div>
                `;
            });
        }

        function selectQuiz(key) {
            activeQuizId = key;
            const q = window.quizData[key];
            
            document.getElementById('quizEmptyMsg').style.display = 'none';
            document.getElementById('quizContent').style.display = 'block';
            document.getElementById('stageQuestion').innerText = `Q. ${q.text}`;
            
            const optDiv = document.getElementById('stageOptions');
            optDiv.innerHTML = "";
            q.options.forEach((opt, idx) => {
                // Ï†ïÎãµ ÌëúÏãú (Í≤∞Í≥ºÌôîÎ©¥ÏóêÏÑúÎßå Î≥¥Ïù¥Í≤å Ìï† ÏàòÎèÑ ÏûàÏßÄÎßå Í∞ïÏÇ¨ÎãàÍπå ÎØ∏Î¶¨ Î≥¥Ïó¨Ï§å)
                let cls = (idx + 1 == q.correct) ? 'quiz-option correct' : 'quiz-option';
                optDiv.innerHTML += `<div class="${cls}">${idx+1}. ${opt}</div>`;
            });
            
            // ÏÉÅÌÉúÏóê Îî∞Î•∏ Î≤ÑÌäº ÌôúÏÑ±ÌôîÎäî Ïó¨Í∏∞ÏÑú ÏÉùÎûµ (Îã®ÏàúÌôî)
        }

        function openQuizEditor() {
            document.getElementById('editQuizId').value = "";
            document.getElementById('editQText').value = "";
            [1,2,3,4].forEach(i => document.getElementById(`opt${i}`).value = "");
            document.querySelectorAll('input[name="correct"]').forEach(r => r.checked = false);
            document.getElementById('quizEditModal').style.display = 'flex';
        }

        function editQuiz(key) {
            const q = window.quizData[key];
            document.getElementById('editQuizId').value = key;
            document.getElementById('editQText').value = q.text;
            q.options.forEach((opt, i) => document.getElementById(`opt${i+1}`).value = opt);
            document.querySelector(`input[name="correct"][value="${q.correct}"]`).checked = true;
            document.getElementById('quizEditModal').style.display = 'flex';
        }

        function saveQuiz() {
            const id = document.getElementById('editQuizId').value || dbQuizRef.push().key;
            const text = document.getElementById('editQText').value;
            const options = [1,2,3,4].map(i => document.getElementById(`opt${i}`).value);
            const correct = document.querySelector('input[name="correct"]:checked')?.value;

            if(!text || options.some(o=>!o) || !correct) return alert("Fill all fields.");

            dbQuizRef.child(id).update({
                text, options, correct, 
                status: 'ready', // ready, active, closed, finished
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            document.getElementById('quizEditModal').style.display = 'none';
        }

        function deleteQuiz() {
            const id = document.getElementById('editQuizId').value;
            if(id && confirm("Delete this quiz?")) {
                dbQuizRef.child(id).remove();
                document.getElementById('quizEditModal').style.display = 'none';
            }
        }

        // Quiz Execution
        function startQuiz() {
            if(!activeQuizId) return;
            if(confirm("Î¨∏Ï†úÎ•º Ï∂úÏ†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? (ÍµêÏú°ÏÉù ÌôîÎ©¥Ïóê ÌåùÏóÖÎê©ÎãàÎã§)")) {
                // 1. Ìï¥Îãπ ÌÄ¥Ï¶à ÏÉÅÌÉú Active
                dbQuizRef.child(activeQuizId).update({ status: 'active' });
                // 2. Room Ï†ÑÏ≤¥ ÏÉÅÌÉúÏóê ÌòÑÏû¨ ÌôúÏÑ± ÌÄ¥Ï¶à ID Í∏∞Î°ù (ÍµêÏú°ÏÉùÏù¥ Í∞êÏßÄ)
                firebase.database().ref(`courses/${currentRoom}/activeQuiz`).set({
                    id: activeQuizId,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                alert("Î¨∏Ï†úÍ∞Ä Ï∂úÏ†úÎêòÏóàÏäµÎãàÎã§. (ÍµêÏú°ÏÉù ÏûÖÎ†• ÎåÄÍ∏∞Ï§ë)");
            }
        }

        function stopQuiz() {
            if(!activeQuizId) return;
            if(confirm("ÏÑ§Î¨∏ÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå? (ÏûÖÎ†• Ï∞®Îã®)")) {
                dbQuizRef.child(activeQuizId).update({ status: 'closed' });
                firebase.database().ref(`courses/${currentRoom}/activeQuiz`).set(null); // active Ìï¥Ï†ú
                alert("ÏÑ§Î¨∏Ïù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.");
            }
        }

        function showResult() {
            if(!activeQuizId) return;
            const overlay = document.getElementById('chartOverlay');
            overlay.style.display = 'flex';
            document.getElementById('chartLoading').style.display = 'block';
            document.getElementById('chartContent').style.display = 'none';

            // DBÏóêÏÑú ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (Í∞ÄÏÉÅÏùò Í≤ΩÎ°ú: courses/A/quiz_answers/quizId)
            // Ïó¨Í∏∞ÏÑúÎäî ÏãúÎÆ¨Î†àÏù¥ÏÖòÏùÑ ÏúÑÌï¥ ÎûúÎç§Í∞í ÏÇ¨Ïö© (Ïã§Ï†ú Íµ¨ÌòÑ Ïãú DB Ïó∞Îèô)
            // Ïã§Ï†ú Íµ¨ÌòÑ: firebase.database().ref(`courses/${currentRoom}/quiz_answers/${activeQuizId}`).once('value')...
            
            setTimeout(() => {
                document.getElementById('chartLoading').style.display = 'none';
                document.getElementById('chartContent').style.display = 'flex';
                
                // Demo Data Generation (ÎÇòÏ§ëÏóê Ïã§Ï†ú DB Ïó∞Îèô ÌïÑÏöî)
                const counts = [0, 0, 0, 0]; 
                // DB Ïó∞Îèô Ïãú: snap.forEach(c => counts[c.val().choice - 1]++)
                
                // Í∞ÄÏßú Îç∞Ïù¥ÌÑ∞ (ÌÖåÏä§Ìä∏Ïö©)
                for(let i=0; i<4; i++) counts[i] = Math.floor(Math.random() * 20);
                
                const max = Math.max(...counts, 1);
                const chartBox = document.getElementById('chartBox');
                chartBox.innerHTML = "";
                
                // Ï†ïÎãµ Ï†ïÎ≥¥
                const q = window.quizData[activeQuizId];
                
                counts.forEach((val, idx) => {
                    const isCorrect = (idx + 1) == q.correct;
                    const color = isCorrect ? '#10b981' : '#3b82f6';
                    const height = (val / max) * 100;
                    
                    chartBox.innerHTML += `
                        <div class="bar-container">
                            <div class="bar-value">${val}Î™Ö</div>
                            <div class="bar" style="height:${height}%; background:${color}"></div>
                            <div class="bar-label" style="${isCorrect?'color:#10b981':''}">${idx+1}Î≤à</div>
                        </div>
                    `;
                });
                
                // ÏôÑÎ£å ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                dbQuizRef.child(activeQuizId).update({ status: 'finished' });
                
            }, 2000); // 2Ï¥à Î°úÎî©
        }

        function closeResult() {
            document.getElementById('chartOverlay').style.display = 'none';
        }

        // --- UI Utils ---
        function switchView(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            
            document.getElementById('view-qa').classList.remove('view-active');
            document.getElementById('view-quiz').classList.remove('view-active');
            document.getElementById(`view-${mode}`).classList.add('view-active');
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
        function closeModal(e) { if(e.target.className.includes('modal-overlay')) e.target.style.display='none'; }
        
        function saveConfig() {
            const name = document.getElementById('confName').value;
            const color = document.getElementById('confColor').value;
            const footer = document.getElementById('confFooter').value;
            dbSettingsRef.update({ courseName: name, themeColor: color, footerText: footer })
                .then(() => alert("Settings Saved."));
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('themeIcon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
            localStorage.setItem('kac_admin_theme', isDark ? 'dark' : 'light');
        }
        function loadThemeMode() {
            if(localStorage.getItem('kac_admin_theme') === 'dark') toggleDarkMode();
        }
        function logout() {
            localStorage.removeItem('kac_admin_session');
            location.replace('login.html');
        }
        function escapeHtml(t) { return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }
    </script>
</body>
</html>