<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Admin - CATC</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #333;
            --header-bg: #1a237e; --sidebar-bg: #212529; --sidebar-text: #e9ecef;
            --accent-color: #3b82f6; --navy-border: #1a237e;
        }
        body.dark-mode { --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --header-bg: #0d1b2a; }
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-color); overflow: hidden; height: 100vh; display:flex; flex-direction:column; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 0 30px; height: 70px; background: var(--header-bg); color: #fff; flex-shrink:0; box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-bottom: 5px solid transparent; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .header-title { font-size: 20px; font-weight: 700; display:flex; align-items: center; gap:10px;}
        .course-name-text { font-size: 20px; font-weight: 400; color: #fff; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .icon-btn { font-size: 20px; cursor: pointer; color: rgba(255,255,255,0.7); padding: 5px; }
        .kac-logo { height: 28px; object-fit: contain; margin-left: 10px; }

        /* Container */
        .container { flex-grow:1; display:flex; flex-direction:column; padding: 20px 40px; max-width: 1600px; margin: 0 auto; width:100%; overflow:hidden; }
        
        .mode-tabs { display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; flex-shrink:0; }
        .mode-tab { padding: 10px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; background: rgba(0,0,0,0.1); transition: 0.2s; }
        .mode-tab.active { background: var(--accent-color); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        #view-qa, #view-quiz { display: none; height:100%; overflow:hidden; }
        .view-active { display: block !important; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }

        /* Q&A Layout */
        #qListArea { height: 100%; overflow-y: auto; padding-bottom: 50px; }
        .q-card { background: var(--card-bg); border-radius: 10px; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #ccc; cursor: pointer; margin-bottom:10px; }
        .state-notice { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.05); }
        .state-done { opacity: 0.6; filter: grayscale(1); border-left-color: #10b981; }

        /* Quiz Layout (New) */
        .quiz-container { display: flex; gap: 20px; height: 100%; }
        
        /* Left: Nav Sidebar (Hidden list, mainly buttons) */
        .quiz-sidebar { width: 250px; display: flex; flex-direction: column; gap:10px; }
        .quiz-list-box { flex-grow:1; background: var(--card-bg); border-radius: 12px; padding:10px; overflow-y:auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .quiz-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; border-radius: 5px; font-size:14px; margin-bottom:5px; }
        .quiz-item:hover { background: #f1f1f1; }
        .quiz-item.active { background: var(--accent-color); color: white; }
        .quiz-item.completed { color: #10b981; }

        /* Center: Stage */
        .quiz-stage-wrapper { flex-grow: 1; display:flex; align-items:center; justify-content:center; position:relative; }
        .nav-arrow { font-size: 40px; color: #ccc; cursor: pointer; padding: 20px; transition:0.2s; user-select:none; }
        .nav-arrow:hover { color: var(--accent-color); transform: scale(1.1); }

        .quiz-card-main { 
            background: var(--card-bg); width: 100%; max-width: 900px; height: 90%; 
            border: 4px solid var(--navy-border); border-radius: 30px; /* ÎÇ®ÏÉâ ÎùºÏö¥Îî© ÌÖåÎëêÎ¶¨ */
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; position: relative; overflow-y: auto;
        }

        .quiz-question-display { font-size: 32px; font-weight: 800; margin-bottom: 40px; text-align: center; word-break: keep-all; line-height:1.4; }
        
        .quiz-options-list { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 700px; }
        .quiz-option-row { 
            display: flex; align-items: center; padding: 15px 20px; 
            border: 2px solid #e0e0e0; border-radius: 15px; 
            font-size: 20px; font-weight: 500; transition: 0.2s;
        }
        .opt-num { 
            width: 40px; height: 40px; background: #eee; color: #555; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 900; margin-right: 20px; flex-shrink:0;
        }
        /* Ï†ïÎãµ Í≥µÍ∞ú Ïãú Ïä§ÌÉÄÏùº */
        .quiz-option-row.reveal-correct { border-color: #10b981; background: #f0fdf4; color: #10b981; font-weight:800; }
        .quiz-option-row.reveal-correct .opt-num { background: #10b981; color: white; }

        .quiz-controls { margin-top: 50px; display: flex; gap: 20px; }
        .btn-control { 
            padding: 15px 40px; border-radius: 50px; border: none; 
            font-size: 18px; font-weight: 800; color: white; cursor: pointer; 
            display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .btn-control:active { transform: scale(0.95); }
        .btn-open { background: #2563eb; } 
        .btn-close { background: #d32f2f; } 
        .btn-result { background: #10b981; }

        /* Chart */
        .result-overlay { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: rgba(255,255,255,0.95); border-radius: 25px; 
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; 
        }
        .chart-container { display: flex; align-items: flex-end; gap: 40px; height: 300px; margin-bottom: 30px; border-bottom: 2px solid #aaa; padding-bottom: 5px; }
        .bar-wrap { display: flex; flex-direction: column; align-items: center; width: 60px; }
        .bar-val { font-weight: bold; margin-bottom: 5px; font-size: 18px; }
        .bar { width: 100%; background: #ccc; border-radius: 5px 5px 0 0; transition: height 1s; height: 0; }
        .bar.winner { background: #10b981; } /* Ï†ïÎãµÎ∞î */
        .bar-lbl { margin-top: 10px; font-weight: bold; }

        /* Sidebar Settings */
        .sidebar { position: fixed; top: 0; left: 0; width: 450px; height: 100%; background: var(--sidebar-bg); color: var(--sidebar-text); transform: translateX(-100%); transition: 0.3s; z-index: 200; padding: 25px; overflow-y: auto; box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
        .sidebar.active { transform: translateX(0); }
        .setting-group { margin-bottom: 25px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; }
        .setting-label { font-size: 12px; color: #adb5bd; margin-bottom: 8px; display: block; font-weight: 700; text-transform: uppercase; }
        .setting-input { width: 100%; padding: 10px; background: #343a40; border: 1px solid #495057; color: white; border-radius: 4px; margin-bottom: 10px; }
        
        /* Restored Sidebar Elements */
        .radio-group { display: flex; gap: 15px; margin-bottom: 10px; }
        .radio-label { display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer; }
        .pw-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .color-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; margin-bottom: 10px; }
        .color-swatch { width: 100%; aspect-ratio: 1; border-radius: 4px; cursor: pointer; border: 2px solid transparent; }
        .color-swatch.selected { border-color: white; transform: scale(1.1); box-shadow: 0 0 0 2px #3b82f6; }

        .btn-action { width: 100%; padding: 10px; border-radius: 4px; border:none; cursor: pointer; font-weight: bold; margin-bottom: 5px; color:white; }
        .btn-blue { background: #2563eb; } .btn-red { background: #ef4444; } .btn-dark { background: #495057; } .btn-green { background: #10b981; }

        /* Footer (Fixed) */
        .footer { text-align: center; padding: 20px; font-size: 13px; color: rgba(255,255,255,0.6); background: var(--header-bg); border-top: 1px solid rgba(255,255,255,0.1); flex-shrink:0; }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 500; justify-content: center; align-items: center; }
        .modal-box { background: var(--card-bg); padding: 30px; border-radius: 12px; width: 600px; max-width: 95%; color: var(--text-color); }
        .option-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <header class="header" id="mainHeader">
        <div class="header-left">
            <div class="icon-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>
            <div class="header-title">
                CATC Training Platform <span style="margin:0 10px; opacity:0.5;">|</span> 
                <span class="course-name-text" id="displayCourseName">Loading...</span>
            </div>
        </div>
        <div class="header-right">
            <div class="icon-btn" onclick="toggleDarkMode()"><i class="fa-solid fa-moon" id="themeIcon"></i></div>
            <div class="icon-btn" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i></div>
            <img src="logo.png" alt="KAC" class="kac-logo">
        </div>
    </header>

    <div class="container">
        <div class="mode-tabs">
            <div class="mode-tab active" id="tab-qa" onclick="switchMode('qa')"><i class="fa-regular fa-comments"></i> Q&A Mode</div>
            <div class="mode-tab" id="tab-quiz" onclick="switchMode('quiz')"><i class="fa-solid fa-clipboard-question"></i> Quiz Mode</div>
        </div>

        <!-- 1. Q&A View -->
        <div id="view-qa" class="view-active">
            <div id="qListArea"></div>
        </div>

        <!-- 2. Quiz View -->
        <div id="view-quiz">
            <div class="quiz-container">
                <div class="quiz-sidebar">
                    <button class="btn-action btn-dark" onclick="openQuizEditor()">+ New Question (Î¨∏Ï†úÎì±Î°ù)</button>
                    <div class="quiz-list-box" id="quizListArea"></div>
                </div>
                
                <div class="quiz-stage-wrapper">
                    <div class="nav-arrow" onclick="navQuiz(-1)"><i class="fa-solid fa-chevron-left"></i></div>
                    
                    <div class="quiz-card-main" id="quizStage">
                        <div id="quizEmptyMsg" style="color:#888; font-size:20px;">Î¨∏Ï†úÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.<br>Select a question.</div>
                        
                        <div id="quizContent" style="display:none; width:100%; flex-direction:column; align-items:center;">
                            <div class="quiz-question-text quiz-question-display" id="stageQuestion"></div>
                            
                            <!-- Options (Vertical) -->
                            <div class="quiz-options-list" id="stageOptions"></div>

                            <div class="quiz-controls">
                                <button class="btn-control btn-open" onclick="openQuiz()"><i class="fa-solid fa-paper-plane"></i> Î∞∞Ìè¨ (Open)</button>
                                <button class="btn-control btn-close" onclick="closeQuiz()"><i class="fa-solid fa-lock"></i> ÎßàÍ∞ê (Close)</button>
                                <button class="btn-control btn-result" onclick="showResult()"><i class="fa-solid fa-chart-simple"></i> Í≤∞Í≥º (Result)</button>
                            </div>

                            <!-- Result Overlay -->
                            <div class="result-overlay" id="resultOverlay">
                                <h2 style="margin-bottom:40px; color:#333;">Result Analysis</h2>
                                <div class="chart-container" id="chartBox"></div>
                                <button class="btn-action btn-dark" style="width:auto;" onclick="hideResult()">Close Result</button>
                            </div>
                        </div>
                    </div>

                    <div class="nav-arrow" onclick="navQuiz(1)"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer" id="mainFooter">
        Î≥∏ ÏõπÏÇ¨Ïù¥Ìä∏Îäî KAC Ìï≠Í≥µÍ∏∞Ïà†ÌõàÎ†®Ïõê ÍµêÏú°Í¥ÄÎ†® Q&AÌîåÎû´ÌèºÏûÖÎãàÎã§.<br>
        Î¨∏Ïùò Ïù¥Î©îÏùº : jds0616@airport.co.kr (Developed by DooSeok, Jang)<br>
        ¬© 2026 Korea Airports Corporation. All rights reserved.
    </div>

    <!-- Sidebar (Restored) -->
    <div class="sidebar" id="sidebar">
        <div class="sb-header">Settings <span style="cursor:pointer" onclick="toggleSidebar()">‚úï</span></div>
        
        <div class="setting-group">
            <label class="setting-label">Select Course Room</label>
            <select id="roomSelect" class="setting-input" onchange="changeRoom(this.value)"></select>
        </div>

        <div class="setting-group">
            <label class="setting-label">Course Mode (Í≥ºÏ†ï Î™®Îìú)</label>
            <div class="radio-group">
                <label class="radio-label"><input type="radio" name="courseMode" value="continue" checked> Ïù¥Ïñ¥ÏÑú ÏßÑÌñâ</label>
                <label class="radio-label"><input type="radio" name="courseMode" value="new"> Ïã†Í∑ú Í∞úÏÑ§ (Ï¥àÍ∏∞Ìôî)</label>
            </div>

            <label class="setting-label">Course Name</label>
            <input type="text" id="confName" class="setting-input" placeholder="Í≥ºÏ†ïÎ™Ö ÏûÖÎ†•">
            
            <label class="setting-label">Room Password (4 Digits)</label>
            <div class="pw-grid">
                <input type="password" id="confPw" class="setting-input" placeholder="ÎπÑÎ≤à" maxlength="4">
                <input type="password" id="confPwConfirm" class="setting-input" placeholder="ÌôïÏù∏" maxlength="4">
            </div>

            <label class="setting-label">Theme Color</label>
            <div class="color-grid" id="colorGrid"></div>
            <input type="hidden" id="confColor" value="#3b82f6">

            <label class="setting-label">Language Mode (ÍµêÏú°ÏÉù ÌôîÎ©¥)</label>
            <select id="confLang" class="setting-input">
                <option value="ko">ÌïúÍµ≠Ïñ¥ (Korean)</option>
                <option value="en">ÏòÅÏñ¥ (English)</option>
            </select>

            <label class="setting-label">Footer Text</label>
            <textarea id="confFooter" class="setting-input" style="height:100px;" placeholder="ÌïòÎã® Î¨∏Íµ¨..."></textarea>
            
            <button class="btn-action btn-blue" onclick="handleSaveConfig()">Save Config</button>
        </div>
        
        <!-- Super Admin Zone -->
        <div class="setting-group" id="superAdminZone" style="display:none; border:1px solid #d63384;">
            <label class="setting-label" style="color:#d63384;">Super Admin</label>
            <input type="password" id="ghToken" class="setting-input" placeholder="GitHub Token">
            <button class="btn-action btn-dark" onclick="saveGithubInfo()">Save Token</button>
            <button class="btn-action btn-green" onclick="uploadToGithub()">Backup to GitHub</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="detailModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-box">
            <h3>Q&A Detail</h3>
            <div id="modalText" style="font-size:18px; margin:20px 0; background:#f9f9f9; padding:15px; border-radius:8px; color:#333;"></div>
            <textarea id="adminMemo" style="width:100%; height:80px; padding:10px; margin-bottom:10px;" placeholder="Memo..."></textarea>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                <button class="btn-action btn-dark" onclick="setQaStatus('pin')">üìå Pin</button>
                <button class="btn-action btn-dark" onclick="setQaStatus('done')">‚úÖ Done</button>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <button class="btn-action btn-red" style="width:auto;" onclick="deleteQa()">Delete</button>
                <button class="btn-action btn-blue" style="width:auto;" onclick="saveQa()">Save</button>
            </div>
        </div>
    </div>

    <div id="quizEditModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Î¨∏Ï†ú Îì±Î°ù/ÏàòÏ†ï</h3>
            <input type="hidden" id="editQuizId">
            <input type="text" id="editQText" class="setting-input" placeholder="ÏßàÎ¨∏ ÎÇ¥Ïö©">
            <div class="option-row"><input type="radio" name="correct" value="1"><input type="text" id="opt1" class="setting-input" placeholder="Î≥¥Í∏∞ 1Î≤à"></div>
            <div class="option-row"><input type="radio" name="correct" value="2"><input type="text" id="opt2" class="setting-input" placeholder="Î≥¥Í∏∞ 2Î≤à"></div>
            <div class="option-row"><input type="radio" name="correct" value="3"><input type="text" id="opt3" class="setting-input" placeholder="Î≥¥Í∏∞ 3Î≤à"></div>
            <div class="option-row"><input type="radio" name="correct" value="4"><input type="text" id="opt4" class="setting-input" placeholder="Î≥¥Í∏∞ 4Î≤à"></div>
            <div style="margin-top:20px; display:flex; justify-content:space-between;">
                <button class="btn-action btn-red" style="width:auto;" onclick="deleteQuiz()">ÏÇ≠Ï†ú</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn-action btn-dark" style="width:auto;" onclick="document.getElementById('quizEditModal').style.display='none'">Ï∑®ÏÜå</button>
                    <button class="btn-action btn-blue" style="width:auto;" onclick="saveQuiz()">Ï†ÄÏû•</button>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let currentRoom = "A", dbRef = {};
        let currentData = {}, quizData = {}, activeQuizId = null, activeQaId = null;
        const PRESET_COLORS = ["#f44336", "#e91e63", "#9c27b0", "#673ab7", "#3f51b5", "#2196f3", "#03a9f4", "#00bcd4", "#009688", "#4caf50", "#8bc34a", "#ffeb3b", "#ff9800", "#ff5722", "#795548", "#607d8b"];

        window.onload = function() {
            initRoomSelector(); initColorPicker(); loadRoom("A");
            const session = JSON.parse(localStorage.getItem('kac_admin_session'));
            if(session && session.role === 'super_admin') document.getElementById('superAdminZone').style.display='block';
        };

        function initRoomSelector() {
            const s = document.getElementById('roomSelect');
            for(let i=65;i<=90;i++) s.innerHTML += `<option value="${String.fromCharCode(i)}">Course ${String.fromCharCode(i)}</option>`;
        }
        function initColorPicker() {
            const g = document.getElementById('colorGrid');
            PRESET_COLORS.forEach(c => {
                const d = document.createElement('div'); d.className='color-swatch'; d.style.background=c;
                d.onclick = () => { document.getElementById('confColor').value=c; document.querySelectorAll('.color-swatch').forEach(x=>x.classList.remove('selected')); d.classList.add('selected'); };
                g.appendChild(d);
            });
        }

        function changeRoom(r) { currentRoom=r; loadRoom(r); }
        function loadRoom(r) {
            if(dbRef.qa) dbRef.qa.off(); if(dbRef.quiz) dbRef.quiz.off();
            dbRef.qa = firebase.database().ref(`courses/${r}/questions`);
            dbRef.quiz = firebase.database().ref(`courses/${r}/quizzes`);
            dbRef.settings = firebase.database().ref(`courses/${r}/settings`);
            dbRef.status = firebase.database().ref(`courses/${r}/status`); // Sync Mode

            dbRef.settings.on('value', s => {
                const v = s.val() || {};
                document.getElementById('displayCourseName').innerText = v.courseName || `Course ${r}`;
                document.getElementById('mainHeader').style.borderBottomColor = v.themeColor || '#3b82f6';
                document.documentElement.style.setProperty('--accent-color', v.themeColor || '#3b82f6');
                document.documentElement.style.setProperty('--navy-border', v.themeColor || '#1a237e');
                
                document.getElementById('confName').value = v.courseName || "";
                document.getElementById('confColor').value = v.themeColor || "#3b82f6";
                document.getElementById('confFooter').value = v.footerText || "";
                document.getElementById('confLang').value = v.language || "ko";
            });

            dbRef.qa.on('value', s => {
                const d = s.val(); window.currentQaData = d;
                const div = document.getElementById('qListArea'); div.innerHTML = "";
                if(!d) { div.innerHTML="<p style='text-align:center; padding:30px; color:#888;'>ÏßàÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.</p>"; return; }
                Object.keys(d).forEach(k => {
                    const item = d[k];
                    const badge = item.status==='pin'?'<span style="color:red">[NOTICE]</span> ':'';
                    const cls = item.status==='done'?'state-done':(item.status==='pin'?'state-notice':'');
                    div.innerHTML += `<div class="q-card ${cls}" onclick="openQaModal('${k}')"><div style="font-size:18px;">${badge}${escapeHtml(item.text)}</div><div style="font-size:12px; color:#888;">${new Date(item.timestamp).toLocaleTimeString()}</div></div>`;
                });
            });

            dbRef.quiz.on('value', s => {
                quizData = s.val() || {};
                const div = document.getElementById('quizListArea'); div.innerHTML = "";
                Object.keys(quizData).forEach(k => {
                    const q = quizData[k];
                    const cls = q.status==='finished'?'completed':'';
                    const icon = q.status==='finished'?'<i class="fa-solid fa-check-circle"></i>':'<i class="fa-regular fa-circle"></i>';
                    div.innerHTML += `<div class="quiz-item ${cls}" id="qi_${k}" onclick="selectQuiz('${k}')"><span>${icon} Q. ${q.text.substring(0,10)}...</span></div>`;
                });
            });
        }

        // Mode Switching (Sync with Students)
        function switchMode(mode) {
            document.querySelectorAll('.mode-tab').forEach(t=>t.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            document.getElementById('view-qa').style.display = (mode=='qa'?'block':'none');
            document.getElementById('view-quiz').style.display = (mode=='quiz'?'block':'none');
            
            // Sync to DB
            firebase.database().ref(`courses/${currentRoom}/status/mode`).set(mode);
        }

        function selectQuiz(k) {
            activeQuizId = k;
            const q = quizData[k];
            document.querySelectorAll('.quiz-item').forEach(x=>x.classList.remove('active'));
            if(document.getElementById(`qi_${k}`)) document.getElementById(`qi_${k}`).classList.add('active');

            document.getElementById('quizContent').style.display='flex';
            document.getElementById('quizEmptyMsg').style.display='none';
            document.getElementById('stageQuestion').innerText = `Q. ${q.text}`;
            
            // Reset View
            document.getElementById('resultOverlay').style.display='none';
            
            const optDiv = document.getElementById('stageOptions'); optDiv.innerHTML="";
            q.options.forEach((opt, i) => {
                optDiv.innerHTML += `<div class="quiz-option-row" id="qopt_${i+1}"><div class="opt-num">${i+1}</div>${opt}</div>`;
            });
        }

        function navQuiz(dir) {
            const keys = Object.keys(quizData);
            if(keys.length === 0) return;
            let idx = keys.indexOf(activeQuizId);
            if(idx === -1) idx = 0;
            else idx += dir;
            
            if(idx >= 0 && idx < keys.length) selectQuiz(keys[idx]);
        }

        // Quiz Control
        function openQuiz() {
            if(!activeQuizId) return;
            if(confirm("Î¨∏Ï†úÎ•º Î∞∞Ìè¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå? (ÌïôÏÉù ÌôîÎ©¥ Ï†ÑÌôò)")) {
                firebase.database().ref(`courses/${currentRoom}/activeQuiz`).set({ id: activeQuizId, timestamp: Date.now() });
                dbRef.quiz.child(activeQuizId).update({ status: 'active' });
                alert("Î¨∏Ï†ú Î∞∞Ìè¨ ÏôÑÎ£å.");
            }
        }

        function closeQuiz() {
            if(confirm("Ï†ëÏàòÎ•º ÎßàÍ∞êÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                firebase.database().ref(`courses/${currentRoom}/activeQuiz`).set(null);
                dbRef.quiz.child(activeQuizId).update({ status: 'closed' });
                alert("Ï†ëÏàò ÎßàÍ∞ê ÏôÑÎ£å.");
            }
        }

        function showResult() {
            document.getElementById('resultOverlay').style.display='flex';
            const box = document.getElementById('chartBox'); box.innerHTML = "Loading...";
            const correctAns = quizData[activeQuizId].correct;

            // Highlight Correct Answer
            document.querySelectorAll('.quiz-option-row').forEach(r => r.classList.remove('reveal-correct'));
            document.getElementById(`qopt_${correctAns}`).classList.add('reveal-correct');

            firebase.database().ref(`courses/${currentRoom}/quiz_answers/${activeQuizId}`).once('value', s => {
                const answers = s.val();
                const counts = [0,0,0,0];
                if(answers) Object.values(answers).forEach(a => { if(a.choice >=1 && a.choice<=4) counts[a.choice-1]++; });
                
                box.innerHTML = "";
                const max = Math.max(...counts, 1);
                counts.forEach((c, i) => {
                    const h = (c/max)*100;
                    const isWinner = (i+1) == correctAns;
                    const colorClass = isWinner ? 'bar winner' : 'bar';
                    box.innerHTML += `<div class="bar-wrap"><div class="bar-val">${c}</div><div class="${colorClass}" style="height:${h}%;"></div><div class="bar-lbl">${i+1}Î≤à</div></div>`;
                });
                dbRef.quiz.child(activeQuizId).update({ status: 'finished' });
            });
        }
        function hideResult() { document.getElementById('resultOverlay').style.display='none'; }

        // Settings Save
        function handleSaveConfig() {
            const mode = document.querySelector('input[name="courseMode"]:checked').value;
            const name = document.getElementById('confName').value;
            const color = document.getElementById('confColor').value;
            const footer = document.getElementById('confFooter').value;
            const lang = document.getElementById('confLang').value;

            const updates = { courseName: name, themeColor: color, footerText: footer, language: lang };
            
            dbRef.settings.update(updates).then(() => {
                if(mode === 'new') {
                    if(confirm("Ï†ïÎßê Ï¥àÍ∏∞Ìôî ÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Î™®Îì† ÏßàÎ¨∏ ÏÇ≠Ï†ú)")) {
                        dbRef.qa.set(null);
                        alert("Ï¥àÍ∏∞Ìôî Î∞è Ï†ÄÏû• ÏôÑÎ£å");
                    }
                } else {
                    alert("Ï†ÄÏû• ÏôÑÎ£å");
                }
            });
        }

        // Quiz CRUD
        function openQuizEditor() { document.getElementById('quizEditModal').style.display='flex'; }
        function saveQuiz() {
            const txt = document.getElementById('editQText').value;
            const opts = [1,2,3,4].map(i=>document.getElementById('opt'+i).value);
            const cor = document.querySelector('input[name="correct"]:checked')?.value;
            if(!txt || !cor) return alert("ÏûÖÎ†• ÌôïÏù∏");
            const id = dbRef.quiz.push().key;
            dbRef.quiz.child(id).set({ text: txt, options: opts, correct: cor, status: 'ready' });
            document.getElementById('quizEditModal').style.display='none';
        }
        function deleteQuiz() {
            const id = document.getElementById('editQuizId').value;
            if(id && confirm("ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) dbRef.quiz.child(id).remove();
            document.getElementById('quizEditModal').style.display='none';
        }

        // Q&A Modal
        function openQaModal(key) {
            activeQaId = key;
            const item = window.currentQaData[key];
            document.getElementById('modalText').innerText = item.text;
            document.getElementById('adminMemo').value = item.memo || "";
            document.getElementById('detailModal').style.display='flex';
        }
        function saveQa() {
            const memo = document.getElementById('adminMemo').value;
            dbRef.qa.child(activeQaId).update({ memo: memo });
            document.getElementById('detailModal').style.display='none';
        }
        function deleteQa() { if(confirm("ÏÇ≠Ï†ú?")) dbRef.qa.child(activeQaId).remove(); document.getElementById('detailModal').style.display='none'; }
        function setQaStatus(st) { dbRef.qa.child(activeQaId).update({ status: st }); document.getElementById('detailModal').style.display='none'; }

        function closeModal(e) { if(e.target.className.includes('modal-overlay')) e.target.style.display='none'; }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
        function logout() { localStorage.removeItem('kac_admin_session'); location.replace('login.html'); }
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
        function escapeHtml(t) { return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }
        function saveGithubInfo() { alert("Saved Locally."); }
        function uploadToGithub() { alert("Backup feature not configured."); }
    </script>
</body>
</html>