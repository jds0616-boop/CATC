<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Platform - CATC</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #333;
            --header-bg: #1a237e; --sidebar-bg: #212529; --sidebar-text: #e9ecef;
            --accent-color: #3b82f6;
        }
        body.dark-mode { --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --header-bg: #0d1b2a; }
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-color); overflow-x: hidden; transition: background 0.3s; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 0 30px; height: 70px; background: var(--header-bg); color: #fff; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-bottom: 5px solid transparent; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .header-title { font-size: 20px; font-weight: 700; display:flex; align-items: center; gap:10px;}
        .course-name-text { font-size: 20px; font-weight: 400; color: #fff; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .icon-btn { font-size: 20px; cursor: pointer; color: rgba(255,255,255,0.7); padding: 5px; }
        .kac-logo { height: 28px; object-fit: contain; margin-left: 10px; }

        /* Container */
        .container { padding: 20px 40px; max-width: 1400px; margin: 0 auto; min-height: 80vh; }
        .mode-tabs { display: flex; justify-content: center; margin-top: 20px; gap: 10px; }
        .mode-tab { padding: 10px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; background: rgba(0,0,0,0.1); transition: 0.2s; }
        .mode-tab.active { background: var(--accent-color); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #view-qa, #view-quiz { display: none; }
        .view-active { display: block !important; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }

        /* Quiz Layout (Vertical) */
        .quiz-container { display: flex; gap: 20px; height: 70vh; margin-top: 20px; }
        .quiz-sidebar { width: 300px; background: var(--card-bg); border-radius: 12px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
        .quiz-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; margin-bottom: 5px; }
        .quiz-item.active { background: var(--accent-color); color: white; }
        
        .quiz-stage { flex-grow: 1; background: var(--card-bg); border-radius: 12px; padding: 40px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .quiz-question-text { font-size: 28px; font-weight: 800; margin-bottom: 30px; line-height: 1.4; text-align: center; }
        
        /* Updated Quiz Options (Vertical) */
        .quiz-options { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 800px; }
        .quiz-option { 
            display: flex; align-items: center; padding: 15px 20px; 
            border: 2px solid #eee; border-radius: 50px; 
            font-size: 20px; font-weight: 500; color: var(--text-color); transition: 0.2s;
        }
        .opt-icon {
            width: 36px; height: 36px; background: #eee; color: #555;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 16px; margin-right: 15px; flex-shrink: 0;
        }
        .quiz-option.correct { border-color: #10b981; color: #10b981; background: #f0fdf4; }
        .quiz-option.correct .opt-icon { background: #10b981; color: white; }

        .quiz-controls { margin-top: 40px; display: flex; gap: 15px; }
        .btn-quiz { padding: 12px 30px; font-size: 16px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; gap: 8px;}
        .btn-start { background: #2563eb; } .btn-stop { background: #d32f2f; } .btn-result { background: #10b981; }

        /* Sidebar Settings (Fixed) */
        .sidebar { position: fixed; top: 0; left: 0; width: 450px; height: 100%; background: var(--sidebar-bg); color: var(--sidebar-text); transform: translateX(-100%); transition: 0.3s; z-index: 200; padding: 25px; overflow-y: auto; box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
        .sidebar.active { transform: translateX(0); }
        .setting-group { margin-bottom: 25px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; }
        .setting-label { font-size: 12px; color: #adb5bd; margin-bottom: 8px; display: block; font-weight: 700; text-transform: uppercase; }
        .setting-input { width: 100%; padding: 10px; background: #343a40; border: 1px solid #495057; color: white; border-radius: 4px; margin-bottom: 10px; }
        
        /* Restored Elements */
        .radio-group { display: flex; gap: 15px; margin-bottom: 10px; }
        .radio-label { display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer; }
        .pw-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .color-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; margin-bottom: 10px; }
        .color-swatch { width: 100%; aspect-ratio: 1; border-radius: 4px; cursor: pointer; border: 2px solid transparent; }
        .color-swatch.selected { border-color: white; transform: scale(1.1); box-shadow: 0 0 0 2px #3b82f6; }

        /* Chart */
        .chart-overlay { position: absolute; top:0; left:0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 10; border-radius: 12px; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .dark-mode .chart-overlay { background: rgba(30,30,30,0.98); }
        .chart-box { display: flex; align-items: flex-end; gap: 40px; height: 300px; padding-bottom: 10px; border-bottom: 2px solid #ccc; }
        .bar-col { display: flex; flex-direction: column; align-items: center; }
        .bar { width: 50px; background: #3b82f6; border-radius: 5px 5px 0 0; transition: height 1s; }

        /* Q&A Cards */
        .q-list { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .q-card { background: var(--card-bg); border-radius: 10px; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #ccc; cursor: pointer; }
        
        .btn-action { width: 100%; padding: 10px; border-radius: 4px; border:none; cursor: pointer; font-weight: bold; margin-bottom: 5px; color:white; }
        .btn-blue { background: #2563eb; } .btn-red { background: #ef4444; } .btn-dark { background: #495057; }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 500; justify-content: center; align-items: center; }
        .modal-box { background: var(--card-bg); padding: 30px; border-radius: 12px; width: 600px; max-width: 95%; color: var(--text-color); }
    </style>
</head>
<body>

    <header class="header" id="mainHeader">
        <div class="header-left">
            <div class="icon-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>
            <div class="header-title">
                CATC Training Platform <span style="margin:0 10px; opacity:0.5;">|</span> 
                <span class="course-name-text" id="displayCourseName">Loading...</span>
            </div>
        </div>
        <div class="header-right">
            <div class="icon-btn" onclick="toggleDarkMode()"><i class="fa-solid fa-moon" id="themeIcon"></i></div>
            <div class="icon-btn" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i></div>
            <img src="logo.png" alt="KAC" class="kac-logo">
        </div>
    </header>

    <div class="container">
        <div class="mode-tabs">
            <div class="mode-tab active" id="tab-qa" onclick="switchView('qa')"><i class="fa-regular fa-comments"></i> Q&A Mode</div>
            <div class="mode-tab" id="tab-quiz" onclick="switchView('quiz')"><i class="fa-solid fa-clipboard-question"></i> Quiz Mode</div>
        </div>

        <div id="view-qa" class="view-active">
            <div id="qListArea" class="q-list"></div>
        </div>

        <div id="view-quiz">
            <div class="quiz-container">
                <div class="quiz-sidebar">
                    <button class="btn-action btn-dark" onclick="openQuizEditor()">+ New Question</button>
                    <div id="quizListArea"></div>
                </div>
                <div class="quiz-stage">
                    <div id="quizEmptyMsg" style="color:#888;">문제를 선택하세요.</div>
                    <div id="quizContent" style="display:none; width:100%; display:flex; flex-direction:column; align-items:center;">
                        <div class="quiz-question-text" id="stageQuestion"></div>
                        <div class="quiz-options" id="stageOptions"></div>
                        <div class="quiz-controls">
                            <button class="btn-quiz btn-start" onclick="startQuiz()"><i class="fa-solid fa-play"></i> Start</button>
                            <button class="btn-quiz btn-stop" onclick="stopQuiz()"><i class="fa-solid fa-stop"></i> Stop</button>
                            <button class="btn-quiz btn-result" onclick="showResult()"><i class="fa-solid fa-chart-simple"></i> Result</button>
                        </div>
                        <div class="chart-overlay" id="chartOverlay">
                            <h2 style="color:#333; margin-bottom:30px;">Result Analysis</h2>
                            <div class="chart-box" id="chartBox"></div>
                            <button class="btn-action btn-dark" style="width:auto; margin-top:20px;" onclick="closeResult()">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Settings (Restored) -->
    <div class="sidebar" id="sidebar">
        <div class="sb-header">Settings <span style="cursor:pointer" onclick="toggleSidebar()">✕</span></div>
        
        <div class="setting-group">
            <label class="setting-label">Select Course Room</label>
            <select id="roomSelect" class="setting-input" onchange="changeRoom(this.value)"></select>
        </div>

        <div class="setting-group">
            <label class="setting-label">Course Mode</label>
            <div class="radio-group">
                <label class="radio-label"><input type="radio" name="courseMode" value="continue" checked> 이어서 진행</label>
                <label class="radio-label"><input type="radio" name="courseMode" value="new"> 신규 개설 (초기화)</label>
            </div>

            <label class="setting-label">Course Name</label>
            <input type="text" id="confName" class="setting-input" placeholder="과정명 입력">
            
            <label class="setting-label">Room Password (4 Digits)</label>
            <div class="pw-grid">
                <input type="password" id="confPw" class="setting-input" placeholder="비번" maxlength="4">
                <input type="password" id="confPwConfirm" class="setting-input" placeholder="확인" maxlength="4">
            </div>

            <label class="setting-label">Theme Color</label>
            <div class="color-grid" id="colorGrid"></div>
            <input type="hidden" id="confColor" value="#3b82f6">

            <label class="setting-label">Footer Text</label>
            <textarea id="confFooter" class="setting-input" style="height:100px;" placeholder="하단 문구..."></textarea>
            
            <button class="btn-action btn-blue" onclick="handleSaveConfig()">Save Config</button>
        </div>
        
        <!-- Super Admin Zone -->
        <div class="setting-group" id="superAdminZone" style="display:none; border:1px solid #d63384;">
            <label class="setting-label" style="color:#d63384;">Super Admin</label>
            <input type="password" id="ghToken" class="setting-input" placeholder="GitHub Token">
            <button class="btn-action btn-dark" onclick="saveGithubInfo()">Save Token</button>
            <button class="btn-action btn-green" onclick="uploadToGithub()">Backup to GitHub</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="quizEditModal" class="modal-overlay">
        <div class="modal-box">
            <h3>문제 등록/수정</h3>
            <input type="hidden" id="editQuizId">
            <input type="text" id="editQText" class="setting-input" placeholder="질문 내용을 입력하세요">
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
                <div style="display:flex; align-items:center; gap:10px;"><input type="radio" name="correct" value="1"><input type="text" id="opt1" class="setting-input" placeholder="보기 1번"></div>
                <div style="display:flex; align-items:center; gap:10px;"><input type="radio" name="correct" value="2"><input type="text" id="opt2" class="setting-input" placeholder="보기 2번"></div>
                <div style="display:flex; align-items:center; gap:10px;"><input type="radio" name="correct" value="3"><input type="text" id="opt3" class="setting-input" placeholder="보기 3번"></div>
                <div style="display:flex; align-items:center; gap:10px;"><input type="radio" name="correct" value="4"><input type="text" id="opt4" class="setting-input" placeholder="보기 4번"></div>
            </div>
            <div style="margin-top:20px; display:flex; justify-content:space-between;">
                <button class="btn-action btn-red" style="width:auto;" onclick="deleteQuiz()">삭제</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn-action btn-dark" style="width:auto;" onclick="document.getElementById('quizEditModal').style.display='none'">취소</button>
                    <button class="btn-action btn-blue" style="width:auto;" onclick="saveQuiz()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let currentRoom = "A", dbRef = {};
        let currentData = {}, quizData = {}, activeQuizId = null;
        
        const PRESET_COLORS = ["#f44336", "#e91e63", "#9c27b0", "#673ab7", "#3f51b5", "#2196f3", "#03a9f4", "#00bcd4", "#009688", "#4caf50", "#8bc34a", "#ffeb3b", "#ff9800", "#ff5722", "#795548", "#607d8b"];

        window.onload = function() {
            initRoomSelector();
            initColorPicker();
            loadRoom("A");
            
            // Super Admin Check
            const session = JSON.parse(localStorage.getItem('kac_admin_session'));
            if(session && session.role === 'super_admin') document.getElementById('superAdminZone').style.display='block';
        };

        function initRoomSelector() {
            const s = document.getElementById('roomSelect');
            for(let i=65;i<=90;i++) s.innerHTML += `<option value="${String.fromCharCode(i)}">Course ${String.fromCharCode(i)}</option>`;
        }

        function initColorPicker() {
            const g = document.getElementById('colorGrid');
            PRESET_COLORS.forEach(c => {
                const d = document.createElement('div'); d.className='color-swatch'; d.style.background=c;
                d.onclick = () => { document.getElementById('confColor').value=c; document.querySelectorAll('.color-swatch').forEach(x=>x.classList.remove('selected')); d.classList.add('selected'); };
                g.appendChild(d);
            });
        }

        function changeRoom(r) { currentRoom=r; loadRoom(r); }
        function loadRoom(r) {
            if(dbRef.qa) dbRef.qa.off(); if(dbRef.quiz) dbRef.quiz.off();
            dbRef.qa = firebase.database().ref(`courses/${r}/questions`);
            dbRef.quiz = firebase.database().ref(`courses/${r}/quizzes`);
            dbRef.settings = firebase.database().ref(`courses/${r}/settings`);

            dbRef.settings.on('value', s => {
                const v = s.val() || {};
                document.getElementById('displayCourseName').innerText = v.courseName || `Course ${r}`;
                document.getElementById('mainHeader').style.borderBottomColor = v.themeColor || '#3b82f6';
                document.documentElement.style.setProperty('--accent-color', v.themeColor || '#3b82f6');
                document.getElementById('confName').value = v.courseName || "";
                document.getElementById('confColor').value = v.themeColor || "#3b82f6";
                document.getElementById('confFooter').value = v.footerText || "";
            });

            dbRef.qa.on('value', s => {
                const d = s.val();
                const div = document.getElementById('qListArea'); div.innerHTML = "";
                if(!d) { div.innerHTML="<p style='text-align:center; padding:30px; color:#888;'>질문이 없습니다.</p>"; return; }
                Object.keys(d).forEach(k => {
                    div.innerHTML += `<div class="q-card"><div class="q-text">${d[k].text}</div></div>`;
                });
            });

            dbRef.quiz.on('value', s => {
                quizData = s.val() || {};
                const div = document.getElementById('quizListArea'); div.innerHTML = "";
                Object.keys(quizData).forEach(k => {
                    const q = quizData[k];
                    div.innerHTML += `<div class="quiz-item" onclick="selectQuiz('${k}')"><span>Q. ${q.text.substring(0,10)}...</span></div>`;
                });
            });
        }

        function selectQuiz(k) {
            activeQuizId = k;
            const q = quizData[k];
            document.getElementById('quizContent').style.display='flex';
            document.getElementById('quizEmptyMsg').style.display='none';
            document.getElementById('stageQuestion').innerText = q.text;
            
            const optDiv = document.getElementById('stageOptions'); optDiv.innerHTML="";
            q.options.forEach((opt, i) => {
                const isCorrect = (i+1 == q.correct); // 강사니까 정답 표시 가능
                optDiv.innerHTML += `<div class="quiz-option"><div class="opt-icon">${i+1}</div>${opt}</div>`;
            });
        }

        function startQuiz() {
            if(!activeQuizId) return;
            if(confirm("문제를 출제하시겠습니까? (교육생 화면 전환)")) {
                firebase.database().ref(`courses/${currentRoom}/activeQuiz`).set({ id: activeQuizId, timestamp: Date.now() });
                alert("출제 완료.");
            }
        }

        function stopQuiz() {
            if(confirm("설문을 종료하시겠습니까?")) {
                firebase.database().ref(`courses/${currentRoom}/activeQuiz`).set(null);
                alert("종료 완료.");
            }
        }

        function showResult() {
            // 차트 표시 로직 (데모 데이터)
            document.getElementById('chartOverlay').style.display='flex';
            const box = document.getElementById('chartBox'); box.innerHTML = "";
            const counts = [5, 12, 3, 8]; // 실제로는 DB quiz_answers에서 카운트해야 함
            const max = Math.max(...counts);
            counts.forEach((c, i) => {
                const h = (c/max)*100;
                box.innerHTML += `<div class="bar-col"><div style="font-weight:bold; margin-bottom:5px;">${c}</div><div class="bar" style="height:${h}%;"></div><div style="margin-top:10px; font-weight:bold;">${i+1}번</div></div>`;
            });
        }
        function closeResult() { document.getElementById('chartOverlay').style.display='none'; }

        // Settings Save
        function handleSaveConfig() {
            const mode = document.querySelector('input[name="courseMode"]:checked').value;
            const name = document.getElementById('confName').value;
            const pw = document.getElementById('confPw').value;
            const color = document.getElementById('confColor').value;
            const footer = document.getElementById('confFooter').value;

            // Password Hash Logic skipped for brevity, add back if needed
            
            dbRef.settings.update({ courseName: name, themeColor: color, footerText: footer }).then(() => {
                if(mode === 'new') {
                    if(confirm("정말 초기화 하시겠습니까? (질문 데이터 삭제)")) {
                        dbRef.qa.set(null);
                        dbRef.quiz.set(null); // 퀴즈도 초기화 할지 선택
                        alert("초기화 및 저장 완료");
                    }
                } else {
                    alert("저장 완료");
                }
            });
        }

        // Quiz Editor
        function openQuizEditor() { document.getElementById('quizEditModal').style.display='flex'; }
        function saveQuiz() {
            const txt = document.getElementById('editQText').value;
            const opts = [1,2,3,4].map(i=>document.getElementById('opt'+i).value);
            const cor = document.querySelector('input[name="correct"]:checked')?.value;
            if(!txt || !cor) return alert("입력 확인");
            const id = dbRef.quiz.push().key;
            dbRef.quiz.child(id).set({ text: txt, options: opts, correct: cor });
            document.getElementById('quizEditModal').style.display='none';
        }

        function switchView(v) {
            document.getElementById('view-qa').style.display = (v=='qa'?'block':'none');
            document.getElementById('view-quiz').style.display = (v=='quiz'?'block':'none');
            document.getElementById('tab-qa').className = (v=='qa'?'mode-tab active':'mode-tab');
            document.getElementById('tab-quiz').className = (v=='quiz'?'mode-tab active':'mode-tab');
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
        function logout() { localStorage.removeItem('kac_admin_session'); location.replace('login.html'); }
    </script>
</body>
</html>