<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - KAC Platform</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
  @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
  * { box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
  body { 
    background: #0f172a; height: 100vh; display: flex; flex-direction: column; 
    align-items: center; justify-content: center; margin: 0; color: #fff;
  }
  .login-card {
    background: #1e293b; padding: 50px 40px; border-radius: 20px; width: 400px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-align: center;
    border: 1px solid rgba(255,255,255,0.1);
  }
  .logo { font-size: 26px; font-weight: 800; margin-bottom: 10px; display: block; letter-spacing: -0.5px; }
  .logo span { color: #3b82f6; }
  .sub-title { font-size: 16px; color: #94a3b8; margin-bottom: 30px; }
  
  input {
    width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #334155;
    background: #0f172a; color: #fff; margin-bottom: 15px; font-size: 16px; outline: none;
    text-align: center; letter-spacing: 4px; transition: 0.3s;
  }
  input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
  
  button {
    width: 100%; padding: 15px; border-radius: 10px; border: none;
    background: #3b82f6; color: #fff; font-size: 16px; font-weight: 700;
    cursor: pointer; transition: 0.3s; margin-top: 10px;
  }
  button:hover { background: #2563eb; transform: translateY(-2px); }
  
  .message { margin-top: 20px; font-size: 14px; min-height: 20px; color: #ef4444; }
</style>
</head>
<body>
  <div class="login-card">
    <div class="logo">KAC <span>Q&A</span> Platform</div>
    <div class="sub-title">강사 및 관리자 접속</div>
    
    <input type="password" id="pwInput" placeholder="PASSWORD" maxlength="4" onkeyup="if(window.event.keyCode==13){tryLogin()}">
    <button onclick="tryLogin()">Login</button>
    <div id="msg" class="message"></div>
  </div>

  <!-- Config JS 연결 (필수) -->
  <script src="config.js"></script>
  
  <script>
    const SESSION_DURATION = 5 * 60 * 60 * 1000; // 5시간
    
    // 기본 해시값 (DB에 값이 없을 때 작동할 안전장치)
    // 1234
    const DEFAULT_INST = "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4"; 
    // 9999
    const DEFAULT_ADMIN = "863339c089945df81f7c320875e53313337946955a5078505c8686e0c704c77f"; 

    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function tryLogin() {
        const input = document.getElementById('pwInput').value;
        const msgBox = document.getElementById('msg');
        
        if(!input) { msgBox.textContent = "비밀번호를 입력하세요."; return; }
        
        // config.js 연결 확인
        if (typeof firebase === 'undefined') { 
            msgBox.textContent = "DB 연결 실패. config.js 파일을 확인하세요."; 
            return; 
        }

        msgBox.style.color = "#94a3b8";
        msgBox.textContent = "확인 중...";

        try {
            // 1. 입력값 암호화
            const inputHash = await sha256(input);

            // 2. DB에서 저장된 비밀번호 가져오기 (없으면 null 반환)
            let dbPass = {};
            try {
                const snapshot = await firebase.database().ref('globalSettings/passwords').once('value');
                if (snapshot.exists()) {
                    dbPass = snapshot.val();
                }
            } catch (dbError) {
                console.log("DB 접속 불가(초기 상태), 기본값 사용");
            }

            // 3. 비교 (DB에 값이 있으면 DB값 사용, 없으면 기본값 사용)
            // 핵심 수정: DB값이 undefined일 경우를 대비해 확실하게 OR 연산 처리
            const realInstHash = (dbPass && dbPass.instructor) ? dbPass.instructor : DEFAULT_INST;
            const realAdminHash = (dbPass && dbPass.super_admin) ? dbPass.super_admin : DEFAULT_ADMIN;

            let role = null;
            if(inputHash === realInstHash) role = 'instructor';
            else if(inputHash === realAdminHash) role = 'super_admin';

            if(role) {
                msgBox.style.color = "#4ade80";
                msgBox.textContent = role === 'super_admin' ? "관리자 접속 성공!" : "강사 접속 성공!";
                
                const sessionData = {
                    token: 'granted',
                    role: role,
                    expiry: Date.now() + SESSION_DURATION
                };
                localStorage.setItem('kac_admin_session', JSON.stringify(sessionData));
                
                setTimeout(() => location.replace('admin.html'), 500);
            } else {
                throw new Error("비밀번호 오류입니다.");
            }
        } catch (e) {
            msgBox.style.color = "#ef4444";
            msgBox.textContent = e.message;
            document.getElementById('pwInput').value = "";
            document.getElementById('pwInput').focus();
        }
    }
    
    // 자동 로그인 체크
    window.onload = function() {
        const session = JSON.parse(localStorage.getItem('kac_admin_session'));
        if(session && session.token === 'granted') {
            if(Date.now() < session.expiry) location.replace('admin.html');
            else localStorage.removeItem('kac_admin_session'); 
        }
    }
  </script>
</body>
</html>