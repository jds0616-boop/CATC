<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CATC Training Q&A</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --theme-color: #3b82f6; --main-color: #1a237e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: sans-serif; margin: 0; padding: 0; background: #f0f2f5; overflow: hidden; height: 100vh; }
        
        .app-container { width: 100%; max-width: 600px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; background: #f0f2f5; }
        
        /* Header & Footer */
        .header { height: 65px; background: var(--main-color); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 6px solid var(--theme-color); transition: border-color 0.3s; flex-shrink: 0;}
        .footer { height: auto; min-height: 60px; background: var(--main-color); color: #ccc; text-align: center; padding: 15px; font-size: 11px; flex-shrink: 0;}
        .course-title { font-weight: bold; font-size: 18px; }
        .kac-logo { height: 16px; }

        /* Main Content */
        .scroll-area { flex-grow: 1; overflow-y: auto; padding-bottom: 80px; }
        .input-section { padding: 20px; background: #e8eaf6; }
        .q-input { width: 100%; height: 100px; padding: 15px; border: 2px solid var(--theme-color); border-radius: 12px; resize: none; }
        .btn-submit { background: var(--theme-color); color: white; padding: 12px 30px; border: none; border-radius: 50px; font-weight: bold; margin-top: 10px; float: right; transition: background 0.3s;}
        
        .list-header { padding: 15px; font-weight: bold; color: #555; background: #f0f2f5; position: sticky; top: 0; }
        .q-card { background: white; margin: 10px 15px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* Quiz Overlay */
        #quizOverlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; z-index: 5000; flex-direction: column; 
            align-items: center; justify-content: center; padding: 20px;
        }
        .quiz-badge { background: #1a237e; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; margin-bottom: 20px; }
        .quiz-msg { font-size: 22px; font-weight: bold; text-align: center; margin-bottom: 40px; color: #333; word-break: keep-all; }
        
        .quiz-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .quiz-btn { 
            height: 80px; font-size: 28px; font-weight: bold; 
            border: 3px solid #eee; background: white; border-radius: 15px; cursor: pointer; 
        }
        .quiz-btn:active { background: #eee; }
        .quiz-btn.selected { background: var(--theme-color); color: white; border-color: var(--theme-color); }
        
        .quiz-wait { display: none; text-align: center; color: #555; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="header">
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-bars" style="font-size:20px;"></i>
                <div class="course-title" id="courseTitle">Loading...</div>
            </div>
            <img src="logo.png" class="kac-logo">
        </header>

        <div class="scroll-area">
            <div class="input-section">
                <textarea class="q-input" id="qInput" placeholder="질문을 입력하세요..."></textarea>
                <button class="btn-submit" onclick="submitQuestion()">Submit</button>
            </div>
            <div class="list-header">Live Questions</div>
            <div id="qList"></div>
        </div>

        <footer class="footer" id="appFooter">
            KAC 항공기술훈련원 교육 플랫폼<br>
            © 2026 KAC. All rights reserved.
        </footer>
    </div>

    <!-- QUIZ MODE -->
    <div id="quizOverlay">
        <div class="quiz-badge">LIVE QUIZ</div>
        <div class="quiz-msg">
            강사님이 문제를 출제 중입니다.<br>
            정답을 선택해주세요.
        </div>
        <div class="quiz-btn-grid" id="quizBtns">
            <button class="quiz-btn" onclick="sendAnswer(1)">1</button>
            <button class="quiz-btn" onclick="sendAnswer(2)">2</button>
            <button class="quiz-btn" onclick="sendAnswer(3)">3</button>
            <button class="quiz-btn" onclick="sendAnswer(4)">4</button>
        </div>
        <div class="quiz-wait" id="quizWait">
            <i class="fa-solid fa-check-circle" style="font-size:40px; color:#10b981;"></i><br><br>
            제출 완료!<br>결과를 기다려주세요.
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const room = new URLSearchParams(window.location.search).get('room') || 'A';
        const db = firebase.database();
        
        window.onload = () => {
            // 1. Settings Sync
            db.ref(`courses/${room}/settings`).on('value', s => {
                const v = s.val();
                if(v) {
                    if(v.courseName) document.getElementById('courseTitle').innerText = v.courseName;
                    if(v.themeColor) document.documentElement.style.setProperty('--theme-color', v.themeColor);
                    if(v.footerText) document.getElementById('appFooter').innerHTML = v.footerText.replace(/\n/g, '<br>');
                } else {
                    document.getElementById('courseTitle').innerText = `Course ${room}`;
                }
            });

            // 2. Q&A List
            db.ref(`courses/${room}/questions`).on('value', s => {
                const d = s.val();
                const div = document.getElementById('qList'); div.innerHTML = "";
                if(!d) { div.innerHTML = "<p style='text-align:center; padding:20px; color:#aaa;'>질문이 없습니다.</p>"; return; }
                
                Object.keys(d).reverse().forEach(k => { // Simple reverse for demo
                    div.innerHTML += `<div class="q-card">${d[k].text}</div>`;
                });
            });

            // 3. Quiz Mode Sync
            let currentQuizId = null;
            db.ref(`courses/${room}/activeQuiz`).on('value', s => {
                const val = s.val();
                if(val && val.id) {
                    // Quiz Active
                    currentQuizId = val.id;
                    document.getElementById('quizOverlay').style.display = 'flex';
                    
                    // Check if already answered
                    if(localStorage.getItem(`quiz_${currentQuizId}`)) {
                        showWait();
                    } else {
                        showBtns();
                    }
                } else {
                    // Quiz Closed
                    currentQuizId = null;
                    document.getElementById('quizOverlay').style.display = 'none';
                }
            });
        };

        function sendAnswer(ans) {
            // Get Active Quiz ID first (from closure or re-read)
            // For simplicity, we assume listener set `currentQuizId` correctly.
            // In production, verify ID again.
            
            // Send
            db.ref(`courses/${room}/activeQuiz`).once('value', s => {
                const val = s.val();
                if(val && val.id) {
                    const qId = val.id;
                    db.ref(`courses/${room}/quiz_answers/${qId}`).push({
                        choice: ans,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    localStorage.setItem(`quiz_${qId}`, ans);
                    showWait();
                }
            });
        }

        function showBtns() {
            document.getElementById('quizBtns').style.display = 'grid';
            document.getElementById('quizWait').style.display = 'none';
        }
        function showWait() {
            document.getElementById('quizBtns').style.display = 'none';
            document.getElementById('quizWait').style.display = 'block';
        }

        function submitQuestion() {
            const t = document.getElementById('qInput').value;
            if(!t) return alert("내용을 입력하세요.");
            db.ref(`courses/${room}/questions`).push({
                text: t,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            document.getElementById('qInput').value = "";
            alert("등록되었습니다.");
        }
    </script>
</body>
</html>