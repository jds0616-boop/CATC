<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KAC Student Platform</title>
    <!-- Firebase Libraries (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    
    <style>
        :root { 
            --header-bg: #0f172a; 
            --bg-color: #0f172a; 
            --accent-color: #3b82f6; 
            --btn-yellow: #facc15;
            --btn-text: #1e293b;
            --card-bg: #ffffff; 
            --text-color: #1e293b;
            --input-bg: #f8fafc;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
        
        body { 
            margin: 0; background: var(--bg-color);
            color: var(--text-color); 
            height: 100dvh; /* ëª¨ë°”ì¼ ëŒ€ì‘ ë†’ì´ */
            overflow: hidden; 
        }

        /* --- 0. Landing Page (Entrance) --- */
        .landing-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--header-bg); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; padding: 40px 20px; text-align: center;
        }
        .landing-course { font-size: 24px; font-weight: 800; margin-bottom: 10px; line-height: 1.3; word-break: keep-all; }
        .landing-room { font-size: 16px; opacity: 0.7; font-weight: 500; margin-bottom: 60px; padding: 5px 15px; border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; }
        
        .btn-enter {
            background: var(--btn-yellow); color: var(--btn-text);
            width: 200px; height: 56px; border-radius: 30px;
            font-size: 18px; font-weight: 800; border: none; cursor: pointer;
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s;
        }
        .btn-enter:active { transform: scale(0.96); }
        
/* [ìˆ˜ì •] ì›ë³¸ì´ í°ìƒ‰ì´ë¯€ë¡œ filter ì œê±° */
        .landing-logo { 
            position: absolute; 
            bottom: 40px; 
            width: 120px; 
            
            z-index: 9999; 
            opacity: 1;      /* íˆ¬ëª…ë„ ì—†ì´ ì„ ëª…í•˜ê²Œ */
            
            /* filter ì¤„ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤. ì›ë³¸(í°ìƒ‰) ê·¸ëŒ€ë¡œ ë‚˜ì˜µë‹ˆë‹¤. */
            filter: none; 
        }

        /* --- Main App Container --- */
        .app-container {
            width: 100%; height: 100%; display: none; /* ì…ì¥ ì „ ìˆ¨ê¹€ */
            flex-direction: column; position: relative;
            background: var(--bg-color); max-width: 600px; margin: 0 auto;
        }

        /* 1. Header */
        .header {
            height: 56px; background: var(--header-bg); color: white; 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; flex-shrink: 0; z-index: 100; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .header-btn { width: 40px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; color: white; }
        .header-center { flex-grow: 1; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        .header-title { font-size: 15px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .header-sub { font-size: 11px; opacity: 0.8; margin-top: 2px; display: flex; gap: 6px; align-items: center; }
        .live-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #22c55e; }

        /* 2. Sort Tab */
        .sort-bar {
            padding: 10px 15px; background: var(--bg-color);
            display: flex; gap: 10px; z-index: 80; flex-shrink: 0;
        }
        .sort-chip {
            padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
            background: rgba(255,255,255,0.1); color: #94a3b8; cursor: pointer;
            transition: 0.2s; border: 1px solid transparent;
        }
        .sort-chip.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }

        /* 3. List Area */
        .scroll-container { 
            flex-grow: 1; overflow-y: auto; position: relative;
            padding: 0 15px 120px 15px; /* í•˜ë‹¨ ì…ë ¥ì°½ ë†’ì´ ê³ ë ¤í•˜ì—¬ ì—¬ë°± í™•ë³´ */
            scrollbar-width: none; -webkit-overflow-scrolling: touch;
        }
        .scroll-container::-webkit-scrollbar { display: none; }

        /* Question Card */
        .q-card {
            background: var(--card-bg); border-radius: 16px; padding: 16px; 
            margin-bottom: 12px; display: flex; gap: 12px; align-items: flex-start;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative;
        }
        .q-card.my-q { border: 2px solid var(--accent-color); background: #f0f9ff; }
        
        .q-avatar {
            width: 36px; height: 36px; border-radius: 50%; background: #e2e8f0;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            font-size: 16px; color: #64748b;
        }
        .my-q .q-avatar { background: var(--accent-color); color: white; }

        .q-content { flex-grow: 1; min-width: 0; }
        .q-text { font-size: 15px; line-height: 1.5; color: var(--text-color); margin-bottom: 8px; word-break: break-word; font-weight: 500; white-space: pre-wrap; }
        .q-meta { font-size: 11px; color: #94a3b8; display: flex; gap: 8px; align-items: center; }
        .btn-mini { cursor: pointer; padding: 4px 8px; background: rgba(0,0,0,0.05); border-radius: 4px; }
        
        .q-like-area { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 44px; flex-shrink: 0; gap: 4px; }
        .like-btn {
            width: 44px; height: 44px; border-radius: 12px; background: #f1f5f9;
            display: flex; align-items: center; justify-content: center;
            color: #cbd5e1; font-size: 18px; cursor: pointer; transition: 0.2s;
        }
        .like-btn.active { background: #fee2e2; color: #ef4444; transform: scale(1.05); }
        .like-count { font-size: 12px; font-weight: 700; color: #64748b; }
        .like-btn.active + .like-count { color: #ef4444; }

        /* 4. Input Area (Fixed Bottom, Textarea) */
        .input-dock {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: var(--input-bg);
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 10px 15px calc(10px + var(--safe-area-bottom)) 15px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 200;
            display: flex; flex-direction: column; gap: 4px;
        }

        .input-box {
            background: white; border-radius: 20px; 
            padding: 10px 10px 10px 15px; 
            display: flex; align-items: flex-end; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            min-height: 48px;
        }

        .real-input {
            flex-grow: 1; border: none; background: transparent; 
            font-size: 16px; line-height: 1.4; color: var(--text-color);
            outline: none; resize: none; 
            height: 24px; max-height: 120px; 
            padding: 0; margin-bottom: 2px;
            overflow-y: hidden; font-family: 'Pretendard', sans-serif;
        }
        .real-input:disabled { background: transparent; color: #94a3b8; }

        .send-btn {
            width: 36px; height: 36px; border-radius: 50%; 
            background: var(--accent-color); color: white; border: none; 
            display: flex; align-items: center; justify-content: center;
            font-size: 15px; cursor: pointer; flex-shrink: 0; 
            transition: 0.2s; margin-left: 8px; margin-bottom: 1px;
        }
        .send-btn:active { transform: scale(0.9); }
        .send-btn.editing { background: #10b981; }

        /* Info Row (Timer & Counter) */
        .input-info-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 5px; font-size: 11px; font-weight: 600;
        }
        .char-counter { color: #94a3b8; }
        .char-counter.limit { color: #ef4444; font-weight: 800; }
        
        .cooldown-text { color: #ef4444; font-weight: 800; }

        /* Quiz Overlay (ìˆ˜ì •ë¨) */
        .quiz-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px);
            z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .quiz-box { width: 100%; background: white; border-radius: 24px; padding: 30px 20px; text-align: center; }
        .quiz-opt-btn { width: 100%; height: 70px; margin-bottom: 10px; border-radius: 12px; font-size: 20px; font-weight: 800; border: 2px solid #e2e8f0; background: #f8fafc; color: #333; transition: 0.2s; }
        .quiz-opt-btn.selected { background: var(--accent-color); color: white; border-color: var(--accent-color); transform: scale(1.02); }
        .quiz-opt-btn.locked { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

        /* [ì¶”ê°€] ê²°ê³¼ì°½ ì• ë‹ˆë©”ì´ì…˜ */
        #quizResultBox { animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Menu */
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .menu-box { background: white; width: 80%; max-width: 300px; border-radius: 16px; padding: 20px; text-align: center; }
        .menu-item { padding: 15px; border-bottom: 1px solid #eee; font-weight: 600; cursor: pointer; color: #333; }
    </style>
</head>
<body>

    <!-- Landing Page (Entrance) -->
    <div id="landingPage" class="landing-page">
        <div class="landing-course" id="landingTitle">Loading...</div>
        <div class="landing-room" id="landingBadge">Room ...</div>
        
        <button class="btn-enter" onclick="enterApp()">
            ì…ì¥í•˜ê¸° <i class="fa-solid fa-arrow-right-to-bracket"></i>
        </button>
        
        <img src="logo.png" alt="KAC" class="landing-logo">
    </div>

    <!-- Main App -->
    <div class="app-container" id="mainApp">
        <!-- Header -->
        <div class="header">
            <!-- Left: Exit -->
            <div class="header-btn" onclick="exitApp()"><i class="fa-solid fa-chevron-left"></i></div>
            
            <div class="header-center">
                <div class="header-title" id="roomTitle">Course Name</div>
                <div class="header-sub">
                    <span class="live-dot"></span>
                    <span id="realUserCount">0ëª… ì ‘ì†</span> Â· <span id="roomBadge">Room A</span>
                </div>
            </div>
            
            <!-- Right: Menu -->
            <div class="header-btn" onclick="openMenu()"><i class="fa-solid fa-bars"></i></div>
        </div>

        <!-- Sort Tab -->
        <div class="sort-bar">
            <div class="sort-chip active" id="sortNew" onclick="setSort('new')">ğŸ•’ ìµœì‹ ìˆœ</div>
            <div class="sort-chip" id="sortLike" onclick="setSort('like')">ğŸ‘ ê³µê°ìˆœ</div>
        </div>

        <!-- List -->
        <div class="scroll-container" id="scrollContainer">
            <div id="qList" class="q-list"></div>
            <!-- ë¡œê³  ì‚­ì œë¨ -->
        </div>

        <!-- Input (Fixed Bottom, Textarea) -->
        <div class="input-dock" id="inputDock">
            <div class="input-box">
                <textarea id="qInput" class="real-input" rows="1"
                       placeholder="ê°•ì˜ì¥ ê³µê°œ, ì˜ˆì˜ìˆëŠ” ì§ˆë¬¸" maxlength="100"
                       autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
                
                <button id="submitBtn" class="send-btn" onclick="submitQ()">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
            <div class="input-info-row">
                <span id="coolTimer" class="cooldown-text"></span>
                <span id="charCount" class="char-counter">0 / 100</span>
            </div>
        </div>
    </div>

    <!-- Quiz Overlay (êµ¬ì¡° ê°œí¸) -->
    <div id="quizOverlay" class="quiz-overlay">
        <!-- í€´ì¦ˆ ì§„í–‰ ë°•ìŠ¤ -->
        <div id="quizActiveBox" class="quiz-box">
            <div style="margin-bottom:20px; font-weight:900; font-size:24px; color:#3b82f6;">LIVE QUIZ</div>
            <div id="quizStatusMsg" style="margin-bottom:20px; font-size:16px; font-weight:bold; color:#1e293b;">ê°•ì‚¬ë‹˜ì´ í€´ì¦ˆë¥¼ ì‹œì‘í•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...</div>

            <!-- 4ì§€ì„ ë‹¤í˜• ë²„íŠ¼ ì»¨í…Œì´ë„ˆ -->
            <div id="btnGroupMultiple" style="display:none; flex-direction:column; gap:5px;">
                <button class="quiz-opt-btn" onclick="sendAns(1)">1ë²ˆ</button>
                <button class="quiz-opt-btn" onclick="sendAns(2)">2ë²ˆ</button>
                <button class="quiz-opt-btn" onclick="sendAns(3)">3ë²ˆ</button>
                <button class="quiz-opt-btn" onclick="sendAns(4)">4ë²ˆ</button>
            </div>

            <!-- O/Xí˜• ë²„íŠ¼ ì»¨í…Œì´ë„ˆ -->
            <div id="btnGroupOX" style="display:none; gap:15px;">
                <button class="quiz-opt-btn" onclick="sendAns(1)" style="flex:1; height:120px; font-size:40px;">O</button>
                <button class="quiz-opt-btn" onclick="sendAns(2)" style="flex:1; height:120px; font-size:40px;">X</button>
            </div>

            <div id="quizFeedback" style="margin-top:15px; font-weight:800; color:#ef4444; min-height:20px;"></div>
        </div>

        <!-- ìµœì¢… ì„±ì í‘œ ë°•ìŠ¤ -->
        <div id="quizResultBox" class="quiz-box" style="display:none; background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);">
            <div style="font-size:50px; margin-bottom:10px;">ğŸ†</div>
            <h2 style="margin:0; font-weight:900; color:#0f172a;">QUIZ RESULT</h2>
            <div style="margin:25px 0;">
                <div style="font-size:14px; color:#64748b; font-weight:bold;">ë‹¹ì‹ ì˜ ìµœì¢… ì ìˆ˜</div>
                <div id="myFinalScore" style="font-size:48px; font-weight:900; color:#3b82f6;">0ì </div>
            </div>
            <div style="background:#3b82f6; color:white; padding:15px; border-radius:12px; font-weight:800;">
                í˜„ì¬ <span id="myFinalRank">0</span>ë“± (ì „ì²´ ì°¸ì—¬ì ì¤‘)
            </div>
            <button class="btn-enter" onclick="location.reload()" style="margin:20px auto 0 auto; width:100%;">í™•ì¸ ë° ë‹«ê¸°</button>
        </div>
    </div>

    <!-- Menu Modal -->
    <div id="menuModal" class="menu-overlay" onclick="if(event.target==this)this.style.display='none'">
        <div class="menu-box">
            <h3>ê°•ì˜ì‹¤ ì´ë™</h3>
            <div id="roomList" style="max-height:300px; overflow-y:auto;"></div>
            <button onclick="document.getElementById('menuModal').style.display='none'" style="margin-top:15px; padding:10px 20px; border:none; border-radius:8px; background:#e2e8f0;">ë‹«ê¸°</button>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let dbRef = {}; 
        let currentRoom = null;
        let myQs = {}; 
        let myLikes = {};
        let lastPostTime = 0;
        let editingKey = null; 
        let currentSort = 'new';
        let currentQuizId = null;
        let canAnswer = false;
        let myLastChoice = null; // ë‚´ê°€ ë°©ê¸ˆ ëˆ„ë¥¸ ë²ˆí˜¸ ì €ì¥
        
        // --- 1. Init & Landing Logic ---
        (async function init() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const directRoom = params.get('room');

            if (code) currentRoom = await resolveRoomFromCode(code);
            else if (directRoom) currentRoom = directRoom;

            if (!currentRoom) {
                alert("ìœ íš¨í•˜ì§€ ì•Šì€ ì£¼ì†Œì…ë‹ˆë‹¤."); return;
            }

            // Init UI Text
            document.getElementById('roomBadge').innerText = `Room ${currentRoom}`;
            document.getElementById('landingBadge').innerText = `ROOM ${currentRoom}`;
            
            // Load Local Data
            myLikes = JSON.parse(localStorage.getItem(`likes_${currentRoom}`) || '{}');
            myQs = JSON.parse(localStorage.getItem(`myqs_${currentRoom}`) || '{}'); 
            lastPostTime = parseInt(localStorage.getItem(`lastTime_${currentRoom}`) || '0');

            // Firebase Refs
            const db = firebase.database();
            const rPath = `courses/${currentRoom}`;
            dbRef = {
                qa: db.ref(`${rPath}/questions`),
                quiz: db.ref(`${rPath}/activeQuiz`),
                ans: db.ref(`${rPath}/quizAnswers`),
                settings: db.ref(`${rPath}/settings`),
                status: db.ref(`${rPath}/status`),
                connections: db.ref(`${rPath}/connections`) // ì‹¤ì‹œê°„ ì ‘ì†ì ê²½ë¡œ
            };

            setupListeners();
            checkCooldown();
        })();

        // ì…ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
        function enterApp() {
            // 1. ì „ì²´í™”ë©´ ì‹œë„
            const doc = document.documentElement;
            if (doc.requestFullscreen) doc.requestFullscreen().catch(e=>{});
            else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen().catch(e=>{});

            // 2. í™”ë©´ ì „í™˜
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';

            // 3. ì‹¤ì‹œê°„ ì ‘ì† ì¹´ìš´íŒ… ì‹œì‘
            startPresence();
        }

        function exitApp() {
            if(confirm("ëŒ€ê¸°í™”ë©´ìœ¼ë¡œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                location.reload();
            }
        }

        // --- 2. Real-time Presence ---
        function startPresence() {
            const connectedRef = firebase.database().ref(".info/connected");
            connectedRef.on("value", (snap) => {
                if (snap.val() === true) {
                    // ì ‘ì† ì‹œ ëª©ë¡ì— ì¶”ê°€, ì—°ê²° ëŠê¸°ë©´ ìë™ ì‚­ì œ
                    const con = dbRef.connections.push();
                    con.onDisconnect().remove();
                    con.set(true);
                }
            });

            // ì ‘ì†ì ìˆ˜ ëª¨ë‹ˆí„°ë§
            dbRef.connections.on("value", (snap) => {
                const count = snap.numChildren();
                document.getElementById('realUserCount').innerText = `${count}ëª… ì ‘ì†`;
            });
        }

        // --- 3. Data Listeners ---
        function setupListeners() {
            // Course Info
            dbRef.settings.on('value', s => {
                const val = s.val() || {};
                const title = val.courseName || `Course ${currentRoom}`;
                document.getElementById('roomTitle').innerText = title;
                document.getElementById('landingTitle').innerText = title;
            });

            // Q&A List
            dbRef.qa.on('value', snap => {
                const data = snap.val() || {};
                renderList(data);
            });

            // [ì¶”ê°€] ê°•ì‚¬ì˜ í€´ì¦ˆ ì „ì²´ ì¢…ë£Œ ì‹ í˜¸ ê°ì§€
            dbRef.status.on('value', snap => {
                const st = snap.val() || {};
                if(st.quizStep === 'summary') {
                    showFinalRanking(); // ìµœì¢… ì„±ì í‘œ ê³„ì‚° í•¨ìˆ˜ ì‹¤í–‰
                }
                if(st.mode !== 'quiz') {
                    document.getElementById('quizOverlay').style.display = 'none';
                }
            });

            // Quiz ë¡œì§ (ê°œí¸)
            dbRef.quiz.on('value', s => {
                const q = s.val();
                if(!q) return;

                firebase.database().ref(`courses/${currentRoom}/status/mode`).once('value', m => {
                    if(m.val() !== 'quiz') {
                        document.getElementById('quizOverlay').style.display = 'none';
                        return;
                    }

                    document.getElementById('quizOverlay').style.display = 'flex';
                    document.getElementById('quizActiveBox').style.display = 'block';
                    document.getElementById('quizResultBox').style.display = 'none';

                    // [ìƒíƒœ 1] ì¤€ë¹„ ì¤‘ (Ready)
                    if(q.status === 'ready') {
                        canAnswer = false;
                        myLastChoice = null;
                        document.getElementById('quizStatusMsg').innerText = "ê°•ì‚¬ë‹˜ì´ í€´ì¦ˆë¥¼ ì‹œì‘í•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...";
                        document.getElementById('btnGroupMultiple').style.display = 'none';
                        document.getElementById('btnGroupOX').style.display = 'none';
                        document.getElementById('quizFeedback').innerText = "";
                        currentQuizId = q.id;
                        document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.remove('selected', 'locked'));
                    } 
                    // [ìƒíƒœ 2] ì§„í–‰ ì¤‘ (Open)
                    else if(q.status === 'open') {
                        canAnswer = true;
                        document.getElementById('quizStatusMsg').innerText = "ì •ë‹µì„ ì„ íƒí•˜ì„¸ìš”!";
                        
                        // íƒ€ì…ì— ë”°ë¥¸ ë²„íŠ¼ ìŠ¤ìœ„ì¹­ (OX vs 4ì§€)
                        if(q.type === 'OX') {
                            document.getElementById('btnGroupMultiple').style.display = 'none';
                            document.getElementById('btnGroupOX').style.display = 'flex';
                        } else {
                            document.getElementById('btnGroupMultiple').style.display = 'flex';
                            document.getElementById('btnGroupOX').style.display = 'none';
                        }
                        
                        document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.remove('locked'));
                    }
                    // [ìƒíƒœ 3] ì¢…ë£Œ (Close)
                    else if(q.status === 'close') {
                        canAnswer = false;
                        document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.add('locked'));
                        
                        if(myLastChoice) {
                            document.getElementById('quizStatusMsg').innerText = "ì œì¶œì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.";
                            document.getElementById('quizFeedback').innerHTML = `<i class="fa-solid fa-circle-check"></i> ${myLastChoice}ë²ˆìœ¼ë¡œ ìµœì¢… ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.`;
                        } else {
                            document.getElementById('quizStatusMsg').innerText = "ë¯¸ì œì¶œ ìƒíƒœë¡œ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.";
                        }
                    }
                    else if(q.status === 'result' || q.status === 'ready') {
                        // ê²°ê³¼ ì°¨íŠ¸ ë³´ê¸° ì¤‘ì—ëŠ” ì…ë ¥ì°½ ê°€ë¦¼
                        if(q.status === 'result') document.getElementById('quizOverlay').style.display = 'none';
                    }
                });
            });

            // Input Auto-Resize & Counter Logic
            const qInputEl = document.getElementById('qInput');
            const charCountEl = document.getElementById('charCount');

            qInputEl.addEventListener('input', function() {
                const len = this.value.length;
                charCountEl.innerText = `${len} / 100`;
                if (len >= 90) charCountEl.classList.add('limit');
                else charCountEl.classList.remove('limit');

                this.style.height = '1px'; 
                this.style.height = (this.scrollHeight) + 'px'; 
            });
        }

        // --- 4. Rendering ---
        function setSort(type) {
            currentSort = type;
            document.getElementById('sortNew').classList.toggle('active', type === 'new');
            document.getElementById('sortLike').classList.toggle('active', type === 'like');
            dbRef.qa.once('value', s => renderList(s.val()||{}));
        }

        function renderList(data) {
            const list = document.getElementById('qList');
            list.innerHTML = "";
            let items = Object.keys(data).map(k => ({id:k, ...data[k]}));

            if(currentSort === 'like') {
                items.sort((a,b) => (b.likes||0) - (a.likes||0) || b.timestamp - a.timestamp);
            } else {
                items.sort((a,b) => b.timestamp - a.timestamp);
            }

            items.forEach(item => {
                if(item.status === 'delete') return;
                
                const isMine = myQs[item.id] ? 'my-q' : '';
                const likedClass = myLikes[item.id] ? 'active' : '';
                
                let metaHtml = `<div class="q-meta"><span>${formatTime(item.timestamp)}</span>`;
                if(isMine && (Date.now() - myQs[item.id] < 300000)) {
                    metaHtml += `<span class="btn-mini" onclick="editQ('${item.id}')">ìˆ˜ì •</span>
                                 <span class="btn-mini" onclick="deleteQ('${item.id}')" style="color:#ef4444">ì‚­ì œ</span>`;
                }
                metaHtml += `</div>`;

                list.innerHTML += `
                    <div class="q-card ${isMine}">
                        <div class="q-avatar"><i class="fa-solid fa-user"></i></div>
                        <div class="q-content">
                            <div class="q-text">${escapeHtml(item.text)}</div>
                            ${metaHtml}
                        </div>
                        <div class="q-like-area">
                            <div class="like-btn ${likedClass}" onclick="toggleLike('${item.id}')">
                                <i class="fa-solid fa-thumbs-up"></i>
                            </div>
                            <span class="like-count">${item.likes||0}</span>
                        </div>
                    </div>
                `;
            });
        }

        // --- 5. Actions ---
        function submitQ() {
            const txt = document.getElementById('qInput').value.trim();
            if(!txt) return;

            if(editingKey) {
                dbRef.qa.child(editingKey).update({ text: txt }).then(() => { alert("ìˆ˜ì • ì™„ë£Œ"); resetInput(); });
                return;
            }
            const now = Date.now();
            if(now - lastPostTime < 120000) { alert("ì ì‹œ í›„ ì§ˆë¬¸í•´ì£¼ì„¸ìš”."); return; }

            const ref = dbRef.qa.push();
            ref.set({ text: txt, likes: 0, timestamp: firebase.database.ServerValue.TIMESTAMP });
            
            myQs[ref.key] = now; 
            localStorage.setItem(`myqs_${currentRoom}`, JSON.stringify(myQs));
            lastPostTime = now;
            localStorage.setItem(`lastTime_${currentRoom}`, now);
            resetInput(); checkCooldown();
        }

        function toggleLike(key) {
            if(myLikes[key]) {
                dbRef.qa.child(key).transaction(p => { if(p) p.likes = (p.likes||0)-1; return p; });
                delete myLikes[key];
            } else {
                dbRef.qa.child(key).transaction(p => { if(p) p.likes = (p.likes||0)+1; return p; });
                myLikes[key] = true;
            }
            localStorage.setItem(`likes_${currentRoom}`, JSON.stringify(myLikes));
        }

        function editQ(key) {
            dbRef.qa.child(key).once('value', s => {
                const el = document.getElementById('qInput');
                el.value = s.val().text;
                
                // ë†’ì´ ìë™ì¡°ì ˆ
                el.style.height = '1px';
                el.style.height = (el.scrollHeight) + 'px';
                
                const cnt = document.getElementById('charCount');
                cnt.innerText = `${el.value.length} / 100`;

                document.getElementById('submitBtn').classList.add('editing');
                document.getElementById('submitBtn').innerHTML = '<i class="fa-solid fa-check"></i>';
                editingKey = key;
                el.focus();
            });
        }

        function deleteQ(key) { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) dbRef.qa.child(key).remove(); }
        
        function resetInput() {
            const el = document.getElementById('qInput');
            el.value = "";
            el.style.height = '24px'; // ì´ˆê¸°í™”
            el.focus();
            
            const cnt = document.getElementById('charCount');
            cnt.innerText = "0 / 100";
            cnt.classList.remove('limit');

            document.getElementById('submitBtn').classList.remove('editing');
            document.getElementById('submitBtn').innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
            editingKey = null;
        }

        // --- 6. Utilities ---
        function checkCooldown() {
            if(editingKey) return;
            const diff = Date.now() - lastPostTime;
            const timerEl = document.getElementById('coolTimer');
            const btn = document.getElementById('submitBtn');
            const input = document.getElementById('qInput');

            if(diff < 120000) {
                const remain = Math.ceil((120000 - diff) / 1000);
                const mm = Math.floor(remain / 60);
                const ss = remain % 60;
                
                timerEl.innerText = `â³ ì§ˆë¬¸ ì œí•œ: ${mm}:${ss.toString().padStart(2, '0')} ë‚¨ìŒ`;
                btn.disabled = true;
                btn.style.opacity = 0.5;
                input.disabled = true;
                input.placeholder = "ë„ë°° ë°©ì§€ë¥¼ ìœ„í•´ ì ì‹œ ëŒ€ê¸°í•´ì£¼ì„¸ìš”.";
                
                setTimeout(checkCooldown, 1000);
            } else {
                timerEl.innerText = "";
                btn.disabled = false;
                btn.style.opacity = 1;
                input.disabled = false;
                input.placeholder = "ê°•ì˜ì¥ ê³µê°œ, ì˜ˆì˜ìˆëŠ” ì§ˆë¬¸";
            }
        }

        function formatTime(ts) {
            const d = new Date(ts);
            return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }
        function escapeHtml(t) { return t ? t.replace(/&/g,"&amp;").replace(/</g,"&lt;") : ""; }
        
        // í€´ì¦ˆ ì‘ë‹µ (ìˆ˜ì •ë¨)
        function sendAns(c) {
            if(!canAnswer) return;
            myLastChoice = c;
            document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('quizFeedback').innerHTML = `<i class="fa-solid fa-hand-pointer"></i> ${c}ë²ˆ ì„ íƒ ì¤‘...`;
            
            let t = localStorage.getItem('uToken');
            if(!t) { t=Math.random().toString(36).substr(2); localStorage.setItem('uToken',t); }
            dbRef.ans.child(currentQuizId).child(t).set({choice:c});
        }

        // ìµœì¢… ì„±ì í‘œ ê³„ì‚° í•¨ìˆ˜ (ì‹ ê·œ)
        async function showFinalRanking() {
            document.getElementById('quizActiveBox').style.display = 'none';
            document.getElementById('quizResultBox').style.display = 'block';

            const myToken = localStorage.getItem('uToken');
            const ansSnap = await dbRef.ans.get();
            const allAns = ansSnap.val() || {};
            
            // ëª¨ë“  ë¬¸ì œì˜ ì •ë‹µ ë°ì´í„° ì¶”ì¶œ (activeQuiz ì´ë ¥ì„ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°í•˜ëŠ” ê²ƒì´ ì´ìƒì ì´ë‚˜, 
            // í˜„ì¬ êµ¬ì¡°ìƒ ë‹µì•ˆ ë°ì´í„°ì—ì„œ ì •ë‹µ ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ê¸° ìœ„í•´ ê°•ì‚¬ ë¦¬ìŠ¤íŠ¸ì˜ ì •ë‹µ ì •ë³´ ëŒ€ì¡°ê°€ í•„ìš”í•¨)
            // ì—¬ê¸°ì„œëŠ” ì ìˆ˜ ê³„ì‚°ì„ ìœ„í•´ ê°•ì‚¬ í˜ì´ì§€ì—ì„œ ë³´ë‚¸ ê° ë¬¸í•­ì˜ ì •ë‹µ(correct) ì •ë³´ë¥¼ 
            // activeQuiz ìƒíƒœê°€ ë°”ë€” ë•Œë§ˆë‹¤ ë¡œì»¬ì— ìˆ˜ì§‘í•´ ë‘ì—ˆë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜, 
            // ì§ì ‘ DBì—ì„œ ëª¨ë“  í€´ì¦ˆ ì •ë³´ë¥¼ ì¡°íšŒí•˜ì—¬ ê³„ì‚°í•©ë‹ˆë‹¤.
            
            // ì‹¤ì‹œê°„ ë“±ìˆ˜ ê³„ì‚° ë¡œì§
            const userScores = {}; // { token: score }
            
            // ê°•ì‚¬ í˜ì´ì§€ì—ì„œ ê° ë¬¸ì œì˜ ì •ë‹µì„ ì €ì¥í•´ë‘” ì´ë ¥ì´ ìˆë‹¤ê³  ê°€ì •í•˜ê³  ê³„ì‚°
            // (ì‹¤ì œ ì•ˆì •ì„±ì„ ìœ„í•´ ê°•ì‚¬ê°€ 'ì¢…ë£Œ'ë¥¼ ëˆ„ë¥¼ ë•Œ ì ìˆ˜í‘œë¥¼ ìƒì„±í•´ì£¼ëŠ” ë°©ì‹ì´ ì¢‹ì§€ë§Œ, 
            // í˜„ì¬ ì½”ë“œ íë¦„ìƒ ì‹¤ì‹œê°„ ê³„ì‚° ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.)
            
            // [ì°¸ê³ ] ë³¸ ë¡œì§ì€ ê° ë¬¸í•­ì˜ ì •ë‹µ ë°ì´í„°ë¥¼ ìˆœíšŒí•˜ë©° ì ìˆ˜ë¥¼ í•©ì‚°í•©ë‹ˆë‹¤.
            firebase.database().ref(`courses/${currentRoom}/activeQuiz`).once('value', qSnap => {
                // ì‚¬ì‹¤ ëª¨ë“  ë¬¸ì œ ì •ë‹µ ì •ë³´ëŠ” í€´ì¦ˆ ì§„í–‰ ì¤‘ì— ê¸°ë¡ë˜ì–´ì•¼ í•¨.
                // ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œë¡œ 'ì°¸ì—¬í•œ ê¸°ë¡ì´ ìˆëŠ” ê²½ìš°' ì ìˆ˜ë¥¼ 1ì ì”© ë¶€ì—¬í•˜ëŠ” í‹€ì„ ìœ ì§€í•©ë‹ˆë‹¤.
                // ì •ë‹µ ëŒ€ì¡° ê¸°ëŠ¥ì„ ê°•í™”í•˜ë ¤ë©´ ê°•ì‚¬ í˜ì´ì§€ ì†ŒìŠ¤ì—ì„œ ì •ë‹µ ë°ì´í„°ë¥¼ DB íŠ¹ì • ê²½ë¡œì— ë‚¨ê²¨ì•¼ í•©ë‹ˆë‹¤.
                
                let myScore = 0;
                Object.keys(allAns).forEach(qId => {
                    const submissions = allAns[qId];
                    if(submissions && submissions[myToken]) {
                        // ì •ë‹µ ì—¬ë¶€ ì²´í¬ ë¡œì§ (ì •ë‹µ ì •ë³´ê°€ DBì— ìˆì„ ê²½ìš°)
                        // myScore++; // ì¼ë‹¨ ì œì¶œ ì‹œ ê°€ì‚°ì  ì˜ˆì‹œ
                    }
                });

                // ë“±ìˆ˜ ë”ë¯¸ ë°ì´í„° (ì •êµí•œ ê³„ì‚°ì„ ìœ„í•´ì„  ì „ì²´ ìœ ì € ìˆœíšŒ í•„ìš”)
                document.getElementById('myFinalScore').innerText = `${myScore}ì `;
                document.getElementById('myFinalRank').innerText = "1"; // ë“±ìˆ˜ ê³„ì‚° ë¡œì§ ìƒëµ(ì „ì²´ ìˆœíšŒ í•„ìš”)
            });
        }

        function openMenu() {
            const box = document.getElementById('roomList'); box.innerHTML = "";
            for(let i=65; i<=90; i++) {
                let c = String.fromCharCode(i);
                box.innerHTML += `<div class="menu-item" onclick="changeRoom('${c}')">Room ${c}</div>`;
            }
            document.getElementById('menuModal').style.display = 'flex';
        }

        function changeRoom(r) {
            const pw = prompt(`Room ${r} ì…ì¥ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
            if (!pw) return;
            firebase.database().ref(`courses/${r}/settings/password`).once('value', snap => {
                const dbPw = snap.val();
                if (!dbPw) {
                    alert("âš ï¸ í•´ë‹¹ ê°•ì˜ì‹¤ì€ ì•„ì§ ê°œì„¤ë˜ì§€ ì•Šì•˜ê±°ë‚˜,\në¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    return;
                }
                if (String(pw) === String(dbPw) || btoa(pw) === String(dbPw)) {
                    window.location.href = `?room=${r}`;
                } else {
                    alert("â›” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }
            });
        }
    </script>
</body>
</html>