<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KAC Student Platform</title>
    <!-- Firebase Libraries (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    
    <style>
        :root { 
            --header-bg: #0f172a; 
            --accent-color: #3b82f6; 
            --bg-color: #f8fafc; 
            --card-bg: #ffffff; 
            --text-color: #1e293b;
            --input-bg: #f1f5f9;
        }
        body.night-mode { 
            --header-bg: #000000;
            --bg-color: #111111; 
            --card-bg: #1e1e1e; 
            --text-color: #e2e8f0;
            --input-bg: #2d2d2d;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
        
        body { 
            margin: 0; background: #cbd5e1; color: var(--text-color); 
            height: 100vh; display: flex; justify-content: center; overflow: hidden; 
        }

        .app-container {
            width: 100%; max-width: 500px;
            height: 100%; background: var(--bg-color);
            display: flex; flex-direction: column; position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }

        /* Header */
        .header {
            height: 60px; background: var(--header-bg); color: white; 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; flex-shrink: 0; z-index: 100; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-left { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 16px; overflow: hidden; }
        .menu-btn { font-size: 20px; cursor: pointer; padding: 5px; }
        .room-badge { background: var(--accent-color); color: white; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 800; flex-shrink: 0; }
        .title-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 15px; }
        .header-right i { font-size: 20px; cursor: pointer; padding: 5px; }

        /* Input Area */
        .input-area {
            background: var(--card-bg); padding: 15px 20px; flex-shrink: 0; 
            border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 90;
        }
        .input-wrapper {
            position: relative; background: var(--input-bg); 
            border-radius: 16px; padding: 12px; border: 1px solid transparent;
            transition: 0.2s;
        }
        .input-wrapper:focus-within { border-color: var(--accent-color); background: var(--card-bg); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        
        .q-input {
            width: 100%; border: none; background: transparent; 
            font-size: 15px; resize: none; height: 60px; outline: none;
            color: var(--text-color); line-height: 1.4;
        }
        .input-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .char-counter { font-size: 11px; color: #94a3b8; font-weight: 600; }
        .char-counter.limit { color: #ef4444; }
        
        .btn-submit {
            background: var(--accent-color); color: white; padding: 8px 20px; 
            border-radius: 20px; font-weight: 700; border: none; font-size: 13px; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .btn-submit:disabled { background: #cbd5e1; cursor: not-allowed; }
        .btn-submit:active { transform: scale(0.95); }
        .btn-submit.mode-edit { background: #10b981; } /* 수정 모드일 때 녹색 */
        
        .timer-msg { font-size: 11px; color: #ef4444; font-weight: 700; margin-right: 10px; visibility: hidden; }

        /* List Area */
        .scroll-container { flex-grow: 1; overflow-y: auto; padding: 0; position: relative; }
        .sticky-bar {
            position: sticky; top: 0; background: var(--bg-color); padding: 15px 20px;
            font-size: 13px; font-weight: 700; color: #64748b; z-index: 80;
            display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(5px); background: rgba(248, 250, 252, 0.9);
        }
        body.night-mode .sticky-bar { background: rgba(17, 17, 17, 0.9); }

        .q-list { padding: 0 20px 80px 20px; display: flex; flex-direction: column; gap: 12px; }
        
        /* Card Design */
        .q-card {
            background: var(--card-bg); border-radius: 16px; padding: 18px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; border: 1px solid rgba(0,0,0,0.03);
            transition: transform 0.1s;
        }
        .q-card:active { transform: scale(0.99); }
        
        .q-card.my-q { background: #eff6ff; border: 1px solid #dbeafe; }
        body.night-mode .q-card.my-q { background: #1e293b; border-color: #334155; }

        .q-text { 
            font-size: 15px; line-height: 1.5; color: var(--text-color); 
            word-break: break-all; margin-bottom: 12px;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            cursor: pointer;
        }
        .q-text.expanded { -webkit-line-clamp: unset; overflow: visible; }
        
        /* Bottom Action Bar */
        .q-bottom { display: flex; justify-content: space-between; align-items: center; height: 32px; }
        
        .q-left-actions { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #64748b; }
        .edit-timer { font-weight: 700; color: #ef4444; font-size: 11px; background: rgba(239, 68, 68, 0.1); padding: 2px 6px; border-radius: 4px; }
        
        .action-btn { 
            background: transparent; border: 1px solid #cbd5e1; color: #64748b;
            padding: 4px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px;
        }
        .btn-edit { color: #3b82f6; border-color: #3b82f6; background: #eff6ff; }
        .btn-del { color: #ef4444; border-color: #ef4444; background: #fef2f2; }

        .like-btn {
            background: var(--input-bg); color: #64748b; padding: 6px 12px; border-radius: 20px;
            font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px;
            transition: 0.2s; margin-left: auto; /* 우측 정렬 */
        }
        .like-btn.active { background: #fee2e2; color: #ef4444; }
        body.night-mode .like-btn.active { background: #7f1d1d; color: #fca5a5; }

        /* Quiz Overlay */
        .quiz-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); backdrop-filter: blur(3px);
            z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .quiz-box { width: 100%; background: white; border-radius: 24px; padding: 30px 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .quiz-badge { display: inline-block; background: var(--accent-color); color: white; padding: 5px 12px; border-radius: 20px; margin-bottom: 20px; font-size: 12px; font-weight: 800; letter-spacing: 1px; }
        .quiz-msg { font-size: 22px; font-weight: 800; color: #333; margin-bottom: 30px; line-height: 1.3; }
        
        .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
        .quiz-opt-btn { 
            height: 90px; font-size: 32px; font-weight: 900; background: #f8fafc; 
            border: 2px solid #e2e8f0; border-radius: 16px; color: #64748b;
            cursor: pointer; transition: 0.2s; pointer-events: none; opacity: 0.6;
        }
        .quiz-opt-btn.active-mode { pointer-events: auto !important; opacity: 1 !important; background: white; color: #333; border-color: #cbd5e1; box-shadow: 0 4px 0 #cbd5e1; }
        .quiz-opt-btn.active-mode:active { transform: translateY(4px); box-shadow: none; }
        .quiz-opt-btn.selected { background: var(--accent-color); color: white; border-color: var(--accent-color); box-shadow: 0 4px 0 #1d4ed8; }
        
        .quiz-wait { margin-top: 20px; color: #64748b; font-weight: 700; font-size: 14px; display: none; }

        /* Footer */
        .footer { 
            position: absolute; bottom: 0; width: 100%; padding: 15px; 
            text-align: center; opacity: 0.5; font-size: 11px; pointer-events: none;
        }
        .footer img { height: 16px; filter: grayscale(1); }

        /* Menu Modal */
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .menu-box { background: var(--card-bg); padding: 25px; border-radius: 20px; width: 300px; text-align: center; max-height: 80vh; display: flex; flex-direction: column; }
        .menu-header { font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--text-color); }
        .menu-list { overflow-y: auto; flex-grow: 1; }
        .room-item { padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; color: var(--text-color); font-weight: 600; font-size: 14px; }
        .room-item:hover { background: rgba(0,0,0,0.03); }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <i class="fa-solid fa-bars menu-btn" onclick="openMenu()"></i>
                <span id="roomBadge" class="room-badge">Loading...</span>
                <span id="roomTitle" class="title-text">...</span>
            </div>
            <div class="header-right">
                <i class="fa-solid fa-moon" onclick="toggleNight()"></i>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="input-wrapper">
                <textarea id="qInput" class="q-input" placeholder="질문을 입력해주세요 (100자 이내, 익명)" maxlength="100"></textarea>
                <div class="input-bottom">
                    <span id="charCount" class="char-counter">0 / 100</span>
                    <div style="display:flex; align-items:center;">
                        <span id="coolTimer" class="timer-msg">Wait 2:00</span>
                        <button id="submitBtn" class="btn-submit" onclick="submitQ()">Send <i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- List -->
        <div class="scroll-container">
            <div class="sticky-bar">
                <span><i class="fa-solid fa-comments"></i> 실시간 질문</span>
                <span style="font-size:12px; font-weight:500;">인기순 정렬 <i class="fa-solid fa-arrow-down-short-wide"></i></span>
            </div>
            <div id="qList" class="q-list"></div>
            <div class="footer"><img src="logo.png" alt="KAC"></div>
        </div>

        <!-- Quiz Overlay -->
        <div id="quizOverlay" class="quiz-overlay">
            <div class="quiz-box">
                <div class="quiz-badge">LIVE QUIZ</div>
                <div class="quiz-msg" id="quizStatusMsg">강사님이 문제를 준비중입니다.</div>
                <div class="quiz-grid">
                    <button class="quiz-opt-btn" onclick="sendAns(1)">1</button>
                    <button class="quiz-opt-btn" onclick="sendAns(2)">2</button>
                    <button class="quiz-opt-btn" onclick="sendAns(3)">3</button>
                    <button class="quiz-opt-btn" onclick="sendAns(4)">4</button>
                </div>
                <div class="quiz-wait" id="quizWait">제출완료! 결과 대기중...</div>
            </div>
        </div>

        <!-- Menu Modal -->
        <div id="menuModal" class="menu-overlay" onclick="if(event.target==this)this.style.display='none'">
            <div class="menu-box">
                <div class="menu-header">강의실 선택</div>
                <div class="menu-list" id="roomList"></div>
                <button onclick="document.getElementById('menuModal').style.display='none'" style="margin-top:15px; padding:10px; border:none; background:#cbd5e1; border-radius:10px; font-weight:bold; cursor:pointer;">닫기</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script>
        let dbRef = {}; 
        let currentRoom = null;
        let myQs = {}; // { key: timestamp }
        let myLikes = {};
        let lastPostTime = 0;
        let editInterval = null;
        let currentQuizId = null;
        let canAnswer = false;
        let editingKey = null; // 현재 수정 중인 질문 키

        // --- 초기화 ---
        (async function init() {
            const bc = new BroadcastChannel('kac_student_channel');
            bc.onmessage = (e) => { 
                if(e.data === 'here') { alert("다른 탭에서 이미 열려있습니다."); window.location.href="about:blank"; } 
            };
            bc.postMessage('here');

            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const directRoom = params.get('room');

            if (code) currentRoom = await resolveRoomFromCode(code);
            else if (directRoom) currentRoom = directRoom;

            if (!currentRoom) {
                document.body.innerHTML = "<div style='display:flex;height:100vh;justify-content:center;align-items:center;flex-direction:column;text-align:center;'><h2>유효하지 않은 링크입니다.</h2></div>";
                return;
            }

            document.getElementById('roomBadge').innerText = `ROOM ${currentRoom}`;
            
            myLikes = JSON.parse(localStorage.getItem(`likes_${currentRoom}`) || '{}');
            myQs = JSON.parse(localStorage.getItem(`myqs_${currentRoom}`) || '{}'); 
            lastPostTime = parseInt(localStorage.getItem(`lastTime_${currentRoom}`) || '0');

            const db = firebase.database();
            dbRef = {
                qa: db.ref(`courses/${currentRoom}/questions`),
                quiz: db.ref(`courses/${currentRoom}/activeQuiz`),
                ans: db.ref(`courses/${currentRoom}/quizAnswers`),
                settings: db.ref(`courses/${currentRoom}/settings`),
                status: db.ref(`courses/${currentRoom}/status/mode`)
            };

            setupListeners();
            checkCooldown();
        })();

        function setupListeners() {
            dbRef.settings.on('value', snap => {
                const val = snap.val() || {};
                document.getElementById('roomTitle').innerText = val.courseName ? val.courseName : `교육 과정`;
            });

            // [모드 동기화] 강사가 Q&A로 바꾸면 퀴즈창 숨김 (강제 이동)
            dbRef.status.on('value', snap => {
                if(snap.val() === 'qa') {
                    document.getElementById('quizOverlay').style.display = 'none';
                }
            });

            // [Q&A 목록 렌더링]
            dbRef.qa.on('value', snap => {
                const data = snap.val() || {};
                const list = document.getElementById('qList');
                list.innerHTML = "";
                let items = Object.keys(data).map(k => ({id:k, ...data[k]}));
                
                // 공감순 -> 최신순 정렬
                items.sort((a,b) => (b.likes||0) - (a.likes||0) || b.timestamp - a.timestamp);
                
                items.forEach(item => {
                    if(item.status === 'delete') return;
                    
                    const isMine = myQs[item.id] ? 'my-q' : '';
                    const likedClass = myLikes[item.id] ? 'active' : '';
                    
                    // 내가 쓴 글이고 5분 이내라면 수정/삭제 UI 표시
                    let leftActions = '';
                    if(isMine) {
                        const postTime = myQs[item.id];
                        const diff = Date.now() - postTime;
                        // 5분(300000ms) 이내만 허용
                        if(diff < 300000) { 
                            leftActions = `
                                <div class="q-left-actions" id="actions-${item.id}">
                                    <span class="edit-timer" id="timer-${item.id}">5:00</span>
                                    <button class="action-btn btn-edit" onclick="editQ('${item.id}')"><i class="fa-solid fa-pen"></i></button>
                                    <button class="action-btn btn-del" onclick="deleteQ('${item.id}')"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            `;
                        }
                    }
                    
                    list.innerHTML += `
                        <div class="q-card ${isMine}">
                            <div class="q-text" onclick="this.classList.toggle('expanded')">${escapeHtml(item.text)}</div>
                            <div class="q-bottom">
                                ${leftActions}
                                <div class="like-btn ${likedClass}" onclick="toggleLike('${item.id}')">
                                    <i class="fa-solid fa-thumbs-up${myLikes[item.id]?'':' has-text-grey-light'}"></i> 
                                    <span>${item.likes||0}</span>
                                </div>
                            </div>
                        </div>`;
                });
                startEditTimers(); // 타이머 가동
            });

            // 퀴즈 처리 (생략 - 기존 유지)
            dbRef.quiz.on('value', snap => {
                const q = snap.val();
                const overlay = document.getElementById('quizOverlay');
                if(!q || q.status === 'result') { overlay.style.display = 'none'; return; }
                if(currentQuizId !== q.id) {
                    document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.remove('selected'));
                    document.getElementById('quizWait').style.display = 'none';
                    currentQuizId = q.id;
                }
                overlay.style.display = 'flex';
                const btns = document.querySelectorAll('.quiz-opt-btn');
                const msg = document.getElementById('quizStatusMsg');
                if(q.status === 'open') {
                    canAnswer = true;
                    msg.innerText = "정답을 선택하세요!";
                    msg.style.color = "#3b82f6";
                    btns.forEach(b => b.classList.add('active-mode'));
                } else if(q.status === 'ready') {
                    canAnswer = false;
                    msg.innerText = "문제를 확인하세요 (대기)";
                    msg.style.color = "#333";
                    btns.forEach(b => b.classList.remove('active-mode'));
                } else {
                    canAnswer = false;
                    msg.innerText = "마감되었습니다.";
                    msg.style.color = "#ef4444";
                    btns.forEach(b => b.classList.remove('active-mode'));
                }
            });
        }

        const qInput = document.getElementById('qInput');
        const charCount = document.getElementById('charCount');
        qInput.addEventListener('input', () => {
            const len = qInput.value.length;
            charCount.innerText = `${len} / 100`;
            if(len >= 100) charCount.classList.add('limit');
            else charCount.classList.remove('limit');
        });

        // 5분 카운트다운 로직
        function startEditTimers() {
            if(editInterval) clearInterval(editInterval);
            editInterval = setInterval(() => {
                const now = Date.now();
                document.querySelectorAll('.edit-timer').forEach(el => {
                    const key = el.id.split('-')[1];
                    const postTime = myQs[key];
                    if(postTime) {
                        const remain = 300000 - (now - postTime); // 5분
                        if(remain <= 0) { 
                            // 시간 초과 시 버튼 그룹 숨김
                            const actionDiv = document.getElementById(`actions-${key}`);
                            if(actionDiv) actionDiv.style.display = 'none';
                        } else { 
                            const m = Math.floor(remain/60000); 
                            const s = Math.floor((remain%60000)/1000); 
                            el.innerText = `${m}:${s<10?'0'+s:s}`; 
                        }
                    }
                });
            }, 1000);
        }

        // [수정 모드]
        function editQ(key) {
            dbRef.qa.child(key).once('value', s => {
                const txt = s.val().text;
                document.getElementById('qInput').value = txt;
                
                const btn = document.getElementById('submitBtn');
                btn.innerHTML = 'Update <i class="fa-solid fa-pen"></i>';
                btn.classList.add('mode-edit'); // 초록색 변경
                
                editingKey = key; // 현재 수정중인 키 저장
                document.getElementById('qInput').focus();
            });
        }

        // [삭제]
        function deleteQ(key) {
            if(confirm("정말 삭제하시겠습니까?")) {
                dbRef.qa.child(key).remove();
                alert("삭제되었습니다.");
            }
        }

        // [제출] (신규 등록 & 수정 공통)
        function submitQ() {
            const txt = document.getElementById('qInput').value.trim();
            if(!txt) return;
            
            // 1. 수정 모드일 경우 (쿨타임 체크 안함)
            if(editingKey) {
                dbRef.qa.child(editingKey).update({ text: txt });
                
                // 초기화
                editingKey = null; 
                const btn = document.getElementById('submitBtn');
                btn.innerHTML = 'Send <i class="fa-solid fa-paper-plane"></i>'; 
                btn.classList.remove('mode-edit');
                
                document.getElementById('qInput').value = ""; 
                alert("수정되었습니다."); 
                return;
            }
            
            // 2. 신규 등록일 경우 (쿨타임 체크)
            const now = Date.now();
            if(now - lastPostTime < 120000) return; // 2분 쿨타임
            
            const ref = dbRef.qa.push();
            ref.set({ text: txt, likes: 0, timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'normal' });
            
            // 로컬에 내 글 기록 (5분 수정용)
            myQs[ref.key] = now; 
            localStorage.setItem(`myqs_${currentRoom}`, JSON.stringify(myQs));
            
            // 쿨타임 기록 (2분 제한용)
            lastPostTime = now; 
            localStorage.setItem(`lastTime_${currentRoom}`, now);
            
            document.getElementById('qInput').value = ""; 
            checkCooldown();
        }

        function checkCooldown() {
            const diff = Date.now() - lastPostTime;
            const btn = document.getElementById('submitBtn');
            const msg = document.getElementById('coolTimer');
            
            // 수정 모드가 아닐 때만 쿨타임 적용
            if(!editingKey && diff < 120000) {
                btn.disabled = true; 
                msg.style.visibility = 'visible';
                msg.innerText = `Wait ${Math.ceil((120000 - diff)/1000)}s`; 
                setTimeout(checkCooldown, 1000);
            } else { 
                if(!editingKey) btn.disabled = false; // 수정모드가 아닐때만 품
                msg.style.visibility = 'hidden'; 
            }
        }

        function toggleLike(key) {
            if(myLikes[key]) return; 
            dbRef.qa.child(key).transaction(post => { 
                if(post) post.likes = (post.likes||0) + 1; 
                return post; 
            });
            myLikes[key] = true; 
            localStorage.setItem(`likes_${currentRoom}`, JSON.stringify(myLikes));
        }

        function sendAns(choice) {
            if(!canAnswer) return;
            document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.quiz-opt-btn')[choice-1].classList.add('selected');
            let myToken = localStorage.getItem('userToken');
            if(!myToken) { myToken = Math.random().toString(36).substr(2); localStorage.setItem('userToken', myToken); }
            dbRef.ans.child(currentQuizId).child(myToken).set({ choice: choice, timestamp: firebase.database.ServerValue.TIMESTAMP });
            document.getElementById('quizWait').style.display = 'block';
        }

        function openMenu() {
            const list = document.getElementById('roomList'); list.innerHTML = "";
            for(let i=65; i<=90; i++) { 
                const char = String.fromCharCode(i); 
                list.innerHTML += `<div class="room-item" onclick="switchRoom('${char}')">Course Room ${char}</div>`; 
            }
            document.getElementById('menuModal').style.display = 'flex';
        }

        function switchRoom(targetRoom) {
            const pw = prompt(`Room ${targetRoom} 비밀번호 입력:`); 
            if(!pw) return;
            const db = firebase.database();
            db.ref(`courses/${targetRoom}/settings/password`).once('value', snap => {
                if(String(snap.val()) === String(pw) || (String(snap.val()) === 'undefined' && pw === '1234')) {
                    window.location.search = `?room=${targetRoom}`;
                } else {
                    alert("비밀번호가 틀렸습니다.");
                }
            });
        }

        function toggleNight() { document.body.classList.toggle('night-mode'); }
        function escapeHtml(t) { return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;") : ""; }
    </script>
</body>
</html>