<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KAC Student Platform</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --theme-color: #1e293b; --bg-color: #f1f5f9; --text-color: #333; }
        body.night-mode { --theme-color: #0f172a; --bg-color: #111; --text-color: #eee; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        body { margin: 0; background: var(--bg-color); color: var(--text-color); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Header */
        .header {
            height: 60px; background: var(--bg-color); display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; border-bottom: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 16px; width: 80%; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .room-badge { background: var(--theme-color); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; }
        .title-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px; }

        /* Input Area (Rectangular & Sharp) */
        .input-area {
            background: #1e293b; padding: 20px; flex-shrink: 0; z-index: 90;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            /* No round radius as requested */
            position: relative;
        }
        .q-input {
            width: 100%; border: 3px solid #334155; padding: 15px; border-radius: 4px; /* Slight edge */
            font-size: 16px; margin-bottom: 10px; resize: none; height: 90px;
            background: #0f172a; color: #fff;
        }
        .q-input:focus { outline: none; border-color: #3b82f6; }
        .q-input.limit-reached { border-color: #ef4444; }
        
        .char-counter { position: absolute; right: 25px; bottom: 70px; color: #94a3b8; font-size: 11px; }
        .char-counter.limit { color: #ef4444; }

        .input-actions { display: flex; justify-content: space-between; align-items: center; }
        .timer-msg { font-size: 12px; color: #ef4444; font-weight: bold; visibility: hidden; }
        .btn-submit {
            background: #3b82f6; color: white; padding: 10px 25px; border-radius: 4px;
            font-weight: bold; border: none; font-size: 14px;
        }
        .btn-submit:disabled { background: #64748b; }

        /* List */
        .scroll-container { flex-grow: 1; overflow-y: auto; position: relative; padding-bottom: 60px; }
        .sticky-bar {
            position: sticky; top: 0; background: var(--bg-color); padding: 15px;
            font-size: 14px; font-weight: bold; color: #64748b; z-index: 80;
            display: flex; justify-content: space-between;
        }
        .q-list { padding: 0 15px; }
        .q-card {
            background: #fff; border-radius: 4px; padding: 15px; margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); position: relative;
        }
        .q-card.my-q { border: 2px solid #3b82f6; background: #f0f9ff; }
        
        .q-text { 
            font-size: 15px; line-height: 1.4; color: #333; word-break: break-all; margin-bottom: 10px;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            cursor: pointer;
        }
        .q-text.expanded { -webkit-line-clamp: unset; overflow: visible; }
        
        .q-bottom { display: flex; justify-content: flex-end; align-items: center; gap: 8px; }

        .like-btn {
            background: #f1f5f9; color: #94a3b8; padding: 5px 10px; border-radius: 20px;
            font-size: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .like-btn.active { background: #ffe4e6; color: #f43f5e; }

        /* Edit Button */
        .edit-btn { 
            font-size: 11px; color: #3b82f6; border: 1px solid #3b82f6; padding: 3px 8px; 
            border-radius: 4px; cursor: pointer; display: none; 
        }
        .edit-timer { font-size: 10px; color: #ef4444; }

        /* Fixed Dark Navy Footer with Logo */
        .footer {
            position: fixed; bottom: 0; width: 100%; height: 50px; background: #1e293b; color: #94a3b8;
            display: flex; align-items: center; justify-content: flex-end; padding: 0 20px;
            font-size: 10px; z-index: 200;
        }
        .footer img { height: 20px; opacity: 0.8; }

        /* Quiz Overlay */
        .quiz-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color);
            z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .quiz-badge { background: #3b82f6; color: white; padding: 5px 15px; border-radius: 20px; margin-bottom: 20px; font-size: 12px; font-weight: bold; }
        .quiz-msg { font-size: 20px; font-weight: 800; text-align: center; margin-bottom: 40px; color: var(--text-color); }
        .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .quiz-opt-btn { 
            height: 100px; font-size: 30px; font-weight: 900; background: #fff; 
            border: 4px solid #cbd5e1; border-radius: 15px; color: #333;
            pointer-events: none; opacity: 0.5;
        }
        .quiz-opt-btn.active-mode { pointer-events: auto !important; opacity: 1 !important; cursor: pointer; }
        .quiz-opt-btn.selected { border-color: #3b82f6; background: #3b82f6; color: white; }
        .quiz-wait { margin-top: 30px; color: #64748b; font-weight: bold; display: none; }

        /* Menu */
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .menu-box { background: white; padding: 30px; border-radius: 15px; width: 300px; text-align: center; }
        .room-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; color: #333; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <i class="fa-solid fa-bars" onclick="openMenu()"></i>
            <span id="roomBadge" class="room-badge">ROOM A</span>
            <span id="roomTitle" class="title-text">...</span>
        </div>
        <div class="header-right">
            <i class="fa-solid fa-moon" onclick="toggleNight()"></i>
        </div>
    </div>

    <div class="input-area">
        <textarea id="qInput" class="q-input" placeholder="본 설문은 익명이며, 서로를 존중하는 표현을 부탁드립니다." maxlength="100"></textarea>
        <span id="charCount" class="char-counter">0 / 100</span>
        <div class="input-actions">
            <span id="coolTimer" class="timer-msg">Wait 02:00</span>
            <button id="submitBtn" class="btn-submit" onclick="submitQ()">Submit</button>
        </div>
    </div>

    <div class="scroll-container">
        <div class="sticky-bar">
            <span><i class="fa-solid fa-comments"></i> Live Questions</span>
            <span style="font-size:12px;">Sort: Likes <i class="fa-solid fa-arrow-down"></i></span>
        </div>
        <div id="qList" class="q-list"></div>
    </div>

    <div class="footer">
        <img src="logo.png" alt="KAC">
    </div>

    <!-- Quiz Overlay -->
    <div id="quizOverlay" class="quiz-overlay">
        <div class="quiz-badge">LIVE QUIZ</div>
        <div class="quiz-msg" id="quizStatusMsg">Select Answer</div>
        <div class="quiz-grid" id="quizBtns">
            <button class="quiz-opt-btn" onclick="sendAns(1)">1</button>
            <button class="quiz-opt-btn" onclick="sendAns(2)">2</button>
            <button class="quiz-opt-btn" onclick="sendAns(3)">3</button>
            <button class="quiz-opt-btn" onclick="sendAns(4)">4</button>
        </div>
        <div class="quiz-wait" id="quizWait">Submitted. Waiting for result...</div>
    </div>

    <div id="menuModal" class="menu-overlay" onclick="if(event.target==this)this.style.display='none'">
        <div class="menu-box"><h3>Select Room</h3><div id="roomList" style="max-height:300px; overflow-y:auto;"></div></div>
    </div>

    <script src="config.js"></script>
    <script>
        const bc = new BroadcastChannel('kac_student_channel');
        bc.onmessage = (e) => { if(e.data === 'here') { alert("Already open in another tab."); window.location.href="about:blank"; } };
        bc.postMessage('here');

        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        let currentRoom = getRoomFromCode(code);
        if(!currentRoom) { document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;'>Invalid Link</h2>"; throw new Error("No Room"); }

        document.getElementById('roomBadge').innerText = `ROOM ${currentRoom}`;

        const dbRef = {
            qa: db.ref(`courses/${currentRoom}/questions`),
            quiz: db.ref(`courses/${currentRoom}/activeQuiz`),
            ans: db.ref(`courses/${currentRoom}/quizAnswers`),
            settings: db.ref(`courses/${currentRoom}/settings`),
            status: db.ref(`courses/${currentRoom}/status/mode`)
        };

        dbRef.settings.on('value', snap => {
            const val = snap.val() || {};
            document.getElementById('roomTitle').innerText = val.courseName ? val.courseName.substring(0,20) : `Course`;
        });

        dbRef.status.on('value', snap => {
            if(snap.val() === 'qa') {
                document.getElementById('quizOverlay').style.display = 'none';
            }
        });

        // 100 Char Limit
        const qInput = document.getElementById('qInput');
        const charCount = document.getElementById('charCount');
        qInput.addEventListener('input', () => {
            const len = qInput.value.length;
            charCount.innerText = `${len} / 100`;
            if(len >= 100) { qInput.classList.add('limit-reached'); charCount.classList.add('limit'); } 
            else { qInput.classList.remove('limit-reached'); charCount.classList.remove('limit'); }
        });

        // Toggle Text Expand
        window.toggleExpand = function(el) {
            el.classList.toggle('expanded');
        };

        // Q&A Logic
        let myLikes = JSON.parse(localStorage.getItem(`likes_${currentRoom}`) || '{}');
        let myQs = JSON.parse(localStorage.getItem(`myqs_${currentRoom}`) || '{}'); 
        let lastPostTime = parseInt(localStorage.getItem(`lastTime_${currentRoom}`) || '0');
        let editInterval = null;

        dbRef.qa.on('value', snap => {
            const data = snap.val() || {};
            const list = document.getElementById('qList');
            list.innerHTML = "";
            let items = Object.keys(data).map(k => ({id:k, ...data[k]}));
            items.sort((a,b) => (b.likes||0) - (a.likes||0) || b.timestamp - a.timestamp);
            
            items.forEach(item => {
                if(item.status === 'delete') return;
                const isMine = myQs[item.id] ? 'my-q' : '';
                const likedClass = myLikes[item.id] ? 'active' : '';
                
                let editHtml = '';
                if(isMine) {
                    const postTime = myQs[item.id];
                    const diff = Date.now() - postTime;
                    if(diff < 300000) { 
                        editHtml = `<span id="timer-${item.id}" class="edit-timer"></span><button class="edit-btn" style="display:inline-block;" onclick="editQ('${item.id}')"><i class="fa-solid fa-pen"></i></button>`;
                    }
                }

                list.innerHTML += `
                    <div class="q-card ${isMine}">
                        <div class="q-text" onclick="toggleExpand(this)">${escapeHtml(item.text)}</div>
                        <div class="q-bottom">
                            ${editHtml}
                            <div class="like-btn ${likedClass}" onclick="toggleLike('${item.id}')"><i class="fa-solid fa-thumbs-up"></i> ${item.likes||0}</div>
                        </div>
                    </div>`;
            });
            startEditTimers();
        });

        function startEditTimers() {
            if(editInterval) clearInterval(editInterval);
            editInterval = setInterval(() => {
                const now = Date.now();
                document.querySelectorAll('.edit-timer').forEach(el => {
                    const key = el.id.split('-')[1];
                    const postTime = myQs[key];
                    if(postTime) {
                        const remain = 300000 - (now - postTime);
                        if(remain <= 0) { el.parentElement.innerHTML = ""; } 
                        else {
                            const m = Math.floor(remain/60000);
                            const s = Math.floor((remain%60000)/1000);
                            el.innerText = `${m}:${s<10?'0'+s:s}`;
                        }
                    }
                });
            }, 1000);
        }

        let editingKey = null;
        function editQ(key) {
            dbRef.qa.child(key).once('value', s => {
                const txt = s.val().text;
                document.getElementById('qInput').value = txt;
                document.getElementById('submitBtn').innerText = "Update";
                editingKey = key;
                document.getElementById('qInput').focus();
            });
        }

        function submitQ() {
            const txt = document.getElementById('qInput').value.trim();
            if(!txt) return;

            if(editingKey) {
                dbRef.qa.child(editingKey).update({ text: txt });
                editingKey = null;
                document.getElementById('submitBtn').innerText = "Submit";
                document.getElementById('qInput').value = "";
                alert("Updated.");
                return;
            }

            const now = Date.now();
            if(now - lastPostTime < 120000) return; 
            
            const ref = dbRef.qa.push();
            ref.set({ text: txt, likes: 0, timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'normal' });
            
            myQs[ref.key] = now; 
            localStorage.setItem(`myqs_${currentRoom}`, JSON.stringify(myQs));
            lastPostTime = now; 
            localStorage.setItem(`lastTime_${currentRoom}`, now);
            
            document.getElementById('qInput').value = ""; 
            checkCooldown();
        }

        function checkCooldown() {
            const diff = Date.now() - lastPostTime;
            const btn = document.getElementById('submitBtn');
            const msg = document.getElementById('coolTimer');
            if(diff < 120000) {
                btn.disabled = true; msg.style.visibility = 'visible';
                msg.innerText = `Wait ${Math.ceil((120000 - diff)/1000)}s`;
                setTimeout(checkCooldown, 1000);
            } else { btn.disabled = false; msg.style.visibility = 'hidden'; }
        }
        checkCooldown();

        function toggleLike(key) {
            if(myLikes[key]) return;
            dbRef.qa.child(key).transaction(post => { if(post) post.likes = (post.likes||0) + 1; return post; });
            myLikes[key] = true; localStorage.setItem(`likes_${currentRoom}`, JSON.stringify(myLikes));
        }

        // Quiz Logic Fix
        let currentQuizId = null;
        let canAnswer = false;

        dbRef.quiz.on('value', snap => {
            const q = snap.val();
            const overlay = document.getElementById('quizOverlay');
            if(!q || q.status === 'result') { overlay.style.display = 'none'; return; }

            if(currentQuizId !== q.id) {
                document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.remove('selected'));
                document.getElementById('quizWait').style.display = 'none';
                currentQuizId = q.id;
            }

            overlay.style.display = 'flex';
            const btns = document.querySelectorAll('.quiz-opt-btn');

            if(q.status === 'open') {
                canAnswer = true;
                document.getElementById('quizStatusMsg').innerText = "Select Answer Now!";
                btns.forEach(b => b.classList.add('active-mode'));
            } else if(q.status === 'ready') {
                canAnswer = false;
                document.getElementById('quizStatusMsg').innerText = "Look at the Screen (Ready)";
                btns.forEach(b => b.classList.remove('active-mode'));
            } else {
                canAnswer = false;
                document.getElementById('quizStatusMsg').innerText = "Closed.";
                btns.forEach(b => b.classList.remove('active-mode'));
            }
        });

        function sendAns(choice) {
            if(!canAnswer) return;
            document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.quiz-opt-btn')[choice-1].classList.add('selected');
            
            let myToken = localStorage.getItem('userToken');
            if(!myToken) { myToken = Math.random().toString(36).substr(2); localStorage.setItem('userToken', myToken); }
            
            dbRef.ans.child(currentQuizId).child(myToken).set({ choice: choice, timestamp: firebase.database.ServerValue.TIMESTAMP });
            document.getElementById('quizWait').style.display = 'block';
        }

        function openMenu() {
            const list = document.getElementById('roomList');
            list.innerHTML = "";
            for(let i=65; i<=90; i++) {
                const char = String.fromCharCode(i);
                list.innerHTML += `<div class="room-item" onclick="switchRoom('${char}')">Course Room ${char}</div>`;
            }
            document.getElementById('menuModal').style.display = 'flex';
        }
        function switchRoom(targetRoom) {
            const pw = prompt(`Enter Password for Room ${targetRoom}:`);
            if(!pw) return;
            db.ref(`courses/${targetRoom}/settings/password`).once('value', snap => {
                if(snap.val() == pw) window.location.search = `?code=${getCodeFromRoom(targetRoom)}`;
                else alert("Wrong Password.");
            });
        }
        function toggleNight() { document.body.classList.toggle('night-mode'); }
        function escapeHtml(t) { return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;") : ""; }
    </script>
</body>
</html>