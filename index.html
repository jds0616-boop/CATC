<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KAC Student Platform</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        :root { --header-bg: #0f172a; --bg-color: #0f172a; --accent-color: #3b82f6; --btn-yellow: #facc15; --btn-text: #1e293b; --card-bg: #ffffff; --text-color: #1e293b; --input-bg: #f8fafc; --safe-area-bottom: env(safe-area-inset-bottom); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
        body { margin: 0; background: var(--bg-color); color: var(--text-color); height: 100dvh; overflow: hidden; }
        .landing-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--header-bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 40px 20px; text-align: center; }
        .landing-course { font-size: 24px; font-weight: 800; margin-bottom: 10px; line-height: 1.3; }
        .landing-room { font-size: 16px; opacity: 0.7; font-weight: 500; margin-bottom: 60px; padding: 5px 15px; border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; }
        .btn-enter { background: var(--btn-yellow); color: var(--btn-text); width: 200px; height: 56px; border-radius: 30px; font-size: 18px; font-weight: 800; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3); display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.1s; }
        .btn-enter:active { transform: scale(0.96); }
        .landing-logo { position: absolute; bottom: 40px; width: 120px; z-index: 9999; }
        .app-container { width: 100%; height: 100%; display: none; flex-direction: column; position: relative; background: var(--bg-color); max-width: 600px; margin: 0 auto; }
        .header { height: 56px; background: var(--header-bg); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header-btn { width: 40px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; color: white; }
        .header-center { flex-grow: 1; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        .header-title { font-size: 15px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .header-sub { font-size: 11px; opacity: 0.8; margin-top: 2px; display: flex; gap: 6px; align-items: center; }
        .live-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #22c55e; }
        .sort-bar { padding: 10px 15px; background: var(--bg-color); display: flex; gap: 10px; z-index: 80; flex-shrink: 0; }
        .sort-chip { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(255,255,255,0.1); color: #94a3b8; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .sort-chip.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .scroll-container { flex-grow: 1; overflow-y: auto; position: relative; padding: 0 15px 120px 15px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .scroll-container::-webkit-scrollbar { display: none; }
        .q-card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; display: flex; gap: 12px; align-items: flex-start; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; }


/* ë‚´ê°€ ì‘ì„±í•œ ì§ˆë¬¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ë…¹ìƒ‰ìœ¼ë¡œ ë³€ê²½) */
.q-card.my-q { 
    border: 2px solid #10b981; /* ë…¹ìƒ‰ í…Œë‘ë¦¬ */
    background: #f0fdf4;       /* ì—°í•œ ë…¹ìƒ‰ ë°°ê²½ */
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1); 
}
/* ë‚´ê°€ ì‘ì„±í•œ ì¹´ë“œì˜ ì•„ë°”íƒ€(ì•„ì´ì½˜) ë°°ê²½ìƒ‰ */
.my-q .q-avatar { 
    background: #10b981; 
    color: white; 
}




        .q-content { flex-grow: 1; min-width: 0; }
        .q-text { font-size: 15px; line-height: 1.5; color: var(--text-color); margin-bottom: 8px; word-break: break-word; font-weight: 500; white-space: pre-wrap; }
        .q-meta { font-size: 11px; color: #94a3b8; display: flex; gap: 8px; align-items: center; }
        .btn-mini { cursor: pointer; padding: 4px 8px; background: rgba(0,0,0,0.05); border-radius: 4px; }
        .q-like-area { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 44px; flex-shrink: 0; gap: 4px; }
        .like-btn { width: 44px; height: 44px; border-radius: 12px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; color: #cbd5e1; font-size: 18px; cursor: pointer; transition: 0.2s; }
        .like-btn.active { background: #fee2e2; color: #ef4444; transform: scale(1.05); }
        .like-count { font-size: 12px; font-weight: 700; color: #64748b; }
        .like-btn.active + .like-count { color: #ef4444; }
        
        .input-dock { 
    position: fixed; /* absoluteì—ì„œ fixedë¡œ ë³€ê²½ */
    bottom: 0; 
    left: 0; 
    width: 100%; 
    background: var(--input-bg); 
    border-top-left-radius: 20px; 
    border-top-right-radius: 20px; 
    padding: 10px 15px calc(15px + var(--safe-area-bottom)) 15px; /* íŒ¨ë”© ì‚´ì§ ì¦ê°€ */
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1); 
    z-index: 1000; /* ë ˆì´ì–´ ìˆœìœ„ ë†’ì„ */
    display: flex; 
    flex-direction: column; 
    gap: 4px;
}


/* ë¯¸ë‹ˆ ê³µì§€ ë°” ìŠ¤íƒ€ì¼ */
.mini-notice-bar {
    display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
    background: #fef3c7; /* ì—°í•œ í™©ê¸ˆìƒ‰ */
    height: 36px;
    align-items: center;
    padding: 0 10px;
    border-bottom: 1px solid #fde68a;
    overflow: hidden;
    position: relative;
    cursor: pointer;
    z-index: 90;
    flex-shrink: 0;
}

.notice-icon {
    color: #d97706;
    font-size: 14px;
    margin-right: 8px;
    z-index: 2;
    background: #fef3c7;
    padding-right: 5px;
}

.notice-ticker {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    position: relative;
}

.notice-text {
    display: inline-block;
    padding-left: 100%;
    animation: marquee 20s linear infinite;
    font-size: 13px;
    font-weight: 700;
    color: #92400e;
}

@keyframes marquee {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100%); }
}

.notice-close {
    padding: 5px 8px;
    color: #b45309;
    font-size: 14px;
    z-index: 2;
    background: #fef3c7;
}










        .input-box { background: white; border-radius: 20px; padding: 10px 10px 10px 15px; display: flex; align-items: flex-end; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; min-height: 48px; height: auto; }
        .real-input { flex-grow: 1; border: none; background: transparent; font-size: 16px; line-height: 1.4; color: var(--text-color); outline: none; resize: none; height: 24px; max-height: 120px; padding: 0; margin-bottom: 2px; overflow-y: hidden; font-family: 'Pretendard', sans-serif; }


/* ì»¤ìŠ¤í…€ íŒì—… ë””ìì¸ (ì‹œì¸ì„± ê°•í™”) */
        .kac-confirm-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 20000;
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .kac-confirm-box {
            background: white; width: 100%; max-width: 320px;
            border-radius: 20px; overflow: hidden; border: 3px solid #3b82f6;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .kac-confirm-msg {
            padding: 30px 20px; text-align: center; font-size: 18px;
            font-weight: 800; color: #1e293b; line-height: 1.5; white-space: pre-wrap;
        }
        .kac-confirm-btns { display: flex; border-top: 1px solid #e2e8f0; }
        .kac-btn-no {
            flex: 1; padding: 18px; background: #f1f5f9; border: none;
            font-size: 16px; font-weight: 700; color: #64748b; cursor: pointer;
        }
        .kac-btn-yes {
            flex: 1; padding: 18px; background: #3b82f6; border: none;
            font-size: 16px; font-weight: 700; color: white; cursor: pointer;
        }
















/* ì…ë ¥ì°½ ê°€ì´ë“œ ë¬¸êµ¬ ë””ìì¸ ê°œì„  */
.real-input::placeholder {
    color: rgba(239, 68, 68, 0.6); /* íˆ¬ëª…ë„ê°€ ìˆëŠ” ë¹¨ê°„ìƒ‰ (ë¶€ë“œëŸ¬ìš´ ê²½ê³ ) */
    font-weight: 700;
    font-style: italic;           /* ê¸°ìš¸ì„ê¼´ë¡œ ì‹¤ì œ ëŒ“ê¸€ê³¼ ì°¨ë³„í™” */
    font-size: 14px;              /* ê¸€ì í¬ê¸°ë¥¼ ì‚´ì§ ì¤„ì„ */
}

/* ì•„ì´í°/ì‚¬íŒŒë¦¬ ëŒ€ì‘ */
.real-input::-webkit-input-placeholder {
    color: rgba(239, 68, 68, 0.6);
    font-weight: 700;
    font-style: italic;
    font-size: 14px;
}

        .real-input:disabled { background: transparent; color: #94a3b8; opacity: 1; }
        .send-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--accent-color); color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 15px; cursor: pointer; flex-shrink: 0; transition: 0.2s; margin-left: 8px; margin-bottom: 1px; }
        .send-btn:active { transform: scale(0.9); }
        .send-btn.editing { background: #10b981; }
        .input-info-row { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; font-size: 11px; font-weight: 600; }
        .char-counter { color: #94a3b8; } .char-counter.limit { color: #ef4444; font-weight: 800; }
        .cooldown-text { color: #ef4444; font-weight: 800; }
        
        .quiz-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .quiz-box { width: 100%; background: white; border-radius: 24px; padding: 30px 20px; text-align: center; }
        .quiz-opt-btn { width: 100%; height: 70px; margin-bottom: 10px; border-radius: 12px; font-size: 20px; font-weight: 800; border: 2px solid #e2e8f0; background: #f8fafc; color: #333; transition: 0.2s; }
        .quiz-opt-btn.selected { background: var(--accent-color); color: white; border-color: var(--accent-color); transform: scale(1.02); }
        .quiz-opt-btn.locked { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        #quizResultBox { animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .quiz-king-stamp { position: absolute; top: 5px; right: 5px; width: 95px; height: 95px; border: 4px double #facc15; border-radius: 50%; color: #facc15; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 900; font-size: 14px; transform: rotate(15deg); background: rgba(250, 204, 21, 0.1); z-index: 10; animation: stampIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes stampIn { from { transform: scale(3) rotate(45deg); opacity: 0; } to { transform: scale(1) rotate(15deg); opacity: 1; } }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .menu-box { 
    background: white; 
    width: 80%; 
    max-width: 350px; 
    border-radius: 16px; 
    padding: 20px; 
    text-align: center; 
    max-height: 85vh;    /* í™”ë©´ ë†’ì´ì˜ 85%ê¹Œì§€ë§Œ ì»¤ì§€ê²Œ ì œí•œ */
    overflow-y: auto;   /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ì„¸ë¡œ ìŠ¤í¬ë¡¤ë°” ìƒì„± */
}



/* ë©”ë‰´ ìƒë‹¨ ë‚´ ì •ë³´ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .user-profile-card {
            background: #f8fafc;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            text-align: left;
            position: relative;
        }
        .profile-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .profile-name {
            font-size: 18px;
            font-weight: 900;
            color: #1e293b;
        }
        .btn-edit-profile {
            font-size: 13px;
            color: #3b82f6;
            font-weight: 700;
            cursor: pointer;
            background: #eff6ff;
            padding: 4px 10px;
            border-radius: 6px;
        }
        .profile-dorm {
            font-size: 14px;
            font-weight: 800;
            color: #6366f1;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        /* ìƒí™œê´€ ì•„ì´ì½˜: ë§µí•€ í˜•íƒœì˜ ì„¸ë ¨ëœ ì•„ì´ì½˜ ì ìš© */
        .profile-dorm i {
            color: #3b82f6;
            font-size: 16px;
        }



        .menu-item { padding: 15px; border-bottom: 1px solid #eee; font-weight: 600; cursor: pointer; color: #333; }


/* ê³µì§€ì‚¬í•­ ë° QR ë””ìì¸ */
        .notice-card { background: #f8fafc; border-radius: 14px; padding: 15px; margin-bottom: 12px; border: 1px solid #e2e8f0; text-align: left; }
        .notice-tag { font-size: 11px; font-weight: 800; padding: 3px 8px; border-radius: 6px; color: white; margin-bottom: 8px; display: inline-block; }
        .tag-global { background: #10b981; } /* ì„¼í„°ê³µì§€ ë…¹ìƒ‰ */
        .tag-course { background: #3b82f6; } /* ê³¼ì •ê³µì§€ íŒŒë€ìƒ‰ */
        .tag-global { background: #10b981; } /* ì„¼í„°ê³µì§€ ë…¹ìƒ‰ */
        .tag-course { background: #3b82f6; } /* ê°•ì‚¬ê³µì§€ íŒŒë€ìƒ‰ */
        .tag-coord { background: #6366f1; }  /* ì½”ë””ê³µì§€ ë³´ë¼ìƒ‰ (ì¶”ê°€ë¨) */
        .notice-body { font-size: 14px; line-height: 1.6; color: #334155; white-space: pre-wrap; font-weight: 500; }
        .qr-img-full { width: 100%; border-radius: 12px; display: block; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }



/* ì°¨ëŸ‰ ì‹ ì²­ ë²„íŠ¼ ì„ íƒ ì‹œ í™œì„±í™” ìŠ¤íƒ€ì¼ (ì—°í•œ ë…¹ìƒ‰) */
.quiz-opt-btn.shuttle-active {
    background-color: #f0fdf4 !important; /* ì—°í•œ ë…¹ìƒ‰ ë°”íƒ• */
    border-color: #22c55e !important;    /* ì„ ëª…í•œ ë…¹ìƒ‰ í…Œë‘ë¦¬ */
    color: #166534 !important;           /* ì§„í•œ ë…¹ìƒ‰ ê¸€ì */
    font-weight: 900 !important;
    transform: scale(1.02);              /* ì‚´ì§ ì»¤ì§€ëŠ” íš¨ê³¼ */
    box-shadow: 0 4px 10px rgba(34, 197, 94, 0.2);
}





    </style>
</head>
<body>

<!-- [ìˆ˜ì •] ê°œì¸ì •ë³´ ë™ì˜ ì ˆì°¨ê°€ ì¶”ê°€ëœ í”„ë¡œí•„ ë“±ë¡ íŒì—… -->
<div id="profileOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,42,0.98); z-index:10000; flex-direction:column; align-items:center; justify-content:center; color:white; padding:20px; text-align:center;">
    <div style="background:white; color:#1e293b; padding:30px 20px; border-radius:24px; width:100%; max-width:350px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
        <h2 style="margin:0 0 10px 0; font-weight:900; color:#0f172a;">ë³¸ì¸ í™•ì¸</h2>
        <p style="font-size:13px; color:#64748b; margin-bottom:20px; line-height:1.5;">ì›í™œí•œ êµìœ¡ í–‰ì • ì„œë¹„ìŠ¤(ì¶œê²°, ë°°ì°¨, ìƒí™œê´€)ë¥¼ ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        
        <input type="text" id="userName" placeholder="ì„±í•¨ ì…ë ¥" style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:12px; font-size:18px; margin-bottom:12px; text-align:center; outline:none;">
        <input type="number" id="userPhone" placeholder="ì „í™”ë²ˆí˜¸ ë’· 4ìë¦¬" style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:12px; font-size:18px; margin-bottom:15px; text-align:center; outline:none;">
        
        <!-- ê°œì¸ì •ë³´ ë™ì˜ ì˜ì—­ -->
        <div style="background:#f8fafc; padding:12px; border-radius:10px; text-align:left; margin-bottom:20px; border:1px solid #e2e8f0;">
            <label style="display:flex; align-items:flex-start; gap:8px; cursor:pointer;">
                <input type="checkbox" id="privacyAgree" style="width:18px; height:18px; margin-top:2px;">
                <span style="font-size:12px; color:#475569; line-height:1.4;">
                    (í•„ìˆ˜) <b>ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©</b>ì— ë™ì˜í•©ë‹ˆë‹¤. 
                    <br><small style="color:#94a3b8;">*ëª©ì : êµìœ¡ìš´ì˜ ë° ìˆ˜ì†¡ê´€ë¦¬<br>*í•­ëª©: ì„±ëª…, ì „í™”ë²ˆí˜¸ ë’·4ìë¦¬<br>*ë³´ìœ : êµìœ¡ ì¢…ë£Œ ì‹œ ì¦‰ì‹œ íŒŒê¸°</small>
                </span>
            </label>
        </div>
        
        <button onclick="saveProfileWithCheck()" style="width:100%; padding:16px; background:#3b82f6; color:white; border:none; border-radius:12px; font-size:18px; font-weight:900; cursor:pointer; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">ë™ì˜í•˜ê³  ì…ì¥í•˜ê¸°</button>
    </div>
</div>

    <div id="landingPage" class="landing-page">
        <div class="landing-course" id="landingTitle">Loading...</div>
        <div class="landing-room" id="landingBadge">Room ...</div>
        <button class="btn-enter" onclick="enterApp()">ì…ì¥í•˜ê¸° <i class="fa-solid fa-arrow-right-to-bracket"></i></button>
        <img src="logo.png" alt="KAC" class="landing-logo">
    </div>
    <div class="app-container" id="mainApp">
<div class="header">
    <div class="header-btn" onclick="exitApp()"><i class="fa-solid fa-chevron-left"></i></div>
    <div class="header-center">
        <div class="header-title" id="roomTitle">Course Name</div>
        <div class="header-sub">
            <span class="live-dot"></span>
            <span id="realUserCount">0ëª… ì ‘ì†</span> Â· <span id="roomBadge">Room A</span>
        </div>
    </div>
    <div class="header-btn" onclick="openMainMenu()">
        <i class="fa-solid fa-bars"></i>
    </div>
</div>

<!-- [ì‹ ê·œ] ë¯¸ë‹ˆ ê³µì§€ ë°” (ê³µì§€ê°€ ìˆì„ ë•Œë§Œ ë…¸ì¶œë¨) -->
<div id="miniNoticeBar" class="mini-notice-bar" onclick="openNotice()">
    <i class="fa-solid fa-bullhorn notice-icon"></i>
    <div class="notice-ticker">
        <span id="miniNoticeText" class="notice-text"></span>
    </div>
    <div class="notice-close" onclick="event.stopPropagation(); closeMiniNotice()">
        <i class="fa-solid fa-xmark"></i>
    </div>
</div>

<!-- ì •ë ¬ ë°” ì˜ì—­ -->
<div class="sort-bar">
    <div class="sort-chip active" id="sortNew" onclick="setSort('new')">ğŸ•’ ìµœì‹ ìˆœ</div>
    <div class="sort-chip" id="sortLike" onclick="setSort('like')">ğŸ‘ ê³µê°ìˆœ</div>
</div>
        <div class="scroll-container" id="scrollContainer"><div id="qList" class="q-list"></div></div>
        <div class="input-dock" id="inputDock">

<!-- [ì‹ ê·œ] ì§ˆë¬¸ ëŒ€ìƒ(ê³¼ëª©) ì„ íƒì°½ -->
<div style="padding: 0 15px 8px 15px;">
    <select id="subjectSelect" onchange="handleSubjectChange()" style="width:100%; padding:10px; border-radius:12px; border:2px solid #e2e8f0; font-size:14px; font-weight:800; color:var(--accent-color); background:white; outline:none;">
        <option value="ê³µí†µì§ˆë¬¸">ì§ˆë¬¸ ëŒ€ìƒ ì„ íƒ (ê¸°ë³¸: ê³µí†µì§ˆë¬¸)</option>
    </select>
</div>
            <div class="input-box">
                <textarea id="qInput" class="real-input" rows="1" 
          placeholder="âœ ì§ˆë¬¸ ì…ë ¥ (ë¬´ë¡€í•œ í‘œí˜„ì€ ì‚¼ê°€ì£¼ì„¸ìš”)" 
          maxlength="100" ...></textarea>
                <button id="submitBtn" class="send-btn" onclick="submitQ()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
            <div class="input-info-row"><span id="coolTimer" class="cooldown-text"></span><span id="charCount" class="char-counter">0 / 100</span></div>
        </div>
    </div>
    <div id="quizOverlay" class="quiz-overlay">
        <div id="quizActiveBox" class="quiz-box">
            <div style="margin-bottom:20px; font-weight:900; font-size:24px; color:#3b82f6;">LIVE QUIZ</div>
<!-- í•™ìƒìš© íƒ€ì´ë¨¸ ë””ìì¸ ì¶”ê°€ -->
<div id="studentQuizTimerBox" style="display:none; justify-content:center; align-items:center; gap:10px; margin-bottom:15px;">
    <i class="fa-regular fa-clock" style="color:#64748b; font-size:20px;"></i>
    <div id="studentTimer" style="font-family: monospace; font-size:30px; font-weight:900; color:#1e293b;">00:08</div>
</div>
            <div id="quizStatusMsg" style="margin-bottom:20px; font-size:16px; font-weight:bold; color:#1e293b;">ê°•ì‚¬ë‹˜ì´ í€´ì¦ˆë¥¼ ì‹œì‘í•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...</div>
            <div id="btnGroupMultiple" style="display:none; flex-direction:column; gap:5px;">
                <button class="quiz-opt-btn" onclick="sendAns(1)">1ë²ˆ</button><button class="quiz-opt-btn" onclick="sendAns(2)">2ë²ˆ</button><button class="quiz-opt-btn" onclick="sendAns(3)">3ë²ˆ</button><button class="quiz-opt-btn" onclick="sendAns(4)">4ë²ˆ</button>
            </div>
            <div id="btnGroupOX" style="display:none; gap:15px;">
                <button class="quiz-opt-btn ox-btn" onclick="sendAns(1)" style="flex:1; height:120px; font-size:40px;">O</button><button class="quiz-opt-btn ox-btn" onclick="sendAns(2)" style="flex:1; height:120px; font-size:40px;">X</button>
            </div>
            <div id="quizFeedback" style="margin-top:15px; font-weight:800; color:#ef4444; min-height:20px;"></div>
        </div>
        <div id="quizResultBox" class="quiz-box" style="display:none; background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%); position:relative; overflow:hidden;">
            <div id="quizKingStamp" style="display:none;" class="quiz-king-stamp"><span style="font-size:30px;">ğŸ‘‘</span><span>í€´ì¦ˆì™•</span></div>
            <div style="font-size:50px; margin-bottom:10px;">ğŸ†</div>
            <h2 style="margin:0; font-weight:900; color:#0f172a;">QUIZ RESULT</h2>
            <div style="margin:25px 0;"><div style="font-size:14px; color:#64748b; font-weight:bold;">ë‹¹ì‹ ì˜ ìµœì¢… ì ìˆ˜</div><div id="myFinalScore" style="font-size:48px; font-weight:900; color:#3b82f6;">0ì </div></div>
            <div style="background:#3b82f6; color:white; padding:15px; border-radius:12px; font-weight:800;">í˜„ì¬ <span id="myFinalRank">0</span>ë“± (ì „ì²´ ì°¸ì—¬ì ì¤‘)</div>
            <button class="btn-enter" onclick="closeResultOverlay()" style="margin:20px auto 0 auto; width:100%;">í™•ì¸ ë° ë‹«ê¸°</button>
        </div>
    </div>



<div id="menuModal" class="menu-overlay" onclick="if(event.target==this)this.style.display='none'">
        <div class="menu-box">
            <!-- [ì¶”ê°€] ë§ˆì´ í”„ë¡œí•„ ì¹´ë“œ ì„¹ì…˜ -->
            <div class="user-profile-card">
                <div class="profile-info-row">
                    <div class="profile-name">
                        <span id="displayMyName">-</span>ë‹˜ <span style="font-size:14px; color:#94a3b8; font-weight:500;">(<span id="displayMyPhone">0000</span>)</span>
                    </div>
                    <div class="btn-edit-profile" onclick="editProfile()">ì •ë³´ ìˆ˜ì •</div>
                </div>
                <div class="profile-dorm" id="displayMyDormArea">
                    <i class="fa-solid fa-map-location-dot"></i>
                    <span id="displayMyDorm">ìƒí™œê´€ ì •ë³´ í™•ì¸ ì¤‘...</span>
                </div>
            </div>

            <h3 style="margin-bottom:15px; font-size:16px; color:#64748b;">ë©”ë‰´ ì„œë¹„ìŠ¤</h3>
            <div class="menu-item" onclick="openNotice()"><i class="fa-solid fa-bullhorn" style="color: #facc15;"></i> ê³µì§€ì‚¬í•­ </div>
            <div class="menu-item" onclick="viewMealMenu()"><i class="fa-solid fa-utensils"></i> ê¸ˆì£¼ ì‹ë‹¨ë³´ê¸°</div>
            <div class="menu-item" onclick="openShuttleApply()"><i class="fa-solid fa-bus"></i> ì°¨ëŸ‰ ì‹ ì²­</div>
            <div class="menu-item" onclick="openAdminAction()"><i class="fa-solid fa-file-signature"></i> ì™¸ì¶œÂ·ì™¸ë°• / ì„ì‹ì œì™¸</div>
            <div class="menu-item" onclick="openAttendanceQR()"><i class="fa-solid fa-qrcode" style="color: #3b82f6;"></i> ì¶œê²° QR í™•ì¸</div>
            <button onclick="document.getElementById('menuModal').style.display='none'" style="margin-top:15px; width:100%; padding:12px; border:none; border-radius:12px; background:#f1f5f9; font-weight:900; color:#475569;">ë‹«ê¸°</button>
        </div>
    </div>







<!-- [ê°œí¸] ì°¨ëŸ‰ ì‹ ì²­ íŒì—… -->
<div id="shuttleModal" class="menu-overlay" style="display:none; z-index: 7000;">
    <div class="menu-box" style="width:90%; padding: 25px 20px; border-radius: 24px; max-width: 400px;">
        <h3 style="margin-bottom: 5px; color:#1e293b; font-weight:900;">í‡´êµ ì°¨ëŸ‰ ì‹ ì²­</h3>
        
        <!-- ê¸°ì‚¬ë‹˜ ì „ë‹¬ ì‹œê°„ í‘œì‹œ ì˜ì—­ -->
        <div id="driverNoticeBar" style="background: #eff6ff; border: 1px solid #dbeafe; padding: 12px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 11px; font-weight: 800; color: #3b82f6; margin-bottom: 4px;">ğŸ“¢ í•­ê¸°ì› ì¶œë°œ ì˜ˆì • ì‹œê°„</div>
            <div id="departureTimeText" style="font-size: 18px; font-weight: 900; color: #1e40af;">ì‹œê°„ ì •ë³´ ì—†ìŒ</div>
        </div>

        <!-- ì‹ ì²­ ì „: ë²„íŠ¼ ì„ íƒ ì˜ì—­ -->
        <div id="shuttleSelectionArea">
            <p style="font-size:12px; color:#94a3b8; margin-bottom:15px; text-align: center;">ì´ë™ ìˆ˜ë‹¨ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="quiz-opt-btn shuttle-btn" onclick="selectShuttle('car', 'ìì°¨(ê°œë³„ì´ë™)')" style="justify-content: center; height:55px; font-size:17px; background:#f1f5f9; border-color:#e2e8f0; color:#64748b;">ìì°¨ (ê°œë³„ì´ë™)</button>
                <button class="quiz-opt-btn shuttle-btn" onclick="selectShuttle('osong', 'ì˜¤ì†¡ì—­')" style="justify-content: center; height:55px; font-size:17px; border-color:#fca5a5; color:#b91c1c;">ì˜¤ì†¡ì—­</button>
                <button class="quiz-opt-btn shuttle-btn" onclick="selectShuttle('terminal', 'ì²­ì£¼í„°ë¯¸ë„')" style="justify-content: center; height:55px; font-size:17px; border-color:#93c5fd; color:#1e40af;">ì²­ì£¼í„°ë¯¸ë„</button>
                <button class="quiz-opt-btn shuttle-btn" onclick="selectShuttle('airport', 'ì²­ì£¼ê³µí•­')" style="justify-content: center; height:55px; font-size:17px; border-color:#86efac; color:#166534;">ì²­ì£¼êµ­ì œê³µí•­</button>
            </div>
        </div>

        <!-- ì‹ ì²­ í›„: ë‚´ì—­ í™•ì¸ ë° ì·¨ì†Œ ì˜ì—­ -->
        <div id="shuttleCancelArea" style="display:none; background: #f8fafc; padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; text-align:center;">
            <p style="font-size: 12px; font-weight: 800; color: #64748b; margin-bottom:5px;">ğŸ“ ë‚˜ì˜ ì‹ ì²­ í˜„í™©</p>
            <p id="myCurrentShuttleText" style="font-size: 20px; font-weight: 900; color: #1e293b; margin-bottom:20px;"></p>
            <button onclick="cancelShuttleRequest()" style="width: 100%; padding: 15px; background: #ef4444; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: bold;">ì‹ ì²­ ì·¨ì†Œí•˜ê¸°</button>
        </div>

        <button onclick="closeShuttleModal()" style="margin-top:20px; width:100%; padding:15px; border:none; border-radius:15px; background:#f1f5f9; color: #475569; font-size: 18px; font-weight: 900;">ë‹«ê¸°</button>
    </div>
</div>








<!-- [ìµœì¢… ìˆ˜ì •] ì™¸ì¶œ/ì™¸ë°• ì‹ ì²­ ë° ë³µê·€ ì‹œìŠ¤í…œ íŒì—… -->
<div id="adminActionModal" class="menu-overlay" style="display:none; z-index: 7000;">
    <div class="menu-box" style="width:95%; padding: 20px; border-radius: 20px; max-width: 450px;">
        <h3 style="margin-bottom: 5px; font-weight:900;">ì™¸ì¶œÂ·ì™¸ë°• ì‹ ì²­ì„œ ì‘ì„±</h3>
        <p id="adminActionDate" style="font-size:12px; color:#94a3b8; margin-bottom:15px;">ì˜¤ëŠ˜ ë‚ ì§œ: 2026-01-20</p>

        <!-- [í˜„í™© ì˜ì—­] ì´ë¯¸ ì‹ ì²­í–ˆì„ ë•Œë§Œ ë³´ì„ -->
        <div id="adminStatusArea" style="display:none; background: #f0f7ff; padding: 15px; border-radius: 12px; border: 1px solid #3b82f6; margin-bottom: 20px; text-align: left;">
            <p style="font-size: 14px; font-weight: 800; color: #3b82f6; margin: 0 0 5px 0;">í˜„ì¬ ì‹ ì²­ ë° ë³µê·€ í˜„í™©</p>
            <div id="adminStatusText" style="font-size: 14px; color: #1e293b; margin: 0; line-height: 1.5;"></div>
            
            <div id="returnBtnArea" style="margin-top:15px; display:flex; flex-direction:column; gap:8px;">
                <div id="beforeReturnGroup" style="display:flex; gap:8px;">
                    <button onclick="confirmReturnAction()" style="flex:2; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: bold;">ë³µê·€ ì™„ë£Œ ë³´ê³ </button>
                    <button onclick="cancelAdminAction()" style="flex:1; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: bold;">ì·¨ì†Œ</button>
                </div>
                <div id="afterReturnGroup" style="display:none;">
                    <button onclick="undoReturnAction()" style="width:100%; padding: 12px; background: #64748b; color: white; border: none; border-radius: 8px; font-weight: bold;">ë³µê·€ ë³´ê³  ì·¨ì†Œ (ì¬ìˆ˜ì •)</button>
                </div>
<!-- [ì°¾ì„ ìœ„ì¹˜] afterReturnGroup ê°€ ëë‚˜ëŠ” </div> ë°”ë¡œ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš” -->
<div id="dinnerOnlyGroup" style="display:none;">
    <button onclick="cancelDinnerOnly()" style="width:100%; padding: 12px; background: #64748b; color: white; border: none; border-radius: 8px; font-weight: bold;">
        ğŸ´ ì„ì‹ ì œì™¸ì‹ ì²­ ì·¨ì†Œ
    </button>
</div>

            </div>
        </div>

<!-- [ìµœì¢…] ìë™ì™„ì„± ê¸°ëŠ¥ì´ ì¶”ê°€ëœ ì…ë ¥ ì–‘ì‹ ì˜ì—­ -->
        <div id="adminActionForm" style="display: none; text-align: left; flex-direction: column; gap: 12px;">
            <div style="display: flex; gap: 8px;">
                <button class="quiz-opt-btn admin-type-btn" id="btn-outing" onclick="selectAdminType('outing')" style="height:45px; font-size:14px; flex:1; margin-bottom:0;">ì™¸ì¶œ (ë‹¹ì¼)</button>
                <button class="quiz-opt-btn admin-type-btn" id="btn-overnight" onclick="selectAdminType('overnight')" style="height:45px; font-size:14px; flex:1; margin-bottom:0;">ì™¸ë°• (ìµì¼)</button>
            </div>

            <div>
                <label style="font-size:11px; font-weight:800; color:#64748b;">ì†Œì† (ì˜ˆ: ê¹€í¬ê³µí•­ ë ˆì´ë”ê´€ì œë¶€ ë“±)</label>
                <input type="text" id="userDept" list="deptHistory" placeholder="ì†Œì† ë¶€ì„œë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width:100%; padding:12px; border:1.5px solid #e2e8f0; border-radius:10px; outline:none; font-size:15px;">
                <datalist id="deptHistory"></datalist> <!-- ì†Œì† ì €ì¥ì†Œ -->
            </div>

            <div style="background: #f8fafc; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 10px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label style="font-size:13px; font-weight:800; color:#64748b;">ì™¸ì¶œ ì‹œê°„</label>
                    <input type="time" id="startTime" style="width:60%; padding:8px; border:1px solid #cbd5e1; border-radius:8px; font-size:15px;">
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label style="font-size:13px; font-weight:800; color:#64748b;">ë³µê·€ ì‹œê°„</label>
                    <input type="time" id="endTime" style="width:60%; padding:8px; border:1px solid #cbd5e1; border-radius:8px; font-size:15px;">
                </div>
                <div id="returnDateArea" style="display:none; border-top: 1px dashed #cbd5e1; padding-top:10px; display: flex; align-items: center; justify-content: space-between;">
                    <label style="font-size:13px; font-weight:800; color:#e11d48;">ë³µê·€ ë‚ ì§œ</label>
                    <input type="date" id="returnDate" style="width:60%; padding:8px; border:1px solid #fda4af; border-radius:8px; font-size:14px;">
                </div>
            </div>

            <div>
                <label style="font-size:11px; font-weight:800; color:#64748b;">í–‰ì„ ì§€</label>
                <input type="text" id="destination" list="destHistory" placeholder="ì˜ˆ: ì²­ì£¼ì‹œë‚´" style="width:100%; padding:12px; border:1.5px solid #e2e8f0; border-radius:10px; outline:none; font-size:15px;">
                <datalist id="destHistory"></datalist> <!-- í–‰ì„ ì§€ ì €ì¥ì†Œ -->
            </div>

            <div>
                <label style="font-size:11px; font-weight:800; color:#64748b;">ì‹ ì²­ ì‚¬ìœ </label>
                <input type="text" id="outingReason" list="reasonHistory" placeholder="ì˜ˆ: ê°œì¸ìš©ë¬´ ë“±" style="width:100%; padding:12px; border:1.5px solid #e2e8f0; border-radius:10px; outline:none; font-size:15px;">
                <datalist id="reasonHistory"></datalist> <!-- ì‚¬ìœ  ì €ì¥ì†Œ -->
            </div>

            <div>
                <label style="font-size:11px; font-weight:800; color:#64748b;">ë¹„ìƒ ì—°ë½ì²˜</label>
                <input type="tel" id="fullPhone" placeholder="010-0000-0000" style="width:100%; padding:12px; border:1.5px solid #e2e8f0; border-radius:10px; outline:none; font-size:15px;">
            </div>

<!-- ì„ì‹ ì œì™¸ ì²´í¬ë°•ìŠ¤ ì¶”ê°€ -->
            <div style="background: #fdf2f2; padding: 12px; border-radius: 12px; border: 1px solid #fee2e2; margin-top: 5px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="skipDinner" style="width:20px; height:20px; accent-color: #ef4444;">
                    <span style="font-size:15px; font-weight:800; color:#b91c1c;">ì˜¤ëŠ˜ ì €ë… ì‹ì‚¬ë¥¼ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
                </label>
                <p style="font-size:11px; color:#ef4444; margin: 8px 0 0 30px; font-weight: 600;">
                    â€» 16:00 ì´í›„ì—ëŠ” ë³€ê²½ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.
                </p>
            </div>




            <button onclick="submitAdminAction()" style="width: 100%; padding: 15px; background: #10b981; color: white; border: none; border-radius: 12px; font-size: 17px; font-weight: 900; margin-top:5px;">ì‹ ì²­ì„œ ì œì¶œ</button>
        </div>

        <button onclick="document.getElementById('adminActionModal').style.display='none'" style="margin-top:15px; width:100%; padding:12px; border:none; border-radius:12px; background:#f1f5f9; color: #475569; font-size: 15px; font-weight: 800; cursor: pointer;">ë‹«ê¸°</button>
    </div>
</div>











<!-- [ì‹ ê·œ] ê³µì§€ì‚¬í•­ íŒì—… -->
    <div id="noticeModal" class="menu-overlay" style="display:none; z-index: 9000;" onclick="if(event.target==this)this.style.display='none'">
        <div class="menu-box">
            <h3 style="margin-bottom:20px;">ğŸ“¢ ì¤‘ìš” ê³µì§€ì‚¬í•­</h3>
            <div id="noticeContainer"></div>
            <button onclick="document.getElementById('noticeModal').style.display='none'" style="margin-top:15px; width:100%; padding:12px; border:none; border-radius:8px; background:#e2e8f0; font-weight:bold;">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- [ì‹ ê·œ] ì¶œê²° QR í™•ì¸ íŒì—… -->
    <div id="qrModal" class="menu-overlay" style="display:none; z-index: 9001;" onclick="if(event.target==this)this.style.display='none'">
        <div class="menu-box">
            <h3 style="margin-bottom:15px;">ì¶œê²° QR (ê³ ìš©ë…¸ë™ë¶€)</h3>
            <img id="qrImage" src="" class="qr-img-full" style="display:none;">
            <div id="qrEmptyMsg" style="padding:40px 0; color:#94a3b8; font-weight:bold; display:none;">ë“±ë¡ëœ QRì´ ì—†ìŠµë‹ˆë‹¤.</div>
            <button onclick="document.getElementById('qrModal').style.display='none'" style="margin-top:20px; width:100%; padding:12px; border:none; border-radius:8px; background:#e2e8f0; font-weight:bold;">ë‹«ê¸°</button>
        </div>
    </div>


<!-- [ì‹ ê·œ] ì‹ë‹¨í‘œ ì´ë¯¸ì§€ íŒì—… -->
<div id="mealMenuModal" class="menu-overlay" style="display:none; z-index: 8000;" onclick="this.style.display='none'">
    <div style="width:90%; max-width:500px; background:white; border-radius:20px; padding:10px; position:relative;">
        <img id="mealMenuImage" src="" style="width:100%; border-radius:15px; display:block;" alt="ì‹ë‹¨í‘œ ì¤€ë¹„ì¤‘">
        <p style="margin-top:10px; font-weight:bold; color:#64748b;">(í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ë‹«í™ë‹ˆë‹¤)</p>
    </div>
</div>















    <script src="config.js"></script>
    <script>
        let serverTimeOffset = 0; // ì¶”ê°€
let confirmCallback = null;
        function showKacConfirm(msg, callback) {
            document.getElementById('kacConfirmMsg').innerText = msg;
            document.getElementById('kacConfirm').style.display = 'flex';
            confirmCallback = callback;
        }
        function closeKacConfirm(result) {
            document.getElementById('kacConfirm').style.display = 'none';
            if(result && confirmCallback) confirmCallback();
            confirmCallback = null;
        }



        let dbRef = {}; let currentRoom = null; let myQs = {}; let myLikes = {}; let lastPostTimeMap = JSON.parse(localStorage.getItem(`lastTimeMap_${currentRoom}`) || '{}'); let editingKey = null; let currentSort = 'new'; let currentQuizId = null; let canAnswer = false;  let myLastChoice = null; let myLastChoiceIdx = null; let hasClosedSummary = false; let rankingListener = null; let studentTimerInterval = null; let currentFilter = "ê³µí†µì§ˆë¬¸"; 


function sendAns(idx) {
    if (!canAnswer || !currentQuizId) return; 

    myLastChoiceIdx = idx; // ë‚´ê°€ ì„ íƒí•œ ë²ˆí˜¸ ì €ì¥
    const oxArea = document.getElementById('btnGroupOX');
    const multArea = document.getElementById('btnGroupMultiple');
    
    // í˜„ì¬ ì–´ë–¤ ë²„íŠ¼ ê·¸ë£¹ì´ í™”ë©´ì— ë³´ì´ëŠ”ì§€ í™•ì¸
    const isOX = (oxArea.style.display === 'flex' || oxArea.offsetParent !== null);
    myLastChoice = isOX ? (idx === 1 ? 'O' : 'X') : idx + 'ë²ˆ';

    // [í•µì‹¬ ìˆ˜ì •] í˜„ì¬ ëˆˆì— ë³´ì´ëŠ” ë²„íŠ¼ ê·¸ë£¹ ì•ˆì—ì„œë§Œ ë²„íŠ¼ì„ ì°¾ì•„ ìƒ‰ì„ ë°”ê¿‰ë‹ˆë‹¤.
    const activeArea = isOX ? oxArea : multArea;
    const buttons = activeArea.querySelectorAll('.quiz-opt-btn');
    
    buttons.forEach((btn, i) => {
        btn.classList.remove('selected'); // ê¸°ì¡´ íŒŒë€ìƒ‰ ì œê±°
        if ((i + 1) === idx) {
            btn.classList.add('selected'); // ì„ íƒí•œ ë²„íŠ¼ë§Œ íŒŒë€ìƒ‰ ì¶”ê°€
        }
    });

    // Firebase ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
    const uToken = localStorage.getItem('uToken');
    if(uToken && currentQuizId) {
        dbRef.ans.child(currentQuizId).child(uToken).set({
            choice: idx,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }
    
    // í•˜ë‹¨ í”¼ë“œë°± ë¬¸êµ¬ ì¶œë ¥
    document.getElementById('quizFeedback').innerHTML = `<i class="fa-solid fa-check"></i> ${myLastChoice} ì„ íƒ ì™„ë£Œ!`;
}





        
// [ìˆ˜ì •] index.htmlì˜ ìµœí•˜ë‹¨ (async function init() { ... })
(async function init() {
    const params = new URLSearchParams(window.location.search);
    const directRoom = params.get('room'); // ìƒˆë¡œ ì°ì€ QRì˜ ë°© (ì˜ˆ: C)
    const code = params.get('code');

    // [ê°•ë ¥ ë¡œì§ 1] URLì— ë°© ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ê·¸ ë°©ì„ í˜„ì¬ ë°©ìœ¼ë¡œ í™•ì •
    if (directRoom) {
        currentRoom = directRoom;
    } else if (code) {
        currentRoom = await resolveRoomFromCode(code);
    }

    // [ê°•ë ¥ ë¡œì§ 2] ë°© ë²ˆí˜¸ê°€ ë°”ë€Œì—ˆëŠ”ì§€ í™•ì¸í•˜ê³ , ë°ì´í„° ê²½ë¡œ ë¦¬ì…‹
    if (!currentRoom) {
        alert("ê°•ì˜ì‹¤ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. QR ì½”ë“œë¥¼ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.");
        return;
    }

    // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ì´ì „ ë°© ì´ë¦„ì´ ë³´ì´ì§€ ì•Šê²Œ)
    document.getElementById('roomBadge').innerText = `Room ${currentRoom}`;
    document.getElementById('landingBadge').innerText = `ROOM ${currentRoom}`;

    // í•´ë‹¹ ë°©(currentRoom) ì „ìš© ë°ì´í„° ì €ì¥ì†Œ ì—°ê²°
    myLikes = JSON.parse(localStorage.getItem(`likes_${currentRoom}`) || '{}'); 
    myQs = JSON.parse(localStorage.getItem(`myqs_${currentRoom}`) || '{}'); 
    lastPostTimeMap = JSON.parse(localStorage.getItem(`lastTimeMap_${currentRoom}`) || '{}');

    const db = firebase.database();
    const rPath = `courses/${currentRoom}`;
    dbRef = { 
        qa: db.ref(`${rPath}/questions`), 
        quiz: db.ref(`${rPath}/activeQuiz`), 
        ans: db.ref(`${rPath}/quizAnswers`), 
        settings: db.ref(`${rPath}/settings`), 
        status: db.ref(`${rPath}/status`), 
        connections: db.ref(`${rPath}/connections`) 
    };

    // [ì¤‘ìš”] ì¶œì„ ì²´í¬ í•¨ìˆ˜ í˜¸ì¶œ (ì´ë•Œ roomì€ ìƒˆë¡œ ì°ì€ 'C'ì—¬ì•¼ í•¨)
    handleInternalAttendance(currentRoom); 

    // ë¦¬ìŠ¤ë„ˆ ë° í‚¤ë³´ë“œ ë³´ì • ì‹¤í–‰
    setupListeners(); 
    checkCooldown(); 
    initKeyboardFix();
})();




async function enterApp() {
    // 1. ê°•ì‚¬ì˜ ê°•ì˜ì‹¤ ìƒíƒœë¥¼ ë¨¼ì € í™•ì¸í•©ë‹ˆë‹¤.
    const statusSnap = await firebase.database().ref(`courses/${currentRoom}/status/roomStatus`).once('value');
    const roomStatus = statusSnap.val();

    // 2. 'active'(ì‚¬ìš©ì¤‘)ê°€ ì•„ë‹ˆë©´ ì…ì¥ì„ ë§‰ìŠµë‹ˆë‹¤.
    if (roomStatus !== 'active') {
        alert("âš ï¸ ê°•ì‚¬ë‹˜ì´ ì•„ì§ ê°•ì˜ë¥¼ ì‹œì‘í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        return; // ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œ (ì…ì¥ ì•ˆ ë¨)
    }

    // 3. 'active'ì¼ ë•Œë§Œ ê¸°ì¡´ ì…ì¥ ë¡œì§ ì‹¤í–‰
    const doc = document.documentElement;
    if (doc.requestFullscreen) doc.requestFullscreen().catch(e=>{});
    await checkProfile();
}


function openMainMenu() {
    // 1. ë‚´ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ê³µë°± ì œê±°)
    const myName = (localStorage.getItem('kac_user_name') || "ë¯¸ë“±ë¡").trim();
    const myPhone = (localStorage.getItem('kac_user_phone') || "0000").trim();
    const dormTextEl = document.getElementById('displayMyDorm');

    // 2. ìƒë‹¨ ì´ë¦„/ë²ˆí˜¸ í‘œì‹œ
    document.getElementById('displayMyName').innerText = myName;
    document.getElementById('displayMyPhone').innerText = myPhone;

    // 3. [ì§€ëŠ¥í˜• ì‹¤ì‹œê°„ ë§¤ì¹­] 
    // ìš°ì„ ìˆœìœ„ 1: 'ì´ë¦„_ë²ˆí˜¸'ë¡œ ëœ ì •ë°€ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸ (ë™ëª…ì´ì¸ ìˆ˜ë™ êµ¬ë¶„ìš©)
    // ìš°ì„ ìˆœìœ„ 2: ì¼ë°˜ 'ì´ë¦„' ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸ (ê¸°ë³¸ ë§¤ì¹­)
    
    const dormAssignmentsRef = firebase.database().ref(`system/dormitory_assignments`);

    // .onì„ ì‚¬ìš©í•˜ì—¬ ì§€ì›ë¶€ì—ì„œ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •í•˜ë“  ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì‘í•©ë‹ˆë‹¤.
    dormAssignmentsRef.on('value', snap => {
        const allDormData = snap.val() || {};
        
        // [A] ì´ë¦„_ë²ˆí˜¸ ì¡°í•© (ì˜ˆ: í™ê¸¸ë™_3126) í™•ì¸
        const precisionKey = `${myName}_${myPhone}`;
        
        if (allDormData[precisionKey]) {
            const data = allDormData[precisionKey];
            dormTextEl.innerText = `${data.building} ${data.room}í˜¸`;
            dormTextEl.style.color = "#3b82f6";
            dormTextEl.style.fontWeight = "900";
        } 
        // [B] ì¼ë°˜ ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™) í™•ì¸
        else if (allDormData[myName]) {
            const data = allDormData[myName];
            dormTextEl.innerText = `${data.building} ${data.room}í˜¸`;
            dormTextEl.style.color = "#3b82f6";
            dormTextEl.style.fontWeight = "900";
        } 
        // [C] ë°ì´í„° ì—†ìŒ
        else {
            dormTextEl.innerText = "ìƒí™œê´€ ë°°ì • ì •ë³´ í™•ì¸ ì¤‘...";
            dormTextEl.style.color = "#94a3b8";
        }
    });

    document.getElementById('menuModal').style.display = 'flex';
}





// [ì‹ ê·œ] ì •ë³´ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
function editProfile() {
    // [ì¤‘ìš”] ìˆ˜ì • ì „ì˜ ì´ë¦„ê³¼ ë²ˆí˜¸ë¥¼ ë¯¸ë¦¬ ë°±ì—…í•´ë‘¡ë‹ˆë‹¤. (ë‚˜ì¤‘ì— ì§€ìš°ê¸° ìœ„í•¨)
    const oldName = localStorage.getItem('kac_user_name');
    const oldPhone = localStorage.getItem('kac_user_phone');
    localStorage.setItem('kac_old_uToken', `${oldName}_${oldPhone}`);

    document.getElementById('userName').value = oldName || "";
    document.getElementById('userPhone').value = oldPhone || "";
    
    document.getElementById('menuModal').style.display = 'none';
    document.getElementById('profileOverlay').style.display = 'flex';
}






        // [ìˆ˜ì •] ì™„ì „íˆ ë‚˜ê°€ê¸° (ì£¼ì†Œ ì´ˆê¸°í™”)
function exitApp() {

    if (confirm("í˜„ì¬ ê°•ì˜ì‹¤ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {

    const uToken = localStorage.getItem('uToken');
    if (uToken && currentRoom) {
        firebase.database().ref(`courses/${currentRoom}/students/${uToken}/isOnline`).set(false);
    }

        const ua = navigator.userAgent.toLowerCase();
        
        // 1. ì¹´ì¹´ì˜¤í†¡ ì¸ì•± ë¸Œë¼ìš°ì € ê°•ì œ ì¢…ë£Œ (ì„±ê³µ ì‹œ ì—¬ê¸°ì„œ ëë‚¨)
        if (ua.indexOf('kakaotalk') !== -1) {
            location.href = 'kakaotalk://inappbrowser/close';
            return;
        }

        // 2. ë„¤ì´ë²„ ì•± ì¸ì•± ë¸Œë¼ìš°ì € ê°•ì œ ì¢…ë£Œ (ì„±ê³µ ì‹œ ì—¬ê¸°ì„œ ëë‚¨)
        if (ua.indexOf('naver') !== -1) {
            location.href = 'naversearchapp://inappbrowser/close';
            return;
        }

        // 3. ê·¸ ì™¸ (ì•„ì´í° ì¹´ë©”ë¼, í¬ë¡¬, ì‚¬íŒŒë¦¬ ë“±)
        // [ì¤‘ìš”] ì ˆëŒ€ window.location.href ë¡œì§ì„ ë„£ì§€ ë§ˆì„¸ìš”! (ì…ì¥ì°½ìœ¼ë¡œ ê°€ëŠ” ì›ì¸)
        
        // ë¸Œë¼ìš°ì €ê°€ ì°½ì„ ë‹«ëŠ” ê²ƒì„ ê±°ë¶€í•  ë•Œë¥¼ ëŒ€ë¹„í•´ í™”ë©´ì„ 'í‡´ì¥ ì•ˆë‚´'ë¡œ ë®ì–´ë²„ë¦½ë‹ˆë‹¤.
        document.documentElement.innerHTML = `
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>í‡´ì¥ ì™„ë£Œ</title>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                <style>
                    body { background: #0f172a; color: white; margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; }
                    .exit-box { height: 100dvh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
                    .icon { font-size: 80px; color: #3b82f6; margin-bottom: 20px; }
                    h2 { font-size: 24px; margin: 0; }
                    p { font-size: 16px; opacity: 0.7; margin-top: 15px; line-height: 1.5; }
                    .btn-close { margin-top: 30px; padding: 12px 40px; background: #334155; color: white; border: none; border-radius: 30px; font-weight: bold; }
                </style>
            </head>
            <body>
                <div class="exit-box">
                    <div class="icon"><i class="fa-solid fa-right-from-bracket"></i></div>
                    <h2>í‡´ì¥ ì™„ë£Œ</h2>
                    <p>ì •ìƒì ìœ¼ë¡œ í‡´ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì´ ë¸Œë¼ìš°ì € ì°½(íƒ­)ì„ ë‹«ì•„ì£¼ì„¸ìš”.</p>
                    <button class="btn-close" onclick="window.close()">ì°½ ë‹«ê¸° ì‹œë„</button>
                </div>

            </body>
        `;

        // íˆìŠ¤í† ë¦¬ë¥¼ ê¼¬ì•„ë²„ë ¤ ë’¤ë¡œê°€ê¸°ë¥¼ í•´ë„ ì…ì¥ì°½ìœ¼ë¡œ ëª» ëŒì•„ê°€ê²Œ í•¨
        window.history.pushState(null, null, window.location.href);
        window.onpopstate = function() { window.history.go(1); };

        // ë§ˆì§€ë§‰ìœ¼ë¡œ ì°½ ë‹«ê¸° ì‹œë„
        setTimeout(() => { window.close(); }, 300);
    }
}














// [ìµœì¢… ë³´ê°•] ìœ ë ¹ íšŒì› ë°©ì§€ ë° ê°•ì œ í‡´ì¶œ ë¡œì§ ì™„ê²°íŒ
function startPresence() {
    const uToken = localStorage.getItem('uToken');
    const name = localStorage.getItem('kac_user_name');
    const phone = localStorage.getItem('kac_user_phone');
    
    // ì…ì¥ê¶Œì´ ì—†ìœ¼ë©´ ì‹¤í–‰ ì¤‘ë‹¨
    if (!uToken || !currentRoom || !name) {
        if(document.getElementById('mainApp')) document.getElementById('mainApp').style.display = 'none';
        return;
    }

    const myRef = firebase.database().ref(`courses/${currentRoom}/students/${uToken}`);
    const connectedRef = firebase.database().ref(".info/connected");

    // [1] ì‹¤ì‹œê°„ ê°ì‹œ: ë‚´ê°€ ì„œë²„ì—ì„œ ì§€ì›Œì§€ëŠ” ìˆœê°„ ì¦‰ì‹œ í™”ë©´ ì°¨ë‹¨
    myRef.on('value', snap => {
        if (!snap.exists()) {
            evictUser("í•´ë‹¹ ì •ë³´ê°€ ë³€ê²½ë˜ì–´ ì¬ì‹œì‘í•©ë‹ˆë‹¤.");
        }
    });

    // [2] ì ‘ì† ìƒíƒœ ì—…ë°ì´íŠ¸: ì„œë²„ í™•ì¸ í›„ ëª…ë‹¨ì— ìˆì„ ë•Œë§Œ ë°ì´í„° ì „ì†¡
    connectedRef.on("value", (snap) => {
        if (snap.val() === true) {
            myRef.once('value').then(s => {
                if (s.exists()) {
                    // ì„œë²„ ëª…ë‹¨ì— ë‚´ê°€ ìˆì„ ë•Œë§Œ ì˜¨ë¼ì¸ ìƒíƒœ ë³´ê³ 
                    myRef.update({
                        name: name,
                        phone: phone,
                        isOnline: true,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                    myRef.child('isOnline').onDisconnect().set(false);
                } else {
                    // ì„œë²„ ëª…ë‹¨ì— ì—†ìœ¼ë©´ ë¶€í™œ ì‹œë„ ì°¨ë‹¨ ë° í‡´ì¶œ
                    evictUser("ìœ íš¨í•˜ì§€ ì•Šì€ ì ‘ê·¼ì…ë‹ˆë‹¤.");
                }
            });
        }
    });

    // [ê°•ì œ í‡´ì¶œ í•¨ìˆ˜] ëª¨ë“  ë°ì´í„° ì‚­ì œ ë° í™”ë©´ ë´‰ì‡„
    function evictUser(msg) {
        myRef.off(); // ì„œë²„ ì—°ê²° ëŠê¸°
        localStorage.removeItem('uToken'); // ì…ì¥ê¶Œ ì‚­ì œ
        if(document.getElementById('mainApp')) document.getElementById('mainApp').style.display = 'none';
        alert(msg);
        location.reload(); // ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ê°•ì œ ì´ë™
    }

    // ì „ì²´ ì ‘ì†ì ìˆ˜ ê°ì‹œ
    firebase.database().ref(`courses/${currentRoom}/students`).on('value', (snap) => {
        const data = snap.val() || {};
        const activeUsers = Object.values(data).filter(user => 
            user.name && user.name !== "undefined" && user.isOnline === true
        );
        const countEl = document.getElementById('realUserCount');
        if(countEl) countEl.innerText = `${activeUsers.length}ëª… ì ‘ì†`;
    });
}















function setupListeners() {
            // 1. ì„œë²„ ì‹œê°„ ë™ê¸°í™”
            firebase.database().ref(".info/serverTimeOffset").on("value", (snap) => {
                serverTimeOffset = snap.val() || 0;
            });


            watchNotices(); 


            // 2. ê³¼ì •ëª… ë° ê¸°ë³¸ ì„¤ì • ê°ì‹œ
            dbRef.settings.on('value', s => { 
                const val = s.val() || {}; 
                const title = val.courseName || `Course ${currentRoom}`; 
                document.getElementById('roomTitle').innerText = title; 
                document.getElementById('landingTitle').innerText = title; 
            });

            // 3. ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸ ì‹¤ì‹œê°„ ê°ì‹œ
            dbRef.qa.on('value', snap => renderList(snap.val() || {}));

            // [ì‹ ê·œ ì¶”ê°€] 1ë¶„ë§ˆë‹¤ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°•ì œë¡œ ë‹¤ì‹œ ê·¸ë ¤ì„œ 5ë¶„ ì§€ë‚œ ê¸€ì˜ 'ìˆ˜ì •' ë²„íŠ¼ì„ ìë™ìœ¼ë¡œ ì—†ì•±ë‹ˆë‹¤.
            setInterval(() => {
                dbRef.qa.once('value', snap => {
                    if(snap.exists()) renderList(snap.val());
                });
            }, 60000);

            // 4. ê³¼ëª© ë¦¬ìŠ¤íŠ¸ ì‹¤ì‹œê°„ ë¡œë“œ
            firebase.database().ref(`courses/${currentRoom}/settings/subjects`).on('value', s => {
                const data = s.val() || {};
                const sel = document.getElementById('subjectSelect');
                if(!sel) return;
                let html = '<option value="ê³µí†µì§ˆë¬¸">ì§ˆë¬¸ ëŒ€ìƒ ì„ íƒ (ê¸°ë³¸: ê³µí†µì§ˆë¬¸)</option>';
                Object.values(data).forEach(name => {
                    html += `<option value="${name}">${name}</option>`;
                });
                sel.innerHTML = html;
            });

// 5. ê°•ì˜ì‹¤ ìƒíƒœ ê°ì‹œ (ì¤‘ë³µ ì½”ë“œ ì œê±° ë° ë¡œì§ í†µí•© ë²„ì „)
dbRef.status.on('value', snap => {
    const st = snap.val() || {};

    // [A] ë¦¬ì…‹ ë° ì‚­ì œ ì²´í¬
    const serverResetKey = st.resetKey || 'init';
    const myLocalKey = localStorage.getItem(`kac_resetKey_${currentRoom}`);

    if (!myLocalKey) {
        localStorage.setItem(`kac_resetKey_${currentRoom}`, serverResetKey);
    } else if (myLocalKey !== serverResetKey) {
        localStorage.clear();
        alert("ê°•ì˜ì‹¤ ì •ë³´ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.replace(location.pathname + location.search);
        return;
    }

    const uToken = localStorage.getItem('uToken');
    if (uToken && st.roomStatus === 'active') {
        firebase.database().ref(`courses/${currentRoom}/students/${uToken}`).once('value', sSnap => {
            if (!sSnap.exists() && document.getElementById('mainApp').style.display === 'flex') {
                localStorage.removeItem('uToken');
                alert("ì •ë³´ê°€ ê°±ì‹ ë˜ì—ˆê±°ë‚˜ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
            }
        });
    }

    // [B] ê°•ì‚¬ ìƒíƒœ ì²´í¬
    if (st.roomStatus !== 'active') {
        forceCloseQuiz();
        return;
    }

    // [C] í€´ì¦ˆ ëª¨ë“œ ì „í™˜
    if (st.mode === 'quiz') {
        if (st.quizStep !== 'summary') {
            document.getElementById('quizOverlay').style.display = 'flex';
        }
    } else {
        forceCloseQuiz();
    }
    
    // [D] í€´ì¦ˆ ê²°ê³¼ ë°œí‘œ ì²´í¬
    if (st.quizStep === 'summary') { 
        if(!hasClosedSummary) showFinalRanking(); 
    }
});






// 6. í€´ì¦ˆ ì„¸ë¶€ ì§„í–‰ ê°ì‹œ (ë¦¬ì…‹ ë¡œì§ ë° ì—°ë™ ë³´ì™„)
            dbRef.quiz.on('value', s => {
                const q = s.val(); if(!q) return;

                // [í•µì‹¬ ìˆ˜ì •] ë¬¸ì œ IDê°€ ë°”ë€Œë©´ (ì¦‰, ì§„ì§œ ìƒˆ ë¬¸ì œê°€ ë‚˜ì˜¤ë©´) ë¬´ì¡°ê±´ ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
                if (currentQuizId !== q.id) {
                    currentQuizId = q.id;
                    myLastChoiceIdx = null;
                    myLastChoice = null;
                    canAnswer = false;
                    // ì´ì „ ë¬¸ì œì˜ ëª¨ë“  ì„ íƒ/ì ê¸ˆ íš¨ê³¼ ì œê±°
                    document.querySelectorAll('.quiz-opt-btn').forEach(b => {
                        b.classList.remove('selected', 'locked');
                    });
                }

                if(studentTimerInterval) clearInterval(studentTimerInterval);
                const sTimerBox = document.getElementById('studentQuizTimerBox');
                const sTimerText = document.getElementById('studentTimer');
                if(sTimerBox) sTimerBox.style.display = 'none';

                dbRef.status.once('value', statusSnap => {
                    const st = statusSnap.val() || {};
                    if (st.quizStep === 'summary' && !hasClosedSummary) return; 
                    if (st.mode !== 'quiz') { forceCloseQuiz(); return; }

                    document.getElementById('quizOverlay').style.display = 'flex';
                    const msgBox = document.getElementById('quizStatusMsg');
                    const feedBox = document.getElementById('quizFeedback');

                    // [ìƒíƒœ: ì¼ì‹œì •ì§€]
                    if(q.status === 'pause') {
                        canAnswer = false; 
                        msgBox.innerText = "ì„¤ëª…ì„ ìœ„í•´ ì ì‹œ ë©ˆì·„ìŠµë‹ˆë‹¤.";
                        if(sTimerBox && q.remainingTime !== undefined) {
                            sTimerBox.style.display = 'flex';
                            sTimerText.innerText = `00:${q.remainingTime < 10 ? '0' + q.remainingTime : q.remainingTime}`;
                        }
                        // ë²„íŠ¼ ì ê¸ˆ ìœ ì§€
                        document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.add('locked'));
                        return; 
                    }

                    // [ìƒíƒœ: ê²°ê³¼ ë°œí‘œ]
                    if (q.status === 'result') { 
                        document.getElementById('btnGroupMultiple').style.display = 'none';
                        document.getElementById('btnGroupOX').style.display = 'none';
                        const correctAns = q.correct;
                        if (q.isSurvey) {
                            msgBox.innerText = "ğŸ“‹ ì„¤ë¬¸ ê²°ê³¼ ìš”ì•½";
                            feedBox.innerHTML = `<span style="color:#3b82f6; font-size:18px;">${q.surveyResult || "ì§‘ê³„ ì™„ë£Œ"}</span>`;
                        } else {
                            if (myLastChoiceIdx === correctAns) {
                                 msgBox.innerText = "ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!"; feedBox.innerHTML = `í›Œë¥­í•©ë‹ˆë‹¤!`;
                            } else {
                                 msgBox.innerText = "ì•—, í‹€ë ¸ìŠµë‹ˆë‹¤...";
                                 const ansText = q.isOX ? (correctAns===1?'O':'X') : `${correctAns}ë²ˆ`;
                                 feedBox.innerHTML = `ì •ë‹µì€ [ ${ansText} ] ì…ë‹ˆë‹¤.`;
                            }
                        }
                        return; 
                    }

                    // [ìƒíƒœ: ëŒ€ê¸° ì¤‘]
                    if(q.status === 'ready') {
                        canAnswer = false; 
                        msgBox.innerText = "ê°•ì‚¬ë‹˜ì˜ ì‹œì‘ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...";
                        document.getElementById('btnGroupMultiple').style.display = 'none';
                        document.getElementById('btnGroupOX').style.display = 'none';
                        feedBox.innerText = "";
                    } 
                    // [ìƒíƒœ: ì§„í–‰ ì¤‘]
                    else if(q.status === 'open') {
                        canAnswer = true; 
                        msgBox.innerText = "ì •ë‹µì„ ì„ íƒí•˜ì„¸ìš”!";
                        
                        // íƒ€ì´ë¨¸ ì‘ë™
                        if(q.endTime && sTimerBox) {
                            sTimerBox.style.display = 'flex';
                            studentTimerInterval = setInterval(() => {
                                const remain = Math.ceil((q.endTime - (Date.now() + serverTimeOffset)) / 1000);
                                const display = remain < 0 ? 0 : remain;
                                sTimerText.innerText = `00:${display < 10 ? '0' + display : display}`;
                                if(remain <= 0) clearInterval(studentTimerInterval);
                            }, 200);
                        }

                        if(q.isOX) {
                            document.getElementById('btnGroupMultiple').style.display = 'none';
                            const oxArea = document.getElementById('btnGroupOX');
                            oxArea.style.display = 'flex';
                            // ë²„íŠ¼ ë¦¬ì…‹ í›„ ë‚´ ì„ íƒ ê°•ì¡°
                            document.querySelectorAll('.ox-btn').forEach((btn, i) => {
                                btn.classList.remove('locked', 'selected');
                                if((i + 1) === myLastChoiceIdx) btn.classList.add('selected');
                            });
                        } else {
                            document.getElementById('btnGroupOX').style.display = 'none';
                            const multArea = document.getElementById('btnGroupMultiple');
                            multArea.style.display = 'flex'; multArea.innerHTML = ""; 
                            q.options.forEach((opt, i) => {
                                const btn = document.createElement('button');
                                btn.className = 'quiz-opt-btn' + ((i+1)===myLastChoiceIdx?' selected':'');
                                btn.innerText = `${i+1}. ${opt}`; 
                                btn.onclick = () => sendAns(i+1);
                                multArea.appendChild(btn);
                            });
                        }
                    }
                    // [ìƒíƒœ: ì‹œê°„ ì¢…ë£Œ/ë§ˆê°]
                    else if(q.status === 'close') {
                        canAnswer = false;
                        document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.add('locked'));
                        msgBox.innerText = myLastChoice ? "ì œì¶œ ì™„ë£Œ" : "ë¯¸ì œì¶œ ë§ˆê°";
                    }
                });
            });

            // 7. ì…ë ¥ì°½ ìë™ ë†’ì´ ì¡°ì ˆ ë° ê¸€ììˆ˜ ì œí•œ
            const qInputEl = document.getElementById('qInput');
            qInputEl.addEventListener('input', function() {
                const len = this.value.length; 
                document.getElementById('charCount').innerText = `${len} / 100`;
                if (len >= 90) document.getElementById('charCount').classList.add('limit'); 
                else document.getElementById('charCount').classList.remove('limit');
                this.style.height = '1px'; 
                this.style.height = (this.scrollHeight) + 'px';
            });
        }



        function setSort(type) { currentSort = type; document.getElementById('sortNew').classList.toggle('active', type === 'new'); document.getElementById('sortLike').classList.toggle('active', type === 'like'); dbRef.qa.once('value', s => renderList(s.val()||{})); }

// [ì¶”ê°€] ëˆ„ë½ëœ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ì´ê²Œ ìˆì–´ì•¼ ì§ˆë¬¸ ëª©ë¡ì´ ëœ¹ë‹ˆë‹¤)
        function formatTime(ts) {
            if(!ts) return "";
            const d = new Date(ts);
            const hh = d.getHours().toString().padStart(2, '0');
            const mm = d.getMinutes().toString().padStart(2, '0');
            return hh + ":" + mm;
        }

        function escapeHtml(text) {
            const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }





// [ìµœì¢… ìˆ˜ì •] ì§ˆë¬¸ ëª©ë¡ ë Œë”ë§ (ë‚´ê°€ ì“´ ê¸€ ë…¹ìƒ‰ ê°•ì¡° ë¡œì§ í¬í•¨)
function renderList(data) {
    const list = document.getElementById('qList'); 
    list.innerHTML = ""; 
    
    // 1. ì „ì²´ ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜
    let items = Object.keys(data).map(k => ({id:k, ...data[k]}));
    
    // 2. ê°•ì‚¬ë³„ í•„í„°ë§ ë¡œì§
    if (currentFilter !== "ê³µí†µì§ˆë¬¸") {
        items = items.filter(item => item.subject === currentFilter);
    }
    
    // 3. ì •ë ¬ ë¡œì§
    if(currentSort === 'like') {
        items.sort((a,b) => (b.likes||0) - (a.likes||0) || b.timestamp - a.timestamp); 
    } else {
        items.sort((a,b) => b.timestamp - a.timestamp);
    }

    // 4. ì§ˆë¬¸ì´ ì—†ì„ ë•Œ ì•ˆë‚´ ë¬¸êµ¬
    if (items.length === 0) {
        const emptyMsg = currentFilter === "ê³µí†µì§ˆë¬¸" 
            ? "ë“±ë¡ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤." 
            : `'${currentFilter}'ë‹˜ê»˜ ë“±ë¡ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.`;
        list.innerHTML = `<div style="text-align:center; padding:80px 20px; color:#94a3b8; font-size:14px;">${emptyMsg}</div>`;
        return;
    }

    // 5. ì§ˆë¬¸ ì¹´ë“œ ê·¸ë¦¬ê¸°
    items.forEach(item => {
        if(item.status === 'delete') return;
        
        const isMine = myQs[item.id] ? true : false; // ë‚´ê°€ ì“´ ê¸€ì¸ì§€ íŒë‹¨
        const myQClass = isMine ? 'my-q' : '';       // CSS í´ë˜ìŠ¤ ì ìš©
        const likedClass = myLikes[item.id] ? 'active' : '';
        
        // ê°•ì‚¬ ì„±í•¨ í˜¸ì¹­ ì •ë¦¬
        let targetName = item.subject || 'ê³µí†µì§ˆë¬¸';
        let displayName = "";
        const positions = ["ë³¸ë¶€ì¥", "ê³µí•­ì¥", "ì„¼í„°ì¥", "ë¶€ì¥", "ì°¨ì¥", "ê³¼ì¥", "ì£¼ì„", "êµìˆ˜"];
        const foundPos = positions.find(pos => targetName.includes(pos));
        if (foundPos) displayName = targetName.includes("ë‹˜") ? targetName : targetName + "ë‹˜";
        else if (targetName !== 'ì¼ë°˜' && targetName !== 'ê³µí†µì§ˆë¬¸') displayName = targetName + " ê°•ì‚¬ë‹˜";
        else displayName = targetName;

        // [í•µì‹¬ ìˆ˜ì •] ë‚´ê°€ ì“´ ê¸€ì´ë©´ ë…¹ìƒ‰ ë°°ì§€ ìƒ‰ìƒ, ì•„ë‹ˆë©´ íŒŒë€ìƒ‰ ë°°ì§€ ìƒ‰ìƒ ì ìš©
        const tagBg = isMine ? "#d1fae5" : "#eff6ff";
        const tagColor = isMine ? "#059669" : "#3b82f6";
        const tagBorder = isMine ? "#a7f3d0" : "#dbeafe";

        const instructorTag = `<span style="display:inline-block; background:${tagBg}; color:${tagColor}; font-size:10px; padding:1px 6px; border-radius:4px; margin-right:6px; border:1px solid ${tagBorder}; font-weight:800; vertical-align:middle;">To. ${displayName}</span>`;

        let metaHtml = `<div class="q-meta"><span>${formatTime(item.timestamp)}</span>`;
        
        // ë‚´ê°€ ì“´ ê¸€ì´ê³  + ì‘ì„±í•œ ì§€ 5ë¶„(300,000ms)ì´ ì•ˆ ì§€ë‚¬ì„ ë•Œë§Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë…¸ì¶œ
        if(isMine && (Date.now() - myQs[item.id] < 300000)) {
            metaHtml += `<span class="btn-mini" onclick="editQ('${item.id}')">ìˆ˜ì •</span><span class="btn-mini" onclick="deleteQ('${item.id}')" style="color:#ef4444">ì‚­ì œ</span>`;
        }
        metaHtml += `</div>`;

        list.innerHTML += `
            <div class="q-card ${myQClass}">
                <div class="q-avatar"><i class="fa-solid fa-user"></i></div>
                <div class="q-content">
                    <div class="q-text" style="font-size:15px; color:#1e293b; line-height:1.4;">${instructorTag}<span>${escapeHtml(item.text)}</span></div>
                    ${metaHtml}
                </div>
                <div class="q-like-area">
                    <div class="like-btn ${likedClass}" onclick="toggleLike('${item.id}')"><i class="fa-solid fa-thumbs-up"></i></div>
                    <span class="like-count">${item.likes||0}</span>
                </div>
            </div>`;
    });
}



function handleSubjectChange() {
    // 1. ì„ íƒëœ ê°•ì‚¬ëª…ì„ ê°€ì ¸ì™€ì„œ í•„í„° ë³€ìˆ˜ì— ì €ì¥
    currentFilter = document.getElementById('subjectSelect').value;
    
    // 2. [ì¶”ê°€] ì…ë ¥ì°½ì˜ ì•ˆë‚´ ë¬¸êµ¬(Placeholder)ë¥¼ ì„ íƒí•œ ê°•ì‚¬ì— ë§ì¶° ë³€ê²½
    const inputEl = document.getElementById('qInput');
    if (currentFilter === "ê³µí†µì§ˆë¬¸") {
        inputEl.placeholder = "âœ ì§ˆë¬¸ ì…ë ¥ (ë¬´ë¡€í•œ í‘œí˜„ì€ ì‚¼ê°€ì£¼ì„¸ìš”)";
    } else {
        inputEl.placeholder = `âœ ${currentFilter}ë‹˜ê»˜ ì§ˆë¬¸ ì…ë ¥...`;
    }
    
    // 3. ì¿¨íƒ€ì„ ì²´í¬ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
    checkCooldown();
    
    // 4. ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨ (í•„í„° ì ìš©ëœ renderList í˜¸ì¶œ)
    dbRef.qa.once('value', snap => {
        renderList(snap.val() || {});
    });
}













function submitQ() {
    const txt = document.getElementById('qInput').value.trim();
    if(!txt) return;

    const subject = document.getElementById('subjectSelect').value;
    const now = Date.now();
    
    // [ìˆ˜ì •] ì„ íƒí•œ ê°•ì‚¬(ëŒ€ìƒ)ì— ëŒ€í•œ ë§ˆì§€ë§‰ ì§ˆë¬¸ ì‹œê°„ ì²´í¬
    const lastTimeForSubject = lastPostTimeMap[subject] || 0;

    if(editingKey) {
        dbRef.qa.child(editingKey).update({ text: txt, subject: subject }).then(() => { 
            alert("ìˆ˜ì • ì™„ë£Œ"); 
            resetInput(); 
        });
        return;
    }

    // [ìˆ˜ì •] í•´ë‹¹ ê°•ì‚¬ì—ê²Œ 2ë¶„ì´ ì§€ë‚¬ëŠ”ì§€ í™•ì¸
    if(now - lastTimeForSubject < 120000) { 
        alert(`'${subject}'ë‹˜ê»˜ëŠ” ì ì‹œ í›„ ë‹¤ì‹œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.`); 
        return; 
    }

    const ref = dbRef.qa.push();
    ref.set({
        text: txt,
        subject: subject,
        likes: 0,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });

    myQs[ref.key] = now;
    localStorage.setItem(`myqs_${currentRoom}`, JSON.stringify(myQs));
    
    // [ìˆ˜ì •] í•´ë‹¹ ê°•ì‚¬ì— ëŒ€í•œ ì§ˆë¬¸ ì‹œê°„ë§Œ ì—…ë°ì´íŠ¸í•˜ì—¬ ì €ì¥
    lastPostTimeMap[subject] = now;
    localStorage.setItem(`lastTimeMap_${currentRoom}`, JSON.stringify(lastPostTimeMap));
    
    resetInput();
    checkCooldown();
}



        function toggleLike(key) { if(myLikes[key]) { dbRef.qa.child(key).transaction(p => { if(p) p.likes = (p.likes||0)-1; return p; }); delete myLikes[key]; } else { dbRef.qa.child(key).transaction(p => { if(p) p.likes = (p.likes||0)+1; return p; }); myLikes[key] = true; } localStorage.setItem(`likes_${currentRoom}`, JSON.stringify(myLikes)); }
// [ìˆ˜ì •] ìˆ˜ì • ëª¨ë“œ ì§„ì… (5ë¶„ ê²½ê³¼ ì—¬ë¶€ ì¬ê²€ì‚¬)
        function editQ(key) {
            // í´ë¦­ ì‹œì ì— ë‹¤ì‹œ í•œë²ˆ ì‹œê°„ ì²´í¬
            if (Date.now() - myQs[key] > 300000) {
                alert("âŒ› ì‘ì„± í›„ 5ë¶„ì´ ê²½ê³¼í•˜ì—¬ ë‚´ìš©ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                // ë²„íŠ¼ì„ ì—†ì• ê¸° ìœ„í•´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                dbRef.qa.once('value', s => renderList(s.val() || {}));
                return;
            }

            dbRef.qa.child(key).once('value', s => {
                const el = document.getElementById('qInput'); 
                el.value = s.val().text;
                el.style.height = '1px'; 
                el.style.height = (el.scrollHeight) + 'px';
                document.getElementById('charCount').innerText = `${el.value.length} / 100`;
                document.getElementById('submitBtn').classList.add('editing'); 
                document.getElementById('submitBtn').innerHTML = '<i class="fa-solid fa-check"></i>';
                editingKey = key; 
                el.focus(); 
                checkCooldown(); 
            });
        }
        function deleteQ(key) { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) dbRef.qa.child(key).remove(); }
        function resetInput() { const el = document.getElementById('qInput'); el.value = ""; el.style.height = '24px'; el.focus(); document.getElementById('charCount').innerText = "0 / 100"; document.getElementById('charCount').classList.remove('limit'); document.getElementById('submitBtn').classList.remove('editing'); document.getElementById('submitBtn').innerHTML = '<i class="fa-solid fa-paper-plane"></i>'; editingKey = null; checkCooldown(); }



        function checkCooldown() {
    const btn = document.getElementById('submitBtn');
    const input = document.getElementById('qInput');
    const timerEl = document.getElementById('coolTimer');
    const subject = document.getElementById('subjectSelect').value;

    if(editingKey) { 
        timerEl.innerText = ""; 
        btn.disabled = false; 
        btn.style.opacity = 1; 
        input.disabled = false; 
        input.placeholder = "ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”."; 
        return; 
    }

    const now = Date.now();
    const lastTimeForSubject = lastPostTimeMap[subject] || 0;
    const diff = now - lastTimeForSubject;

    if(diff < 120000) {
        const remain = Math.ceil((120000 - diff) / 1000);
        const mm = Math.floor(remain / 60);
        const ss = remain % 60;
        timerEl.innerText = `â³ [${subject}] ì§ˆë¬¸ ëŒ€ê¸°: ${mm}:${ss.toString().padStart(2, '0')}`;
        btn.disabled = true;
        btn.style.opacity = 0.5;
        input.disabled = true;
        input.placeholder = "ë„ë°° ë°©ì§€ë¥¼ ìœ„í•´ ì ì‹œ ëŒ€ê¸°í•´ì£¼ì„¸ìš”.";
        // 1ì´ˆë§ˆë‹¤ ë‹¤ì‹œ ì²´í¬ (ì´ì „ì— ëŒë˜ íƒ€ì´ë¨¸ì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ ì£¼ì˜)
        setTimeout(checkCooldown, 1000);
    } else {
        timerEl.innerText = "";
        btn.disabled = false;
        btn.style.opacity = 1;
        input.disabled = false;
        input.placeholder = "ê°•ì˜ì¥ ê³µê°œ, ì˜ˆì˜ìˆëŠ” ì§ˆë¬¸";
    }
}




        function showFinalRanking() {
            const myToken = localStorage.getItem('uToken'); if(!myToken) return; if(rankingListener) return;
            document.getElementById('quizOverlay').style.display = 'flex'; document.getElementById('quizActiveBox').style.display = 'block'; document.getElementById('quizResultBox').style.display = 'none';
            document.getElementById('quizStatusMsg').innerText = "ğŸ“Š ì ìˆ˜ë¥¼ ì§‘ê³„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”..."; document.getElementById('btnGroupMultiple').style.display = 'none'; document.getElementById('btnGroupOX').style.display = 'none'; document.getElementById('quizFeedback').innerText = "";
            const resultRef = firebase.database().ref(`courses/${currentRoom}/quizFinalResults/${myToken}`);
            rankingListener = resultRef.on('value', snap => {
                const myResult = snap.val();
                if(myResult) {
                    document.getElementById('quizActiveBox').style.display = 'none'; document.getElementById('quizResultBox').style.display = 'block';
                    document.getElementById('myFinalScore').innerText = `${myResult.score}ì `; document.getElementById('myFinalRank').innerText = myResult.rank;
                    if(myResult.rank === 1) document.getElementById('quizKingStamp').style.display = 'flex'; else document.getElementById('quizKingStamp').style.display = 'none';
                }
            });
        }


function forceCloseQuiz() {
    hasClosedSummary = false; canAnswer = false;
    if (rankingListener) { const myToken = localStorage.getItem('uToken'); firebase.database().ref(`courses/${currentRoom}/quizFinalResults/${myToken}`).off(); rankingListener = null; }
    document.getElementById('quizResultBox').style.display = 'none'; document.getElementById('quizActiveBox').style.display = 'block'; document.getElementById('quizOverlay').style.display = 'none'; document.getElementById('quizKingStamp').style.display = 'none';

    // [ì¶”ê°€] í€´ì¦ˆ ì¢…ë£Œ ì‹œ ëª¨ë“  ë²„íŠ¼ì˜ ì ê¸ˆ í´ë˜ìŠ¤(locked)ë¥¼ ê°•ì œë¡œ ì œê±°
    document.querySelectorAll('.locked').forEach(el => el.classList.remove('locked'));
}



        function closeResultOverlay() { hasClosedSummary = true; document.getElementById('quizOverlay').style.display = 'none'; }
        function openMenu() {
            const box = document.getElementById('roomList'); box.innerHTML = "";
            for(let i=65; i<=90; i++) { let c = String.fromCharCode(i); box.innerHTML += `<div class="menu-item" onclick="changeRoom('${c}')">Room ${c}</div>`; }
            document.getElementById('menuModal').style.display = 'flex';
        }
        function changeRoom(r) {
            const pw = prompt(`Room ${r} ì…ì¥ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`); if (!pw) return;
            firebase.database().ref(`courses/${r}/settings/password`).once('value', snap => {
                const dbPw = snap.val();
                if (!dbPw) { alert("âš ï¸ í•´ë‹¹ ê°•ì˜ì‹¤ì€ ì•„ì§ ê°œì„¤ë˜ì§€ ì•Šì•˜ê±°ë‚˜,\në¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return; }
                if (String(pw) === String(dbPw) || btoa(pw) === String(dbPw)) { window.location.href = `?room=${r}`; } else { alert("â›” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
            });
        }





// --- ì°¨ëŸ‰ ì‹ ì²­ ê´€ë ¨ ë³€ìˆ˜ ì´ˆê¸°í™” ---
let currentShuttleData = null; // ë‚˜ì˜ ì‹ ì²­ ë°ì´í„° ì €ì¥ìš©

// 1. ì°¨ëŸ‰ ì‹ ì²­ íŒì—… ì—´ê¸°
// [ìˆ˜ì •] ê¸°ì‚¬ë‹˜ì´ ì„¤ì •í•œ ì¶œë°œ ì‹œê°„ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—°ë™í•˜ë„ë¡ ë³€ê²½ëœ í•¨ìˆ˜
async function openShuttleApply() {
    document.getElementById('menuModal').style.display = 'none';
    document.getElementById('shuttleModal').style.display = 'flex';
    
    const uToken = localStorage.getItem('uToken');

    // [í•µì‹¬ ì—°ë™] ê¸°ì‚¬ë‹˜ì´ driver.htmlì—ì„œ ì„¤ì •í•œ ì‹œê°„ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì‹œí•˜ì—¬ í‘œì‹œí•©ë‹ˆë‹¤.
    firebase.database().ref(`courses/${currentRoom}/shuttle/departure`).on('value', snap => {
        const dep = snap.val();
        const timeEl = document.getElementById('departureTimeText');
        if(!timeEl) return;

        if (dep && dep.time) {
            // ê¸°ì‚¬ë‹˜ì´ ì‹œê°„ì„ ì„¤ì •í•œ ê²½ìš° (ì˜ˆ: 2026-01-23 15:00)
            // ë‚ ì§œ ë¶€ë¶„ì€ ë¹¼ê³  ì‹œê°„ë§Œ ê¹”ë”í•˜ê²Œ ë³´ê³  ì‹¶ë‹¤ë©´ ${dep.time}ë§Œ ë‚¨ê²¨ë„ ë©ë‹ˆë‹¤.
            timeEl.innerText = `${dep.date} [ ${dep.time} ] ì¶œë°œ ì˜ˆì •`;
            timeEl.style.color = "#ef4444"; // ëˆˆì— ì˜ ë„ê²Œ ë¹¨ê°„ìƒ‰ ê³„ì—´ë¡œ ê°•ì¡°
        } else {
            // ê¸°ì‚¬ë‹˜ì´ ì•„ì§ ì‹œê°„ì„ ì„¤ì •í•˜ì§€ ì•Šì•˜ì„ ê²½ìš°
            firebase.database().ref('system/shuttle_notice').once('value', s => {
                // system/shuttle_noticeì— ê°’ì´ ìˆìœ¼ë©´ ê·¸ê±¸ ë³´ì—¬ì£¼ê³ , ì—†ìœ¼ë©´ ëŒ€ê¸° ë¬¸êµ¬ ì¶œë ¥
                timeEl.innerText = s.val() || "ê¸°ì‚¬ë‹˜ì´ ì¶œë°œ ì‹œê°„ì„ ì„¤ì • ì¤‘ì…ë‹ˆë‹¤.";
                timeEl.style.color = "#64748b"; 
            });
        }
    });

    // ê¸°ì¡´ ì‹ ì²­ ë‚´ì—­ í™•ì¸ (ì´ë¯¸ ì‹ ì²­í–ˆëŠ”ì§€ ì²´í¬)
    const snap = await firebase.database().ref(`courses/${currentRoom}/shuttle/requests/${uToken}`).once('value');
    currentShuttleData = snap.val();

    if (currentShuttleData) {
        // ì‹ ì²­ ê¸°ë¡ì´ ìˆìœ¼ë©´ ì·¨ì†Œ í™”ë©´ í‘œì‹œ
        document.getElementById('shuttleSelectionArea').style.display = 'none';
        document.getElementById('shuttleCancelArea').style.display = 'block';
        document.getElementById('myCurrentShuttleText').innerText = currentShuttleData.typeText;
    } else {
        // ì‹ ì²­ ê¸°ë¡ì´ ì—†ìœ¼ë©´ ì„ íƒ ë²„íŠ¼ë“¤ í‘œì‹œ
        document.getElementById('shuttleSelectionArea').style.display = 'block';
        document.getElementById('shuttleCancelArea').style.display = 'none';
    }
}

// 2. ì°¨ëŸ‰ ì„ íƒ ì‹œ í˜¸ì¶œ (ì˜¤ì†¡, í„°ë¯¸ë„, ê³µí•­, ìì°¨ ê³µí†µ)
function selectShuttle(typeId, typeName) {
    showKacConfirm(`[${typeName}]\nì°¨ëŸ‰ì„ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async function() {
        const uToken = localStorage.getItem('uToken');
        const name = localStorage.getItem('kac_user_name');
        const phone = localStorage.getItem('kac_user_phone');

        // ì„œë²„ì— ì €ì¥í•  ë°ì´í„° êµ¬ì„±
        const requestData = {
            type: typeId,      // osong, terminal, airport, car
            typeText: typeName, // ì˜¤ì†¡ì—­, ì²­ì£¼í„°ë¯¸ë„...
            name: name,
            phone: phone,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        try {
            // ì‹ ê·œ í†µí•© ê²½ë¡œ: shuttle/requests ë°‘ì— ë‚´ í† í°ìœ¼ë¡œ ì €ì¥
            await firebase.database().ref(`courses/${currentRoom}/shuttle/requests/${uToken}`).set(requestData);
            alert("âœ… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeShuttleModal();
        } catch (e) { 
            alert("ì €ì¥ ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”."); 
        }
    });
}

// 3. ì‹ ì²­ ì·¨ì†Œ ì‹¤í–‰
async function cancelShuttleRequest() {
    if (!confirm("ì •ë§ ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
    const uToken = localStorage.getItem('uToken');
    try {
        // ì„œë²„ì—ì„œ ë‚´ ë°ì´í„° ì‚­ì œ
        await firebase.database().ref(`courses/${currentRoom}/shuttle/requests/${uToken}`).remove();
        alert("ì •ìƒì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        
        // ë‹¤ì‹œ ì‹ ì²­í•  ìˆ˜ ìˆë„ë¡ íŒì—… í™”ë©´ ê°±ì‹ 
        openShuttleApply(); 
    } catch (e) { 
        alert("ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); 
    }
}

// 4. íŒì—…ì°½ ë‹«ê¸°
function closeShuttleModal() { 
    document.getElementById('shuttleModal').style.display = 'none'; 
}











// --- [ë³µêµ¬] í†µí•© í–‰ì • ì‹ ì²­(ì™¸ì¶œ/ì™¸ë°•/ì„ì‹) ë¡œì§ ---

let selectedAdminType = 'none'; // ì™¸ì¶œ/ì™¸ë°• ì„ íƒ ìƒíƒœ ì €ì¥



// [ìµœì¢… í†µí•©] í–‰ì • ì‹ ì²­ ë©”ë‰´ ì—´ê¸° (ì™¸ì¶œ/ì™¸ë°• + ì„ì‹ ì œì™¸ ë™ì‹œ ì²´í¬)
// [ìµœì¢…] í–‰ì • ì‹ ì²­ ë©”ë‰´ ì—´ê¸° (ìƒí™©ë³„ ë²„íŠ¼ ì œì–´ ë¡œì§ í¬í•¨)
async function openAdminAction() {

    // --- [ì¶”ê°€] ìë™ì™„ì„± ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ---
    const loadHistory = (id, datalistId) => {
        const history = JSON.parse(localStorage.getItem('kac_auto_' + id) || '[]');
        const dl = document.getElementById(datalistId);
        if(dl) dl.innerHTML = history.map(item => `<option value="${item}">`).join('');
    };
    loadHistory('dept', 'deptHistory');
    loadHistory('dest', 'destHistory');
    loadHistory('reason', 'reasonHistory');
    // ---------------------------------



    const uToken = localStorage.getItem('uToken');
    const today = getTodayString();
    
    const [actionSnap, dinnerSnap] = await Promise.all([
        firebase.database().ref(`courses/${currentRoom}/admin_actions/${today}/${uToken}`).once('value'),
        firebase.database().ref(`courses/${currentRoom}/dinner_skips/${today}/${uToken}`).once('value')
    ]);

    const existingData = actionSnap.val();
    const hasDinnerSkip = dinnerSnap.exists();

    // 1. ì•„ë¬´ê²ƒë„ ì‹ ì²­ ì•ˆ í–ˆì„ ë•Œ
    if (!existingData && !hasDinnerSkip) {
        document.getElementById('adminActionForm').style.display = 'flex';
        document.getElementById('adminStatusArea').style.display = 'none';
        
        // ì…ë ¥ê°’ ì´ˆê¸°í™”
        document.getElementById('userDept').value = "";
        document.getElementById('startTime').value = "";
        document.getElementById('endTime').value = "";
        document.getElementById('destination').value = "";
        document.getElementById('outingReason').value = "";
        document.getElementById('skipDinner').checked = false;
        selectedAdminType = 'none';
        updateAdminTypeButtons();
    } 
    // 2. ì‹ ì²­ ë‚´ì—­ì´ ìˆì„ ë•Œ
    else {
        document.getElementById('adminActionForm').style.display = 'none';
        document.getElementById('adminStatusArea').style.display = 'block';

        let statusTxt = "";
        if (hasDinnerSkip) {
            statusTxt += `<div style="margin-bottom:10px; padding:8px; background:#fff1f2; border-radius:8px; border:1px solid #fda4af;">
                            <b style="color:#e11d48;">ğŸ´ ì˜¤ëŠ˜ ì„ì‹ ì œì™¸ ì‹ ì²­ë¨</b>
                          </div>`;
        }
        if (existingData) {
            const typeNm = existingData.type === 'outing' ? 'ì™¸ì¶œ(ë‹¹ì¼)' : 'ì™¸ë°•(ìµì¼)';
            const returnStatus = existingData.returned 
                ? `<b style="color:#059669;">[ë³µê·€ ì™„ë£Œ ë³´ê³ ë¨: ${existingData.returnReportTime}]</b>` 
                : `<b style="color:#b91c1c;">[ë¯¸ë³µê·€ / ì™¸ì¶œ ì¤‘]</b>`;
            statusTxt += `<div style="background:#fff; padding:10px; border-radius:8px; border:1px solid #dbeafe;">
                            ${returnStatus}<br>
                            <span style="font-size:13px; color:#64748b;">ìœ í˜•: ${typeNm}</span><br>
                            <span style="font-size:13px; color:#64748b;">ì‹œê°„: ${existingData.startTime} ~ ${existingData.endTime}</span>
                          </div>`;
        }
        document.getElementById('adminStatusText').innerHTML = statusTxt;

        // --- ë²„íŠ¼ ì œì–´ í•µì‹¬ ë¡œì§ ---
        const beforeGrp = document.getElementById('beforeReturnGroup');
        const afterGrp = document.getElementById('afterReturnGroup');
        const dinnerGrp = document.getElementById('dinnerOnlyGroup');

        // ì¼ë‹¨ ë‹¤ ìˆ¨ê¹€
        beforeGrp.style.display = 'none';
        afterGrp.style.display = 'none';
        dinnerGrp.style.display = 'none';

        if (existingData) {
            // ì™¸ì¶œ/ì™¸ë°• ì •ë³´ê°€ ìˆìœ¼ë©´ ë³µê·€ ê´€ë ¨ ë²„íŠ¼ë“¤ ë…¸ì¶œ
            if (existingData.returned) afterGrp.style.display = 'block';
            else beforeGrp.style.display = 'flex';
        } else if (hasDinnerSkip) {
            // ì™¸ì¶œ ì •ë³´ëŠ” ì—†ê³  'ì„ì‹ ì œì™¸'ë§Œ ìˆì„ ë•Œ
            dinnerGrp.style.display = 'block';
        }
    }

    document.getElementById('adminActionDate').innerText = `ì˜¤ëŠ˜ ë‚ ì§œ: ${today}`;
    document.getElementById('adminActionModal').style.display = 'flex';
}


// [ì‹ ê·œ] ì„ì‹ ì œì™¸ì‹ ì²­ë§Œ ì·¨ì†Œí•˜ëŠ” í•¨ìˆ˜
async function cancelDinnerOnly() {
    const now = new Date();
    if (now.getHours() >= 16) {
        alert("âš ï¸ ì„ì‹ ì·¨ì†ŒëŠ” 16ì‹œì— ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤. í–‰ì •íŒ€ì— ë³„ë„ ë¬¸ì˜ë°”ëë‹ˆë‹¤.");
        return;
    }
    
    if(!confirm("ì˜¤ëŠ˜ ì €ë… ì‹ì‚¬ ì œì™¸ ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
    const uToken = localStorage.getItem('uToken');
    const today = getTodayString();
    
    try {
        await firebase.database().ref(`courses/${currentRoom}/dinner_skips/${today}/${uToken}`).remove();
        alert("ì„ì‹ ì œì™¸ ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        openAdminAction(); // í™”ë©´ ê°±ì‹ 
    } catch (e) { alert("ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }
}






// ë³µê·€ ë³´ê³  ì·¨ì†Œ (ì¬ìˆ˜ì •)
async function undoReturnAction() {
    if(!confirm("ë³µê·€ ë³´ê³ ë¥¼ ì·¨ì†Œí•˜ê³  ë‹¤ì‹œ ì™¸ì¶œ ì¤‘ ìƒíƒœë¡œ ëŒë¦´ê¹Œìš”?")) return;
    const uToken = localStorage.getItem('uToken');
    const today = getTodayString();
    
    try {
        await firebase.database().ref(`courses/${currentRoom}/admin_actions/${today}/${uToken}`).update({
            returned: false,
            returnReportTime: null
        });
        openAdminAction(); // í™”ë©´ ê°±ì‹ 
    } catch (e) { alert("ì²˜ë¦¬ ì˜¤ë¥˜"); }
}



// 1. ì™¸ì¶œ/ì™¸ë°• íƒ€ì… ì„ íƒ ì‹œ ë‚ ì§œì°½ ì œì–´
function selectAdminType(type) {
    selectedAdminType = type;
    updateAdminTypeButtons();
    const returnDateArea = document.getElementById('returnDateArea');
    if(type === 'overnight') {
        returnDateArea.style.display = 'block';
        // ë³µê·€ ë‚ ì§œ ê¸°ë³¸ê°’ì„ ë‚´ì¼ë¡œ ì„¤ì •
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('returnDate').value = tomorrow.toISOString().substring(0, 10);
    } else {
        returnDateArea.style.display = 'none';
    }
}



function updateAdminTypeButtons() {
    const types = ['outing', 'overnight'];
    types.forEach(t => {
        const btn = document.getElementById(`btn-${t}`);
        if(!btn) return;
        if (t === selectedAdminType) {
            btn.style.background = "#3b82f6"; // ì„ íƒë˜ë©´ íŒŒë€ìƒ‰
            btn.style.color = "white";
            btn.style.borderColor = "#3b82f6";
        } else {
            btn.style.background = "#f8fafc"; // ì•ˆë˜ë©´ í°ìƒ‰
            btn.style.color = "#64748b";
            btn.style.borderColor = "#e2e8f0";
        }
    });
}





// [ìµœì¢… í†µí•©] í–‰ì • ì‹ ì²­ ì œì¶œ í•¨ìˆ˜ (ì‹œê°„ê²€ì‚¬ + ì„ì‹ì²´í¬ + ìë™ì™„ì„± ê¸°ë¡ ë³´ê´€)
async function submitAdminAction() {
    const today = getTodayString();
    const uToken = localStorage.getItem('uToken');
    const name = localStorage.getItem('kac_user_name');
    const phoneShort = localStorage.getItem('kac_user_phone');
    
    // ì…ë ¥ëœ ê°’ë“¤ ê°€ì ¸ì˜¤ê¸°
    const dept = document.getElementById('userDept').value.trim();
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    const returnDate = document.getElementById('returnDate').value;
    const dest = document.getElementById('destination').value.trim();
    const reason = document.getElementById('outingReason').value.trim();
    const fullPhone = document.getElementById('fullPhone').value.trim();
    const skipDinner = document.getElementById('skipDinner').checked;

    // 1. ì•„ë¬´ê²ƒë„ ì„ íƒ/ì²´í¬ ì•ˆ í•œ ê²½ìš° ì°¨ë‹¨
    if (selectedAdminType === 'none' && !skipDinner) {
        alert("ì™¸ì¶œ ìœ í˜•ì„ ì„ íƒí•˜ê±°ë‚˜ 'ì„ì‹ ì œì™¸'ì— ì²´í¬í•´ì£¼ì„¸ìš”.");
        return;
    }

    // 2. ì™¸ì¶œ/ì™¸ë°•ì„ ì„ íƒí–ˆì„ ê²½ìš° í•„ìˆ˜ ì…ë ¥ ë° ì‹œê°„ ìœ íš¨ì„± ê²€ì‚¬
    if (selectedAdminType !== 'none') {
        if (!dept || !startTime || !endTime || !dest || !reason || !fullPhone) {
            alert("ì™¸ì¶œÂ·ì™¸ë°• ëŒ€ì¥ ê¸°ë¡ì„ ìœ„í•´ ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        // ì‹œê°„ ì„ í›„ ê´€ê³„ ì²´í¬ ë¡œì§
        const outFullTime = new Date(`${today}T${startTime}`);
        const retDateStr = (selectedAdminType === 'overnight' ? returnDate : today);
        const returnFullTime = new Date(`${retDateStr}T${endTime}`);

        if (returnFullTime <= outFullTime) {
            alert("âš ï¸ ë³µê·€ ì‹œê°„ì´ ì™¸ì¶œ ì‹œê°„ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në‚ ì§œì™€ ì‹œê°„ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
            return;
        }
    }

    try {
        // 3. ì™¸ì¶œ/ì™¸ë°• ë°ì´í„° ì €ì¥ (ì„ íƒí–ˆì„ ë•Œë§Œ)
        if (selectedAdminType !== 'none') {
            const actionData = {
                name: name,
                dept: dept,
                startTime: startTime,
                endTime: endTime,
                returnDate: (selectedAdminType === 'overnight' ? returnDate : today),
                destination: dest,
                reason: reason,
                phone: fullPhone,
                type: selectedAdminType,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                returned: false
            };
            await firebase.database().ref(`courses/${currentRoom}/admin_actions/${today}/${uToken}`).set(actionData);

            // [ê¸°ëŠ¥ ì¶”ê°€] ìë™ì™„ì„±ì„ ìœ„í•´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì…ë ¥ ë‚´ìš© ì €ì¥
            const saveAutoHistory = (id, val) => {
                let history = JSON.parse(localStorage.getItem('kac_auto_' + id) || '[]');
                if (val && !history.includes(val)) {
                    history.unshift(val); // ìƒˆ ê¸°ë¡ì„ ë§¨ ì•ìœ¼ë¡œ
                    if(history.length > 5) history.pop(); // ìµœê·¼ 5ê°œë§Œ ìœ ì§€
                    localStorage.setItem('kac_auto_' + id, JSON.stringify(history));
                }
            };
            saveAutoHistory('dept', dept);
            saveAutoHistory('dest', dest);
            saveAutoHistory('reason', reason);
        }

        // 4. ì„ì‹ ì œì™¸ ë°ì´í„° ì €ì¥ (ì²´í¬í–ˆì„ ë•Œë§Œ)
        if (skipDinner) {
            const now = new Date();
            if (now.getHours() >= 16) {
                alert("âš ï¸ ì„ì‹ ì‹ ì²­/ì·¨ì†ŒëŠ” 16ì‹œì— ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì™¸ì¶œ ì‹ ì²­ì€ ì •ìƒ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤)");
            } else {
                await firebase.database().ref(`courses/${currentRoom}/dinner_skips/${today}/${uToken}`).set(`${name}(${phoneShort})`);
            }
        }

        alert("âœ… í–‰ì • ì‹ ì²­ì„œê°€ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById('adminActionModal').style.display = 'none';

    } catch (e) {
        alert("ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
    }
}





// [ìˆ˜ì •] ì‹ ì²­ ì·¨ì†Œ ì²˜ë¦¬
async function cancelAdminAction() {
    if(!confirm("ê¸°ì¡´ ì™¸ì¶œ/ì™¸ë°• ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
    const today = getTodayString();
    const uToken = localStorage.getItem('uToken');

    try {
        // 1. ì™¸ì¶œ/ì™¸ë°• ë‚´ì—­ ì‚­ì œ
        await firebase.database().ref(`courses/${currentRoom}/admin_actions/${today}/${uToken}`).remove();
        
        // 2. ì„ì‹ ì œì™¸ë„ ê°™ì´ ì‹ ì²­í–ˆë‹¤ë©´ ì‚­ì œ
        await firebase.database().ref(`courses/${currentRoom}/dinner_skips/${today}/${uToken}`).remove();

        alert("ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‘ì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        
        // 3. UIë¥¼ ë‹¤ì‹œ ì‹ ì²­ ì–‘ì‹ìœ¼ë¡œ ì „í™˜
        document.getElementById('adminStatusArea').style.display = 'none';
        document.getElementById('adminActionForm').style.display = 'flex';
    } catch (e) {
        alert("ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}




// ë³µê·€ ì™„ë£Œ ë³´ê³  ì²˜ë¦¬
async function confirmReturnAction() {
    if(!confirm("í˜„ ì‹œê°ë¶€ë¡œ ê°•ì˜ì‹¤(ìƒí™œê´€)ì— ë³µê·€í•˜ì…¨ìŠµë‹ˆê¹Œ?")) return;
    const uToken = localStorage.getItem('uToken');
    const today = getTodayString();
    
    try {
        const nowTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        await firebase.database().ref(`courses/${currentRoom}/admin_actions/${today}/${uToken}`).update({
            returned: true,
            returnReportTime: nowTime
        });
        alert("âœ… ë³µê·€ ë³´ê³  ì™„ë£Œ!");
        openAdminAction(); // í™”ë©´ ê°±ì‹ 
    } catch (e) { alert("ì²˜ë¦¬ ì˜¤ë¥˜"); }
}







// 4. ê°•ì˜ì‹¤ ì´ë™ ë©”ë‰´ í´ë¦­ ì‹œ
function openRoomMove() {
    document.getElementById('menuModal').style.display = 'none';
    if(typeof openMenu === 'function') openMenu(); 
}





// [ì¶”ê°€] ë™ì˜ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³  ì €ì¥í•˜ëŠ” í•¨ìˆ˜
async function saveProfileWithCheck() {
    const agree = document.getElementById('privacyAgree').checked;
    const name = document.getElementById('userName').value.trim();
    const phone = document.getElementById('userPhone').value.trim();

    if (!agree) {
        alert("ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
        return;
    }
    
    if (!name || phone.length !== 4) {
        alert("ì„±í•¨ê³¼ ì „í™”ë²ˆí˜¸ ë’· 4ìë¦¬ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    // ëª¨ë“  ì¡°ê±´ ì¶©ì¡± ì‹œ ê¸°ì¡´ ì €ì¥ ë¡œì§ ì‹¤í–‰
    saveProfile(); 
}

















// [ìµœì¢… ìˆ˜ì •] í”„ë¡œí•„ ì €ì¥ ë° ìë™ ì¶œì„ ì—°ê²° ë¡œì§
async function saveProfile() {
    const name = document.getElementById('userName').value.trim();
    const phone = document.getElementById('userPhone').value.trim();
    
    // 1. ì…ë ¥ê°’ ìœ íš¨ì„± ê²€ì‚¬
    if (!name || phone.length !== 4) {
        alert("ì„±í•¨ê³¼ ì „í™”ë²ˆí˜¸ ë’· 4ìë¦¬ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }
    
    const newUToken = `${name}_${phone}`;
    const oldUToken = localStorage.getItem('kac_old_uToken');
    const isEditMode = !!oldUToken;

    try {
        // 2. [ìˆ˜ì • ëª¨ë“œ] ì´ë¦„ì´ë‚˜ ë²ˆí˜¸ê°€ ë°”ë€Œì—ˆë‹¤ë©´ ê¸°ì¡´ ì„œë²„ ë°ì´í„° ì‚­ì œ
        if (isEditMode && oldUToken !== newUToken) {
            await firebase.database().ref(`courses/${currentRoom}/students/${oldUToken}`).remove();
        }

        // 3. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì •ë³´ ê°±ì‹ 
        localStorage.setItem('kac_user_name', name);
        localStorage.setItem('kac_user_phone', phone);
        localStorage.setItem('uToken', newUToken);
        localStorage.removeItem('kac_old_uToken'); // ë°±ì—… ë°ì´í„° ì‚­ì œ

        // 4. ì„œë²„(Firebase) ìˆ˜ê°•ìƒ ëª…ë‹¨ ì—…ë°ì´íŠ¸
        await firebase.database().ref(`courses/${currentRoom}/students/${newUToken}`).update({
            name: name,
            phone: phone,
            joinedAt: firebase.database.ServerValue.TIMESTAMP,
            isOnline: true
        });

        // 5. ì ‘ì† ìƒíƒœ ê°ì‹œ ì‹œì‘ ë° UI ì •ë¦¬
        startPresence(); 
        document.getElementById('profileOverlay').style.display = 'none';
        
        if (isEditMode) {
            alert("âœ… ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            alert(`${name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`);
        }
        
        // 6. [í•µì‹¬] ì¶œì„ ì²´í¬ íŒŒë¼ë¯¸í„°(&checkin=true)ê°€ ìˆëŠ” ê²½ìš° ìë™ ì¶œì„ ì‹¤í–‰
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('checkin') === 'true') {
            // ìƒˆë¡œ ìˆ˜ì •ëœ í•¨ìˆ˜ ì´ë¦„ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.
            handleInternalAttendance(currentRoom); 
        } else {
            // ì¼ë°˜ ì…ì¥ì˜ ê²½ìš° ëŒ€ì‹œë³´ë“œ í‘œì‹œ
            showMainDashboard();
        }
        
    } catch (e) {
        console.error("Profile Save Error:", e);
        alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
}






// [ìµœì¢… ìˆ˜ì •] ì„œë²„ ëª…ë‹¨ ëŒ€ì¡° ë°©ì‹ì˜ ì—„ê²©í•œ í”„ë¡œí•„ ì²´í¬
async function checkProfile() {
    const savedName = localStorage.getItem('kac_user_name');
    const savedPhone = localStorage.getItem('kac_user_phone');
    const uToken = localStorage.getItem('uToken');

    // 1. ê¸°ë³¸ ì •ë³´ì¡°ì°¨ ì—†ìœ¼ë©´ ì…ë ¥ì°½í–‰
    if (!uToken || !savedName) {
        document.getElementById('profileOverlay').style.display = 'flex';
        return;
    }

    try {
        // 2. [í•µì‹¬] í˜„ì¬ ì ‘ì†í•˜ë ¤ëŠ” ë°©(Room C)ì˜ ìˆ˜ê°•ìƒ ëª…ë‹¨ì— ë‚´ê°€ ìˆëŠ”ì§€ í™•ì¸
        const snap = await firebase.database().ref(`courses/${currentRoom}/students/${uToken}`).once('value');
        
        if (!snap.exists()) {
            // ì´ë¦„ì€ ì €ì¥ë˜ì–´ ìˆì§€ë§Œ, 'ì´ ë°©(C)'ì—ëŠ” ì²˜ìŒ ë“¤ì–´ì˜¨ ê²½ìš°
            // ìë™ìœ¼ë¡œ ë°© ëª…ë‹¨ì— ë‚˜ë¥¼ ë“±ë¡í•˜ê³  ì…ì¥ (ì‚¬ìš©ìì—ê²Œ ë‹¤ì‹œ ì…ë ¥ ì•ˆ ì‹œí‚´)
            await firebase.database().ref(`courses/${currentRoom}/students/${uToken}`).update({
                name: savedName,
                phone: savedPhone,
                joinedAt: firebase.database.ServerValue.TIMESTAMP,
                isOnline: true
            });
        }
        
        // 3. ì •ìƒ ì…ì¥ ì²˜ë¦¬
        showMainDashboard();
        
    } catch (e) {
        document.getElementById('profileOverlay').style.display = 'flex';
    }
}




// ë©”ì¸ í™”ë©´ ì „í™˜ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°ìš©)
function showMainDashboard() {
    document.getElementById('landingPage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'flex';
    startPresence();
}







// [ì‹ ê·œ] ì‹ë‹¨í‘œ ë³´ê¸° ê¸°ëŠ¥
async function viewMealMenu() {
    document.getElementById('menuModal').style.display = 'none';
    const snap = await firebase.database().ref('system/nutrition_menu').once('value');
    const imageUrl = snap.val();
    
    if (!imageUrl) {
        alert("ë“±ë¡ëœ ì‹ë‹¨í‘œ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
    
    document.getElementById('mealMenuImage').src = imageUrl;
    document.getElementById('mealMenuModal').style.display = 'flex';
}



// [ìˆ˜ì •] ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸°: ì„¼í„° ê³µì§€ + ì½”ë””ë„¤ì´í„° ê³µì§€ + ê°•ì‚¬ ê³µì§€ 3ì¢… í†µí•©
async function openNotice() {
    document.getElementById('menuModal').style.display = 'none';
    const container = document.getElementById('noticeContainer');
    
    container.innerHTML = "<div style='text-align:center; padding:20px;'>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>";
    document.getElementById('noticeModal').style.display = 'flex';

    try {
        // 1. ì„¼í„° ì „ì²´ ê³µì§€ (system/globalNotice)
        const globalSnap = await firebase.database().ref('system/globalNotice').once('value');
        const globalVal = globalSnap.val();

        // 2. ì½”ë””ë„¤ì´í„° ê³¼ì • ê³µì§€ (courses/ë°©ID/coordNotice) - [ì‹ ê·œ ì¶”ê°€]
        const coordSnap = await firebase.database().ref(`courses/${currentRoom}/coordNotice`).once('value');
        const coordVal = coordSnap.val();

        // 3. ê°•ì‚¬ ê³¼ì • ê³µì§€ (courses/ë°©ID/notice)
        const instSnap = await firebase.database().ref(`courses/${currentRoom}/notice`).once('value');
        const instVal = instSnap.val();

        let html = "";
        
        // (1) ì„¼í„° ì „ì²´ ê³µì§€ í‘œì‹œ
        if (globalVal) {
            html += `<div class="notice-card"><span class="notice-tag tag-global">ì„¼í„° ì „ì²´ ê³µì§€</span><div class="notice-body">${globalVal}</div></div>`;
        }
        
        // (2) ì½”ë””ë„¤ì´í„° ê³¼ì • ê³µì§€ í‘œì‹œ
        if (coordVal) {
            html += `<div class="notice-card"><span class="notice-tag tag-coord">êµìœ¡ ìš´ì˜ë¶€ ê³µì§€</span><div class="notice-body">${coordVal}</div></div>`;
        }

        // (3) ê°•ì‚¬ ê³¼ì • ê³µì§€ í‘œì‹œ
        if (instVal) {
            html += `<div class="notice-card"><span class="notice-tag tag-course">ìš°ë¦¬ ê³¼ì • ê³µì§€ (ê°•ì‚¬)</span><div class="notice-body">${instVal}</div></div>`;
        }

        container.innerHTML = html || "<div style='text-align:center; padding:30px; color:#94a3b8;'>í˜„ì¬ ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
        
    } catch (e) {
        console.error(e);
        container.innerHTML = "<div style='text-align:center; padding:20px; color:red;'>ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>";
    }
}




// [ì‹ ê·œ] ì¶œê²° QR ë¶ˆëŸ¬ì˜¤ê¸°
async function openAttendanceQR() {
    document.getElementById('menuModal').style.display = 'none';
    const img = document.getElementById('qrImage');
    const msg = document.getElementById('qrEmptyMsg');
    img.style.display = 'none'; msg.style.display = 'none';
    document.getElementById('qrModal').style.display = 'flex';

    try {
        const snap = await firebase.database().ref(`courses/${currentRoom}/attendanceQR`).once('value');
        if (snap.val()) { img.src = snap.val(); img.style.display = 'block'; }
        else { msg.style.display = 'block'; }
    } catch (e) { msg.innerText = "ì—°ê²° ì˜¤ë¥˜"; msg.style.display = 'block'; }
}



// [ìµœì¢… ìµœì í™”] ì•„ì´í°/ì•ˆë“œë¡œì´ë“œ í‚¤ë³´ë“œ ê°€ë¦¼ ì™„ë²½ ë°©ì§€ ë¡œì§
function initKeyboardFix() {
    const inputDock = document.getElementById('inputDock');
    const scrollContainer = document.getElementById('scrollContainer');
    const qInput = document.getElementById('qInput');

    // 1. VisualViewport ì§€ì› ë¸Œë¼ìš°ì € (ìµœì‹  ì•„ì´í°/ì•ˆë“œë¡œì´ë“œ)
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            const offset = window.innerHeight - window.visualViewport.height;
            if (offset > 50) { // í‚¤ë³´ë“œê°€ ì˜¬ë¼ì™”ë‹¤ê³  íŒë‹¨ë˜ëŠ” ë†’ì´
                inputDock.style.bottom = offset + 'px';
                // ì±„íŒ… ëª©ë¡ í•˜ë‹¨ì— ì—¬ë°±ì„ ì¤˜ì„œ ë§ˆì§€ë§‰ ë©”ì‹œì§€ê°€ í‚¤ë³´ë“œ ìœ„ë¡œ ë³´ì´ê²Œ í•¨
                scrollContainer.style.paddingBottom = (offset + 150) + 'px';
                
                // ê¸€ ì“°ëŠ” ì¹¸ì´ ë°”ë¡œ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤ ì•„ë˜ë¡œ ê³ ì •
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    scrollContainer.scrollTop = scrollContainer.scrollHeight;
                }, 100);
            } else {
                inputDock.style.bottom = '0px';
                scrollContainer.style.paddingBottom = '150px';
            }
        });
    }

    // 2. ì…ë ¥ì°½ í´ë¦­ ì‹œ ê°•ì œ í™”ë©´ ë³´ì • (ì•„ì´í° ì‚¬íŒŒë¦¬ ì „ìš©)
    qInput.addEventListener('focus', () => {
        // í‚¤ë³´ë“œê°€ ì˜¬ë¼ì˜¤ëŠ” ì‹œê°„ì„ ê³ ë ¤í•´ ì•½ê°„ì˜ ì§€ì—° í›„ ì‹¤í–‰
        setTimeout(() => {
            // ì…ë ¥ì°½ì´ í™”ë©´ ì¤‘ì•™ì— ì˜¤ë„ë¡ ê°•ì œ ìŠ¤í¬ë¡¤
            qInput.scrollIntoView({ block: "center", behavior: "smooth" });
            
            // ì „ì²´ ìœˆë„ìš° ìŠ¤í¬ë¡¤ì´ íŠ€ëŠ” í˜„ìƒ ë°©ì§€
            window.scrollTo(0, 0);
        }, 300);
    });

    qInput.addEventListener('blur', () => {
        inputDock.style.bottom = '0px';
        scrollContainer.style.paddingBottom = '150px';
        window.scrollTo(0, 0);
    });
}




// 1. ë¯¸ë‹ˆ ê³µì§€ ë°” ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (3ê°€ì§€ ê³µì§€ í†µí•© ë²„ì „)
async function updateMiniNotice() {
    const bar = document.getElementById('miniNoticeBar');
    const textEl = document.getElementById('miniNoticeText');
    if(!bar || !textEl) return;

    // ì„¸ êµ°ë° ê³µì§€ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ê°€ì ¸ì˜´
    const [instSnap, coordSnap, globalSnap] = await Promise.all([
        firebase.database().ref(`courses/${currentRoom}/notice`).once('value'),
        firebase.database().ref(`courses/${currentRoom}/coordNotice`).once('value'),
        firebase.database().ref('system/globalNotice').once('value')
    ]);

    // í…ìŠ¤íŠ¸ ì •ì œ í•¨ìˆ˜ (íƒœê·¸ ì œê±° ë° ì¤„ë°”ê¿ˆ ì •ë¦¬)
    const clean = (txt) => txt ? txt.replace(/<[^>]*>?/gm, '').replace(/\n/g, ' ').trim() : "";

    const t_inst = clean(instSnap.val());   // ìš°ë¦¬ ê³¼ì •
    const t_coord = clean(coordSnap.val()); // ìš´ì˜ë¶€
    const t_global = clean(globalSnap.val()); // ì„¼í„°

    // ë‚´ìš©ì´ ìˆëŠ” ê³µì§€ë§Œ ëª¨ì•„ì„œ í•©ì¹¨
    let combinedParts = [];
    if (t_inst) combinedParts.push(`ğŸ“¢ [ìš°ë¦¬ê³¼ì •] ${t_inst}`);
    if (t_coord) combinedParts.push(`ğŸ”” [ìš´ì˜ë¶€] ${t_coord}`);
    if (t_global) combinedParts.push(`ğŸ¢ [ì„¼í„°ê³µì§€] ${t_global}`);

    // ê³µì§€ë“¤ ì‚¬ì´ì— êµ¬ë¶„ì„ ì„ ë„£ì–´ í•˜ë‚˜ë¡œ í•©ì¹¨
    const finalNoticeText = combinedParts.join(" ã€€ | ã€€ ");

    if (finalNoticeText) {
        // ì´ì „ì— 'X' ëˆŒëŸ¬ì„œ ë‹«ì€ ê³µì§€ì™€ ë‚´ìš©ì´ ë‹¤ë¥¼ ë•Œë§Œ í‘œì‹œ
        if (localStorage.getItem('lastClosedNotice') !== finalNoticeText) {
            textEl.innerText = finalNoticeText;
            bar.style.display = 'flex';
        } else {
            bar.style.display = 'none';
        }
    } else {
        // ê³µì§€ê°€ ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´ ë°”ë¥¼ ìˆ¨ê¹€
        bar.style.display = 'none';
    }
}

function closeMiniNotice() {
    const text = document.getElementById('miniNoticeText').innerText;
    localStorage.setItem('lastClosedNotice', text);
    document.getElementById('miniNoticeBar').style.display = 'none';
}

function watchNotices() {
    if(!currentRoom) return;
    firebase.database().ref(`courses/${currentRoom}/notice`).on('value', updateMiniNotice);
    firebase.database().ref(`courses/${currentRoom}/coordNotice`).on('value', updateMiniNotice);
    firebase.database().ref('system/globalNotice').on('value', updateMiniNotice);
}
// --- ë¯¸ë‹ˆ ê³µì§€ ë°” ê´€ë ¨ í•¨ìˆ˜ ë ---











function handleInternalAttendance(room) {
    const urlParams = new URLSearchParams(window.location.search);
    const isCheckIn = urlParams.get('checkin') === 'true';

    if (!isCheckIn || !room) return;

    const d = new Date();
    const today = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    
    // [í™•ì¸] storageKeyê°€ kac_attended_C_2026-01-25 ì²˜ëŸ¼ ìƒì„±ë¨
    const storageKey = `kac_attended_${room}_${today}`; 

    if (localStorage.getItem(storageKey)) {
        // ì´ë¯¸ í•´ë‹¹ ë°©ì— ì¶œì„í•œ ê¸°ë¡ì´ ë¸Œë¼ìš°ì €ì— ìˆë‹¤ë©´
        alert(`ì•Œë¦¼: ì˜¤ëŠ˜ [Room ${room}]ì˜ ì¶œì„ ì²˜ë¦¬ëŠ” ì´ë¯¸ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        cleanUrlAndGo(room);
        return;
    }

    // ì´ë¦„/ë²ˆí˜¸ê°€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    const myName = (localStorage.getItem('kac_user_name') || "").trim();
    const myPhone = (localStorage.getItem('kac_user_phone') || "").trim();

    if (!myName || myPhone.length !== 4) {
        // ì •ë³´ê°€ ì—†ìœ¼ë©´ ì…êµ ë“±ë¡ì°½ë¶€í„° ë„ì›€
        alert(`[Room ${room}] ì¶œì„ì„ ìœ„í•´ ì„±í•¨ê³¼ ë²ˆí˜¸ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
        document.getElementById('profileOverlay').style.display = 'flex';
        return;
    }

    // ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë¡ ì‹¤í–‰
    executeAttendanceRecord(room, myName, myPhone, today, storageKey);
}









// [ì‹¤ì œ ì €ì¥] íŒŒì´ì–´ë² ì´ìŠ¤ì— ë°ì´í„°ë¥¼ ì“°ê³  ë¸Œë¼ìš°ì €ì— ì™„ë£Œ ë§ˆí‚¹ì„ í•¨
function executeAttendanceRecord(room, name, phone, dateStr, storageKey) {
    const attendanceKey = `${name}_${phone}`;
    const attendRef = firebase.database().ref(`courses/${room}/internal_attendance/${dateStr}/${attendanceKey}`);

    const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const authId = "KAC-" + Math.random().toString(36).substr(2, 5).toUpperCase();

    attendRef.set({
        name: name,
        phone: phone,
        time: currentTime,
        authId: authId,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        // í•´ë‹¹ ê°•ì˜ì‹¤+ì˜¤ëŠ˜ë‚ ì§œ ì „ìš© ì¶œì„ ì™„ë£Œ ë§ˆí‚¹ (ì¤‘ìš”!)
        localStorage.setItem(storageKey, "true");
        alert(`âœ… [Room ${room}] ì¶œì„ ì™„ë£Œ!\n${name}ë‹˜, í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        cleanUrlAndGo(room);
    }).catch(e => {
        alert("ì¶œì„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
    });
}

// ì£¼ì†Œì°½ ì •ë¦¬ í•¨ìˆ˜
function cleanUrlAndGo(r) {
    const newUrl = window.location.pathname + `?room=${r}`;
    window.history.replaceState({}, '', newUrl);
    if(document.getElementById('landingPage')) document.getElementById('landingPage').style.display = 'none';
    if(document.getElementById('mainApp')) document.getElementById('mainApp').style.display = 'flex';
    startPresence();
}








    </script>

<!-- ì»¤ìŠ¤í…€ ì»¨íŒ ì°½ (ì—¬ê¸°ê°€ ì§„ì§œ ìë¦¬ì…ë‹ˆë‹¤) -->
<div id="kacConfirm" class="kac-confirm-overlay">
    <div class="kac-confirm-box">
        <div id="kacConfirmMsg" class="kac-confirm-msg">ë©”ì‹œì§€ ë‚´ìš©</div>
        <div class="kac-confirm-btns">
            <button id="kacBtnNo" class="kac-btn-no" onclick="closeKacConfirm(false)">ì·¨ì†Œ</button>
            <button id="kacBtnYes" class="kac-btn-yes" onclick="closeKacConfirm(true)">í™•ì¸</button>
        </div>
    </div>
</div>


</body>
</html>