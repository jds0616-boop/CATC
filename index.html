<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KAC Student Platform</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        :root { --header-bg: #0f172a; --bg-color: #0f172a; --accent-color: #3b82f6; --btn-yellow: #facc15; --btn-text: #1e293b; --card-bg: #ffffff; --text-color: #1e293b; --input-bg: #f8fafc; --safe-area-bottom: env(safe-area-inset-bottom); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
        body { margin: 0; background: var(--bg-color); color: var(--text-color); height: 100dvh; overflow: hidden; }
        .landing-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--header-bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 40px 20px; text-align: center; }
        .landing-course { font-size: 24px; font-weight: 800; margin-bottom: 10px; line-height: 1.3; }
        .landing-room { font-size: 16px; opacity: 0.7; font-weight: 500; margin-bottom: 60px; padding: 5px 15px; border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; }
        .btn-enter { background: var(--btn-yellow); color: var(--btn-text); width: 200px; height: 56px; border-radius: 30px; font-size: 18px; font-weight: 800; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3); display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.1s; }
        .btn-enter:active { transform: scale(0.96); }
        .landing-logo { position: absolute; bottom: 40px; width: 120px; z-index: 9999; }
        .app-container { width: 100%; height: 100%; display: none; flex-direction: column; position: relative; background: var(--bg-color); max-width: 600px; margin: 0 auto; }
        .header { height: 56px; background: var(--header-bg); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header-btn { width: 40px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; color: white; }
        .header-center { flex-grow: 1; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        .header-title { font-size: 15px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .header-sub { font-size: 11px; opacity: 0.8; margin-top: 2px; display: flex; gap: 6px; align-items: center; }
        .live-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #22c55e; }
        .sort-bar { padding: 10px 15px; background: var(--bg-color); display: flex; gap: 10px; z-index: 80; flex-shrink: 0; }
        .sort-chip { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(255,255,255,0.1); color: #94a3b8; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .sort-chip.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .scroll-container { flex-grow: 1; overflow-y: auto; position: relative; padding: 0 15px 120px 15px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .scroll-container::-webkit-scrollbar { display: none; }
        .q-card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; display: flex; gap: 12px; align-items: flex-start; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; }
        .q-card.my-q { border: 2px solid var(--accent-color); background: #f0f9ff; }
        .q-avatar { width: 36px; height: 36px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 16px; color: #64748b; }
        .my-q .q-avatar { background: var(--accent-color); color: white; }
        .q-content { flex-grow: 1; min-width: 0; }
        .q-text { font-size: 15px; line-height: 1.5; color: var(--text-color); margin-bottom: 8px; word-break: break-word; font-weight: 500; white-space: pre-wrap; }
        .q-meta { font-size: 11px; color: #94a3b8; display: flex; gap: 8px; align-items: center; }
        .btn-mini { cursor: pointer; padding: 4px 8px; background: rgba(0,0,0,0.05); border-radius: 4px; }
        .q-like-area { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 44px; flex-shrink: 0; gap: 4px; }
        .like-btn { width: 44px; height: 44px; border-radius: 12px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; color: #cbd5e1; font-size: 18px; cursor: pointer; transition: 0.2s; }
        .like-btn.active { background: #fee2e2; color: #ef4444; transform: scale(1.05); }
        .like-count { font-size: 12px; font-weight: 700; color: #64748b; }
        .like-btn.active + .like-count { color: #ef4444; }
        
        .input-dock { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--input-bg); border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 10px 15px calc(10px + var(--safe-area-bottom)) 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 200; display: flex; flex-direction: column; gap: 4px; height: auto; min-height: 80px; }
        .input-box { background: white; border-radius: 20px; padding: 10px 10px 10px 15px; display: flex; align-items: flex-end; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; min-height: 48px; height: auto; }
        .real-input { flex-grow: 1; border: none; background: transparent; font-size: 16px; line-height: 1.4; color: var(--text-color); outline: none; resize: none; height: 24px; max-height: 120px; padding: 0; margin-bottom: 2px; overflow-y: hidden; font-family: 'Pretendard', sans-serif; }
/* ì…ë ¥ì°½ ê°€ì´ë“œ ë¬¸êµ¬ ë””ìì¸ ê°œì„  */
.real-input::placeholder {
    color: rgba(239, 68, 68, 0.6); /* íˆ¬ëª…ë„ê°€ ìˆëŠ” ë¹¨ê°„ìƒ‰ (ë¶€ë“œëŸ¬ìš´ ê²½ê³ ) */
    font-weight: 700;
    font-style: italic;           /* ê¸°ìš¸ì„ê¼´ë¡œ ì‹¤ì œ ëŒ“ê¸€ê³¼ ì°¨ë³„í™” */
    font-size: 14px;              /* ê¸€ì í¬ê¸°ë¥¼ ì‚´ì§ ì¤„ì„ */
}

/* ì•„ì´í°/ì‚¬íŒŒë¦¬ ëŒ€ì‘ */
.real-input::-webkit-input-placeholder {
    color: rgba(239, 68, 68, 0.6);
    font-weight: 700;
    font-style: italic;
    font-size: 14px;
}

        .real-input:disabled { background: transparent; color: #94a3b8; opacity: 1; }
        .send-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--accent-color); color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 15px; cursor: pointer; flex-shrink: 0; transition: 0.2s; margin-left: 8px; margin-bottom: 1px; }
        .send-btn:active { transform: scale(0.9); }
        .send-btn.editing { background: #10b981; }
        .input-info-row { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; font-size: 11px; font-weight: 600; }
        .char-counter { color: #94a3b8; } .char-counter.limit { color: #ef4444; font-weight: 800; }
        .cooldown-text { color: #ef4444; font-weight: 800; }
        
        .quiz-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .quiz-box { width: 100%; background: white; border-radius: 24px; padding: 30px 20px; text-align: center; }
        .quiz-opt-btn { width: 100%; height: 70px; margin-bottom: 10px; border-radius: 12px; font-size: 20px; font-weight: 800; border: 2px solid #e2e8f0; background: #f8fafc; color: #333; transition: 0.2s; }
        .quiz-opt-btn.selected { background: var(--accent-color); color: white; border-color: var(--accent-color); transform: scale(1.02); }
        .quiz-opt-btn.locked { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        #quizResultBox { animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .quiz-king-stamp { position: absolute; top: 5px; right: 5px; width: 95px; height: 95px; border: 4px double #facc15; border-radius: 50%; color: #facc15; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 900; font-size: 14px; transform: rotate(15deg); background: rgba(250, 204, 21, 0.1); z-index: 10; animation: stampIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes stampIn { from { transform: scale(3) rotate(45deg); opacity: 0; } to { transform: scale(1) rotate(15deg); opacity: 1; } }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .menu-box { background: white; width: 80%; max-width: 300px; border-radius: 16px; padding: 20px; text-align: center; }
        .menu-item { padding: 15px; border-bottom: 1px solid #eee; font-weight: 600; cursor: pointer; color: #333; }
    </style>
</head>
<body>

<!-- [ì¶”ê°€] êµìœ¡ìƒ í”„ë¡œí•„ ë“±ë¡ íŒì—… -->
<div id="profileOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,42,0.95); z-index:10000; flex-direction:column; align-items:center; justify-content:center; color:white; padding:20px; text-align:center;">
    <div style="background:white; color:#1e293b; padding:30px 20px; border-radius:24px; width:100%; max-width:350px;">
        <h2 style="margin:0 0 10px 0; font-weight:900;">ë³¸ì¸ í™•ì¸</h2>
        <p style="font-size:14px; color:#64748b; margin-bottom:25px;">ì›í™œí•œ êµìœ¡ í–‰ì • ì„œë¹„ìŠ¤ë¥¼ ìœ„í•´<br>ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        
        <input type="text" id="userName" placeholder="ì„±í•¨ ì…ë ¥" style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:12px; font-size:18px; margin-bottom:12px; text-align:center;">
        <input type="number" id="userPhone" placeholder="ì „í™”ë²ˆí˜¸ ë’· 4ìë¦¬" style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:12px; font-size:18px; margin-bottom:20px; text-align:center;">
        
        <button onclick="saveProfile()" style="width:100%; padding:15px; background:#3b82f6; color:white; border:none; border-radius:12px; font-size:18px; font-weight:bold;">ì…ì¥ ì™„ë£Œ</button>
    </div>
</div>

    <div id="landingPage" class="landing-page">
        <div class="landing-course" id="landingTitle">Loading...</div>
        <div class="landing-room" id="landingBadge">Room ...</div>
        <button class="btn-enter" onclick="enterApp()">ì…ì¥í•˜ê¸° <i class="fa-solid fa-arrow-right-to-bracket"></i></button>
        <img src="logo.png" alt="KAC" class="landing-logo">
    </div>
    <div class="app-container" id="mainApp">
        <div class="header">
            <!-- [ìˆ˜ì •] ë‚˜ê°€ê¸° ë²„íŠ¼ ê¸°ëŠ¥ ë³€ê²½ (ì™„ì „ í‡´ì¥) -->
            <div class="header-btn" onclick="exitApp()"><i class="fa-solid fa-chevron-left"></i></div>
            <div class="header-center"><div class="header-title" id="roomTitle">Course Name</div><div class="header-sub"><span class="live-dot"></span><span id="realUserCount">0ëª… ì ‘ì†</span> Â· <span id="roomBadge">Room A</span></div></div>
            <div class="header-btn" onclick="document.getElementById('menuModal').style.display='flex'">
    <i class="fa-solid fa-bars"></i>
</div>
        </div>
        <div class="sort-bar">
            <div class="sort-chip active" id="sortNew" onclick="setSort('new')">ğŸ•’ ìµœì‹ ìˆœ</div>
            <div class="sort-chip" id="sortLike" onclick="setSort('like')">ğŸ‘ ê³µê°ìˆœ</div>
        </div>
        <div class="scroll-container" id="scrollContainer"><div id="qList" class="q-list"></div></div>
        <div class="input-dock" id="inputDock">
            <div class="input-box">
                <textarea id="qInput" class="real-input" rows="1" 
          placeholder="âœ ì§ˆë¬¸ ì…ë ¥ (ë¬´ë¡€í•œ í‘œí˜„ì€ ì‚¼ê°€ì£¼ì„¸ìš”)" 
          maxlength="100" ...></textarea>
                <button id="submitBtn" class="send-btn" onclick="submitQ()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
            <div class="input-info-row"><span id="coolTimer" class="cooldown-text"></span><span id="charCount" class="char-counter">0 / 100</span></div>
        </div>
    </div>
    <div id="quizOverlay" class="quiz-overlay">
        <div id="quizActiveBox" class="quiz-box">
            <div style="margin-bottom:20px; font-weight:900; font-size:24px; color:#3b82f6;">LIVE QUIZ</div>
<!-- í•™ìƒìš© íƒ€ì´ë¨¸ ë””ìì¸ ì¶”ê°€ -->
<div id="studentQuizTimerBox" style="display:none; justify-content:center; align-items:center; gap:10px; margin-bottom:15px;">
    <i class="fa-regular fa-clock" style="color:#64748b; font-size:20px;"></i>
    <div id="studentTimer" style="font-family: monospace; font-size:30px; font-weight:900; color:#1e293b;">00:08</div>
</div>
            <div id="quizStatusMsg" style="margin-bottom:20px; font-size:16px; font-weight:bold; color:#1e293b;">ê°•ì‚¬ë‹˜ì´ í€´ì¦ˆë¥¼ ì‹œì‘í•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...</div>
            <div id="btnGroupMultiple" style="display:none; flex-direction:column; gap:5px;">
                <button class="quiz-opt-btn" onclick="sendAns(1)">1ë²ˆ</button><button class="quiz-opt-btn" onclick="sendAns(2)">2ë²ˆ</button><button class="quiz-opt-btn" onclick="sendAns(3)">3ë²ˆ</button><button class="quiz-opt-btn" onclick="sendAns(4)">4ë²ˆ</button>
            </div>
            <div id="btnGroupOX" style="display:none; gap:15px;">
                <button class="quiz-opt-btn ox-btn" onclick="sendAns(1)" style="flex:1; height:120px; font-size:40px;">O</button><button class="quiz-opt-btn ox-btn" onclick="sendAns(2)" style="flex:1; height:120px; font-size:40px;">X</button>
            </div>
            <div id="quizFeedback" style="margin-top:15px; font-weight:800; color:#ef4444; min-height:20px;"></div>
        </div>
        <div id="quizResultBox" class="quiz-box" style="display:none; background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%); position:relative; overflow:hidden;">
            <div id="quizKingStamp" style="display:none;" class="quiz-king-stamp"><span style="font-size:30px;">ğŸ‘‘</span><span>í€´ì¦ˆì™•</span></div>
            <div style="font-size:50px; margin-bottom:10px;">ğŸ†</div>
            <h2 style="margin:0; font-weight:900; color:#0f172a;">QUIZ RESULT</h2>
            <div style="margin:25px 0;"><div style="font-size:14px; color:#64748b; font-weight:bold;">ë‹¹ì‹ ì˜ ìµœì¢… ì ìˆ˜</div><div id="myFinalScore" style="font-size:48px; font-weight:900; color:#3b82f6;">0ì </div></div>
            <div style="background:#3b82f6; color:white; padding:15px; border-radius:12px; font-weight:800;">í˜„ì¬ <span id="myFinalRank">0</span>ë“± (ì „ì²´ ì°¸ì—¬ì ì¤‘)</div>
            <button class="btn-enter" onclick="closeResultOverlay()" style="margin:20px auto 0 auto; width:100%;">í™•ì¸ ë° ë‹«ê¸°</button>
        </div>
    </div>
    <div id="menuModal" class="menu-overlay" onclick="if(event.target==this)this.style.display='none'">
    <div class="menu-box">
        <h3>Menu</h3>
        <div class="menu-item" style="opacity:0.5; color:#999;"><i class="fa-solid fa-bullhorn"></i> ê³µì§€ì‚¬í•­(ì¤€ë¹„ì¤‘)</div>
        <div class="menu-item" onclick="viewMealMenu()"><i class="fa-solid fa-utensils"></i> ê¸ˆì£¼ ì‹ë‹¨ë³´ê¸°</div>
        <div class="menu-item" onclick="openShuttleApply()"><i class="fa-solid fa-bus"></i> ì°¨ëŸ‰ ì‹ ì²­</div>
        <div class="menu-item" onclick="openAdminAction()"><i class="fa-solid fa-file-signature"></i> ì™¸ì¶œÂ·ì™¸ë°• / ì„ì‹ì œì™¸</div>
        <div class="menu-item" style="opacity:0.5; color:#999;"><i class="fa-solid fa-box-open"></i> ë¯¸í™”/ë¹„í’ˆ ì‹ ì²­(ì¤€ë¹„ì¤‘)</div>
        <div class="menu-item" onclick="openRoomMove()"><i class="fa-solid fa-door-open"></i> ê°•ì˜ì‹¤ ì´ë™</div>
        <button onclick="document.getElementById('menuModal').style.display='none'" style="margin-top:15px; width:100%; padding:12px; border:none; border-radius:8px; background:#e2e8f0; font-weight:bold;">ë‹«ê¸°</button>
    </div>
</div>

<!-- ì°¨ëŸ‰ ì‹ ì²­ìš© íŒì—… (êµ¬ë¶„ê° í™•ì‹¤í•œ ë””ìì¸) -->
<div id="shuttleModal" class="menu-overlay" style="display:none; z-index: 7000;">
    <div class="menu-box" style="width:90%; padding: 25px 20px; border-radius: 20px;">
        <h3 style="margin-bottom: 5px;">ì°¨ëŸ‰ íƒ‘ìŠ¹ ì‹ ì²­</h3>
        <p style="font-size:12px; color:#94a3b8; margin-bottom:20px;">1ë‹¨ê³„: ëª©ì ì§€ ì„ íƒ -> 2ë‹¨ê³„: ì„±í•¨ ì…ë ¥</p>
        

<!-- ê¸°ì¡´ ì‹ ì²­ ë‚´ì—­ í™•ì¸ ë° ì·¨ì†Œ ì˜ì—­ -->
<div id="shuttleCancelArea" style="display:none; background: #fff1f2; padding: 15px; border-radius: 12px; border: 1px solid #fda4af; margin-bottom: 20px;">
    <p style="font-size: 14px; font-weight: 800; color: #e11d48; margin: 0 0 10px 0;">ê¸°ì¡´ ì‹ ì²­ ë‚´ì—­ì´ ìˆìŠµë‹ˆë‹¤.</p>
    <p id="myCurrentShuttle" style="font-size: 16px; font-weight: 900; color: #1e293b; margin-bottom: 15px;"></p>
    <button onclick="cancelShuttleRequest()" 
            style="width: 100%; padding: 10px; background: #e11d48; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold;">
        ì‹ ì²­ ì·¨ì†Œí•˜ê¸° (ì‚­ì œ)
    </button>
</div>



        <!-- 1ë‹¨ê³„: ëª©ì ì§€ ë²„íŠ¼ -->
        <div id="shuttleButtons" style="display:flex; flex-direction:column; gap:10px; margin-bottom: 25px;">
            <button class="quiz-opt-btn shuttle-btn" id="btn-osong" onclick="selectShuttle('osong', 'ì˜¤ì†¡ì—­')" style="justify-content: center;">ì˜¤ì†¡ì—­</button>
            <button class="quiz-opt-btn shuttle-btn" id="btn-terminal" onclick="selectShuttle('terminal', 'ì²­ì£¼í„°ë¯¸ë„')" style="justify-content: center;">ì²­ì£¼í„°ë¯¸ë„</button>
            <button class="quiz-opt-btn shuttle-btn" id="btn-airport" onclick="selectShuttle('airport', 'ì²­ì£¼ê³µí•­')" style="justify-content: center;">ì²­ì£¼ê³µí•­</button>
        </div>

        <!-- 2ë‹¨ê³„: ì´ë¦„ ì…ë ¥ ì˜ì—­ (ìƒ‰ìƒìœ¼ë¡œ í™•ì‹¤íˆ êµ¬ë¶„) -->
        <div id="shuttleInputArea" style="display:none; background: #f0f7ff; padding: 20px; border-radius: 15px; border: 2px dashed #3b82f6;">
            <label style="display:block; font-size:13px; font-weight:800; color:#3b82f6; margin-bottom:10px;">ğŸ‘‡ íƒ‘ìŠ¹ì ì„±í•¨ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”</label>
            <input type="text" id="shuttleUserName" placeholder="ì„±í•¨ ì…ë ¥" 
                   style="width: 100%; padding: 15px; border: 2px solid #3b82f6; border-radius: 10px; font-size: 20px; font-weight: 900; text-align: center; outline: none; background: white; margin-bottom: 10px;">
            <button onclick="submitShuttleRequest()" 
                    style="width: 100%; padding: 15px; background: #3b82f6; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);">
                ì‹ ì²­ ì™„ë£Œí•˜ê¸°
            </button>
        </div>

        <button onclick="closeShuttleModal()" style="margin-top:20px; width:100%; padding:15px; border:none; border-radius:12px; background:#f1f5f9; color: #475569; font-size: 20px; font-weight: 900; cursor: pointer;">ë‚˜ê°€ê¸°</button>
    </div>
</div>



<!-- [ì‹ ê·œ] í†µí•© í–‰ì • ì‹ ì²­ íŒì—… (ì™¸ì¶œ/ì™¸ë°•/ì„ì‹ ì œì™¸) -->
<div id="adminActionModal" class="menu-overlay" style="display:none; z-index: 7000;">
    <div class="menu-box" style="width:90%; padding: 25px 20px; border-radius: 20px; max-width: 400px;">
        <h3 style="margin-bottom: 5px;">ì¼ì¼ í–‰ì • ì‹ ì²­</h3>
        <p id="adminActionDate" style="font-size:12px; color:#94a3b8; margin-bottom:20px;">ì˜¤ëŠ˜ ë‚ ì§œ: 202X-XX-XX</p>

        <!-- ì‹ ì²­ í˜„í™© í‘œì‹œ (ì‹ ì²­í–ˆì„ ë•Œë§Œ ë³´ì„) -->
        <div id="adminStatusArea" style="display:none; background: #f0f7ff; padding: 15px; border-radius: 12px; border: 1px solid #3b82f6; margin-bottom: 20px; text-align: left;">
            <p style="font-size: 14px; font-weight: 800; color: #3b82f6; margin: 0 0 5px 0;">í˜„ì¬ ì‹ ì²­ ë‚´ì—­</p>
            <div id="adminStatusText" style="font-size: 15px; color: #1e293b; margin: 0; line-height: 1.4;"></div>
            <button onclick="cancelAdminAction()" style="width: 100%; margin-top:10px; padding: 8px; background: #ef4444; color: white; border: none; border-radius: 6px; font-weight: bold;">ì‹ ì²­ ì·¨ì†Œ</button>
        </div>

        <!-- ì‹ ì²­ ì…ë ¥ í¼ -->
        <div id="adminActionForm">
            <div style="text-align: left; margin-bottom: 20px;">
                <label style="font-weight: 800; font-size: 14px; color: #1e293b;">1. ì˜¤ëŠ˜ ì €ë… ì‹ì‚¬ ì—¬ë¶€</label>
                <div style="margin-top: 10px; background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                        <input type="checkbox" id="skipDinner" style="width:20px; height:20px;">
                        <span style="font-size:15px; font-weight:600;">ì˜¤ëŠ˜ ì €ë…ì€ ë¨¹ì§€ ì•ŠìŠµë‹ˆë‹¤. (ë™ì˜)</span>
                    </label>
                    <p style="font-size:11px; color:#ef4444; margin: 8px 0 0 30px;">â€» 16:00 ì´í›„ì—ëŠ” ì‹ ì²­/ì·¨ì†Œ ë¶ˆê°€</p>
                </div>
            </div>

            <div style="text-align: left; margin-bottom: 25px;">
                <label style="font-weight: 800; font-size: 14px; color: #1e293b;">2. ì™¸ì¶œÂ·ì™¸ë°• ì‹ ì²­ (í•´ë‹¹ ì‹œ)</label>
                <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 8px;">
                    <button class="quiz-opt-btn admin-type-btn" id="btn-none" onclick="selectAdminType('none')" style="height:50px; font-size:16px;">í•´ë‹¹ ì—†ìŒ</button>
                    <button class="quiz-opt-btn admin-type-btn" id="btn-outing" onclick="selectAdminType('outing')" style="height:50px; font-size:16px;">ì™¸ì¶œ (ë‹¹ì¼ ë³µê·€)</button>
                    <button class="quiz-opt-btn admin-type-btn" id="btn-overnight" onclick="selectAdminType('overnight')" style="height:50px; font-size:16px;">ì™¸ë°• (ìµì¼ ë³µê·€)</button>
                </div>
            </div>

            <!-- ì™¸ì¶œ/ì™¸ë°• ì„ íƒ ì‹œì—ë§Œ ë‚˜íƒ€ë‚˜ëŠ” ì „í™”ë²ˆí˜¸ ì…ë ¥ -->
            <div id="fullPhoneArea" style="display:none; text-align: left; margin-bottom: 25px; background: #fff1f2; padding: 15px; border-radius: 12px;">
                <label style="font-weight: 800; font-size: 13px; color: #e11d48;">ë¹„ìƒ ì—°ë½ì²˜ (ì „ì²´ ë²ˆí˜¸ ì…ë ¥)</label>
                <input type="tel" id="fullPhone" placeholder="010-0000-0000" style="width:100%; margin-top:8px; padding:12px; border:1px solid #fda4af; border-radius:8px; font-size:16px; text-align:center;">
            </div>

            <button onclick="submitAdminAction()" style="width: 100%; padding: 15px; background: #10b981; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);">ì‹ ì²­ ì™„ë£Œ</button>
        </div>

           <button onclick="document.getElementById('adminActionModal').style.display='none'" style="margin-top:20px; width:100%; padding:15px; border:none; border-radius:12px; background:#f1f5f9; color: #475569; font-size: 20px; font-weight: 900; cursor: pointer;">ë‚˜ê°€ê¸°</button>
    </div>
</div>




<!-- [ì‹ ê·œ] ì‹ë‹¨í‘œ ì´ë¯¸ì§€ íŒì—… -->
<div id="mealMenuModal" class="menu-overlay" style="display:none; z-index: 8000;" onclick="this.style.display='none'">
    <div style="width:90%; max-width:500px; background:white; border-radius:20px; padding:10px; position:relative;">
        <img id="mealMenuImage" src="" style="width:100%; border-radius:15px; display:block;" alt="ì‹ë‹¨í‘œ ì¤€ë¹„ì¤‘">
        <p style="margin-top:10px; font-weight:bold; color:#64748b;">(í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ë‹«í™ë‹ˆë‹¤)</p>
    </div>
</div>















    <script src="config.js"></script>
    <script>
        let serverTimeOffset = 0; // ì¶”ê°€
        let dbRef = {}; let currentRoom = null; let myQs = {}; let myLikes = {}; let lastPostTime = 0; let editingKey = null; let currentSort = 'new'; let currentQuizId = null; let canAnswer = false; let myLastChoice = null; let hasClosedSummary = false; let rankingListener = null; let studentTimerInterval = null;
        
        (async function init() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code'); const directRoom = params.get('room');
            if (code) currentRoom = await resolveRoomFromCode(code); else if (directRoom) currentRoom = directRoom;
            
            // [ìˆ˜ì •] ë°© ì •ë³´ê°€ ì—†ìœ¼ë©´ 'ë°© ì„ íƒ' UI ë³´ì—¬ì£¼ê¸° (ì˜¤ë¥˜ ëŒ€ì‹ )
            if (!currentRoom) { 
                document.getElementById('roomBadge').innerText = "Select Room";
                document.getElementById('landingBadge').innerText = "ê°•ì˜ì‹¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”";
                document.getElementById('landingTitle').innerText = "KAC Student Platform";
                
                const btn = document.querySelector('.btn-enter');
                btn.innerHTML = 'ê°•ì˜ì‹¤ ëª©ë¡ ë³´ê¸° <i class="fa-solid fa-list"></i>';
                btn.onclick = function() {
                    document.getElementById('landingPage').style.display = 'none'; // ì¼ë‹¨ ëœë”© ìˆ¨ê¸°ê³ 
                    openMenu(); // ë©”ë‰´ ì—´ê¸°
                };
                return;
            }

            document.getElementById('roomBadge').innerText = `Room ${currentRoom}`; document.getElementById('landingBadge').innerText = `ROOM ${currentRoom}`;
            myLikes = JSON.parse(localStorage.getItem(`likes_${currentRoom}`) || '{}'); myQs = JSON.parse(localStorage.getItem(`myqs_${currentRoom}`) || '{}'); 
            lastPostTime = parseInt(localStorage.getItem(`lastTime_${currentRoom}`) || '0');
            const db = firebase.database(); const rPath = `courses/${currentRoom}`;
            dbRef = { qa: db.ref(`${rPath}/questions`), quiz: db.ref(`${rPath}/activeQuiz`), ans: db.ref(`${rPath}/quizAnswers`), settings: db.ref(`${rPath}/settings`), status: db.ref(`${rPath}/status`), connections: db.ref(`${rPath}/connections`) };


            setupListeners(); checkCooldown();

            dbRef.status.once('value', s => {
                const st = s.val() || {};
                if(st.quizStep !== 'summary') {
                    document.getElementById('quizOverlay').style.display = 'none';
                    document.getElementById('quizResultBox').style.display = 'none';
                }
            });
        })();




async function enterApp() {
    // 1. ì „ì²´í™”ë©´ ìš”ì²­
    const doc = document.documentElement;
    if (doc.requestFullscreen) doc.requestFullscreen().catch(e=>{});
    else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen().catch(e=>{});

    // 2. [í•µì‹¬] ì…ì¥ ì „ í”„ë¡œí•„ í™•ì¸ (ì„œë²„ ëŒ€ì¡°)
    await checkProfile();
}









        // [ìˆ˜ì •] ì™„ì „íˆ ë‚˜ê°€ê¸° (ì£¼ì†Œ ì´ˆê¸°í™”)
function exitApp() {
    if (confirm("í˜„ì¬ ê°•ì˜ì‹¤ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        const ua = navigator.userAgent.toLowerCase();
        
        // 1. ì¹´ì¹´ì˜¤í†¡ ì¸ì•± ë¸Œë¼ìš°ì € ê°•ì œ ì¢…ë£Œ (ì„±ê³µ ì‹œ ì—¬ê¸°ì„œ ëë‚¨)
        if (ua.indexOf('kakaotalk') !== -1) {
            location.href = 'kakaotalk://inappbrowser/close';
            return;
        }

        // 2. ë„¤ì´ë²„ ì•± ì¸ì•± ë¸Œë¼ìš°ì € ê°•ì œ ì¢…ë£Œ (ì„±ê³µ ì‹œ ì—¬ê¸°ì„œ ëë‚¨)
        if (ua.indexOf('naver') !== -1) {
            location.href = 'naversearchapp://inappbrowser/close';
            return;
        }

        // 3. ê·¸ ì™¸ (ì•„ì´í° ì¹´ë©”ë¼, í¬ë¡¬, ì‚¬íŒŒë¦¬ ë“±)
        // [ì¤‘ìš”] ì ˆëŒ€ window.location.href ë¡œì§ì„ ë„£ì§€ ë§ˆì„¸ìš”! (ì…ì¥ì°½ìœ¼ë¡œ ê°€ëŠ” ì›ì¸)
        
        // ë¸Œë¼ìš°ì €ê°€ ì°½ì„ ë‹«ëŠ” ê²ƒì„ ê±°ë¶€í•  ë•Œë¥¼ ëŒ€ë¹„í•´ í™”ë©´ì„ 'í‡´ì¥ ì•ˆë‚´'ë¡œ ë®ì–´ë²„ë¦½ë‹ˆë‹¤.
        document.documentElement.innerHTML = `
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>í‡´ì¥ ì™„ë£Œ</title>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                <style>
                    body { background: #0f172a; color: white; margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; }
                    .exit-box { height: 100dvh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
                    .icon { font-size: 80px; color: #3b82f6; margin-bottom: 20px; }
                    h2 { font-size: 24px; margin: 0; }
                    p { font-size: 16px; opacity: 0.7; margin-top: 15px; line-height: 1.5; }
                    .btn-close { margin-top: 30px; padding: 12px 40px; background: #334155; color: white; border: none; border-radius: 30px; font-weight: bold; }
                </style>
            </head>
            <body>
                <div class="exit-box">
                    <div class="icon"><i class="fa-solid fa-right-from-bracket"></i></div>
                    <h2>í‡´ì¥ ì™„ë£Œ</h2>
                    <p>ì •ìƒì ìœ¼ë¡œ í‡´ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì´ ë¸Œë¼ìš°ì € ì°½(íƒ­)ì„ ë‹«ì•„ì£¼ì„¸ìš”.</p>
                    <button class="btn-close" onclick="window.close()">ì°½ ë‹«ê¸° ì‹œë„</button>
                </div>
            </body>
        `;

        // íˆìŠ¤í† ë¦¬ë¥¼ ê¼¬ì•„ë²„ë ¤ ë’¤ë¡œê°€ê¸°ë¥¼ í•´ë„ ì…ì¥ì°½ìœ¼ë¡œ ëª» ëŒì•„ê°€ê²Œ í•¨
        window.history.pushState(null, null, window.location.href);
        window.onpopstate = function() { window.history.go(1); };

        // ë§ˆì§€ë§‰ìœ¼ë¡œ ì°½ ë‹«ê¸° ì‹œë„
        setTimeout(() => { window.close(); }, 300);
    }
}

// [í†µí•© ë¡œì§] ì—¬ê¸°ì„œë¶€í„° ë§ˆì§€ë§‰ê¹Œì§€ êµì²´ (ìš©ëŸ‰ ìœ ì§€ ë° ë¦¬ì…‹ ë³´ì•ˆ ê°•í™” ë²„ì „)
function startPresence() {
    const uToken = localStorage.getItem('uToken');
    if (!uToken || !currentRoom) return;

    // ì˜¨ë¼ì¸ ìƒíƒœ ì‹¤ì‹œê°„ ì—°ë™ (onDisconnect í¬í•¨)
    const connectedRef = firebase.database().ref(".info/connected");
    const myStatusRef = firebase.database().ref(`courses/${currentRoom}/students/${uToken}/isOnline`);

    connectedRef.on("value", (snap) => {
        if (snap.val() === true) {
            myStatusRef.set(true);
            myStatusRef.onDisconnect().set(false);
            const con = dbRef.connections.push();
            con.onDisconnect().remove();
            con.set(true);
        }
    });

    dbRef.connections.on("value", (snap) => {
        const count = snap.numChildren();
        const countEl = document.getElementById('realUserCount');
        if(countEl) countEl.innerText = `${count}ëª… ì ‘ì†`;
    });
}

// ê°•ì‚¬ í™”ë©´ì˜ ìƒíƒœ ë³€í™”(ëª¨ë“œ ì „í™˜, ë¦¬ì…‹)ë¥¼ ê°ì‹œí•˜ëŠ” ì „ë¬¸ ë¦¬ìŠ¤ë„ˆ
function setupListeners() {
    // 1. ì„œë²„ ì‹œê°„ ë™ê¸°í™”
    firebase.database().ref(".info/serverTimeOffset").on("value", (snap) => {
        serverTimeOffset = snap.val() || 0;
    });

    // 2. ë°© ì œëª© ë° ì„¤ì • ë³€ê²½ ê°ì§€
    dbRef.settings.on('value', s => { 
        const val = s.val() || {}; 
        const title = val.courseName || `Course ${currentRoom}`; 
        document.getElementById('roomTitle').innerText = title; 
        document.getElementById('landingTitle').innerText = title; 
    });

    // 3. Q&A ì§ˆë¬¸ ëª©ë¡ ì—…ë°ì´íŠ¸ ê°ì‹œ
    dbRef.qa.on('value', snap => renderList(snap.val() || {}));

    // 4. ë¦¬ì…‹ ë° í€´ì¦ˆ ëª¨ë“œ ì „í™˜ í†µí•© ê°ì‹œ (ê°€ì¥ ì¤‘ìš”í•œ êµ¬ê°„)
    dbRef.status.on('value', snap => {
        const st = snap.val() || {};
        
        // [ë³´ì•ˆ] ê°•ì‚¬ê°€ ë¦¬ì…‹(ResetCourse)ì„ ëˆŒë €ëŠ”ì§€ ì—´ì‡ (resetKey)ë¥¼ ëŒ€ì¡°í•¨
        const serverResetKey = st.resetKey || 'init';
        const myKey = localStorage.getItem(`kac_resetKey_${currentRoom}`);

        // ë‚´ ì—´ì‡ ì™€ ì„œë²„ ì—´ì‡ ê°€ ë‹¤ë¥´ë©´ "ë¦¬ì…‹ë˜ì—ˆë‹¤"ê³  íŒë‹¨í•˜ê³  ì¦‰ì‹œ í‡´ì¥
        if (myKey && myKey !== serverResetKey) {
            console.log("ì„¸ì…˜ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤. ê°•ì œ í‡´ì¥ ì²˜ë¦¬í•©ë‹ˆë‹¤.");
            localStorage.clear(); // ê³¼ê±°ì˜ ì´ë¦„, í† í° ì •ë³´ ëª¨ë‘ ì‚­ì œ
            alert("ê°•ì˜ì‹¤ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ì¥í•´ì£¼ì„¸ìš”.");
            location.reload(); // ìƒˆë¡œê³ ì¹¨í•´ì„œ ì´ë¦„ ì…ë ¥ì°½ìœ¼ë¡œ ë³´ëƒ„
            return;
        }

        // Q&A ëª¨ë“œì™€ Quiz ëª¨ë“œ ì „í™˜ ë¡œì§ (í•™ìƒ í™”ë©´ ì œì–´)
        if (st.mode === 'qa') { 
            forceCloseQuiz(); 
        } else if (st.mode === 'quiz') {
            if (st.quizStep === 'summary') {
                if(!hasClosedSummary) showFinalRanking();
            } else {
                document.getElementById('quizOverlay').style.display = 'flex';
                document.getElementById('quizActiveBox').style.display = 'block';
                document.getElementById('quizResultBox').style.display = 'none';
                if (!currentQuizId) {
                    document.getElementById('quizStatusMsg').innerText = "ê°•ì‚¬ë‹˜ì´ í€´ì¦ˆë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...";
                }
            }
        }
    });

    // í€´ì¦ˆ ë¬¸ì œ ë° ìƒíƒœ ë³€í™” ê°ì‹œ
    dbRef.quiz.on('value', s => {
        const q = s.val(); if(!q) return;
        handleQuizData(q);
    });

    // ì§ˆë¬¸ ì…ë ¥ì°½ ìë™ ë†’ì´ ì¡°ì ˆ ê¸°ëŠ¥
    const qInputEl = document.getElementById('qInput');
    if(qInputEl) {
        qInputEl.addEventListener('input', function() {
            const len = this.value.length; 
            document.getElementById('charCount').innerText = `${len} / 100`;
            this.style.height = '1px'; 
            this.style.height = (this.scrollHeight) + 'px';
        });
    }
}

// ì…ì¥ ì‹œ í”„ë¡œí•„ í™•ì¸ ë° ì„¸ì…˜ ì—´ì‡ (Key) ìœ íš¨ì„± ê²€ì‚¬
async function checkProfile() {
    try {
        const statusSnap = await firebase.database().ref(`courses/${currentRoom}/status`).once('value');
        const serverResetKey = statusSnap.val()?.resetKey || 'init';
        const myKey = localStorage.getItem(`kac_resetKey_${currentRoom}`);
        const uToken = localStorage.getItem('uToken');

        // ë‚´ ì—´ì‡ ê°€ ì„œë²„ ì—´ì‡ ì™€ ë‹¤ë¥´ê±°ë‚˜ ì •ë³´ê°€ ì—†ìœ¼ë©´ í”„ë¡œí•„ ì…ë ¥ì°½ì„ ë„ì›€
        if (!uToken || !myKey || myKey !== serverResetKey) {
            console.log("ìƒˆë¡œìš´ ì„¸ì…˜ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            localStorage.clear(); // ê³¼ê±° ì •ë³´ ì‚­ì œ
            document.getElementById('profileOverlay').style.display = 'flex';
        } else {
            // ìœ íš¨í•œ ìˆ˜ê°•ìƒì´ë©´ ì¦‰ì‹œ ì…ì¥
            startPresence();
            showMainDashboard();
            setupListeners();
        }
    } catch (e) {
        console.error("ì¸ì¦ ê³¼ì • ì˜¤ë¥˜ ë°œìƒ:", e);
        document.getElementById('profileOverlay').style.display = 'flex';
    }
}

// ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ ì“°ê³  [ì…ì¥ ì™„ë£Œ]ë¥¼ ëˆŒë €ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
async function saveProfile() {
    const name = document.getElementById('userName').value.trim();
    const phone = document.getElementById('userPhone').value.trim();
    
    if (!name || phone.length !== 4) { 
        alert("ì„±í•¨ê³¼ ì „í™”ë²ˆí˜¸ ë’· 4ìë¦¬ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”."); 
        return; 
    }

    try {
        // í˜„ì¬ ì„œë²„ì˜ ë¦¬ì…‹ ì—´ì‡ ë¥¼ ê°€ì ¸ì˜´
        const statusSnap = await firebase.database().ref(`courses/${currentRoom}/status`).once('value');
        const serverResetKey = statusSnap.val()?.resetKey || 'init';
        const uToken = Math.random().toString(36).substr(2); // ìƒˆë¡œìš´ ê³ ìœ  í† í° ìƒì„±

        // 1. ì„œë²„ì— ìˆ˜ê°•ìƒ ì •ë³´ ë“±ë¡
        await firebase.database().ref(`courses/${currentRoom}/students/${uToken}`).set({
            name: name, phone: phone, joinedAt: firebase.database.ServerValue.TIMESTAMP, isOnline: true
        });

        // 2. ë¸Œë¼ìš°ì €ì— ì´ë¦„, í† í°, ê·¸ë¦¬ê³  ì„œë²„ ì—´ì‡ (ResetKey) ì €ì¥
        localStorage.setItem('kac_user_name', name);
        localStorage.setItem('kac_user_phone', phone);
        localStorage.setItem('uToken', uToken);
        localStorage.setItem(`kac_resetKey_${currentRoom}`, serverResetKey);

        document.getElementById('profileOverlay').style.display = 'none';
        showMainDashboard();
        startPresence();
        setupListeners();
        alert(`${name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`);
    } catch (e) {
        console.error("ì €ì¥ ì˜¤ë¥˜:", e);
        alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}

// ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜
function showMainDashboard() {
    document.getElementById('landingPage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'flex';
}

// ì™„ì „íˆ ë‚˜ê°€ê¸° (ë°© ì •ë³´ ë¦¬ì…‹ í›„ ì´ˆê¸°í™”ë©´ìœ¼ë¡œ)
function exitApp() {
    if (confirm("í˜„ì¬ ê°•ì˜ì‹¤ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        localStorage.clear();
        location.reload();
    }
}

// ê¸°íƒ€ ì§ˆë¬¸ ëª©ë¡ ë Œë”ë§ ë° í€´ì¦ˆ í•¸ë“¤ë§ ë¡œì§ë“¤
function setSort(type) { currentSort = type; dbRef.qa.once('value', s => renderList(s.val()||{})); }
function renderList(data) {
    const list = document.getElementById('qList'); if(!list) return;
    list.innerHTML = ""; let items = Object.keys(data).map(k => ({id:k, ...data[k]}));
    if(currentSort === 'like') items.sort((a,b) => (b.likes||0)-(a.likes||0));
    else items.sort((a,b) => b.timestamp - a.timestamp);
    items.forEach(i => {
        const likedClass = myLikes[i.id] ? 'active' : '';
        list.innerHTML += `<div class="q-card"><div class="q-content"><div class="q-text">${i.text}</div></div><div class="q-like-area"><div class="like-btn ${likedClass}" onclick="toggleLike('${i.id}')">ğŸ‘</div><div class="like-count">${i.likes||0}</div></div></div>`;
    });
}
function submitQ() {
    const txt = document.getElementById('qInput').value.trim(); if(!txt) return;
    dbRef.qa.push({ text: txt, likes: 0, timestamp: firebase.database.ServerValue.TIMESTAMP });
    document.getElementById('qInput').value = "";
}
function toggleLike(id) {
    if(myLikes[id]) { dbRef.qa.child(id).child('likes').transaction(l => (l||0)-1); delete myLikes[id]; }
    else { dbRef.qa.child(id).child('likes').transaction(l => (l||0)+1); myLikes[id]=true; }
    localStorage.setItem(`likes_${currentRoom}`, JSON.stringify(myLikes));
}
function handleQuizData(q) {
    if(studentTimerInterval) clearInterval(studentTimerInterval);
    const msgBox = document.getElementById('quizStatusMsg');
    const multArea = document.getElementById('btnGroupMultiple');
    const oxArea = document.getElementById('btnGroupOX');
    if(q.status === 'ready') {
        canAnswer = false; msgBox.innerText = "ê°•ì‚¬ë‹˜ì´ ê³§ í€´ì¦ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.";
        multArea.style.display = 'none'; oxArea.style.display = 'none';
    } else if(q.status === 'open') {
        canAnswer = true; msgBox.innerText = "ì •ë‹µì„ ì„ íƒí•˜ì„¸ìš”!";
        if(q.isOX) oxArea.style.display = 'flex'; else multArea.style.display = 'flex';
    }
    currentQuizId = q.id;
}
async function sendAns(c) {
    if(!canAnswer) return;
    const t = localStorage.getItem('uToken');
    myLastChoiceIdx = c;
    dbRef.ans.child(currentQuizId).child(t).set({choice:c});
    document.getElementById('quizFeedback').innerText = `${c}ë²ˆ ì„ íƒ ì™„ë£Œ!`;
}
function forceCloseQuiz() { document.getElementById('quizOverlay').style.display = 'none'; }
function showFinalRanking() {
    document.getElementById('quizOverlay').style.display = 'flex';
    document.getElementById('quizActiveBox').style.display = 'none';
    document.getElementById('quizResultBox').style.display = 'block';
}
function closeResultOverlay() { hasClosedSummary = true; forceCloseQuiz(); }
async function viewMealMenu() {
    document.getElementById('menuModal').style.display = 'none';
    const snap = await firebase.database().ref('system/nutrition_menu').once('value');
    if (snap.val()) { document.getElementById('mealMenuImage').src = snap.val(); document.getElementById('mealMenuModal').style.display = 'flex'; }
    else alert("ë“±ë¡ëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.");
}
function openShuttleApply() { document.getElementById('menuModal').style.display = 'none'; document.getElementById('shuttleModal').style.display = 'flex'; }
function selectShuttle(id, name) {
    const t = localStorage.getItem('uToken');
    const userName = localStorage.getItem('kac_user_name');
    firebase.database().ref(`courses/${currentRoom}/shuttle/${id}/${t}`).set(userName);
    alert(`${name} ì‹ ì²­ ì™„ë£Œ!`); closeShuttleModal();
}
function closeShuttleModal() { document.getElementById('shuttleModal').style.display = 'none'; }
function openAdminAction() { document.getElementById('menuModal').style.display = 'none'; document.getElementById('adminActionModal').style.display = 'flex'; }
function selectAdminType(t) { selectedAdminType = t; }
function submitAdminAction() { alert("ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤."); document.getElementById('adminActionModal').style.display = 'none'; }
function openRoomMove() { location.reload(); }



    </script>
</body>
</html>