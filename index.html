<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KAC Student Platform</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --theme-color: #0f172a; /* Instructor's Navy */
            --point-color: #d32f2f; /* Red Bar if needed */
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        body { margin: 0; background: #f1f5f9; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Level 1: Fixed Header */
        .header {
            height: 60px; background: white; display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 18px; color: #333; flex-shrink: 0; z-index: 100;
            border-bottom: 5px solid var(--theme-color); /* Color Bar */
        }

        /* Level 2: Fixed Input Area */
        .input-area {
            background: #e2e8f0; padding: 15px; flex-shrink: 0; z-index: 90;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .q-input {
            width: 100%; border: 2px solid #cbd5e1; padding: 12px; border-radius: 10px;
            font-size: 16px; margin-bottom: 10px; resize: none; height: 80px;
        }
        .q-input:focus { outline: none; border-color: var(--theme-color); }
        .input-actions { display: flex; justify-content: space-between; align-items: center; }
        .timer-msg { font-size: 12px; color: #ef4444; font-weight: bold; visibility: hidden; }
        .btn-submit {
            background: var(--theme-color); color: white; padding: 10px 25px; border-radius: 30px;
            font-weight: bold; border: none; font-size: 14px;
        }
        .btn-submit:disabled { background: #94a3b8; }

        /* Level 3: Sticky Bar */
        .scroll-container { flex-grow: 1; overflow-y: auto; position: relative; }
        .sticky-bar {
            position: sticky; top: 0; background: #f1f5f9; padding: 15px;
            font-size: 14px; font-weight: bold; color: #64748b; z-index: 80;
            border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between;
        }

        /* Level 4: List */
        .q-list { padding: 0 15px 30px 15px; }
        .q-card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); display: flex; justify-content: space-between;
            align-items: flex-start;
        }
        .q-card.my-q { border: 2px solid var(--theme-color); background: #f8fafc; }
        .q-text { font-size: 15px; line-height: 1.4; color: #333; word-break: break-all; width: 80%; }
        .like-btn {
            background: #f1f5f9; color: #94a3b8; padding: 5px 10px; border-radius: 20px;
            font-size: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .like-btn.active { background: #ffe4e6; color: #f43f5e; }

        /* Menu Modal */
        .menu-btn { position: absolute; left: 15px; font-size: 20px; cursor: pointer; }
        .menu-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            z-index: 2000; display: none; align-items: center; justify-content: center; 
        }
        .menu-box { background: white; padding: 30px; border-radius: 15px; width: 300px; text-align: center; }
        .room-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }

        /* Quiz Overlay */
        .quiz-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white;
            z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .quiz-badge { background: var(--theme-color); color: white; padding: 5px 15px; border-radius: 20px; margin-bottom: 20px; font-size: 12px; font-weight: bold; }
        .quiz-msg { font-size: 20px; font-weight: 800; text-align: center; margin-bottom: 40px; }
        .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .quiz-opt-btn { 
            height: 100px; font-size: 30px; font-weight: 900; background: white; 
            border: 4px solid #e2e8f0; border-radius: 15px; color: #333;
        }
        .quiz-opt-btn.selected { border-color: var(--theme-color); background: var(--theme-color); color: white; }
        .quiz-wait { margin-top: 30px; color: #64748b; font-weight: bold; display: none; }

    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="menu-btn" onclick="openMenu()"><i class="fa-solid fa-bars"></i></div>
        <span id="roomTitle">Loading...</span>
    </div>

    <!-- Fixed Input -->
    <div class="input-area">
        <textarea id="qInput" class="q-input" placeholder="Ask a question..."></textarea>
        <div class="input-actions">
            <span id="coolTimer" class="timer-msg">Wait 02:00</span>
            <button id="submitBtn" class="btn-submit" onclick="submitQ()">Submit</button>
        </div>
    </div>

    <!-- Scroll Area -->
    <div class="scroll-container">
        <div class="sticky-bar">
            <span><i class="fa-solid fa-comments"></i> Live Questions</span>
            <span style="font-size:12px;">Sort: Likes <i class="fa-solid fa-arrow-down"></i></span>
        </div>
        <div id="qList" class="q-list"></div>
    </div>

    <!-- Quiz Overlay -->
    <div id="quizOverlay" class="quiz-overlay">
        <div class="quiz-badge">LIVE QUIZ</div>
        <div class="quiz-msg" id="quizStatusMsg">Select Answer</div>
        <div class="quiz-grid" id="quizBtns">
            <button class="quiz-opt-btn" onclick="sendAns(1)">1</button>
            <button class="quiz-opt-btn" onclick="sendAns(2)">2</button>
            <button class="quiz-opt-btn" onclick="sendAns(3)">3</button>
            <button class="quiz-opt-btn" onclick="sendAns(4)">4</button>
        </div>
        <div class="quiz-wait" id="quizWait">Submitted. Waiting for result...</div>
    </div>

    <!-- Menu Modal -->
    <div id="menuModal" class="menu-overlay" onclick="if(event.target==this)this.style.display='none'">
        <div class="menu-box">
            <h3>Select Room</h3>
            <div id="roomList" style="max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // --- 1. Security & Init ---
        // Single Tab Check
        const bc = new BroadcastChannel('kac_student_channel');
        bc.onmessage = (e) => { if(e.data === 'here') { alert("Already open in another tab."); window.location.href="about:blank"; } };
        bc.postMessage('here');

        // Resolve Room
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        let currentRoom = getRoomFromCode(code);

        if(!currentRoom) {
            alert("Invalid Link or Room Code.");
            // Fallback (e.g. ask for code logic could be here, but for now just stop)
            document.body.innerHTML = "<h2 style='text-align:center; margin-top:50px;'>Invalid Access Link</h2>";
            throw new Error("No Room");
        }

        document.getElementById('roomTitle').innerText = `Course Room ${currentRoom}`;

        // --- 2. Firebase & Logic ---
        const dbRef = {
            qa: db.ref(`courses/${currentRoom}/questions`),
            quiz: db.ref(`courses/${currentRoom}/activeQuiz`),
            ans: db.ref(`courses/${currentRoom}/quizAnswers`)
        };

        // Q&A
        let myLikes = JSON.parse(localStorage.getItem(`likes_${currentRoom}`) || '{}');
        let myQs = JSON.parse(localStorage.getItem(`myqs_${currentRoom}`) || '{}');
        let lastPostTime = parseInt(localStorage.getItem(`lastTime_${currentRoom}`) || '0');

        dbRef.qa.on('value', snap => {
            const data = snap.val() || {};
            const list = document.getElementById('qList');
            list.innerHTML = "";

            let items = Object.keys(data).map(k => ({id:k, ...data[k]}));
            // Sort: Likes DESC -> Time DESC
            items.sort((a,b) => (b.likes||0) - (a.likes||0) || b.timestamp - a.timestamp);

            items.forEach(item => {
                if(item.status === 'delete') return; // Hide deleted
                const isMine = myQs[item.id] ? 'my-q' : '';
                const likedClass = myLikes[item.id] ? 'active' : '';
                
                list.innerHTML += `
                    <div class="q-card ${isMine}">
                        <div class="q-text">${escapeHtml(item.text)}</div>
                        <div class="like-btn ${likedClass}" onclick="toggleLike('${item.id}')">
                            <i class="fa-solid fa-thumbs-up"></i> ${item.likes||0}
                        </div>
                    </div>
                `;
            });
        });

        function submitQ() {
            const now = Date.now();
            if(now - lastPostTime < 120000) return; // 2 min check

            const txt = document.getElementById('qInput').value.trim();
            if(!txt) return;

            const ref = dbRef.qa.push();
            ref.set({
                text: txt, likes: 0, timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'normal'
            });

            // Local Save
            myQs[ref.key] = true;
            localStorage.setItem(`myqs_${currentRoom}`, JSON.stringify(myQs));
            
            // Timer logic
            lastPostTime = now;
            localStorage.setItem(`lastTime_${currentRoom}`, now);
            document.getElementById('qInput').value = "";
            checkCooldown();
        }

        function checkCooldown() {
            const diff = Date.now() - lastPostTime;
            const btn = document.getElementById('submitBtn');
            const msg = document.getElementById('coolTimer');
            
            if(diff < 120000) {
                btn.disabled = true;
                msg.style.visibility = 'visible';
                const sec = Math.ceil((120000 - diff)/1000);
                msg.innerText = `Wait ${sec}s`;
                setTimeout(checkCooldown, 1000);
            } else {
                btn.disabled = false;
                msg.style.visibility = 'hidden';
            }
        }
        // Init timer check
        checkCooldown();

        function toggleLike(key) {
            if(myLikes[key]) return; // 1 like per person
            dbRef.qa.child(key).transaction(post => {
                if(post) post.likes = (post.likes||0) + 1;
                return post;
            });
            myLikes[key] = true;
            localStorage.setItem(`likes_${currentRoom}`, JSON.stringify(myLikes));
        }

        // Quiz Logic
        let currentQuizId = null;
        let canAnswer = false;

        dbRef.quiz.on('value', snap => {
            const q = snap.val();
            const overlay = document.getElementById('quizOverlay');
            
            if(!q || q.status === 'result') {
                overlay.style.display = 'none'; // Hide on result or null
                return;
            }

            // Show Overlay
            overlay.style.display = 'flex';
            currentQuizId = q.id;
            
            if(q.status === 'open') {
                canAnswer = true;
                document.getElementById('quizStatusMsg').innerText = "Select Answer Now!";
                document.getElementById('quizBtns').style.pointerEvents = 'auto';
                document.getElementById('quizBtns').style.opacity = '1';
            } else if(q.status === 'ready') {
                canAnswer = false;
                document.getElementById('quizStatusMsg').innerText = "Look at the Screen (Ready)";
                document.getElementById('quizBtns').style.pointerEvents = 'none';
                document.getElementById('quizBtns').style.opacity = '0.5';
            } else {
                // Closed
                canAnswer = false;
                document.getElementById('quizStatusMsg').innerText = "Closed.";
                document.getElementById('quizBtns').style.pointerEvents = 'none';
            }

            // Check if I already answered this specific quiz ID
            // But requirement says: allow modification until closed.
            // So we just highlight selected button.
        });

        function sendAns(choice) {
            if(!canAnswer || !currentQuizId) return;
            
            // Highlight UI
            document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.quiz-opt-btn')[choice-1].classList.add('selected');

            // Send to DB (Push unique key per user-device is hard without auth, 
            // so we push and let backend count, or overwrite if we had user ID.
            // Simplified: Just push. Real stats might need dedup logic in admin, 
            // or we generate a random user token in localStorage.)
            
            let myToken = localStorage.getItem('userToken');
            if(!myToken) { myToken = Math.random().toString(36).substr(2); localStorage.setItem('userToken', myToken); }

            dbRef.ans.child(currentQuizId).child(myToken).set({
                choice: choice,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            document.getElementById('quizWait').style.display = 'block';
        }

        // Menu & Room Switching
        function openMenu() {
            const list = document.getElementById('roomList');
            list.innerHTML = "";
            for(let i=65; i<=90; i++) {
                const char = String.fromCharCode(i);
                list.innerHTML += `<div class="room-item" onclick="switchRoom('${char}')">Course Room ${char}</div>`;
            }
            document.getElementById('menuModal').style.display = 'flex';
        }

        function switchRoom(targetRoom) {
            const pw = prompt(`Enter Password for Room ${targetRoom}:`);
            if(!pw) return;

            // Verify Password via DB
            db.ref(`courses/${targetRoom}/settings/password`).once('value', snap => {
                const realPw = snap.val();
                if(realPw && realPw == pw) {
                    const nextCode = getCodeFromRoom(targetRoom);
                    window.location.search = `?code=${nextCode}`;
                } else {
                    alert("Wrong Password.");
                }
            });
        }

        function escapeHtml(t) { return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;") : ""; }
    </script>
</body>
</html>