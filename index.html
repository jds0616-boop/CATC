<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CATC Training Q&A</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --theme-color: #3b82f6; --main-color: #1a237e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: sans-serif; margin: 0; padding: 0; background: #f0f2f5; overflow: hidden; height: 100vh; }
        .app-container { width: 100%; max-width: 600px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; background: #f0f2f5; }
        .header { height: 65px; background: var(--main-color); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 6px solid var(--theme-color); transition: border-color 0.3s; flex-shrink: 0;}
        .footer { height: auto; min-height: 60px; background: var(--main-color); color: #ccc; text-align: center; padding: 15px; font-size: 11px; flex-shrink: 0;}
        .course-title { font-weight: bold; font-size: 18px; }
        .kac-logo { height: 16px; }
        
        .scroll-area { flex-grow: 1; overflow-y: auto; padding-bottom: 80px; }
        .input-section { padding: 20px; background: #e8eaf6; }
        .q-input { width: 100%; height: 100px; padding: 15px; border: 2px solid var(--theme-color); border-radius: 12px; resize: none; }
        .action-row { display: flex; justify-content: flex-end; align-items: center; margin-top: 12px; }
        .btn-submit { background: var(--theme-color); color: white; padding: 12px 30px; border: none; border-radius: 50px; font-weight: bold; cursor:pointer;}
        
        .list-header { padding: 15px; font-weight: bold; color: #555; background: #f0f2f5; position: sticky; top: 0; }
        .q-card { background: white; margin: 10px 15px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* Quiz Overlay */
        #quizOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 5000; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        #quizWaitingScreen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 4900; align-items: center; justify-content: center; flex-direction: column; text-align: center; }
        
        .quiz-badge { background: var(--main-color); color: white; padding: 8px 20px; border-radius: 30px; font-weight: bold; margin-bottom: 30px; font-size: 16px; }
        .quiz-msg { font-size: 24px; font-weight: 800; text-align: center; margin-bottom: 50px; color: #333; line-height: 1.4; }
        
        .quiz-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 400px; }
        .quiz-btn { height: 120px; font-size: 40px; font-weight: 900; border: 4px solid #eee; background: white; border-radius: 20px; cursor: pointer; color: #333; transition:0.1s; }
        .quiz-btn.selected { background: var(--theme-color); color: white; border-color: var(--theme-color); }
        
        .btn-confirm-quiz { margin-top: 40px; padding: 15px 50px; background: #1a237e; color: white; font-size: 20px; font-weight: bold; border-radius: 50px; border: none; cursor: pointer; display: none; }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="header">
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-bars" style="font-size:20px;"></i>
                <div class="course-title" id="courseTitle">Loading...</div>
            </div>
            <img src="logo.png" class="kac-logo">
        </header>

        <div class="scroll-area">
            <div class="input-section">
                <div class="notice-text" id="lang-notice">
                    All questions are anonymous.<br>익명으로 접수됩니다.
                </div>
                <textarea class="q-input" id="qInput" placeholder="Type here..."></textarea>
                <div class="action-row">
                    <button class="btn-submit" id="btn-submit-qa" onclick="submitQuestion()">Submit</button>
                </div>
            </div>
            <div class="list-header" id="lang-live">Live Questions</div>
            <div id="qList"></div>
        </div>

        <footer class="footer" id="appFooter">KAC Platform</footer>
    </div>

    <!-- Quiz Waiting Screen (When Teacher is in Quiz Mode but no question active) -->
    <div id="quizWaitingScreen">
        <i class="fa-solid fa-hourglass-half fa-3x" style="color:#aaa; margin-bottom:20px;"></i>
        <h2 id="lang-quiz-wait">퀴즈 대기 중...</h2>
        <p style="color:#666;" id="lang-quiz-sub">강사님이 문제를 준비하고 있습니다.</p>
    </div>

    <!-- Quiz Active Overlay -->
    <div id="quizOverlay">
        <div class="quiz-badge">LIVE QUIZ</div>
        <div class="quiz-msg" id="lang-quiz-active">정답을 선택해주세요.</div>
        
        <div class="quiz-btn-grid" id="quizBtns">
            <button class="quiz-btn" onclick="selectAnswer(1)">1</button>
            <button class="quiz-btn" onclick="selectAnswer(2)">2</button>
            <button class="quiz-btn" onclick="selectAnswer(3)">3</button>
            <button class="quiz-btn" onclick="selectAnswer(4)">4</button>
        </div>
        
        <button class="btn-confirm-quiz" id="btnConfirm" onclick="submitFinalAnswer()">제출 (Submit)</button>
    </div>

    <script src="config.js"></script>
    <script>
        const room = new URLSearchParams(window.location.search).get('room') || 'A';
        const db = firebase.database();
        let selectedChoice = null;
        let currentQuizId = null;
        
        // Multi-language Dictionary
        const LANG = {
            ko: { notice: "익명으로 접수됩니다.", live: "실시간 질문", submit: "등록", quizWait: "퀴즈 대기 중...", quizSub: "문제를 준비 중입니다.", quizActive: "정답을 선택하세요.", quizConfirm: "제출하기" },
            en: { notice: "All questions are anonymous.", live: "Live Questions", submit: "Submit", quizWait: "Waiting for Quiz...", quizSub: "Instructor is preparing.", quizActive: "Select an answer.", quizConfirm: "Confirm Submit" }
        };

        window.onload = () => {
            // 1. Listen Settings (Theme & Language)
            db.ref(`courses/${room}/settings`).on('value', s => {
                const v = s.val() || {};
                if(v.courseName) document.getElementById('courseTitle').innerText = v.courseName;
                if(v.themeColor) document.documentElement.style.setProperty('--theme-color', v.themeColor);
                if(v.footerText) document.getElementById('appFooter').innerHTML = v.footerText.replace(/\n/g, '<br>');
                
                // Language Apply
                const curLang = LANG[v.language || 'ko'];
                document.getElementById('lang-notice').innerHTML = curLang.notice;
                document.getElementById('lang-live').innerText = curLang.live;
                document.getElementById('btn-submit-qa').innerText = curLang.submit;
                document.getElementById('lang-quiz-wait').innerText = curLang.quizWait;
                document.getElementById('lang-quiz-sub').innerText = curLang.quizSub;
                document.getElementById('lang-quiz-active').innerText = curLang.quizActive;
                document.getElementById('btnConfirm').innerText = curLang.quizConfirm;
            });

            // 2. Mode Sync (QA vs Quiz)
            db.ref(`courses/${room}/status/mode`).on('value', s => {
                const mode = s.val();
                if(mode === 'quiz') {
                    document.getElementById('quizWaitingScreen').style.display = 'flex';
                } else {
                    document.getElementById('quizWaitingScreen').style.display = 'none';
                    document.getElementById('quizOverlay').style.display = 'none';
                }
            });

            // 3. Active Quiz Trigger
            db.ref(`courses/${room}/activeQuiz`).on('value', s => {
                const val = s.val();
                if(val && val.id) {
                    currentQuizId = val.id;
                    document.getElementById('quizWaitingScreen').style.display = 'none';
                    document.getElementById('quizOverlay').style.display = 'flex';
                    
                    // Check if already answered
                    if(localStorage.getItem(`quiz_${currentQuizId}`)) {
                        document.getElementById('quizOverlay').innerHTML = `<h2>제출 완료!</h2><i class='fa-solid fa-check-circle fa-3x' style='color:#10b981'></i>`;
                    } else {
                        // Reset UI
                        selectedChoice = null;
                        document.querySelectorAll('.quiz-btn').forEach(b => b.classList.remove('selected'));
                        document.getElementById('btnConfirm').style.display = 'none';
                    }
                } else {
                    // If mode is still quiz but activeQuiz is null -> Back to waiting
                    db.ref(`courses/${room}/status/mode`).once('value', m => {
                        if(m.val() === 'quiz') document.getElementById('quizWaitingScreen').style.display = 'flex';
                    });
                    document.getElementById('quizOverlay').style.display = 'none';
                }
            });

            startDataListener();
        };

        function selectAnswer(n) {
            selectedChoice = n;
            document.querySelectorAll('.quiz-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.quiz-btn')[n-1].classList.add('selected');
            document.getElementById('btnConfirm').style.display = 'block';
        }

        function submitFinalAnswer() {
            if(!selectedChoice || !currentQuizId) return;
            db.ref(`courses/${room}/quiz_answers/${currentQuizId}`).push({
                choice: selectedChoice,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            localStorage.setItem(`quiz_${currentQuizId}`, selectedChoice);
            document.getElementById('quizOverlay').innerHTML = `<h2>제출 완료!</h2><i class='fa-solid fa-check-circle fa-3x' style='color:#10b981'></i>`;
        }

        function startDataListener() {
            db.ref(`courses/${room}/questions`).on('value', s => {
                const d = s.val();
                const div = document.getElementById('qList'); div.innerHTML="";
                if(d) Object.keys(d).reverse().forEach(k => {
                    div.innerHTML += `<div class="q-card" style="padding:15px; margin:10px;">${d[k].text}</div>`;
                });
            });
        }

        function submitQuestion() {
            const t = document.getElementById('qInput').value;
            if(!t) return alert("Empty!");
            db.ref(`courses/${room}/questions`).push({
                text: t, timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            document.getElementById('qInput').value = "";
        }
    </script>
</body>
</html>