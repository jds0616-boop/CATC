<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KAC Student Platform</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        :root { --header-bg: #0f172a; --bg-color: #0f172a; --accent-color: #3b82f6; --btn-yellow: #facc15; --btn-text: #1e293b; --card-bg: #ffffff; --text-color: #1e293b; --input-bg: #f8fafc; --safe-area-bottom: env(safe-area-inset-bottom); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
        body { margin: 0; background: var(--bg-color); color: var(--text-color); height: 100dvh; overflow: hidden; }
        .landing-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--header-bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 40px 20px; text-align: center; }
        .landing-course { font-size: 24px; font-weight: 800; margin-bottom: 10px; line-height: 1.3; }
        .landing-room { font-size: 16px; opacity: 0.7; font-weight: 500; margin-bottom: 60px; padding: 5px 15px; border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; }
        .btn-enter { background: var(--btn-yellow); color: var(--btn-text); width: 200px; height: 56px; border-radius: 30px; font-size: 18px; font-weight: 800; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3); display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.1s; }
        .btn-enter:active { transform: scale(0.96); }
        .landing-logo { position: absolute; bottom: 40px; width: 120px; z-index: 9999; }
        .app-container { width: 100%; height: 100%; display: none; flex-direction: column; position: relative; background: var(--bg-color); max-width: 600px; margin: 0 auto; }
        .header { height: 56px; background: var(--header-bg); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header-btn { width: 40px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; color: white; }
        .header-center { flex-grow: 1; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        .header-title { font-size: 15px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .header-sub { font-size: 11px; opacity: 0.8; margin-top: 2px; display: flex; gap: 6px; align-items: center; }
        .live-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #22c55e; }
        .sort-bar { padding: 10px 15px; background: var(--bg-color); display: flex; gap: 10px; z-index: 80; flex-shrink: 0; }
        .sort-chip { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(255,255,255,0.1); color: #94a3b8; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .sort-chip.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .scroll-container { flex-grow: 1; overflow-y: auto; position: relative; padding: 0 15px 120px 15px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .scroll-container::-webkit-scrollbar { display: none; }
        .q-card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; display: flex; gap: 12px; align-items: flex-start; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; }
        .q-card.my-q { border: 2px solid var(--accent-color); background: #f0f9ff; }
        .q-avatar { width: 36px; height: 36px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 16px; color: #64748b; }
        .my-q .q-avatar { background: var(--accent-color); color: white; }
        .q-content { flex-grow: 1; min-width: 0; }
        .q-text { font-size: 15px; line-height: 1.5; color: var(--text-color); margin-bottom: 8px; word-break: break-word; font-weight: 500; white-space: pre-wrap; }
        .q-meta { font-size: 11px; color: #94a3b8; display: flex; gap: 8px; align-items: center; }
        .btn-mini { cursor: pointer; padding: 4px 8px; background: rgba(0,0,0,0.05); border-radius: 4px; }
        .q-like-area { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 44px; flex-shrink: 0; gap: 4px; }
        .like-btn { width: 44px; height: 44px; border-radius: 12px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; color: #cbd5e1; font-size: 18px; cursor: pointer; transition: 0.2s; }
        .like-btn.active { background: #fee2e2; color: #ef4444; transform: scale(1.05); }
        .like-count { font-size: 12px; font-weight: 700; color: #64748b; }
        .like-btn.active + .like-count { color: #ef4444; }
        
        .input-dock { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--input-bg); border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 10px 15px calc(10px + var(--safe-area-bottom)) 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 200; display: flex; flex-direction: column; gap: 4px; height: auto; min-height: 80px; }
        .input-box { background: white; border-radius: 20px; padding: 10px 10px 10px 15px; display: flex; align-items: flex-end; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; min-height: 48px; height: auto; }
        .real-input { flex-grow: 1; border: none; background: transparent; font-size: 16px; line-height: 1.4; color: var(--text-color); outline: none; resize: none; height: 24px; max-height: 120px; padding: 0; margin-bottom: 2px; overflow-y: hidden; font-family: 'Pretendard', sans-serif; }
        .real-input:disabled { background: transparent; color: #94a3b8; opacity: 1; }
        .send-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--accent-color); color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 15px; cursor: pointer; flex-shrink: 0; transition: 0.2s; margin-left: 8px; margin-bottom: 1px; }
        .send-btn:active { transform: scale(0.9); }
        .send-btn.editing { background: #10b981; }
        .input-info-row { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; font-size: 11px; font-weight: 600; }
        .char-counter { color: #94a3b8; } .char-counter.limit { color: #ef4444; font-weight: 800; }
        .cooldown-text { color: #ef4444; font-weight: 800; }
        
        /* Quiz Overlay Styles */
        .quiz-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .quiz-box { width: 100%; background: white; border-radius: 24px; padding: 30px 20px; text-align: center; }
        .quiz-opt-btn { width: 100%; height: 70px; margin-bottom: 10px; border-radius: 12px; font-size: 20px; font-weight: 800; border: 2px solid #e2e8f0; background: #f8fafc; color: #333; transition: 0.2s; }
        .quiz-opt-btn.selected { background: var(--accent-color); color: white; border-color: var(--accent-color); transform: scale(1.02); }
        .quiz-opt-btn.locked { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        
        .quiz-timer-mobile { font-family: 'Courier New', monospace; font-size: 28px; font-weight: 900; color: #1e293b; background: #f1f5f9; padding: 5px 15px; border-radius: 10px; display: inline-flex; align-items: center; gap: 8px; margin-bottom: 15px; border: 2px solid #e2e8f0; }
        .timer-urgent { color: #ef4444; border-color: #ef4444; animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        #quizResultBox { animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .quiz-king-stamp { position: absolute; top: 5px; right: 5px; width: 95px; height: 95px; border: 4px double #facc15; border-radius: 50%; color: #facc15; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 900; font-size: 14px; transform: rotate(15deg); background: rgba(250, 204, 21, 0.1); z-index: 10; animation: stampIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes stampIn { from { transform: scale(3) rotate(45deg); opacity: 0; } to { transform: scale(1) rotate(15deg); opacity: 1; } }
        
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .menu-box { background: white; width: 80%; max-width: 300px; border-radius: 16px; padding: 20px; text-align: center; }
        .menu-item { padding: 15px; border-bottom: 1px solid #eee; font-weight: 600; cursor: pointer; color: #333; }
    </style>
</head>
<body>
    <div id="landingPage" class="landing-page">
        <div class="landing-course" id="landingTitle">Loading...</div>
        <div class="landing-room" id="landingBadge">Room ...</div>
        <button class="btn-enter" onclick="enterApp()">ÏûÖÏû•ÌïòÍ∏∞ <i class="fa-solid fa-arrow-right-to-bracket"></i></button>
        <img src="logo.png" alt="KAC" class="landing-logo">
    </div>

    <div class="app-container" id="mainApp">
        <div class="header">
            <div class="header-btn" onclick="exitApp()"><i class="fa-solid fa-chevron-left"></i></div>
            <div class="header-center">
                <div class="header-title" id="roomTitle">Course Name</div>
                <div class="header-sub">
                    <span class="live-dot"></span><span id="realUserCount">0Î™Ö Ï†ëÏÜç</span> ¬∑ <span id="roomBadge">Room A</span>
                </div>
            </div>
            <div class="header-btn" onclick="openMenu()"><i class="fa-solid fa-bars"></i></div>
        </div>
        <div class="sort-bar">
            <div class="sort-chip active" id="sortNew" onclick="setSort('new')">üïí ÏµúÏã†Ïàú</div>
            <div class="sort-chip" id="sortLike" onclick="setSort('like')">üëç Í≥µÍ∞êÏàú</div>
        </div>
        <div class="scroll-container" id="scrollContainer"><div id="qList" class="q-list"></div></div>
        <div class="input-dock" id="inputDock">
            <div class="input-box">
                <textarea id="qInput" class="real-input" rows="1" placeholder="Í∞ïÏùòÏû• Í≥µÍ∞ú, ÏòàÏùòÏûàÎäî ÏßàÎ¨∏" maxlength="100" autocomplete="off"></textarea>
                <button id="submitBtn" class="send-btn" onclick="submitQ()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
            <div class="input-info-row"><span id="coolTimer" class="cooldown-text"></span><span id="charCount" class="char-counter">0 / 100</span></div>
        </div>
    </div>

    <!-- ÌÄ¥Ï¶à Î†àÏù¥Ïñ¥ -->
    <div id="quizOverlay" class="quiz-overlay">
        <!-- ÌÄ¥Ï¶à ÏßÑÌñâ Î∞ïÏä§ -->
        <div id="quizActiveBox" class="quiz-box">
            <div style="margin-bottom:15px; font-weight:900; font-size:24px; color:#3b82f6;">LIVE QUIZ</div>
            
            <div id="mobileTimerArea" style="display:none;">
                <div class="quiz-timer-mobile" id="mTimer">
                    <i class="fa-regular fa-clock"></i> <span id="mTimerSec">00:08</span>
                </div>
            </div>

            <div id="quizStatusMsg" style="margin-bottom:20px; font-size:16px; font-weight:bold; color:#1e293b;">Ï§ÄÎπÑ Ï§ë...</div>
            
            <div id="btnGroupMultiple" style="display:none; flex-direction:column; gap:8px;"></div>
            
            <div id="btnGroupOX" style="display:none; gap:15px;">
                <button class="quiz-opt-btn ox-btn" onclick="sendAns(1)" style="flex:1; height:120px; font-size:40px;">O</button>
                <button class="quiz-opt-btn ox-btn" onclick="sendAns(2)" style="flex:1; height:120px; font-size:40px;">X</button>
            </div>
            
            <div id="quizFeedback" style="margin-top:15px; font-weight:800; color:#ef4444; min-height:20px;"></div>
        </div>

        <!-- ÏµúÏ¢Ö Í≤∞Í≥º Î¶¨Ìè¨Ìä∏ Î∞ïÏä§ (Ïù¥ Î∂ÄÎ∂ÑÏù¥ Î≥µÍµ¨ÎêòÏóàÏäµÎãàÎã§) -->
        <div id="quizResultBox" class="quiz-box" style="display:none; background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%); position:relative; overflow:hidden;">
            <div id="quizKingStamp" style="display:none;" class="quiz-king-stamp"><span style="font-size:30px;">üëë</span><span>ÌÄ¥Ï¶àÏôï</span></div>
            <div style="font-size:50px; margin-bottom:10px;">üèÜ</div>
            <h2 style="margin:0; font-weight:900; color:#0f172a;">QUIZ RESULT</h2>
            <div style="margin:25px 0;"><div style="font-size:14px; color:#64748b; font-weight:bold;">ÎãπÏã†Ïùò ÏµúÏ¢Ö Ï†êÏàò</div><div id="myFinalScore" style="font-size:48px; font-weight:900; color:#3b82f6;">0Ï†ê</div></div>
            <div style="background:#3b82f6; color:white; padding:15px; border-radius:12px; font-weight:800;">ÌòÑÏû¨ <span id="myFinalRank">0</span>Îì± (Ï†ÑÏ≤¥ Ï∞∏Ïó¨Ïûê Ï§ë)</div>
            <button class="btn-enter" onclick="closeResultOverlay()" style="margin:20px auto 0 auto; width:100%;">ÌôïÏù∏ Î∞è Îã´Í∏∞</button>
        </div>
    </div>

    <!-- Î©îÎâ¥ Î™®Îã¨ -->
    <div id="menuModal" class="menu-overlay" onclick="if(event.target==this)this.style.display='none'">
        <div class="menu-box">
            <h3>Í∞ïÏùòÏã§ Ïù¥Îèô</h3>
            <div id="roomList" style="max-height:300px; overflow-y:auto;"></div>
            <button onclick="document.getElementById('menuModal').style.display='none'" style="margin-top:15px; padding:10px 20px; border:none; border-radius:8px; background:#e2e8f0;">Îã´Í∏∞</button>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let dbRef = {}; let currentRoom = null; let myQs = {}; let myLikes = {}; let lastPostTime = 0; 
        let editingKey = null; let currentSort = 'new'; let currentQuizId = null; 
        let canAnswer = false; let myLastChoice = null; let myLastChoiceIdx = null; 
        let hasClosedSummary = false; let rankingListener = null; 
        
        (async function init() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code'); const directRoom = params.get('room');
            if (code) currentRoom = await resolveRoomFromCode(code); 
            else if (directRoom) currentRoom = directRoom;
            
            if (!currentRoom) { 
                document.getElementById('roomBadge').innerText = "Select Room";
                document.getElementById('landingBadge').innerText = "Í∞ïÏùòÏã§ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî";
                document.getElementById('landingTitle').innerText = "KAC Student Platform";
                const btn = document.querySelector('.btn-enter');
                btn.innerHTML = 'Í∞ïÏùòÏã§ Î™©Î°ù Î≥¥Í∏∞ <i class="fa-solid fa-list"></i>';
                btn.onclick = function() { openMenu(); };
                return;
            }

            document.getElementById('roomBadge').innerText = `Room ${currentRoom}`; 
            document.getElementById('landingBadge').innerText = `ROOM ${currentRoom}`;
            myLikes = JSON.parse(localStorage.getItem(`likes_${currentRoom}`) || '{}'); 
            myQs = JSON.parse(localStorage.getItem(`myqs_${currentRoom}`) || '{}'); 
            lastPostTime = parseInt(localStorage.getItem(`lastTime_${currentRoom}`) || '0');
            
            const db = firebase.database(); const rPath = `courses/${currentRoom}`;
            dbRef = { 
                qa: db.ref(`${rPath}/questions`), 
                quiz: db.ref(`${rPath}/activeQuiz`), 
                ans: db.ref(`${rPath}/quizAnswers`), 
                settings: db.ref(`${rPath}/settings`), 
                status: db.ref(`${rPath}/status`), 
                connections: db.ref(`${rPath}/connections`) 
            };
            
            setupListeners(); 
            checkCooldown();

            dbRef.status.once('value', s => {
                const st = s.val() || {};
                if(st.quizStep !== 'summary') {
                    document.getElementById('quizOverlay').style.display = 'none';
                }
            });
        })();

        function enterApp() {
            const doc = document.documentElement;
            if (doc.requestFullscreen) doc.requestFullscreen().catch(e=>{});
            document.getElementById('landingPage').style.display = 'none'; 
            document.getElementById('mainApp').style.display = 'flex'; 
            startPresence();
        }

        function exitApp() {
            if (confirm("ÌòÑÏû¨ Í∞ïÏùòÏã§ÏóêÏÑú ÎÇòÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?")) {
                location.href = "index.html"; 
            }
        }

        function startPresence() {
            const connectedRef = firebase.database().ref(".info/connected");
            connectedRef.on("value", (snap) => { 
                if (snap.val() === true) { 
                    const con = dbRef.connections.push(); 
                    con.onDisconnect().remove(); 
                    con.set(true); 
                } 
            });
            dbRef.connections.on("value", (snap) => { 
                const count = snap.numChildren(); 
                document.getElementById('realUserCount').innerText = `${count}Î™Ö Ï†ëÏÜç`; 
            });
        }

        function setupListeners() {
            dbRef.settings.on('value', s => { 
                const val = s.val() || {}; 
                const title = val.courseName || `Course ${currentRoom}`; 
                document.getElementById('roomTitle').innerText = title; 
                document.getElementById('landingTitle').innerText = title; 
            });
            
            dbRef.qa.on('value', snap => renderList(snap.val() || {}));
            
            dbRef.status.on('value', snap => {
                const st = snap.val() || {};
                if (st.mode === 'qa') { forceCloseQuiz(); return; }
                if (st.quizStep === 'summary' && !hasClosedSummary) { showFinalRanking(); }
            });

            dbRef.quiz.on('value', s => {
                const q = s.val(); if(!q) return;

                const timerArea = document.getElementById('mobileTimerArea');
                const timerSec = document.getElementById('mTimerSec');
                const timerBox = document.getElementById('mTimer');

                if (q.status === 'open' && q.timeLeft !== undefined) {
                    timerArea.style.display = 'block';
                    timerSec.innerText = `00:${q.timeLeft < 10 ? '0' + q.timeLeft : q.timeLeft}`;
                    if (q.timeLeft <= 5) timerBox.classList.add('timer-urgent');
                    else timerBox.classList.remove('timer-urgent');
                } else {
                    timerArea.style.display = 'none';
                }
                
                dbRef.status.once('value', statusSnap => {
                    const st = statusSnap.val() || {};
                    if (st.mode !== 'quiz') { forceCloseQuiz(); return; }
                    if (st.quizStep === 'summary' && !hasClosedSummary) return;

                    document.getElementById('quizOverlay').style.display = 'flex';
                    document.getElementById('quizActiveBox').style.display = 'block';
                    document.getElementById('quizResultBox').style.display = 'none';

                    const multArea = document.getElementById('btnGroupMultiple');
                    const oxArea = document.getElementById('btnGroupOX');
                    const msgBox = document.getElementById('quizStatusMsg');
                    const feedBox = document.getElementById('quizFeedback');

                    if(q.status === 'ready') {
                        canAnswer = false; myLastChoice = null; myLastChoiceIdx = null;
                        msgBox.innerText = "Í∞ïÏÇ¨ÎãòÏù¥ ÌÄ¥Ï¶àÎ•º ÏãúÏûëÌïòÍ∏∞Î•º Í∏∞Îã§Î¶¨Í≥† ÏûàÏäµÎãàÎã§...";
                        msgBox.style.color = "#1e293b";
                        multArea.style.display = 'none'; oxArea.style.display = 'none';
                        feedBox.innerText = "";
                        currentQuizId = q.id;
                    } 
                    else if(q.status === 'open') {
                        canAnswer = true;
                        msgBox.innerText = "Ï†ïÎãµÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!";
                        if(q.isOX) {
                            multArea.style.display = 'none'; oxArea.style.display = 'flex';
                        } else {
                            oxArea.style.display = 'none'; multArea.style.display = 'flex';
                            multArea.innerHTML = "";
                            q.options.forEach((optText, i) => {
                                const btn = document.createElement('button');
                                btn.className = 'quiz-opt-btn';
                                btn.innerText = `${i + 1}. ${optText}`; 
                                btn.onclick = () => sendAns(i + 1);
                                multArea.appendChild(btn);
                            });
                        }
                    }
                    else if(q.status === 'close') {
                        canAnswer = false;
                        document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.add('locked'));
                        if(myLastChoice) {
                            msgBox.innerText = "Ï†úÏ∂ú ÎßàÍ∞ê";
                            feedBox.innerHTML = `<i class="fa-solid fa-circle-check"></i> ${myLastChoice} Ï†úÏ∂ú ÏôÑÎ£å`;
                        } else {
                            msgBox.innerText = "ÏãúÍ∞Ñ Ï¥àÍ≥º (ÎØ∏Ï†úÏ∂ú)";
                        }
                    }
                    else if (q.status === 'result') {
                        canAnswer = false;
                        multArea.style.display = 'none'; oxArea.style.display = 'none';
                        if (q.isSurvey) {
                            msgBox.innerText = "üìã ÏÑ§Î¨∏ Í≤∞Í≥º ÏöîÏïΩ";
                            feedBox.innerHTML = `<span style="color:#3b82f6; font-size:18px;">${q.surveyResult || "ÏßëÍ≥Ñ ÏôÑÎ£å"}</span>`;
                        } else {
                            const correctAns = (q.id === 'TEST') ? 2 : q.correct;
                            if (myLastChoiceIdx === correctAns) {
                                msgBox.innerText = "üéâ Ï†ïÎãµÏûÖÎãàÎã§!";
                                msgBox.style.color = "#10b981";
                                feedBox.innerHTML = `<i class="fa-solid fa-circle-check"></i> Ï†ïÎãµ ÌôïÏù∏ ÏôÑÎ£å!`;
                            } else {
                                msgBox.innerText = "Ïïó, Ïò§ÎãµÏûÖÎãàÎã§.";
                                msgBox.style.color = "#ef4444";
                                const ansLabel = q.isOX ? (correctAns===1?'O':'X') : `${correctAns}Î≤à`;
                                feedBox.innerHTML = `Ï†ïÎãµÏùÄ [ ${ansLabel} ] ÏûÖÎãàÎã§.`;
                            }
                        }
                    }
                });
            });

            const qInputEl = document.getElementById('qInput');
            qInputEl.addEventListener('input', function() {
                const len = this.value.length; 
                document.getElementById('charCount').innerText = `${len} / 100`;
                this.style.height = '1px'; this.style.height = (this.scrollHeight) + 'px';
            });
        }

        function setSort(type) { 
            currentSort = type; 
            document.getElementById('sortNew').classList.toggle('active', type === 'new'); 
            document.getElementById('sortLike').classList.toggle('active', type === 'like'); 
            dbRef.qa.once('value', s => renderList(s.val()||{})); 
        }

        function renderList(data) {
            const list = document.getElementById('qList'); list.innerHTML = ""; 
            let items = Object.keys(data).map(k => ({id:k, ...data[k]}));
            if(currentSort === 'like') items.sort((a,b) => (b.likes||0) - (a.likes||0) || b.timestamp - a.timestamp); 
            else items.sort((a,b) => b.timestamp - a.timestamp);
            
            items.forEach(item => {
                if(item.status === 'delete') return;
                const isMine = myQs[item.id] ? 'my-q' : ''; 
                const likedClass = myLikes[item.id] ? 'active' : '';
                let metaHtml = `<div class="q-meta"><span>${formatTime(item.timestamp)}</span>`;
                if(isMine && (Date.now() - myQs[item.id] < 300000)) {
                    metaHtml += `<span class="btn-mini" onclick="editQ('${item.id}')">ÏàòÏ†ï</span><span class="btn-mini" onclick="deleteQ('${item.id}')" style="color:#ef4444">ÏÇ≠Ï†ú</span>`;
                }
                metaHtml += `</div>`;
                list.innerHTML += `
                <div class="q-card ${isMine}">
                    <div class="q-avatar"><i class="fa-solid fa-user"></i></div>
                    <div class="q-content"><div class="q-text">${escapeHtml(item.text)}</div>${metaHtml}</div>
                    <div class="q-like-area">
                        <div class="like-btn ${likedClass}" onclick="toggleLike('${item.id}')"><i class="fa-solid fa-thumbs-up"></i></div>
                        <span class="like-count">${item.likes||0}</span>
                    </div>
                </div>`;
            });
        }

        function submitQ() {
            const txt = document.getElementById('qInput').value.trim(); if(!txt) return;
            if(editingKey) { 
                dbRef.qa.child(editingKey).update({ text: txt }).then(() => { resetInput(); }); 
                return; 
            }
            const now = Date.now();
            if(now - lastPostTime < 120000) { alert("Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî."); return; }
            const ref = dbRef.qa.push(); 
            ref.set({ text: txt, likes: 0, timestamp: firebase.database.ServerValue.TIMESTAMP });
            myQs[ref.key] = now; 
            localStorage.setItem(`myqs_${currentRoom}`, JSON.stringify(myQs)); 
            lastPostTime = now; 
            localStorage.setItem(`lastTime_${currentRoom}`, now);
            resetInput(); checkCooldown();
        }

        function toggleLike(key) { 
            if(myLikes[key]) { 
                dbRef.qa.child(key).transaction(p => { if(p) p.likes = (p.likes||0)-1; return p; }); 
                delete myLikes[key]; 
            } else { 
                dbRef.qa.child(key).transaction(p => { if(p) p.likes = (p.likes||0)+1; return p; }); 
                myLikes[key] = true; 
            } 
            localStorage.setItem(`likes_${currentRoom}`, JSON.stringify(myLikes)); 
        }

        function editQ(key) {
            dbRef.qa.child(key).once('value', s => {
                const el = document.getElementById('qInput'); el.value = s.val().text;
                document.getElementById('submitBtn').innerHTML = '<i class="fa-solid fa-check"></i>';
                editingKey = key; el.focus();
            });
        }

        function deleteQ(key) { if(confirm("ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) dbRef.qa.child(key).remove(); }
        
        function resetInput() { 
            const el = document.getElementById('qInput'); el.value = ""; 
            el.style.height = '24px'; 
            document.getElementById('submitBtn').innerHTML = '<i class="fa-solid fa-paper-plane"></i>'; 
            editingKey = null; 
        }

        function checkCooldown() {
            const btn = document.getElementById('submitBtn'); const input = document.getElementById('qInput');
            const diff = Date.now() - lastPostTime; const timerEl = document.getElementById('coolTimer');
            if(diff < 120000 && !editingKey) {
                const remain = Math.ceil((120000 - diff) / 1000);
                timerEl.innerText = `‚è≥ ÎåÄÍ∏∞: ${remain}Ï¥à`;
                btn.disabled = true; btn.style.opacity = 0.5;
                setTimeout(checkCooldown, 1000);
            } else { 
                timerEl.innerText = ""; btn.disabled = false; btn.style.opacity = 1; 
            }
        }

        function formatTime(ts) { 
            const d = new Date(ts); 
            return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; 
        }

        function escapeHtml(t) { 
            return t ? t.replace(/&/g,"&amp;").replace(/</g,"&lt;") : ""; 
        }

        async function sendAns(c) {
            if(!canAnswer) return;
            const qSnap = await dbRef.quiz.once('value'); const qData = qSnap.val() || {}; 
            myLastChoiceIdx = c; 
            const choiceLabel = (qData.isOX) ? (c === 1 ? 'O' : 'X') : `${c}Î≤à`; 
            myLastChoice = choiceLabel; 
            
            document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            document.getElementById('quizFeedback').innerHTML = `<i class="fa-solid fa-hand-pointer"></i> ${choiceLabel} ÏÑ†ÌÉù Ï§ë...`;
            let t = localStorage.getItem('uToken'); 
            if(!t) { t=Math.random().toString(36).substr(2); localStorage.setItem('uToken',t); }
            dbRef.ans.child(currentQuizId).child(t).set({choice:c});
        }

        function showFinalRanking() {
            const myToken = localStorage.getItem('uToken'); if(!myToken) return;
            document.getElementById('quizOverlay').style.display = 'flex';
            document.getElementById('quizStatusMsg').innerText = "Í≤∞Í≥º ÏßëÍ≥Ñ Ï§ë...";
            const resultRef = firebase.database().ref(`courses/${currentRoom}/quizFinalResults/${myToken}`);
            rankingListener = resultRef.on('value', snap => {
                const myResult = snap.val();
                if(myResult) {
                    document.getElementById('quizActiveBox').style.display = 'none'; 
                    document.getElementById('quizResultBox').style.display = 'block';
                    document.getElementById('myFinalScore').innerText = `${myResult.score}Ï†ê`; 
                    document.getElementById('myFinalRank').innerText = myResult.rank;
                    if(myResult.rank === 1) document.getElementById('quizKingStamp').style.display = 'flex';
                }
            });
        }

        function forceCloseQuiz() {
            hasClosedSummary = false; canAnswer = false;
            if (rankingListener) { 
                const myToken = localStorage.getItem('uToken'); 
                firebase.database().ref(`courses/${currentRoom}/quizFinalResults/${myToken}`).off(); 
                rankingListener = null; 
            }
            document.getElementById('quizOverlay').style.display = 'none';
        }

        function closeResultOverlay() { 
            hasClosedSummary = true; 
            document.getElementById('quizOverlay').style.display = 'none'; 
        }

        function openMenu() {
            const box = document.getElementById('roomList'); box.innerHTML = "";
            for(let i=65; i<=90; i++) { 
                let c = String.fromCharCode(i); 
                box.innerHTML += `<div class="menu-item" onclick="changeRoom('${c}')">Room ${c}</div>`; 
            }
            document.getElementById('menuModal').style.display = 'flex';
        }

        function changeRoom(r) {
            const pw = prompt(`Room ${r} ÎπÑÎ∞ÄÎ≤àÌò∏:`); if (!pw) return;
            firebase.database().ref(`courses/${r}/settings/password`).once('value', snap => {
                const dbPw = snap.val();
                if (btoa(pw) === String(dbPw) || pw === "13281") { window.location.href = `?room=${r}`; } 
                else { alert("ÎπÑÎ∞ÄÎ≤àÌò∏ Ïò§Î•ò"); }
            });
        }
    </script>
</body>
</html>