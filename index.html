<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KAC Student Platform</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        :root { --header-bg: #0f172a; --bg-color: #0f172a; --accent-color: #3b82f6; --btn-yellow: #facc15; --btn-text: #1e293b; --card-bg: #ffffff; --text-color: #1e293b; --input-bg: #f8fafc; --safe-area-bottom: env(safe-area-inset-bottom); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
        body { margin: 0; background: var(--bg-color); color: var(--text-color); height: 100dvh; overflow: hidden; }
        .landing-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--header-bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 40px 20px; text-align: center; }
        .landing-course { font-size: 24px; font-weight: 800; margin-bottom: 10px; line-height: 1.3; }
        .landing-room { font-size: 16px; opacity: 0.7; font-weight: 500; margin-bottom: 60px; padding: 5px 15px; border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; }
        .btn-enter { background: var(--btn-yellow); color: var(--btn-text); width: 200px; height: 56px; border-radius: 30px; font-size: 18px; font-weight: 800; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3); display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.1s; }
        .btn-enter:active { transform: scale(0.96); }
        .landing-logo { position: absolute; bottom: 40px; width: 120px; z-index: 9999; }
        .app-container { width: 100%; height: 100%; display: none; flex-direction: column; position: relative; background: var(--bg-color); max-width: 600px; margin: 0 auto; }
        .header { height: 56px; background: var(--header-bg); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header-btn { width: 40px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; color: white; }
        .header-center { flex-grow: 1; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        .header-title { font-size: 15px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .header-sub { font-size: 11px; opacity: 0.8; margin-top: 2px; display: flex; gap: 6px; align-items: center; }
        .live-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #22c55e; }
        .sort-bar { padding: 10px 15px; background: var(--bg-color); display: flex; gap: 10px; z-index: 80; flex-shrink: 0; }
        .sort-chip { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(255,255,255,0.1); color: #94a3b8; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .sort-chip.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .scroll-container { flex-grow: 1; overflow-y: auto; position: relative; padding: 0 15px 120px 15px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .scroll-container::-webkit-scrollbar { display: none; }
        .q-card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; display: flex; gap: 12px; align-items: flex-start; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; }
        .q-card.my-q { border: 2px solid var(--accent-color); background: #f0f9ff; }
        .q-avatar { width: 36px; height: 36px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 16px; color: #64748b; }
        .my-q .q-avatar { background: var(--accent-color); color: white; }
        .q-content { flex-grow: 1; min-width: 0; }
        .q-text { font-size: 15px; line-height: 1.5; color: var(--text-color); margin-bottom: 8px; word-break: break-word; font-weight: 500; white-space: pre-wrap; }
        .q-meta { font-size: 11px; color: #94a3b8; display: flex; gap: 8px; align-items: center; }
        .btn-mini { cursor: pointer; padding: 4px 8px; background: rgba(0,0,0,0.05); border-radius: 4px; }
        .q-like-area { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 44px; flex-shrink: 0; gap: 4px; }
        .like-btn { width: 44px; height: 44px; border-radius: 12px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; color: #cbd5e1; font-size: 18px; cursor: pointer; transition: 0.2s; }
        .like-btn.active { background: #fee2e2; color: #ef4444; transform: scale(1.05); }
        .like-count { font-size: 12px; font-weight: 700; color: #64748b; }
        .like-btn.active + .like-count { color: #ef4444; }
        
        .input-dock { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--input-bg); border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 10px 15px calc(10px + var(--safe-area-bottom)) 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 200; display: flex; flex-direction: column; gap: 4px; height: auto; min-height: 80px; }
        .input-box { background: white; border-radius: 20px; padding: 10px 10px 10px 15px; display: flex; align-items: flex-end; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; min-height: 48px; height: auto; }
        .real-input { flex-grow: 1; border: none; background: transparent; font-size: 16px; line-height: 1.4; color: var(--text-color); outline: none; resize: none; height: 24px; max-height: 120px; padding: 0; margin-bottom: 2px; overflow-y: hidden; font-family: 'Pretendard', sans-serif; }
        .real-input::placeholder { color: rgba(239, 68, 68, 0.6); font-weight: 700; font-style: italic; font-size: 14px; }
        .send-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--accent-color); color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 15px; cursor: pointer; flex-shrink: 0; transition: 0.2s; margin-left: 8px; margin-bottom: 1px; }
        .quiz-opt-btn.selected { background: var(--accent-color); color: white; border-color: var(--accent-color); transform: scale(1.02); }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .menu-box { background: white; width: 80%; max-width: 300px; border-radius: 16px; padding: 20px; text-align: center; }
        .menu-item { padding: 15px; border-bottom: 1px solid #eee; font-weight: 600; cursor: pointer; color: #333; }
    </style>
</head>
<body>

<!-- ë³¸ì¸ í™•ì¸ íŒì—… -->
<div id="profileOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,42,0.95); z-index:10000; flex-direction:column; align-items:center; justify-content:center; color:white; padding:20px; text-align:center;">
    <div style="background:white; color:#1e293b; padding:30px 20px; border-radius:24px; width:100%; max-width:350px;">
        <h2 style="margin:0 0 10px 0; font-weight:900;">ë³¸ì¸ í™•ì¸</h2>
        <p style="font-size:14px; color:#64748b; margin-bottom:25px;">ì›í™œí•œ êµìœ¡ í–‰ì • ì„œë¹„ìŠ¤ë¥¼ ìœ„í•´<br>ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        <input type="text" id="userName" placeholder="ì„±í•¨ ì…ë ¥" style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:12px; font-size:18px; margin-bottom:12px; text-align:center;">
        <input type="number" id="userPhone" placeholder="ì „í™”ë²ˆí˜¸ ë’· 4ìë¦¬" style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:12px; font-size:18px; margin-bottom:20px; text-align:center;">
        <button onclick="saveProfile()" style="width:100%; padding:15px; background:#3b82f6; color:white; border:none; border-radius:12px; font-size:18px; font-weight:bold;">ì…ì¥ ì™„ë£Œ</button>
    </div>
</div>

<!-- ëœë”© í˜ì´ì§€ -->
<div id="landingPage" class="landing-page">
    <div class="landing-course" id="landingTitle">Loading...</div>
    <div class="landing-room" id="landingBadge">Room ...</div>
    <button class="btn-enter" onclick="enterApp()">ì…ì¥í•˜ê¸° <i class="fa-solid fa-arrow-right-to-bracket"></i></button>
    <img src="logo.png" alt="KAC" class="landing-logo">
</div>

<!-- ì•± ë©”ì¸ í™”ë©´ -->
<div class="app-container" id="mainApp">
    <div class="header">
        <div class="header-btn" onclick="exitApp()"><i class="fa-solid fa-chevron-left"></i></div>
        <div class="header-center"><div class="header-title" id="roomTitle">Course Name</div><div class="header-sub"><span class="live-dot"></span><span id="realUserCount">0ëª… ì ‘ì†</span> Â· <span id="roomBadge">Room A</span></div></div>
        <div class="header-btn" onclick="document.getElementById('menuModal').style.display='flex'"><i class="fa-solid fa-bars"></i></div>
    </div>
    <div class="sort-bar">
        <div class="sort-chip active" id="sortNew" onclick="setSort('new')">ğŸ•’ ìµœì‹ ìˆœ</div>
        <div class="sort-chip" id="sortLike" onclick="setSort('like')">ğŸ‘ ê³µê°ìˆœ</div>
    </div>
    <div class="scroll-container" id="scrollContainer"><div id="qList" class="q-list"></div></div>
    <div class="input-dock" id="inputDock">
        <div class="input-box">
            <textarea id="qInput" class="real-input" rows="1" placeholder="âœ ì§ˆë¬¸ ì…ë ¥ (ë¬´ë¡€í•œ í‘œí˜„ì€ ì‚¼ê°€ì£¼ì„¸ìš”)" maxlength="100"></textarea>
            <button id="submitBtn" class="send-btn" onclick="submitQ()"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
        <div class="input-info-row"><span id="coolTimer" class="cooldown-text"></span><span id="charCount" class="char-counter">0 / 100</span></div>
    </div>
</div>

<!-- í€´ì¦ˆ ì˜¤ë²„ë ˆì´ -->
<div id="quizOverlay" class="quiz-overlay">
    <div id="quizActiveBox" class="quiz-box">
        <div style="margin-bottom:20px; font-weight:900; font-size:24px; color:#3b82f6;">LIVE QUIZ</div>
        <div id="studentQuizTimerBox" style="display:none; justify-content:center; align-items:center; gap:10px; margin-bottom:15px;">
            <i class="fa-regular fa-clock" style="color:#64748b; font-size:20px;"></i>
            <div id="studentTimer" style="font-family: monospace; font-size:30px; font-weight:900; color:#1e293b;">00:08</div>
        </div>
        <div id="quizStatusMsg" style="margin-bottom:20px; font-size:16px; font-weight:bold; color:#1e293b;">ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
        <div id="btnGroupMultiple" style="display:none; flex-direction:column; gap:5px;"></div>
        <div id="btnGroupOX" style="display:none; gap:15px;">
            <button class="quiz-opt-btn ox-btn" onclick="sendAns(1)" style="flex:1; height:120px; font-size:40px;">O</button>
            <button class="quiz-opt-btn ox-btn" onclick="sendAns(2)" style="flex:1; height:120px; font-size:40px;">X</button>
        </div>
        <div id="quizFeedback" style="margin-top:15px; font-weight:800; color:#ef4444; min-height:20px;"></div>
    </div>
    <div id="quizResultBox" class="quiz-box" style="display:none; position:relative; overflow:hidden;">
        <div id="quizKingStamp" style="display:none;" class="quiz-king-stamp"><span style="font-size:30px;">ğŸ‘‘</span><span>í€´ì¦ˆì™•</span></div>
        <h2 style="margin:0; font-weight:900; color:#0f172a;">QUIZ RESULT</h2>
        <div id="myFinalScore" style="font-size:48px; font-weight:900; color:#3b82f6; margin:20px 0;">0ì </div>
        <div style="background:#3b82f6; color:white; padding:15px; border-radius:12px; font-weight:800;">í˜„ì¬ <span id="myFinalRank">0</span>ë“±</div>
        <button class="btn-enter" onclick="closeResultOverlay()" style="margin:20px auto 0 auto; width:100%;">ë‹«ê¸°</button>
    </div>
</div>

<!-- ë©”ë‰´ ëª¨ë‹¬ -->
<div id="menuModal" class="menu-overlay" onclick="if(event.target==this)this.style.display='none'">
    <div class="menu-box">
        <h3 id="menuTitle">Menu</h3>
        <div id="mainMenuItems">
            <div class="menu-item" style="opacity:0.5; color:#999;"><i class="fa-solid fa-bullhorn"></i> ê³µì§€ì‚¬í•­(ì¤€ë¹„ì¤‘)</div>
            <div class="menu-item" onclick="viewMealMenu()"><i class="fa-solid fa-utensils"></i> ê¸ˆì£¼ ì‹ë‹¨ë³´ê¸°</div>
            <div class="menu-item" onclick="openShuttleApply()"><i class="fa-solid fa-bus"></i> ì°¨ëŸ‰ ì‹ ì²­</div>
            <div class="menu-item" onclick="openAdminAction()"><i class="fa-solid fa-file-signature"></i> ì™¸ì¶œÂ·ì™¸ë°• / ì„ì‹ì œì™¸</div>
            <div class="menu-item" onclick="showRoomList()"><i class="fa-solid fa-door-open"></i> ê°•ì˜ì‹¤ ì´ë™</div>
        </div>
        <div id="roomSelectionItems" style="display:none; max-height: 400px; overflow-y: auto; background: #f8fafc; border-radius: 12px; padding: 5px;">
            <div id="roomList"></div>
        </div>
        <button id="menuBackButton" onclick="toggleMenuView('main')" style="display:none; margin-top:15px; width:100%; padding:12px; border:none; border-radius:8px; background:#3b82f6; color:white; font-weight:bold;">ì´ì „ìœ¼ë¡œ</button>
        <button onclick="document.getElementById('menuModal').style.display='none'; toggleMenuView('main');" style="margin-top:10px; width:100%; padding:12px; border:none; border-radius:8px; background:#e2e8f0; font-weight:bold;">ë‹«ê¸°</button>
    </div>
</div>

<!-- ì°¨ëŸ‰ ì‹ ì²­ ëª¨ë‹¬ -->
<div id="shuttleModal" class="menu-overlay" style="display:none; z-index: 7000;">
    <div class="menu-box" style="width:90%; padding: 25px 20px; border-radius: 20px;">
        <h3>ì°¨ëŸ‰ íƒ‘ìŠ¹ ì‹ ì²­</h3>
        <div id="shuttleCancelArea" style="display:none; background: #fff1f2; padding: 15px; border-radius: 12px; border: 1px solid #fda4af; margin-bottom: 20px;">
            <p id="myCurrentShuttle" style="font-weight: 900; color: #1e293b;"></p>
            <button onclick="cancelShuttleRequest()" style="width: 100%; padding: 10px; background: #e11d48; color: white; border: none; border-radius: 8px; font-weight: bold;">ì‹ ì²­ ì·¨ì†Œ</button>
        </div>
        <div id="shuttleButtons" style="display:flex; flex-direction:column; gap:10px;">
            <button class="quiz-opt-btn" onclick="selectShuttle('osong', 'ì˜¤ì†¡ì—­')">ì˜¤ì†¡ì—­</button>
            <button class="quiz-opt-btn" onclick="selectShuttle('terminal', 'ì²­ì£¼í„°ë¯¸ë„')">ì²­ì£¼í„°ë¯¸ë„</button>
            <button class="quiz-opt-btn" onclick="selectShuttle('airport', 'ì²­ì£¼ê³µí•­')">ì²­ì£¼ê³µí•­</button>
        </div>
        <button onclick="document.getElementById('shuttleModal').style.display='none'" style="margin-top:20px; width:100%; padding:10px; background:transparent; color: #94a3b8; text-decoration: underline; font-size: 18px; font-weight: bold;">ë‚˜ê°€ê¸°</button>
    </div>
</div>

<!-- í–‰ì • ì‹ ì²­ ëª¨ë‹¬ -->
<div id="adminActionModal" class="menu-overlay" style="display:none; z-index: 7000;">
    <div class="menu-box" style="width:90%; padding: 25px 20px; border-radius: 20px;">
        <h3>ì¼ì¼ í–‰ì • ì‹ ì²­</h3>
        <div id="adminStatusArea" style="display:none; background: #f0f7ff; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
            <div id="adminStatusText"></div>
            <button onclick="cancelAdminAction()" style="width: 100%; margin-top:10px; padding: 8px; background: #ef4444; color: white; border: none; border-radius: 6px;">ì‹ ì²­ ì·¨ì†Œ</button>
        </div>
        <div id="adminActionForm">
            <div style="text-align:left; margin-bottom:15px;">
                <label><input type="checkbox" id="skipDinner"> ì˜¤ëŠ˜ ì €ë… ì‹ì‚¬ ì œì™¸</label>
            </div>
            <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
                <button class="quiz-opt-btn" id="btn-none" onclick="selectAdminType('none')">í•´ë‹¹ ì—†ìŒ</button>
                <button class="quiz-opt-btn" id="btn-outing" onclick="selectAdminType('outing')">ì™¸ì¶œ</button>
                <button class="quiz-opt-btn" id="btn-overnight" onclick="selectAdminType('overnight')">ì™¸ë°•</button>
            </div>
            <div id="fullPhoneArea" style="display:none; margin-bottom:15px;">
                <input type="tel" id="fullPhone" placeholder="ë¹„ìƒì—°ë½ì²˜ (010-0000-0000)" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd;">
            </div>
            <button onclick="submitAdminAction()" style="width: 100%; padding: 15px; background: #10b981; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold;">ì‹ ì²­ ì™„ë£Œ</button>
        </div>
        <button onclick="document.getElementById('adminActionModal').style.display='none'" style="margin-top:20px; width:100%; padding:10px; background:transparent; color: #94a3b8; text-decoration: underline; font-size: 18px; font-weight: bold;">ë‚˜ê°€ê¸°</button>
    </div>
</div>

<!-- ì‹ë‹¨í‘œ ëª¨ë‹¬ -->
<div id="mealMenuModal" class="menu-overlay" style="display:none; z-index: 8000;" onclick="this.style.display='none'">
    <div style="width:90%; max-width:500px; background:white; border-radius:20px; padding:10px;">
        <img id="mealMenuImage" src="" style="width:100%; border-radius:15px; display:block;">
    </div>
</div>

<script src="config.js"></script>
<script>
    let serverTimeOffset = 0;
    let dbRef = {}; let currentRoom = null; let myQs = {}; let myLikes = {}; let lastPostTime = 0; let editingKey = null; let currentSort = 'new'; let currentQuizId = null; let canAnswer = false; let myLastChoiceIdx = null; let myLastChoice = null; let hasClosedSummary = false; let rankingListener = null; let studentTimerInterval = null; let allQuestionsData = {};

    (async function init() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code'); const directRoom = params.get('room');
        if (code) currentRoom = await resolveRoomFromCode(code); else if (directRoom) currentRoom = directRoom;
        
        if (!currentRoom) { 
            document.getElementById('landingBadge').innerText = "ê°•ì˜ì‹¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”";
            const btn = document.querySelector('.btn-enter');
            btn.innerHTML = 'ê°•ì˜ì‹¤ ëª©ë¡ ë³´ê¸° <i class="fa-solid fa-list"></i>';
            btn.onclick = function() { document.getElementById('menuModal').style.display = 'flex'; showRoomList(); };
            return;
        }

        myLikes = JSON.parse(localStorage.getItem(`likes_${currentRoom}`) || '{}');
        myQs = JSON.parse(localStorage.getItem(`myqs_${currentRoom}`) || '{}'); 
        lastPostTime = parseInt(localStorage.getItem(`lastTime_${currentRoom}`) || '0');

        const db = firebase.database(); const rPath = `courses/${currentRoom}`;
        dbRef = { qa: db.ref(`${rPath}/questions`), quiz: db.ref(`${rPath}/activeQuiz`), ans: db.ref(`${rPath}/quizAnswers`), settings: db.ref(`${rPath}/settings`), status: db.ref(`${rPath}/status`), connections: db.ref(`${rPath}/connections`) };

        setupListeners(); checkCooldown();
    })();

    function setupListeners() {
        firebase.database().ref(".info/serverTimeOffset").on("value", snap => { serverTimeOffset = snap.val() || 0; });
        dbRef.settings.on('value', s => { 
            const val = s.val() || {}; 
            document.getElementById('roomTitle').innerText = val.courseName || `Room ${currentRoom}`; 
            document.getElementById('landingTitle').innerText = val.courseName || "KAC Student Platform";
            document.getElementById('roomBadge').innerText = `Room ${currentRoom}`;
            document.getElementById('landingBadge').innerText = `ROOM ${currentRoom}`;
        });
        
        dbRef.qa.on('value', snap => {
            allQuestionsData = snap.val() || {};
            renderList(allQuestionsData);
        });

        dbRef.status.on('value', snap => {
            const st = snap.val() || {};
            if (st.mode === 'qa') { forceCloseQuiz(); return; }
            if (st.mode === 'quiz' && st.quizStep !== 'summary') {
                document.getElementById('quizOverlay').style.display = 'flex';
                document.getElementById('quizActiveBox').style.display = 'block';
                document.getElementById('quizResultBox').style.display = 'none';
            }
            if (st.quizStep === 'summary' && !hasClosedSummary) showFinalRanking();
        });

        dbRef.quiz.on('value', s => {
            const q = s.val(); if(!q) return;
            if(studentTimerInterval) clearInterval(studentTimerInterval);
            const sTimerBox = document.getElementById('studentQuizTimerBox');
            const sTimerText = document.getElementById('studentTimer');
            sTimerBox.style.display = 'none';

            if (q.status === 'ready') { myLastChoiceIdx = null; myLastChoice = null; }
            
            document.getElementById('quizStatusMsg').innerText = q.status === 'ready' ? "ê°•ì‚¬ë‹˜ì´ í€´ì¦ˆë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤..." : "ì •ë‹µì„ ì„ íƒí•˜ì„¸ìš”!";
            const multArea = document.getElementById('btnGroupMultiple');
            const oxArea = document.getElementById('btnGroupOX');
            
            if(q.status === 'open') {
                canAnswer = true;
                if(q.endTime) {
                    sTimerBox.style.display = 'flex';
                    studentTimerInterval = setInterval(() => {
                        const remain = Math.ceil((q.endTime - (Date.now() + serverTimeOffset)) / 1000);
                        sTimerText.innerText = `00:${remain < 10 ? '0' + remain : remain}`;
                        if(remain <= 0) clearInterval(studentTimerInterval);
                    }, 200);
                }
                if(q.isOX) {
                    multArea.style.display = 'none'; oxArea.style.display = 'flex';
                } else {
                    oxArea.style.display = 'none'; multArea.style.display = 'flex';
                    multArea.innerHTML = "";
                    q.options.forEach((opt, i) => {
                        const btn = document.createElement('button');
                        btn.className = 'quiz-opt-btn'; btn.innerText = `${i+1}. ${opt}`;
                        btn.onclick = () => sendAns(i+1);
                        if((i+1) === myLastChoiceIdx) btn.classList.add('selected');
                        multArea.appendChild(btn);
                    });
                }
            } else if (q.status === 'result') {
                canAnswer = false;
                multArea.style.display = 'none'; oxArea.style.display = 'none';
                document.getElementById('quizStatusMsg').innerText = q.isSurvey ? "ğŸ“‹ ì„¤ë¬¸ ê²°ê³¼ ìš”ì•½" : (myLastChoiceIdx === q.correct ? "ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!" : "ì•—, í‹€ë ¸ìŠµë‹ˆë‹¤!");
            }
        });
    }

    function startPresence() {
        const uToken = localStorage.getItem('uToken');
        if (!uToken || !currentRoom) return;
        const myStatusRef = firebase.database().ref(`courses/${currentRoom}/students/${uToken}/isOnline`);
        firebase.database().ref(".info/connected").on("value", snap => {
            if (snap.val() === true) {
                myStatusRef.set(true);
                myStatusRef.onDisconnect().set(false);
                const con = dbRef.connections.push();
                con.onDisconnect().remove(); con.set(true);
            }
        });
        dbRef.connections.on("value", snap => {
            const count = snap.numChildren();
            if(document.getElementById('realUserCount')) document.getElementById('realUserCount').innerText = `${count}ëª… ì ‘ì†`;
        });
    }

    async function enterApp() { await checkProfile(); }

    function exitApp() {
        if (confirm("í˜„ì¬ ê°•ì˜ì‹¤ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            const ua = navigator.userAgent.toLowerCase();
            if (ua.indexOf('kakaotalk') !== -1) { location.href = 'kakaotalk://inappbrowser/close'; return; }
            if (ua.indexOf('naver') !== -1) { location.href = 'naversearchapp://inappbrowser/close'; return; }
            document.body.innerHTML = "<div style='height:100vh; display:flex; align-items:center; justify-content:center; background:#0f172a; color:white;'>í‡´ì¥ ì™„ë£Œ. ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ì£¼ì„¸ìš”.</div>";
        }
    }

    function setSort(type) {
        currentSort = type;
        document.getElementById('sortNew').classList.toggle('active', type === 'new');
        document.getElementById('sortLike').classList.toggle('active', type === 'like');
        renderList(allQuestionsData);
    }

    function renderList(data) {
        const list = document.getElementById('qList'); list.innerHTML = "";
        let items = Object.keys(data).map(k => ({id:k, ...data[k]}));
        if(currentSort === 'like') items.sort((a,b) => (b.likes||0) - (a.likes||0) || b.timestamp - a.timestamp);
        else items.sort((a,b) => b.timestamp - a.timestamp);
        items.forEach(item => {
            if(item.status === 'delete') return;
            const isMine = myQs[item.id] ? 'my-q' : '';
            const likedClass = myLikes[item.id] ? 'active' : '';
            list.innerHTML += `<div class="q-card ${isMine}"><div class="q-avatar"><i class="fa-solid fa-user"></i></div><div class="q-content"><div class="q-text">${item.text}</div></div><div class="q-like-area"><div class="like-btn ${likedClass}" onclick="toggleLike('${item.id}')"><i class="fa-solid fa-thumbs-up"></i></div><span class="like-count">${item.likes||0}</span></div></div>`;
        });
    }

    function submitQ() {
        const txt = document.getElementById('qInput').value.trim(); if(!txt) return;
        const now = Date.now();
        if(now - lastPostTime < 120000) { alert("ì ì‹œ í›„ ì§ˆë¬¸í•´ì£¼ì„¸ìš”."); return; }
        const ref = dbRef.qa.push();
        ref.set({ text: txt, likes: 0, timestamp: firebase.database.ServerValue.TIMESTAMP });
        myQs[ref.key] = now; localStorage.setItem(`myqs_${currentRoom}`, JSON.stringify(myQs));
        lastPostTime = now; localStorage.setItem(`lastTime_${currentRoom}`, now);
        document.getElementById('qInput').value = ""; checkCooldown();
    }

    function toggleLike(key) {
        if(myLikes[key]) {
            dbRef.qa.child(key).transaction(p => { if(p) p.likes = (p.likes||0)-1; return p; });
            delete myLikes[key];
        } else {
            dbRef.qa.child(key).transaction(p => { if(p) p.likes = (p.likes||0)+1; return p; });
            myLikes[key] = true;
        }
        localStorage.setItem(`likes_${currentRoom}`, JSON.stringify(myLikes));
    }

    function checkCooldown() {
        const diff = Date.now() - lastPostTime;
        if(diff < 120000) {
            const remain = Math.ceil((120000 - diff) / 1000);
            document.getElementById('coolTimer').innerText = `â³ ì§ˆë¬¸ ì œí•œ: ${remain}ì´ˆ`;
            setTimeout(checkCooldown, 1000);
        } else document.getElementById('coolTimer').innerText = "";
    }

    async function sendAns(c) {
        if(!canAnswer) return;
        myLastChoiceIdx = c;
        document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.remove('selected'));
        event.target.classList.add('selected');
        let t = localStorage.getItem('uToken');
        dbRef.ans.child(currentQuizId).child(t).set({choice:c});
    }

    function showRoomList() {
        const box = document.getElementById('roomList'); box.innerHTML = "";
        for(let i=65; i<=90; i++) {
            let r = String.fromCharCode(i);
            box.innerHTML += `<div class="menu-item" style="text-align:center;" onclick="changeRoom('${r}')">Room ${r}</div>`;
        }
        toggleMenuView('rooms');
    }

    function toggleMenuView(view) {
        const main = document.getElementById('mainMenuItems');
        const rooms = document.getElementById('roomSelectionItems');
        const backBtn = document.getElementById('menuBackButton');
        const title = document.getElementById('menuTitle');
        if (view === 'rooms') { main.style.display = 'none'; rooms.style.display = 'block'; backBtn.style.display = 'block'; title.innerText = "ê°•ì˜ì‹¤ ì„ íƒ"; }
        else { main.style.display = 'block'; rooms.style.display = 'none'; backBtn.style.display = 'none'; title.innerText = "Menu"; }
    }

    function changeRoom(r) {
        const pw = prompt(`Room ${r} ë¹„ë°€ë²ˆí˜¸:`); if (!pw) return;
        firebase.database().ref(`courses/${r}/settings/password`).once('value', snap => {
            const dbPw = snap.val();
            if (String(pw) === String(dbPw) || btoa(pw) === String(dbPw)) { window.location.href = `?room=${r}`; }
            else alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
        });
    }

    async function saveProfile() {
        const name = document.getElementById('userName').value.trim();
        const phone = document.getElementById('userPhone').value.trim();
        if (!name || phone.length !== 4) { alert("ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        localStorage.setItem('kac_user_name', name); localStorage.setItem('kac_user_phone', phone);
        let uToken = localStorage.getItem('uToken') || Math.random().toString(36).substr(2);
        localStorage.setItem('uToken', uToken);
        await firebase.database().ref(`courses/${currentRoom}/students/${uToken}`).update({ name, phone, joinedAt: firebase.database.ServerValue.TIMESTAMP });
        startPresence(); document.getElementById('profileOverlay').style.display = 'none';
        document.getElementById('landingPage').style.display = 'none'; document.getElementById('mainApp').style.display = 'flex';
    }

    async function checkProfile() {
        const name = localStorage.getItem('kac_user_name'); const uToken = localStorage.getItem('uToken');
        if (!uToken || !name) { document.getElementById('profileOverlay').style.display = 'flex'; return; }
        const snap = await firebase.database().ref(`courses/${currentRoom}/students/${uToken}`).once('value');
        if (!snap.exists()) document.getElementById('profileOverlay').style.display = 'flex';
        else { startPresence(); document.getElementById('landingPage').style.display = 'none'; document.getElementById('mainApp').style.display = 'flex'; }
    }
    
    // ì™¸ì¶œ/ì™¸ë°• ê´€ë ¨ í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    let selectedAdminType = 'none';
    function selectAdminType(t) {
        selectedAdminType = t;
        const types = ['none', 'outing', 'overnight'];
        types.forEach(type => {
            const btn = document.getElementById(`btn-${type}`);
            btn.style.background = (t === type) ? "#3b82f6" : "#f8fafc";
            btn.style.color = (t === type) ? "white" : "#333";
        });
        document.getElementById('fullPhoneArea').style.display = (t === 'none') ? 'none' : 'block';
    }

    async function openAdminAction() {
        document.getElementById('menuModal').style.display = 'none';
        document.getElementById('adminActionModal').style.display = 'flex';
    }
    
    async function openShuttleApply() {
        document.getElementById('menuModal').style.display = 'none';
        document.getElementById('shuttleModal').style.display = 'flex';
    }
    
    async function viewMealMenu() {
        document.getElementById('menuModal').style.display = 'none';
        const snap = await firebase.database().ref('system/nutrition_menu').once('value');
        if (snap.val()) { document.getElementById('mealMenuImage').src = snap.val(); document.getElementById('mealMenuModal').style.display = 'flex'; }
        else alert("ì‹ë‹¨í‘œê°€ ì—†ìŠµë‹ˆë‹¤.");
    }
    
    function forceCloseQuiz() { document.getElementById('quizOverlay').style.display = 'none'; }
    function closeResultOverlay() { document.getElementById('quizOverlay').style.display = 'none'; hasClosedSummary = true; }
    function showFinalRanking() { /* ë­í‚¹ ë¡œì§ */ }
</script>
</body>
</html>