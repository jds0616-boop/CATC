<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KAC Student Platform</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        :root { --header-bg: #0f172a; --bg-color: #0f172a; --accent-color: #3b82f6; --btn-yellow: #facc15; --btn-text: #1e293b; --card-bg: #ffffff; --text-color: #1e293b; --input-bg: #f8fafc; --safe-area-bottom: env(safe-area-inset-bottom); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Pretendard', sans-serif; }
        body { margin: 0; background: var(--bg-color); color: var(--text-color); height: 100dvh; overflow: hidden; }
        .landing-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--header-bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 40px 20px; text-align: center; }
        .landing-course { font-size: 24px; font-weight: 800; margin-bottom: 10px; line-height: 1.3; }
        .landing-room { font-size: 16px; opacity: 0.7; font-weight: 500; margin-bottom: 60px; padding: 5px 15px; border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; }
        .btn-enter { background: var(--btn-yellow); color: var(--btn-text); width: 200px; height: 56px; border-radius: 30px; font-size: 18px; font-weight: 800; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3); display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.1s; }
        .btn-enter:active { transform: scale(0.96); }
        .landing-logo { position: absolute; bottom: 40px; width: 120px; z-index: 9999; }
        .app-container { width: 100%; height: 100%; display: none; flex-direction: column; position: relative; background: var(--bg-color); max-width: 600px; margin: 0 auto; }
        .header { height: 56px; background: var(--header-bg); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header-btn { width: 40px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; color: white; }
        .header-center { flex-grow: 1; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        .header-title { font-size: 15px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .header-sub { font-size: 11px; opacity: 0.8; margin-top: 2px; display: flex; gap: 6px; align-items: center; }
        .live-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #22c55e; }
        .sort-bar { padding: 10px 15px; background: var(--bg-color); display: flex; gap: 10px; z-index: 80; flex-shrink: 0; }
        .sort-chip { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(255,255,255,0.1); color: #94a3b8; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .sort-chip.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .scroll-container { flex-grow: 1; overflow-y: auto; position: relative; padding: 0 15px 120px 15px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .scroll-container::-webkit-scrollbar { display: none; }
        .q-card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; display: flex; gap: 12px; align-items: flex-start; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; }


/* ë‚´ê°€ ì‘ì„±í•œ ì§ˆë¬¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ë…¹ìƒ‰ìœ¼ë¡œ ë³€ê²½) */
.q-card.my-q { 
    border: 2px solid #10b981; /* ë…¹ìƒ‰ í…Œë‘ë¦¬ */
    background: #f0fdf4;       /* ì—°í•œ ë…¹ìƒ‰ ë°°ê²½ */
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1); 
}
/* ë‚´ê°€ ì‘ì„±í•œ ì¹´ë“œì˜ ì•„ë°”íƒ€(ì•„ì´ì½˜) ë°°ê²½ìƒ‰ */
.my-q .q-avatar { 
    background: #10b981; 
    color: white; 
}




        .q-content { flex-grow: 1; min-width: 0; }
        .q-text { font-size: 15px; line-height: 1.5; color: var(--text-color); margin-bottom: 8px; word-break: break-word; font-weight: 500; white-space: pre-wrap; }
        .q-meta { font-size: 11px; color: #94a3b8; display: flex; gap: 8px; align-items: center; }
        .btn-mini { cursor: pointer; padding: 4px 8px; background: rgba(0,0,0,0.05); border-radius: 4px; }
        .q-like-area { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 44px; flex-shrink: 0; gap: 4px; }
        .like-btn { width: 44px; height: 44px; border-radius: 12px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; color: #cbd5e1; font-size: 18px; cursor: pointer; transition: 0.2s; }
        .like-btn.active { background: #fee2e2; color: #ef4444; transform: scale(1.05); }
        .like-count { font-size: 12px; font-weight: 700; color: #64748b; }
        .like-btn.active + .like-count { color: #ef4444; }
        
        .input-dock { 
    position: fixed; /* absoluteì—ì„œ fixedë¡œ ë³€ê²½ */
    bottom: 0; 
    left: 0; 
    width: 100%; 
    background: var(--input-bg); 
    border-top-left-radius: 20px; 
    border-top-right-radius: 20px; 
    padding: 10px 15px calc(15px + var(--safe-area-bottom)) 15px; /* íŒ¨ë”© ì‚´ì§ ì¦ê°€ */
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1); 
    z-index: 1000; /* ë ˆì´ì–´ ìˆœìœ„ ë†’ì„ */
    display: flex; 
    flex-direction: column; 
    gap: 4px;
}


/* ë¯¸ë‹ˆ ê³µì§€ ë°” ìŠ¤íƒ€ì¼ */
.mini-notice-bar {
    display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
    background: #fef3c7; /* ì—°í•œ í™©ê¸ˆìƒ‰ */
    height: 36px;
    align-items: center;
    padding: 0 10px;
    border-bottom: 1px solid #fde68a;
    overflow: hidden;
    position: relative;
    cursor: pointer;
    z-index: 90;
    flex-shrink: 0;
}

.notice-icon {
    color: #d97706;
    font-size: 14px;
    margin-right: 8px;
    z-index: 2;
    background: #fef3c7;
    padding-right: 5px;
}

.notice-ticker {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    position: relative;
}

.notice-text {
    display: inline-block;
    padding-left: 100%;
    animation: marquee 20s linear infinite;
    font-size: 13px;
    font-weight: 700;
    color: #92400e;
}

@keyframes marquee {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100%); }
}

.notice-close {
    padding: 5px 8px;
    color: #b45309;
    font-size: 14px;
    z-index: 2;
    background: #fef3c7;
}










        .input-box { background: white; border-radius: 20px; padding: 10px 10px 10px 15px; display: flex; align-items: flex-end; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; min-height: 48px; height: auto; }
        .real-input { flex-grow: 1; border: none; background: transparent; font-size: 16px; line-height: 1.4; color: var(--text-color); outline: none; resize: none; height: 24px; max-height: 120px; padding: 0; margin-bottom: 2px; overflow-y: hidden; font-family: 'Pretendard', sans-serif; }


/* ì»¤ìŠ¤í…€ íŒì—… ë””ìì¸ (ì‹œì¸ì„± ê°•í™”) */
        .kac-confirm-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 20000;
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .kac-confirm-box {
            background: white; width: 100%; max-width: 320px;
            border-radius: 20px; overflow: hidden; border: 3px solid #3b82f6;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .kac-confirm-msg {
            padding: 30px 20px; text-align: center; font-size: 18px;
            font-weight: 800; color: #1e293b; line-height: 1.5; white-space: pre-wrap;
        }
        .kac-confirm-btns { display: flex; border-top: 1px solid #e2e8f0; }
        .kac-btn-no {
            flex: 1; padding: 18px; background: #f1f5f9; border: none;
            font-size: 16px; font-weight: 700; color: #64748b; cursor: pointer;
        }
        .kac-btn-yes {
            flex: 1; padding: 18px; background: #3b82f6; border: none;
            font-size: 16px; font-weight: 700; color: white; cursor: pointer;
        }
















/* ì…ë ¥ì°½ ê°€ì´ë“œ ë¬¸êµ¬ ë””ìì¸ ê°œì„  */
.real-input::placeholder {
    color: rgba(239, 68, 68, 0.6); /* íˆ¬ëª…ë„ê°€ ìˆëŠ” ë¹¨ê°„ìƒ‰ (ë¶€ë“œëŸ¬ìš´ ê²½ê³ ) */
    font-weight: 700;
    font-style: italic;           /* ê¸°ìš¸ì„ê¼´ë¡œ ì‹¤ì œ ëŒ“ê¸€ê³¼ ì°¨ë³„í™” */
    font-size: 14px;              /* ê¸€ì í¬ê¸°ë¥¼ ì‚´ì§ ì¤„ì„ */
}

/* ì•„ì´í°/ì‚¬íŒŒë¦¬ ëŒ€ì‘ */
.real-input::-webkit-input-placeholder {
    color: rgba(239, 68, 68, 0.6);
    font-weight: 700;
    font-style: italic;
    font-size: 14px;
}

        .real-input:disabled { background: transparent; color: #94a3b8; opacity: 1; }
        .send-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--accent-color); color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 15px; cursor: pointer; flex-shrink: 0; transition: 0.2s; margin-left: 8px; margin-bottom: 1px; }
        .send-btn:active { transform: scale(0.9); }
        .send-btn.editing { background: #10b981; }
        .input-info-row { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; font-size: 11px; font-weight: 600; }
        .char-counter { color: #94a3b8; } .char-counter.limit { color: #ef4444; font-weight: 800; }
        .cooldown-text { color: #ef4444; font-weight: 800; }
        
        .quiz-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .quiz-box { width: 100%; background: white; border-radius: 24px; padding: 30px 20px; text-align: center; }
        .quiz-opt-btn { width: 100%; height: 70px; margin-bottom: 10px; border-radius: 12px; font-size: 20px; font-weight: 800; border: 2px solid #e2e8f0; background: #f8fafc; color: #333; transition: 0.2s; }
        .quiz-opt-btn.selected { background: var(--accent-color); color: white; border-color: var(--accent-color); transform: scale(1.02); }
        .quiz-opt-btn.locked { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        #quizResultBox { animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .quiz-king-stamp { position: absolute; top: 5px; right: 5px; width: 95px; height: 95px; border: 4px double #facc15; border-radius: 50%; color: #facc15; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 900; font-size: 14px; transform: rotate(15deg); background: rgba(250, 204, 21, 0.1); z-index: 10; animation: stampIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes stampIn { from { transform: scale(3) rotate(45deg); opacity: 0; } to { transform: scale(1) rotate(15deg); opacity: 1; } }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .menu-box { 
    background: white; 
    width: 80%; 
    max-width: 350px; 
    border-radius: 16px; 
    padding: 20px; 
    text-align: center; 
    max-height: 85vh;    /* í™”ë©´ ë†’ì´ì˜ 85%ê¹Œì§€ë§Œ ì»¤ì§€ê²Œ ì œí•œ */
    overflow-y: auto;   /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ì„¸ë¡œ ìŠ¤í¬ë¡¤ë°” ìƒì„± */
}



/* ë©”ë‰´ ìƒë‹¨ ë‚´ ì •ë³´ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .user-profile-card {
            background: #f8fafc;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            text-align: left;
            position: relative;
        }
        .profile-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .profile-name {
            font-size: 18px;
            font-weight: 900;
            color: #1e293b;
        }
        .btn-edit-profile {
            font-size: 13px;
            color: #3b82f6;
            font-weight: 700;
            cursor: pointer;
            background: #eff6ff;
            padding: 4px 10px;
            border-radius: 6px;
        }
        .profile-dorm {
            font-size: 14px;
            font-weight: 800;
            color: #6366f1;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        /* ìƒí™œê´€ ì•„ì´ì½˜: ë§µí•€ í˜•íƒœì˜ ì„¸ë ¨ëœ ì•„ì´ì½˜ ì ìš© */
        .profile-dorm i {
            color: #3b82f6;
            font-size: 16px;
        }



        .menu-item { padding: 15px; border-bottom: 1px solid #eee; font-weight: 600; cursor: pointer; color: #333; }


/* ê³µì§€ì‚¬í•­ ë° QR ë””ìì¸ */
        .notice-card { background: #f8fafc; border-radius: 14px; padding: 15px; margin-bottom: 12px; border: 1px solid #e2e8f0; text-align: left; }
        .notice-tag { font-size: 11px; font-weight: 800; padding: 3px 8px; border-radius: 6px; color: white; margin-bottom: 8px; display: inline-block; }
        .tag-global { background: #10b981; } /* ì„¼í„°ê³µì§€ ë…¹ìƒ‰ */
        .tag-course { background: #3b82f6; } /* ê³¼ì •ê³µì§€ íŒŒë€ìƒ‰ */
        .tag-global { background: #10b981; } /* ì„¼í„°ê³µì§€ ë…¹ìƒ‰ */
        .tag-course { background: #3b82f6; } /* ê°•ì‚¬ê³µì§€ íŒŒë€ìƒ‰ */
        .tag-coord { background: #6366f1; }  /* ì½”ë””ê³µì§€ ë³´ë¼ìƒ‰ (ì¶”ê°€ë¨) */
        .notice-body { font-size: 14px; line-height: 1.6; color: #334155; white-space: pre-wrap; font-weight: 500; }
        .qr-img-full { width: 100%; border-radius: 12px; display: block; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }



/* ì°¨ëŸ‰ ì‹ ì²­ ë²„íŠ¼ ì„ íƒ ì‹œ í™œì„±í™” ìŠ¤íƒ€ì¼ (ì—°í•œ ë…¹ìƒ‰) */
.quiz-opt-btn.shuttle-active {
    background-color: #f0fdf4 !important; /* ì—°í•œ ë…¹ìƒ‰ ë°”íƒ• */
    border-color: #22c55e !important;    /* ì„ ëª…í•œ ë…¹ìƒ‰ í…Œë‘ë¦¬ */
    color: #166534 !important;           /* ì§„í•œ ë…¹ìƒ‰ ê¸€ì */
    font-weight: 900 !important;
    transform: scale(1.02);              /* ì‚´ì§ ì»¤ì§€ëŠ” íš¨ê³¼ */
    box-shadow: 0 4px 10px rgba(34, 197, 94, 0.2);
}





    </style>
</head>
<body>

<!-- [ìˆ˜ì •] ê°œì¸ì •ë³´ ë™ì˜ ì ˆì°¨ê°€ ì¶”ê°€ëœ í”„ë¡œí•„ ë“±ë¡ íŒì—… -->
<div id="profileOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,42,0.98); z-index:10000; flex-direction:column; align-items:center; justify-content:center; color:white; padding:20px; text-align:center;">
    <div style="background:white; color:#1e293b; padding:30px 20px; border-radius:24px; width:100%; max-width:350px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
        <h2 style="margin:0 0 10px 0; font-weight:900; color:#0f172a;">ë³¸ì¸ í™•ì¸</h2>
        <p style="font-size:13px; color:#64748b; margin-bottom:20px; line-height:1.5;">ì›í™œí•œ êµìœ¡ í–‰ì • ì„œë¹„ìŠ¤(ì¶œê²°, ë°°ì°¨, ìƒí™œê´€)ë¥¼ ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        
        <input type="text" id="userName" placeholder="ì„±í•¨ ì…ë ¥" style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:12px; font-size:18px; margin-bottom:12px; text-align:center; outline:none;">
        <input type="number" id="userPhone" placeholder="ì „í™”ë²ˆí˜¸ ë’· 4ìë¦¬" style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:12px; font-size:18px; margin-bottom:15px; text-align:center; outline:none;">
        
        <!-- ê°œì¸ì •ë³´ ë™ì˜ ì˜ì—­ -->
        <div style="background:#f8fafc; padding:12px; border-radius:10px; text-align:left; margin-bottom:20px; border:1px solid #e2e8f0;">
            <label style="display:flex; align-items:flex-start; gap:8px; cursor:pointer;">
                <input type="checkbox" id="privacyAgree" style="width:18px; height:18px; margin-top:2px;">
                <span style="font-size:12px; color:#475569; line-height:1.4;">
                    (í•„ìˆ˜) <b>ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©</b>ì— ë™ì˜í•©ë‹ˆë‹¤. 
                    <br><small style="color:#94a3b8;">*ëª©ì : êµìœ¡ìš´ì˜ ë° ìˆ˜ì†¡ê´€ë¦¬<br>*í•­ëª©: ì„±ëª…, ì „í™”ë²ˆí˜¸ ë’·4ìë¦¬<br>*ë³´ìœ : êµìœ¡ ì¢…ë£Œ ì‹œ ì¦‰ì‹œ íŒŒê¸°</small>
                </span>
            </label>
        </div>
        
        <button onclick="saveProfileWithCheck()" style="width:100%; padding:16px; background:#3b82f6; color:white; border:none; border-radius:12px; font-size:18px; font-weight:900; cursor:pointer; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">ë™ì˜í•˜ê³  ì…ì¥í•˜ê¸°</button>
    </div>
</div>

    <div id="landingPage" class="landing-page">
        <div class="landing-course" id="landingTitle">Loading...</div>
        <div class="landing-room" id="landingBadge">Room ...</div>
        <button class="btn-enter" onclick="enterApp()">ì…ì¥í•˜ê¸° <i class="fa-solid fa-arrow-right-to-bracket"></i></button>
        <img src="logo.png" alt="KAC" class="landing-logo">
    </div>
    <div class="app-container" id="mainApp">
<div class="header">
    <div class="header-btn" onclick="exitApp()"><i class="fa-solid fa-chevron-left"></i></div>
    <div class="header-center">
        <div class="header-title" id="roomTitle">Course Name</div>
        <div class="header-sub">
            <span class="live-dot"></span>
            <span id="realUserCount">0ëª… ì ‘ì†</span> Â· <span id="roomBadge">Room A</span>
        </div>
    </div>
    <div class="header-btn" onclick="openMainMenu()">
        <i class="fa-solid fa-bars"></i>
    </div>
</div>

<!-- [ì‹ ê·œ] ë¯¸ë‹ˆ ê³µì§€ ë°” (ê³µì§€ê°€ ìˆì„ ë•Œë§Œ ë…¸ì¶œë¨) -->
<div id="miniNoticeBar" class="mini-notice-bar" onclick="openNotice()">
    <i class="fa-solid fa-bullhorn notice-icon"></i>
    <div class="notice-ticker">
        <span id="miniNoticeText" class="notice-text"></span>
    </div>
    <div class="notice-close" onclick="event.stopPropagation(); closeMiniNotice()">
        <i class="fa-solid fa-xmark"></i>
    </div>
</div>

<!-- ì •ë ¬ ë°” ì˜ì—­ -->
<div class="sort-bar">
    <div class="sort-chip active" id="sortNew" onclick="setSort('new')">ğŸ•’ ìµœì‹ ìˆœ</div>
    <div class="sort-chip" id="sortLike" onclick="setSort('like')">ğŸ‘ ê³µê°ìˆœ</div>
</div>
        <div class="scroll-container" id="scrollContainer"><div id="qList" class="q-list"></div></div>
        <div class="input-dock" id="inputDock">

<!-- [ì‹ ê·œ] ì§ˆë¬¸ ëŒ€ìƒ(ê³¼ëª©) ì„ íƒì°½ -->
<div style="padding: 0 15px 8px 15px;">
    <select id="subjectSelect" onchange="handleSubjectChange()" style="width:100%; padding:10px; border-radius:12px; border:2px solid #e2e8f0; font-size:14px; font-weight:800; color:var(--accent-color); background:white; outline:none;">
        <option value="ê³µí†µì§ˆë¬¸">ì§ˆë¬¸ ëŒ€ìƒ ì„ íƒ (ê¸°ë³¸: ê³µí†µì§ˆë¬¸)</option>
    </select>
</div>
            <div class="input-box">
                <textarea id="qInput" class="real-input" rows="1" 
          placeholder="âœ ì§ˆë¬¸ ì…ë ¥ (ë¬´ë¡€í•œ í‘œí˜„ì€ ì‚¼ê°€ì£¼ì„¸ìš”)" 
          maxlength="100" ...></textarea>
                <button id="submitBtn" class="send-btn" onclick="submitQ()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
            <div class="input-info-row"><span id="coolTimer" class="cooldown-text"></span><span id="charCount" class="char-counter">0 / 100</span></div>
        </div>
    </div>
    <div id="quizOverlay" class="quiz-overlay">
        <div id="quizActiveBox" class="quiz-box">
            <div style="margin-bottom:20px; font-weight:900; font-size:24px; color:#3b82f6;">LIVE QUIZ</div>
<!-- í•™ìƒìš© íƒ€ì´ë¨¸ ë””ìì¸ ì¶”ê°€ -->
<div id="studentQuizTimerBox" style="display:none; justify-content:center; align-items:center; gap:10px; margin-bottom:15px;">
    <i class="fa-regular fa-clock" style="color:#64748b; font-size:20px;"></i>
    <div id="studentTimer" style="font-family: monospace; font-size:30px; font-weight:900; color:#1e293b;">00:08</div>
</div>
            <div id="quizStatusMsg" style="margin-bottom:20px; font-size:16px; font-weight:bold; color:#1e293b;">ê°•ì‚¬ë‹˜ì´ í€´ì¦ˆë¥¼ ì‹œì‘í•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...</div>
            <div id="btnGroupMultiple" style="display:none; flex-direction:column; gap:5px;">
                <button class="quiz-opt-btn" onclick="sendAns(1)">1ë²ˆ</button><button class="quiz-opt-btn" onclick="sendAns(2)">2ë²ˆ</button><button class="quiz-opt-btn" onclick="sendAns(3)">3ë²ˆ</button><button class="quiz-opt-btn" onclick="sendAns(4)">4ë²ˆ</button>
            </div>
            <div id="btnGroupOX" style="display:none; gap:15px;">
                <button class="quiz-opt-btn ox-btn" onclick="sendAns(1)" style="flex:1; height:120px; font-size:40px;">O</button><button class="quiz-opt-btn ox-btn" onclick="sendAns(2)" style="flex:1; height:120px; font-size:40px;">X</button>
            </div>
            <div id="quizFeedback" style="margin-top:15px; font-weight:800; color:#ef4444; min-height:20px;"></div>
        </div>
        <div id="quizResultBox" class="quiz-box" style="display:none; background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%); position:relative; overflow:hidden;">
            <div id="quizKingStamp" style="display:none;" class="quiz-king-stamp"><span style="font-size:30px;">ğŸ‘‘</span><span>í€´ì¦ˆì™•</span></div>
            <div style="font-size:50px; margin-bottom:10px;">ğŸ†</div>
            <h2 style="margin:0; font-weight:900; color:#0f172a;">QUIZ RESULT</h2>
            <div style="margin:25px 0;"><div style="font-size:14px; color:#64748b; font-weight:bold;">ë‹¹ì‹ ì˜ ìµœì¢… ì ìˆ˜</div><div id="myFinalScore" style="font-size:48px; font-weight:900; color:#3b82f6;">0ì </div></div>
            <div style="background:#3b82f6; color:white; padding:15px; border-radius:12px; font-weight:800;">í˜„ì¬ <span id="myFinalRank">0</span>ë“± (ì „ì²´ ì°¸ì—¬ì ì¤‘)</div>
            <button class="btn-enter" onclick="closeResultOverlay()" style="margin:20px auto 0 auto; width:100%;">í™•ì¸ ë° ë‹«ê¸°</button>
        </div>
    </div>



<div id="menuModal" class="menu-overlay" onclick="if(event.target==this)this.style.display='none'">
        <div class="menu-box">
            <!-- [ì¶”ê°€] ë§ˆì´ í”„ë¡œí•„ ì¹´ë“œ ì„¹ì…˜ -->
            <div class="user-profile-card">
                <div class="profile-info-row">
                    <div class="profile-name">
                        <span id="displayMyName">-</span>ë‹˜ <span style="font-size:14px; color:#94a3b8; font-weight:500;">(<span id="displayMyPhone">0000</span>)</span>
                    </div>
                    <div class="btn-edit-profile" onclick="editProfile()">ì •ë³´ ìˆ˜ì •</div>
                </div>
                <div class="profile-dorm" id="displayMyDormArea">
                    <i class="fa-solid fa-map-location-dot"></i>
                    <span id="displayMyDorm">ìƒí™œê´€ ì •ë³´ í™•ì¸ ì¤‘...</span>
                </div>
            </div>

            <h3 style="margin-bottom:15px; font-size:16px; color:#64748b;">ë©”ë‰´ ì„œë¹„ìŠ¤</h3>
            <div class="menu-item" onclick="openNotice()"><i class="fa-solid fa-bullhorn" style="color: #facc15;"></i> ê³µì§€ì‚¬í•­ </div>
            <div class="menu-item" onclick="viewMealMenu()"><i class="fa-solid fa-utensils"></i> ê¸ˆì£¼ ì‹ë‹¨ë³´ê¸°</div>
            <div class="menu-item" onclick="openShuttleApply()"><i class="fa-solid fa-bus"></i> ì°¨ëŸ‰ ì‹ ì²­</div>
            <div class="menu-item" onclick="openAdminAction()"><i class="fa-solid fa-file-signature"></i> ì™¸ì¶œÂ·ì™¸ë°• / ì„ì‹ì œì™¸</div>
            <div class="menu-item" onclick="openAttendanceQR()"><i class="fa-solid fa-qrcode" style="color: #3b82f6;"></i> ì¶œê²° QR í™•ì¸</div>
            <button onclick="document.getElementById('menuModal').style.display='none'" style="margin-top:15px; width:100%; padding:12px; border:none; border-radius:12px; background:#f1f5f9; font-weight:900; color:#475569;">ë‹«ê¸°</button>
        </div>
    </div>







<!-- [ê°œí¸] ì°¨ëŸ‰ ì‹ ì²­ íŒì—… -->
<div id="shuttleModal" class="menu-overlay" style="display:none; z-index: 7000;">
    <div class="menu-box" style="width:90%; padding: 25px 20px; border-radius: 24px; max-width: 400px;">
        <h3 style="margin-bottom: 5px; color:#1e293b; font-weight:900;">í‡´êµ ì°¨ëŸ‰ ì‹ ì²­</h3>
        
        <!-- ê¸°ì‚¬ë‹˜ ì „ë‹¬ ì‹œê°„ í‘œì‹œ ì˜ì—­ -->
        <div id="driverNoticeBar" style="background: #eff6ff; border: 1px solid #dbeafe; padding: 12px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 11px; font-weight: 800; color: #3b82f6; margin-bottom: 4px;">ğŸ“¢ í•­ê¸°ì› ì¶œë°œ ì˜ˆì • ì‹œê°„</div>
            <div id="departureTimeText" style="font-size: 18px; font-weight: 900; color: #1e40af;">ì‹œê°„ ì •ë³´ ì—†ìŒ</div>
        </div>

        <!-- ì‹ ì²­ ì „: ë²„íŠ¼ ì„ íƒ ì˜ì—­ -->
        <div id="shuttleSelectionArea">
            <p style="font-size:12px; color:#94a3b8; margin-bottom:15px; text-align: center;">ì´ë™ ìˆ˜ë‹¨ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="quiz-opt-btn shuttle-btn" onclick="selectShuttle('car', 'ìì°¨(ê°œë³„ì´ë™)')" style="justify-content: center; height:55px; font-size:17px; background:#f1f5f9; border-color:#e2e8f0; color:#64748b;">ìì°¨ (ê°œë³„ì´ë™)</button>
                <button class="quiz-opt-btn shuttle-btn" onclick="selectShuttle('osong', 'ì˜¤ì†¡ì—­')" style="justify-content: center; height:55px; font-size:17px; border-color:#fca5a5; color:#b91c1c;">ì˜¤ì†¡ì—­</button>
                <button class="quiz-opt-btn shuttle-btn" onclick="selectShuttle('terminal', 'ì²­ì£¼í„°ë¯¸ë„')" style="justify-content: center; height:55px; font-size:17px; border-color:#93c5fd; color:#1e40af;">ì²­ì£¼í„°ë¯¸ë„</button>
                <button class="quiz-opt-btn shuttle-btn" onclick="selectShuttle('airport', 'ì²­ì£¼ê³µí•­')" style="justify-content: center; height:55px; font-size:17px; border-color:#86efac; color:#166534;">ì²­ì£¼êµ­ì œê³µí•­</button>
            </div>
        </div>

        <!-- ì‹ ì²­ í›„: ë‚´ì—­ í™•ì¸ ë° ì·¨ì†Œ ì˜ì—­ -->
        <div id="shuttleCancelArea" style="display:none; background: #f8fafc; padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; text-align:center;">
            <p style="font-size: 12px; font-weight: 800; color: #64748b; margin-bottom:5px;">ğŸ“ ë‚˜ì˜ ì‹ ì²­ í˜„í™©</p>
            <p id="myCurrentShuttleText" style="font-size: 20px; font-weight: 900; color: #1e293b; margin-bottom:20px;"></p>
            <button onclick="cancelShuttleRequest()" style="width: 100%; padding: 15px; background: #ef4444; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: bold;">ì‹ ì²­ ì·¨ì†Œí•˜ê¸°</button>
        </div>

        <button onclick="closeShuttleModal()" style="margin-top:20px; width:100%; padding:15px; border:none; border-radius:15px; background:#f1f5f9; color: #475569; font-size: 18px; font-weight: 900;">ë‹«ê¸°</button>
    </div>
</div>








<!-- [ìµœì¢… ìˆ˜ì •] ì™¸ì¶œ/ì™¸ë°• ì‹ ì²­ ë° ë³µê·€ ì‹œìŠ¤í…œ íŒì—… -->
<div id="adminActionModal" class="menu-overlay" style="display:none; z-index: 7000;">
    <div class="menu-box" style="width:95%; padding: 20px; border-radius: 20px; max-width: 450px;">
        <h3 style="margin-bottom: 5px; font-weight:900;">ì™¸ì¶œÂ·ì™¸ë°• ì‹ ì²­ì„œ ì‘ì„±</h3>
        <p id="adminActionDate" style="font-size:12px; color:#94a3b8; margin-bottom:15px;">ì˜¤ëŠ˜ ë‚ ì§œ: 2026-01-20</p>

        <!-- [í˜„í™© ì˜ì—­] ì´ë¯¸ ì‹ ì²­í–ˆì„ ë•Œë§Œ ë³´ì„ -->
        <div id="adminStatusArea" style="display:none; background: #f0f7ff; padding: 15px; border-radius: 12px; border: 1px solid #3b82f6; margin-bottom: 20px; text-align: left;">
            <p style="font-size: 14px; font-weight: 800; color: #3b82f6; margin: 0 0 5px 0;">í˜„ì¬ ì‹ ì²­ ë° ë³µê·€ í˜„í™©</p>
            <div id="adminStatusText" style="font-size: 14px; color: #1e293b; margin: 0; line-height: 1.5;"></div>
            
            <div id="returnBtnArea" style="margin-top:15px; display:flex; flex-direction:column; gap:8px;">
                <div id="beforeReturnGroup" style="display:flex; gap:8px;">
                    <button onclick="confirmReturnAction()" style="flex:2; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: bold;">ë³µê·€ ì™„ë£Œ ë³´ê³ </button>
                    <button onclick="cancelAdminAction()" style="flex:1; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: bold;">ì·¨ì†Œ</button>
                </div>
                <div id="afterReturnGroup" style="display:none;">
                    <button onclick="undoReturnAction()" style="width:100%; padding: 12px; background: #64748b; color: white; border: none; border-radius: 8px; font-weight: bold;">ë³µê·€ ë³´ê³  ì·¨ì†Œ (ì¬ìˆ˜ì •)</button>
                </div>
<!-- [ì°¾ì„ ìœ„ì¹˜] afterReturnGroup ê°€ ëë‚˜ëŠ” </div> ë°”ë¡œ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš” -->
<div id="dinnerOnlyGroup" style="display:none;">
    <button onclick="cancelDinnerOnly()" style="width:100%; padding: 12px; background: #64748b; color: white; border: none; border-radius: 8px; font-weight: bold;">
        ğŸ´ ì„ì‹ ì œì™¸ì‹ ì²­ ì·¨ì†Œ
    </button>
</div>

            </div>
        </div>

<!-- [ìµœì¢…] ìë™ì™„ì„± ê¸°ëŠ¥ì´ ì¶”ê°€ëœ ì…ë ¥ ì–‘ì‹ ì˜ì—­ -->
        <div id="adminActionForm" style="display: none; text-align: left; flex-direction: column; gap: 12px;">
            <div style="display: flex; gap: 8px;">
                <button class="quiz-opt-btn admin-type-btn" id="btn-outing" onclick="selectAdminType('outing')" style="height:45px; font-size:14px; flex:1; margin-bottom:0;">ì™¸ì¶œ (ë‹¹ì¼)</button>
                <button class="quiz-opt-btn admin-type-btn" id="btn-overnight" onclick="selectAdminType('overnight')" style="height:45px; font-size:14px; flex:1; margin-bottom:0;">ì™¸ë°• (ìµì¼)</button>
            </div>

            <div>
                <label style="font-size:11px; font-weight:800; color:#64748b;">ì†Œì† (ì˜ˆ: ê¹€í¬ê³µí•­ ë ˆì´ë”ê´€ì œë¶€ ë“±)</label>
                <input type="text" id="userDept" list="deptHistory" placeholder="ì†Œì† ë¶€ì„œë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width:100%; padding:12px; border:1.5px solid #e2e8f0; border-radius:10px; outline:none; font-size:15px;">
                <datalist id="deptHistory"></datalist> <!-- ì†Œì† ì €ì¥ì†Œ -->
            </div>

            <div style="background: #f8fafc; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 10px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label style="font-size:13px; font-weight:800; color:#64748b;">ì™¸ì¶œ ì‹œê°„</label>
                    <input type="time" id="startTime" style="width:60%; padding:8px; border:1px solid #cbd5e1; border-radius:8px; font-size:15px;">
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label style="font-size:13px; font-weight:800; color:#64748b;">ë³µê·€ ì‹œê°„</label>
                    <input type="time" id="endTime" style="width:60%; padding:8px; border:1px solid #cbd5e1; border-radius:8px; font-size:15px;">
                </div>
                <div id="returnDateArea" style="display:none; border-top: 1px dashed #cbd5e1; padding-top:10px; display: flex; align-items: center; justify-content: space-between;">
                    <label style="font-size:13px; font-weight:800; color:#e11d48;">ë³µê·€ ë‚ ì§œ</label>
                    <input type="date" id="returnDate" style="width:60%; padding:8px; border:1px solid #fda4af; border-radius:8px; font-size:14px;">
                </div>
            </div>

            <div>
                <label style="font-size:11px; font-weight:800; color:#64748b;">í–‰ì„ ì§€</label>
                <input type="text" id="destination" list="destHistory" placeholder="ì˜ˆ: ì²­ì£¼ì‹œë‚´" style="width:100%; padding:12px; border:1.5px solid #e2e8f0; border-radius:10px; outline:none; font-size:15px;">
                <datalist id="destHistory"></datalist> <!-- í–‰ì„ ì§€ ì €ì¥ì†Œ -->
            </div>

            <div>
                <label style="font-size:11px; font-weight:800; color:#64748b;">ì‹ ì²­ ì‚¬ìœ </label>
                <input type="text" id="outingReason" list="reasonHistory" placeholder="ì˜ˆ: ê°œì¸ìš©ë¬´ ë“±" style="width:100%; padding:12px; border:1.5px solid #e2e8f0; border-radius:10px; outline:none; font-size:15px;">
                <datalist id="reasonHistory"></datalist> <!-- ì‚¬ìœ  ì €ì¥ì†Œ -->
            </div>

            <div>
                <label style="font-size:11px; font-weight:800; color:#64748b;">ë¹„ìƒ ì—°ë½ì²˜</label>
                <input type="tel" id="fullPhone" placeholder="010-0000-0000" style="width:100%; padding:12px; border:1.5px solid #e2e8f0; border-radius:10px; outline:none; font-size:15px;">
            </div>

<!-- ì„ì‹ ì œì™¸ ì²´í¬ë°•ìŠ¤ ì¶”ê°€ -->
            <div style="background: #fdf2f2; padding: 12px; border-radius: 12px; border: 1px solid #fee2e2; margin-top: 5px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="skipDinner" style="width:20px; height:20px; accent-color: #ef4444;">
                    <span style="font-size:15px; font-weight:800; color:#b91c1c;">ì˜¤ëŠ˜ ì €ë… ì‹ì‚¬ë¥¼ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
                </label>
                <p style="font-size:11px; color:#ef4444; margin: 8px 0 0 30px; font-weight: 600;">
                    â€» 16:00 ì´í›„ì—ëŠ” ë³€ê²½ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.
                </p>
            </div>




            <button onclick="submitAdminAction()" style="width: 100%; padding: 15px; background: #10b981; color: white; border: none; border-radius: 12px; font-size: 17px; font-weight: 900; margin-top:5px;">ì‹ ì²­ì„œ ì œì¶œ</button>
        </div>

        <button onclick="document.getElementById('adminActionModal').style.display='none'" style="margin-top:15px; width:100%; padding:12px; border:none; border-radius:12px; background:#f1f5f9; color: #475569; font-size: 15px; font-weight: 800; cursor: pointer;">ë‹«ê¸°</button>
    </div>
</div>











<!-- [ì‹ ê·œ] ê³µì§€ì‚¬í•­ íŒì—… -->
    <div id="noticeModal" class="menu-overlay" style="display:none; z-index: 9000;" onclick="if(event.target==this)this.style.display='none'">
        <div class="menu-box">
            <h3 style="margin-bottom:20px;">ğŸ“¢ ì¤‘ìš” ê³µì§€ì‚¬í•­</h3>
            <div id="noticeContainer"></div>
            <button onclick="document.getElementById('noticeModal').style.display='none'" style="margin-top:15px; width:100%; padding:12px; border:none; border-radius:8px; background:#e2e8f0; font-weight:bold;">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- [ì‹ ê·œ] ì¶œê²° QR í™•ì¸ íŒì—… -->
    <div id="qrModal" class="menu-overlay" style="display:none; z-index: 9001;" onclick="if(event.target==this)this.style.display='none'">
        <div class="menu-box">
            <h3 style="margin-bottom:15px;">ì¶œê²° QR (ê³ ìš©ë…¸ë™ë¶€)</h3>
            <img id="qrImage" src="" class="qr-img-full" style="display:none;">
            <div id="qrEmptyMsg" style="padding:40px 0; color:#94a3b8; font-weight:bold; display:none;">ë“±ë¡ëœ QRì´ ì—†ìŠµë‹ˆë‹¤.</div>
            <button onclick="document.getElementById('qrModal').style.display='none'" style="margin-top:20px; width:100%; padding:12px; border:none; border-radius:8px; background:#e2e8f0; font-weight:bold;">ë‹«ê¸°</button>
        </div>
    </div>


<!-- [ì‹ ê·œ] ì‹ë‹¨í‘œ ì´ë¯¸ì§€ íŒì—… -->
<div id="mealMenuModal" class="menu-overlay" style="display:none; z-index: 8000;" onclick="this.style.display='none'">
    <div style="width:90%; max-width:500px; background:white; border-radius:20px; padding:10px; position:relative;">
        <img id="mealMenuImage" src="" style="width:100%; border-radius:15px; display:block;" alt="ì‹ë‹¨í‘œ ì¤€ë¹„ì¤‘">
        <p style="margin-top:10px; font-weight:bold; color:#64748b;">(í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ë‹«í™ë‹ˆë‹¤)</p>
    </div>
</div>













<script src="config.js"></script>
    <script>
        let serverTimeOffset = 0;
        let confirmCallback = null;

        // ì»¤ìŠ¤í…€ í™•ì¸ì°½ ì œì–´
        function showKacConfirm(msg, callback) {
            document.getElementById('kacConfirmMsg').innerText = msg;
            document.getElementById('kacConfirm').style.display = 'flex';
            confirmCallback = callback;
        }

        function closeKacConfirm(result) {
            document.getElementById('kacConfirm').style.display = 'none';
            if(result && confirmCallback) confirmCallback();
            confirmCallback = null;
        }

        // ì „ì—­ ìƒíƒœ ë³€ìˆ˜
        let dbRef = {}; 
        let currentRoom = null; 
        let myQs = {}; 
        let myLikes = {}; 
        let lastPostTimeMap = {}; 
        let editingKey = null; 
        let currentSort = 'new'; 
        let currentQuizId = null; 
        let canAnswer = false;  
        let myLastChoice = null; 
        let myLastChoiceIdx = null; 
        let hasClosedSummary = false; 
        let rankingListener = null; 
        let studentTimerInterval = null; 
        let currentFilter = "ê³µí†µì§ˆë¬¸"; 
        let currentShuttleData = null;
        let selectedAdminType = 'none';

        // 1. [ì´ˆê¸°í™”] í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        (async function init() {
            const params = new URLSearchParams(window.location.search);
            const directRoom = params.get('room');
            const code = params.get('code');

            if (directRoom) { currentRoom = directRoom; } 
            else if (code) { currentRoom = await resolveRoomFromCode(code); }

            if (!currentRoom) {
                alert("ê°•ì˜ì‹¤ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. QR ì½”ë“œë¥¼ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.");
                return;
            }

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('roomBadge').innerText = `Room ${currentRoom}`;
            document.getElementById('landingBadge').innerText = `ROOM ${currentRoom}`;

            // ë°©ë³„ ë¡œì»¬ ë°ì´í„° ë¡œë“œ
            myLikes = JSON.parse(localStorage.getItem(`likes_${currentRoom}`) || '{}'); 
            myQs = JSON.parse(localStorage.getItem(`myqs_${currentRoom}`) || '{}'); 
            lastPostTimeMap = JSON.parse(localStorage.getItem(`lastTimeMap_${currentRoom}`) || '{}');

            const db = firebase.database();
            const rPath = `courses/${currentRoom}`;
            dbRef = { 
                qa: db.ref(`${rPath}/questions`), 
                quiz: db.ref(`${rPath}/activeQuiz`), 
                ans: db.ref(`${rPath}/quizAnswers`), 
                settings: db.ref(`${rPath}/settings`), 
                status: db.ref(`${rPath}/status`), 
                connections: db.ref(`${rPath}/connections`) 
            };

            handleInternalAttendance(currentRoom); // ìë™ ì¶œê²° ì²´í¬
            setupListeners(); // ë¦¬ì–¼íƒ€ì„ ê°ì‹œ ì‹œì‘
            checkCooldown(); // ì§ˆë¬¸ ì¿¨íƒ€ì„ ì²´í¬
            initKeyboardFix(); // ëª¨ë°”ì¼ í‚¤ë³´ë“œ ëŒ€ì‘
        })();

        // 2. [ì…ì¥ ë¡œì§] ê°•ì‚¬ ìƒíƒœ í™•ì¸ ë° í”„ë¡œí•„ ì²´í¬
        async function enterApp() {
            const statusSnap = await firebase.database().ref(`courses/${currentRoom}/status/roomStatus`).once('value');
            if (statusSnap.val() !== 'active') {
                alert("âš ï¸ ê°•ì‚¬ë‹˜ì´ ì•„ì§ ê°•ì˜ë¥¼ ì‹œì‘í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");
                return;
            }
            const doc = document.documentElement;
            if (doc.requestFullscreen) doc.requestFullscreen().catch(e=>{});
            await checkProfile();
        }

        async function checkProfile() {
            const uToken = localStorage.getItem('uToken_' + currentRoom);
            const savedName = localStorage.getItem('kac_user_name_' + currentRoom);

            if (!uToken || !savedName) {
                // ë‹¤ë¥¸ ë°©ì—ì„œ ì¼ë˜ ì´ë¦„ ìë™ì™„ì„±ìš©
                const globalName = localStorage.getItem('kac_user_name');
                const globalPhone = localStorage.getItem('kac_user_phone');
                if(globalName) document.getElementById('userName').value = globalName;
                if(globalPhone) document.getElementById('userPhone').value = globalPhone;
                document.getElementById('profileOverlay').style.display = 'flex';
                return;
            }
            showMainDashboard();
        }

        function showMainDashboard() {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            startPresence();
        }

        // 3. [í”„ë¡œí•„ ì €ì¥] ë°©ë³„ ë…ë¦½ í† í° ë°œí–‰
        function saveProfileWithCheck() {
            if(!document.getElementById('privacyAgree').checked) {
                alert("ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•´ì•¼ ì„œë¹„ìŠ¤ ì´ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }
            saveProfile();
        }

        async function saveProfile() {
            const name = document.getElementById('userName').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            if (!name || phone.length !== 4) {
                alert("ì„±í•¨ê³¼ ì „í™”ë²ˆí˜¸ ë’· 4ìë¦¬ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            const newUToken = `${name}_${phone}`;
            const oldToken = localStorage.getItem('kac_old_uToken');
            
            try {
                // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° ì´ì „ ë°ì´í„° ì‚­ì œ
                if(oldToken && oldToken !== newUToken) {
                    await firebase.database().ref(`courses/${currentRoom}/students/${oldToken}`).remove();
                }

                // ë¡œì»¬ ì €ì¥ (ë°©ë³„ ë…ë¦½)
                localStorage.setItem('kac_user_name', name); // ê³µí†µ ìë™ì™„ì„±ìš©
                localStorage.setItem('kac_user_phone', phone); // ê³µí†µ ìë™ì™„ì„±ìš©
                localStorage.setItem('uToken_' + currentRoom, newUToken);
                localStorage.setItem('kac_user_name_' + currentRoom, name);
                localStorage.setItem('kac_user_phone_' + currentRoom, phone);
                localStorage.removeItem('kac_old_uToken');

                // ì„œë²„ ì €ì¥
                await firebase.database().ref(`courses/${currentRoom}/students/${newUToken}`).update({
                    name: name, phone: phone, joinedAt: firebase.database.ServerValue.TIMESTAMP, isOnline: true
                });

                document.getElementById('profileOverlay').style.display = 'none';
                
                // ì¶œê²° ì²´í¬ íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‹¤í–‰
                if (new URLSearchParams(window.location.search).get('checkin') === 'true') {
                    handleInternalAttendance(currentRoom); 
                } else {
                    showMainDashboard();
                }
            } catch (e) {
                alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // 4. [ì ‘ì† ìœ ì§€] ìœ ë ¹ íšŒì› ë°©ì§€ ë° ê°•ì œ í‡´ì¶œ
        function startPresence() {
            const uToken = localStorage.getItem('uToken_' + currentRoom);
            const name = localStorage.getItem('kac_user_name_' + currentRoom);
            const phone = localStorage.getItem('kac_user_phone_' + currentRoom);
            if (!uToken || !currentRoom || !name) return;

            const myRef = firebase.database().ref(`courses/${currentRoom}/students/${uToken}`);
            const connectedRef = firebase.database().ref(".info/connected");

            // ì„œë²„ì—ì„œ ë‚´ê°€ ì§€ì›Œì¡ŒëŠ”ì§€ ê°ì‹œ
            myRef.on('value', snap => {
                if (!snap.exists() && document.getElementById('mainApp').style.display === 'flex') {
                    myRef.off();
                    localStorage.removeItem('uToken_' + currentRoom);
                    alert("ì •ë³´ê°€ ë³€ê²½ë˜ì—ˆê±°ë‚˜ ì‚­ì œë˜ì–´ ë‹¤ì‹œ ì…ì¥í•©ë‹ˆë‹¤.");
                    location.reload();
                }
            });

            // ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ ë³´ê³ 
            connectedRef.on("value", (snap) => {
                if (snap.val() === true) {
                    myRef.update({ name: name, phone: phone, isOnline: true, lastSeen: firebase.database.ServerValue.TIMESTAMP });
                    myRef.child('isOnline').onDisconnect().set(false);
                }
            });

            // ì „ì²´ ì ‘ì†ì ìˆ˜ ì¹´ìš´íŠ¸
            firebase.database().ref(`courses/${currentRoom}/students`).on('value', (snap) => {
                const data = snap.val() || {};
                const activeUsers = Object.values(data).filter(user => user.isOnline === true);
                document.getElementById('realUserCount').innerText = `${activeUsers.length}ëª… ì ‘ì†`;
            });
        }

        // 5. [ì§ˆë¬¸ ê¸°ëŠ¥] í•„í„°ë§ ë° ì¿¨íƒ€ì„
        function submitQ() {
            const txt = document.getElementById('qInput').value.trim();
            if(!txt) return;

            const uToken = localStorage.getItem('uToken_' + currentRoom);
            const subject = document.getElementById('subjectSelect').value;
            const now = Date.now();
            
            // ìˆ˜ì • ëª¨ë“œ ì²˜ë¦¬
            if(editingKey) {
                dbRef.qa.child(editingKey).update({ text: txt, subject: subject }).then(() => { 
                    alert("ìˆ˜ì • ì™„ë£Œ"); 
                    resetInput(); 
                });
                return;
            }

            // ë„ë°° ë°©ì§€ ì¿¨íƒ€ì„ (2ë¶„)
            if(now - (lastPostTimeMap[subject] || 0) < 120000) { 
                alert(`'${subject}'ë‹˜ê»˜ëŠ” ì ì‹œ í›„ ë‹¤ì‹œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.`); 
                return; 
            }

            const ref = dbRef.qa.push();
            ref.set({
                text: txt, subject: subject, likes: 0, 
                timestamp: firebase.database.ServerValue.TIMESTAMP, uToken: uToken
            });

            myQs[ref.key] = now;
            localStorage.setItem(`myqs_${currentRoom}`, JSON.stringify(myQs));
            lastPostTimeMap[subject] = now;
            localStorage.setItem(`lastTimeMap_${currentRoom}`, JSON.stringify(lastPostTimeMap));
            
            resetInput();
            checkCooldown();
        }

        function renderList(data) {
            const list = document.getElementById('qList'); 
            list.innerHTML = ""; 
            let items = Object.keys(data).map(k => ({id:k, ...data[k]}));
            
            if (currentFilter !== "ê³µí†µì§ˆë¬¸") items = items.filter(item => item.subject === currentFilter);
            
            if(currentSort === 'like') {
                items.sort((a,b) => (b.likes||0) - (a.likes||0) || b.timestamp - a.timestamp); 
            } else {
                items.sort((a,b) => b.timestamp - a.timestamp);
            }

            if (items.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:80px 20px; color:#94a3b8; font-size:14px;">ë“±ë¡ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            items.forEach(item => {
                if(item.status === 'delete') return;
                const isMine = myQs[item.id] ? true : false;
                const likedClass = myLikes[item.id] ? 'active' : '';
                
                const instructorTag = `<span style="display:inline-block; background:${isMine?'#d1fae5':'#eff6ff'}; color:${isMine?'#059669':'#3b82f6'}; font-size:10px; padding:1px 6px; border-radius:4px; margin-right:6px; border:1px solid ${isMine?'#a7f3d0':'#dbeafe'}; font-weight:800; vertical-align:middle;">To. ${item.subject || 'ê³µí†µì§ˆë¬¸'}</span>`;

                list.innerHTML += `
                    <div class="q-card ${isMine?'my-q':''}">
                        <div class="q-avatar"><i class="fa-solid fa-user"></i></div>
                        <div class="q-content">
                            <div class="q-text" style="font-size:15px; color:#1e293b; line-height:1.4;">${instructorTag}<span>${escapeHtml(item.text)}</span></div>
                            <div class="q-meta">
                                <span>${formatTime(item.timestamp)}</span>
                                ${isMine && (Date.now() - myQs[item.id] < 300000) ? 
                                `<span class="btn-mini" onclick="editQ('${item.id}')">ìˆ˜ì •</span><span class="btn-mini" onclick="deleteQ('${item.id}')" style="color:#ef4444">ì‚­ì œ</span>` : ''}
                            </div>
                        </div>
                        <div class="q-like-area">
                            <div class="like-btn ${likedClass}" onclick="toggleLike('${item.id}')"><i class="fa-solid fa-thumbs-up"></i></div>
                            <span class="like-count">${item.likes||0}</span>
                        </div>
                    </div>`;
            });
        }

        // 6. [í–‰ì • ì‹ ì²­] ì™¸ì¶œ/ì™¸ë°•/ì„ì‹ í†µí•© ê´€ë¦¬
        function selectAdminType(type) {
            selectedAdminType = type;
            const types = ['outing', 'overnight'];
            types.forEach(t => {
                const btn = document.getElementById(`btn-${t}`);
                if(!btn) return;
                btn.style.background = (t === type) ? "#3b82f6" : "#f8fafc";
                btn.style.color = (t === type) ? "white" : "#64748b";
            });
            document.getElementById('returnDateArea').style.display = (type === 'overnight') ? 'block' : 'none';
            if(type === 'overnight') {
                const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('returnDate').value = tomorrow.toISOString().substring(0, 10);
            }
        }

        async function openAdminAction() {
            const uToken = localStorage.getItem('uToken_' + currentRoom);
            const today = getTodayString();
            
            const [actionSnap, dinnerSnap] = await Promise.all([
                firebase.database().ref(`courses/${currentRoom}/admin_actions/${today}/${uToken}`).once('value'),
                firebase.database().ref(`courses/${currentRoom}/dinner_skips/${today}/${uToken}`).once('value')
            ]);

            const actionData = actionSnap.val();
            const hasDinner = dinnerSnap.exists();

            if (!actionData && !hasDinner) {
                document.getElementById('adminActionForm').style.display = 'flex';
                document.getElementById('adminStatusArea').style.display = 'none';
                selectedAdminType = 'none';
            } else {
                document.getElementById('adminActionForm').style.display = 'none';
                document.getElementById('adminStatusArea').style.display = 'block';

                let txt = "";
                if(hasDinner) txt += `<div style="margin-bottom:10px; padding:10px; background:#fff1f2; border:1px solid #fda4af; border-radius:10px; color:#e11d48; font-weight:800;">ğŸ´ ì˜¤ëŠ˜ ì„ì‹ ì œì™¸ ì‹ ì²­ë¨</div>`;
                if(actionData) txt += `<div style="background:#fff; padding:12px; border:1px solid #dbeafe; border-radius:10px;"><b>${actionData.returned ? '[ë³µê·€ ì™„ë£Œ ë³´ê³ ë¨]' : '[ë¯¸ë³µê·€ / ì™¸ì¶œ ì¤‘]'}</b><br>ìœ í˜•: ${actionData.type=='outing'?'ì™¸ì¶œ':'ì™¸ë°•'}<br>ì‹œê°„: ${actionData.startTime} ~ ${actionData.endTime}</div>`;
                document.getElementById('adminStatusText').innerHTML = txt;

                document.getElementById('beforeReturnGroup').style.display = (actionData && !actionData.returned) ? 'flex' : 'none';
                document.getElementById('afterReturnGroup').style.display = (actionData && actionData.returned) ? 'block' : 'none';
                document.getElementById('dinnerOnlyGroup').style.display = (!actionData && hasDinner) ? 'block' : 'none';
            }
            document.getElementById('adminActionModal').style.display = 'flex';
        }

        async function submitAdminAction() {
            const uToken = localStorage.getItem('uToken_' + currentRoom);
            const name = localStorage.getItem('kac_user_name_' + currentRoom);
            const phone = localStorage.getItem('kac_user_phone_' + currentRoom);
            const skipDinner = document.getElementById('skipDinner').checked;
            const today = getTodayString();

            if(selectedAdminType === 'none' && !skipDinner) return alert("ìœ í˜•ì„ ì„ íƒí•˜ê±°ë‚˜ ì„ì‹ì œì™¸ì— ì²´í¬í•˜ì„¸ìš”.");

            if(selectedAdminType !== 'none') {
                const dept = document.getElementById('userDept').value.trim();
                const start = document.getElementById('startTime').value;
                const end = document.getElementById('endTime').value;
                const dest = document.getElementById('destination').value.trim();
                const reason = document.getElementById('outingReason').value.trim();
                const fullPhone = document.getElementById('fullPhone').value.trim();
                const retDate = (selectedAdminType === 'overnight') ? document.getElementById('returnDate').value : today;

                if(!dept || !start || !end || !dest || !reason || !fullPhone) return alert("ì™¸ì¶œ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
                
                await firebase.database().ref(`courses/${currentRoom}/admin_actions/${today}/${uToken}`).set({
                    name, dept, startTime: start, endTime: end, returnDate: retDate, destination: dest, reason, phone: fullPhone, type: selectedAdminType, timestamp: firebase.database.ServerValue.TIMESTAMP, returned: false
                });
            }

            if(skipDinner) {
                if(new Date().getHours() >= 16) alert("ì„ì‹ ì‹ ì²­/ì·¨ì†ŒëŠ” 16ì‹œ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.");
                else await firebase.database().ref(`courses/${currentRoom}/dinner_skips/${today}/${uToken}`).set(`${name}(${phone})`);
            }
            alert("âœ… ì‹ ì²­ì„œê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById('adminActionModal').style.display = 'none';
        }

        async function cancelDinnerOnly() {
            if(new Date().getHours() >= 16) return alert("ì„ì‹ ì·¨ì†ŒëŠ” 16ì‹œ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.");
            if(confirm("ì„ì‹ ì œì™¸ ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const u = localStorage.getItem('uToken_' + currentRoom);
                await firebase.database().ref(`courses/${currentRoom}/dinner_skips/${getTodayString()}/${u}`).remove();
                alert("ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."); openAdminAction();
            }
        }

        async function cancelAdminAction() {
            if(confirm("ê¸°ì¡´ ì‹ ì²­ ë‚´ì—­ì„ ëª¨ë‘ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const u = localStorage.getItem('uToken_' + currentRoom);
                const t = getTodayString();
                await firebase.database().ref(`courses/${currentRoom}/admin_actions/${t}/${u}`).remove();
                await firebase.database().ref(`courses/${currentRoom}/dinner_skips/${t}/${u}`).remove();
                alert("ì·¨ì†Œ ì™„ë£Œ"); openAdminAction();
            }
        }

        async function confirmReturnAction() {
            if(confirm("í˜„ ì‹œê°ë¶€ë¡œ ë³µê·€í•˜ì…¨ìŠµë‹ˆê¹Œ?")) {
                const u = localStorage.getItem('uToken_' + currentRoom);
                await firebase.database().ref(`courses/${currentRoom}/admin_actions/${getTodayString()}/${u}`).update({
                    returned: true, returnReportTime: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
                });
                alert("âœ… ë³µê·€ ë³´ê³  ì™„ë£Œ"); openAdminAction();
            }
        }

        // 7. [ì°¨ëŸ‰ ì‹ ì²­]
        async function openShuttleApply() {
            document.getElementById('menuModal').style.display = 'none';
            document.getElementById('shuttleModal').style.display = 'flex';
            const uToken = localStorage.getItem('uToken_' + currentRoom);
            
            firebase.database().ref(`courses/${currentRoom}/shuttle/departure`).on('value', snap => {
                const d = snap.val();
                document.getElementById('departureTimeText').innerText = (d && d.time) ? `${d.date} [ ${d.time} ] ì¶œë°œ ì˜ˆì •` : "ê¸°ì‚¬ë‹˜ì´ ì¶œë°œ ì‹œê°„ì„ ì„¤ì • ì¤‘ì…ë‹ˆë‹¤.";
            });

            const snap = await firebase.database().ref(`courses/${currentRoom}/shuttle/requests/${uToken}`).once('value');
            currentShuttleData = snap.val();
            document.getElementById('shuttleSelectionArea').style.display = currentShuttleData ? 'none' : 'block';
            document.getElementById('shuttleCancelArea').style.display = currentShuttleData ? 'block' : 'none';
            if(currentShuttleData) document.getElementById('myCurrentShuttleText').innerText = currentShuttleData.typeText;
        }

        function selectShuttle(typeId, typeName) {
            showKacConfirm(`[${typeName}] ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async function() {
                const u = localStorage.getItem('uToken_' + currentRoom);
                const n = localStorage.getItem('kac_user_name_' + currentRoom);
                const p = localStorage.getItem('kac_user_phone_' + currentRoom);
                await firebase.database().ref(`courses/${currentRoom}/shuttle/requests/${u}`).set({
                    type: typeId, typeText: typeName, name: n, phone: p, timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                alert("ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); closeShuttleModal();
            });
        }

        async function cancelShuttleRequest() {
            if(confirm("ì°¨ëŸ‰ ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await firebase.database().ref(`courses/${currentRoom}/shuttle/requests/${localStorage.getItem('uToken_'+currentRoom)}`).remove();
                alert("ì •ìƒì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."); openShuttleApply();
            }
        }

        // 8. [í€´ì¦ˆ ë‹µë³€] ë°©ë³„ í† í°ìœ¼ë¡œ ì „ë‹¬
        function sendAns(idx) {
            if (!canAnswer || !currentQuizId) return; 
            myLastChoiceIdx = idx;
            const oxArea = document.getElementById('btnGroupOX');
            const multArea = document.getElementById('btnGroupMultiple');
            const isOX = (oxArea.style.display === 'flex' || oxArea.offsetParent !== null);
            myLastChoice = isOX ? (idx === 1 ? 'O' : 'X') : idx + 'ë²ˆ';

            const activeArea = isOX ? oxArea : multArea;
            activeArea.querySelectorAll('.quiz-opt-btn').forEach((btn, i) => {
                btn.classList.remove('selected');
                if ((i + 1) === idx) btn.classList.add('selected');
            });

            const uToken = localStorage.getItem('uToken_' + currentRoom);
            if(uToken && currentQuizId) {
                dbRef.ans.child(currentQuizId).child(uToken).set({
                    choice: idx, timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
            document.getElementById('quizFeedback').innerHTML = `<i class="fa-solid fa-check"></i> ${myLastChoice} ì„ íƒ ì™„ë£Œ!`;
        }

        // 9. [ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ] í€´ì¦ˆ ë° ìƒíƒœ ê°ì‹œ
        function setupListeners() {
            firebase.database().ref(".info/serverTimeOffset").on("value", s => { serverTimeOffset = s.val() || 0; });
            watchNotices();

            dbRef.settings.on('value', s => { 
                const v = s.val() || {}; 
                document.getElementById('roomTitle').innerText = v.courseName || `Room ${currentRoom}`; 
                document.getElementById('landingTitle').innerText = v.courseName || `Room ${currentRoom}`;
            });

            dbRef.qa.on('value', s => renderList(s.val() || {}));

            dbRef.status.on('value', s => {
                const st = s.val() || {};
                const sk = st.resetKey || 'init';
                if (localStorage.getItem(`kac_resetKey_${currentRoom}`) && localStorage.getItem(`kac_resetKey_${currentRoom}`) !== sk) {
                    localStorage.clear(); location.reload(); return;
                }
                localStorage.setItem(`kac_resetKey_${currentRoom}`, sk);
                
                if (st.mode === 'quiz' && st.quizStep !== 'summary') {
                    document.getElementById('quizOverlay').style.display = 'flex';
                } else if (st.quizStep === 'summary' && !hasClosedSummary) {
                    showFinalRanking();
                } else if (st.mode !== 'quiz') {
                    forceCloseQuiz();
                }
            });

            dbRef.quiz.on('value', s => {
                const q = s.val(); if(!q) return;
                if (currentQuizId !== q.id) {
                    currentQuizId = q.id; myLastChoiceIdx = null; myLastChoice = null; canAnswer = false;
                    document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.remove('selected', 'locked'));
                }
                const msgBox = document.getElementById('quizStatusMsg');
                const feedBox = document.getElementById('quizFeedback');
                const multArea = document.getElementById('btnGroupMultiple');
                const oxArea = document.getElementById('btnGroupOX');

                if(q.status === 'open') {
                    canAnswer = true; msgBox.innerText = "ì •ë‹µì„ ì„ íƒí•˜ì„¸ìš”!";
                    multArea.style.display = q.isOX ? 'none' : 'flex';
                    oxArea.style.display = q.isOX ? 'flex' : 'none';
                    if(!q.isOX) {
                        multArea.innerHTML = "";
                        q.options.forEach((opt, i) => {
                            const btn = document.createElement('button');
                            btn.className = 'quiz-opt-btn' + ((i+1)===myLastChoiceIdx?' selected':'');
                            btn.innerText = `${i+1}. ${opt}`; btn.onclick = () => sendAns(i+1);
                            multArea.appendChild(btn);
                        });
                    }
                } else if(q.status === 'result') {
                    canAnswer = false; 
                    msgBox.innerText = q.isSurvey ? "ğŸ“‹ ì„¤ë¬¸ ê²°ê³¼" : (myLastChoiceIdx === q.correct ? "ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!" : "ì•—, í‹€ë ¸ìŠµë‹ˆë‹¤.");
                    feedBox.innerText = q.isSurvey ? (q.surveyResult || "") : `ì •ë‹µ: ${q.isOX ? (q.correct==1?'O':'X') : q.correct+'ë²ˆ'}`;
                } else if(q.status === 'close') {
                    canAnswer = false; document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.add('locked'));
                    msgBox.innerText = "ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.";
                }
            });
        }

        // 10. [ì¶œê²° ì²˜ë¦¬] ë‚´ë¶€ ìì²´ ì¶œì„ë¶€
        function handleInternalAttendance(room) {
            const isCheckIn = new URLSearchParams(window.location.search).get('checkin') === 'true';
            if (!isCheckIn || !room) return;
            const today = getTodayString();
            const storageKey = `kac_attended_${room}_${today}`;
            if (localStorage.getItem(storageKey)) { cleanUrlAndGo(room); return; }

            const n = (localStorage.getItem('kac_user_name_' + room) || "").trim();
            const p = (localStorage.getItem('kac_user_phone_' + room) || "").trim();
            if (!n || p.length !== 4) {
                document.getElementById('profileOverlay').style.display = 'flex'; 
                return; 
            }
            
            firebase.database().ref(`courses/${room}/internal_attendance/${today}/${n}_${p}`).set({
                name: n, phone: p, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => { 
                localStorage.setItem(storageKey, "true"); 
                alert("âœ… ì¶œì„ ì™„ë£Œ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                cleanUrlAndGo(room); 
            });
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function formatTime(ts) { if(!ts) return ""; const d = new Date(ts); return d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0'); }
        function escapeHtml(t) { const m = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'}; return t.replace(/[&<>"']/g, f => m[f]); }
        function getTodayString() { const d = new Date(); return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`; }
        function cleanUrlAndGo(r) { window.history.replaceState({}, '', window.location.pathname + `?room=${r}`); showMainDashboard(); }
        function closeShuttleModal() { document.getElementById('shuttleModal').style.display = 'none'; }
        function forceCloseQuiz() { document.getElementById('quizOverlay').style.display = 'none'; rankingListener = null; }
        function resetInput() { const el = document.getElementById('qInput'); el.value = ""; el.style.height = '24px'; document.getElementById('submitBtn').classList.remove('editing'); editingKey = null; checkCooldown(); }
        function toggleLike(k) { if(myLikes[k]) { dbRef.qa.child(k).transaction(p=>{if(p)p.likes=(p.likes||1)-1;return p;}); delete myLikes[k]; } else { dbRef.qa.child(k).transaction(p=>{if(p)p.likes=(p.likes||0)+1;return p;}); myLikes[k]=true; } localStorage.setItem(`likes_${currentRoom}`, JSON.stringify(myLikes)); }
        function editQ(k) { if (Date.now() - myQs[k] > 300000) return alert("âŒ› 5ë¶„ì´ ê²½ê³¼í–ˆìŠµë‹ˆë‹¤."); dbRef.qa.child(k).once('value', s => { const el = document.getElementById('qInput'); el.value = s.val().text; editingKey = k; document.getElementById('submitBtn').classList.add('editing'); el.focus(); }); }
        function deleteQ(k) { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) dbRef.qa.child(k).remove(); }
        function setSort(t) { currentSort = t; document.getElementById('sortNew').classList.toggle('active', t === 'new'); document.getElementById('sortLike').classList.toggle('active', t === 'like'); dbRef.qa.once('value', s => renderList(s.val()||{})); }
        function handleSubjectChange() { currentFilter = document.getElementById('subjectSelect').value; document.getElementById('qInput').placeholder = currentFilter === "ê³µí†µì§ˆë¬¸" ? "âœ ì§ˆë¬¸ ì…ë ¥..." : `âœ ${currentFilter}ë‹˜ê»˜ ì§ˆë¬¸...`; checkCooldown(); dbRef.qa.once('value', s => renderList(s.val() || {})); }
        function checkCooldown() { const s = document.getElementById('subjectSelect').value; const d = Date.now() - (lastPostTimeMap[s] || 0); if(!editingKey && d < 120000) { const r = Math.ceil((120000 - d) / 1000); document.getElementById('coolTimer').innerText = `â³ [${s}] ëŒ€ê¸°: ${Math.floor(r/60)}:${(r%60).toString().padStart(2,'0')}`; document.getElementById('submitBtn').disabled = true; document.getElementById('qInput').disabled = true; setTimeout(checkCooldown, 1000); } else { document.getElementById('coolTimer').innerText = ""; document.getElementById('submitBtn').disabled = false; document.getElementById('qInput').disabled = false; } }
        async function updateMiniNotice() {
            const [inst, co, g] = await Promise.all([firebase.database().ref(`courses/${currentRoom}/notice`).once('value'), firebase.database().ref(`courses/${currentRoom}/coordNotice`).once('value'), firebase.database().ref('system/globalNotice').once('value')]);
            const cl = t => t ? t.replace(/\n/g, ' ').trim() : "";
            let p = [];
            if(cl(inst.val())) p.push(`ğŸ“¢ [ìš°ë¦¬ê³¼ì •] ${cl(inst.val())}`);
            if(cl(co.val())) p.push(`ğŸ”” [ìš´ì˜ë¶€] ${cl(co.val())}`);
            if(cl(g.val())) p.push(`ğŸ¢ [ì„¼í„°ê³µì§€] ${cl(g.val())}`);
            const f = p.join(" | ");
            if(f && localStorage.getItem('lastClosedNotice') !== f) { document.getElementById('miniNoticeText').innerText = f; document.getElementById('miniNoticeBar').style.display = 'flex'; }
            else document.getElementById('miniNoticeBar').style.display = 'none';
        }
        function closeMiniNotice() { localStorage.setItem('lastClosedNotice', document.getElementById('miniNoticeText').innerText); document.getElementById('miniNoticeBar').style.display = 'none'; }
        function watchNotices() { firebase.database().ref(`courses/${currentRoom}/notice`).on('value', updateMiniNotice); firebase.database().ref(`courses/${currentRoom}/coordNotice`).on('value', updateMiniNotice); firebase.database().ref('system/globalNotice').on('value', updateMiniNotice); }
        function initKeyboardFix() { if (window.visualViewport) { window.visualViewport.addEventListener('resize', () => { const o = window.innerHeight - window.visualViewport.height; document.getElementById('inputDock').style.bottom = o > 50 ? o + 'px' : '0px'; }); } }
        function exitApp() {
            if (confirm("í˜„ì¬ ê°•ì˜ì‹¤ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const u = localStorage.getItem('uToken_' + currentRoom);
                if (u) firebase.database().ref(`courses/${currentRoom}/students/${u}/isOnline`).set(false);
                const ua = navigator.userAgent.toLowerCase();
                if (ua.indexOf('kakaotalk') !== -1) { location.href = 'kakaotalk://inappbrowser/close'; return; }
                document.documentElement.innerHTML = `<div style="height:100dvh; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#0f172a; color:white; text-align:center;"><h2>í‡´ì¥ ì™„ë£Œ</h2><p>ë¸Œë¼ìš°ì € ì°½ì„ ë‹«ì•„ì£¼ì„¸ìš”.</p></div>`;
            }
        }
        async function openAttendanceQR() { document.getElementById('menuModal').style.display = 'none'; const img = document.getElementById('qrImage'); const msg = document.getElementById('qrEmptyMsg'); const snap = await firebase.database().ref(`courses/${currentRoom}/attendanceQR`).once('value'); if(snap.val()){ img.src=snap.val(); img.style.display='block'; msg.style.display='none'; } else { img.style.display='none'; msg.style.display='block'; } document.getElementById('qrModal').style.display = 'flex'; }
        function showFinalRanking() {
            const u = localStorage.getItem('uToken_' + currentRoom); if(!u || rankingListener) return;
            document.getElementById('quizOverlay').style.display = 'flex'; 
            document.getElementById('quizActiveBox').style.display = 'block'; 
            document.getElementById('quizResultBox').style.display = 'none';
            rankingListener = firebase.database().ref(`courses/${currentRoom}/quizFinalResults/${u}`).on('value', snap => {
                const r = snap.val();
                if(r) {
                    document.getElementById('quizActiveBox').style.display = 'none'; document.getElementById('quizResultBox').style.display = 'block';
                    document.getElementById('myFinalScore').innerText = `${r.score}ì `; document.getElementById('myFinalRank').innerText = r.rank;
                    document.getElementById('quizKingStamp').style.display = r.rank === 1 ? 'flex' : 'none';
                }
            });
        }
    </script>








<!-- ì»¤ìŠ¤í…€ ì»¨íŒ ì°½ (ì—¬ê¸°ê°€ ì§„ì§œ ìë¦¬ì…ë‹ˆë‹¤) -->
<div id="kacConfirm" class="kac-confirm-overlay">
    <div class="kac-confirm-box">
        <div id="kacConfirmMsg" class="kac-confirm-msg">ë©”ì‹œì§€ ë‚´ìš©</div>
        <div class="kac-confirm-btns">
            <button id="kacBtnNo" class="kac-btn-no" onclick="closeKacConfirm(false)">ì·¨ì†Œ</button>
            <button id="kacBtnYes" class="kac-btn-yes" onclick="closeKacConfirm(true)">í™•ì¸</button>
        </div>
    </div>
</div>


</body>
</html>