<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAC 영양관리 대시보드</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        :root { --primary: #10b981; --accent: #3b82f6; --danger: #ef4444; --bg: #f1f5f9; }
        * { box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
        body { background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        .container { max-width: 1100px; margin: 0 auto; }
        
        /* 상단 요약 카드 */
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); text-align: center; }
        .stat-card i { font-size: 24px; margin-bottom: 10px; display: block; }
        .stat-label { font-size: 14px; font-weight: 600; color: #64748b; }
        .stat-value { font-size: 36px; font-weight: 900; margin-top: 5px; }

        /* 테이블 영역 */
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 25px; }
        h2 { font-size: 20px; font-weight: 800; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; }
        
        .status-table { width: 100%; border-collapse: collapse; font-size: 15px; }
        .status-table th { background: #f8fafc; padding: 15px 10px; text-align: center; border-bottom: 2px solid #e2e8f0; color: #475569; }
        .status-table td { padding: 15px 10px; text-align: center; border-bottom: 1px solid #f1f5f9; }
        .status-table tr:hover { background-color: #fbfcfe; }
        
        .c-name { text-align: left !important; font-weight: 600; color: #334155; }
        .val-total { font-weight: 700; color: #1e293b; }
        .val-skip { font-weight: 800; color: var(--danger); background: #fff1f2; border-radius: 6px; padding: 4px 8px; }
        .val-net { font-weight: 800; color: var(--primary); }

        /* 업로드 영역 */
        .upload-section { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .upload-btn { 
    background: #059669; /* 좀 더 진한 녹색으로 변경 */
    color: white; 
    border: none; 
    padding: 20px 50px; /* 더 크게 */
    border-radius: 15px; 
    font-size: 18px; /* 글자도 크게 */
    font-weight: 800; 
    cursor: pointer; 
    transition: 0.2s; 
    box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3); /* 그림자 추가 */
}
        .upload-btn:hover { background: #2563eb; transform: translateY(-2px); }
        #preview { width: 100%; max-width: 400px; border-radius: 15px; margin-top: 10px; display: none; border: 4px solid #fff; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        @media (max-width: 768px) {
            .summary-grid { grid-template-columns: 1fr; }
            .status-table { font-size: 13px; }
            .hide-mobile { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 1. 상단 요약 정보 -->
        <div class="summary-grid">
            <div class="stat-card">
                <i class="fa-solid fa-users" style="color: var(--accent);"></i>
                <div class="stat-label">수강생 총원</div>
                <div class="stat-value" id="grandTotalStudents">0</div>
            </div>
            <div class="stat-card">
                <i class="fa-solid fa-utensils" style="color: var(--danger);"></i>
                <div class="stat-label">금일 석식 제외 총계</div>
                <div class="stat-value" id="grandTotalSkips" style="color: var(--danger);">0</div>
            </div>
            <div class="stat-card">
                <i class="fa-solid fa-circle-check" style="color: var(--primary);"></i>
                <div class="stat-label">예상 식사 인원</div>
                <div class="stat-value" id="grandTotalNet" style="color: var(--primary);">0</div>
            </div>
        </div>

        <!-- 2. 과정별 상세 현황판 -->
        <div class="card">
            <h2><i class="fa-solid fa-table-list"></i> 강의실별 식수 현황 (실시간)</h2>
            <table class="status-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">Room</th>
                        <th class="c-name">과정명</th>
                        <th style="width: 120px;">수강 총원</th>
                        <th style="width: 120px;">석식 제외</th>
                        <th style="width: 120px;">식사 예정</th>
                    </tr>
                </thead>
                <tbody id="roomTableBody">
                    <tr><td colspan="5" style="padding:40px;">데이터를 집계 중입니다...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- 3. 식단표 업로드 -->
        <div class="card">
            <div class="upload-section">
                <h2><i class="fa-solid fa-camera"></i> 주간 식단표 사진 업로드</h2>
                <p style="font-size:14px; color:#64748b; margin-top:-15px;">업로드 시 기존 사진은 삭제되고 새로운 사진이 학생들에게 즉시 공개됩니다.</p>
                <input type="file" id="menuFile" accept="image/*" style="display:none;" onchange="handleFileUpload(this)">
                <button class="upload-btn" onclick="document.getElementById('menuFile').click()">
                    <i class="fa-solid fa-cloud-arrow-up"></i> 사진 선택 및 업로드
                </button>
                <img id="preview" alt="식단표 미리보기">
                <p id="uploadStatus" style="font-weight:bold; font-size:14px;"></p>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        function updateDashboard() {
            const today = getTodayString();
            firebase.database().ref('courses').on('value', snap => {
                const allRooms = snap.val() || {};
                const tbody = document.getElementById('roomTableBody');
                tbody.innerHTML = "";

                let gTotalStudents = 0;
                let gTotalSkips = 0;

                // A부터 Z까지 순회
                for (let i = 65; i <= 90; i++) {
                    const roomId = String.fromCharCode(i);
                    const roomData = allRooms[roomId] || {};
                    
                    // 수강생 총원 (명부에 등록된 수)
                    const students = roomData.students || {};
                    const studentCount = Object.keys(students).length;
                    
                    // 석식 제외 인원
                    const skips = roomData.dinner_skips?.[today] || {};
                    const skipCount = Object.keys(skips).length;

                    // 과정명
                    const courseName = roomData.settings?.courseName || `<span style="color:#cbd5e1;">(비어있음)</span>`;

                    // 수강생이 1명이라도 있는 방만 리스트에 표시
                    if (studentCount > 0) {
                        gTotalStudents += studentCount;
                        gTotalSkips += skipCount;
                        const netCount = studentCount - skipCount;

                        tbody.innerHTML += `
                            <tr>
                                <td style="font-weight:800; color:var(--accent);">Room ${roomId}</td>
                                <td class="c-name">${courseName}</td>
                                <td class="val-total">${studentCount}명</td>
                                <td><span class="${skipCount > 0 ? 'val-skip' : ''}">${skipCount}명</span></td>
                                <td class="val-net">${netCount}명</td>
                            </tr>
                        `;
                    }
                }

                // 상단 요약 정보 업데이트
                document.getElementById('grandTotalStudents').innerText = gTotalStudents;
                document.getElementById('grandTotalSkips').innerText = gTotalSkips;
                document.getElementById('grandTotalNet').innerText = gTotalStudents - gTotalSkips;

                if (tbody.innerHTML === "") {
                    tbody.innerHTML = "<tr><td colspan='5' style='padding:50px; color:#94a3b8;'>현재 운영 중인 과정이 없습니다.</td></tr>";
                }
            });
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // 용량 체크 (2MB 이상 시 경고)
            if (file.size > 2 * 1024 * 1024) {
                alert("사진 용량이 너무 큽니다(2MB 이하 권장). 용량을 줄여서 다시 올려주세요.");
                return;
            }

            const reader = new FileReader();
            document.getElementById('uploadStatus').innerText = "업로드 중...";
            document.getElementById('uploadStatus').style.color = "var(--accent)";
            
            reader.onload = async function(e) {
                const base64Image = e.target.result;
                const img = document.getElementById('preview');
                img.src = base64Image;
                img.style.display = "block";

                try {
                    await firebase.database().ref('system/nutrition_menu').set(base64Image);
                    document.getElementById('uploadStatus').innerText = "✅ 업로드 완료! 교육생들이 즉시 확인할 수 있습니다.";
                    document.getElementById('uploadStatus').style.color = "var(--primary)";
                } catch(err) {
                    alert("서버 오류로 업로드에 실패했습니다.");
                    document.getElementById('uploadStatus').innerText = "";
                }
            };
            reader.readAsDataURL(file);
        }

        // 실행
        updateDashboard();
    </script>
</body>
</html>