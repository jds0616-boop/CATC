<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>KAC Nutrition Monitoring</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Font Awesome & Pretendard Font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

  <style>
    :root {
      --navy-dark: #0f172a;   /* 상/하단바 */
      --green-main: #10b981;  /* 메인 그린 (에메랄드) */
      --green-dark: #047857;  /* 짙은 그린 */
      --green-bg: #f0fdf4;    /* 아주 연한 그린 배경 */
      --card-white: #ffffff;
      --text-dark: #1e293b;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; padding: 0;
      font-family: 'Pretendard', sans-serif;
      background: #e2e8f0; 
      display: flex; justify-content: center;
      color: var(--text-dark);
    }

    .app-container {
      width: 100%;
      max-width: 600px; 
      min-height: 100dvh;
      background: var(--green-bg); /* 배경색을 연한 그린으로 */
      position: relative;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 30px rgba(0,0,0,0.1);
    }

    /* --- 상단바 (고정) --- */
    .app-header {
      position: fixed; top: 0; width: 100%; max-width: 600px; height: 60px;
      background: var(--navy-dark);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; z-index: 1000;
    }
    .header-btn { font-size: 20px; color: #fff; cursor: pointer; border:none; background:none; }
    .header-title { color: #fff; font-size: 17px; font-weight: 800; letter-spacing: -0.5px; }

    /* --- 하단바 (고정) --- */
    .app-footer {
      position: fixed; bottom: 0; width: 100%; max-width: 600px; height: 54px;
      background: var(--navy-dark); color: #94a3b8;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; font-size: 12px; z-index: 1000;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .footer-logo img { height: 22px; display: block; filter: brightness(0) invert(1); opacity: 0.8; }

    /* --- 콘텐츠 영역 --- */
    .app-content {
      flex: 1;
      margin-top: 60px; margin-bottom: 54px;
      padding: 20px;
    }

    /* 상단 상태 리본 */
    .status-ribbon {
      background: var(--card-white);
      border: 1.5px solid #dcfce7;
      border-radius: 14px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 4px 6px rgba(16, 185, 129, 0.05);
    }
    .date-badge { color: var(--green-dark); font-weight: 800; font-size: 14px; display: flex; align-items: center; gap: 8px; }
    .status-tag { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 800; }
    .status-tag.open { background: #dcfce7; color: var(--green-dark); }
    .status-tag.closed { background: #fee2e2; color: var(--danger); }

    /* 메인 요약 (그린 강조) */
    .summary-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;
    }
    .stat-card {
      background: var(--card-white);
      padding: 22px 16px; border-radius: 24px;
      border: 1px solid #dcfce7; text-align: center;
      box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.05);
    }
    .stat-card.full { grid-column: span 2; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; }
    .stat-label { font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 8px; display: block; }
    .stat-card.full .stat-label { color: #d1fae5; }
    .stat-val { font-size: 36px; font-weight: 900; line-height: 1; }

    /* 과정별 리스트 */
    .list-card {
      background: var(--card-white); border-radius: 24px;
      border: 1px solid #dcfce7; overflow: hidden; margin-bottom: 20px;
    }
    .card-header {
      padding: 16px 20px; background: #f0fdf4;
      border-bottom: 1px solid #dcfce7; font-weight: 800; font-size: 15px;
      display: flex; align-items: center; gap: 8px; color: var(--green-dark);
    }

    .status-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .status-table th { padding: 12px; font-size: 12px; color: #059669; background: #f0fdf4; text-align: center; }
    .status-table td { padding: 16px 8px; font-size: 14px; text-align: center; border-bottom: 1px solid #f0fdf4; font-weight: 600; }
    .status-table td.course-name { 
        text-align: left; font-weight: 800; color: var(--text-dark); padding-left: 15px;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .status-table td.skip-val { color: var(--danger); }
    .status-table td.net-val { color: var(--green-main); }

    /* 식단표 업로드 */
    .upload-card {
      background: #fff; border: 2px dashed var(--green-main);
      border-radius: 24px; padding: 24px; text-align: center;
    }
    .upload-btn {
      background: var(--green-main); color: white;
      border: none; padding: 14px 28px; border-radius: 14px;
      font-weight: 800; font-size: 14px; cursor: pointer;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }
    #preview { width: 100%; border-radius: 16px; margin-top: 15px; display: none; border: 1.5px solid #dcfce7; }

  </style>
</head>

<body>

  <div class="app-container">
    <header class="app-header">
      <button class="header-btn" onclick="history.back()"><i class="fa-solid fa-chevron-left"></i></button>
      <div class="header-title">KAC Nutrition Monitoring</div>
      <button class="header-btn"><i class="fa-solid fa-bars"></i></button>
    </header>

    <main class="app-content">
      
      <!-- 상태 정보 리본 -->
      <div class="status-ribbon">
          <div class="date-badge">
              <i class="fa-solid fa-calendar-day"></i>
              <span id="targetDateText">0000-00-00</span> 석식
          </div>
          <div id="surveyStatusTag" class="status-tag">조사 중</div>
      </div>

      <!-- 요약 카드 -->
      <div class="summary-grid">
          <div class="stat-card full">
              <span class="stat-label">예상 교육생 식사 총원</span>
              <div class="stat-val" id="grandTotalNet">0</div>
          </div>
          <div class="stat-card">
              <span class="stat-label">수강 총원</span>
              <div class="stat-val" id="grandTotalStudents">0</div>
          </div>
          <div class="stat-card">
              <span class="stat-label" style="color: var(--danger);">석식 제외</span>
              <div class="stat-val" id="grandTotalSkips" style="color: var(--danger);">0</div>
          </div>
      </div>

      <!-- 상세 테이블 -->
      <div class="list-card">
          <div class="card-header"><i class="fa-solid fa-leaf"></i> 과정별 식수 현황</div>
          <table class="status-table">
              <colgroup>
                  <col style="width: 48%;">
                  <col style="width: 17%;">
                  <col style="width: 17%;">
                  <col style="width: 18%;">
              </colgroup>
              <thead>
                  <tr>
                      <th style="text-align: left; padding-left: 15px;">과정명</th>
                      <th>총원</th>
                      <th>제외</th>
                      <th>예정</th>
                  </tr>
              </thead>
              <tbody id="roomTableBody">
                  <!-- JS Injection -->
              </tbody>
          </table>
      </div>

      <!-- 식단표 관리 -->
      <div class="upload-card">
          <div style="font-weight: 800; font-size: 15px; margin-bottom: 12px; color: var(--green-dark);">주간 식단표 이미지 관리</div>
          <input type="file" id="menuFile" accept="image/*" style="display:none;" onchange="handleFileUpload(this)">
          <button class="upload-btn" onclick="document.getElementById('menuFile').click()">
              <i class="fa-solid fa-camera-retro"></i> 식단표 업로드
          </button>
          <img id="preview" alt="식단표 미리보기">
      </div>

    </main>

    <footer class="app-footer">
      <div id="footer-time">0000년 00월 00일 (요일) 00:00</div>
      <div class="footer-logo"><img src="logo.png" alt="KAC Logo"></div>
    </footer>
  </div>

  <script src="config.js"></script>
  <script>
    // --- 시스템 상태 업데이트 ---
    function updateSystem() {
        const now = new Date();
        const week = ['일','월','화','수','목','금','토'];
        document.getElementById('footer-time').innerText = 
            `${now.getFullYear()}년 ${now.getMonth()+1}월 ${now.getDate()}일 (${week[now.getDay()]}) ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        
        const isAfter = now.getHours() >= 16;
        const tag = document.getElementById('surveyStatusTag');
        tag.innerText = isAfter ? "조사 마감" : "조사 진행 중";
        tag.className = isAfter ? "status-tag closed" : "status-tag open";
        document.getElementById('targetDateText').innerText = getTodayString();
    }
    setInterval(updateSystem, 1000); updateSystem();

    // --- 데이터 바인딩 ---
    function fetchMealData() {
        const today = getTodayString();
        firebase.database().ref('courses').on('value', snap => {
            const data = snap.val() || {};
            const tbody = document.getElementById('roomTableBody');
            tbody.innerHTML = "";

            let totalS = 0, totalK = 0;

            Object.keys(data).forEach(rid => {
                const room = data[rid];
                const cName = (room.settings && room.settings.courseName) ? room.settings.courseName : `과정 미지정(Room ${rid})`;
                const students = room.students ? Object.keys(room.students).length : 0;
                const skips = (room.dinner_skips && room.dinner_skips[today]) ? Object.keys(room.dinner_skips[today]).length : 0;

                if (students > 0) {
                    totalS += students; totalK += skips;
                    tbody.innerHTML += `
                        <tr>
                            <td class="course-name" title="${cName}">${cName}</td>
                            <td>${students}</td>
                            <td class="skip-val">${skips}</td>
                            <td class="net-val">${students - skips}</td>
                        </tr>
                    `;
                }
            });

            document.getElementById('grandTotalStudents').innerText = totalS;
            document.getElementById('grandTotalSkips').innerText = totalK;
            document.getElementById('grandTotalNet').innerText = totalS - totalK;
            if(!tbody.innerHTML) tbody.innerHTML = "<tr><td colspan='4' style='padding:40px; color:#94a3b8'>현재 진행중인 과정이 없습니다.</td></tr>";
        });
    }

    async function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            const base64 = e.target.result;
            document.getElementById('preview').src = base64;
            document.getElementById('preview').style.display = "block";
            await firebase.database().ref('system/nutrition_menu').set(base64);
            alert("식단표가 업데이트 되었습니다.");
        };
        reader.readAsDataURL(file);
    }

    fetchMealData();
  </script>
</body>
</html>