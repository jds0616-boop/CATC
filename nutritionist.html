<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>항공기술훈련원 식당 - 관리시스템</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Font Awesome & Pretendard Font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

  <style>
    :root {
      --navy-dark: #0f172a;
      --green-main: #10b981;
      --green-dark: #065f46;
      --green-bg: #f8fafc;
      --card-white: #ffffff;
      --text-dark: #1e293b;
      --danger: #ef4444;
      --accent-blue: #3b82f6;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; padding: 0;
      font-family: 'Pretendard', sans-serif;
      background: #f1f5f9; 
      display: flex; justify-content: center;
      color: var(--text-dark);
    }

    .app-container {
      width: 100%;
      max-width: 600px; 
      min-height: 100dvh;
      background: var(--green-bg);
      position: relative;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 30px rgba(0,0,0,0.1);
    }

    /* --- 상단바 --- */
    .app-header {
      position: fixed; top: 0; width: 100%; max-width: 600px; height: 60px;
      background: var(--navy-dark);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; z-index: 1000;
    }
    .header-btn { font-size: 20px; color: #fff; cursor: pointer; border:none; background:none; }
    .header-title { color: #fff; font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }

    /* --- 콘텐츠 영역 --- */
    .app-content {
      flex: 1;
      margin-top: 60px; margin-bottom: 54px;
      padding: 20px;
    }

    /* 카운트다운 바 */
    .countdown-bar {
        background: #fffbeb;
        border: 1px solid #fef3c7;
        padding: 10px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 15px;
        font-size: 13px;
        font-weight: 700;
        color: #b45309;
    }
    #timerText { color: var(--danger); font-weight: 900; }

    /* 메인 지표 카드 */
    .main-stat-card {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 24px;
        padding: 35px 20px;
        text-align: center;
        color: white;
        box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
        margin-bottom: 15px;
    }
    .main-stat-label { font-size: 15px; opacity: 0.9; margin-bottom: 10px; display: block; font-weight: 600;}
    .main-stat-val { font-size: 60px; font-weight: 900; line-height: 1; }
    .main-stat-val span { font-size: 24px; margin-left: 5px; }

    .sub-stat-row {
        display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 25px;
    }
    .sub-stat-card {
        background: white; border: 1.5px solid #e2e8f0; border-radius: 15px;
        padding: 18px 20px; display: flex; justify-content: space-between; align-items: center;
        cursor: pointer; transition: 0.2s;
    }
    .sub-stat-card:active { background: #fef2f2; transform: scale(0.98); border-color: var(--danger); }
    .sub-stat-label { font-size: 14px; font-weight: 700; color: #64748b; }
    .sub-stat-val { font-size: 20px; font-weight: 800; color: var(--danger); }

    /* 테이블 스타일 */
    .list-card {
      background: var(--card-white); border-radius: 20px;
      border: 1px solid #e2e8f0; overflow: hidden; margin-bottom: 20px;
    }
    .card-header {
      padding: 15px 20px; background: #f8fafc;
      border-bottom: 1px solid #e2e8f0; font-weight: 800; font-size: 14px;
      color: var(--navy-dark);
    }
    .status-table { width: 100%; border-collapse: collapse; }
    .status-table th { padding: 12px; font-size: 12px; color: #64748b; background: #f8fafc; text-align: center; }
    .status-table td { padding: 16px 10px; font-size: 14px; text-align: center; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
    .status-table tr:active { background: #f0fdf4; }
    .status-table td.course-name { text-align: left; font-weight: 800; color: var(--text-dark); padding-left: 20px; }
    .status-table td.skip-val { color: var(--danger); font-weight: 800; }
    .status-table td.net-val { color: var(--green-main); font-weight: 800; }

    /* 팝업 모달 */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); z-index: 5000;
        display: none; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-box {
        background: white; width: 100%; max-width: 400px;
        border-radius: 24px; overflow: hidden; display: flex; flex-direction: column;
        max-height: 80vh;
    }
    .modal-header { padding: 20px; background: var(--navy-dark); color: white; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 20px; overflow-y: auto; }
    .modal-close { font-size: 20px; cursor: pointer; }
    .skip-user-item { padding: 12px 0; border-bottom: 1px solid #f1f5f9; display: flex; flex-direction: column; gap: 4px; }
    .skip-user-main { display: flex; justify-content: space-between; align-items: center; }
    .skip-user-name { font-weight: 800; color: var(--text-dark); font-size: 16px; }
    .skip-user-phone { color: var(--accent-blue); font-weight: 700; font-size: 14px; }
    .skip-user-course { font-size: 11px; color: #94a3b8; font-weight: 600; }

    /* 사이드 메뉴 */
    .side-menu {
        position: fixed; top: 0; right: -100%; width: 80%; max-width: 300px; height: 100%;
        background: white; z-index: 6000; transition: 0.3s; padding: 30px 20px;
        box-shadow: -5px 0 20px rgba(0,0,0,0.1);
    }
    .side-menu.open { right: 0; }
    .menu-title { font-size: 18px; font-weight: 900; margin-bottom: 30px; border-bottom: 2px solid var(--navy-dark); padding-bottom: 10px;}
    .upload-btn { background: var(--green-main); color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-weight: 800; cursor: pointer; margin-bottom: 20px;}
    #menuPreview { width: 100%; border-radius: 10px; border: 1px solid #ddd; margin-top: 10px; }

    /* 하단바 디자인 */
    .app-footer {
      position: fixed; bottom: 0; width: 100%; max-width: 600px; height: 54px;
      background: var(--navy-dark); color: #fff;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; z-index: 1000;
    }
    #footer-date { font-size: 15px; font-weight: 800; opacity: 0.9; letter-spacing: -0.5px; }
    .footer-logo img { height: 18px; filter: brightness(0) invert(1); opacity: 0.9; }
  </style>
</head>

<body>

  <div class="app-container">
    <header class="app-header">
      <button class="header-btn" onclick="history.back()"><i class="fa-solid fa-chevron-left"></i></button>
      <div class="header-title">항공기술훈련원 식당</div>
      <button class="header-btn" onclick="toggleSideMenu(true)"><i class="fa-solid fa-bars"></i></button>
    </header>

    <div id="sideMenu" class="side-menu">
        <div style="text-align: right; margin-bottom: 20px;"><i class="fa-solid fa-xmark modal-close" onclick="toggleSideMenu(false)"></i></div>
        <div class="menu-title">주간 식단표 관리</div>
        <div class="upload-section">
            <p style="font-size: 13px; color: #64748b; margin-bottom: 15px;">교육생 앱에 노출될<br>식단표 사진을 업로드하세요.</p>
            <input type="file" id="menuFile" accept="image/*" style="display:none;" onchange="handleFileUpload(this)">
            <button class="upload-btn" onclick="document.getElementById('menuFile').click()">
                <i class="fa-solid fa-camera"></i> 식단표 사진 변경
            </button>
            <div style="font-size: 12px; font-weight: bold; color: var(--navy-dark); margin-bottom: 5px; text-align: left;">현재 등록된 사진:</div>
            <img id="menuPreview" src="" alt="식단표 로딩 중...">
        </div>
    </div>

    <main class="app-content">
      <div class="countdown-bar">
          <i class="fa-regular fa-clock"></i> 금일 석식 조사 마감까지 <span id="timerText">00:00:00</span> 남음
      </div>

      <div class="main-stat-card">
          <span class="main-stat-label">오늘의 석식 식사 예정 총원</span>
          <div class="main-stat-val" id="grandTotalNet">0<span>명</span></div>
      </div>

      <div class="sub-stat-row">
          <div class="sub-stat-card" onclick="showAllExclusions()">
              <span class="sub-stat-label">오늘의 석식 제외 신청 (명단보기)</span>
              <span class="sub-stat-val" id="grandTotalSkips">0명</span>
          </div>
      </div>

      <div class="list-card">
          <div class="card-header"><i class="fa-solid fa-clipboard-list"></i> 과정별 식수 상세 (클릭 시 명단확인)</div>
          <table class="status-table">
              <thead>
                  <tr>
                      <th style="width: 50%;">과정명</th>
                      <th style="width: 15%;">입교</th>
                      <th style="width: 15%;">제외</th>
                      <th style="width: 20%;">예정</th>
                  </tr>
              </thead>
              <tbody id="roomTableBody"></tbody>
          </table>
      </div>
    </main>

    <div id="detailModal" class="modal-overlay" onclick="if(event.target==this) closeDetailModal()">
        <div class="modal-box">
            <div class="modal-header">
                <div id="modalTitle" style="font-weight: 800;">제외 교육생 명단</div>
                <i class="fa-solid fa-xmark modal-close" onclick="closeDetailModal()"></i>
            </div>
            <div class="modal-body" id="modalList"></div>
            <button onclick="closeDetailModal()" style="width: 100%; padding: 15px; border: none; background: #f1f5f9; font-weight: 800; color: #64748b; cursor: pointer;">닫기</button>
        </div>
    </div>

    <footer class="app-footer">
      <div id="footer-date">로딩 중...</div>
      <div class="footer-logo"><img src="logo.png" alt="KAC"></div>
    </footer>
  </div>

  <script src="config.js"></script>
  <script>
    let allCourseData = {};

    function toggleSideMenu(open) {
        document.getElementById('sideMenu').classList.toggle('open', open);
        if(open) fetchCurrentMenu();
    }

    function updateClock() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const day = now.getDate();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('footer-date').innerText = `${year}.${month}.${day} ${hh}시 ${mm}분`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    function updateCountdown() {
        const now = new Date();
        const deadline = new Date();
        deadline.setHours(16, 0, 0, 0);
        let diff = deadline - now;
        const timerEl = document.getElementById('timerText');
        if (diff <= 0) { timerEl.innerText = "조사 마감됨"; return; }
        const h = String(Math.floor(diff / (1000 * 60 * 60))).padStart(2, '0');
        const m = String(Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, '0');
        const s = String(Math.floor((diff % (1000 * 60)) / 1000)).padStart(2, '0');
        timerEl.innerText = `${h}:${m}:${s}`;
    }
    setInterval(updateCountdown, 1000);

    // --- [핵심 수정] 데이터 로드 (입교 완료된 사람만 총원으로 계산) ---
    function fetchMealData() {
        const today = getTodayString();
        firebase.database().ref('courses').on('value', snap => {
            const data = snap.val() || {};
            allCourseData = data;
            const tbody = document.getElementById('roomTableBody');
            tbody.innerHTML = "";
            let grandTotalArrived = 0; // 실제 입교 완료 총원
            let grandTotalSkips = 0;

            Object.keys(data).forEach(rid => {
                const room = data[rid];
                if (room.status && room.status.roomStatus === 'active') {
                    
                    // (변경) 총원 계산: 명단에 관계없이 앱에 접속한 '실제 인원'만 추출
                    const actualStudents = Object.values(room.students || {}).filter(s => s.name && s.name !== "undefined");
                    const actualNames = Array.from(new Set(actualStudents.map(s => s.name))); // 중복 기기 제거
                    
                    const roomArrived = actualNames.length; // 이 강의실의 실제 입교 인원
                    const roomSkips = room.dinner_skips && room.dinner_skips[today] ? Object.keys(room.dinner_skips[today]).length : 0;
                    
                    if (roomArrived > 0) {
                        grandTotalArrived += roomArrived;
                        grandTotalSkips += roomSkips;

                        const cName = room.settings?.courseName || `강의실 ${rid}`;
                        tbody.innerHTML += `
                            <tr onclick="showRoomDetails('${rid}', '${cName}')">
                                <td class="course-name">${cName}</td>
                                <td>${roomArrived}</td>
                                <td class="skip-val">${roomSkips}</td>
                                <td class="net-val">${roomArrived - roomSkips}</td>
                            </tr>`;
                    }
                }
            });
            // 식사 예정 = 실제 입교 인원 - 제외 신청자
            document.getElementById('grandTotalNet').innerHTML = (grandTotalArrived - grandTotalSkips) + "<span>명</span>";
            document.getElementById('grandTotalSkips').innerText = grandTotalSkips + "명";
        });
    }

    function showRoomDetails(rid, cName) {
        const today = getTodayString();
        const skips = allCourseData[rid].dinner_skips ? allCourseData[rid].dinner_skips[today] : null;
        const modal = document.getElementById('detailModal');
        const listArea = document.getElementById('modalList');
        document.getElementById('modalTitle').innerText = cName;
        listArea.innerHTML = "";

        if (!skips || Object.keys(skips).length === 0) {
            listArea.innerHTML = "<div style='text-align:center; padding:30px; color:#94a3b8;'>석식 제외 신청자가 없습니다.</div>";
        } else {
            Object.values(skips).sort().forEach(val => {
                const name = val.split('(')[0];
                const phone = val.includes('(') ? val.split('(')[1].replace(')', '') : '';
                listArea.innerHTML += `
                    <div class="skip-user-item">
                        <div class="skip-user-main"><span class="skip-user-name">${name}</span><span class="skip-user-phone">${phone}</span></div>
                    </div>`;
            });
        }
        modal.style.display = 'flex';
    }

    function showAllExclusions() {
        const today = getTodayString();
        const modal = document.getElementById('detailModal');
        const listArea = document.getElementById('modalList');
        document.getElementById('modalTitle').innerText = "전체 석식 제외자 현황";
        listArea.innerHTML = "";

        let allSkips = [];
        Object.keys(allCourseData).forEach(rid => {
            const room = allCourseData[rid];
            const skips = room.dinner_skips ? room.dinner_skips[today] : null;
            if(skips) {
                Object.values(skips).forEach(val => {
                    allSkips.push({
                        nameInfo: val,
                        course: room.settings?.courseName || rid
                    });
                });
            }
        });

        if (allSkips.length === 0) {
            listArea.innerHTML = "<div style='text-align:center; padding:30px; color:#94a3b8;'>오늘 석식 제외자가 없습니다.</div>";
        } else {
            allSkips.sort((a,b) => a.nameInfo.localeCompare(b.nameInfo));
            allSkips.forEach(item => {
                const name = item.nameInfo.split('(')[0];
                const phone = item.nameInfo.includes('(') ? item.nameInfo.split('(')[1].replace(')', '') : '';
                listArea.innerHTML += `
                    <div class="skip-user-item">
                        <div class="skip-user-main"><span class="skip-user-name">${name}</span><span class="skip-user-phone">${phone}</span></div>
                        <div class="skip-user-course">${item.course}</div>
                    </div>`;
            });
        }
        modal.style.display = 'flex';
    }

    function closeDetailModal() { document.getElementById('detailModal').style.display = 'none'; }

    function fetchCurrentMenu() {
        firebase.database().ref('system/nutrition_menu').once('value', snap => {
            const imgEl = document.getElementById('menuPreview');
            imgEl.src = snap.exists() ? snap.val() : "https://via.placeholder.com/300x400?text=No+Image";
        });
    }

    async function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const base64 = e.target.result;
            await firebase.database().ref('system/nutrition_menu').set(base64);
            document.getElementById('menuPreview').src = base64;
            alert("식단표 업로드가 완료되었습니다.");
        };
        reader.readAsDataURL(file);
    }

    fetchMealData();
    fetchCurrentMenu();
  </script>
</body>
</html>