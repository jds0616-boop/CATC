<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAC ì˜ì–‘ì‚¬ í”Œë«í¼</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        :root { --primary: #10b981; --bg: #f8fafc; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: center; }
        h1 { font-size: 24px; color: #1e293b; margin-bottom: 10px; }
        .total-box { font-size: 48px; font-weight: 900; color: var(--primary); margin: 20px 0; }
        .room-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .room-item { background: #f1f5f9; padding: 15px; border-radius: 12px; font-weight: bold; }
        .upload-btn { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; display: block; margin: 20px auto; }
        #preview { width: 100%; max-width: 300px; border-radius: 10px; margin-top: 15px; display: none; margin-left: auto; margin-right: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ´ ê¸ˆì¼ ì„ì‹ ë¯¸ì·¨ì‹ í†µí•© í˜„í™©</h1>
            <p style="color:#64748b;">ì „ì²´ ê°•ì˜ì‹¤ì—ì„œ "ì•ˆ ë¨¹ì–´ìš”"ë¥¼ ëˆ„ë¥¸ ì¸ì›ì…ë‹ˆë‹¤.</p>
            <div class="total-box"><span id="grandTotal">0</span>ëª…</div>
            <div class="room-grid" id="roomStats"></div>
        </div>

        <div class="card">
            <h1>ğŸ“¸ ì‹ë‹¨í‘œ ì—…ë¡œë“œ</h1>
            <p style="color:#64748b;">ì‚¬ì§„ì„ ì˜¬ë¦¬ë©´ ëª¨ë“  êµìœ¡ìƒ ì•±ì— ì¦‰ì‹œ ê³µìœ ë©ë‹ˆë‹¤.</p>
            <input type="file" id="menuFile" accept="image/*" style="display:none;" onchange="handleFileUpload(this)">
            <button class="upload-btn" onclick="document.getElementById('menuFile').click()">ì‚¬ì§„ ì„ íƒ ë° ì—…ë¡œë“œ</button>
            <img id="preview" alt="ë¯¸ë¦¬ë³´ê¸°">
            <p id="uploadStatus" style="font-size:14px; margin-top:10px;"></p>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // 1. í†µí•© ì¸ì› ì§‘ê³„ (A-Z ëª¨ë“  ë°© ì¡°ì‚¬)
        function loadGrandTotal() {
            const today = getTodayString();
            firebase.database().ref('courses').on('value', snap => {
                const allData = snap.val() || {};
                let total = 0;
                const statsDiv = document.getElementById('roomStats');
                statsDiv.innerHTML = "";

                for(let i=65; i<=90; i++) {
                    const room = String.fromCharCode(i);
                    const skips = allData[room]?.dinner_skips?.[today] || {};
                    const count = Object.keys(skips).length;
                    
                    if(count > 0) {
                        total += count;
                        statsDiv.innerHTML += `<div class="room-item">Room ${room}<br><span style="color:#10b981;">${count}ëª…</span></div>`;
                    }
                }
                document.getElementById('grandTotal').innerText = total;
            });
        }

        // 2. ì‚¬ì§„ ì—…ë¡œë“œ (Base64 ì••ì¶• ë°©ì‹ - ì´ˆë³´ììš©)
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            document.getElementById('uploadStatus').innerText = "ì—…ë¡œë“œ ì¤‘...";
            
            reader.onload = async function(e) {
                const base64Image = e.target.result;
                
                // ë¯¸ë¦¬ë³´ê¸°
                const img = document.getElementById('preview');
                img.src = base64Image;
                img.style.display = "block";

                // ì„œë²„ ì €ì¥ (ê¸°ì¡´ ì‚¬ì§„ ë®ì–´ì“°ê¸°)
                try {
                    await firebase.database().ref('system/nutrition_menu').set(base64Image);
                    document.getElementById('uploadStatus').innerText = "âœ… ì—…ë¡œë“œ ì™„ë£Œ!";
                    document.getElementById('uploadStatus').style.color = "#10b981";
                } catch(err) {
                    alert("ì‚¬ì§„ ìš©ëŸ‰ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. ì¢€ ë” ì‘ì€ ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”.");
                }
            };
            reader.readAsDataURL(file);
        }

        loadGrandTotal();
    </script>
</body>
</html>