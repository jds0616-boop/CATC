<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Room C ê°•ì‚¬ Q&A (ê²€ì¦ìš©)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- 1. ë§Œì•½ config.jsê°€ ì•ˆ ì½íˆë©´ ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì£¼ì˜ -->
    <script src="config.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    
    <style>
        :root { --bg-gray: #f8fafc; --kac-blue: #003366; --accent-blue: #3b82f6; }
        body { margin: 0; font-family: 'Pretendard', sans-serif; background: var(--bg-gray); display: flex; flex-direction: column; height: 100dvh; }
        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--kac-blue); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; width: 90%; max-width: 320px; padding: 30px; border-radius: 20px; text-align: center; }
        .login-input { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; text-align: center; margin-bottom: 15px; outline: none; }
        .login-btn { width: 100%; padding: 14px; background: var(--accent-blue); color: white; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; }
        header { background: var(--kac-blue); color: white; padding: 15px; text-align: center; }
        .filter-container { background: white; padding: 10px; border-bottom: 1px solid #e2e8f0; overflow-x: auto; white-space: nowrap; }
        .chip { display: inline-block; padding: 8px 15px; background: #f1f5f9; border-radius: 20px; margin-right: 5px; font-size: 13px; font-weight: 700; cursor: pointer; }
        .chip.active { background: var(--accent-blue); color: white; }
        .content { flex: 1; overflow-y: auto; padding: 15px; }
        .q-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid var(--kac-blue); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="login-box">
            <h2 style="color:var(--kac-blue); margin-top:0;">ê°•ì‚¬ ì¸ì¦</h2>
            <input type="password" id="pwInput" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeyup="if(window.event.keyCode==13){checkAuth()}">
            <button class="login-btn" onclick="checkAuth()">ì…ì¥í•˜ê¸°</button>
            <p id="errorMsg" style="color:red; font-size:12px; display:none;">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</p>
            <p id="debugMsg" style="color:gray; font-size:10px; margin-top:10px;"></p>
        </div>
    </div>

    <header>
        <h1 id="courseTitle" style="font-size:16px; margin:0;">ì§ˆë¬¸ ì„¼í„°</h1>
    </header>

    <div class="filter-container" id="instructorChips"></div>

    <main class="content" id="qaList">
        <p style="text-align:center; color:gray; margin-top:50px;">ê°•ì‚¬ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
    </main>

    <script>
        // [ê²€ì¦ 1] config.js íŒŒì¼ì´ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
        window.addEventListener('load', function() {
            const debug = document.getElementById('debugMsg');
            if (typeof firebaseConfig === 'undefined') {
                debug.innerText = "âš ï¸ ì„¤ì •(config.js)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
                // ë§Œì•½ ê³„ì† ì•ˆëœë‹¤ë©´ ì—¬ê¸°ì— ì§ì ‘ íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì •ì„ ë³µì‚¬í•´ ë„£ìœ¼ì„¸ìš”.
                /*
                window.firebaseConfig = {
  apiKey: "AIzaSyDo3BPMV8qayQ3MdKBglYNtsvii0ZtCHHs",
  authDomain: "catcqna.firebaseapp.com",
  databaseURL: "https://catcqna-default-rtdb.firebaseio.com",
  projectId: "catcqna",
  storageBucket: "catcqna.firebasestorage.app",
  messagingSenderId: "327047828064",
  appId: "1:327047828064:web:a2e26fea9f276764412905",
  measurementId: "G-TBGD8F1V2M"
                };
                */
            } else {
                debug.innerText = "âœ… ì—°ê²° ì¤€ë¹„ ì™„ë£Œ (config.js ë¡œë“œë¨)";
                try {
                    firebase.initializeApp(firebaseConfig);
                } catch(e) {
                    alert("ì´ˆê¸°í™” ì—ëŸ¬: " + e.message);
                }
            }
        });

        const db = firebase.database();
        const ROOM_ID = 'C';
        let currentInstructor = null;

        // [ê²€ì¦ 2] ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œê·¸ í™•ì¸
        function checkAuth() {
            const pw = document.getElementById('pwInput').value.trim();
            console.log("ì…ë ¥ëœ ë¹„ë²ˆ:", pw); // ë¸Œë¼ìš°ì € ì½˜ì†”ìš©

            if (pw === 'catc1234') {
                document.getElementById('authOverlay').style.display = 'none';
                startApp();
            } else {
                document.getElementById('errorMsg').style.display = 'block';
                document.getElementById('pwInput').value = '';
            }
        }

        function startApp() {
            // ê³¼ì •ëª… ë¶ˆëŸ¬ì˜¤ê¸° í…ŒìŠ¤íŠ¸
            db.ref(`courses/${ROOM_ID}/settings/courseName`).once('value')
            .then(snap => {
                document.getElementById('courseTitle').innerText = snap.val() || "Room C ì§ˆë¬¸ ì„¼í„°";
            })
            .catch(err => {
                alert("ë°ì´í„° ì½ê¸° ê¶Œí•œ ì—ëŸ¬: " + err.message + "\nFirebase Rulesë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            });

            // ê°•ì‚¬ ë¦¬ìŠ¤íŠ¸
            db.ref(`courses/${ROOM_ID}/settings/subjects`).on('value', snap => {
                const subjects = snap.val() || {};
                const wrapper = document.getElementById('instructorChips');
                wrapper.innerHTML = "";
                Object.values(subjects).forEach(name => {
                    const chip = document.createElement('div');
                    chip.className = "chip";
                    chip.innerText = name;
                    chip.onclick = () => setInstructor(name, chip);
                    wrapper.appendChild(chip);
                });
            });
        }

        function setInstructor(name, el) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            currentInstructor = name;

            db.ref(`courses/${ROOM_ID}/questions`).on('value', snap => {
                const data = snap.val() || {};
                const container = document.getElementById('qaList');
                container.innerHTML = "";

                let items = Object.keys(data).map(k => ({ id: k, ...data[k] }));
                items = items.filter(q => q.status !== 'delete' && (q.subject || "").includes(currentInstructor));
                items.sort((a, b) => (b.likes || 0) - (a.likes || 0) || b.timestamp - a.timestamp);

                if(items.length === 0) {
                    container.innerHTML = `<p style="text-align:center; padding:50px; color:gray;">ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }

                items.forEach(q => {
                    container.innerHTML += `
                        <div class="q-card">
                            <div style="font-weight:800; font-size:16px;">${q.text}</div>
                            <div style="margin-top:10px; display:flex; justify-content:space-between; font-size:12px; color:gray;">
                                <span>ğŸ‘ ${q.likes || 0}</span>
                                <span>${new Date(q.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                            </div>
                        </div>`;
                });
            });
        }
    </script>
</body>
</html>